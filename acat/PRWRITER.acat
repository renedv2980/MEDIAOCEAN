*          DATA SET PRWRITER   AT LEVEL 150 AS OF 01/28/21                      
*CATALP PRWRITER                                                                
         TITLE 'PRWRITER - CHANGE LOG'                                          
***********************************************************************         
* USER    JIRA       DATE                  CHANGE LOG                 *         
* ---- ----------  -------- ----------------------------------------- *         
* KWAN SPEC-52236  01/12/21 TSRECVD KEYWORD                           *         
* AKAT SPEC-32217  06/17/19 DO NOT APPLY BFORM TO TAX FOR BDACT       *         
* AKAT SPEC-16537  06/18/18 PASS CLT OFFICE AT INPUT TIME FOR BHINV   *         
* KWAN SPEC-16356  03/06/18 New keyword RATETYPE (Buy Rate Type)      *         
* AKAT SPEC-22981  04/13/18 CLEAR ICOMMCHP TO PREVENT LOOP            *         
* KWAN SPEC-13046  09/13/17 New keyword SREP (Special Rep)            *         
* AKAT SPEC-4898   08/18/16 PICOM & ICCOM COMMENT FILTER SUPPORT      *         
* AKAT SPEC-13     07/14/16 PUBLOCK KEYWORD                           *         
* AKAT CUSTENH3347 05/19/16 HST INCREASING TO 15% FOR NB 07/01/16     *         
* AKAT SPSUG-20    05/19/16 HST INCREASING TO 15% FOR NF 07/01/16     *         
* AKAT SPSUG-42    05/19/16 HST INCREASING TO 15% FOR PE 10/01/16     *         
* kwan DSPTK-182   03/30/16 PAYSRC keyword fix for AUTOPAY payments   *         
* AKAT DSPTK-111   03/24/16 SUPPORT ESTIMATE UCOMMS 5-8               *         
*                                                                     *         
*JAN21/15 AKAT - FIXES FOR MONEYFLOW                                  *         
*                                                                     *         
*NOV05/14 AKAT - SUPPORT NEW PAYSRC KEYWORD AND FILTER                *         
*                                                                     *         
*OCT20/14 KWAN - Report on Prisma/Radia origins (BUYSRC)              *         
*                                                                     *         
*MAY15/14 AKAT - INCLUDE VOIDED CHECKS WHEN USING CBU OPTION          *         
*                                                                     *         
*APR  /14 KWAN - CHECK FOR PRD RECORD WHEN PROCESSING UDEF (IUDF)     *         
*                                                                     *         
*JAN  /14 AKAT - DONT READ DELETED CLT/PRD/PUB GROUP DIR POINTERS     *         
*                                                                     *         
*APR  /13 BOBY - BILLING PURCHASE ORDER NUMBERS                       *         
*                                                                     *         
*MAY  /12 BOBY - BUYSRC1 FOR IDESK 3                                  *         
*                                                                     *         
*MAR  /12 AKAT - SC JOHNSON SUPPORT                                   *         
*                                                                     *         
*FEB  /09 BOBY - DCOMMENT PID AND TIME                                *         
*                                                                     *         
*FEB  /09 BOBY - HANDLE CASH OVERPAYMENTS                             *         
*                                                                     *         
*NOV  /08 BOBY - READ BFORM RECORDS OPTION                            *         
*                                                                     *         
*NOV  /08 BOBY - PRINT COMPACT ZZZ ALLOCATION                         *         
*                                                                     *         
*MAR  /08 BOBY - FULL BILL INVOICE NUMBER WITH MEDIA                  *         
*                                                                     *         
*JAN  /08 BOBY - NEW GST RATE FOR CANADA                              *         
*                                                                     *         
*SEP  /07 BOBY - FIX SECOND INSERTION DISPLAY BUG                     *         
*                                                                     *         
*AUG  /07 BOBY - NEW CLEARANCE STATUS RECORDS                         *         
*                                                                     *         
*JUL  /07 BOBY - INSDATE WITHOUT BFD,WEEKLY INDICATORS                *         
*                                                                     *         
*JUL  /07 BOBY - OFFICE KEYWORDS                                      *         
*                                                                     *         
*DEC  /06 BOBY - PLANNED COST KEYWORDS                                *         
*                                                                     *         
*DEC  /06 BOBY - PO# KEYWORDS                                         *         
*                                                                     *         
*JUN  /06 BOBY - GST/PST CHANGES                                      *         
*                                                                     *         
*JUN  /06 BOBY - INSERTION ORDER STATUS KEYWORDS                      *         
*                                                                     *         
*MAY  /06 BOBY - PUBLIST KEYWORDS FOR REPORTS RUN BY PUBLIST          *         
*                                                                     *         
*MAR  /06 BOBY - CHECK CONTROL DATE                                   *         
*                                                                     *         
*OCT  /05 BOBY - 2 CHARACTER MEDIA OFFICE CODES                       *         
*                                                                     *         
*MAY  /05 BOBY - LABATT SPECIAL KEYWORDS                              *         
*                                                                     *         
*MAY  /05 BOBY - NONADD COLUMN FILTER                                 *         
*                                                                     *         
*APR28/05 BOBY - ADCAP PRINTING PROBLEM/BHHST - KEYWORD               *         
*                                                                     *         
*JAN04/05 BOBY - BUY NEW INVOICE DATA                                 *         
*                                                                     *         
*JAN04/05 BOBY - SUBMEDIA KEYWORDS                                    *         
*                                                                     *         
*JUN10/04 BOBY - NEW INVOICE KEYWORDS                                 *         
*                                                                     *         
*APR29/04 BOBY - UP MAX UCOMMS TO 12                                  *         
*                HAVE ICOMM ALWAYS PASS SE CODE                       *         
*                                                                     *         
*JUL23/97 BOBY ROUTINES IADRREP AND OADRREP ARE NOW ACCESSED BY A     *         
*        V-CON POINTING TO ROUTINES IN PRWRIADR. THESE ROUTINES       *         
*        MAKE USE OF PUB ADDRESS RECORDS. IF YOU NEED TO RETURN       *         
*        TO OLD WAY CHANGE THE V-CON BACK TO A-CON. THIS WILL USE     *         
*        ROUTINES IN THIS PROGRAM                                     *         
*                                                                     *         
*                                                                     *         
*                                                                     *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         TITLE 'PRWRITER - SYSTEM DRIVER FOR PRINTPAK WRITER'                   
***********************************************************************         
*                                                                     *         
*        PROGRAM CONTAINS THE INPUT & OUTPUT ROUTINES FOR             *         
*        HANDLING DRIVER DATA                                         *         
*                                                                     *         
*        CONVENTIONS                                                  *         
*                                                                     *         
*              1. ON INPUT GLARGS+0 IS RESERVED FOR DESCRIBING DATA   *         
*                 TYPE AND IF POSSIBLE DATA SOURCE                    *         
*                                                                     *         
*                 'A' - AOR      RECORD DATA                          *         
*                 'B' - BUY      RECORD DATA                          *         
*                 'C' - CONTRACT RECORD DATA                          *         
*                 'D' - DRD      RECORD DATA - DIV/REG/DIS            *         
*                 'E' - ESTIMATE RECORD DATA                          *         
*                 'F' - CIRC     RECORD DATA -                        *         
*                 'G' - JOB      RECORD DATA                          *         
*                 'H' - HEADER   RECORD DATA - AGY, CLT, PRD, EST     *         
*                   '1'        AGENCY   RECORD DATA                   *         
*                   '2'        CLIENT   RECORD DATA                   *         
*                   '3'        PRODUCT  RECORD DATA                   *         
*                   '4'        ESTIMATE RECORD DATA                   *         
*                   '5'        GROUP    RECORD DATA                   *         
*                   '6'        OFFICE   RECORD DATA                   *         
*                 'I' - BUY      RECORD DATA AND BILL HEADER DATA     *         
*                 'J' - BUY      RECORD DATA FOUND IN CLRST ELEMENTS  *         
*                 'K' - CLEARANCE STATUS RECORD DATA                  *         
*                 'L' - BILL HEADER     DATA                          *         
*                 'M' - BUY      RECORD DATA FOUND IN BILL ELEMENTS   *         
*                 'N' - BUY      RECORD DATA FOUND IN PAY  ELEMENTS   *         
*                 '                 DOES NOT REQUIRE CHECK TO BE CUT  *         
*                 'O' - BUY      RECORD DATA FOUND IN ACH  ELEMENTS   *         
*                 'P' - PUB      RECORD DATA                          *         
*                 'Q' - CASH APPLICATION DATA                         *         
*                 'S' - SHIPPING DATA - VARIOUS RECORDS               *         
*                 'T' - TRAFFIC  DATA - VARIOUS RECORDS               *         
*                 'U' - BUY      RECORD DATA FOUND IN NEW INV ELMS    *         
*                 'W' - ISSUE RECORD DATA                             *         
*                 'X' - INVOICE RECORD DATA                           *         
*                 'Y' - NEW INVOICE RECORD DATA                       *         
*                                                                     *         
***********************************************************************         
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        INITIALIZATION                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
T40509   CSECT                                                                  
         PRINT NOGEN                                                            
         NMOD1 300,PRWRITER,R7,R5                                               
*                                                                               
         L     RA,0(R1)            ESTABLISH DRIVER WORKAREA                    
         USING GLOBALD,RA                                                       
*                                                                               
         ST    RC,MYWORK           SAVE POINTER TO WORKING STORAGE              
*                                                                               
         L     RC,GLAWORKD         ESTABLISH GENCON WORKAREA                    
         USING GEND,RC                                                          
*                                                                               
         L     R8,ASPOOLD          ESTABLISH SPOOL WORKAREA                     
         USING SPOOLD,R8                                                        
*                                                                               
         L     R9,ASYSD            ESTABLISH PRINT WRITER WORKAREA              
         USING SYSD,R9                                                          
*                                                                               
         EJECT                                                                  
*                                                                               
*        DETERMINE SERVICE REQUESTED                                            
*                                                                               
         CLI   GLHOOK,GLRESOLV     RESOLVE ADDRESSES                            
         BNE   GLHRSLVN                                                         
*                                                                               
         MVI   LEVELID,0              INITIALIZE FOR EVERY REQUEST              
         GOTO1 =A(RESOLVER)                                                     
         B     XIT                                                              
*                                                                               
GLHRSLVN DS    0H                                                               
*                                                                               
         CLI   GLHOOK,GLROUT       EXECUTE ROUTINES                             
         BE    EXEC                                                             
*                                                                               
         CLI   GLHOOK,GLPUTSRT     PUT SORT RECORD                              
         BNE   GLHPUTN                                                          
*                                                                               
         GOTO1 =A(PUTSRT)                                                       
*                                                                               
         B     XIT                                                              
*                                                                               
GLHPUTN  DS    0H                                                               
*                                                                               
         CLI   GLHOOK,GLPRINT      PRINT A LINE                                 
         BNE   GLHPRNTN                                                         
*                                                                               
         GOTO1 =A(PRINTLN)                                                      
*                                                                               
         B     XIT                                                              
*                                                                               
GLHPRNTN DS    0H                                                               
*                                                                               
         CLI   GLHOOK,GLHEAD       HEADLINE HOOK                                
         BNE   GLHHEADN                                                         
*                                                                               
         GOTO1 GENHEAD             LINE UP HEADLINES                            
*                                                                               
GLHHEADN DS    0H                                                               
*                                                                               
YES      XR    RC,RC                                                            
NO       LTR   RC,RC                                                            
XIT      XIT1                                                                   
*                                                                               
         TITLE 'EXECUTE KEYWORD ROUTINE -   EXEC'                               
***********************************************************************         
*                                                                     *         
*        EXECUTE KEYWORD ROUTINE                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
EXEC     DS    0H                                                               
*                                                                               
         MVC   WORK,SPACES         PRESET WORK AREAS                            
         ZAP   DUB,=P'0'                                                        
*                                                                               
         L     R2,GLAIFLD          R2=A(INPUT)                                  
         L     R3,GLAOFLD          R3=A(OUTPUT)                                 
*                                                                               
         CLI   GLMODE,GLOUTPUT                                                  
         BE    EXECOUT                                                          
*                                                                               
*        ** INPUT ROUTINE **                                                    
*                                                                               
         CLI   SORTSW,C'D'         IF SORT DELETE DONE                          
         BNE   *+8                                                              
         MVI   SORTSW,0               RESET SORTSW                              
*                                                                               
         L     R4,PBAIO1           R4=A(PRINT FILE RECORD)                      
         LR    R6,R4                                                            
*                                                                               
*        FIND FILTER AREA ADDRESS                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,GLARGS+6       GET KEYWORD NUMBER                           
         BZ    EXIFLTX             NONE GIVEN                                   
*                                                                               
         LA    RE,FLTAREAL         LENGTH OF FILTER SAVEAREA                    
         BCTR  RF,0                DECREMENMT FOR INDEXING                      
         MR    RE,RE               CALCULATE INDEX AMOUNT                       
*                                                                               
         L     RE,AFLTTAB          POINT TO FILTER SAVEAREAS                    
         LA    RE,0(RF,RE)         POINT TO THIS KEYWORD'S AREA                 
         ST    RE,FLTFLTRA         SAVE ADDRESS                                 
*                                                                               
EXIFLTX  DS    0H                                                               
*                                                                               
         GOTO1 =V(COLFLTR)         APPLY COLUMN FILTERS                         
         BNE   EXECX               DROP RECORD                                  
*                                                                               
         CLI   GLARGS,C'G'         IF JOB RECORD FIELD                          
         BNE   EXIJOBX                                                          
*                                                                               
         CLI   PBUYKRCD-PBUYKEY(R6),PBUYKIDQ AND BUY IN CORE                    
         BE    *+8                                                              
         CLI   PBUYKRCD-PBUYKEY(R6),PBUYPIDQ                                    
         BE    EXEC11                 TREAT AS BASIC BUY KEYWORD                
*                                                                               
EXIJOBX  DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'B'         IF BUY RELATED FIELD                         
         BE    *+8                                                              
         CLI   GLARGS,C'O'         IF BUY RELATED FIELD                         
         BE    *+8                                                              
         CLI   GLARGS,C'K'         IF BUY RELATED FIELD                         
         BE    *+8                                                              
         CLI   GLARGS,C'J'         IF BUY RELATED FIELD                         
         BE    *+8                                                              
         CLI   GLARGS,C'M'         IF BUY RELATED FIELD                         
         BE    *+8                                                              
         CLI   GLARGS,C'Q'         IF BUY RELATED FIELD                         
         BE    *+8                                                              
         CLI   GLARGS,C'N'         IF BUY RELATED FIELD                         
         BE    *+8                                                              
         CLI   GLARGS,C'I'         IF BUY RELATED FIELD                         
         BNE   EXIINGO                                                          
*                                                                               
         CLI   PBUYKRCD-PBUYKEY(R6),PBUYKIDQ THEN MUST HAVE BUY IN CORE         
         BE    *+8                                                              
         CLI   PBUYKRCD-PBUYKEY(R6),PBUYPIDQ                                    
         BE    EXEC10                                                           
*                                                                               
         L     R1,GLADTENT             ESTABLISH INPUT DRIVETABLE ENTRY         
         USING DRIND,R1                                                         
*                                                                               
         CLC   DRINROUT,=CL8'IBLISTCD'  UNLESS PUBLIST KEYWORD                  
         BE    EXIINGO                                                          
*                                                                               
         CLC   DRINROUT,=CL8'IINDATE'   UNLESS INSDATE                          
         BNE   EXECX                                                            
*                                                                               
         CLI   PBMODE,PBPROCES        AND PROCESSING ESTIMATES                  
         BE    *+8                                                              
         CLI   PBMODE,PBPROCIV        OR  PROCESSING INVOICES                   
         BE    *+8                                                              
         CLI   PBMODE,PBPROCNV        OR  PROCESSING INVOICES                   
         BNE   EXECX                                                            
*                                                                               
         B     EXIINGO                                                          
*                                                                               
EXEC10   DS    0H                                                               
*                                                                               
         TM    PBQACHGS,PBQACOPQ   SKIP IF ADDL CHARGES INVOLVED                
         BO    EXEC09                                                           
*                                                                               
         CLI   GLARGS,C'B'         IF TOTAL BUY RELATED FIELD                   
         BNE   EXEC09                                                           
*                                                                               
EXEC11   DS    0H                                                               
*                                                                               
         L     R1,GLADTENT             ESTABLISH INPUT DRIVETABLE ENTRY         
         USING DRIND,R1                                                         
*                                                                               
         OC    PBPAYELA,PBPAYELA      AND PAY  ELEMENT POINTED TO               
         BNZ   *+10                                                             
         OC    PBCLSELA,PBCLSELA      OR  CLS  ELEMENT POINTED TO               
         BNZ   *+10                                                             
         OC    PBBLLELA,PBBLLELA      OR  BILL ELEMENT POINTED TO               
         BNZ   *+10                                                             
         OC    PBPNVELA,PBPNVELA      OR  NEW INVOICE  POINTED TO               
         BNZ   *+10                                                             
         OC    PBBHDELA,PBBHDELA      OR  BILL HEADER ELEMENT                   
******   BZ    EXEC09                                                           
         BZ    EXEC091                                                          
*                                                                               
         CLC   DRINROUT,=CL8'IAADT'    SKIP IF ACTIVITY DATE ROUTINE            
         BE    *+10                                                             
         CLC   DRINROUT,=CL8'IAGLDLR'  OR      AGING DOLLARS ROUTINE            
         BE    EXEC09                                                           
*                                                                               
EXEC091  DS    0H                                                               
*                                                                               
         TM    PBBYOPT2,PBBY1STQ   SKIP IF FIRST TIME TO WRITER                 
         BO    EXEC09                                                           
*                                                                               
         TM    PBBYOPT2,PBBYCPYQ   SKIP IF NOT  COPY SPLIT PROCESSING           
         BNO   EXEC092                                                          
*                                                                               
         CLI   GLARGS,C'G'         SKIP IF JOB KEYWORD                          
         BE    EXEC09                                                           
*                                                                               
         TP    PBSUBSHR            SKIP IF SUB ADCODE SHARE PRESENT             
         BZ    EXEC09                                                           
*                                                                               
EXEC092  DS    0H                                                               
*                                                                               
         CLI   DRINTYPE+1,C'+'            SKIP ALL ADDITIVE FIELDS              
         BE    EXECX                                                            
*                                                                               
EXEC09   DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'J'         IF PAY  ELEMENT RELATED FIELD                
         BE    *+8                                                              
         CLI   GLARGS,C'N'         IF PAY  ELEMENT RELATED FIELD                
         BE    *+8                                                              
         CLI   GLARGS,C'K'                                                      
         BNE   EXI090                                                           
*                                                                               
         OC    PBPAYELA,PBPAYELA      MUST HAVE ONE                             
         BZ    EXECX                                                            
*                                                                               
         B     EXIINGO                                                          
*                                                                               
EXI090   DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'M'         IF BILL ELEMENT RELATED FIELD                
         BE    *+8                                                              
         CLI   GLARGS,C'Q'         IF BILL ELEMENT RELATED FIELD                
         BE    *+8                                                              
         CLI   GLARGS,C'I'                                                      
         BNE   EXI09A                                                           
*                                                                               
         ICM   RF,15,PBBLLELA      POINT TO BILL ELEMENT                        
         BZ    EXECX               MUST HAVE ONE                                
*                                                                               
         CLI   GLARGS+1,C'L'       BILL TYPE MUST MATCH FIELD'S TYPE            
         BNE   *+12                BILLED                                       
         CLI   0(RF),PBILELQ                                                    
         BNE   EXECX                                                            
*                                                                               
         CLI   GLARGS+1,C'O'       OPEN                                         
         BNE   *+12                                                             
         CLI   0(RF),PBILOPNQ                                                   
         BNE   EXECX                                                            
*                                                                               
         CLI   GLARGS+1,C'R'       REBATE                                       
         BNE   *+12                                                             
         CLI   0(RF),PBILREBQ                                                   
         BNE   EXECX                                                            
*                                                                               
         B     EXIINGO                                                          
*                                                                               
EXI09A   DS    0H                                                               
*                                                                               
EXIINGO  DS    0H                                                               
*                                                                               
*        BECAUSE NOT ALL ROUTINES SAVE REGISTERS ON ENTRY                       
*        WE NEED SPECIAL CODE TO FORCE RETURN TO HERE                           
*                                                                               
         LA    RE,EXIINRET         POINT TO RETURN POINT                        
EXINSAV  NTR1                      SAVE CURRENT REGISTERS                       
*                                                                               
         L     RF,GLAROUT       ** BRANCH TO I/O ROUTINE **                     
         BASR  RE,RF                                                            
*                               ROUTINES THAT SAVE REGS RETURN HERE             
         XIT1                   UNSAVE REGISTERS                                
*                                                                               
EXIINRET DS    0H                  EVERYONE WINDS UP HERE                       
*                                                                               
         CLI   GLARGS+7,C'$'       IF DATA NOT TO BE FLOWCHARTED                
         BE    EXIFLW                                                           
*                                                                               
         TM    STACKSW,STCKMRGQ       SKIP IF NOT MERGING DATA                  
         BNO   EXIFLWX                                                          
*                                                                               
         B     EXIFLW10               DO END OF RECORD STACKING ROUTINE         
*                                                                               
EXIFLW   DS    0H                                                               
*                                                                               
         GOTO1 =V(DOFLOW)          FLOWCHART DATA                               
*                                                                               
         CLI   FLOWDATA,C'Y'          IF SIGNIFICANT DATA FOUND                 
         BNE   EXIFLWX                                                          
         TM    STACKSW,STACKYQ        AND STACKING                              
         BNO   EXIFLWX                                                          
*                                                                               
EXIFLW10 DS    0H                                                               
*                                                                               
         NI    STACKSW,X'FF'-STCKINIQ  TURN OFF INIT SWITCH                     
*                                                                               
         GOTO1 =V(XSTACK)          GO HANDLE STACKING FOR DATA                  
*                                                                               
EXIFLWX  DS    0H                                                               
*                                                                               
         B     EXECX                                                            
*                                                                               
         EJECT                                                                  
*                                                                               
*        ** OUTPUT ROUTINE **                                                   
*                                                                               
EXECOUT  MVC   OUTAREA,SPACES      PRESET SOME FIELDS FOR OUTPUT                
*                                                                               
         L     R1,GLADTENT         POINT TO DRIVE TABLE ENTRY                   
         USING DROD,R1             ESTABLISH AS OUTPUT ELEMENT                  
*                                                                               
         CLI   DROEL,X'30'         SKIP IF NOT OUTPUT ROUTINE                   
         BNE   EXECOUT0                                                         
*                                                                               
         TM    PBQCFOPT,PBQCFNDQ   IF PRINTING ONLY IF THERE IS DATA            
         BNO   EXECOUT0                                                         
*                                                                               
         CLI   SORTSW,C'P'         SKIP IF ALREADY PRINTING LINE                
         BE    EXECOUT0                                                         
*                                                                               
         MVI   SORTSW,C'X'         INIT PRINT SWITCH TO SUPPRESS                
*                                                                               
EXECOUT0 DS    0H                                                               
*                                                                               
         CLC   GLLABEL,=CL8'NOREPORT' SKIP TEST IF GRAND TOTALS ROUTINE         
         BE    *+10                                                             
         LTR   R2,R2               SKIP IF NO INPUT AVAILABLE                   
         BZ    EXECX                                                            
*                                                                               
         L     R1,GLADTENT         POINT TO DRIVE TABLE ENTRY                   
         USING DROD,R1             ESTABLISH AS OUTPUT ELEMENT                  
*                                                                               
         CLI   DROLTYP,C'N'        NO PRINT - NOT INTERESTED                    
         BE    EXECX                                                            
*                                                                               
         MVC   MYPOSO,DROPOS       SAVE PRINT POSITION AND                      
         MVC   MYOLEN,DROLEN       OUTPUT AREA WIDTH                            
*                                                                               
         L     R1,GLATHID                                                       
         USING GLINTD,R1                                                        
*                                                                               
         CLC   GLLEVEL,GLDETLEV    CLEAR ACCUMULATORS IF LEVEL                  
         BNL   EXECXS                 LOWER THAN DETAIL LEVEL                   
*                                                                               
         GOTO1 =A(CLEARCUM)        CLEAR ACCUMULATORS                           
*                                                                               
EXECXS   DS    0H                  POST ACCUMULATORS                            
*                                                                               
         GOTO1 =A(POSTCUM)         POST ACCUMULATORS                            
*                                                                               
         DROP  R1                                                               
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL FROM HEADLINES                   
*                                                                               
EXECGO   DS    0H               ** BRANCH TO I/O ROUTINE **                     
*                                                                               
*        BECAUSE NOT ALL ROUTINES SAVE REGISTERS ON ENTRY                       
*        WE NEED SPECIAL CODE TO FORCE RETURN TO HERE                           
*                                                                               
         LA    RE,EXOUTRET         POINT TO RETURN POINT                        
EXOUTSAV NTR1                      SAVE CURRENT REGISTERS                       
*                                                                               
         L     RF,GLAROUT       ** BRANCH TO I/O ROUTINE **                     
         BASR  RE,RF                                                            
*                               ROUTINES THAT SAVE REGS RETURN HERE             
         XIT1                   UNSAVE REGISTERS                                
*                                                                               
EXOUTRET DS    0H                  EVERYONE WINDS UP HERE                       
*                                                                               
*        CHECK IF PRINTING TO BE SUPPRESSED IF THIS KEYWORD HAS NO              
*        DATA TO PRINT                                                          
*                                                                               
         L     R1,GLADTENT         POINT TO DRIVE TABLE ENTRY                   
         USING DROD,R1             ESTABLISH AS OUTPUT ELEMENT                  
*                                                                               
         CLI   DROEL,X'30'         IF NOT OUTPUT ROUTINE                        
         BE    *+12                                                             
         MVI   SORTSW,C'P'            FORCE PRINTING                            
         B     EXECOUT1                                                         
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFNDT)),0                
*                                                                               
         OC    8(4,R1),8(R1)                                                    
         BZ    EXECOUT1            NO SUPPRESSION                               
*                                                                               
         L     R1,GLADTENT         POINT TO DRIVE TABLE ENTRY                   
         USING DROD,R1             ESTABLISH AS OUTPUT ELEMENT                  
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,DROLEN         OUTPUT LENGTH                                
         BZ    EXECOUT1            SKIP IF NOTHING PRINTED                      
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R3),SPACES      CHECKS FOR PRINTED OUTPUT                    
         BNH   EXECOUT1            NOTHING PRINTED                              
*                                                                               
         MVI   SORTSW,C'P'         SOMETHING PRINTED - FORCE PRINTING           
*                                                                               
EXECOUT1 DS    0H                                                               
*                                                                               
*        CHECK IF THIS FIELD IS BEING COUNTED                                   
*                                                                               
         TM    PBQCFOPT,PBQCFCTQ   SKIP IF NO FIELD BEING COUNTED               
         BNO   EXECOUT2                                                         
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFCT)),0                 
*                                                                               
         OC    8(4,R1),8(R1)                                                    
         BZ    EXECOUT2            NO COUNTING                                  
*                                                                               
         GOTO1 =V(COUNT)           GO PROCESS COUNT FUNCTION                    
*                                  IN PRWRICFL                                  
*                                                                               
EXECOUT2 DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQCFPAQ   IF RESETTING PAGE NUMBER TO 1                
         BNO   EXECOUT3                                                         
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFPGE)),0                
*                                                                               
         OC    8(4,R1),8(R1)       CHECK IF FILTER FOUND                        
         BZ    EXECOUT3               NONE FOUND                                
*                                                                               
         BRAS  RE,PGEFORM          HANDLE PAGE FORMATTING                       
*                                                                               
EXECOUT3 DS    0H                                                               
*                                                                               
EXECX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DROP  R1                                                               
         EJECT                                                                  
*                                                                               
*-------------->           INPUT ROUTINES                                       
*                                                                               
IDUMMY   MVI   0(R2),1             DUMMY                                        
         B     XIT                                                              
*                                                                               
*-------------->     COMPUTE                                                    
*                                                                               
ICOMPUTE ZAP   0(8,R2),=P'0'       COMPUTE                                      
         B     XIT                                                              
*                                                                               
*-------------->    POOL SPLIT                                                  
*                                                                               
IPOLSPLT DS    0H                                                               
         MVC   0(3,R2),PBPROD        PRODUCT                                    
*                                                                               
         LH    RF,=Y(PPBYOUTC-SYSD)  DISPLACEMENT OF PPBYOUT AREA               
         AR    RF,R9                                                            
         USING PPBYOUTD,RF         ESTABLISH PPBYOUT AREA                       
*                                                                               
         MVC   3(50,R2),PBYOZZZ      POOL SPLIT                                 
*                                                                               
         B     XIT                                                              
*                                                                               
         DROP  RF                                                               
*                                                                               
*-------------->    ESTIMATE NUMBER                                             
*                                                                               
IESTNUMB DS    0H                                                               
*                                                                               
         MVC   0(2,R2),PBEST       ONLY ESTIMATE NUMBER                         
*                                                                               
         CLI   GLARGS+1,C'A'       IF ATT CODE                                  
         BNE   *+16                                                             
         MVC   0(1,R2),PBMED          MEDIA CODE                                
         MVC   1(2,R2),PBEST          ESTIMATE NUMBER                           
*                                                                               
         B     XIT                                                              
         EJECT                                                                  
*                                                                     *         
*        ROUTINE TO COMBINE CON-UNIT AND BACTIVE INTO ONE - INPUT     *         
*                                                                     *         
         SPACE 2                                                                
ICONUNAC DS    0H                                                               
*                                                                               
         GOTO1 =A(IACTIVE)         GET ACTIVITY INDICATOR                       
*                                                                               
         LA    R2,32(R2)           POINT TO CON-UNIT AREA                       
         B     ICLV4BUY            HANDLE CON-UNIT INPUT                        
*                                                                               
*                                                                               
*-------------->       COUNT                                                    
*                                                                               
ICOUNT   DS    0H                                                               
         ZAP   0(8,R2),=P'1'           COUNT                                    
         B     XIT                                                              
*                                                                               
*-------------->    NUMBER OF BUY RECORDS                                       
*                                                                               
INUMINS  DS    0H                                                               
*========              ========*                                                
         USING PBUYRECD,R4                                                      
*========              ========*                                                
*                                                                               
*        FIRST CHECK IF KEYWORD BEING FILTERED                                  
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQBUYS),0,0                                  
*                                                                               
         ICM   R6,15,DMCB+8        POINT TO FOUND FILTER                        
         BZ    INUMINS8            NO FILTER USE DEFAULT                        
*                                                                               
         USING FLTCTL,R6           ESTABLISH FILTER                             
*                                                                               
INUMINS1 DS    0H                  EXCLUDE #BUYS                                
*                                                                               
         CLC   =AL2(PRQBYS#N),FLTFVAL   IF EXCLUDING #BUYS                      
         BNE   INUMINS2                                                         
*                                                                               
         CLI   PBDSPACE,C'#'              IF #BUY                               
         BE    INUMINSX                      DROP FROM TOTAL                    
         B     INUMINS8                   ELSE TEST DEFAULT                     
*                                                                               
INUMINS2 DS    0H                  #BUYS ONLY                                   
*                                                                               
         CLC   =AL2(PRQBYS#Y),FLTFVAL   IF #BUYS ONLY                           
         BNE   INUMINS3                                                         
*                                                                               
         CLI   PBDSPACE,C'#'              IF #BUY                               
         BE    INUMINS9                      INCLUDE IN TOTAL                   
         B     INUMINSX                   ELSE DROP FROM TOTAL                  
*                                                                               
INUMINS3 DS    0H                      *BUYS ONLY                               
*                                                                               
         CLC   =AL2(PRQBYSSY),FLTFVAL   IF *BUYS ONLY                           
         BNE   INUMINS4                                                         
*                                                                               
         CLI   PBDSPACE,C'*'              IF *BUY                               
         BE    INUMINS9                      INCLUDE IN TOTAL                   
         B     INUMINSX                   ELSE DROP FROM TOTAL                  
*                                                                               
INUMINS4 DS    0H                                                               
*                                                                               
INUMINS8 DS    0H                  DEFAULT - EXCLUDE *BUYS ONLY                 
*                                                                               
         CLI   PBDSPACE,C'*'       SKIP *BUYS IS DEFAULT                        
         BE    INUMINSX                                                         
*                                                                               
INUMINS9 DS    0H                  COUNT BUY                                    
*                                                                               
         ZAP   0(8,R2),=P'1'     BUY COUNT                                      
*                                                                               
         GOTO1 =V(DOFLOW)                                                       
*                                                                               
         B     CHK4TST           TEST BUY                         L09           
*                                                                               
INUMINSX DS    0H                                                               
         B     XIT                                                              
*                                                                               
         DROP  R6                                                               
*                                                                               
*-------------->    PRODUCT CODE                                                
*                                                                               
IPRD     DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCNV     IF PROCESSING NEW INVOICES                   
         BNE   IPRD20                                                           
*                                                                               
         ICM   R6,15,PBIDTELA      ESTABLISH DETAIL ELEMENT                     
         BZ    IPRD10                NONE AVAILABLE                             
         USING PNVDTLD,R6                                                       
*                                                                               
         MVC   0(3,R2),PNVDPRD     RETURN PRODUCT CODE                          
*                                                                               
         CLC   0(3,R2),SPACES      DONE IF WE HAVE A PRODUCT CODE               
         BH    IPRD90                                                           
*                                                                               
IPRD10   DS    0H                                                               
*                                                                               
         ICM   R6,15,PBIHDELA      ESTABLISH HEADER ELEMENT                     
         BZ    IPRD90                 NONE AVAILABLE                            
         USING PNVHDRD,R6                                                       
*                                                                               
         MVC   0(3,R2),PNVHPRD     RETURN PRODUCT CODE                          
*                                                                               
         B     IPRD90                                                           
*                                                                               
IPRD20   DS    0H                                                               
*                                                                               
         MVC   0(3,R2),PBPROD      PRODUCT                                      
*                                                                               
IPRD90   DS    0H                                                               
*                                                                               
*        ESTIMATE DROPS PRODUCT FROM ITS ENTRY IF PRODUCT NOT HIGHER            
*        IN KEY. LOGIC FOR DETERMINING IF PRD IN KEY IS IN VALROWS.             
*        DPG PROGRAMS MAY NOT USE THIS LOGIC. IF NO LEVELS SET                  
*        FORCE PRODUCT IN KEY INDICATOR.                                        
*                                                                               
         OC    LEVELTYP,LEVELTYP   IF NO TYPES STORED YET                       
         BNZ   *+8                                                              
         MVI   LEVELTYP,X'08'      INDICATE PRODUCT IN KEY                      
*                                                                               
         B     XIT                                                              
*                                                                               
*-------------->    BILLING GROUP                                               
*                                                                               
IBILLCOD MVC   0(1,R2),PBCBLGP     BILLING GROUP                                
         CLI   PBQSLAVE,C'Y'                                                    
         BNE   IBILLCO1                                                         
*========              ========*                                                
         ICM   RF,15,PBCLTADR                                                   
         BZ    IBILLCO1                                                         
         USING PCLTRECD,RF                                                      
*========              ========*                                                
         MVC   0(1,R2),PCLTBLGP    SLAVE BILLING GROUP                          
IBILLCO1 CLI   0(R2),0             ANYTHING THERE                               
         BH    *+8                                                              
         MVI   0(R2),X'FF'         NO - FORCE TO SORT LAST                      
         B     XIT                                                              
*                                                                               
*-------------->      CLIENT MEDIA OFFICE CODE                                  
*                                                                               
ICLOFF   MVC   0(1,R2),PBOFC       CLIENT MEDIA OFFICE CODE                     
*                                                                               
         CLI   PBQSLAVE,C'Y'                                                    
         BNE   ICLOFF1                                                          
*                                                                               
         ICM   RF,15,PBCLTADR                                                   
         BZ    ICLOFF1                                                          
*                                                                               
         USING PCLTRECD,RF                                                      
*                                                                               
         MVC   0(1,R2),PCLTOFF     CLIENT MEDIA OFFICE CODE                     
*                                                                               
ICLOFF1  DS    0H                                                               
*                                                                               
*        TRANSLATE 2 CHARACTER OFFICE CODE                                      
*                                                                               
         LA    R3,WORK                USE OFFICER                               
         XC    WORK,WORK                                                        
*                                                                               
         USING OFFICED,R3                                                       
*                                                                               
         MVI   OFCSYS,C'P'         SYSTEM                                       
         MVC   OFCAGY,AGENCY       AGENCY ID                                    
         MVC   OFCOFC,0(R2)        INTERNAL OFFICE CODE                         
*                                                                               
         GOTO1 PBVOFFCR,DMCB,(C'2',OFFICED),(X'01',PBCOMFAC),          X        
               (C'L',2(R2))                                                     
*                                                                               
         MVC   0(2,R2),OFCOFC2     2 CH OFFICE CODE                             
*                                                                               
         CLI   GLARGS+2,C'C'       SKIP IF CODE ONLY                            
         BE    ICLOFFX                                                          
*                                                                               
         CLI   GLARGS+2,C'A'       IF ALPHA SORT                                
         BNE   *+10                                                             
         XC    0(2,R2),0(R2)          CLEAR COPY OF CODE                        
*                                                                               
ICLOFFX  DS    0H                                                               
*                                                                               
         OC    0(22,R2),0(R2)      ANYTHING THERE                               
         BNZ   *+8                                                              
         MVI   0(R2),X'FF'         NO - FORCE TO SORT LAST                      
*                                                                               
         B     XIT                                                              
*                                                                               
         DROP  R3,RF                                                            
*                                                                               
*-------------->     STATE CODE                                                 
*                                                                               
ISTATE   DS    0H                                                  L17          
*========              ========*                                                
         L     R6,AIO3                                                          
         USING PUBNAMD,R6          PUBADDRESS                     BUG07         
*========              ========*                                                
         MVI   ELCODE,X'10'                                       BUG07         
         BAS   RE,GETEL                                           BUG07         
         BNE   XIT                                                BUG07         
         MVC   0(2,R2),PUBSTATE                                    L17          
         B     XIT                                                 L17          
*                                                                               
*************************                                                       
*-------------->    ACTIVITY DATE                                               
*************************                                                       
IACTDATE DS    0H                                                  L22          
         CLI   GLARGS,C'A'                                                      
         BE    IAACTV                                                           
         USING PBUYRECD,R4                                                      
         L     R4,AIO1                                             L22          
         TM    PBUYCNTL,X'80'    DELETED                                        
         BNO   XIT                                                 L22          
IAACTV   MVC   0(3,R2),PBDDATE     ACTIVITY DATE                   L22          
         B     XIT                                                 L22          
         EJECT                                                                  
**************                                                                  
*-------------->    CLIENT VENDOR                                               
*************                                                                   
ICLIVEND GOTO1 =A(COMMON1),DMCB,RTICLVEN                           L19          
         B     XIT                                                 L19          
**************                                                                  
*-------------->    PUBLISHER                                                   
*************                                                                   
IPUBLSH  DS    0H                                                               
*                                                                               
         GOTO1 =A(IPUBLSHR)                                                     
*                                                                               
         B     XIT                                                              
*                                                                               
*-------------->       ESTIMATE                                                 
*                                                                               
IEST     DS    0H                                                               
         GOTO1 =A(COMMON2),DMCB,RTIEST                             L27          
         B     XIT                                                              
*                                                                               
*========              ========*                                                
         USING PBILLRCD,R4                                                      
*========              ========*                                                
IBJOB    MVI   ELCODE,9            JOB   FROM BILLING RECORD                    
         BAS   RE,GETEL                                                         
         BE    IBJOBOK                                                          
*========              ========*                                                
         ICM   RE,15,PBCLTADR                                                   
         BZ    DCH0                                                             
         USING PCLTRECD,RE                                                      
*========              ========*                                                
         CLI   PCLTFIN,C'Y'        IS THIS A FINANCIAL CLIENT                   
         BNE   IBJOBNON            IF YES -- REAL PROBLEM                       
*        ========  *                                                            
         DROP  RE                                                               
*        ========  *                                                            
DCH0     DC    H'0'                                                             
*========              ========*                                                
         USING PBILOTH,R6                                                       
*========              ========*                                                
IBJOBOK  MVC   0(6,R2),PBILLJOB                                                 
         MVC   6(1,R2),PBMED                                                    
         CLI   PBQMED,C'C'                                                      
         BNE   *+8                                                              
         MVI   6(R2),C'C'                                                       
         MVC   7(3,R2),PBCLT                                                    
         MVC   10(3,R2),PBPROD                                                  
         CLC   PBILLJOB(3),=X'FFD7D6'                                           
         BE    *+10                                                             
         CLC   PBILLJOB,SPACES                                                  
         BH    XIT                                                              
IBJOBNON MVC   0(6,R2),=C'*NONE*'                                               
         B     XIT                                                              
*        ========  *                                                            
         DROP  R4,R6                                                            
*        ========  *                                                            
*                                                                               
*------------->   CONTRACT NAME / START & END DATE / CD ==============          
*                                                                               
IBCONTR  DS   0H                                                                
*========              ========*                                                
         L     RF,AIO2              WHERE CONTRACT IS                           
         USING PCONRECD,RF                                                      
*========              ========*                                                
         CLC   GLARGS+1(2),=C'CD'  FIND PCATELEM IF CASH DISCOUNT               
         BE    *+10                  WANTED                                     
         CLC   GLARGS+1(2),=C'MX'  FIND PCATELEM IF MAX INSERTS                 
         BE    *+10                  WANTED                                     
         CLC   GLARGS+1(2),=C'MZ'  FIND PCATELEM IF MAX INSERTS                 
         BE    IBCCATEL              ACROSS ZONES WANTED                        
*                                                                               
         CLC   GLARGS+1(2),=C'NU'  CONTRACT NUMBER                 L24          
         BNE   IBCSTEND                                            L24          
         EDIT  (2,PCONNUM),(3,(R2)),ZERO=NOBLANK,FILL=0            L24          
         B     IBCONTRX                                            L24          
*                                                                               
IBCSTEND DS    0H                                                  L24          
         CLC   GLARGS+1(2),=C'ST'  START CONTRACT DATE             L24          
         BNE   IBCONN                                              L24          
         MVC   0(6,R2),PCONSDT                                     L24          
         B     IBCONTRX                                            L24          
*                                                                               
IBCONN   CLI   GLARGS+1,C'N'       SORT BY NUNBER                               
         BNE   IBCONN1                                                          
*                                                                               
         MVC   0(6,R2),PBPUB                                    L02             
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   *+10                                                             
         MVC   0(6,R2),PAORPUB        USE AOR PUB NUMBER                        
*                                                                               
IBCONN1  DS    0H                                                               
*                                                                               
         MVC   6(20,R2),PBPUBNM     PUB NAME                    L02             
         MVC   28(6,R2),PBPUB       PUB NO/ZONE/ED                              
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   *+10                                                             
         MVC   28(6,R2),PAORPUB       USE AOR PUB NUMBER                        
*                                                                               
         CLC   PCONNUM,=X'FFFF'     CONTRACT NOT FOUND (BUY FLAVOR WITH         
         BNE   IBCONAA              SOME CONTRACT RELATED DATA RQSTED))         
         MVI   0(R2),255                                                        
         B     IBCONTRX                                                         
**                                                                              
**                                                                              
IBCONAA  MVC   34(6,R2),PCONSDT     CONTRACT START & END DATE                   
         ZAP   40(3,R2),=P'0'       CASH DISCOUNT                               
         MVC   43(2,R2),PCONNUM     CONTRACT NUMBER                             
*                                                                               
IBCCATEL DS    0H                                                               
*========              ========*                                                
         LR    R6,RF                                                            
         MVI   ELCODE,X'50'       FIND CONTRACT OVERRIDE CASH DISCOUNT          
         BAS   RE,GETEL                                                         
         BNE   GETFRMPU           GET FROM PUB                                  
         USING PCATELD,R6                                                       
*========              ========*                                                
         CLC   GLARGS+1(2),=C'MX'  SKIP IF NOT MAX INSERTS                      
         BNE   IBCMAXN                                                          
*                                                                               
         MVC   0(2,R2),PCATMAX     RETRIEVE MAX INSERTS/ISSUE                   
         MVC   2(2,R2),=X'0001'    COUNTER                                      
         B     IBCONTRX                                                         
*                                                                               
IBCMAXN  DS    0H                                                               
*                                                                               
         CLC   GLARGS+1(2),=C'MZ'  SKIP IF NOT MAX INSERTS ACROSS ZONES         
         BNE   IBCMAXZN                                                         
*                                                                               
         MVC   0(2,R2),PCATMAXZ    RETRIEVE MAX INS/ISS ACROSS ZONES            
         B     IBCONTRX                                                         
*                                                                               
IBCMAXZN DS    0H                                                               
*                                                                               
IBCCD    DS    0H                  SKIP IF NOT CASH DISCOUNT WANTED             
*                                                                               
         CLC   GLARGS+1(2),=C'CD'  CASH DISCOUNT                                
         BNE   IBCCDN                                                           
*                                                                               
         CLI   PCATPCT,X'FF'         IF X'FF' NO DISCOUNT FOR CONTRACT          
         BE    IBCCDX                                                           
*                                                                               
         OC    PCATPCT,PCATPCT     IF 00 DEFAULT TO PUB                         
         BZ    GETFRMPU                                                         
*                                                                               
         XR    RF,RF                                                            
         LH    RF,PCATPCT                                                       
         MH    RF,=H'10'           ADD DECIMAL PLACE                            
         CVD   RF,DUB                                                           
         ZAP   0(3,R2),DUB+5(3)    CASH DISCOUNT                                
*                                                                               
IBCCDX   DS    0H                                                               
*                                                                               
         B     IBCONTRX                                                         
*                                                                               
IBCCDN   DS    0H                                                               
*                                                                               
IBCATT   DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'A'       ATTENTION OF RQSTED                          
         BNE   IBCATTN                                                          
         MVC   45(30,R2),PCATNAM                                                
*                                                                               
IBCATTN  DS    0H                                                               
*                                                                               
         CLI   PCATPCT,255           IF X'FF' NO DISCOUNT                       
         BE    IBCONTRX               ATTENTION OF                              
         OC    PCATPCT,PCATPCT       IF 00 DEFAULT TO PUB                       
         BZ    GETFRMPU                                                         
         XR    RF,RF                                                            
         LH    RF,PCATPCT                                                       
         MH    RF,=H'10'                                                        
         CVD   RF,DUB                                                           
         ZAP   40(3,R2),DUB+5(3)                                                
         B     IBCONTRX                                                         
*                                                                               
*========              ========*                                                
GETFRMPU L     R6,AIO3                                                          
         USING PUBGEND,R6                                                       
*========              ========*                                                
         CLC   GLARGS+1(2),=C'MX'  NON-APPLICABLE IF MAX INSERTS                
         BE    IBCONTRX                                                         
*                                                                               
         MVI   ELCODE,X'20'                                                     
         BAS   RE,GETEL                                                         
         BNE   XIT                                                              
         ZAP   DMCB(8),PUBCD       PUB CD                                       
         MP    DMCB(8),=P'10'       TO ALIGN WITH CONTRACT OVERRIDE             
*                                                                               
         CLC   GLARGS+1(2),=C'CD'  IF CD ONLY                                   
         BNE   *+14                                                             
         ZAP   0(3,R2),DMCB+5(3)      USE START OF FIELD                        
         B     IBCONTRX                                                         
*                                                                               
         ZAP   40(3,R2),DMCB+5(3)  ELSE BACK OF FIELD                           
*                                                                               
IBCONTRX DS    0H                                                               
         B     XIT                                                              
*        ========  *                                                            
         DROP  RF                                                               
*        ========  *                                                            
*                                                                               
*--------------------------------> GST TAX   =====================              
*                                                                               
IGST     DS    0H                                                               
*****    LH    RF,=Y(GSTTAX-SYSD)                                               
*****    AR    RF,R9                                                            
*****    MVC   0(4,R2),0(RF)       GST PAYABLE                                  
         B     XIT                                                              
         SPACE 3                                                                
*                                                                               
*========              ========*                                                
         USING PBUYRECD,R4                                                      
*========              ========*                                                
*                                                                               
*--------------------------------> INSERT DATE=====================             
*                                                                               
IINDATE  DS    0H                                                               
*                                                                               
         GOTO1 =A(IINDATER)                                                     
         OC    0(3,R2),0(R2)       EXIT ON NO DATA                              
         BZ    XIT                                                              
*                                                                               
***                                                                             
*  ALL DATES MUST PASS THRU TO SEE IF PERIOD TOTALS ARE NEEDED                  
***                                                                             
DATECOMM CLI   GLARGS+15,C'M'                                                   
         BE    DATEMON                                                          
         CLI   GLARGS+15,C'Q'                                                   
         BE    DATEMON                                                          
         CLI   GLARGS+15,C'W'                                                   
         BE    DATEMON                                                          
         CLI   GLARGS+15,C'Y'                                                   
         BNE   XIT                                                              
DATEMON  CLI   PBQPTSW,0                                                        
         BE    XIT                 PROBABLY FLOWCHARTING/STACKING               
         GOTO1 =A(COMMON1),DMCB,24        CONVERT DATE INTO PERIOD              
         B     XIT                                                              
*                                                                               
*------------------> BUY COMMENT ======================================         
*                                                                               
ICOMMENT DS    0H                                                               
         GOTO1 =A(PP12468),DMCB,(X'66',PBUYKEY),=C'NOSQ'                        
         B     ORDERCOM                                                         
*                                                                               
*------------------> INSERTION ORDR INSTRUCTIONS ============                   
*                                                                               
IIORDER  GOTO1 =A(PP12468),DMCB,(X'67',PBUYKEY),=C'NOSQ'                        
         B     ORDERCOM                                                         
*                                                                               
*------------------> POSITION ORDER INSTRUCTIONS =========                      
*                                                                               
IPOSIT   GOTO1 =A(PP12468),DMCB,(X'68',PBUYKEY),=C'NOSQ'                        
ORDERCOM L     R1,0(R1)    ADDR OF COMMENT TABLE                                
         CLC   0(100,R1),SPACES                                                 
         BNH   MOVEFF                   FORCE NO COMMENT TO BOTTOM              
         OC    PBABUY,PBABUY            ENSURE ADDRESS IS PRESENT               
         BZ    MOVEFF                                                           
         MVC   0(35,R2),0(R1)                                                   
         MVC   35(4,R2),PBABUY          DISK ADDRESS OF BUY REC                 
*                                                                               
         ICM   RF,15,PBUTLA        IF UTL ADDRESS SET                           
         BZ    *+10                                                             
         MVC   39(1,R2),4(RF)      PASS SE NUMBER                               
*                                                                               
         B     XIT                                                              
MOVEFF   MVI   0(R2),X'FF'                                                      
         B     XIT                                                              
*                                                                               
*------------------> Special Rep =========================                      
*                                                                               
IBYSREP  GOTO1 =A(PP12468),DMCB,(X'80',PBUYKEY),=C'NOSQ'                        
         L     R1,0(R1)                                                         
         CLC   0(4,R1),SPACES      Have special rep?                            
         JNH   IBYSR_ER                                                         
         OC    PBABUY,PBABUY                                                    
         BZ    IBYSR_ER                                                         
         MVC   0(03,R2),PBUYKEY    Agency and media code                        
         MVI   3(R2),X'11'         Rep record code                              
         MVC   4(04,R2),0(R1)      Rep code                                     
         MVC   35(4,R2),PBABUY                                                  
*                                                                               
         ICM   RF,15,PBUTLA                                                     
         BZ    *+10                                                             
         MVC   39(1,R2),4(RF)      Pass SE number                               
*                                                                               
         B     XIT                                                              
IBYSR_ER MVI   0(R2),X'FF'                                                      
         B     XIT                                                              
*                                                                               
*------------------>  RATE CODE===================================              
*                                                                               
IRTECODE DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBUY    IF READING BUYS                              
         BNO   *+14                                                             
         MVC   0(3,R2),PBDRCODE       USE BUY RATE CODE                         
         B     IRTECDX                                                          
*                                  ELSE                                         
         ICM   R1,15,PBQCRTA          USE SPACE IN PASSED CONT RATE ELM         
         BZ    IRTECDX                EXIT IF NONE FOUND                        
*                                                                               
         CLC   =C'R=',PRBDESC-PRBELEM(R1)     SKIP IF NOT A RATE CODE           
         BNE   *+10                                                             
         MVC   0(3,R2),PRBDESC+2-PRBELEM(R1)  RATECODE IS IN SPACE              
*                                                                               
IRTECDX  DS    0H                                                               
         B     XIT                                                              
*                                                                               
*------------------>   CLOSING DATE===============================              
*                                                                               
IBCLOSE  DS    0H                                                               
         MVC   0(3,R2),PBDCDATE      CLOSING DATE                               
         B     DATECOMM                                                         
*                                                                               
*------------------>   PLANNED COST AND PLANNED COST LESS ACTUAL COST==         
*                                                                               
IBPLANED DS    0H                                                               
         MVC   0(4,R2),PBDPLCOS      PLANNING COST                              
         CLI   GLARGS+1,C'L'          LESS ACTUAL                               
         BNE   UNPKXIT                                                          
         L     RF,PBGRS                                                         
         OC    PBDPLCOS,PBDPLCOS                                                
         BZ    UNPKXIT                                                          
         S     RF,PBDPLCOS                                                      
         ST    RF,0(R2)                                                         
         B     UNPKXIT                                                          
*                                                                               
*------------------> OAN NAME + CODE =================================          
*                                                                               
IBOANAME DS    0H                                                               
         MVC   0(32,R2),PBOANAME                                                
         OC    0(32,R2),SPACES                                                  
         CLI   GLARGS+1,C'N'        CODE  AS WELL                               
         BNE   XIT                                                              
         MVC   32(2,R2),PBOANCOD                                                
         B     XIT                                                              
IBOANCOD MVC   0(2,R2),PBOANCOD                                                 
         CLI   0(R2),0                                                          
         BNE   XIT                                                              
         MVC   0(2,R2),PBAGY         DEFAULT                                    
         B     XIT                                                              
*                                                                               
*------------------> ASPNO  ****                                                
*                                                                               
IASPNO   DS    0H                                                               
*========              ========*                                                
         L     RF,PBESTADR                                                      
         USING PESTRECD,RF                                                      
*========              ========*                                                
***      LTR   RF,RF                                                            
***      BZ    *+2                                                              
         LTR   RF,RF                                                            
         BNZ   *+6                                                              
         DC    H'0'                                                             
         CLC   PBUYKEY(2),=C'BD'    DIFFERENT FROM ALL OTHERS                   
         BE    DOBDONLY                                                         
         CLC   PESTNAME(2),=C'**'                                               
         BNE   DP93E                                                            
         MVC   0(9,R2),PESTNAME+2                                               
         CLI   8(R2),C'*'                                                       
         BNE   *+8                                                              
         MVI   8(R2),C' '                                                       
         B     XIT                                                              
*                                                                               
DP93E    MVC   0(2,R2),PBUYKEY                                                  
         MVC   2(2,R2),=C'S-'                                                   
         MVC   4(6,R2),PBDJOB                                                   
         B     XIT                                                              
*                                                                               
*                                                                               
DOBDONLY MVC   0(9,R2),PESTNAME                                                 
         B     XIT                                                              
*        ========  *                                                            
         DROP  RF                                                               
*        ========  *                                                            
*                                                                               
*-------------->  PAID ELEMENTS =================================               
*                                                                               
IPAYMENT DS    0H                                                               
         ZAP   COLLECT,=P'0'                                                    
         MVI   ELCODE,X'25'                                                     
         L     R6,AIO1                                                          
         BAS   RE,GETEL          GET FIRST ELEMENT                              
         BNE   XIT               NONE THERE                                     
LOOPTHRU GOTO1 =A(FLTPD)                                                        
         BNE   NOGOODD           FAILS DATE FILTER                              
         AP    COLLECT,=P'1'                                                    
NOGOODD  BAS   RE,NEXTEL                                                        
         BE    LOOPTHRU                                                         
*                                                                               
         L     R6,AIO1       POSITION TO FIRST PAYMENT ELEMENT                  
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SP    COLLECT,=P'14'                                                   
         BC    12,NOTGT14A         BRANCH ON MINUS OR ZERO                      
NXTELMNT DS    0H                                                               
         GOTO1 =A(FLTPD)   CHECK DATES                                          
         BNE   NGOODD           FAILS DATE FILTER                               
         SP    COLLECT,=P'1'                                                    
NGOODD   BAS   RE,NEXTEL                                                        
         BNE   XIT                                                              
         CP    COLLECT,=P'1'                                                    
         BE    NOTGT14                                                          
         B     NXTELMNT                                                         
*                                                                               
NOTGT14A ZAP   COLLECT,=P'0'         THERE WERE LESS THAN 14 ELEMENTS           
NOTGT14  DS    0H                                                               
         GOTO1 =A(FLTPD)   CHECK DATES                                          
         BNE   NGOOD            FAILS DATE FILTER                               
*========              ========*                                                
         USING PPAYELD,R6                                                       
*========              ========*                                                
         MVC   0(3,R2),PPDDATE                                                  
         GOTO1 =A(COMMON1),DMCB,12,PPGROSS,=C'P'                                
         MVC   3(4,R2),0(R1)                                                    
         MVC   7(2,R2),PPREP                                                    
         CP    COLLECT,=P'1'         IF 1 THEN THERE WERE MORE THAN 14          
         BNE   *+8                                                              
         MVI   9(R2),255              INDICATOR TO PRINT MESSAGE                
         LA    R2,10(R2)                                                        
NGOOD    BAS   RE,NEXTEL                                                        
         BNE   XIT                                                              
         B     NOTGT14                                                          
*                                                                               
*-----------> REBATE  BILLING ELEMENTS ========================                 
*                                                                               
IBILLEDR DS    0H                                                               
         MVI   ELCODE,X'29'     REBATE ELEMENT                                  
         B     IBILLCOM                                                         
*                                                                               
*-----------> OPEN  BILLING ELEMENTS ========================                   
*                                                                               
IBILLEDO DS    0H                                                               
         MVI   ELCODE,X'28'      OPEN ELEMENT                                   
         B     IBILLCOM                                                         
*                                                                               
*-----------> BILLING ELEMENTS ========================                         
*                                                                               
IBILLED  DS    0H                                                               
         MVI   ELCODE,X'26'                                                     
IBILLCOM ZAP   COLLECT,=P'0'                                                    
         L     R6,AIO1                                                          
         MVC   154(1,R2),PBUYKMED-PBUYKEY(R6)  PASS MEDIA                       
         MVC   155(3,R2),PBUYKCLT-PBUYKEY(R6)  PASS CLIENT                      
         BAS   RE,GETEL          GET FIRST ELEMENT                              
         BNE   XIT               NONE THERE                                     
IBILLA   GOTO1 =A(FLTBLD)                                                       
         BNE   IBILLB            FAILS DATE FILTER                              
         AP    COLLECT,=P'1'                                                    
IBILLB   BAS   RE,NEXTEL                                                        
         BE    IBILLA                                                           
*                                                                               
         L     R6,AIO1           POSITION TO FIRST BILLING ELEMENT              
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         SP    COLLECT,=P'14'                                                   
         BC    12,IBILLC         BRANCH ON MINUS OR ZERO                        
IBILLD   DS    0H                                                               
         GOTO1 =A(FLTBLD)        CHECK DATES                                    
         BNE   IBILLE            FAILS DATE FILTER                              
         SP    COLLECT,=P'1'                                                    
IBILLE   BAS   RE,NEXTEL                                                        
         BNE   XIT                                                              
         CP    COLLECT,=P'1'                                                    
         BE    IBILLF                                                           
         B     IBILLD            NEXT ELEMENT                                   
*                                                                               
IBILLC   ZAP   COLLECT,=P'0'     THERE WERE LESS THAN 14 ELEMENTS               
IBILLF   DS    0H                                                               
         GOTO1 =A(FLTBLD)       CHECK DATES                                     
         BNE   IBILLG           FAILS DATE FILTER                               
*                                                                               
         MVC   0(6,R2),5(R6)    SAVE BILLED DATE AND INVOICE NO+ TYPE           
*                                                                               
GTOCOM   GOTO1 =A(COMMON1),DMCB,12,11(R6),=C'B'                                 
         MVC   6(4,R2),0(R1)                                                    
         CP    COLLECT,=P'1'    IF 1 THEN THERE WERE MORE THAN 14               
         BNE   *+8                                                              
         MVI   10(R2),255        INDICATOR TO PRINT MESSAGE                     
         LA    R2,11(R2)                                                        
IBILLG   BAS   RE,NEXTEL                                                        
         BNE   XIT                                                              
         B     IBILLF                  FILTER ON DATES                          
*                                                                               
*--------------> COST TO CLIENT ================================                
*                                                                               
ICLICOS  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'F'           DO  BILLING FORMULA         L26          
         BE    ICLICOSA                EVEN THOUGH DELETED         L26          
*                                                                               
         GOTO1 =A(TSTDEL)                                                       
         BNO   *+10                IF BUY DELETED                               
         XC    PBGRS(PBUNITS-PBGRS),PBGRS         CLEAR ORDERED MONIES          
*                                                                               
ICLICOSA DS    0H                                                               
*                                                                               
* LOOK FOR BILLING OPTIONS IN THIS SEQUENCE                                     
*  1-FOR THIS EST                                                               
*  2-FOR THIS EST PRODUCT AAA                                                   
*  3-FOR THIS PRODUCT                                                           
*  4-FOR PRODUCT AAA                                                            
*  5-DEFAULT                                                                    
*                                                                               
* LOOK FOR THIS EST IN ESTIMATE TABLE  // EST / PRD AAA IN PBESTADR             
* PRODUCTS ARE IN PRODUCT TABLE                                                 
*                                                                               
         GOTO1 =A(COMMON1),DMCB,RTOCOST                                         
*                                                                               
         CLI   GLARGS+1,C'F'               BILLING FORMULA         L26          
         BE    XIT                                                 L26          
*                                                                               
         B     UNPKXIT                                                          
*                                                                               
ICLICOS2 DS    0H                                                               
*                                                                               
         BRAS  RE,GETCOS2                                                       
         BE    XIT                                                 L26          
*                                                                               
         B     UNPKXIT                                                          
*                                                                               
*--------------> COLLECT CONTRACT UNITS AND LEVEL DATA                          
*                                                                               
ICOLLECT NTR1                                                                   
         L     RF,4(RD) POINT TO CALLING REGISTERS                              
         LA    RE,ICOLLECA                                                      
         ST    RE,12(RF)         *** MODIFY RETURN *** (R14)                    
         ZIC   RF,GLARGS+2                                                      
         B     *+4(RF)                                                          
         B     ICLV4BUH    00     GET HIGHER LEVEL                              
         B     ICLV4BUL    04     GET LOWER LEVEL                               
*                                                                               
ICOLLECA LA    R2,8*3(R2)                                                       
**                                                                              
**    COLLECT UNITS                                                             
**                                                                              
         MVC   WORK(2),GLARGS+1    SAVE INDICATOR                               
         MVI   WORK+2,X'FD'        INDICATOR                                    
         MVC   GLARGS+1(2),=C'UM'  FORCE TO GET UNITS                           
         NTR1                                                                   
         L     RF,4(RD)                                                         
         LA    RE,ICOLL2A                                                       
         ST    RE,12(RF)          MODIFY RETURN ADDRESS                         
         B     ICLV4BUY           ALWAYS GO HERE REGARDLESS                     
ICOLL2A  MVC   GLARGS+1(2),WORK   REINITALIZE                                   
         CLI   0(R2),C'$'                                                       
         BNE   XIT                                                              
         MVI   0(R2),0                                                          
         AHI   R2,-24                                                           
         ZAP   8(8,R2),=P'1'         COUNT                                      
         ZAP   16(8,R2),=P'1'        DOLLAR                                     
         B     XIT                                                              
*======================================================================         
* ROUTINES FOR DIFFERENCE BETWEEN CURRENT-HIGER CURRENT-LOWER AND               
* LOWER-HIGHER.   NOTE -- IF EITHER RATE IS NOT PRESENT,  THEN                  
* DIFFERENCE IS ZERO.                                                           
*======================================================================         
*                                                                               
IBDIFF   NTR1                                                                   
         ZAP   COLLECT,=P'0'                                                    
         ZAP   COLLECTR,=P'0'                                                   
         L     RF,4(RD) POINT TO CALLING REGISTERS                              
         LA    RE,IBDIFFA                                                       
         ST    RE,12(RF)         *** MODIFY RETURN *** (R14)                    
         ZIC   RF,GLARGS+2                                                      
         B     IBDIFFBR(RF)       LOWER RATE                                    
IBDIFFBR B     ICLV4BUH    00     GET HIGHER  RATE                              
         B     ICLV4BUL    04     GET LOWER   RATE                              
         B     ICLV4BUL    08     GET LOWER   RATE                              
         B     ICLV4BUO    0C     GET OPEN    RATE                              
IBDIFFA  OC    R6POINT,R6POINT     RETURN 0 IF NO RATES FOUND                   
         BZ    IBDIFCLR                                                         
*                                                                               
         L     R6,R6POINT                                                       
         ZAP   COLLECT,COLLECTR                 ADD                             
         ZAP   COLLECTR,=P'0'                                                   
         ZAP   IBDFRT,0(8,R2)      SAVE RATE                                    
         ZAP   IBDFCTR,8(8,R2)     SAVE COUNTER                                 
         ZAP   IBDFRTYP,16(8,R2)   SAVE RATE TYPE                               
**                                                                              
**    DO SECOND HALF OF CALCULATION                                             
**                                                                              
         NTR1                                                                   
         L     RF,4(RD)                                                         
         LA    RE,IBDIFFB                                                       
         ST    RE,12(RF)          MODIFY RETURN ADDRESS                         
         ZIC   RF,GLARGS+2                                                      
         B     IBDIFFBZ(RF)                                                     
IBDIFFBZ B     ICLV4BUY    00     GET CURRENT RATE                              
         B     ICLV4BUY    04     GET CURRENT RATE                              
         B     ICLV4BUH    08     GET HIGHER  RATE                              
         B     ICLV4BUY    00     GET CURRENT RATE                              
**                                                                              
IBDIFFB  OC    R6POINT,R6POINT     ZERO RESULT IF NO RATES FOUND                
         BZ    IBDIFCLR                                                         
         CP    IBDFRTYP,16(8,R2)   ALSO IF RATE TYPE HAS CHANGED                
         BNE   IBDIFCLR                                                         
         CP    IBDFCTR,8(8,R2)     ALSO IF COUNTER HAS CHANGED                  
         BE    SPDIFFA                                                          
*                                                                               
IBDIFCLR ZAP   0(8,R2),=P'0'                                                    
         ZAP   8(8,R2),=P'0'                                                    
         ZAP   16(8,R2),=P'0'                                                   
         B     XIT                                                              
*                                                                               
SPDIFFA  DS    0H                                                               
         SP    IBDFRT,0(8,R2)      GET DIFFERENCE IN RATES                      
         ZAP   0(8,R2),IBDFRT      RETURN THIS AMOUNT                           
         B     XIT                                                              
*                                                                               
IBDFRT   DS    PL8                 RATE                                         
IBDFCTR  DS    PL8                 COUNTER                                      
IBDFRTYP DS    PL8                 RATE TYPE                                    
*                                                                               
*                                                                               
*--------------> COPY ==========================================                
*                                                                               
IBCOPY   DS    0H                                                               
*                                                                               
         TM    PBBYOPT2,PBBYCPYQ   IF COPY SPLITS                               
         BNO   IBCOPY1                                                          
*                                                                               
         L     RF,=V(IJOB)                                                      
         BASR  RE,RF                  USE IJOB ROUTINE                          
         B     IBCOPYX                                                          
*                                                                               
IBCOPY1  DS    0H                                                               
*                                                                               
         GOTO1 =A(COMCAPT),DMCB,(C'C',=C'COPY'),0                               
         L     RF,4(R1)                                                         
         MVC   0(17,R2),0(RF)                                                   
*                                                                               
IBCOPYX  DS    0H                                                               
         B     XIT                                                              
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        THIS SECTION RETRIEVES CONTRACT RATE DATA                    *         
*                                                                     *         
*          IF PROCESSING BUYS THE CURRENT BUY RECORD IS USED TO       *         
*            FILTER THE CONTRACT RATES. I.E. BUY SPACE DESCRIPTION    *         
*            IS USED TO FIND APPROPRIATE CONTRACT RATE ELEMENT.       *         
*          IF PROCESSING ONLY CONTRACTS THE SPACE DESCRIPTION IS      *         
*            PASSED IN A CONTRACT RATE ELEMENT SAVED BY THE DRIVING   *         
*            ROUTINE. IN GENERAL THIS ROUTINE USES THE CURRENT LEVEL  *         
*            RATE ELEMENTS OR ENTERED SPACE DESCRIPTIONS. THUS THIS   *         
*            ROUTINE MUST READ CONTRACT RECORD FOR SPACE MATCH        *         
*          BECAUSE IT MAY BE LOOKING FOR LOWER OR HIGHER RATE ELEMENTS.         
*                                                                     *         
*NTRY    R4  ==>  PBUYREC                                             *         
*                                                                     *         
*                                                                     *         
*EXIT    R2  ==>  3PL8   FIELDS                                       *         
*                   1 = CONTRACT LEVEL REPORTED                       *         
*                   2 = INTERNAL COUNTER                              *         
*                   3 = CONTRACT UNITS DESCRIPTION CODE               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
ICLV4BUO DS    0H                                                               
         MVI   ELCODE,X'24'        CONTRACT OPEN          RATES WANTED          
         B     ICLV4COM                                                         
*                                                                               
ICLV4BUH DS    0H                                                               
         MVI   ELCODE,X'22'        CONTRACT HIGHER  LEVEL RATES WANTED          
         B     ICLV4COM                                                         
*                                                                               
ICLV4BUL DS    0H                                                               
         MVI   ELCODE,X'21'        CONTRACT LOWER   LEVEL RATES WANTED          
         B     ICLV4COM                                                         
*                                                                               
ICLV4BUY DS    0H                                                               
         MVI   ELCODE,X'20'        CONTRACT CURRENT LEVEL RATES WANTED          
         B     ICLV4COM                                                         
*                                                                               
ICLV4COM DS    0H                  ROUTINE FOUND IN PRWRICRT                    
*                                                                               
         GOTO1 =V(ICRATE),ICLV4DMCB,R6POINT,COLLECTR                            
*                                                                               
         B     XIT                                                              
*                                                                               
ICLV4DMCB DS    6A                  ROUTINE DMCB                                
*                                                                               
*        ========  *                                                            
         DROP  R6                                                               
*        ========  *                                                            
R6POINT  DS    F                                                                
*                                                                               
         EJECT                                                                  
*                                                                               
*--------------> FIRST/LAST I/O ======================================          
*                                                                               
IBLASTIO DS    0H                                                               
*                                                                               
         XC    WORK(11),WORK     CLEAR AREA                                     
*                                                                               
         LA    R6,33(R6)           SEARCH FOR INSERTION ORDER ELEMS             
         MVI   ELCODE,X'70'                                                     
         SR    R5,R5                                                            
*                                                                               
IBLASTLP BAS   RE,NEXTEL                                                        
         BNE   IBLASTDN            NO MORE ELEMENTS                             
*                                                                               
         USING PIOELD,R6           ESTABLISH INSERTION ORDER ELEMENT            
*                                                                               
         OC    PIODATE,PIODATE    SKIP IF NO DATE PRESENT                       
         BZ    IBLASTCN                                                         
*                                                                               
         CLI   GLARGS+1,C'L'       IF LOOKING FOR LAST INSERTION ORDER          
         BNE   IBLASTLN                                                         
*                                                                               
         LTR   R5,R5                  SAVE ADDRESS IF FIRST ELEMENT             
         BZ    IBLASTL1                                                         
*                                                                               
         CLC   PIODATE,PIODATE-PIOELD(R5)    SKIP IF DATE NOT AFTER             
         BL    IBLASTCN                          LATEST FOUND ALREADY           
         BH    IBLASTL1                          NEW LATEST                     
*                                                                               
         CLC   PIONUM(2),PIONUM-PIOELD(R5)    SKIP IF NUMBER NOT AFTER          
         BNH   IBLASTCN                          HIGHEST FOUND ALREADY          
*                                                                               
IBLASTL1 DS    0H                                                               
*                                                                               
         LR    R5,R6                  SAVE ELEMENT ADDRESS                      
*                                                                               
         B     IBLASTCN                                                         
*                                                                               
IBLASTLN DS    0H                  LOOKING FOR FIRST I/O                        
*                                                                               
         LTR   R5,R5                  SAVE ADDRESS IF FIRST ELEMENT             
         BZ    IBLASTF1                                                         
*                                                                               
         CLC   PIODATE,PIODATE-PIOELD(R5)    SKIP IF DATE NOT BEFORE            
         BH    IBLASTCN                          EARLIEST FOUND ALREADY         
         BL    IBLASTF1                          NEW EARLIEST                   
*                                                                               
         CLC   PIONUM(2),PIONUM-PIOELD(R5)    SKIP IF NUMBER NOT BEFORE         
         BNL   IBLASTCN                          LOWEST FOUND ALREADY           
*                                                                               
IBLASTF1 DS    0H                                                               
*                                                                               
         LR    R5,R6                  SAVE ELEMENT ADDRESS                      
*                                                                               
IBLASTCN DS    0H                                                               
*                                                                               
         B     IBLASTLP                                                         
*                                                                               
IBLASTDN DS    0H                                                               
*                                                                               
         LTR   R6,R5                 POINT TO FOUND I/O ELEMENT                 
         BZ    IBLASTX                NONE FOUND                                
*                                                                               
         CLI GLARGS+2,C' ' SKIP IF NOT DATE                                     
         BH    IBLAST90                                                         
*                                                                               
         MVC   0(1,R2),PBUYKMED                                                 
*                                                                               
         GOTO1 DATCON,DMCB,(3,PIODATE),(0,1(R2))                                
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,3,PIONUM         GET I/O NUMBER                               
         CVD   R0,DUB                                                           
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  8(4,R2),DUB                                                      
*                                                                               
         B     IBLASTX                                                          
*                                                                               
IBLAST90 DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'L'       LEGAL WARNINGS                               
         BNE   *+14                                                             
         MVC   0(1,R2),PIOLWCD        LEGAL WARNING CODE                        
         B     IBLASTX                                                          
*                                                                               
         CLI   GLARGS+2,C'Q'       QAUARTERLY WARNING                           
         BNE   *+14                                                             
         MVC   0(1,R2),PIOQUCD        QUARTERLY WARNING CODE                    
         B     IBLASTX                                                          
*                                                                               
         CLI   GLARGS+2,C'2'      BOTH   WARNINGS                               
         BNE   *+14                                                             
         MVC   0(2,R2),PIOLWCD        BOTH  WARNING CODES                       
         B     IBLASTX                                                          
*                                                                               
IBLASTX  DS    0H                                                               
         B     XIT                                                              
*                                                                               
*-------------->  LAST I/O IN USE ================================              
*                                                                               
ILASTAD  GOTO1 =A(COMMON1),DMCB,8,MYWORK                                        
         B     XIT                                                              
*                                                                               
*-------------->  LIST CODE =======================================             
*                                                                               
*EXIT    R2 ==> 0-2  PUBLIST CODE                                               
*               3-4  AGENCY                                                     
*               5    MEDIA                                                      
*               6-8  CLIENT                                                     
*                                                                               
IBLISTCD DS    0H                                                               
*                                                                               
         MVC   0(3,R2),PBQLISCD    PUBLIST CODE                                 
         MVC   3(2,R2),PBAGY       AGENCY                                       
         MVC   5(1,R2),PBMED       MEDIA                                        
         MVC   6(3,R2),PBCLT       CLIENT                                       
*                                                                               
         OC    PBCLT,PBCLT         IF NO CLIENT                                 
         BNZ   *+10                                                             
         MVC   6(3,R2),PBCLTSV        USE SAVED CLIENT CODE                     
*                                                                               
         OC    0(3,R2),0(R2)       IF NO CODE                                   
         BNZ   IBLISTCX                                                         
*                                                                               
         CLI   PBUYKRCD,X'20'      AND HAVE BUY RECORD                          
         BNE   IBLISTCX                                                         
*                                                                               
         MVC   0(3,R2),PBDLIST        USE PUB LIST CODE IN BUY                  
         MVC   3(2,R2),PBUYKAGY           AGENCY                                
         MVC   5(1,R2),PBUYKMED           MEDIA                                 
         MVC   6(3,R2),PBUYKCLT           CLIENT                                
*                                                                               
IBLISTCX DS    0H                                                               
*                                                                               
         B     XIT                                                              
*                                                                               
*-------------->  CIRCULATION (PUB FILE) ==========================             
*                                                                               
R6CIRC   DS    F                                                                
ICIRC    DS    0H                                                               
         XC    R6CIRC,R6CIRC       INIT CIRC ELM POINTER                        
         L     R6,AIO3                                                          
         LA    R6,33(R6)                                                        
         CLI   GLARGS+1,C'C'       CIRCULATION                                  
         BNE   *+10                                                             
         ZAP   0(8,R2),=P'0'                                                    
         MVI   ELCODE,X'30'                                                     
*========              ========*                                                
         USING PBUYRECD,R4                                                      
         USING PUBCIRD,R6                                                       
*========            =========*                                                 
ICIREAD  BAS   RE,NEXTEL           FIND NEXT CIRCULATION ELEMENT                
         BNE   ICIRFND                                                          
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   IF THERE IS NO BUY AVAILABLE                 
         BE    ICIRBUY                                                          
*                                                                               
         L     RF,AIO2                USE CONTRACT END DATE                     
         CLC   PUBCDAT,PCONEDT-PCONKEY(RF)                                      
         BH    ICIRFND                DONE IF PAST CONTRACT END DATE            
         B     ICIREAD1                                                         
*                                                                               
ICIRBUY  DS    0H                                                               
         CLC   PUBCDAT,PBUYKDAT    DONE IF PAST INSERTION DATE                  
         BH    ICIRFND                                                          
*                                                                               
ICIREAD1 DS    0H                                                               
         ST    R6,R6CIRC           SAVE CIRC ELEMENT ADDRESS                    
         B     ICIREAD                                                          
*                                                                               
ICIRFND  OC    R6CIRC,R6CIRC       DONE IF NO CIRC ELM FOUND                    
         BZ    XIT                                                              
*                                                                               
         L     R6,R6CIRC                                                        
*                                                                               
ICIRCE   CLI   GLARGS+1,C'E'         EFFECTIVE DATE                             
         BNE   *+14                                                             
         MVC   0(3,R2),PUBCDAT       MOVE CIRC DATE                             
         B     XIT                                                              
         CLI   GLARGS+1,C'S'                                                    
         BNE   *+14                                                             
         MVC   0(4,R2),PUBCSRC       SOURCE                                     
         B     XIT                                                              
         CLI   GLARGS+1,C'C'       CIRCULATION                                  
         BNE   XIT                                                              
         OI    PUBCIR1+4,15                                                     
         ZAP   0(8,R2),PUBCIR1                                                  
         GOTO1 =V(DOFLOW)                                                       
         B     CHK4TST                                                          
*        ========  *                                                            
         DROP  R6                                                               
*        ========  *                                                            
*                                                                               
*-------------> FREQUENCY ==========================                            
*                                                                               
IFREQ    DS    0H                                                               
*========            =========*                                                 
         L     R6,AIO3                                                          
         USING PUBGEND,R6                                                       
*========            =========*                                                 
         CLI   0(R6),C'N'          NEWSPAPER HAS NO FREQ                        
         BE    XIT                                                              
         MVI   ELCODE,X'20'                                                     
         BAS   RE,GETEL                                                         
         BNE   XIT                                                              
         MVC   0(2,R2),PUBMFREQ                                                 
         B     XIT                                                              
*        ========  *                                                            
         DROP  R6                                                               
*        ========  *                                                            
*                                                                               
*-------------->  CAPTION =========================================             
*                                                                               
IBCAPT   DS    0H                                                               
*                                                                               
         GOTO1 =A(COMCAPT),DMCB,(C'T',=C'COPY'),0                  L29          
*                                                                               
         L     RF,4(R1)                                                         
*                                                                               
         OC    0(25,RF),0(RF)   ANY CAPTION FOUND                               
         BNZ   IBCAPTZ                                                          
*                                                                               
         MVC   0(3,R2),=X'FFFFFF'                                               
         B     XIT                                                              
*                                                                               
IBCAPTZ  MVC   0(50,R2),0(RF)      DESCRIPTION FOR SORT            L29          
         B     XIT                                                              
*                                                                               
*-------------->  DIVISION NAME ===================================             
*                                                                               
IDIVIS   DS    0H                                                               
*                                                                               
         MVC   0(3,R2),PBDIV       DIVISION CODE                                
         MVC   3(20,R2),PBDIVNM    DIVISION NAME                                
*                                                                               
IDIVZERO DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'N'       IF NAME SORT WANTED                          
         BNE   *+10                                                             
         XC    0(3,R2),0(R2)          KILL CODE                                 
*                                                                               
         OC    0(8,R2),0(R2)                                                    
         BNZ   XIT                                                              
*                                                                               
         MVI   0(R2),255                                                        
         MVC   3(5,R2),=C'NONE '                                                
*                                                                               
         B     XIT                                                              
*                                                                               
*-------------->  REGION  NAME ===================================              
*                                                                               
IREGION  DS    0H                                                               
*                                                                               
         MVC   3(20,R2),PBREGNM       REGION NAME                               
         MVC   0(3,R2),PBRGN                NUMBER                              
*                                                                               
IREGIONX DS    0H                                                               
*                                                                               
         B     IDIVZERO                                                         
*                                                                               
*-------------->  DISTRICT NAME  ==================================             
*                                                                               
IDISTRIC DS    0H                                                               
*******                                                                         
*******  L     RF,AIO1             POINT TO DETAIL RECORD                       
*******  CLI   PBUYKRCD-PBUYKEY(RF),PBUYKIDQ ACCEPT IF BUY                      
*******  BE    *+8                                                              
*******  CLI   PBILKRCD-PBILLKEY(RF),PBILKIDQ OR BILL RECORDS                   
*******  BNE   XIT                                                              
*******                                                                         
         MVC   3(20,R2),PBDSTNM       DISTRICT NAME                             
         MVC   0(3,R2),PBDST                   NUMBER                           
         B     IDIVZERO                                                         
*                                                                               
*--------------> RATE EFFECTIVE DATE  ============================              
*                                                                               
IRATEFDT DS    0H                                                               
         B     XIT                                                              
*                                                                               
*---------------> PUBLICATION NUMBER/ NAME ========================             
*                                                                               
IBPUBNA  DS    0H                                                               
         BRAS  RE,IBPUBNAR         FILL IN PUB NAME AND NUMBER                  
         B     XIT                                                              
*                                                                               
*-------------->  MATERIALS CLOSING ===============================             
*                                                                               
IBMATER  DS    0H                                                               
         MVC   0(3,R2),PBDMDATE                                                 
         B     DATECOMM                                                         
*                                                                               
*-------------->  JOB NUMBER FROM BUY =============================             
*                                                                               
IJOB     DS   0H                                                                
         MVC   0(6,R2),PBDJOB                                                   
         MVC   6(1,R2),PBMED                                                    
         CLI   PBQMED,C'C'                                                      
         BNE   *+8                                                              
         MVI   6(R2),C'C'                                                       
         MVC   7(3,R2),PBCLT                                                    
         MVC   10(3,R2),PBPROD                                                  
         B     XIT                                                              
*                                                                               
*-------------->  BILLABLE DATE   =================================             
*                                                                               
IBBILLBL DS    0H                                                               
         MVC   0(3,R2),PBDBDATE                                                 
         B     DATECOMM                                                         
*                                                                               
*-------------->  PAYABLE DATE ====================================             
*                                                                               
IBPAYBLE DS    0H                                                               
         MVC   0(3,R2),PBDPDATE                                                 
         B     DATECOMM                                                         
*                                                                               
*-------------->  ON SALE  DATE ===================================             
*                                                                               
IBONSALE DS    0H                                                               
         MVC   0(3,R2),PBDSDATE                                                 
         B     DATECOMM                                                         
*                                                                               
*-------------->  ORDERED CD    DOLLARS  ==========================1            
*                                                                               
* COLUMN INPUT ROUTINES                                                         
*                                                                               
IB       ZAP   0(8,R2),=P'0'                                                    
         MVI   ELCODE,8                                                         
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*========              ========*                                                
         USING PBILLEL,R6                                                       
*========              ========*                                                
         CLI   PBILLTYP,C'B'                                                    
         BNE   XIT                                                              
         CLI   GLARGS+1,C'1'                                                    
         BE    *+14                                                             
         CLC   PBILLMOD,GLARGS+1                                                
         BNE   XIT                                                              
         MVI   ELCODE,9                                                         
         LR    R6,R4                                                            
         BAS   RE,GETEL                                                         
         BNE   XIT                                                              
*========              ========*                                                
         USING PBILOTH,R6                                                       
*========              ========*                                                
         ZAP   0(8,R2),PBILLOPG                                                 
         B     XIT                                                              
*        ========  *                                                            
         DROP  R6                                                               
*        ========  *                                                            
IR       ZAP   0(8,R2),=P'0'                                                    
         MVI   ELCODE,8                                                         
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*========              ========*                                                
         USING PBILLEL,R6                                                       
*========              ========*                                                
         CLI   PBILLTYP,C'R'                                                    
         BNE   XIT                                                              
         CLI   GLARGS+1,C'1'                                                    
         BE    *+14                                                             
         CLC   PBILLMOD,GLARGS+1                                                
         BNE   XIT                                                              
         ZAP   0(8,R2),PBILLRCV                                                 
         B     XIT                                                              
*        ========  *                                                            
         DROP  R6                                                               
*        ========  *                                                            
*                                                                               
ICONBLG  ZAP   0(8,R2),=P'0'                                                    
         MVI   ELCODE,8                                                         
         BAS   RE,GETEL                                                         
         BE    *+6                                                              
         DC    H'0'                                                             
*========              ========*                                                
         USING PBILLEL,R6                                                       
*========              ========*                                                
         CLI   PBILLTYP,C'B'                                                    
         BNE   XIT                                                              
         CLI   PBILLMOD,C'4'                                                    
         BE    *+12                                                             
         CLI   PBILLMOD,C'5'                                                    
         BNE   XIT                                                              
         ZAP   0(8,R2),PBILLGRS                                                 
         B     XIT                                                              
*        ========  *                                                            
         DROP  R6                                                               
*        ========  *                                                            
*                                                                               
         GETEL (R6),33,ELCODE                                                   
*                                                                               
*--------------->  PUB ZONE AND EDITION =============================           
*                                                                               
IPUBNUM  DS    0H                                                               
         BRAS  RE,IPUBNUMR         GET PUB NUMBER                               
*                                                                               
         B     XIT                                                              
*                                                                               
*--------------->  CURRENT FREQUENCY =================================          
*                                                                               
IBFREQ1  DS    0H                                                               
IBFREQ2  DS    0H                                                               
         B     XIT                                                              
*                                                                               
UNPKXIT  CLI   GLARGS+1,C'O'       OPEN RATES WERE PROCESSED                    
         BE    RESETGRO                                                         
         CLI   DLRTYPE,C'P'        PAID DATA ENTRIES                            
         BE    *+12                                                             
         CLI   DLRTYPE,C'B'        BILLED                                       
         BNE   UNPKXITA                                                         
         CLC   GLARGS+7(2),=C'$L'  PROCESS BILLED ELEMENTS                      
         BE    RESETGRO                                                         
         CLC   GLARGS+7(2),=C'$T'  PROCESS PAID AND OR BILLED                   
         BE    RESETGRO                                                         
         CLC   GLARGS+7(2),=C'$A'  PROCESS PAID ELEMENTS                        
         BNE   UNPKXITA                                                         
RESETGRO MVC   PBGRS(64),WORK      REINIALIZE WITH CONTRACT RATES               
**                                                                              
UNPKXITA L     RF,0(R2)                                                         
         CVD   RF,DMCB                                                          
         ZAP   0(8,R2),DMCB(8)                                                  
         ZAP   COLLECTR,DMCB(8)        FOR DIFFERENCE                           
*                                                                               
         TM    PBQCFOPT,PBQCFOUQ   IF OUTLET PROCESSING                         
         BNO   UNPKOUTX                                                         
*                                                                               
*        CHECK IF THIS COLUMN INVOLVED                                          
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQCFOUT),0,0                                 
*                                                                               
         OC    8(4,R1),8(R1)       IF OUTLET COLUMN                             
         BZ    UNPKOUTX                                                         
*                                                                               
         GOTO1 =V(OUTFLT)            GO APPLY (IN PRWRIOUT)                     
*                                     MAY APPLY PERCENT TO DOLLAR VALUE         
UNPKOUTX DS    0H                                                               
*                                                                               
         GOTO1 =V(DOFLOW)                                                       
*                                                                               
CHK4TST  TM    GLARGS+5,X'08'           TEST                      L12           
         BNO   CHK4TSTA                                           L12           
         CLI   PBDBFD,C'T'         TEST BUY                       L12           
         BE    CHK4TSTB                                           L12           
ZAPXIT   ZAP   0(8,R2),=P'0'                                                    
         B     XIT                                                              
*                                                                               
CHK4TSTA TM    GLARGS+5,X'04'      LIVE                           L12           
         BNO   CHK4TSTB                                           L12           
         CLI   PBDBFD,C'T'         TEST BUY                       L12           
         BE    ZAPXIT                                             L12           
*                                                                               
CHK4TSTB TM    PBQTOTTY,TOTTYPN    NORMAL                         L09           
         BO    XIT                                                L09           
*  TEST TOTALS REQUESTED                                          L09           
         CLI   PBDBFD,C'T'        TEST BUY                        L09           
         BNE   XIT                                                L09           
         MVC   DMCB(1),0(R2)      SAVE POSSIBLE MASK                            
         ZAP   8(8,R2),0(8,R2)                                    L09           
         MVC   0(1,R2),DMCB       RESTORE POSSIBLE MASK           L09           
         B     XIT                                                L09           
*                                                                               
         SPACE 3                                                  L09           
*                                                                               
* THIS WILL DETERMINE IF THIS IS A DIFFERENCE ITEM FOR FINANCIAL                
* CLIENTS ----- OBJECTIVE -- FIRST TIME THRU SAVE CONTRACT                      
* $$ IN DIF, SET SWITCH DIFF FOR FIRST TIME, SAVE PBGRS IN WORK                 
* AND MOVE OPEN PBGRS INTO PBGRS AND RETURN TO CALLER WITH                      
* EQUAL CONDITION CODE.  CALLER IF CC IS = WILL BRANCH TO FIRST                 
* INSTRUCTION OF SUBROUTINE AND PROCESS OPEN DOLLARS.  IT WILL THEN             
* BRANCH BACK TO DIFFRNCE AND CALCULATE DIFFERENCE, RESTORE DIFF AND            
* PBGRS AND RETURN WITH CC NOT EQUAL....                                        
*                                                                               
*                                                                               
DIFF     DC    F'0'                                                             
DIFFA    DC    X'0'                                                             
*                                                                               
DIFFRNCE CLI   GLARGS+1,C'D'                                                    
         BNER  RE                                                               
         CLI   DIFFA,0             FIRST TIME THRU                              
         BNE   NORMALIZ                                                         
         MVC   DIFF,0(R2)                                                       
         MVI   DIFFA,255           SWITCH                                       
         MVC   WORK(64),PBGRS      SAVE CONTRACT $                              
         MVC   PBGRS(64),OGROSS    OVERLAY                                      
         L     RF,GLAROUT          FIRST INSTRUCTION OF ROUTINE                 
         CR    RE,RE                                                            
         BR    RE                  CC CODE IS=                                  
*                                                                               
NORMALIZ MVC   PBGRS(64),WORK      MOVE BACK                                    
         L     R1,DIFF CONTRACT                                                 
         XC    DIFF(5),DIFF        CLEAR SWITCH & TOTAL                         
         L     RF,0(R2) OPEN                                                    
         SR    RF,R1                                                            
         ST    RF,0(R2)                                                         
         AP    COUNTR,=P'1'                                                     
         CP    COUNTR,=P'10000'                                                 
         BNH   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         LTR   R2,R2                                                            
         BR    RE                  CC CODE IS NE                                
*                                                                               
COUNTR   DC   PL3'0'                                                            
*                                                                               
* OPEN RATE FROM PUB                                                            
*                                                                               
*========              ========*                                                
OOPENR   L     R1,GLATHID                                                       
         USING GLINTD,R1           SEE IF A TOTAL LINE                          
*========              ========*                                                
         CLC   GLLEVEL,GLDETLEV    IF YES GET OUT                               
         BNE   XIT                                                              
         LA    RF,1(R2)                                                         
         XC    EBLOCK,EBLOCK                                                    
         ST    RF,EBAIN                                                         
         TM    0(R2),X'80'                                                      
         BO    OOPNIORL                                                         
         MVI   EBDECS,5                                                         
         B     OBCOST3                                                          
*                                                                               
OOPNIORL MVI   EBDECS,2                                                         
         B     OBCOST3                                                          
**************                                                                  
*-------------->    CLIENT VENDOR                                               
*************                                                                   
OCLIVEND MVC   CODEAREA(12),0(R2)                                  L19          
         B     GENOUT                                              L19          
*                                                                               
OPUBNUM  GOTO1 =A(COMMON1),DMCB,RTOPUBNO                           L20          
         CLI   GLARGS,C'Z'         AVOID GOING TO GENOUT          L23           
         BNE   GENOUT                                                           
*                                                                               
         CLI   MYLTYP,C'H'         IF HEADLINE OR MIDLINE                       
         BE    *+8                                                              
         CLI   MYLTYP,C'M'                                                      
         BE    *+12                                                             
         TM    GLINDS,X'40'        OR TOTALS                                    
         BNO   *+8                                                              
         B     GENOUT                 USE GENOUT                                
*                                                                               
         B     XIT                 ELSE JUST EXIT                               
*                                                                               
OCLV4BUY DS    0H                                                               
*========              ========*                                                
         L     R1,GLATHID                                                       
         USING GLINTD,R1                                                        
*========              ========*                                                
         CLC   GLLEVEL,GLDETLEV                                                 
         BE    XCEBLOK                 ONLY PRINT WHEN DETAIL                   
         ZAP   0(8,R2),=P'0'                                                    
         B     XIT                                                              
*                                                                               
XCEBLOK  CP   16(8,R2),=P'0'   LEVEL TYPE                                       
         BE    XIT                                                              
OCLV4AA  LA    RF,OCRTLVT                                                       
         CP    8(8,R2),=P'0'         COUNT M/B GT 0                             
         BE    XIT                                                              
         ZAP   WORK(8),16(8,R2)                                                 
         DP    WORK(8),13(3,R2)      FIND LEVEL TYPE                            
OROCTEOT CLI   0(RF),X'FF'            EOT                                       
         BE    XIT                                                              
         CP    1(1,RF),WORK+4(1)      LEVEL TYPE EQUAL                          
         BE    OROCMV                                                           
         LA    RF,5(RF)                                                         
         B     OROCTEOT                                                         
OROCMV   ZAP   COLLECT(3),2(3,RF) SCALING                                       
         CLI   0(RF),C'S'          SPECIAL                        BUG02         
         BNE   OROCMVA                                            BUG02         
         CP    0(8,R2),=P'0'        ANY LEVEL                     BUG02         
         BNE   OROCMVC                                            BUG02         
         MVC   0(13,R3),=C'-- SPECIAL --'                         BUG02         
         B     XIT                                                BUG02         
         SPACE 1                                                                
OROCMVA  CP    0(8,R2),=P'0'                                      BUG02         
         BNE   OROCMVC                                            BUG02         
         MVC   0(10,R3),=C'-- OPEN --'                            BUG02         
         CP    8(8,R2),=P'100000'  IF A FLAT RATE                               
         BL    *+10                                                             
         MVC   0(10,R3),=C'-- FLAT --'   CHANGE DESIGNATION                     
         B     XIT                                                BUG02         
*                                                                               
OROCMVC  ZAP   WORK(16),0(8,R2)        ELIMINATE ITERATION                      
         DP    WORK(16),10(6,R2)       DIVIDE BY COUNT                          
         ZAP   0(8,R2),WORK(10)        LEVEL WITH SCALING                       
         DP    WORK(10),COLLECT(3)                                              
*                                                                               
*                                                                               
         XC    EBLOCK,EBLOCK                                                    
         MVI   EBDECS,0                                                         
         LA    R6,WORK                                                          
         ST    R6,EBAIN           ADDRESS OF INPUT                              
         DS    0H                                                               
*========              ========*                                                
         L     R1,GLADTENT                                                      
         USING DROD,R1                                                          
*========              ========*                                                
         ZIC   R6,DROLEN                                                        
         AHI   R6,-2                                                            
         STC   R6,EBLOUT                                                        
         LA    RE,0(R6,R3)                                                      
         MVI   0(RE),C'-'                                                       
         MVC   1(1,RE),0(RF)      LEVEL INDICATOR                               
         MVI   EBLIN,7            LENGTH INPUT                                  
         B     OBCOMM                                                           
*                                                                               
         DROP  R1                                                               
*                                                                               
OCRTLVT DC     C'$',PL1'1',PL3'1000'   DOLLARS                                  
         DC    C'U',PL1'2',PL3'1000'   UNITS                                    
         DC    C'I',PL1'3',PL3'1000'     INCHES                                 
         DC    C'L',PL1'4',PL3'1000'     LINES                                  
         DC    C'S',PL1'5',PL3'1000'   SPECIAL                                  
         DC    C'O',PL1'6',PL3'1000'   OPEN                                     
         DC    C'X',PL1'7',PL3'1000'   TIMES                                    
         DC    C'P',PL1'8',PL3'1000'   PAGES                                    
         DC    X'FFFF'                                                          
*                                                                               
PERTOTAL DS    0H            AT TOTAL BREAK USE ADJACENT ROW                    
*========              ========*                                                
         L     R1,GLATHID                                                       
         USING GLINTD,R1                                                        
*========              ========*                                                
         CLC   GLLEVEL,GLDETLEV                                                 
         BNL   PERTOTX                 ONLY PRINT WHEN TOTAL                    
*                                                                               
         LA    RF,GLARGS+15                                                     
         BRAS  RE,DATES                                                         
*                                                                               
PERTOTX  DS    0H                                                               
         B     XIT                                                              
*                                                                               
*                                                                               
OPERIOD  DS    0H            AT TOTAL BREAK USE ADJACENT ROW                    
*========              ========*                                                
         L     R1,GLATHID                                                       
         USING GLINTD,R1                                                        
*========              ========*                                                
         CLC   GLLEVEL,GLDETLEV                                                 
         BH    OPERIODX                ONLY PRINT WHEN NOT TOTAL                
*                                                                               
         ZIC   RE,GLARGS+14            LENGTH OF INPUT                          
         AR    R2,RE                    POINT TO NEXT COLUMN                    
         LA    RF,GLARGS+13           CHARACTERISTIC OF ADJACENT FIELD          
*                                                                               
         BRAS  RE,DATES                                                         
         BZ    OPERIODX            ROUTINE PRINTED DATES                        
*                                                                               
*  IF ROUTINE DID NOT PRINT DATES, MUST TREAT AS NORMAL DATE                    
*                                                                               
         MVC   GLARGS+15(1),GLARGS+13   FOOL DATE ROUTINE                       
*                                                                               
         CLI   GLARGS,C'I'    INSERT DATE                                       
         BE    OINDATE                                                          
         B     OBCLOSE                                                          
*                                                                               
OPERIODX DS    0H                                                               
         B     XIT                                                              
*                                                                               
LEVELID  DC    X'0'                  LOWEST LEVEL TOTAL                         
*                                                                               
OCOLLECT DS    0H                                                               
*========              ========*                                                
         L     R1,GLATHID                                                       
         USING GLINTD,R1                                                        
*========              ========*                                                
         CLC   GLLEVEL,GLDETLEV                                                 
         BNL   XIT                     ONLY PRINT WHEN TOTAL                    
         CLI   LEVELID,0               HAVE I ENCOUNTERED TOTAL YET             
         BNE   LVLHIT                                                           
         MVC   LEVELID,GLLEVEL                                                  
         B     OCOLLA                                                           
*                                                                               
LVLHIT   CLC   LEVELID,GLLEVEL         ENSURE ONLY PRINTING AT LOWEST           
         BE    OCOLLA                                               L01         
         OC    PBQPBLSH,PBQPBLSH     PRINT TOTALS ONLY IF FILTERING L01         
         BZ    XIT                   ON PUBLISHER                   L01         
*                                                                               
OCOLLA   CP    16(8,R2),=P'0'   LEVEL TYPE                                      
         BE    OCOLS                                                            
         CP    0(8,R2),=P'0'                                                    
         BE    OCOLS                                                            
*                                                                               
         ZAP   WORK(16),0(8,R2)        ELIMINATE ITERATION                      
         DP    WORK(16),10(6,R2)       DIVIDE BY COUNT                          
         ZAP   0(8,R2),WORK(10)        LEVEL WITH SCALING                       
*                                                                               
OCOLS    CLI   GLARGS,C'S'          REVERSE SIGN                                
         BE    OCOLLSP                                                          
         SP    0(8,R2),24(8,R2)                                                 
         ZAP   24(8,R2),0(8,R2)     ALIGN FOR COMMON EDIT                       
         B     *+10                                                             
*                                                                               
OCOLLSP  SP    24(8,R2),0(8,R2)     DIFFERENCE                                  
*                                                                               
* FIND OUT LEVEL TYPE OF CONTRACT                                               
*                                                                               
         CP    16(8,R2),=P'0'       LEVEL TYPE                                  
         BE    OCXCEB                                                           
         LA    RE,OCRTLVT                                                       
         DP    16(8,R2),13(3,R2)    FIND LEVEL TYPE                             
OCOLLEOT CLI   0(RE),X'FF'          EOT                                         
         BE    XIT                                                              
         CP    1(1,RE),20(1,R2)     LEVEL TYPE EQUAL                            
         BE    *+12                                                             
         LA    RE,5(RE)                                                         
         B     OCOLLEOT                                                         
*                                                                               
OCXCEB   XC    EBLOCK,EBLOCK                                                    
         LA    RF,24(R2)                                                        
         ST    RF,EBAIN                                                         
         MVI   EBDECS,3                                                         
*                                                                               
         CLI   0(RE),C'$'           DOLLAR LEVEL TYPE                           
         BNE   OBCOST3                                                          
         MVI   EBDECS,2                                                         
         MVI   EBROUND,1                                                        
         B     OBCOST3                                                          
*                                                                               
*        LAST INSERTION ORDER DATA                                              
*        R2==> MEDIA,DATE(YYMMDD),SPACE,NUMBER(4)                               
*                                                                               
*                                                                               
OBLASTIO DS    0H                                                               
*                                                                               
         OC    0(12,R2),0(R2)      SKIP IF NO DATA                              
         BZ    OBLASTIX                                                         
*                                                                               
         CLI   GLARGS,C'N'         SKIP UNLESS I/O # WANTED                     
         BNE   OBLASTI1                                                         
*                                                                               
         MVI   1(R2),C'-'          SET DASHES IN NUMBER                         
         MVI   7(R2),C'-'                                                       
*                                                                               
         MVC   0(12,R3),0(R2)    LAST IO                                        
*                                                                               
         B     OBLASTIX                                                         
*                                                                               
OBLASTI1 DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'D'         SKIP UNLESS I/O DATE WANTED                  
         BNE   OBLASTI2                                                         
*                                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(0,1(R2)),(5,0(R3))  DISPLAY DATE                    
*                                                                               
         B     OBLASTIX                                                         
*                                                                               
OBLASTI2 DS    0H                                                               
*                                                                               
OBLASTIX DS    0H                                                               
         B     XIT                                                              
*                                                                               
*                                                                               
*                                                                               
OBILLCOD DS    0H                                                               
         MVC   0(1,R3),0(R2)     BILLING CODE                                   
         CLI   0(R2),255         NO BILLING CODE // FORCE TO BOTTOME            
         BNE   OBILLCOU                                                         
         MVC   0(3,R3),=C'N/A'                                                  
         CLI   MYLTYP,C'M'       MIDLINE                                        
         BNE   *+10                                                             
         MVC   0(10,R3),=C'UNASSIGNED'                                          
OBILLCOU CLI   MYLTYP,C'H'         HEADING                                      
         BNE   XIT                                                              
         MVC   LABLAREA(15),=C'BILLING GROUP  '                                 
         MVC   CODEAREA(1),0(R2)                                                
         CLI   0(R2),255         NO BILLING CODE                                
         BNE   *+10                                                             
         MVC   CODEAREA(10),=C'UNASSIGNED'                                      
         B     GENOUT                                                           
*                                                                               
ORTECODE MVC   0(3,R3),0(R2)     RATE CODE                                      
         B     XIT                                                              
*                                                                               
OPOSIT   MVC   0(35,R3),0(R2)                                                   
         CLC   198(20,R2),SPACES                                                
         BNH   XIT                                                              
         MVC   198(35,R3),35(R2)                                                
         CLC   396(20,R2),SPACES                                                
         BNH   XIT                                                              
         MVC   396(35,R3),70(R2)                                                
         B     XIT                                                              
*                                                                               
OLASTAD  DS    0H                                                               
******   MVC   0(8,R3),0(R2)    LAST AD INSERT DATE                             
         CLC   0(3,R2),=X'000001'  IF NEW AD                                    
         BNE   *+14                                                             
         MVC   0(3,R3),=C'NEW'                                                  
         B     OLASTADX                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),(8,0(R3))                                  
*                                                                               
OLASTADX DS    0H                                                               
         B     XIT                                                              
*                                                                               
*        PUBLIST CODE                                                           
*                                                                               
*NTRY    R2 ==> 0-2  PUBLIST CODE                                               
*               3-4  AGENCY                                                     
*               5    MEDIA                                                      
*               6-8  CLIENT                                                     
*                                                                               
OBLISTCD DS    0H                  PUB LIST CODE                                
*                                                                               
         CLI   GLARGS,C'C'         IF CODE ONLY                                 
         BNE   OBLIST10                                                         
*                                                                               
         MVC   LABLAREA(15),=C'PUB LIST CODE  '    TITLE                        
         MVC   CODEAREA(3),0(R2)   ACTUAL CODE                                  
*                                                                               
         B     GENOUT                                                           
*                                                                               
OBLIST10 DS    0H                                                               
*                                                                               
*                                  ELSE NEED NAME AND MUST READ RECORD          
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(08),=C'PUB LIST'  TITLE                                 
*                                                                               
         CLC   0(3,R2),SPACES      DONE IF NO CODE                              
         BNH   GENOUT                                                           
*                                                                               
         CLI   GLARGS,C'B'         IF NAME AND CODE                             
         BNE   *+10                                                             
         MVC   CODEAREA(3),0(R2)      SET CODE                                  
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              ESTABLISH PUBLIST RECORD KEY                 
         USING PLISRECD,R4                                                      
*                                                                               
         MVC   PLISKAGY,3(R2)      SET AGENCY                                   
         MVC   PLISKMED,5(R2)      SET MEDIA                                    
         MVI   PLISKRCD,PLISTIDQ   SET RECORD ID                                
         MVC   PLISKCLT,6(R2)      SET CLIENT                                   
         MVC   PLISKCOD,0(R2)      SET CODE                                     
         MVI   PLISKLIN,1          WANT LINE 1                                  
*                                                                               
         CLC   PLISKEY,SVPLISKY    IF SAME AS CURRENT KEY                       
         BNE   OBLIST20                                                         
*                                                                               
         MVC   NAMEAREA(L'SVPLISNM),SVPLISNM    USE SAVED NAME                  
*                                                                               
         B     OBLISTX                                                          
*                                                                               
OBLIST20 DS    0H                                                               
*                                                                               
         MVC   AIO,AIO3            USE AIO3 FOR READ                            
         XC    FILENAME,FILENAME   USE PRINT FILES I.E. THE DEFAULT             
*                                                                               
         GOTO1 HIGH                READ PUBLIST RECORD                          
*                                                                               
         CLC   PLISKEY,KEYSAVE     IF RECORD NOT FOUND                          
         BE    OBLIST30                                                         
*                                                                               
         MVC   KEY,KEYSAVE            RESTORE ORIGINAL KEY                      
         MVC   PLISKCLT,=C'ZZZ'       SET FOR ALL CLIENTS                       
*                                                                               
         CLC   PLISKEY,SVPLISKY       IF SAME AS CURRENT KEY                    
         BNE   *+14                                                             
         MVC   NAMEAREA(L'SVPLISNM),SVPLISNM    USE SAVED NAME                  
         B     OBLISTX                                                          
*                                                                               
         GOTO1 HIGH                   READ PUBLIST RECORD                       
*                                                                               
         CLC   PLISKEY,KEYSAVE        SKIP IF RECORD NOT FOUND                  
         BNE   XIT                                                              
*                                                                               
OBLIST30 DS    0H                                                               
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
         L     R4,AIO              POINT TO FOUND RECORD                        
*                                                                               
         MVI   ELCODE,PLISDTEQ     FIND DATE ELEMENT                            
         LR    R6,R4                                                            
         BAS   RE,GETEL            FIND ELEMENT                                 
         BNE   XIT                 GIVE UP IF NOT FOUND                         
*                                                                               
         USING PLISDTED,R6         ESTABLISH DATE ELEMENT                       
*                                                                               
         MVC   NAMEAREA(L'PLISDESC),PLISDESC   SET DESCRIPTION                  
*                                                                               
         MVC   SVPLISNM,PLISDESC   SAVE DESCRIPTION                             
         MVC   SVPLISKY,PLISKEY    SAVE KEY                                     
*                                                                               
OBLISTX  DS    0H                                                               
         B     GENOUT                                                           
*                                                                               
SVPLISNM DS    XL(L'PLISDESC)      PUBLIST DESCRIPTION SAVEAREA                 
SVPLISKY DS    XL(L'PLISKEY)       PUBLIST KEY SAVEAREA                         
*                                                                               
OASPNO   MVC   0(9,R3),0(R2)                                                    
         B     XIT                                                              
*                                                                               
OCOUNT   DS    0H                                                               
         MVI   0(R3),C'1'        COUNT                                          
         B     XIT                                                              
*                                                                               
*        NUMBER OF INSERTIONS                                                   
*        IF GLARGS+0 ^= NULLS THEN GLARGS+0 IS PRINTED IF THERE ARE             
*          BUYS ELSE LEFT BLANK                                                 
*                                                                               
ONUMINS  XC    EBLOCK,EBLOCK                                                    
         ST    R2,EBAIN                                                         
*                                                                               
         CLI   GLARGS,0           IF THERE ARE NO ARGUMENTS                     
         BE    OBCOST3               THEN PRINT NUMBER                          
*                                                                               
         L     R1,GLATHID                                                       
         USING GLINTD,R1           ESTABLISH INTERNAL REC DESCRIPTION           
*                                                                               
         CLC   GLLEVEL,GLDETLEV    DON'T PRINT IF A TOTAL LINE                  
         BNE   ONUMINSX                                                         
*                                                                               
         OC    0(8,R2),0(R2)       ELSE DON'T PRINT IF NO BUYS                  
         BZ    ONUMINSX                                                         
*                                                                               
         CP    0(8,R2),=P'0'                                                    
         BE    ONUMINSX                                                         
*                                                                               
         MVC   CODENNAM(1),GLARGS  ELSE PRINT INDICATOR IN ARGUMENTS            
*                                                                               
ONUMINSX DS    0H                                                               
*                                                                               
         B     GENOUT                                                           
         EJECT                                                                  
*                                                                               
*-------------->          OUTPUT ROUTINES                                       
*                                                                               
*        AGENCY ENTRIES                                                         
*                                                                               
OAGYA    DS    0H                                                               
         GOTO1 =A(OAGY)                                                         
         B     GENOUT                                                           
*                                                                               
*                                                                               
OMED     DS    0H                                                               
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(5),=C'MEDIA'       ** MEDIA **                          
*                                                                               
         MVC   PBMED,0(R2)         MEDIA CODE                                   
         MVC   PBQADC,PBMED                                                     
*                                                                               
         CLI   GLARGS,C'N'         SKIP CODE IF NAME ONLY                       
         BE    OMED2                                                            
*                                                                               
         MVC   CODEAREA(1),0(R2)   DISPLAY MEDIA CODE                           
*                                                                               
         CLI   GLARGS,C'C'         DONE IF CODE ONLY WANTED                     
         BE    OMEDX                                                            
*                                                                               
OMED2    CLI   0(R2),C'C'          SPECIAL CASE FOR COMBINED MEDIA              
         BNE   OMED3                                                            
*                                                                               
         MVC   NAMEAREA(8),=C'COMBINED'                                         
*                                                                               
         B     OMEDX                                                            
*                                                                               
OMED3    DS    0H                                                               
*                                                                               
*        FIND MEDIA NAME IN MEDIA BUFFER                                        
*                                                                               
         L     R1,PBAMEDBF                                                      
         USING MEDBUFFD,R1                                                      
*                                                                               
         CLI   0(R1),0             END OF TABLE TEST                            
         BE    OMEDX                                                            
         CLC   MBFMED,0(R2)        MATCH ON MEDIA CODE                          
         BE    *+12                                                             
         LA    R1,MBFLEN(R1)                                                    
         B     *-22                                                             
*                                                                               
         MVC   NAMEAREA(L'MBFNAME),MBFNAME   PRINT MEDIA NAME                   
*                                                                               
OMEDX    DS    0H                                                               
*                                                                               
         B     GENOUT                                                           
*                                                                               
         DROP  R1                                                               
*                                                                               
*        CLIENT CODE AND NAME OUTPUT                                            
*        INPUT IS CL1 INPUT TOTAL LENGTH                                        
*                 CL3 CODE (MAYBE MISSING)                                      
*                 CL?  SOME PART OF NAME FOR SORT PURPOSES                      
*                                                                               
OCLT     DS    0H                          ** CLIENT **                         
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(6),=C'CLIENT'   SET LABEL                               
*                                                                               
         CLI   GLARGS+1,C'M'       IF MASTER CLIENT                             
         BNE   *+10                                                             
         MVC   LABLAREA(8),=C'MAST CLI'   CHANGE LABEL                          
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,0(R2)          GET TOTAL DRIVER INPUT LENGTH                
         BZ    OCLTX               NO DATA AVAILABLE                            
         AHI   R1,-3               DISPLACEMENT TO CLIENT CODE                  
*                                                                               
         CHI   R1,1                IF INPUT LARGE ENOUGH                        
         BNH   *+8                                                              
         AHI   R1,-1                  BACK UP ANOTHER BYTE                      
*                                                                               
         LA    RF,0(R1,R2)         POINT TO CLIENT CODE                         
         MVC   PBCLT,0(RF)         SAVE CLIENT CODE                             
         OC    PBCLT,SPACES        MAKE UPPERCASE                               
*                                                                               
         CLI   GLARGS,C'C'         SKIP IF ONLY CODE WANTED                     
         BE    *+10                                                             
         MVC   PBMED,3(RF)            SAVE MEDIA CODE                           
*                                                                               
         CLI   GLARGS,C'N'         SKIP IF ONLY NAME WANTED                     
         BE    OCLT2                                                            
         MVC   CODEAREA(3),0(RF)   CLIENT CODE                                  
*                                                                               
         CLI   GLARGS,C'C'         DONE IF ONLY CODE WANTED                     
         BE    OCLTX                                                            
*                                                                               
OCLT2    DS    0H                                                               
*                                                                               
*        FIND CLIENT ENTRY IN BUFFER                                            
*                                                                               
         CLC   =C'***',0(RF)       IF CLIENT VARIOUS                            
         BNE   *+14                                                             
         MVC   NAMEAREA(7),=C'VARIOUS'    FILL IN NAME                          
         B     OCLTX                                                            
*                                                                               
         L     RE,PBACLTBF         POINT TO CLIENT BUFFER                       
         L     R0,PBCCLTBF         GET NUMBER OF ENTRIES IN BUFFER              
*                                                                               
OCLTLP   DS    0H                                                               
*                                                                               
         CLI   PBMED,C' '          SKIP IF MEDIA NOT KNOWN                      
         BNH   *+14                                                             
         CLC   PBMED,CBFMED-CLTBUFFD(RE)   FIND MEDIA  IN BUFFER                
         BNE   OCLTCN                                                           
*                                                                               
         CLC   PBCLT,CBFCLT-CLTBUFFD(RE)   FIND CLIENT IN BUFFER                
         BE    OCLTFD              FOUND                                        
*                                                                               
OCLTCN   DS    0H                                                               
*                                                                               
         LA    RE,CBFLEN(RE)       NEXT ENTRY IN BUFFER                         
         BCT   R0,OCLTLP                                                        
         B     OCLTX               NOT IN BUFFER                                
*                                                                               
OCLTFD   DS    0H                                                               
*                                                                               
         MVC   NAMEAREA(L'CBFNAME),CBFNAME-CLTBUFFD(RE) FILL IN NAME            
*                                                                               
OCLTX    DS    0H                                                               
         B     GENOUT                                                           
*                                                                               
         EJECT                                                                  
*                                                                               
*-------------->             ESTIMATE OUTPUT ROUTINE                            
*                                                                               
OESTNUMB DS       0H                                                            
         B     OEST                                                             
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        REP AND ADDRESS FIELDS OUTPUT ROUTINE                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
OADDRESS DS    0H                                                               
*                                                                               
         GOTO1 =V(OADRREP)                                                      
         BNE   GENOUT              USE GENERAL OUTUT ROUTINE                    
         B     XIT                                                              
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        Special rep output routine                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
OBUYSREP DS    0H                                                               
         GOTO1 =A(OBYSREP)                                                      
         B     XIT                                                              
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        USER FIELDS OUTPUT ROUTINE                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
OUDFR    DS    0H                                                               
*                                                                               
         GOTO1 =A(OUDF)                                                         
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    GENOUT                                                           
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BE    GENOUT                 USE GENERAL OUTPUT ROUTINE                
*                                                                               
         B     XIT                 ELSE NORMAL EXIT                             
*                                                                               
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        REP FIELDS OUTPUT ROUTINE                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
OOREP    DS    0H                                                               
*                                                                               
         GOTO1 =A(OREP)                                                         
         BNE   GENOUT              USE GENERAL OUTUT ROUTINE                    
         B     XIT                                                              
*                                                                               
         EJECT                                                                  
*                                                                               
*  PUBLISHER                                                                    
*                                                                               
OPUBLSHR DS    0H                                                               
         GOTO1 =A(COMMON1),DMCB,44                                              
         B     GENOUT                                                           
*********************************************************                       
*    PRINT ESTIMATE                                     *                       
*********************************************************                       
OEST     GOTO1 =A(COMMON1),DMCB,36                                              
OESTCOMM CHI   R1,32           IF EQUAL THEN EXIT TO GENOUT                     
         BE    GENOUT                                                           
         B     XIT                                                              
*                                                                               
         EJECT                                                                  
*                                                                               
*-------------->     MARKET OUTPUT                                              
OMARKET DS    0H                                                                
         GOTO1 =A(COMMON1),DMCB,RTOMARK                                         
         B     GENOUT                                                           
*                                                                               
*                                                                               
*-------------->  PRINT LINES INCHES                                            
*                                                                               
ONCHLINE DS    0H                                                               
*                                                                               
         XC    EBLOCK,EBLOCK       INIT EDIT BLOCK                              
*                                                                               
         L     R1,GLADTENT                                                      
         USING DROD,R1                                                          
*                                                                               
         LR    RF,R2               POINT TO INCH INPUT                          
*                                                                               
         CLI   GLARGS,C'L'         IF LINES                                     
         BNE   *+8                                                              
         LA    RF,8(RF)               USE SECOND BUCKET                         
*                                                                               
         ST    RF,EBAIN            PASS INPUT ADDRESS                           
*                                                                               
         MVI   EBLIN,8             INPUT LENGTH                                 
         MVI   EBTIN,C'P'          INPUT FORMAT IS PACKED                       
*                                                                               
         ST    R3,EBAOUT           OUTPUT ADDRESS                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,DROLEN           GET MAX OUTPUT LENGTH                        
         BCTR  RF,0                DECREMENT BY 1 FOR I/L TRAILER               
         STC   RF,EBLOUT           SET OUTPUT LENGTH                            
*                                                                               
         OI    EBOPT,X'80'         PRINT WITH COMMAS                            
*                                                                               
         CLI   DOWNOPT,C'Y'        FORCE ZEROS IF DOWNLOADING                   
         BNE   *+8                                                              
         OI    EBOPT,EBOQZEN       ZEROS NOT REPLACED BY BLANKS                 
*                                                                               
         TM    DROEDIT,EBOQZEN     PRINT ZEROS IF ASKED                         
         BNO   *+8                                                              
         OI    EBOPT,EBOQZEN                  PRINT ZEROS                       
*                                                                               
         CLI   GLARGS,C'I'         IF INCHES                                    
         BNE   *+8                                                              
         MVI   EBDECS,2               PRINT WITH 2 DECIMALS                     
*                                                                               
         DROP  R1                                                               
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK  PRINT AVG DAYS TO DISBURSE                 
*                                                                               
         SR    RF,RF                                                            
         IC    RF,EBLOUT           OUTPUT LENGTH                                
         LA    RF,0(RF,R3)         POINT TO END OF OUTPUT                       
         MVC   0(1,RF),GLARGS      INCH/LINE INDICATOR                          
*                                                                               
ONCHX    DS    0H                                                               
         B     XIT                                                              
*                                                                               
*-------------->   CLIENT OFFICE  CODE ==========================               
*                                                                               
OCLOFF   DS    0H                                                               
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   CODEAREA,SPACES     INIT OUTPUT AREA                             
         MVC   NAMEAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(6),=C'OFFICE'                                           
*                                                                               
         CLI   0(R2),X'FF'       NO BILLING CODE // FORCE TO BOTTOM             
         BNE   OCLOFFC                                                          
*                                                                               
         MVC   CODEAREA(3),=C'N/A'                                              
*                                                                               
         CLI   MYLTYP,C'M'         MIDLINE                                      
         BNE   *+10                                                             
         MVC   CODEAREA(10),=C'UNASSIGNED'                                      
*                                                                               
         B     OCLOFFCX                                                         
*                                                                               
OCLOFFC  DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'C'         IF CODE ONLY                                 
         BNE   *+14                                                             
         MVC   CODEAREA(2),0(R2)      RETURN CODE                               
         B     OCLOFFCX               DONE                                      
*                                                                               
         CLI   GLARGS,C'B'         IF CODE AND NAME                             
         BNE   *+10                                                             
         MVC   CODEAREA(2),0(R2)      RETURN CODE                               
*                                                                               
         MVC   NAMEAREA(20),2(R2)  RETURN OFFICE NAME                           
*                                                                               
OCLOFFCX DS    0H                                                               
*                                                                               
         B     GENOUT                                                           
*                                                                               
         DROP  R4                                                               
*                                                                               
*-------------->  PRODUCT NAME AND CODE ==========================              
*                                                                               
OPRODAN  DS    0H                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(7),=C'PRODUCT'                                          
         CLI   GLARGS,C'C'                                                      
         BE    OPRODANA                                                         
*========              ========*                                                
         L     R1,GLATHID                                                       
         USING GLINTD,R1           SEE IF A TOTAL LINE                          
*========              ========*                                                
         CLC   GLLEVEL,GLDETLEV    IF YES GET OUT                               
         BNE   OPRODANA                                                         
*                                                                               
         MVC   NAMEAREA(20),3(R2)       PRODUCT NAME                            
OPRODANA CLI   GLARGS+1,C'N'        NAME ONLYSAGE          T                    
         BE    OPRODANX                                                         
         MVC   CODEAREA(3),0(R2)     PROD CODE                                  
         CLI   GLARGS,C'C'                                                      
         BE    GENOUT                                                           
OPRODANX DS    0H                                                               
         MVC   NAMEAREA(20),3(R2)                                               
         B     GENOUT                                                           
*                                                                               
*-------------->   CONTRACT UNITS ================================              
*                                                                               
OCONUNAC DS    0H                                                               
*                                                                               
         TM    GLINDS,GLTOTLIN     NEVER PRINT TOTALS                           
         BO    XIT                                                              
*                                                                               
         GOTO1 =A(OCONUNAR)        HANDLE ACTIVITY INDICATOR                    
*                                                                               
         LA    RE,OCUNRTRN         FORCE RETURN FROM OCONUNIT                   
*                                                                               
         NTR1                      SAVE REGISTERS                               
*                                                                               
         LA    R2,32(R2)           POINT TO CON-UNIT INPUT                      
*                                                                               
         B     OCONUNIT            PRINT CON-UNIT                               
*                                                                               
OCUNRTRN DS    0H                  OCONUNIT RETURNS HERE                        
*                                                                               
         L     R1,GLADTENT         ESTABLISH OUTPUT TABLE                       
         USING DROD,R1                                                          
*                                                                               
         L     RF,=A(OCAOLEN)      RESTORE DROLEN                               
         MVC   DROLEN,0(RF)                                                     
*                                                                               
         B     XIT                 GET OUT                                      
*                                                                               
OCONUNIT DS    0H                                                               
*                                                                               
         CLI   0(R2),X'FF'         IF NO DATA INDICATOR SET                     
         BNE   *+18                                                             
         CP    1(7,R2),=P'0'          EXIT IF 0 UNITS FOUND                     
         BE    XIT                                                              
         MVI   0(R2),0                CLEAR MASK                                
*                                                                               
         XC    EBLOCK,EBLOCK                                                    
*                                                                               
*        FILL IN EBLOCK FIELDS FROM DRIVE TABLE                                 
*                                                                               
         L     R1,GLADTENT         ESTABLISH OUTPUT TABLE                       
         USING DROD,R1                                                          
*                                                                               
         MVC   EBFILL,DROFILL      FILL CHARACTER                               
         MVC   EBFLOAT,DROFLOAT    FLOAT CHARACTER                              
         MVC   EBALIGN,DROALIGN    ALIGN OPTION                                 
         MVC   EBOPT,DROEDIT       EDIT OPTIONS                                 
         MVC   EBTRIM,DROFORM      FORMAT OPTIONS                               
*                                                                               
         ZIC   RF,DRODEC           GET DECIMALS FOR OUTPUT                      
         ZIC   RE,DRODIV           GET AMOUNT TO DIVIDE BY                      
*                                                                               
         CLI   0(R2),C'$'          IF $ VOLUME CONTRACT                         
         MVI   0(R2),0              FORCE TO ZERO                               
         BNE   *+10                                                             
         BCTR  RF,0                 DECREMENT DECIMALS                          
         LA    RE,1(RE)             DIVIDE BY ANOTHER FACTOR OF 10              
*                                                                               
         STC   RF,EBDECS           SET # OF DECIMALS                            
         STC   RE,EBROUND          SET ROUNDING FACTOR                          
*                                                                               
         ST    R2,EBAIN           ADDRESS OF INPUT                              
*                                                                               
         B     OBCOST3                                                          
*                                                                               
         DROP  R1                                                               
*                                                                               
*-------------->  CONTRACT DIFF =================================               
*                                                                               
OBDIFF   DS    0H                                                               
*                                                                               
         XC    OBDTRLER,OBDTRLER   INIT TRAILER                                 
*                                                                               
         CP    0(8,R2),=P'0'                                                    
         BNE   *+12                                                             
         CLI   DOWNOPT,C'Y'        PRINT ZEROS IF DOWNLOADING                   
         B     XIT                 ELSE EXIT WITHOUT PRINTING                   
*        BNE   XIT                 ELSE EXIT WITHOUT PRINTING                   
*                                                                               
*========              ========*                                                
         L     R1,GLATHID                                                       
         USING GLINTD,R1                                                        
*========              ========*                                                
*                                                                               
         CLC   GLLEVEL,GLDETLEV    IF DOING A TOTAL                             
         BE    OBDIFF05                                                         
*                                                                               
         TM    PBQREAD,PBQRDBUY      IF NOT READING BUYS                        
         BNO   OBDIFF10                 SKIP AVERAGING                          
*                                                                               
         CLI   GLARGS,C'C'           ELSE IF THIS A CONTRACT ENTRY              
         BE    XIT                       SKIP TOTALLING                         
*                                                                               
         B     OBDIFF10              ELSE SKIP AVERAGING                        
*                                                                               
OBDIFF05 DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'C'         IF NOT A CONTRACT ENTRY                      
         BNE   OBDIFF10              SKIP AVERAGING                             
*                                                                               
         ZAP   WORK(16),0(8,R2)    REPORT AVERAGE OF ALL                        
*                                                                               
         CP    10(6,R2),=P'0'      SKIP DIVIDE IF ZERO                          
         BE    *+10                                                             
         DP    WORK(16),10(6,R2)   OCCURRENCES                                  
*                                                                               
         ZAP   0(8,R2),WORK(10)                                                 
*                                                                               
OBDIFF10 DS    0H                                                               
*                                                                               
         XC    EBLOCK,EBLOCK                                                    
         MVI   EBDECS,2                ASSUME TWO POSITONS                      
*                                                                               
         CP    16(8,R2),=P'0'      CHECK FOR GROSS RATE                         
         BE    OKMVIEB                                                          
*                                                                               
         ZAP   WORK(16),16(8,R2)   DIVIDE RATE TYPE BY NUMBER OF                
*                                                                               
         CP    10(6,R2),=P'0'      SKIP DIVIDE IF ZERO                          
         BE    *+10                                                             
         DP    WORK(16),10(6,R2)     OCCURRENCES                                
*                                                                               
         ZAP   16(8,R2),WORK(10)                                                
*                                                                               
         CP    WORK+10(6),=P'0'    NON-ZERO REMAINDER MEANS MIXED               
         BE    *+18                   RATE TYPES AND THUS MEANINGLESS           
         CLI   DOWNOPT,C'Y'        IF NOT DOWN LOADING                          
         BNE   XIT                   SKIP PRINTING                              
         ZAP   0(8,R2),=P'0'       ELSE CLEAR TO ZERO                           
*                                                                               
         CP    16(8,R2),=P'1000'   IF >= 1000                                   
         BL    *+16                                                             
         SP    16(8,R2),=P'1000'                                                
         MVC   OBDTRLER,=C'/L'        ASSUME LINE UNIT RATE                     
*                                                                               
         CP    16(8,R2),=P'100'    IF >= 100                                    
         BL    *+16                                                             
         SP    16(8,R2),=P'100'                                                 
         MVC   OBDTRLER,=C'/I'        THEN INCH UNIT RATE                       
*                                                                               
         CP    16(8,R2),=P'10'         IF RESULT IS LESS THAN  10               
         BL    MVIEBFC             THEN NOT LINES OR INCHES                     
*                                                                               
         SP    16(8,R2),=P'10'                                                  
         MVI   EBDECS,5             FIVE DECIMAL PLACES                         
         BE    OKMVIEB              RESULT IS ZERO                              
*                                                                               
MVIEBFC  MVI   EBFLOAT,C'C'                                                     
*                                                                               
         CP    23(1,R2),=P'2'                                                   
         BL    OKMVIEB                                                          
*                                                                               
         MVI   EBFLOAT,C'N'             NET RATE INDICATOR                      
         BE    OKMVIEB                                                          
*                                                                               
         MVI   EBFLOAT,C'S'             S RATE INDICATOR                        
*                                                                               
OKMVIEB  ST    R2,EBAIN           ADDRESS OF INPUT                              
         B     OBCOST3                                                          
*                                                                               
OBDTRLER DC    XL2'00'             RATE TYPE TRAILER '/L' OR '/I'               
*                                                                               
*-------------->   PAID DETAILS ==================================              
*                                                                               
OPAYMENT GOTO1 =A(COMMON1),DMCB,0      PAID                                     
         B     XIT                                                              
*                                                                               
*-------------->    BILLED DETAILS ================================             
*                                                                               
OBILLEDD GOTO1 =A(COMMON1),DMCB,4      BILLED                                   
         B     XIT                                                              
*                                                                               
*-------------->   COPY ===========================================             
*                                                                               
OBCOPY   DS    0H                                                               
         MVC   NAMEAREA(17),0(R2)                                 L07           
         CLI   MYLTYP,C'H'                                        L07           
         BNE   GENOUT                                             L07           
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(4),=C'COPY'                                             
         MVI   CODEAREA,C'-'                                                    
         B     GENOUT                                                           
*                                                                               
*-------------->   CAPTION =========================================            
*                                                                               
OBCAPT   DS    0H                                                               
*                                                                               
*        IF DOWNLOADING, CHANGE " TO '                                          
*                                                                               
         CLI   DOWNOPT,C'Y'        IF DOWNLOADING                               
         BNE   OBCAPT1A                                                         
*                                                                               
         LR    R1,R2               POINT TO CAPTION                             
         LA    RF,50               LENGTH OF CAPTION                            
*                                                                               
         CLI   0(R1),C'"'          CHANGE ALL " TO '                            
         BNE   *+12                                                             
         MVI   0(R1),C''''                                                      
         BCT   RF,*-12                                                          
*                                                                               
OBCAPT1A DS    0H                                                               
*                                                                               
         XC    NAMEAREA,NAMEAREA                                                
*                                                                               
         MVC   NAMEAREA(25),0(R2)                                               
*                                                                               
         CLI   MYLTYP,C'H'                                                      
         BNE   OBCAPT2                                                          
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(7),=C'CAPTION'                                          
         MVI   CODEAREA,C'-'                                                    
*                                                                               
         B     GENOUT                                             L07           
*                                                                               
OBCAPT2  TM    PBQPOPT,PBQPOCUT                                                 
         BO    GENOUT                                                           
*                                                                               
         MVC   0(25,R3),0(R2)                                      L29          
*                                                                               
         CLC   25(25,R2),SPACES    IF MORE TO CAPTION                           
         BNH   *+10                                                             
         MVC   198(25,R3),25(R2)      PRINT IT                     L29          
*                                                                               
         B     XIT                                                              
*                                                                               
*-------------->  CIRCULATION ====================================              
*                                                                               
OCIRC    DS    0H                                                               
         CLI   GLARGS,C'E'                                                      
         BNE   OCIRCC                                                           
         L     RF,DATCON                                                        
         CLI   2(R2),0                IS DAY ZERO                               
         BE    OCIRCM                  JUST PRINT MM/YY                         
         GOTO1 (RF),DMCB,(3,0(R2)),(5,0(R3))                                    
         B     XIT                                                              
***                                                                             
OCIRCM   GOTO1 (RF),DMCB,(3,0(R2)),(6,0(R3))                                    
         B     XIT                                                              
***                                                                             
OCIRCC   CLI   GLARGS,C'C'                                                      
         BNE   OCIRCS                                                           
         XC    EBLOCK,EBLOCK                                                    
         ST    R2,EBAIN           ADDRESS OF INPUT                              
*========              ========*                                                
         L     R1,GLADTENT                                                      
         USING DROD,R1                                                          
*========              ========*                                                
         MVC   EBLOUT,DROLEN                                                    
         MVI   EBLIN,8             LENGTH                                       
         B     OBCOMM                                                           
*                                                                               
         DROP  R1                                                               
*                                                                               
OCIRCS   CLI   GLARGS,C'S'              SOURCE REQUIRED                         
         BNE   XIT                                                              
         MVC   0(4,R3),0(R2)                                                    
         B     XIT                                                              
*                                                                               
*-------------->   JOB NUMBER =====================================             
*                                                                               
OJOB     MVC   0(6,R3),0(R2)                                                    
         B     XIT                                                              
*                                                                               
*-------------->   SPECIAL HANDLING FOR CONTRACT RATE =============             
*                                                                               
OCONTRAT DS    0H                                                               
         CP    0(8,R2),=P'0'                                                    
         BE    XIT                                                              
         ZAP   DMCB(16),0(8,R2)                                                 
         DP    DMCB(16),13(3,R2)                                                
         ZAP   0(8,R2),DMCB(13)                                                 
         XC    EBLOCK,EBLOCK                                                    
         MVI   EBDECS,2                                                         
         ST    R2,EBAIN           ADDRESS OF INPUT                              
         B     OBCOST                                                           
*                                                                               
*-------------->   DISTRICT NAME  ===================================           
*                                                                               
ODISTRIC DS    0H                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(8),=C'DISTRICT'                                         
         B     DRDCOM                                                           
*                                                                               
*-------------->   REGION NAME ====================================             
*                                                                               
OREGION  DS    0H                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(8),=C'REGION  '                                         
         B     DRDCOM                                                           
*                                                                               
*-------------->   BILLFORMULA   ====================================           
*                                                                               
OBILFOR  DS    0H                                                               
         GOTO1 =A(COMMON1),DMCB,RTOBFM                                          
         B     XIT                                                              
*                                                                               
*-------------->   DIVISION NAME ====================================           
*                                                                               
ODIVIS   DS    0H                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(8),=C'DIVISION'                                         
DRDCOM   DS    0H                                                               
         GOTO1 =A(COMMON1),DMCB,RTODRD                                          
         B     GENOUT                                                           
*                                                                               
         EJECT                                                                  
*                                                                               
*-------------->   JOB OUTPUT ROUTINE                                           
*                                                                               
OBJOB    GOTO1 =A(COMMON1),DMCB,RTOOJOB                                         
         CHI   R1,32                                                            
         BE    XIT                                                              
         B     GENOUT                                                           
*                                                                               
*-------------->      COLUMN OUTPUT ROUTINES                                    
*                                                                               
ODUMMY   MVI   0(R3),C' '          DUMMY                                        
         B     XIT                                                              
*                                                                               
OCLINCOD LA    R1,5                                                             
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(11),=C'INTERFACE #'                                     
*                                                                               
OCLINCCO CLI   0(R2),255                                                        
         BNE   *+14                                                             
         MVC   0(3,R3),=C'N/A'                                                  
         B     CHK4H                                                            
*                                                                               
         EX    R1,*+8                                                           
         B     CHK4H                                                            
         MVC   0(0,R3),0(R2)                                                    
*                                                                               
OPRINCOD LA    R1,4                                                             
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(9),=C'ACCOUNT #'                                        
         B     OCLINCCO                                                         
*                                                                               
CHK4H    CLI   MYLTYP,C'H'                                                      
         BNE   XIT                                                              
         MVC   CODEAREA(5),0(R3)                                                
         CLI   0(R2),255                                                        
         BNE   GENOUT                                                           
         MVC   CODEAREA(10),=C'UNASSIGNED'                                      
         B     GENOUT                                                           
*                                                                               
*-------------->  BUY COMMENT ================================                  
*                                                                               
OCOMMENT CLI   0(R2),X'FF'         NO COMMENT                                   
         BE    XIT                                                              
         OC    0(30,R2),0(R2)                                                   
         BZ    XIT                                                              
*                                                                               
         LH    RF,=Y(PPBYOUTC-SYSD)  DISPLACEMENT OF PPBYOUT AREA               
         AR    RF,R9                                                            
         USING PPBYOUTD,RF         ESTABLISH PPBYOUT AREA                       
*                                                                               
         LA    RF,PBYOCOMS                                                      
*                                                                               
         DROP  RF                                                               
*                                                                               
         MVI   0(RF),C' '        CLEAR WORK AREA                                
         MVC   1(L'PBYOCOMS-1,RF),0(RF)                                         
*                                                                               
* THE ADDRESS OF THE BUY ON DISK IS PASSED IN +35(4)                            
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY+27(4),35(R2)                                                 
*                                                                               
         CLI   39(R2),0            SKIP IF NO SE NUMBER PASSED                  
         BE    OCOMM1                                                           
*                                                                               
         L     RF,PBUTLA           POINT TO UTLA                                
         ZIC   R0,4(RF)            SAVE CURRENT SE NUMBER                       
         MVC   4(1,RF),39(R2)      CHANGE SE NUMBER FOR FILES                   
*                                                                               
OCOMM1   DS    0H                                                               
*                                                                               
         L     RF,AIO1                                                          
         ST    RF,AIO                                                           
         OI    DMINBTS,8          PASS DELETED RECORDS                          
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         CLI   GLARGS,C'B'        BUY COMMENT                                   
         BNE   OIORDER                                                          
*                                                                               
         GOTO1 =A(PP12468),DMCB,(X'66',AIO),=C'NOSQ'                            
*                                                                               
         B     OORERCOM                                                         
*                                                                               
*                                                                               
*-------------->   INSERTION ORDER INSTRUCTIONS ===============                 
*                                                                               
OIORDER  CLI   GLARGS,C'I'                                                      
         BNE   OPOSITN                                                          
         GOTO1 =A(PP12468),DMCB,(X'67',AIO),=C'NOSQ'                            
         B     OORERCOM                                                         
*                                                                               
*-------------->   POSITION ORDER INSTRUCTIONS ================                 
*                                                                               
OPOSITN  CLI   GLARGS,C'P'                                                      
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 =A(PP12468),DMCB,(X'68',AIO),=C'NOSQ'                            
*                                                                               
OORERCOM DS    0H                                                               
*                                                                               
         CLI   39(R2),0            SKIP IF NO SE NUMBER PASSED                  
         BE    OCOMM2                                                           
*                                                                               
         L     RF,PBUTLA           POINT TO UTLA                                
         STC   R0,4(RF)            RESTORE CURRENT SE NUMBER                    
*                                                                               
OCOMM2   DS    0H                                                               
*                                                                               
         L     R2,0(R1)            ADDRESS OF WORK AREA FROM PP12468            
*========              ========*                                                
         L     R6,GLADTENT                                                      
         USING DROD,R6                                                          
*========              ========*                                                
         TM    PBQPOPT,PBQPOCUT                                                 
         BNO   OORNOCT                                                          
*                                                                               
         ZIC   RF,DROLEN           OUTPUT LENGTH                                
         BCTR  RF,0            ENTRY LENGTH CONTAINS BOX LINE                   
         EX    RF,*+8                                                           
         B     XIT                                                              
         MVC   0(0,R3),0(R2)                                                    
*                                                                               
OORNOCT  DS    0H                                                               
*                                                                               
         ZIC   RF,DROLEN           MAX COMMENT LENGTH                           
         LA    RE,11                                                            
         MR    RE,RE                                                            
*                                                                               
         GOTO1 CHOPPER,DMCB,(0,0(R2)),(DROLEN,(R3)),(198,14),          X        
               C'LEN=',(RF)                                                     
*        ========  *                                                            
         DROP  R6                                                               
*        ========  *                                                            
         ICM   RF,15,8(R1)                NUMBER OF LINES                       
         B     XIT                                                              
         L     RE,4(R1)                ADDRESS OF CHOPPED                       
         ZIC   R6,4(R1)                LENGTH OF CHOPPED                        
         BCTR  R6,0                    FOR EX                                   
XCOMOVE  EX    R6,*+8                                                           
         B     *+10                                                             
         CLC   0(0,RE),SPACES                                                   
         BNH   XCNOMOVE                                                         
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(RE)                                                    
*                                                                               
XCNOMOVE LA    R3,198(R3)                                                       
         LA    RE,1(R6,RE)                                                      
         BCT   RF,XCOMOVE                                                       
         B     XIT                                                              
*                                                                               
OBOOUT   XC    EBLOCK,EBLOCK                                                    
         MVI   EBDECS,0                                                         
         ST    R2,EBAIN                                                         
         B     OBCOST3                                                          
*                                                                               
*-------------->   CLIENT CODE =============================                    
*                                                                               
OCLICODE MVC   0(3,R3),0(R2)       CLIENT CODE                                  
         B     XIT                                                              
*                                                                               
OBCOST   DS    0H                                                               
OBCOMMON XC    EBLOCK,EBLOCK                                                    
         MVI   EBDECS,2                                                         
*========              ========*                                                
         L     R1,GLADTENT                                                      
         USING DROD,R1                                                          
*========              ========*                                                
         CLI   DRODIV,0            IF FACTORING                                 
         BE    *+10                                                             
         MVC   EBDECS,DRODEC       USE DECIMAL OVERRIDE                         
*                                                                               
         ST    R2,EBAIN                                                         
         TM    PBQGET,1            ROUNDING                       L10           
         BNO   OBCOST3                                            L10           
         MVI   EBDECS,0            NO DECIMALS                    L10           
         MVI   EBROUND,2                                          L10           
         B     OBCOST3                                                          
*                                                                               
*-------------->   GROSS RATE  =============================                    
*                                                                               
OBCOST3  DS    0H                                                               
*========              ========*                                                
         L     R1,GLADTENT                                                      
         USING DROD,R1                                                          
*========              ========*                                                
         MVC   EBLOUT,DROLEN                                                    
*                                                                               
         OC    OBDTRLER,OBDTRLER   IF THERE IS A TRAILER                        
         BZ    *+18                                                             
         SR    RF,RF                                                            
         IC    RF,EBLOUT                                                        
         SH    RF,=Y(L'OBDTRLER)      SHORTEN OUTPUT LENGTH                     
         STC   RF,EBLOUT                                                        
*                                                                               
         MVI   EBLIN,8             LENGTH                                       
*                                                                               
OBCOMM   MVI   EBTIN,C'P'                                                       
         MVI   0(R2),0             ELIMINATE MASK                 L09           
         ST    R3,EBAOUT                                                        
*                                                                               
         CLI   EBFLOAT,0           FLOAT OVERRIDE                               
         BH    *+8                                                              
         MVI   EBFLOAT,C'-'                                                     
*                                                                               
         CLI   EBROUND,0           IF NO FLOAT OVERRIDE                         
         BH    *+10                                                             
         MVC   EBROUND,DRODIV         USE FIELDS OVERRIDE                       
*                                                                               
         MVC   EBOPT,DROEDIT       EDIT OPTIONS                                 
****     MVI   EBOPT,EBOQCEY                                                    
*                                                                               
         TM    0(R2),X'08'           FROZEN RATE                                
         BNO   *+16                                                             
         MVI   EBFLOAT,C'*'                                                     
         OI    EBOPT,EBOQMEY                                                    
         NI    EBOPT,X'FF'-EBOQBEY-EBOQBMF                                      
*                                                                               
         MVI   EBTRIM,EBTQROD                NO DECIMALS                        
*                                                                               
         CLI   DOWNOPT,C'Y'        FORCE ZEROS IF DOWNLOADING                   
         BNE   *+8                                                              
         OI    EBOPT,EBOQZEN       ZEROS NOT REPLACED BY BLANKS                 
*                                                                               
         TM    DROEDIT,EBOQZEN     PRINT ZEROS IF ASKED                         
         BNO   *+8                                                              
         OI    EBOPT,EBOQZEN                  PRINT ZEROS                       
*        ========  *                                                            
         DROP  R1                                                               
*        ========  *                                                            
*========              ========*                                  L09           
         L     R1,GLATHID                                         L09           
         USING GLINTD,R1           SEE IF A TOTAL LINE            L09           
*========              ========*                                  L09           
         CLC   GLLEVEL,GLDETLEV    IF NOT JUST PRINT              L09           
         BE    OBCOMA                                             L09           
         LA    RF,LEVELCON         PRINT ONLY ON THIS LEVEL BREAK L09           
OBCOMLVL CLI   0(RF),0                                            L09           
         BE    OBCOMA                                             L09           
         CLC   GLLEVEL,0(RF)                                      L09           
         BE    SPHL                                               L09           
         LA    RF,1(RF)                                           L09           
         B     OBCOMLVL                                           L09           
OBCOMA   GOTO1 GLAEDITR,DMCB,EBLOCK                               L09           
*                                                                               
         OC    OBDTRLER,OBDTRLER   IF THERE IS A TRAILER                        
         BZ    OBCOMX                                                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,EBLOUT                                                        
         LA    RF,0(RF,R3)            POINT TO TRAILER AREA                     
         MVC   0(L'OBDTRLER,RF),OBDTRLER    MOVE OUT TRAILER                    
         XC    OBDTRLER,OBDTRLER            RESET    TRAILER                    
*                                                                               
OBCOMX   DS    0H                                                               
*                                                                               
         B     XIT                                                              
         SPACE 2                                                                
*                                                                               
*     POSSIBLE COMBINATIONS-- TOTAL COMBINED  FOLLLOWD BY LIVE THEN             
*                             TEST.  IN THIS ORDER                              
SPHL     DS    0H                                                               
         TM    PBQTOTTY,TOTTYPNT     NORMAL AND TEST              L09           
         BNO   SPLLT               M/B LIVE AND TEST              L09           
         ZAP   WORK(8),0(8,R2)     REVERSE ORDER / PRINT TEST     L13           
         ZAP   0(8,R2),8(8,R2)     THEN TOTAL                     L13           
         ZAP   8(8,R2),WORK(8)     SLAP IN TOTAL                  L13           
OBCOMM1A GOTO1 GLAEDITR,DMCB,EBLOCK                               L09           
         LA    RF,8(R2)                                           L09           
         ST    RF,EBAIN                                           L09           
         LA    R3,198(R3)                                         L09           
         ST    R3,EBAOUT                                          L09           
*        CP    0(8,R2),=P'0'                                      L09           
*        BE    XIT                                                L09           
         GOTO1 GLAEDITR,DMCB,EBLOCK                               L09           
         TM    PBQTOTTY,TOTTYPNT     NORMAL AND TEST              L09           
         BO    XIT                                                L09           
         AP    8(8,R2),0(8,R2)                                    L09           
         LA    R3,198(R3)                                         L09           
         ST    R3,EBAOUT                                          L09           
         GOTO1 GLAEDITR,DMCB,EBLOCK                               L09           
         B     XIT                                                L09           
SPLLT    SP    0(8,R2),8(8,R2)     SUBT TEST FROM TOTAL TO MAKE   L09           
*                                  LIVE                           L09           
         B     OBCOMM1A                                           L09           
*                                                                               
*-------------->  OAN NAME + CODE =================================             
*                                                                               
*        IF CODE       THEN INPUT IS CODE(2),                                   
*        IF NAME ORDER THEN INPUT IS NAME(32), CODE(2)                          
*                                                                               
OBOANAME DS    0H                                                               
*========              ========*                                                
         L     RF,GLADTENT                                                      
         USING DROD,RF                                                          
*========              ========*                                                
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(5),=C'O-A-N'   SET LABEL                                
*                                                                               
         CLI   32(R2),0           SKIP CODE IF NO CODE PROVIDED                 
         BE    OBOBMP                                                           
*                                                                               
         MVC   CODEAREA(2),32(R2)  AGENCY ALPHA CODE                            
*                                                                               
         CLI   MYLTYP,C'H'         IF HEADLINE                                  
         BE    *+8                                                              
         MVI   CODEAREA+3,C'-'       SKIP SEPARATOR                             
*                                                                               
OBOBMP   DS    0H                                                               
*                                                                               
         LA    R6,32               NAME'S INPUT LENGTH                          
*                                                                               
         CLI   MYLTYP,C'H'         IF HEADLINE                                  
         BNE   *+8                                                              
         LA    R6,20                  HEADLINE FIELD LENGTH IS 20               
*                                                                               
         LA    RF,L'NAMEAREA       OUTPUT AREA LENGTH                           
         CR    R6,RF               DEFAULT TO SMALLER LENGTH                    
         BNH   *+6                                                              
         LR    R6,RF                                                            
*                                                                               
         BCTR  R6,0                DECREMENT FOR EXECUTE                        
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   NAMEAREA(0),0(R2)   NAME                                         
*                                                                               
         B     GENOUT                                                           
*                                                                               
*        OAN CODE ONLY                                                          
*                                                                               
OBOANCOD DS    0H                  PRINT ONLY CODE                              
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(5),=C'O-A-N'   SET LABEL                                
         MVC   CODEAREA(2),0(R2)   CODE                                         
*                                                                               
         B     GENOUT                                                           
*                                                                               
         DROP  RF                                                               
*                                                                               
*-------------->   LINE NUMBER  ================================                
*                                                                               
OLINENO   DS   0H                  0H                                           
          LA   R6,CODEAREA-1       R6,CODEAREA-1                                
*                                                                               
         EDIT  (1,3(R2)),(2,1(R6))                                              
         OI    1(R6),X'F0'          FORCE TO PRINT                              
*                                                                               
         CLI   3(R2),100           SKIP IF LINE NUMBER UNDER 100                
         BL    OLINENOX                                                         
*                                                                               
         ZIC   RF,3(R2)            LINE NUMBER                                  
         CVD   RF,DMCB                                                          
         DP    DMCB(8),=P'10'         MULTIPLE OF 10'S                          
         ZAP   DMCB(8),DMCB(6)                                                  
         SP    DMCB(8),=P'10'                                                   
         CVB   RF,DMCB                                                          
         LA    RF,ALPHATAB(RF)                                                  
         MVC   1(1,R6),1(RF)                                                    
*                                                                               
OLINENOX DS    0H                                                               
*                                                                               
         B     GENOUT                                                           
*                                                                               
*-------------->   INSERT DATE  IN YYMMDD FORMAT  ==============                
*                                                                               
OINSYYMM DS   0H                                                                
*                                                                               
         LR    R6,R3               SET OUTPUT POINTER                           
*                                                                               
         CLI   MYLTYP,C'H'         IF HEADLINE                                  
         BNE   OINSYYM0                                                         
*                                                                               
         MVC   0(14,R3),=C'INSERTION DATE' SET LABEL                            
*                                                                               
         CLI  GLARGS+1,C'Y'       IF YEAR ONLY PASSED                           
         BNE  *+10                                                              
         MVC  0(14,R3),=C'INSERTION YEAR' SET LABEL                             
*                                                                               
         CLI  GLARGS+1,C'M'       IF MONTH ONLY PASSED                          
         BNE  *+10                                                              
         MVC  0(15,R3),=C'INSERTION MONTH' SET LABEL                            
*                                                                               
         CLI  GLARGS+1,C'D'       IF DAY ONLY PASSED                            
         BNE  *+10                                                              
         MVC  0(14,R3),=C'INSERTION DAY ' SET LABEL                             
*                                                                               
         LA    R3,CODENNAM-OUTAREA(R3) AND BUMP OUTPUT POINTER                  
         LA    R6,CODENNAM-OUTAREA(R6) AND BUMP OUTPUT POINTER                  
*                                                                               
OINSYYM0 DS   0H                                                                
*                                                                               
         CLI  GLARGS+1,C'Y'       IF YEAR ONLY PASSED                           
         BNE  OINSYYYX                                                          
*                                                                               
         MVC   FULL(3),=X'000101'    FORCE JAN FIRST OF YEAR                    
         MVC   FULL(1),0(R2)                                                    
         GOTO1 DATCON,DMCB,(3,FULL),(23,WORK)  YYYY-MM-DD                       
         MVC   0(4,R6),WORK           RETURN 4 DIGIT YEAR                       
*                                                                               
         B    OINSYYMX                                                          
*                                                                               
OINSYYYX DS    0H                                                               
*                                                                               
         CLI  GLARGS+1,C'M'       IF MONTH ONLY PASSED                          
         BNE  OINSYMMX                                                          
*                                                                               
         SR   RF,RF                                                             
         IC   RF,1(R2)                GET MONTH IN BINARY                       
         CVD  RF,DUB                                                            
         OI   DUB+7,X'0F'             FORCE SIGN                                
         UNPK 0(2,R6),DUB             PRINT MONTH                               
*                                                                               
         B    OINSYYMX                                                          
*                                                                               
OINSYMMX DS    0H                                                               
*                                                                               
          CLI  GLARGS+1,C'D'       IF DAY ONLY PASSED                           
          BNE  OINSYYM2                                                         
*                                                                               
          SR   RF,RF                                                            
          IC   RF,2(R2)                GET DAY IN BINARY                        
          CVD  RF,DUB                                                           
          OI   DUB+7,X'0F'             FORCE SIGN                               
          UNPK 0(2,R6),DUB             PRINT DAY                                
*                                                                               
          B    OINSYYMX                                                         
*                                                                               
OINSYYM2  DS   0H                                                               
*                                                                               
         LA    R0,X'20'            SET FOR PRINTABLE DATES                      
*                                                                               
         TM    PBQPOPT,PBQPORFP+PBQPOCTY  IF RFPDATE OR CCYYMMDD                
         BZ    *+8                                                              
         AHI   R0,20                  PUT OUT YYYYMMDD DATES                    
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),((R0),0(R3))      YYMMDD                   
*                                                                               
         LA    R1,0(R3)            POINT TO DECADES IN DATE                     
*                                                                               
         TM    PBQPOPT,PBQPORFP+PBQPOCTY  IF RFPDATE OR CCYYMMDD                
         BZ    *+8                                                              
         AHI   R1,2                   BUMP DECADES POINTER                      
*                                                                               
         CLI   GLARGS+15,C'M'      IF MONTH DATES                               
         BE    *+8                                                              
         CLI  2(R2),0              OR MONTHLY DATE                              
         BNE  *+10                                                              
         MVC  4(2,R1),=C'00'          KILL DAYS IN DATE                         
*                                                                               
         CLI   GLARGS+15,C'Q'      IF QUARTER DATE                              
         BNE   OINSYYM3                                                         
*                                                                               
         MVC   4(2,R1),=C'  '         KILL DAYS IN DATE                         
*                                                                               
*        IF RFPDATE FORMAT, PRINT NUMBER OF QUARTER AND NOT FIRST MONTH         
*                                                                               
         TM    PBQPOPT,PBQPORFP                                                 
         BNO   OINSYYM3                                                         
*                                                                               
         CLC   2(2,R1),=C'03'         CHECK FOR 1ST QUARTER                     
         BH    *+14                                                             
         MVC   2(2,R1),=C'01'                                                   
         B     OINSYYM3                                                         
*                                                                               
         CLC   2(2,R1),=C'06'         CHECK FOR 2ND QUARTER                     
         BH    *+14                                                             
         MVC   2(2,R1),=C'02'                                                   
         B     OINSYYM3                                                         
*                                                                               
         CLC   2(2,R1),=C'09'         CHECK FOR 3RD QUARTER                     
         BH    *+14                                                             
         MVC   2(2,R1),=C'03'                                                   
         B     OINSYYM3                                                         
*                                                                               
         CLC   2(2,R1),=C'12'         CHECK FOR 4TH QUARTER                     
         BH    *+14                                                             
         MVC   2(2,R1),=C'04'                                                   
         B     OINSYYM3                                                         
*                                                                               
OINSYYM3 DS   0H                                                                
*                                                                               
OINSYYMX DS   0H                                                                
         B    XIT                                                               
*                                                                               
         TITLE 'PRWRITER - T40509 - OINDATE'                                    
***********************************************************************         
*                                                                     *         
*        INSERT DATE OUTPUT                                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
OINDATE  DS    0H                                                               
*                                                                               
         OC    0(3,R2),0(R2)       SKIP IF NO DATE GIVEN                        
         BZ    OINDATEX                                                         
*                                                                               
         CLI   GLARGS,C'S'         IF BUY STATUS                                
         BNE   OINDATEC                                                         
*                                                                               
         CLI   0(R2),C'L'          IF LIVE BUY                                  
         BNE   *+14                                                             
         MVC   0(4,R3),=C'LIVE'                                                 
         B     OINDATEA                                                         
*                                                                               
         CLI   0(R2),C'T'          IF TEST BUY                                  
         BNE   *+14                                                             
         MVC   0(4,R3),=C'TEST'                                                 
         B     OINDATEA                                                         
*                                                                               
         CLI   0(R2),C'S'          IF STEWARD BUY                               
         BNE   *+14                                                             
         MVC   0(4,R3),=C'STEW'                                                 
         B     OINDATEA                                                         
*                                                                               
         CLI   0(R2),C'D'          IF DELETED BUY                               
         BNE   *+14                                                             
         MVC   0(4,R3),=C'DLTD'                                                 
         B     OINDATEA                                                         
*                                                                               
         CLI   0(R2),C'H'          IF HELD BUY                                  
         BNE   *+14                                                             
         MVC   0(4,R3),=C'HELD'                                                 
         B     OINDATEA                                                         
*                                                                               
         CLI   0(R2),C'O'          IF ORDERED (SPACE RESERVATION)               
         BNE   *+14                                                             
         MVC   0(4,R3),=C'ORD '                                                 
         B     OINDATEA                                                         
*                                                                               
OINDATEA DS    0H                                                               
*                                                                               
         B     OINDATEX                                                         
*                                                                               
OINDATEC DS    0H                                                               
*                                                                               
         CLC   GLARGS(2),=C'ID'    IF DAY OF WEEK                               
         BNE   *+14                                                             
         MVC   0(3,R3),1(R2)          RETURN DDD FORMAT                         
         B     OINDATEX                                                         
*                                                                               
         TM    PBQPOPT,PBQPOYYM    SKIP IF OUTPUT = YYMMDD FORMAT               
         BO    OINSYYMM                                                         
*                                                                               
         LR    R6,R3               POINT TO START OF OUTPUT                     
*                                                                               
         MVC   0(13,R6),SPACES     BECAUSE MAX DATE LENGTH IS 13                
*                                  CLEAR OUT POSSIBLE OLD DATE                  
*                                                                               
         TM    PBQPOPT,PBQPOCUT    USE OUTPUT AREA IF CUTTING OUTPUT            
         BNO   *+18                                                             
         LA    R6,CODENNAM                                                      
         MVC   LABLAREA(15),=C'INSERTION DATE ' SET LABEL                       
         B     OINDATE1                                                         
*                                                                               
         CLI   MYLTYP,C'H'         IF HEADLINE                                  
         BNE   OINDATE1                                                         
*                                                                               
         MVC   0(14,R6),=C'INSERTION DATE' SET LABEL                            
         LA    R6,CODENNAM-OUTAREA(R6) AND BUMP OUTPUT POINTER                  
         LA    R3,CODENNAM-OUTAREA(R3) AND BUMP OUTPUT POINTER                  
*                                                                               
OINDATE1 DS    0H                                                               
*                                                                               
         LA    RF,GLARGS+15        CHARACTERISTIC OF ADJACENT FIELD             
*                                                                               
         BRAS  RE,DATES            PRINT DATES IF GROUPED BY                    
*                                     WEEK, MONTH, QUARTER ETC.                 
*                                                                               
         BZ    OINDATEX            ROUTINE PRINTED DATE                         
*                                                                               
         CLI   4(R2),C'D'          IF DELETED BUY                               
         BNE   *+16                                                             
         MVI   0(R6),C'D'             FLAG WITH 'D'                             
         LA    R6,2(R6)                                                         
         B     OINDATWX                                                         
*                                                                               
         CLI   4(R2),C'T'          IF TEST BUY                                  
         BNE   *+16                                                             
         MVI   0(R6),C'T'             FLAG WITH 'T'                             
         LA    R6,2(R6)                                                         
         B     OINDATWX                                                         
*                                                                               
         CLI   4(R2),C'S'          IF STEWARD BUY                               
         BNE   *+16                                                             
         MVI   0(R6),C'S'             FLAG WITH 'S'                             
         LA    R6,2(R6)                                                         
         B     OINDATWX                                                         
*                                                                               
         CLI   4(R2),C'H'           IF HELD BUY                                 
         BNE   *+16                                                             
         MVI   0(R6),C'H'             FLAG WITH 'H'                             
         LA    R6,2(R6)                                                         
         B     OINDATWX                                                         
*                                                                               
         CLI   4(R2),C'W'           IF WEEK OF BUY                              
         BE    *+8                                                              
         CLI   4(R2),C'B'           OR BEST FOOD DAY                            
         BNE   OINDATWX                                                         
*                                                                               
*        FLAG BUY IF FORMAT OPTION IN EFFECT                                    
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFWBF)),0                
*                                                                               
         OC    8(4,R1),8(R1)       SKIP IF OPTION NOT IN EFFECT                 
         BZ    OINDATWX                                                         
*                                                                               
         MVC   0(1,R6),4(R2)       FLAG BUY                                     
         LA    R6,2(R6)                                                         
*                                                                               
OINDATWX DS    0H                                                               
*                                                                               
         CLI   5(R2),C'M'      IF MONTHLY FORMAT                                
         BNE   OINDATMN                                                         
*                                                                               
         LHI   R0,6                DEFAULT TO MMM/YY                            
*                                                                               
         CLI   PBQDTTYP,0          IF SPECIAL DATE FORMAT                       
         BE    OINDATM1                                                         
*                                                                               
         IC    R0,PBQDTTYP            USE IT                                    
*                                                                               
         CLI   PBQDTTYP,X'2A'      IF MM/DD/YY DATE FORMAT                      
         BNE   *+8                                                              
         MVI   2(R2),1                FORCE FIRST OF THE MONTH                  
*                                                                               
OINDATM1 DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),((R0),0(R6))   JUST MMM/YY                 
*                                                                               
         CLI   PBQDTTYP,X'2A'      IF MM/DD/YY                                  
         BNE   OINDATM2                                                         
*                                                                               
         MVC   3(2,R6),6(R6)          SHIFT YEAR OVER DAYS                      
         MVC   5(3,R6),SPACES         CLEAR LEFTOVERS                           
         LA    R6,5(R6)               BUMP TO NEXT PRINT IN AREA                
*                                                                               
         B     OINDATDX                                                         
*                                                                               
OINDATM2 DS    0H                                                               
*                                                                               
         MVC   6(2,R6),SPACES      BECAUSE MOST DATES ARE 8 LONG                
         LA    R6,6(R6)                                                         
*                                                                               
         B     OINDATDX                                                         
*                                                                               
OINDATMN DS    0H                  PRINT COMPLETE DATE                          
*                                                                               
         LHI   R0,5                DEFAULT TO MMMDD/YY                          
*                                                                               
         CLI   PBQDTTYP,0          IF SPECIAL DATE FORMAT                       
         BE    *+20                                                             
         IC    R0,PBQDTTYP            USE IT                                    
         CLI   2(R2),0                MAKE SURE THERE IS A DAY                  
         BNE   *+8                                                              
         MVI   2(R2),1                                                          
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),((R0),0(R6))   INSERTION DATE              
*                                                                               
         LA    R6,8(R6)            BUMP TO NEXT PRINT POSITION                  
*                                                                               
OINDATDX DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'M'       IF YEAR TO BE DROPPED                        
         BNE   *+14                                                             
         AHI   R6,-3                  BACK UP TO START OF YEAR                  
         MVC   0(3,R6),SPACES         ERASE YEAR                                
*                                                                               
         CLI   3(R2),1             DEFAULT IS LINE NUMBER 1                     
         BNH   OINDATLX                                                         
*                                                                               
         MVI   0(R6),C'-'          ELSE PRINT LINE NUMBER                       
*                                                                               
         EDIT  (1,3(R2)),(2,1(R6))                                              
         OI    1(R6),X'F0'          FORCE TO PRINT                              
*                                                                               
         CLI   3(R2),100           SKIP IF LINE NUMBER UNDER 100                
         BL    OINDATLX                                                         
*                                                                               
         ZIC   RF,3(R2)            LINE NUMBER                                  
         CVD   RF,DUB                                                           
         DP    DUB,=P'10'          MULTIPLE OF 10'S                             
         ZAP   DUB,DUB(6)                                                       
         SP    DUB,=P'10'                                                       
         CVB   RF,DUB                                                           
         LA    RF,ALPHATAB(RF)                                                  
         MVC   1(1,R6),1(RF)                                                    
*                                                                               
OINDATLX DS    0H                                                               
*                                                                               
         TM    PBQPOPT,PBQPOCUT    IF CUTTING TO ONE LINE                       
         BNO   OINDT2L1                                                         
*                                                                               
         OC    CODENNAM,SPACES        SKIP PRINTING SECOND LINE OF DATE         
*                                                                               
         GOTO1 SQUASHER,DMCB,CODENNAM,49                                        
*                                                                               
         ZIC   RF,MYOLEN                                                        
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),CODENNAM                                                 
*                                                                               
         B     OINDATEX                                                         
*                                                                               
OINDT2L1 DS    0H                                                               
*                                                                               
         MVC   199(13,R3),SPACES   CLEAR OLD DATA ON NEXT LINE                  
*                                                                               
         CLI   6(R2),X'FF'         SKIP IF NO ISSUE NAME                        
         BNE   OINDISNN                                                         
*                                                                               
         MVC   199+1(11,R3),7(R2)  PRINT ISSUE NAME                             
*                                                                               
         B     OINDISNX                                                         
*                                                                               
OINDISNN DS    0H                                                               
*                                                                               
         OC    6(3,R2),6(R2)       DONE IF NO SECOND DATE                       
         BZ    OINDATEX                                                         
*                                                                               
         MVI   199(R3),C'+'        SET INDICATOR ON NEXT LINE                   
*                                                                               
         CLI   5(R2),C'M'          IF MONTHLY INSDATE                           
         BNE   OINDT2L3                                                         
*                                                                               
         LA    R0,6                   DEFAULT TO MMM/YY                         
*                                                                               
         CLI   PBQDTTYP,0             IF SPECIAL OUTPUT DATE FORMAT             
         BE    OINDT2L2                  USE IT                                 
*                                                                               
         IC    R0,PBQDTTYP                                                      
*                                                                               
         CLM   R0,1,=X'2A'             IF MM/YY                                 
         BNE   *+8                                                              
         MVI   8(R2),1                   FORCE FIRST OF THE MONTH               
*                                                                               
OINDT2L2 DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(3,6(R2)),((R0),200(R3)) JUST MMM/YY                 
*                                                                               
         CLI   PBQDTTYP,X'2A'      IF MM/DD/YY                                  
         BNE   OINDATEX                                                         
*                                                                               
         MVC   203(2,R3),206(R3)      SHIFT YEAR OVER DAYS                      
         MVC   205(3,R3),SPACES         CLEAR LEFTOVERS                         
*                                                                               
         B     OINDATEX                                                         
*                                                                               
OINDT2L3 DS    0H                                                               
*                                                                               
         LA    R0,5                   DEFAULT TO MMMDD/YY                       
*                                                                               
         CLI   PBQDTTYP,0             IF SPECIAL OUTPUT DATE FORMAT             
         BE    *+8                                                              
         IC    R0,PBQDTTYP            USE IT                                    
*                                                                               
         GOTO1 DATCON,DMCB,(3,6(R2)),((R0),200(R3)) INSERTION DATE              
*                                                                               
OINDISNX DS    0H                                                               
*                                                                               
OINDATEX DS    0H                                                               
         XIT1                                                                   
*                                                                               
*                                                                               
*-------------->  CLOSE DATE ==================================                 
*                                                                               
OBCLOSE  OC    0(3,R2),0(R2)    ANY DATE PRESENT                                
         BZ    OBCLOSEX                                                         
*                                                                               
         LA    RF,GLARGS+15                                                     
*                                                                               
         BRAS  RE,DATES            PRINT DATES IF GROUPED BY MONTH ETC          
         BZ    OBCLOSEX            ROUTINE PRINTED DATES                        
*                                                                               
         CLI   2(R2),0          EFFECTIVE DATE DAY ZERO                         
         BE    OBCLOSEX         NO PRINTING                                     
*                                                                               
*        PRINT DATE AS IS                                                       
*                                                                               
         TM    PBQPOPT,PBQPOYYM    DATE IN YYMMDD FORMAT                        
         BNO   OBCLOS10                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),(X'20',0(R3))   START DATE                 
*                                                                               
         CLC   GLARGS+1(2),=C'ST'      CONTRACT START/END DATES                 
         BNE   OBCLOSEX                                                         
*                                                                               
         MVI   CODEAREA+6,C'-'                                                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,3(R2)),(X'20',7(R3))   END DATE                   
*                                                                               
         CLI   MYLTYP,C'H'                                                      
         BNE   OBCLOS07                                                         
*                                                                               
         MVC   LABLAREA(15),=C'CON ST/ND DATE '                                 
         MVI   CODEAREA,C'-'                                                    
         MVC   NAMEAREA(13),0(R3)                                               
*                                                                               
         GOTO1 GENOUTA                                                          
*                                                                               
OBCLOS07 DS    0H                                                               
*                                                                               
         B     OBCLOSEX                                                         
*                                                                               
OBCLOS10 DS    0H                                                               
*                                                                               
         LA    R0,5                DEFAULT TO MMMDD/YY FORMAT                   
*                                                                               
         CLI   PBQDTTYP,0          IF THERE IS A DATE TYPE OVERRIDE             
         BE    *+8                                                              
         IC    R0,PBQDTTYP            USE IT                                    
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),((R0),0(R3))   PRINT DATE                  
*                                                                               
         MVC   8(4,R3),SPACES                                                   
*                                                                               
         CLC   GLARGS+1(2),=C'ST'      CONTRACT START/END DATES    L24          
         BNE   OBCLOS17                                            L24          
*                                                                               
         MVI   8(R3),C'-'                                                       
*                                                                               
         GOTO1 DATCON,DMCB,(3,3(R2)),((R0),9(R3))   END DATE                    
*                                                                               
         CLI   MYLTYP,C'H'                                                      
         BNE   OBCLOS17                                                         
*                                                                               
         MVC   LABLAREA(15),=C'CON ST/ND DATE '                                 
         MVI   CODEAREA,C'-'                                                    
         MVC   NAMEAREA(17),0(R3)                                               
*                                                                               
         GOTO1 GENOUTA                                                          
*                                                                               
OBCLOS17 DS    0H                                                               
*                                                                               
OBCLOSEX DS    0H                                                               
         B     XIT                                                              
*                                                                               
*-------------->   BUY DESCRIPTION =============================                
*                                                                               
OBUYDSCR DS    0H                                                               
*                                                                               
         GOTO1 =A(OBUYDSC)         PUT OUT SPACE DESCRIPTION                    
*                                                                               
         BNE   GENOUT              ^= CC MEANS GO TO GENOUT                     
         B     XIT                                                              
*                                                                               
*-------------->  SPECIAL SPACE TOTALING======================                  
*                                                                               
SPACETOT DS    0H                                                               
         ICM   R6,15,PBT2PTR           ADDRESS OF SPACE                         
         BZ    XIT                                                              
         GOTO1 =A(COMMON1),DMCB,20,EBLOCK                                       
         B     XIT                                                              
*                                                                               
*-------------->    AGENCY OF RECORD INPUT =====================                
*                                                                               
IAORFLD  GOTO1 =A(COMMON2),DMCB,RTIAOR                             L27          
         B     XIT                                                              
*                                                                               
*                                                                               
*-------------->    AGENCY OF RECORD OUTPUT ====================                
*                                                                               
OAORFLD  GOTO1 =A(COMMON2),DMCB,RTOAOR                             L27          
         CHI   R1,32                                                            
         BE    OBCOMMON            DO NUMERIC                                   
         B     XIT                                                              
*                                                                               
*-------------->    DAILY BALANCE FIELDS OUPUT    ==============                
*                                                                               
ODBLDLRR DS    0H                                                               
         GOTO1 =A(ODBLDLR)                                                      
         B     OBCOMMON            DO NUMERIC                                   
*                                                                               
*-------------->    BILLING RECORD OUTPUT ====================                  
*                                                                               
OBILLFLD GOTO1 =A(COMMON2),DMCB,RTOBLL                             L27          
         B     XIT                                                              
*                                                                               
*        OUTDOOR SPACE DESCRIPTION SECOND LINE                                  
*                                                                               
         SPACE 2                                                                
OOUTSPC  DS    0H                                                               
*                                                                               
         MVC   OUTAREA,SPACES      INIT OUTPUT AREA                             
         MVC   LABLAREA(5),=C'SPACE' SET TITLE                                  
*                                                                               
         L     R1,GLADTENT         ESTABLISH OUTPUT DRIVER ENTRY                
         USING DROD,R1                                                          
*                                                                               
         LA    R6,17               OUTPUT LENGTH                                
*                                                                               
         BCTR  R6,0                DECREMENT FOR EXECUTE                        
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   NAMEAREA(0),0(R2)   MOVE TO OUTPUT                               
*                                                                               
OOUTSPCX DS    0H                                                               
         B     GENOUT                                                           
*                                                                               
         DROP  R1                                                               
*                                                                               
*                                                                               
*-------------->    PUB NAME AND NUMBER ========================                
*                                                                               
OBPUBNA  DS    0H                                                               
         GOTO1 =A(COMMON2),DMCB,RTOOPUBN                                        
         CHI   R1,32                                                            
         BE    GENOUT                                                           
         B     XIT                                                              
*        ========  *                                                            
NOREPORT DS    0H                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(6),=C'REPORT'                             L03           
*                                                                               
         GOTO1 =A(COMMON1),DMCB,48       TOTAL ROUTINES           L03           
*                                                                               
         B     XIT                                                L03           
*                                                                               
*-------------->   CONTRACT FREQUENCY =========================                 
*                                                                               
OBFREQ1  DS    0H                                                               
         MVC   0(13,R3),0(R2)      FREQUENCY TYPE                               
         B     XIT                                                              
*                                                                               
OPCOUNT  DS    0H                                                               
         OC    0(4,R2),0(R4)                                                    
         BZ    XIT                                                              
         EDIT (B4,0(R2)),(6,0(R3))                                              
         B     XIT                                                              
         EJECT                                                                  
*                                                                               
*-------------->         FORMAT PERIOD HEADLINE                                 
*                                                                               
HPER     DS    0H                                                               
         B     XIT                                                              
         SPACE 3                                                                
*                                                                               
*        INTERFACE TO SHARED OUTPUT ROUTINE                                     
*                                                                               
GENOUT   DS    0H                                                               
*                                                                               
         GOTO1 =A(GENOUTR)                                                      
*                                                                               
GNX      B     XIT                                                              
         EJECT                                                                  
*                                                                               
ALPHATAB DC    C' ABCDEFGHIJKLMNOP'   FOR LINE NUMBERS 100-250                  
*                                                                               
MYWORK   DS    F                                                                
COLLECT  DS    PL8'0'                                                           
COLLECTR DS    PL8'0'                                                           
ESTDATA  DS    CL12                                                             
ESTNAME  DS    CL(L'PESTNAME)                                                   
ESTBL1   DS    CL1                                                              
ESTNAME2 DS    CL(L'PESTNAM2)                                     L11           
ESTBL2   DS    CL1                                                              
ESTDATES DS    0CL12                                                            
ESTST    DS    CL6                                                              
ESTND    DS    CL6                                                              
ESTFILT  DS    CL3                                                              
ESTRSCH  DS    CL2                 RETAIL SCHEME                                
SPWORK   DS    CL17                                                             
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - T40509 - DATES'                                      
***********************************************************************         
*                                                                     *         
*        PRINT DATES                                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
DATES    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   0(RF),C'M'                                                       
         BE    DATESM                                                           
*                                                                               
         CLI   0(RF),C'Q'                                                       
         BE    DATESQ                                                           
*                                                                               
         CLI   0(RF),C'W'                                                       
         BE    DATESW                                                           
*                                                                               
         CLI   0(RF),C'Y'                                                       
         BE    DATESY                                                           
*                                                                               
         B     DATESNO             ROUTINE HAS NOTHING TO DO                    
*                                                                               
*        FORMAT FOR QUARTER DATES IS MMM-MMMYY                                  
*                                                                               
DATESQ   DS    0H                                                               
*                                                                               
*        PRINT FIRST MONTH OF QUARTER                                           
*                                                                               
         MVC   WORK(3),0(R2)       FILL IN FIRST DAY OF MONTH                   
         CLI   WORK+2,0               FOR DATCON                                
         BNE   *+8                                                              
         MVI   WORK+2,1                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,WORK),(4,0(R3))                                   
*                                                                               
         MVC   3(3,R3),=C'-  '                                                  
*                                                                               
         L     R1,PDADATES                                                      
         USING DATELSTD,R1                                                      
*                                                                               
*  LOOK UP QUARTER TABLE TO GET END DATE                                        
*                                                                               
         LA    RE,QURTLIST                                                      
         LA    RF,20                                                            
*                                                                               
DATQTRLP DS    0H                                                               
*                                                                               
         CLC   1(2,R2),1(RE)       MATCH ON MONTH AND DAY                       
         BE    DATQTRFD            END QUARTER                                  
*                                                                               
DATQTRCN DS    0H                                                               
*                                                                               
         LA    RE,6(RE)                                                         
         BCT   RF,DATQTRLP                                                      
*                                                                               
DATQTRDN DS    0H                  QUARTER NOT IN TABLE                         
*                                                                               
         DC    H'0'                FIND OUT WHAT IS WRONG                       
*                                                                               
         DROP  R1                                                               
*                                                                               
DATQTRFD DS    0H                                                               
*                                                                               
         MVC   WORK(3),0(R2)       COPY QUARTER START DATE                      
         MVC   WORK+1(2),4(RE)     FILL IN END OF QTR MONTH & DAY               
*                                                                               
         GOTO1 DATCON,DMCB,(3,WORK),(9,4(R3))                                   
*                                                                               
         B     DATESMX                                                          
*                                                                               
*        PRINT YEAR ONLY                                                        
*                                                                               
DATESY   DS    0H                                                               
*                                                                               
         LHI   R0,20               DEFAULT TO YYYYMMDD                          
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),((R0),WORK)                                
*                                                                               
         MVC   0(4,R3),WORK        JUST PRINT YEAR                              
*                                                                               
         B     DATESMX                                                          
*                                                                               
*        PRINT MONTH DATE                                                       
*                                                                               
DATESM   DS    0H                                                               
*                                                                               
         LHI   R0,9                DEFAULT TO MMM/YY OUTPUT                     
*                                                                               
         CLI   PBQDTTYP,0          IF SPECIAL DATE TYPE GIVEN                   
         BE    *+8                                                              
         IC    R0,PBQDTTYP            USE IT                                    
*                                                                               
         CLM   R0,1,=X'2A'         IF MM/DD/YY FORMAT                           
         BNE   *+8                                                              
         MVI   2(R2),1                FORCE FIRST OF THE MONTH                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),((R0),0(R3))                               
*                                                                               
         CLM   R0,1,=X'09'         IF MMM/YY CLEAR END OF OUTPUT                
         BNE   *+14                                                             
         MVC   6(4,R3),SPACES                                                   
         B     DATESMX                                                          
*                                                                               
         CLM   R0,1,=X'2A'         IF MM/DD/YY ELIMINATE DAY                    
         BNE   *+16                                                             
         MVC   3(2,R3),6(R3)          BY SHIFTING YY LEFT                       
         MVC   5(5,R3),SPACES         AND CLEARING GARBAGE                      
*                                                                               
DATESMX  DS    0H                                                               
*                                                                               
         TM    GLINDS,GLINTOTL     SKIP IF NOT A TOTAL ROUTINE                  
         BNO   DATESOK                                                          
*                                                                               
         L     R4,=A(ODBLADD)      POINT TO AVG DAYS TO DISBURSE                
         OC    0(8,R4),0(R4)       SKIP IF NOTHING PRESENT                      
         BZ    DATEADDX                                                         
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFADD))                  
*                                                                               
         OC    8(4,R1),8(R1)                                                    
         BZ    DATEADDX            AVG DAYS NOT WANTED                          
*                                                                               
         ZIC   R1,GLRECNO          PICK UP PRESENT RECORD NUMBER  L03           
         BCTR  R1,0                                               L03           
         SLL   R1,2                                               L03           
         LA    R1,GLAINTD(R1)      GET TO DETAILS FOR THIS REPORT L03           
*========              ========*                                                
         L     R1,0(R1)                                           L03           
         USING GLINTD,R1                                          L03           
*========              ========*                                                
         LH    R6,GLPDISP          NOW PICK UP PRINT DISPLACEMENT L03           
         A     R6,GLAINTP1         AND GET ACTUAL PRINT ADDRESS   L03           
*                                                                               
         DROP  R1                                                 L03           
*                                                                               
         LTR   R6,R6               NO PRINT POSITION GIVEN        L03           
         BZ    DATEADDX                                           L03           
*                                                                               
         LA    R6,1(R6)            BY PASS BOX LINE               L03           
*                                                                               
         LR    RF,R3                                                            
         SR    RF,R6               SPACE AVAILABLE FOR MESSAGE                  
         BP    *+12                                               L06           
         IC    RF,TOTROWID         DEFAULT TO NEXT LINE                         
         LA    R6,198(R6)                                                       
*                                                                               
         CH    RF,=Y(L'ODBLTXTS+4)  MINIMUM POSITIONS NEEDED                    
         BL    DATEADDX                                                         
*                                                                               
*        FIND A SPARE LINE FOR PRINTING                                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         LA    R0,4                CHECK MAX 4 LINES                            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R6),SPACES      LOOK FOR EMPTY LINE                          
         BNH   *+16                                                             
         LA    R6,198(R6)          BUMP TO NEXT LINE                            
         BCT   R0,*-22                                                          
         B     DATEADDX            NO ROOM LEFT                                 
*                                                                               
         CH    RF,=Y(L'ODBLTXTL-1+5)  IF ROOM FOR LONG TEXT                     
         BL    *+22                                                             
         L     R1,=A(ODBLTXTL)                                                  
         MVC   0(L'ODBLTXTL,R6),0(R1)       USE IT                              
         LA    RE,L'ODBLTXTL(R6)                                                
         B     *+18                                                             
         L     R1,=A(ODBLTXTS)                                                  
         MVC   0(L'ODBLTXTS,R6),0(R1)     ELSE USE SHORT TEXT                   
         LA    RE,L'ODBLTXTS(R6)                                                
*                                                                               
*        PRINT AVERAGE DAYS TO DISBURSEMENT                                     
*                                                                               
         XC    EBLOCK,EBLOCK       INIT EDIT BLOCK                              
*                                                                               
         ST    R4,EBAIN            PASS INPUT ADDRESS                           
         MVI   EBLIN,L'ODBLADD     INPUT LENGTH                                 
         MVI   EBTIN,C'P'          INPUT FORMAT IS PACKED                       
         MVI   EBFLOAT,C'-'        FLOAT MINUS SIGN                             
*                                                                               
         ST    RE,EBAOUT           OUTPUT ADDRESS                               
         MVI   EBLOUT,4            SET OUTPUT LENGTH                            
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK  PRINT AVG DAYS TO DISBURSE                 
*                                                                               
DATEADDX DS    0H                                                               
*                                                                               
         XC    0(8,R4),0(R4)       RESET DAYS FIELD                             
*                                                                               
         B     DATESOK                                                          
*                                                                               
*        PRINT WEEKLY DATE                                                      
*                                                                               
DATESW   DS    0H                                                               
*                                                                               
         TM    PBQPOPT,PBQPOYYM    DATE IN YYMMDD FORMAT                        
         BNO   DATESW10                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),(X'20',0(R3))   START DATE                 
*                                                                               
         CLC   GLARGS+1(2),=C'ST'      CONTRACT START/END DATES                 
         BNE   DATESWX                                                          
*                                                                               
         MVI   CODEAREA+6,C'-'                                                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,3(R2)),(X'20',7(R3))   END DATE                   
*                                                                               
         CLI   MYLTYP,C'H'                                                      
         BNE   DATESW07                                                         
*                                                                               
         MVC   LABLAREA(15),=C'CON ST/ND DATE '                                 
         MVI   CODEAREA,C'-'                                                    
         MVC   NAMEAREA(13),0(R3)                                               
*                                                                               
         GOTO1 GENOUTA                                                          
*                                                                               
DATESW07 DS    0H                                                               
*                                                                               
         B     DATESOK                                                          
*                                                                               
DATESW10 DS    0H                                                               
*                                                                               
         LA    R0,5                DEFAULT TO MMMDD/YY FORMAT                   
*                                                                               
         CLI   PBQDTTYP,0          IF THERE IS A DATE TYPE OVERRIDE             
         BE    *+8                                                              
         IC    R0,PBQDTTYP            USE IT                                    
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),((R0),0(R3))   PRINT DATE                  
*                                                                               
         MVC   8(4,R3),SPACES                                                   
*                                                                               
         CLC   GLARGS+1(2),=C'ST'      CONTRACT START/END DATES    L24          
         BNE   DATESW17                                            L24          
*                                                                               
         MVI   8(R3),C'-'                                                       
*                                                                               
         GOTO1 DATCON,DMCB,(3,3(R2)),((R0),9(R3))   END DATE                    
*                                                                               
         CLI   MYLTYP,C'H'                                                      
         BNE   DATESW17                                                         
*                                                                               
         MVC   LABLAREA(15),=C'CON ST/ND DATE '                                 
         MVI   CODEAREA,C'-'                                                    
         MVC   NAMEAREA(17),0(R3)                                               
*                                                                               
         GOTO1 GENOUTA                                                          
*                                                                               
DATESW17 DS    0H                                                               
*                                                                               
DATESWX  DS    0H                                                               
*                                                                               
DATESOK  DS    0H                  ROUTINE DID SOMETHING                        
*                                                                               
         CR    RB,RB               SET EQ CC                                    
*                                                                               
         B     DATESX                                                           
*                                                                               
DATESNO  DS    0H                  ROUTINE DID NOTHING                          
*                                                                               
         LTR   RB,RB               SET NEQ CC                                   
*                                                                               
DATESX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
*--------------> COST2 TO CLIENT ================================               
*                                                                               
GETCOS2  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   GLARGS+1,C'F'           DO  BILLING FORMULA         L26          
         JE    GETCOS2A                EVEN THOUGH DELETED         L26          
*                                                                               
         GOTOR =A(TSTDEL)                                                       
         JNO   *+10                IF BUY DELETED                               
         XC    PBGRS(PBUNITS-PBGRS),PBGRS         CLEAR ORDERED MONIES          
*                                                                               
GETCOS2A DS    0H                                                               
*                                                                               
* LOOK FOR BILLING OPTIONS IN THIS SEQUENCE                                     
*  1-FOR THIS EST                                                               
*  2-FOR THIS EST PRODUCT AAA                                                   
*  3-FOR THIS PRODUCT                                                           
*  4-FOR PRODUCT AAA                                                            
*  5-DEFAULT                                                                    
*                                                                               
* LOOK FOR THIS EST IN ESTIMATE TABLE  // EST / PRD AAA IN PBESTADR             
* PRODUCTS ARE IN PRODUCT TABLE                                                 
*                                                                               
         GOTOR =A(COMMON1),DMCB,RTOCOST2                                        
*                                                                               
         CLI   GLARGS+1,C'F'               BILLING FORMULA         L26          
         JE    YES                                                 L26          
*                                                                               
         J     NO                                                               
*                                                                               
         TITLE 'PRWRITER - IBPUBNAR'                                            
***********************************************************************         
*                                                                     *         
*        IBPUBNAR - PUB NAME AND NUMBER                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
IBPUBNAR NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RF,AIO1             POINT TO DETAIL RECORD                       
*                                                                               
         CLI   PBILKRCD-PBILLKEY(RF),PBILKIDQ SKIP IF A BILL HDR RECORD         
         BE    IBPUBNAX                                                         
*                                                                               
         CLI   GLARGS+2,C'L'       PUBLOCK?                                     
         BNE   *+14                NO                                           
         MVC   0(1,R2),PBPUBLOC    PUB LOCK (Y/N)                               
         B     IBPUBNAX            DONE                                         
*                                                                               
         MVC   6(20,R2),PBPUBNM       NAME  (WAS 4(20,R2)                       
*                                                                               
         CLI   GLARGS+1,C'N'       IF BASE NAME                                 
         BNE   IBPUBNA1                                                         
*                                                                               
         OC    PBPUB+4(2),PBPUB+4  IF BASEPUB                                   
         BNZ   *+20                                                             
         MVC   IBPUBBNO,PBPUB         SAVE BASE PUB NUMBER                      
         MVC   IBPUBBNM,PBPUBNM       SAVE NAME                                 
         B     IBPUBNAX                                                         
*                                                                               
         CLC   IBPUBBNO,PBPUB      IF BASE PUB THE SAME                         
         BNE   *+10                                                             
         MVC   6(20,R2),IBPUBBNM      RETURN BASE PUB'S NAME                    
*                                                                               
         B     IBPUBNAX                                                         
*                                                                               
IBPUBNA1 DS    0H                                                               
*                                                                               
         MVC   28(6,R2),PBPUB         TO BE EXPANDED ON OUTPUT                  
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+10                                                             
         MVC   28(6,R2),PAORPUB       USE AOR PUB NUMBER                        
*                                                                               
         CLI   GLARGS+2,C'Z'          ZONE TO BE INCLUDED                       
         BNE   IBPUBNA2                                                         
*                                                                               
         L     R6,AIO3             PUBADDRESS                                   
         USING PUBNAMD,R6                                                       
*                                                                               
         MVI   ELCODE,X'10'                                                     
         BRAS  RE,GETEL                                                         
         BNE   IBPUBNA2                                                         
*                                                                               
         MVC   34(20,R2),PUBZNAME    ZONE                                       
*                                                                               
         DROP  R6                                                               
*                                                                               
IBPUBNA2 DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCNV     IF PROCESSING NEW INVOICE RECORDS            
         BNE   IBPUBNA3                                                         
*                                                                               
         ICM   R6,15,PBIHDELA      ESTABLISH HEADER ELEMENT                     
         BZ    IBPUBNAA              NONE AVAILABLE                             
         USING PNVHDRD,R6                                                       
*                                                                               
         OC    PNVHPUB,PNVHPUB     IF WE HAVE A PUB NUMBER                      
         BZ    *+10                                                             
         MVC   28(6,R2),PNVHPUB       USE HEADER PUB NUMBER                     
*                                                                               
IBPUBNAA DS    0H                                                               
*                                                                               
         ICM   R6,15,PBIDTELA      ESTABLISH DETAIL ELEMENT                     
         BZ    IBPUBNAB               NONE AVAILABLE                            
         USING PNVDTLD,R6                                                       
*                                                                               
         OC    PNVDPUB,PNVDPUB     IF WE HAVE A PUB NUMBER                      
         BZ    *+10                                                             
         MVC   28(6,R2),PNVDPUB       USE DETAIL PUB NUMBER                     
*                                                                               
IBPUBNAB DS    0H                                                               
*                                                                               
IBPUBNA3 DS    0H                                                               
*                                                                               
IBPUBNAX DS    0H                                                               
         XIT1                                                                   
*                                                                               
IBPUBBNO DS    CL4                 BASEPUB NUMBER SAVEAREA                      
IBPUBBNM DS    CL20                BASEPUB NAME   SAVEAREA                      
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - IPUBNUMR'                                            
***********************************************************************         
*                                                                     *         
*        IPUBNUMR - PUB NUMBER                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
IPUBNUMR NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RF,AIO1             POINT TO DETAIL RECORD                       
         CLI   PBILKRCD-PBILLKEY(RF),PBILKIDQ SKIP IF A BILL HDR RECORD         
         BE    IPUBNUMX                                                         
*                                                                               
         MVC   0(6,R2),PBPUB   MOVE PUB, ZONE AND EDITION                       
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+10                                                             
         MVC   0(6,R2),PAORPUB        USE AOR PUB NUMBER                        
*                                                                               
         CLI   PBMODE,PBPROCNV     IF PROCESSING NEW INVOICE RECORDS            
         BNE   IPUBNUM3                                                         
*                                                                               
         ICM   R6,15,PBIHDELA      ESTABLISH HEADER ELEMENT                     
         BZ    IPUBNUMA              NONE AVAILABLE                             
         USING PNVHDRD,R6                                                       
*                                                                               
         OC    PNVHPUB,PNVHPUB     IF WE HAVE A PUB NUMBER                      
         BZ    *+10                                                             
         MVC   0(6,R2),PNVHPUB        USE HEADER PUB NUMBER                     
*                                                                               
IPUBNUMA DS    0H                                                               
*                                                                               
         ICM   R6,15,PBIDTELA      ESTABLISH DETAIL ELEMENT                     
         BZ    IPUBNUMB               NONE AVAILABLE                            
         USING PNVDTLD,R6                                                       
*                                                                               
         OC    PNVDPUB,PNVDPUB     IF WE HAVE A PUB NUMBER                      
         BZ    *+10                                                             
         MVC   0(6,R2),PNVDPUB        USE DETAIL PUB NUMBER                     
*                                                                               
IPUBNUMB DS    0H                                                               
*                                                                               
IPUBNUM3 DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'N'        PUB NUMBER ONLY                L18          
         BNE   *+14                                                L18          
         XC    4(2,R2),4(R2)       CLEAR  ZONE & EDITION           L18          
         B     IPUBNUMX                                            L18          
*                                                                               
         CLI   GLARGS+1,C'E'       CHECK IF EDITION CODE ONLY                   
         BE    IPUBEDN                                                          
*                                                                               
         CLI   GLARGS+1,C'S'        PUB NAME AS WELL                            
         BNE   *+8                                                              
         BRAS  RE,IBPUBNAR                                                      
         B     IPUBNUMX                                            L18          
*                                                                               
*        EDITION CODE ONLY WANTED                                               
*                                                                               
IPUBEDN  DS    0H                                                               
*                                                                               
         MVC   IPUBEDCD,5(R2)      SAVE EDITION INTERNAL CODE                   
         XC    0(6,R2),0(R2)       CLEAR PUB CODE FROM OUTPUT                   
*                                                                               
         CLI   IPUBEDCD,0          DONE IF NO EDITION                           
         BE    IPUBEDNX                                                         
*                                                                               
         L     RF,=A(EDTAB)        POINT TO EDITION TRANSLATE TABLE             
*                                                                               
IPUBEDLP DS    0H                                                               
*                                                                               
         CLC   IPUBEDCD,0(RF)      FIND INTENAL CODE IN TABLE                   
         BE    IPUBEDFD            FOUND                                        
*                                                                               
         BL    IPUBEDDN            NOT IN TABLE                                 
*                                                                               
IPUBEDCN DS    0H                                                               
*                                                                               
         LA    RF,4(RF)            BUMP TO NEXT TABLE ENTRY                     
         B     IPUBEDLP                                                         
*                                                                               
IPUBEDFD DS    0H                                                               
*                                                                               
         MVC   0(3,R2),1(RF)       RETURN EDITION CODE                          
*                                                                               
IPUBEDDN DS    0H                                                               
*                                                                               
IPUBEDNX DS    0H                                                               
*                                                                               
IPUBNUMX DS    0H                                                               
*                                                                               
         XIT1                                                      L20          
*                                                                               
IPUBEDCD DS    XL1                 EDITION CODE                                 
*                                                                               
         TITLE 'PRWRITER - PGEFORM'                                             
***********************************************************************         
*                                                                     *         
*        PGEFOEM - HANDLE PAGE NUMBER RESETTING                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PGEFORM  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        CHECKS IF THIS KEYWORD CHECKED BEFORE                                  
*        IF NOT IT CREATES ENTRY IN TABLE                                       
*                                                                               
*        FIND ENTRY FOR KEYWORD IN LOCAL KEYWORD TABLE                          
*                                                                               
         LA    R4,PGETAB           POINT TO START OF KEYWORD TABLE              
         USING PGETAB,R4                                                        
*                                                                               
         LA    R0,PGETAB#Q         MAX NUMBER OF ENTRIES IN TABLE               
*                                                                               
PGEFKYLP DS    0H                                                               
*                                                                               
         CLI   PGEKEY#,0           IF EOT BUILD NEW ENTRY                       
         BE    PGEFKYNW                                                         
*                                                                               
         CLC   PGEKEY#,GLARGS+6    ELSE MATCH KEYWORD NUMBER                    
         BE    PGEFKYFD                                                         
*                                                                               
PGEFKYCN DS    0H                                                               
*                                                                               
         LA    R4,PGETABL(R4)    POINT TO NEXT ENTRY                            
         BCT   R0,PGEFKYLP                                                      
*                                                                               
         B     PGEFORMX            NO ROOM IN TABLE - SKIP KEYWORD              
*                                                                               
PGEFKYNW DS    0H                                                               
*                                                                               
*        BUILD ENTRY IN TABLE FOR NEW KEYWORD                                   
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,GLARGS+6       GET KEYWORD NUMBER                           
         BZ    PGEFORMX            NONE - SKIP KEYWORD                          
*                                                                               
         STC   RF,PGEKEY#          SAVE KEYWORD #                               
*                                                                               
         L     R1,GLADTENT         POINT TO DRIVE TABLE ENTRY                   
         USING DROD,R1             ESTABLISH AS OUTPUT ELEMENT                  
*                                                                               
         ICM   R1,15,DROIADD       POINT TO INPUT CHARACTERISTICS               
         USING DRIND,R1            ESTABLISH AS INPUT ELEMENT                   
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,DRINLEN        OUTPUT LENGTH                                
         BZ    PGEFORMX            SKIP IF NO DATA                              
*                                                                               
         CHI   RF,L'PGEDATA        MAKE SURE DATA NOT TOO LONG                  
         BNH   *+8                                                              
         LA    RF,L'PGEDATA                                                     
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PGEDATA(0),0(R2)    ADD DATA TO TABLE                            
         B     PGEFSET             ASSUME NEW VALUE FOR VARIABLE                
*                                                                               
PGEFKYFD DS    0H                  VARIABLE IN TABLE                            
*                                                                               
         L     R1,GLADTENT         POINT TO DRIVE TABLE ENTRY                   
         USING DROD,R1             ESTABLISH AS OUTPUT ELEMENT                  
*                                                                               
         ICM   R1,15,DROIADD       POINT TO INPUT CHARACTERISTICS               
         USING DRIND,R1            ESTABLISH AS INPUT ELEMENT                   
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,DRINLEN        OUTPUT LENGTH                                
         BZ    PGEFORMX            SKIP IF NO DATA                              
*                                                                               
         CHI   RF,L'PGEDATA        MAKE SURE DATA NOT TOO LONG                  
         BNH   *+8                                                              
         LA    RF,L'PGEDATA                                                     
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   PGEDATA(0),0(R2)    CHECK IF VARIABLE CHANGING                   
         BE    PGEFORMX            NO - DON'T RESET PAGE                        
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   PGEDATA(0),0(R2)    SAVE NEW VALUE OF VARIABLE                   
*                                                                               
PGEFSET  DS    0H                                                               
*                                                                               
         MVC   PAGE,=AL2(1)        RESET PAGE COUNTER                           
         MVI   FORCEHED,C'Y'       FORCE NEW PAGE                               
*                                                                               
PGEFORMX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
*                                                                               
*        TABLE FOR PAGE FORMATTING VARIABLES                                    
*                                                                               
         DS    0D                  ALIGNMENT                                    
PGETAB   DS    0X                  KEYWORD INFO TABLE                           
PGEKEY#  DS    XL1                 KEYWORD NUMBER                               
PGEDATA  DS    XL20                CURRENT VALUE FOR VARIABLE                   
PGETABL  EQU   *-PGETAB            LENGTH OF TABLE ENTRY                        
*                                                                               
         DS    XL((PGETAB#Q-1)*PGETABL) REPEAT OF PREVIOUS TO FORM TAB          
*                                                                               
PGETAB#Q EQU   12                  MAX NUMBER OF UCOMM KYWDS ALLOWED            
*                                                                               
         DROP  R1,R4                                                            
*                                                                               
         EJECT                                                                  
*                                                                               
* CURRENT HEADLINE SUBROUTINE                                                   
*                                                                               
CURRHEAD NMOD1 0,**#CHD                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     RF,AIO2                                                          
         A     RF,SIZEIO                                                        
         AHI   RF,-50                                                           
         CLI   GLARGS,C'1'                                                      
         BE    *+8                                                              
         AHI   RF,25                                                            
         MVC   6(2,R3),=C'**'                                                   
         MVC   30(2,R3),=C'**'                                                  
         MVC  10(20,R3),0(RF)                                                   
         MVC   198(32,R3),=C'CURRENT -  NEXT LEVEL - RATE EFF'                  
         MVC   396(32,R3),=C' RATE   -    RATE     -   DATE  '                  
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
*-------------->      RESOLVE ROUTINE ADDRESSES                                 
*                                                                               
RESOLVER NMOD1 0,**RSLVER                                                       
*                                                                               
*  INSTALL TODAY'S DATE IF NO VALUE IS IN PBBTODAY                              
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     RF,=A(GENOUTR)      SET GENOUT ROUTINE ADDRESS                   
         ST    RF,GENOUTA                                                       
*                                                                               
         L     RF,=V(FNDFLTR)      SET FNDFLTR ROUTINE ADDRESS                  
         ST    RF,FNDFLTRA                                                      
*                                                                               
         L     RF,=A(BLDLBL)       SET BLDLBL ROUTINE ADDRESS                   
         ST    RF,BLDLBLA                                                       
*                                                                               
         OC    PBBTODAY,PBBTODAY                                                
         BNZ   SR1000                                                           
*                                                                               
         L     R1,PBCOMFAC                                                      
         L     RF,DATCON                                                        
*                                                                               
         GOTO1 (RF),DMCB,(4,RCDATE),(3,PBBTODAY)                                
*                                                                               
SR1000   DS    0H                                                               
*                                                                               
*        INIT DDVAL PARAMETERS                                                  
*                                                                               
         XC    VLBLOCK(VLBLOCKL),VLBLOCK CLEAR BLOCK                            
*                                                                               
         MVC   VLACFACS,PBCOMFAC   A(COMFACS)                                   
         MVC   VLCTRY,CTRY         SET COUNTRY CODE                             
         MVC   VLLANG,LANG         LANGUAGE CODE                                
         MVC   VLAGENCY,AGENCY     AGENCY                                       
         MVI   VLSYSTEM,VLSYSPRQ   PRINT SYSTEM                                 
*                                                                               
         GOTO1 (RF),DMCB,(4,RCDATE),(2,VLTODAYC)                                
*                                                                               
         L     R1,=A(ROUTLIST)                                                  
SR10     CLI   0(R1),FF                                                         
         BE    SRX                                                              
         CLC   0(8,R1),GLLABEL                                                  
         BE    SR20                                                             
         LA    R1,16(R1)                                                        
         B     SR10                                                             
*                                                                               
SR20     MVC   GLAROUT,8(R1)       RETURN ADDRESS                               
         OC    DATAIND,12(R1)                                                   
         OC    PBQSPLOP,13(R1)     SECOND BYTE OF OPTIONS                       
*                                                                               
         CLC   GLLABEL,=CL8'IDOLLAR'  CHECK FOR MONEY FIELDS                    
         BE    *+10                                                             
         CLC   GLLABEL,=CL8'ICLRDLR'  CHECK FOR MONEY FIELDS                    
         BE    *+10                                                             
         CLC   GLLABEL,=CL8'IBLD   '  CHECK FOR MONEY FIELDS                    
         BE    *+10                                                             
         CLC   GLLABEL,=CL8'ICLR   '  CHECK FOR MONEY FIELDS                    
         BNE   SR30                                                             
*                                                                               
         CLI   GLARGS+1,C'L'       BILLABLE FIELD                               
         BE    *+8                                                              
         CLI   GLARGS+1,C'4'       BILLABLE FIELD                               
         BNE   *+8                                                              
         OI    PBQSPLOP,PBQIDELB   INCLUDE DELETED BUYS                         
*                                                                               
         CLI   GLARGS+1,C'B'       BILLED   FIELD                               
         BE    *+8                                                              
         CLI   GLARGS+1,C'2'       BILLED   FIELD                               
         BNE   *+8                                                              
         OI    PBQSPLOP,PBQIDELD   INCLUDE DELETED BUYS                         
*                                                                               
         CLI   GLARGS+1,C'P'       PAID     FIELD                               
         BNE   *+8                                                              
         OI    PBQSPLOP,PBQIDELC   INCLUDE DELETED BUYS                         
*                                                                               
         CLI   GLARGS+1,C'Q'       PAYABLE  FIELD                               
         BNE   *+8                                                              
         OI    PBQSPLOP,PBQIDELA   INCLUDE DELETED BUYS                         
*                                                                               
SR30     DS    0H                                                               
*                                                                               
SRX      DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         EJECT                                                                  
*                                                                               
*              CUME ROUTINES                                                    
*                                                                               
         USING DROD,RF                                                          
*        ===== *                                                                
CLEARCUM NMOD1 0,**CLRCUM                                                       
*                                                                               
         XC    CUMEBIN,CUMEBIN                                                  
         ZAP   CUMEPACK,=P'0'                                                   
         XIT1                                                                   
*                                                                               
POSTCUM  NMOD1 0,**POST                                                         
*                                                                               
         L     RF,GLADTENT                                                      
*                                                                               
         TM    DROFORM,X'01'       MUST BE SET TO CUME                          
         BNO   POSTCUMX                                                         
*                                                                               
         ICM   R1,15,DROIADD                                                    
         USING DRIND,R1                                                         
*                                                                               
         CLI   DRINTYPE,C'B'                                                    
         BE    POSTBIN                                                          
*                                                                               
         DROP  RF                                                               
*                                                                               
         ZIC   RF,DRINFLEN          FIELD LENGTH                                
         BCTR  RF,0                                                             
         LR    R4,R2                                                            
*                                                                               
         CLI   DRINTYPE,C'P'                                                    
         BE    POSTCUMP                                                         
*                                                                               
         CLI   DRINTYPE,C'M'       MASK TYPE (PACKED)                           
         BNE   POSTCUMX                                                         
*                                                                               
         BCTR  RF,0                REDUCE LENGTH                                
         LA    R4,1(R4)            BYPASS MASK                                  
         B     POSTCUMP                                                         
*                                                                               
         DROP  R1                                                               
**                                                                              
POSTBIN  L     R1,CUMEBIN                                                       
         A     R1,0(R2)                                                         
         ST    R1,CUMEBIN                                                       
         ST    R1,0(R2)                                                         
         B     POSTCUMX                                                         
*                                                                               
POSTCUMP EX    RF,*+8                                                           
         B     *+10                                                             
         AP    CUMEPACK,0(0,R4)                                                 
*                                                                               
         SLL   RF,4                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R4),CUMEPACK                                                 
*                                                                               
POSTCUMX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
CUMEBIN  DC    F'0'                                                             
CUMEPACK DC    PL8'0'                                                           
*                                                                               
         LTORG                                                                  
*                                                                               
          TITLE 'FIND CAPTION OR COPY IN COMMENT'                               
*                                                                               
*-------------->  FIND CAPTION OR COPY IN COMMENT                               
*                                                                               
*  DETERMINE IF THERE ARE CAPTION OR COPY OVERRIDES IN THE BUY PGM.             
*    IF SO, PASS THEM IN MSGAREA .. IF NOT READ CAPTION OR COPY                 
*         RECORD AND PASS THAT                                                  
*                                                                               
         DS    0D                                                               
COMCAPT  NMOD1 200,COMCAPT                                                      
         SPACE 2                                                                
******                                                                          
*========              ========*                                                
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
*========              ========*                                                
         LR    R7,RC               SAVE WORKING STORAGE POINTER                 
*                                                                               
         L     RC,GLAWORKD     INITIALIZE RC                                    
*                                                                               
         XC    MSGAREA,MSGAREA                                                  
         MVC   FUNCTN,0(R1)      SAVE INDICATOR                                 
         MVC   COMPOPT,COPYEQ    ASSUME COPY MOVE EXECUTE LENGTH                
         CLI   FUNCTN,C'C'       MAX LENGTH OF MOVE AND CONSTANT                
         BE    *+10                                                             
         MVC   COMPOPT,CAPTEQ                                                   
*                                                                               
*  IF SECOND PARAMETER HAS A VALUE, IT IS THE DISK ADDRESS OF RECORD            
*                                                                               
         ICM   RF,15,4(R1)         POSSIBLE DISK ADDRESS           L29          
         BZ    NODADDR                                             L29          
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY+27(4),0(RF)                                     L29          
*                                                                               
         MVI   PAOSESAV,0          INIT CURRENT SE SAVEAREA                     
*                                                                               
         CLI   4(RF),0             IF SE NUMBER GIVEN                           
         BE    COMCAPT1                                                         
*                                                                               
         ICM   RE,15,PBUTLA        AND UTL ADDR GIVEN                           
         BZ    *+16                                                             
         MVC   PAOSESAV,4(RE)      SAVE CURRENT SE NUMBER                       
         MVC   4(1,RE),4(RF)       SET SE NUMBER                                
*                                                                               
COMCAPT1 DS    0H                                                               
*========              ========*                                                
         USING PJOBRECD,R4                                                      
*========              ========*                                                
*                                                                               
*        L     R4,AIO3                                                          
*        AHI   R4,3000                                                          
         LR    R4,R7               POINT TO WORKAREA                            
         ST    R4,AIO                                                           
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         MVC   MSGAREA(25),PJOBCAP1                                             
         MVC   MSGAREA+25(25),PJOBCAP2                                          
*                                                                               
         CLI   PAOSESAV,0          IF SE NUMBER SAVED                           
         BE    COMCAPT2                                                         
*                                                                               
         ICM   RE,15,PBUTLA        AND IF UTL ADDR GIVEN                        
         BZ    *+10                                                             
         MVC   4(1,RE),PAOSESAV    RESTORE CURRENT SE NUMBER                    
*                                                                               
COMCAPT2 DS    0H                                                               
*                                                                               
         B     DP09CC                                              L29          
*                                                                               
*  PREPARE TO READ COMMENT ELEMENTS                                             
*                                                                               
*========                                                                       
*========              ========*                                                
NODADDR  L     R2,AIO1                                                          
         USING PBUYRECD,R2                                                      
*========              ========*                                                
         LA    R2,PBUYREC+33                                                    
         MVI   ELCODE,X'66'      COMMENT ELEMENT ID                             
COMLOOP  BAS   RE,LUUPCOMM                                                      
         BNE   NOMORE66                                                         
         ZIC   RE,COMPOPT         INSERT LENGTH -1                              
         EX    RE,*+8             CHECK FOR CAP= OR COPY=                       
         B     *+10                                                             
         CLC   2(0,R2),COMPOPT+2                                                
         BNE   COMLOOP            HIT ON CAP= OR COPY=                          
         LR    R1,R2              SAVE ELEMENT ADDRESS                          
         LA    R1,3(RE,R1)   PUSH PAST EL LEN,ID AND LEN OF COMPARE16           
         ZIC   RF,1(R2)      LENGTH OF ELEMENT                                  
         AHI   RF,-4         REDUCE BY EL ID, LEN AND FOR EXECUTE               
         SR    RF,RE         SHOULD CONTAIN LENGTH OF COMMENT                   
         ZIC   RE,COMPOPT+1  LIMIT ON MOVE                                      
         CR    RE,RF                                                            
         BH    *+6                                                              
         LR    RF,RE         USE MAX LIMIT                                      
         LTR   RF,RF         ENSURE POSITIVE                                    
         BNM   *+6           B ON NOT MINUS                                     
         LR    RF,RE                                                            
         LA    RE,MSGAREA                                                       
         CLI   COMPOPT,3     CAN HAVE MORE THAN 1 CAPTION                       
         BNE   JUSTCOPY                                                         
         OC    0(8,RE),0(RE) WAS A CAPTION MOVED IN ALREADY                     
         BZ    *+8                                                              
         LA    RE,25(RE)                                                        
JUSTCOPY EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R1)                                                    
         B     COMLOOP        FORCE TO END OF COMMENTS                          
NOMORE66 DS    0H                                                               
         OC    MSGAREA,MSGAREA                                                  
         BNZ   DP09CC                                                           
*                                                                               
*   MUST READ APPROPIATE RECORD // NO OVERRIDES                                 
*                                                                               
         L     R2,AIO1             ADDRESS OF BUY                               
         XC    KEY,KEY                                                          
         MVC   KEY(2),PBUYKAGY                                                  
         MVC   KEY+2(1),PBUYKMED   FOR QMEDIA=C                                 
         MVI   KEY+3,X'15'                                                      
         MVC   KEY+4(3),PBUYKCLT                                                
         MVC   KEY+7(3),PBUYKPRD                                                
* THIS MAY BE A PASSIVE PRODUCT// IF SO USE ZZZ FOR KEY           BUG07         
         OC    PBUYKACT,PBUYKACT                                  BUG07         
         BZ    *+10 ??????????????????????????????????????????????BUG07         
         MVC   KEY+7(3),PBUYKACT     MOVE ACTIVE PRODUCT          BUG07         
         MVC   KEY+10(6),PBDJOB                                                 
*========              ========*                                                
         USING PJOBRECD,R4                                                      
*        L     R4,AIO3                                                          
*========              ========*                                                
*        AHI   R4,3000                                                          
         LR    R4,R7               POINT TO WORKAREA                            
         ST    R4,AIO                                                           
         CLC   PJOBREC(17),KEY                                                  
         BNE   JOBREADD            HAVE JOB REC                                 
         MVC   KEY+27(4),PJCOMDT-4  SAVED ADDRESS                               
         B     DP09C               HAVE JOB REC                                 
* BUY-IO JOB DIR                                                                
JOBREADD GOTO1 HIGH                                                             
         CLC   KEY(17),KEYSAVE                                                  
         BE    GOFORJOB                                                         
         XC    MSGAREA,MSGAREA                                                  
         B     RSTREPTR                                                         
         DC    H'0'                JOB NOT ON FILE                              
* BUY-IO JOB REC                                                                
GOFORJOB GOTO1 GETREC                                                           
DP09C    DS    0H                                                               
*                                                                               
         MVC   PJCOMDT-4(4),KEY+27    SAVED ADDRESS                             
         CLI   FUNCTN,C'T'      CAPTION REQUESTED                               
         BNE   MBCOPY                                                           
         MVC   MSGAREA(25),PJOBCAP1                                             
         MVC   MSGAREA+25(25),PJOBCAP2                                          
         MVC   MSGAREA+50(4),KEY+27                                L29          
         B     RSTREPTR                                                         
*                                                                               
*                                                                               
MBCOPY   MVC   MSGAREA(17),PJOBCPY                                              
RSTREPTR MVC   KEY,IOKEYSVE      RESTORE POINTER                                
         OI    DMINBTS,8         PASS BACK DELETED RECORDS       BUG11          
         GOTO1 HIGH                                                             
*                                                                               
DP09CC   L     RE,4(RD)                                                         
         L     RE,24(RE)                                                        
         LA    RF,MSGAREA                                                       
         ST    RF,4(RE) GIVE CALLER ADDRESS OF MSGAREA                          
CAPTXIT  XMOD1 1                                                                
*                                                                               
LUUPCOMM ZIC   R0,1(R2)     LOAD ELEMENT LENGTH                                 
         AR    R2,R0        GET TO NEXT ELEMENT                                 
         CLI   0(R2),0      END OF RECORD                                       
         BE    NXXTL                                                            
         CLC   ELCODE,0(R2)                                                     
         BER   RE                                                               
         B     LUUPCOMM     CONTINUE                                            
NXXTL    LTR   RE,RE        FORCE CONDITION CODE TO BNE                         
         BR    RE                                                               
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
MSGAREA  DS    CL60                                                             
*                                                                               
COMPOPT  DS    CL7                                                              
*                                                                               
COPYEQ   DC    X'0416',C'COPY='  LEN OF COMPARE/ MOVE LIMIT                     
CAPTEQ   DC    X'0324',C'CAP= '  LEN OF COMPARE/ MOVE LIMIT                     
FF       EQU   X'FF'                                                            
FUNCTN   DS    CL1 CAPTION OR COMMENT                                           
         LTORG                                                                  
         DROP  R2                                                               
         EJECT                                                                  
*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++         
*  THE 13TH AND 14TH BYTE (+12/13) ARE USED TO GIVE THIS FIELD SPECIAL+         
*   CHARACTERISTICS.  +12 CONTENTS ARE MOVED INTO DATAIND AND +13 +             
*   MOVED TO PBQSPLOP.  THEY ARE NOW REFERENCEABLE. +                           
*  +12  BIT CONFIGURATION IS DEFINED BELOW +                                    
*    X'80' (DIEST) JWT +                                                        
*    X'40' (DICLT)         NEED CLIENT RECORD IN CORE +                         
*    X'20' (DIPRD)         NEED PRODUCT RECORD IN CORE +                        
*    X'10' (DIESTREC)      NEED EST IN CORE +                                   
*    X'01' (DPROFDEF)      NEED EST AND PROD DEFAULT PROFILE +                  
*    X'02' (DIREPB)        NEED REP TABLE                                       
*    X'04' (DIPUBLSH)      NEED PUBLISHER IN CORE                               
*    X'08' (DIAPRREC)      NEED AGENCY OF RECORD IN CORE           L27          
*  +13 BIT CONFIGURATION +                                                      
*    X'80' (PBQCONTR)      CONTRACT RULES (READ BUYS BY CONTRACT) +             
*    X'40' (PBQIDELA) THESE FIELDS MAY INCLUDE DELETED BUYS PAYABLE             
*    X'20' (PBQIDELB) DELETED BUYS // BILLABLE                        +         
*    X'10' (PBQIDELC) DELETED BUYS // PAID                            +         
*    X'08' (PBQIDELD) DELETED BUYS // BILLED                          +         
*    X'04' (PBQCLRQS)  CLIENT REQUESTED AS ROW/HEAD                             
*    X'02' (PBQPBRQS)  PUB REQUESTED AS ROW/HEAD                                
*++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++         
*                                                                               
ROUTLIST DS    0D                  ROUTINE ADDRESS LIST                         
*                                                                               
         DC    C'I$COMBO '                   COMBINATION BUY DOLLARS            
         DC    V(I$COMBO),AL1(0,0,0,0)   PRWRIDLR                               
*                                                                               
         DC    C'IAADT   '         ACTIVITY DATE FOR CLEARANCE DATA             
         DC    A(IAADT),AL4(0)                                                  
*                                                                               
         DC    C'IACH    '         ADDITIONAL CHARGES                           
         DC    A(IACH),AL4(0)                                                   
         DC    C'OACH    '                                                      
         DC    A(OACH),AL4(0)                                                   
*                                                                               
         DC    C'IACH    '         ADDITIONAL CHARGES                           
         DC    A(IACH),AL4(0)                                                   
         DC    C'OACH    '                                                      
         DC    A(OACH),AL4(0)                                                   
*                                                                               
         DC    C'IACTIVE '                   ACTIVITY INDICATOR                 
         DC    A(IACTIVE),AL1(0,0,0,0)                                          
*                                                                               
         DC    C'IADFLTR '                   AD FILTER                          
         DC    A(IADFLTR),AL1(0,0,0,0)                                          
*                                                                               
         DC    C'IADRREP '                   ADDRESS/REP                        
         DC    V(IADRREP),AL1(DIREPB,0,0,0)                                     
*                                                                               
         DC    C'IAGY    '                   AGENCY ENTRIES                     
         DC    A(IAGY),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IASPNO  ',A(IASPNO),AL1(DIESTREC,0,0,0) ASPNO                  
*                                                                               
         DC    C'IAORFLD '         AOR RECORD FIELDS                            
         DC    A(IAORFLD),AL1(DIAORREC,0,0,0)         L27                       
*                                                                               
         DC    C'IAORELM '         DATA FROM AOR RECORD                         
         DC    V(IELM),AL1(DIAORREC,0,0,0)   PRWRIELM                           
*                                                                               
         DC    C'IPRDELM '         DATA FROM PRODUCT RECORD                     
         DC    V(IELM),AL1(DIPRD,0,0,0)   PRWRIELM                              
*                                                                               
         DC    C'IB      '                                                      
         DC    A(IB),AL4(0)                                                     
*                                                                               
         DC    C'IBILLU  '         BILL RECORD FIELD                            
         DC    A(IBILLU),AL4(0)                                                 
*                                                                               
         DC    C'IBLD    '         BILL ELEMENT FIELDS - INPUT                  
         DC    A(IBLD),AL4(0)                                                   
         DC    C'OBLD    '         BILL ELEMENT FIELDS - OUTPUT                 
         DC    A(OBLD),AL4(0)                                                   
*                                                                               
         DC    C'IBNV    '         NEW INVOICE BUY KEYWORDS                     
         DC    A(IBNV),AL4(0)                                                   
         DC    C'OBNV    '                                                      
         DC    A(OBNV),AL4(0)                                                   
*                                                                               
         DC    C'IBRATE  '         BUY RATE KEYWORDS                            
         DC    A(IBRATE),AL4(0)                                                 
*                                                                               
         DC    C'IBRTTYPE'         BUY RATE TYPE                                
         DC    A(IBRTTY),AL4(0)                                                 
*                                                                               
         DC    C'IBUYDSCR'         BUY SPACE DESCRIPTION                        
         DC    A(IBUYDSC),AL4(0)                                                
*                                                                               
         DC    C'ICHANGE '         CHANGES TO RECORD                            
         DC    A(ICHANGE),AL1(0,0,0,0)                                          
*                                                                               
         DC    C'ICC     '         CUSTOM COLUMN                                
         DC    A(ICC),AL1(0,0,0,0)                                              
         DC    C'OCC     '                                                      
         DC    A(OCC),AL1(0,0,0,0)                                              
*                                                                               
         DC    C'ICLIVEND'                                                      
         DC    A(ICLIVEND),AL4(0)                                               
*                                                                               
         DC    C'ICLI    '         CLIENT HEADER FIELDS                         
         DC    A(ICLI),AL4(0)                                                   
*                                                                               
         DC    C'OCLI    '         CLIENT HEADER FIELDS                         
         DC    A(OCLI),AL4(0)                                                   
*                                                                               
         DC    C'ICLR    '         CLEARANCE STATUS RECORD FIELDS               
         DC    A(ICLR),AL4(0)                                                   
*                                                                               
         DC    C'ICLRDLR '         CLEARED MONEY FIELDS                         
         DC    A(ICLRDLR),AL4(0)                                                
*                                                                               
         DC    C'OCMAX   '         MAX INSERTS PER ISSUE                        
         DC    A(OCMAX),AL4(0)                                                  
*                                                                               
         DC    C'ICOMM   '         COMMENTS - GENERALIZED                       
         DC    A(ICOMM),AL1(0,PBQCONTR,0,0)                                     
         DC    C'OCOMM   '                                                      
         DC    A(OCOMM),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'ICONDA  '         CONTRACT DISK ADDRESS INPUT                  
         DC    A(ICONDA),AL1(0,0,0,0)                                           
*                                                                               
         DC    C'ICONUNAC'         CONTRACT UNIT AND BUY ACTIVITY               
         DC    A(ICONUNAC),AL1(00,PBQCONTR,00,00)                               
*                                                                               
         DC    C'ICPM    '         COST PER THOUSAND                            
         DC    A(ICPM),AL4(0)                                                   
         DC    C'OCPM    '         COST PER THOUSAND                            
         DC    A(OCPM),AL4(0)                                                   
*                                                                               
         DC    C'ICRC    '         CIRCULATION DATA                             
         DC    V(ICRC),AL4(0)             PRWRICRC                              
*                                                                               
         DC    C'ICSH    '         CASH APPLIED DATA                            
         DC    A(ICSH),AL4(0)                                                   
*                                                                               
         DC    C'IDATA   '                   INPUT IS A CONSTANT                
         DC    A(IDATA),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'ODATA   '                   OUTPUT EQUALS INPUT                
         DC    A(ODATA),AL1(0,0,0,0)         WITH POSSIBLE LABEL                
*                                                                               
         DC    C'ODATE   '                   OUTPUT IS A DATE                   
         DC    A(ODATE),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'IDBLDLR '         DAILY BALANCE MONEY FIELDS                   
         DC    A(IDBLDLR),AL4(0)   INPUT                                        
         DC    C'ODBLDLR '         DAILY BALANCE MONEY FIELDS                   
         DC    A(ODBLDLRR),AL4(0)  OUTPUT                                       
*                                                                               
         DC    C'IAGLDLR '         AGING BALANCE MONEY FIELDS                   
         DC    A(IAGLDLR),AL4(0)   INPUT                                        
         DC    C'OAGLDLR '         AGING BALANCE MONEY FIELDS                   
         DC    A(OAGLDLR),AL4(0)   OUTPUT                                       
*                                                                               
         DC    C'IDOLLAR '                   DOLLAR DATA FROM BUY               
         DC    V(IDOLLAR),AL1(0,0,0,0)  PRWRIDLR                                
*                                                                               
         DC    C'IEIO    '                   EIO DATA  FROM BUY                 
         DC    A(IEIO),AL1(0,0,0,0)                                             
         DC    C'OEIO    '                   EIO DATA  FROM BUY                 
         DC    A(OEIO),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IELM    '                   FIELD GIVEN BY DISP                
         DC    V(IELM),AL1(0,0,0,0)          IN ELEMENT AND LENGTH              
*                                       PRWRIELM                                
*                                                                               
         DC    C'IESTBGT '                   ESTIMATE BUDGET DOLLARS            
         DC    V(IESTBGT),AL1(0,0,0,0)  PRWRIEST                                
*                                                                               
         DC    C'IESTBUF '                   ESTIMATE DATA FROM BUFFER          
         DC    V(IESTBUF),AL1(0,0,0,0)  PRWRIEST                                
*                                                                               
         DC    C'IESTPG  '                   PGESTIMATE DATA                    
         DC    V(IESTPG),AL1(0,0,0,0)   PRWRIEST                                
*                                                                               
         DC    C'IESTSCHM'                   ESTIMATE REQUEST SCHEME            
         DC    V(IESTSCHM),AL1(0,0,0,0) PRWRIEST                                
*                                                                               
         DC    C'IGRP    '                   GROUP CODES                        
         DC    A(IGRP),AL1(0,0,0,0)                                             
         DC    C'OGRP    '                                                      
         DC    A(OGRP),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IGP     '                   GROUP CODES - ALL                  
         DC    A(IGP),AL1(0,0,0,0)                                              
*                                                                               
         DC    C'IHEX    '                   HEX OUTPUT                         
         DC    A(IHEX),AL1(0,0,0,0)                                             
         DC    C'OHEX    '                   HEX OUTPUT                         
         DC    A(OHEX),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IHIO    '                   INSERTION ORDER HISTORY            
         DC    A(IHIO),AL1(0,0,0,0)                                             
         DC    C'OHIO    '                                                      
         DC    A(OHIO),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IINV    '                   INVOICE RECORD FIELDS              
         DC    A(IINV),AL1(0,0,0,0)                                             
         DC    C'OINV    '                   INVOICE RECORD FIELDS              
         DC    A(OINV),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IINVDLR '                   INVOICE REC MONEY FIELDS           
         DC    V(IINVDLR),AL1(0,0,0,0)  PRWRIDLR                                
*                                                                               
         DC    C'IISSUE  '                   ISSUE RECORD FIELDS                
         DC    V(IISSUE),AL1(0,0,0,0)   PRWRIISS                                
         DC    C'OISSUE  '                                                      
         DC    V(OISSUE),AL1(0,0,0,0)   PRWRIISS                                
*                                                                               
         DC    C'IJOBREC '                   JOB RECORD DATA                    
         DC    V(IJOB),AL1(0,0,0,0)     PRWRIJOB                                
*                                                                               
         DC    C'ILAB    '                   LABATT'S SPECIALS                  
         DC    A(ILAB),AL1(0,0,0,0)                                             
         DC    C'OLAB    '                                                      
         DC    A(OLAB),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'OLCOUNT '              LINT COUNTER                            
         DC    A(OLCOUNT),AL1(0,0,0,0)                                          
*                                                                               
         DC    C'ONUM    '                   NUMERIC OUTPUT                     
         DC    A(ONUM),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'HOUTLET '                   OUTLET HEADLINE ROUTINE            
         DC    V(HOUTLET),AL1(0,0,0,0)       PRWRIOUT                           
*                                                                               
         DC    C'IOUTMKT '                   OUTLET MARKET                      
         DC    V(IOUTMKT),AL1(DIESTREC,0,0,0)       PRWRIOUT                    
         DC    C'OOUTMKT '                   OUTLET MARKET                      
         DC    V(OOUTMKT),AL1(0,0,0,0)       PRWRIOUT                           
*                                                                               
         DC    C'IPBYOUT '                   FIELD IS IN PPBYOUT                
         DC    A(IPBYOUT),AL1(0,0,0,0)          OUTPUT AREA                     
*                                                                               
         DC    C'IPC     '                   PLANNED COSTS                      
         DC    A(IPC),AL1(0,0,0,0)                                              
         DC    C'OPC     '                   PLANNED COSTS                      
         DC    A(OPC),AL1(0,0,0,0)                                              
*                                                                               
         DC    C'IPG     '                   PG SPECIAL COST FIELDS             
         DC    A(IPG),AL1(0,0,0,0)                                              
*                                                                               
         DC    C'IPICODE '                   POSITION INSTRUCTIONS              
         DC    A(IPICODE),AL1(0,0,0,0)          CODE                            
*                                                                               
         DC    C'IPNV    '                   NEW INVOICE RECORD FIELDS          
         DC    A(IPNV),AL1(0,0,0,0)                                             
         DC    C'OPNV    '                   NEW INVOICE RECORD FIELDS          
         DC    A(OPNV),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IPO#    '                   PURCHASE ORDER #                   
         DC    A(IPO#),AL1(0,0,0,0)                                             
         DC    C'OPO#    '                   PURCHASE ORDER #                   
         DC    A(OPO#),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IPREM   '                   BUY PREMIUM                        
         DC    A(IPREM),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'IPUBCLS '                   PUBCLASS                           
         DC    A(IPUBCLS),AL1(0,0,0,0)                                          
*                                                                               
         DC    C'IREBATE '                   REBATE BUY DOLLARS                 
         DC    V(IREBATE),AL1(0,0,0,0) PRWRIDLR                                 
*                                                                               
         DC    C'IREF    '                   REFERENCE NUMBER                   
         DC    A(IREF),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'ISHP    '                   SHIPPING ELEMENT DATA              
         DC    A(ISHP),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'ISMED   '                   SUB MEDIA                          
         DC    A(ISMED),AL1(0,0,0,0)                                            
         DC    C'OSMED   '                                                      
         DC    A(OSMED),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'ISTACK  '                   STACKING                           
         DC    V(ISTACK),AL1(0,0,0,0)  PRWRISTK                                 
*                                                                               
         DC    C'ITST1   '                   TESTING                            
         DC    A(ITST1),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'IUCM    '                   USER UCOMM   FIELDS                
         DC    A(IUCM),AL1(0,0,0,0)                                             
         DC    C'OUCM    '                   USER UCOMM   FIELDS                
         DC    A(OUCM),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'IUDF    '                   USER DEFINED FIELDS                
         DC    A(IUDF),AL1(0,0,0,0)                                             
         DC    C'OUDF    '                   USER DEFINED FIELDS                
         DC    A(OUDFR),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'IWLMED  '                   WL SPECIAL MEDIA                   
         DC    A(IWLMED),AL1(0,0,0,0)                                           
*                                                                               
         DC    C'IWSJ    '                   WALL STREET JOURNAL FIELDS         
         DC    A(IWSJ),AL1(0,0,0,0)                                             
         DC    C'OWSJ    '                   WALL STREET JOURNAL FIELDS         
         DC    A(OWSJ),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'ICLINCOD',A(ICLINCOD),AL1(DICLT,0,0,0) CLI INTERFACE           
         DC    C'IPRINCOD',A(IPRINCOD),AL1(DIPRD,0,0,0) PRD INTERFACE           
*        DC    C'IBINCH  ',A(IBINCH),AL4(0)   INCHES                            
         DC    C'IBJOB   ',A(IBJOB),AL1(DICLT,0,0,0)                            
         DC    C'IACTDATE',A(IACTDATE),AL4(0)  ACTIVITY DATE                    
*                                                                               
         DC    C'ICOMMENT',A(ICOMMENT),AL4(0) BUY COMMENT                       
         DC    C'IMARKET ',A(IMARKET),AL4(0)   MARKET                           
         DC    C'IJOB    ',A(IJOB),AL4(0)      JOB FROM BUY                     
         DC    C'IBILLCOD'                    BILLING GROUP                     
         DC    A(IBILLCOD),AL4(0)                                               
*                                                                               
         DC    C'IOUTSPC '         OUTDOOR SPCAE 2ND LINE                       
         DC    A(IOUTSPC),AL4(0)                                                
*                                                                               
         DC    C'IPOLSPLT'                    POL SPLIT                         
         DC    A(IPOLSPLT),AL1(0,0,0,0)                                         
*                                                                               
         DC    C'INCHLINE'                    ACCUM INCHES + LINES              
         DC    A(INCHLINE),AL1(0,0,0,0)                                         
*                                                                               
         DC    C'IPUBLSHR'                    PUBLISHER                         
         DC    A(IPUBLSH),AL1(DIPUBLSH,0,0,0)                                   
*                                                                               
         DC    C'IOPENR  '               OPEN RATE FROM PUB                     
         DC    A(IOPENR),AL4(0)                                                 
*                                                                               
         DC    C'ICOLLECT'               DIFFERENCE BETWEEN UNITS AND           
         DC    A(ICOLLECT),AL4(0)        NEXT LEVEL                             
*                                                                               
         DC    C'IFREQ   '                    FREQUENCY                         
         DC    A(IFREQ),AL4(0)                                                  
*                                                                               
         DC    C'ICIRC   '                    CIRCULATION                       
         DC    A(ICIRC),AL4(0)                                                  
*                                                                               
         DC    C'ITRA    '                    TRAFFIC BUYS                      
         DC    A(ITRA),AL4(0)                                                   
*                                                                               
         DC    C'ISRC    '                    BUY SOURCE                        
         DC    A(ISRC),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'ISTATE  '                    STATE CODE           L17          
         DC    A(ISTATE),AL4(0)                                                 
*                                                                               
         DC    C'IOUTDOOR'                    OUTDOOR REG SIZE &   L17          
         DC    A(IOUTDOOR),AL4(0)                                               
*                                                                               
         DC    C'ICLOFF  '                    OFFICE CODE                       
         DC    A(ICLOFF),AL4(0)                                                 
*                                                                               
         DC    C'IPAYMENT'                    PAYMENT DETAIL                    
         DC    A(IPAYMENT),AL4(0)                                               
*                                                                               
         DC    C'IBILLED '                    BILLED  DETAIL                    
         DC    A(IBILLED),AL4(0)                                                
*                                                                               
         DC    C'IBILUED '                    BILLED  DETAIL                    
         DC    A(IBILUED),AL4(0)                                                
*                                                                               
         DC    C'IBILLEDR'                    REBATED  DETAIL OPEN              
         DC    A(IBILLEDR),AL4(0)                                               
*                                                                               
*                                                                               
         DC    C'IBILLEDO'                    BILLED  DETAIL OPEN               
         DC    A(IBILLEDO),AL4(0)                                               
*                                                                               
         DC    C'IZONE   '                    PUB ZONE                          
         DC    A(IZONE),AL1(0,0,0,0)                                            
         DC    C'OZONE   '                                                      
         DC    A(OZONE),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'IRTECODE'                    BUY RATE CODE                     
         DC    A(IRTECODE),AL4(0)                                               
         DC    C'ICLICOS ',A(ICLICOS)                                           
         DC    AL1(DPROFDEF+DIEST,0,0,0)                                        
         DC    C'ICLICOS2',A(ICLICOS2)                                          
         DC    AL1(DPROFDEF+DIEST,0,0,0)                                        
         DC    C'IBPUBNAN',A(IBPUBNA),AL1(0,PBQPBRQS,0,0)  PUB NA/NUM           
         DC    C'IBPUBNA ',A(IBPUBNA),AL1(0,PBQPBRQS,0,0) PUB NAME              
         DC    C'IBCONTRL'              === CONTRACT NAME ETC==                 
         DC    A(IBCONTR),AL1(00,PBQCONTR+PBQPBRQS,0,0)                         
         DC    C'IBLISTCD',A(IBLISTCD),AL4(0)  LIST CODE          01            
         DC    C'IBLASTIO',A(IBLASTIO),AL4(0)  LAST IO            01            
*        DC    C'IBFREQ1 ',A(IBFREQ1),AL4(0)   CURRENT FREQUENCY                
*        DC    C'IBFREQ2 ',A(IBFREQ2),AL4(0)   NEXT    FREQUENCY                
         DC    C'IBPLANED',A(IBPLANED),AL4(0)  PLANNED COST                     
         DC    C'IBPLLCST',A(IBPLANED),AL4(0)  PLANNED COST-COST                
         DC    C'IBOANAME',A(IBOANAME),AL4(0)  OTHER AGENCY NAME                
         DC    C'IBOANACD',A(IBOANAME),AL4(0)  OTHER AGENCY NAME+CODE           
         DC    C'IBOANCOD',A(IBOANCOD),AL4(0)  OTHER AGENCY CODE                
         DC    C'ICLV4BUY'         === CONTRACT LEVEL FOR BUY                   
         DC    A(ICLV4BUY),AL1(00,PBQCONTR,00,00)                               
         DC    C'ICLV4BUH'    HIGHER== CONTRACT LEVEL FOR BUY                   
         DC    A(ICLV4BUH),AL1(00,PBQCONTR,00,00)                               
         DC    C'ICLV4BUO'    OPEN  == CONTRACT LEVEL FOR BUY                   
         DC    A(ICLV4BUO),AL1(00,PBQCONTR,00,00)                               
         DC    C'ICLV4BUL'    LOWER == CONTRACT LEVEL FOR BUY                   
         DC    A(ICLV4BUL),AL1(00,PBQCONTR,00,00)                               
         DC    C'CONUNIT '           ==   BUY UNITS// TIED W CONTRACT           
         DC    A(ICLV4BUY),AL1(00,PBQCONTR,00,00)                               
************    DATES  **********888                                            
         DC    C'IBMATER ',A(IBMATER),AL4(0)   MATERIAL  "                      
         DC    C'IBBILLBL',A(IBBILLBL),AL4(0)  BILLABLE  "                      
         DC    C'IBPAYBLE',A(IBPAYBLE),AL4(0)  PAYABLE   "                      
         DC    C'IBCLOSE ',A(IBCLOSE),AL4(0)   CLOSING   "                      
         DC    C'IBONSALE',A(IBONSALE),AL4(0)  ON SALE    "                     
*             *******************************************                       
*        DC    C'IBCURRA ',A(IBCURRA),AL4(0)   CURRENT RATE                     
         DC    C'ICOMPUTE',A(ICOMPUTE),AL4(0)                                   
         DC    C'ICLICODE',A(ICLICODE),AL1(DICLT,0,0,0) CLIENT CODE             
         DC    C'ICOUNT  ',A(ICOUNT),AL4(0) COUNT   OCCURANCES                  
         DC    C'INUMINS ',A(INUMINS),AL4(0) COUNT BUY  OCCURANCES              
         DC    C'IESTNUMB',A(IESTNUMB),AL4(0)                                   
         DC    C'ICLTM   ',A(ICLICODE),AL1(DICLT,0,0,0) MASTER CLIENT           
         DC    C'IDUMMY  ',A(IDUMMY),AL4(0)                                     
         DC    C'IDIVIS  ',A(IDIVIS),AL4(0)   DIVISION                          
         DC    C'IREGION ',A(IREGION),AL4(0)  REGION                            
         DC    C'IDISTRIC',A(IDISTRIC),AL4(0) DISTRICT                          
         DC    C'IBDIFF  ',A(IBDIFF),AL1(00,0,0,0)   DIFFERENCE                 
         DC    C'IPRODAN ',A(IPRODAN),AL4(0)  PRODUCT                           
         DC    C'IPRD    ',A(IPRD),AL4(0)                                       
         DC    C'IEST    ',A(IEST),AL1(DIESTREC,0,0,0)        BUG10             
         DC    C'IINDATE ',A(IINDATE),AL4(0)                                    
         DC    C'IR      ',A(IR),AL4(0)                                         
         DC    C'ICONBLG ',A(ICONBLG),AL4(0)                                    
*        DC    C'CURRENT ',A(CURRENT),AL4(0)   RATE/NEXT/EFF DATE               
         DC    C'IPOSIT  ',A(IPOSIT),AL4(0)    POSITION COMMENT                 
         DC    C'IIORDER ',A(IIORDER),AL4(0)    INSERTION ORDER COMMENT         
*        DC    C'BLDESCR ',A(BLDESCR),AL4(0)   BLEED DESCRIPTION                
*        DC    C'NEXT    ',A(CURRENT),AL4(0) ATE/NEXT/EFF DATE DES 2            
*        DC    C'IUSEAGE ',A(IUSEAGE),AL4(0)   USAGE                            
******   DC    C'IBNXTRA ',A(IBNXTRA),AL4(0)   NEXT    RATE                     
         DC    C'IRATEFDT',A(IRATEFDT),AL4(0)  EFFECTIVE DATE OF RATE           
         DC    C'RATEFDT2',A(IRATEFDT),AL4(0) EFFECTIVE DATE OF RATE2           
*        DC    C'IBCURRA2',A(IBCURRA),AL4(0)  CURRENT RATE (SP2)                
******   DC    C'IBNXTRA2',A(IBNXTRA),AL4(0)  NEXT    RATE (SP2)                
         DC    C'ILASTAD ',A(ILASTAD),AL4(0)  LAST AD IN USE      01            
         DC    C'IBCAPT  ',A(IBCAPT),AL4(0)   CAPTION                           
         DC    C'IBCOPY  ',A(IBCOPY),AL4(0)   COPY                              
         DC    C'IPUBNUM ',A(IPUBNUM),AL1(0,PBQPBRQS,0,0)                       
         DC    C'IMED    ',A(IMED),AL4(0)                                       
         DC    C'IBYSREP ',A(IBYSREP),AL4(0)  Special Rep                       
         DC    C'ITSR    ',A(ITSR),AL4(0)     TS Received                       
*====================================================================*          
*                                                                    *          
*        OUTPUT ROUTINES                                             *          
*                                                                    *          
*====================================================================*          
         DC    C'OACTIVE '                   ACTIVITY INDICATOR                 
         DC    A(OACTIVE),AL1(0,0,0,0)                                          
*                                                                               
         DC    C'OADRREP '                    ADDRESS/REP                       
         DC    A(OADDRESS),AL1(0,0,0,0)                                         
*                                                                               
         DC    C'OAGY    '                    AGENCY FIELDS                     
         DC    A(OAGYA),AL1(0,0,0,0)                                            
*                                                                               
         DC    C'OBUYDSCR'         BUY DESCRIPTION - OUTPUT                     
         DC    A(OBUYDSCR),AL4(0)                                               
*                                                                               
         DC    C'OCHANGE '         CHANGES TO RECORD                            
         DC    A(OCHANGE),AL1(0,0,0,0)                                          
*                                                                               
         DC    C'OCLR    '         CLEARANCE STATUS DATA                        
         DC    A(OCLR),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'OCOM    '                    COMMENTS                          
         DC    A(OCOM),AL1(0,0,0,0)                                             
*                                                                               
         DC    C'OCONDA  '         CONTRACT DISK ADDRESS OUTPUT                 
         DC    A(OCONDA),AL1(0,0,0,0)                                           
*                                                                               
         DC    C'OCONUNAC'         CONTRACT UNIT AND BUY ACTIVITY               
         DC    A(OCONUNAC),AL4(0)                                               
*                                                                               
         DC    C'OESTSCHM'                   ESTIMATE REQUEST SCHEME            
         DC    V(OESTSCHM),AL1(0,0,0,0) PRWRIEST                                
*                                                                               
         DC    C'OJOBREC '                   JOB RECORD DATA                    
         DC    V(OJOB),AL1(0,0,0,0)     PRWRIEST                                
*                                                                               
         DC    C'ODUMMY  ',A(ODUMMY),AL4(0)                                     
         DC    C'OCOMPUTE',A(OCOMPUTE),AL4(0)                                   
         DC    C'OJOB    ',A(OJOB),AL4(0)      JOB FROM BUY                     
         DC    C'OMED    ',A(OMED),AL4(0)                                       
         DC    C'OCONTRAT',A(OCONTRAT),AL4(0)                                   
         DC    C'OCLT    ',A(OCLT),AL4(0)                                       
*                                                                               
         DC    C'OPOLSPLT'                    POL SPLIT                         
         DC    A(OPOLSPLT),AL1(0,0,0,0)                                         
*                                                                               
         DC    C'ONUMINS '                     YMENT DETAIL                     
         DC    A(ONUMINS),AL4(0)                                                
*                                                                               
         DC    C'OCOUNT  ',A(OCOUNT),AL4(0) COLLECT OCCURANCES                  
*                                                                               
         DC    C'OPAYMENT'                    PAYMENT DETAIL                    
         DC    A(OPAYMENT),AL4(0)                                               
*                                                                               
         DC    C'OBCOMMON'                    EDIT ROUTINE                      
         DC    A(OBCOMMON),AL4(0)                                               
*                                                                               
         DC    C'OBILFORM'                    EDIT ROUTINE                      
         DC    A(OBILFOR),AL4(0)                                                
*                                                                               
         DC    C'OBILLED '                    BILLED  DETAIL                    
         DC    A(OBILLEDD),AL4(0)                                               
*                                                                               
         DC    C'OPUBLSHR'                    PUBLISHER                         
         DC    A(OPUBLSHR),AL4(0)                                               
*                                                                               
         DC    C'OBOOUT  '                   COMMON OUTDOOR NUMBERS             
         DC    A(OBOOUT),AL4(0)                                                 
*                                                                               
         DC    C'OOUTSPC '         OUTDOOR SPCAE 2ND LINE                       
         DC    A(OOUTSPC),AL4(0)                                                
*                                                                               
         DC    C'OPCOUNT'                     EDIT COUNT                        
         DC    A(OPCOUNT),AL4(0)                                                
*                                                                               
         DC    C'ONCHLINE'                    ACCUM INCHES + LINES              
         DC    A(ONCHLINE),AL1(0,0,0,0)                                         
*                                                                               
         DC    C'OCONUNIT'           ==    UNITS// TIED W CONTRACT              
         DC    A(OCONUNIT),AL4(0)                                               
*                                                                               
         DC    C'OLINENO '           ==    LINE NUMBER            L18           
         DC    A(OLINENO),AL4(0)                                   L18          
*                                                                               
         DC    C'OINSYYMM'           ==    INSERT DATE YYMMDD                   
         DC    A(OINSYYMM),AL4(0)                                               
*                                                                               
         DC    C'OREP    '           ==    REP DATA                             
         DC    A(OOREP),AL4(0)                                                  
*                                                                               
         DC    C'OAORFLD ',A(OAORFLD),AL4(0)                                    
         DC    C'OBILLFLD',A(OBILLFLD),AL4(0)                                   
         DC    C'NOREPORT',A(NOREPORT),AL4(0)                                   
         DC    C'OPRD    ',A(OPRODAN),AL4(0)                                    
         DC    C'OPOSIT  ',A(OPOSIT),AL4(0)    POSITION COMMENT                 
         DC    C'OEST    ',A(OEST),AL4(0)                                       
         DC    C'OINDATE ',A(OINDATE),AL4(0)                                    
         DC    C'PERTOTAL',A(PERTOTAL),AL4(0)                                   
         DC    C'OBLISTCD',A(OBLISTCD),AL4(0)  LIST CODE          01            
         DC    C'OBLASTIO',A(OBLASTIO),AL4(0)  LAST AO            01            
         DC    C'OLASTAD ',A(OLASTAD),AL4(0)  LAST AD IN USE      01            
         DC    C'OBJOB   ',A(OBJOB),AL4(0)                                      
         DC    C'OCOMMENT',A(OCOMMENT),AL4(0) BUY COMMENT                       
         DC    C'OCLINCOD',A(OCLINCOD),AL4(0)                                   
         DC    C'OPRINCOD',A(OPRINCOD),AL4(0)                                   
         DC    C'OMARKET ',A(OMARKET),AL4(0)  MARKET                            
         DC    C'OBCONTR ',A(OBCONTR),AL4(0)   CONTRACT ST-END CD               
         DC    C'OBFREQ1 ',A(OBFREQ1),AL4(0)                                    
         DC    C'OCLIVEND',A(OCLIVEND),AL4(0)                      L19          
         DC    C'OBOANAME',A(OBOANAME),AL4(0)  OTHER AGENCY NAME                
         DC    C'OBDIFF  ',A(OBDIFF),AL4(0)   DIFFERENCE                        
         DC    C'OBOANACD',A(OBOANAME),AL4(0)  OTHER AGENCY NAME+CODE           
         DC    C'OBOANCOD',A(OBOANCOD),AL4(0)  OTHER AGENCY CODE                
         DC    C'OBPUBNAN',A(OBPUBNA),AL4(0)   PUB NAME + NUMBER   01           
         DC    C'OBLASTIO',A(OBLASTIO),AL4(0)  LAST IO            01            
         DC    C'OBPUBNA ',A(OBPUBNA),AL4(0)   PUB NAME                         
*        DC    C'OBLDESCR',A(OBLDESCR),AL4(0)  BLEED DESCRIPTION                
*        DC    C'OBCURRA ',A(OBCURRA),AL4(0)   CURRENT RATE                     
*        DC    C'OBCURRA2',A(OBCURRA),AL4(0)  CURRENT RATE (SP2)                
         DC    C'ODIVIS  ',A(ODIVIS),AL4(0)   DIVISION                          
         DC    C'OREGION ',A(OREGION),AL4(0)  REGION                            
         DC    C'ODISTRIC',A(ODISTRIC),AL4(0) DISTRICT                          
*        DC    C'OCLICOS ',A(OCLICOS),AL4(0)   CLIENT COST                      
         DC    C'OASPNO  ',A(OASPNO),AL4(0)   ASPNO                             
         DC    C'OESTNUMB',A(OESTNUMB),AL4(0)                                   
         DC    C'OBILLCOD'                    BILLING GROUP                     
         DC    A(OBILLCOD),AL4(0)                                               
         DC    C'ORTECODE'                    BUY RATE CODE                     
         DC    A(ORTECODE),AL4(0)                                               
         DC    C'OJOB    ',A(OJOB),AL4(0)                                       
         DC    C'OCLICODE',A(OCLICODE),AL4(0)  CLIENT CODE                      
         DC    C'OPRODAN ',A(OPRODAN),AL4(0)  PRODUCT                           
*        DC    C'OBNXTRA2',A(OBCURRA),AL4(0)  NEXT    RATE (SP2)                
         DC    C'OPUBNUM ',A(OPUBNUM),AL4(0)                                    
*        DC    C'OCURRENT',A(OCURRENT),AL4(0)  RATE/NEXT/EFF DATE               
*****    DC    C'ONEXT   ',A(OCURRENT),AL4(0)  RATE/NEXT/EFF DATE               
*                                                                               
         DC    C'OCOLLECT'               DIFFERENCE BETWEEN UNITS AND           
         DC    A(OCOLLECT),AL4(0)        NEXT LEVEL                             
*                                                                               
         DC    C'OPERIOD '               OPEN RATE FROM PUB                     
         DC    A(OPERIOD),AL4(0)                                                
*                                                                               
         DC    C'OOPENR  '               OPEN RATE FROM PUB                     
         DC    A(OOPENR),AL4(0)                                                 
*                                                                               
         DC    C'SPACETOT'               SPECIAL SPACE CONTRACT TOTAL           
         DC    A(SPACETOT),AL4(0)                                               
*                                                                               
         DC    C'OCLOFF  '                    OFFICE CODE                       
         DC    A(OCLOFF),AL4(0)                                                 
*                                                                               
         DC    C'OBCOST  ',A(OBCOST),AL4(0)                                     
*                                                                               
         DC    C'OCIRC   '                    CIRCULATION                       
         DC    A(OCIRC),AL4(0)                                                  
*                                                                               
         DC    C'OUNITRT '                    UNIT RATES                        
         DC    A(OUNITRT),AL4(0)                                                
*                                                                               
         DC    C'OBPAID  ',A(OBCLOSE),AL4(0)   PAID    DATE                     
         DC    C'ORATEFDT',A(OBCLOSE),AL4(0)  EFFECTIVE DATE OF RATE            
         DC    C'ORATEFD2',A(OBCLOSE),AL4(0)  EFFECTIVE DATE OF RATE2           
         DC    C'OBMATER ',A(OBCLOSE),AL4(0)   MATERIAL  "                      
         DC    C'OBBILLBL',A(OBCLOSE),AL4(0)  BILLABLE  "                       
         DC    C'OBPAYBLE',A(OBCLOSE),AL4(0)  PAYABLE   "                       
         DC    C'OBCLOSE ',A(OBCLOSE),AL4(0)   CLOSING   "                      
         DC    C'OBONSALE',A(OBCLOSE),AL4(0)  ON SALE    "                      
*****    DC    C'OUSEAGE ',A(OUSEAGE),AL4(0)                                    
         DC    C'CURRHEAD',A(CURRHEAD),AL4(0)   CURR HEADLINE                   
         DC    C'OBCAPT  ',A(OBCAPT),AL4(0)   CAPTION                           
         DC    C'OBCOPY  ',A(OBCOPY),AL4(0)   COPY                              
*                                                                               
         DC    C'OCLV4BUY'                                                      
         DC    A(OCLV4BUY),AL4(0)      CONTRACT LEVEL FOR BUY                   
*                                                                               
*                                                                               
         DC    C'HPER    ',A(HPER),AL4(0)                                       
         DC    C'OBYSREP ',A(OBUYSREP),AL4(0) Special Rep                       
*                                                                               
         DC    X'FF'                                                            
         EJECT                                                                  
*=====================================================                          
         DS    0D                                                               
PP12468  NMOD1 160,PP12468                                                      
         SPACE 2                                                                
******                                                                          
* ON INPUT WORD 1   BYTE 0 = ELEMENT CODE                                       
*                        1-3 ADDRESS OF KEY                                     
*               2   OPTION - ADDRESS OF 'NOSQ' FOR NO SQUASH OPTION             
**************************                                                      
*                                                                               
** ON RETURN         WORD 1   BYTE 0                                            
*                                1-3  ADDRESS OF TABLE OF COMMENT               
******                                                                          
         ST    RC,ACOMREC                                                       
*========              ========*                                                
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
*========              ========*                                                
         L     RC,GLAWORKD     INITIALIZE RC                                    
         SPACE 2                                                                
         ST    R1,SAVER1        SAVE POINTER                                    
         MVC   SAVPARMS,0(R1)      SAVE PARAMETERS                              
         MVC   ELCODE,0(R1)     ELEMENT CODE                                    
         LA    R4,BIGTABLE                                                      
         ST    R4,ANXTCOM       ADDRESS OF NEXT COMMENT                         
         MVI   0(R4),C' '                                                       
         LA    R1,L'BIGTABLE-1 BIGTABLE-1                                       
         MOVE  (BIGTABLE+1,(R1)),BIGTABLE                                       
BC2      DS    0H                                                               
*                                                                               
*        CHECK IF A SPECIFIC LINE CALLED FOR                                    
*                                                                               
         MVI   WRKLINE#,0          SET TO PRINT ALL LINES                       
*                                                                               
         CLI   ELCODE,X'67'        INSERTION ORDER COMMENT?                     
         BE    *+8                 YES                                          
         CLI   ELCODE,X'68'        POSITION INSTRUCTION COMMENT?                
         BE    *+12                YES                                          
         CLI   ELCODE,X'66'        SKIP IF NOT BUY COMMENTS                     
         BNE   BCLINEX                                                          
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQCMFRE),0,0  FIND LINE #                    
         BNE   BCLINEX                                                          
*                                                                               
         ICM   R6,15,8(R1)         POINT TO RETURNED FILTER                     
         BZ    BCLINEX                                                          
*                                                                               
         ICM   RF,15,FLTFVAL-FLTCTL(R6) GET LINE NUMBER                         
         BZ    BCLINEX                                                          
*                                                                               
         STC   RF,WRKLINE#         SAVE LINE NUMBER                             
*                                                                               
         MVI   WRKLNCTR,0          INIT COMMENT COUNTER                         
*                                                                               
BCLINEX  DS    0H                                                               
*                                                                               
         L     R6,AIO1                                                          
         LA    R6,33(R6)                                                        
*                                                                               
BC4      BAS   RE,NXTEL                                                         
         BNE   BCX       NO SOUGHT ELEMENTS                                     
*                                                                               
         CLI   1(R6),2             NO DATA?                                     
         BE    BC4                                                              
*                                                                               
         CLI   GLARGS+1,C'R'       IF LOOKING ONLY FOR REGION COMMENTS          
         BNE   *+14                                                             
         CLC   =C'REG=',2(R6)         MUST START WITH REG=                      
         BNE   BC4                                                              
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,WRKLNCTR       BUMP LINE COUNTER                            
         AHI   R0,1                                                             
         STC   R0,WRKLNCTR                                                      
*                                                                               
         CLI   WRKLINE#,0          SKIP IF NO LINE NUMBER CHECK                 
         BE    BC4A                                                             
*                                                                               
         CLC   WRKLNCTR,WRKLINE#   SKIP UNLESS THIS IS LINE TO PRINT            
         BNE   BC4                                                              
*                                                                               
BC4A     DS    0H                                                               
*                                                                               
BC5      CLC   2(4,R6),=C'COM='                                                 
         BE    BC8                 STANDARD COMMENT                             
*                                                                               
         L     R4,ANXTCOM                                                       
         ZIC   R5,1(R6)                                                         
         AHI   R5,-3                                                            
*                                                                               
         LA    R1,2(R6)            START OF COMMENT                             
         LR    RF,R5               COPY EXECUTE LENGTH                          
*                                                                               
         CLC   =C'REG=',0(R1)      STRIP OFF 'REG='                             
         BNE   *+12                                                             
         LA    R1,4(R1)                                                         
         AHI   RF,-4                                                            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(R1)                                                    
*                                                                               
         LA    R4,2(R5,R4)         POINT TO NEXT COMMENT SAVEAREA               
         ST    R4,ANXTCOM                                                       
         B     BC4                                                              
*                                                                               
*                                                                               
BC8      DS    0H                                                               
         MVC   SVELCOD,ELCODE      SAVE ELCODE                                  
         ST    R6,SAVER6           SAVE BUYREC'S R6                             
*                                                                               
         XC    KEY,KEY                                                          
*                                                                               
         L     RF,AIO1             ADDRESS OF BUY                               
*                                                                               
         MVC   KEY(3),0(RF)        AGENCY MEDIA                                 
         MVI   KEY+3,X'40'                                                      
*                                                                               
         ZIC   R5,1(R6)            ELEMENT LENGTH                               
         AHI   R5,-6               REDUCE BY CODE,LEN,COM=                      
         BNP   BC8X                NO NUMBER                                    
*                                                                               
*        STRIP TRAILING BLANKS FROM COMMENT CODE                                
*        ADBUYER PRODUCES SOME TRAILING BLANKS                                  
*                                                                               
         SR    RF,RF                                                            
         LA    RF,6-1(R5,R6)       POINT TO LAST CH IN CODE                     
*                                                                               
         CLI   0(RF),C' '          DONE IF NON-BLANK                            
         BH    *+16                                                             
         SHI   RF,1                BACK UP A BYTE                               
         BCT   R5,*-12                                                          
         B     BC8X                NO CODE ELFT                                 
*                                                                               
         MVC   WORK(10),SPACES                                                  
         LA    R7,WORK+6                                                        
         SR    R7,R5                                                            
*                                                                               
         BCTR  R5,0                RIGHT JUSTIFY                                
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R7),6(R6)                                                    
*                                                                               
         MVC   KEY+4(6),WORK                                                    
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(12),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                STND COMMENT NOT FOUND                       
*                                                                               
         MVC   AIO,ACOMREC         SET UP WHERE REC IS TO BE READ               
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE POINTERS                             
         OI    DMINBTS,X'08'     PASS BACK DELETED RECORDS       BUG11          
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         L     R6,ACOMREC                                                       
         LA    R6,33(R6)                                                        
*                                                                               
         MVI   ELCODE,X'40'                                                     
*                                                                               
         CLI   0(R6),X'40'                                                      
         BE    BC8D                                                             
*                                                                               
BC8C     BAS   RE,NXTEL                                                         
         BNE   BC8X                                                             
*                                                                               
BC8D     DS    0H                                                               
         CLC   2(5,R6),=C'SHIP='                                                
         BE    BC8C                                                             
         CLC   2(6,R6),=C'LABEL='                                               
         BE    BC8C                                                             
         CLC   2(4,R6),=C'MAT='                                                 
         BE    BC8C                                                             
         CLC   2(3,R6),=C'RC='                                                  
         BE    BC8C                                                             
*                                                                               
         ZIC   R5,1(R6)            ELEMENT LENGTH                               
         LR    R1,R6                 SAVE R6                                    
         LA    R4,2(R6)                                                         
         LR    R6,R4                                                            
*                                                                               
         AHI   R5,-3                                                            
         BM    BC8C                                                             
*                                                                               
         CLI   0(R4),C'+'                                                       
         BNE   *+8                                                              
         LA    R6,2(R6)                                                         
*                                                                               
         CLC   0(3,R6),=C'DC='     ONLY DC= COMMNTS                             
         BE    BC8E                                                             
*                                                                               
         L     R3,ANXTCOM                                                       
         LTR   R5,R5                                                            
         BM    BC8E                                                             
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R4)                                                    
*                                                                               
         LA    R3,2(R5,R3)                                                      
         ST    R3,ANXTCOM                                                       
*                                                                               
BC8E     LR    R6,R1                                                            
         B     BC8C                                                             
*                                                                               
BC8X     MVC   ELCODE,SVELCOD      RESTORE ELCODE                               
         MVC   KEY,SVBUYKEY                                                     
         L     R6,SAVER6           RESTORE BUYREC'S R6                          
         B     BC4                                                              
*                                                                               
BCX      DS    0H                                                               
*                                                                               
         L     R0,ANXTCOM          CALCULATE COMMENT LENGTH                     
         LA    RF,BIGTABLE         AS END MINUS START                           
         SR    R0,RF                                                            
         LR    R5,R0               SAVE LENGTH FOR SQUASHER                     
         BNP   BCX1                NOTHING FOUND                                
*                                                                               
         LA    R3,BIGTABLE         START OF COMMENT                             
*                                                                               
BCXLP    DS    0H                                                               
*                                                                               
         LA    RF,L'SPACES         LENGTH OF SPACES                             
*                                                                               
         CR    RF,R0               MAKE COMMENT UPPERCASE                       
         BNH   *+6                                                              
         LR    RF,R0                                                            
*                                                                               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R3),SPACES                                                   
*                                                                               
         LA    R3,1(RF,R3)         NEXT PORTION OF COMMENT                      
         SR    R0,RF                                                            
         BCT   R0,BCXLP                                                         
*                                                                               
BCX1     DS    0H                                                               
*                                                                               
         LA    R3,BIGTABLE                                                      
         L     RF,SAVER1                                                        
         ST    R3,0(RF)            INITIALIZE ANXTCOM TO FIRST                  
*                                                                               
         ICM   RE,15,SAVPARMS+4    GET PARAMETER                                
         CLC   =C'NOSQ',0(RE)      NO SQUASH OPTION                             
         BE    BCXIT                                                            
*                                                                               
         L     RF,SQUASHER                                                      
         GOTO1 (RF),DMCB,(R3),(R5)                                              
*                                                                               
BCXIT    XIT1                                                                   
*                                                                               
NXTEL    DS    0H                                                               
         SR    R0,R0                                                            
NXTELLP  DS    0H                                                               
         IC    R0,1(R6)                                                         
         AR    R6,R0                                                            
*                                                                               
         CLI   0(R6),0                                                          
         BE    NXTELX1                                                          
*                                                                               
         CLC   ELCODE,0(R6)                                                     
         BER   RE                                                               
*                                                                               
         B     NXTELLP                                                          
*                                                                               
NXTELX1  LTR   R6,R6                                                            
         BR    RE                                                               
         SPACE 3                                                                
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
         DS    0F                                                               
SVBUYKEY DS    CL32                                                             
SAVER6   DS    F                                                                
ACOMREC  DS    F                                                                
SAVER1   DS    F                                                                
SAVPARMS DS    XL8                                                              
ANXTCOM  DS    A                                                                
WRKLINE# DS    XL1                 LINE NUMBER TO PRINT                         
WRKLNCTR DS    XL1                 LINE NUMBER COUNTER                          
SVELCOD  DS    CL1                                                              
SAVEP    DS    CL132                                                            
*                                                                               
         SPACE 3                                                                
         EJECT                                                                  
         LTORG                                                                  
BIGTABLE DS    CL4096                                                           
         TITLE 'COMMON SUBROUTINES'                                             
*=====================================================                          
COMMON1  CSECT                                                                  
         NMOD1 500,COM1ON,R7                                                    
         PRINT NOGEN                                                            
         SPACE 2                                                                
******                                                                          
** ON ENTRY          WORD 1   BYTE 0                                            
*                                1-3  DISPLACEMENT                              
******                                                                          
         ST    R1,SAVER1A                                                       
*========              ========*                                                
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
*========              ========*                                                
         ST    RC,RCWORK                                                        
         L     RC,GLAWORKD     INITIALIZE RC                                    
         SPACE 2                                                                
         L     RF,0(R1)                                                         
         LA    RE,TABLEI                                                        
         B     0(RF,RE)                                                         
*                                                                               
ROPYM    EQU  TABLEI-*                                                          
ROBILL   EQU  PROBILL-*                                                         
RILASTA1 EQU  PRILAST-*                                                         
RWHATDOL EQU  PRWHATD-*                                                         
RGETLINE EQU  PRGETLIN-*                                                        
RGETLITO EQU  PRGETLIT-*                                                        
RCONVDAT EQU  PRCONVD-*                                                         
ROESTAA  EQU  PROESTAA-*                                                        
ROPUBLSR EQU  PROPUBLS-*                                                        
RTOTOUT  EQU  PRTOTOUT-*                                                        
RTPROP   EQU  PROPRD-*                                                          
RTOMARK  EQU  PROMARK-*                                                         
RTOCOST  EQU  PROCOST-*                                                         
RTOCOST2 EQU  PROCOST2-*                                                        
RTOGSTC  EQU  PROGSTC-*                                                         
RTICLVEN EQU  PROCLVN-*            CLIENT VENDOR NUMBER                         
RTOPUBNO EQU  PROPUBN-*            PUBLICATION NUMBER              L20          
RTOOJOB  EQU  PROOBJOB-*                                                        
RTODRD   EQU  PRODRD-*                                                          
RTOBFM   EQU  PROBFM-*                                                          
*                                                                               
TABLEI   B     OPAYM               0                                            
PROBILL  B     OBILL               4                                            
PRILAST  B     ILASTA1             8  INPUT SIDE -LAST IO IN USE                
PRWHATD  B     WHATDOL             C  WHAT DOLLARS OF BILLED/PAID               
PRGETLIN B     GETLINES           10  LOOK FOR LINES ENTRY (CONTRACTS)          
PRGETLIT B     GETLITOT           14  LOOK FOR LINES TOTAL                      
PRCONVD  B     CONVDATE           18  CONVERT DATE TO PERIOD                    
         DC    AL4(0)              REPLACED                                     
         DC    AL4(0)              REPLACED                                     
*****PRPBELEM B     PBELEMNT           20  PAID/BILLED ELEMENTS                 
PROESTAA B     OESTAA             24  PROCESS ESTIMATE OUTPUT                   
         DC    AL4(0)              REPLACED                                     
PROPUBLS B     OPUBLSRR           2C  PUBLISHER PROCESSING                      
PRTOTOUT B     OTOTOUT           30  TOTAL SUBROUTINE                           
PROPRD   B     OPRDCOM           34   PRODUCT PROCESSING                        
         DC    AL4(0)              REPLACED                                     
         DC    AL4(0)              REPLACED                                     
PROMARK  B     OOMARKET            MARKET PROCESS                               
PROCOST  B     OOCOST              COST TO CLIENT                               
PROCOST2 B     OOCOST2             COST2 TO CLIENT                              
PROGSTC  B     GETGST              CALCULATE GST FOR ELEMENT                    
PROCLVN  B     ICLIVN              CLIENT VENDOR                                
PROPUBN  B     OPUBNUM1            PUBLICATION NUMBER              L20          
PROOBJOB B     OOBJOB                                                           
PRODRD   B     OOBDRD                                                           
PROBFM   B     OOBILFOR                                                         
         TITLE 'OUTPUT ROUTINES '                                               
*                                                                               
*-------------->   DRD INPUT ROUTINE                                            
*                                                                               
OOBDRD   CLI   0(R2),255                                                        
         BNE   *+8                                                              
         MVI   0(R2),0                                                          
         OC    0(20,R2),0(R2)                                                   
         BNZ   PBDOV1                                                           
         CLI   MYLTYP,C'H'                                                      
         BNE   COMEXIT                                                          
*                                                                               
         MVC   CODEAREA(4),=C'****'                                             
         MVC   NAMEAREA(20),=C'** NONE ASSIGNED ** '                            
         B     COMEXIT                                                          
PBDOV1   CLI   GLARGS,C'D'          CODE ONLY                                   
         BNE   PBDOV1A                                                          
         MVC   CODEAREA(3),0(R2)                                                
         B     COMEXIT                                                          
PBDOV1A  CLI   GLARGS,C'N'                                                      
         BNE   PBDOV1B                                                          
         MVC   NAMEAREA(20),3(R2)    NAME ONLY                                  
         B     COMEXIT                                                          
*                                                                               
PBDOV1B  DS    0H                                                               
         MVC   NAMEAREA(20),3(R2)                                               
         MVC   CODEAREA(3),0(R2)                                                
******   CLI   20(R2),0            SHOULD NOT BE NEEDED                         
******   BE    COMEXIT                                                          
******   TM    PBQPOPT,PBQPOCUT                                                 
******   BO    COMEXIT                                                          
******   MVC   0(20,R3),0(R2)                                                   
******   MVI   20(R3),C'('                                                      
******   MVC   21(3,R3),20(R2)                                                  
******   MVI   24(R3),C')'                                                      
         B     COMEXIT                                                          
*                                                                               
*-------------->   JOB OUTPUT ROUTINE                                           
*                                                                               
OOBJOB   DS    0H                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(3),=C'JOB'                                              
         CLI   GLARGS,C'N'                                                      
         BE    OBJOB1                                                           
         MVC   CODEAREA(6),0(R2)                                                
         CLI   GLARGS,C'C'                                                      
         BE    COMEXIT                                                          
*                                                                               
OBJOB1   CLC   0(6,R2),=C'*NONE*'                                               
         BE    COMEXIT                                                          
         XC    KEY,KEY                                                          
*========              ========*                                                
         LA    R4,KEY                                                           
         USING PJOBREC,R4                                                       
*========              ========*                                                
         MVC   PJOBKAGY,AGENCY                                                  
         MVC   PJOBKMED,6(R2)    MEDIA                                          
         CLI   6(R2),C'C'                                                       
         BNE   *+8                                                              
         MVI   PJOBKMED,C'M'                                                    
OBJOB1A  MVI   PJOBKRCD,X'15'                                                   
         MVC   PJOBKCLT,7(R2)    CLIENT                                         
         MVC   PJOBKPRD,10(R2)   PRODUCT                                        
         MVC   PJOBKJOB,0(R2)                                                   
*                                                                               
OBJOB2   GOTO1 HIGH                                                             
         CLC   PJOBKEY(PJOBKPUB-PJOBKEY),KEYSAVE                                
         BE    OBJOB3                                                           
         CLI   6(R2),C'C'                                                       
         BNE   COMEXIT                                                          
         CLI   PJOBKMED,C'M'                                                    
         BNE   COMEXIT                                                          
         MVI   PJOBKMED,C'N' TRY NEWSPAPER                                      
         B     OBJOB1A                                                          
*                                                                               
*                                                                               
OBJOB3   L     R4,AIO1                                                          
         ST    R4,AIO                                                           
         GOTO1 GETREC                                                           
*========              ========*                                                
         LR    R6,R4                                                            
         USING PJOBELEM,R6                                                      
*========              ========*                                                
         MVI   ELCODE,X'15'                                                     
         BAS   RE,GETELL                                                        
         BE    *+6                                                              
         DC    H'0'                                                             
         MVC   NAMEAREA(L'PJOBCAP1),PJOBCAP1                                    
*                                                                               
OBJOB4   LR    R1,R3               ** WARNING : THIS PART ASSUMES JOB           
         CLI   GLARGS,C'N'            -------   IS NOT A HEADLINE OR            
         BE    *+14                             MIDLINE                         
         MVC   0(6,R1),0(R2)                                                    
         LA    R1,7(R1)                                                         
         CLI   GLARGS,C'C'                                                      
         BE    AGENOUT                                                          
         MVC   0(L'PJOBCAP1,R1),PJOBCAP1                                        
         MVC   198(L'PJOBCAP2,R1),PJOBCAP2                                      
         B     AGENOUT                                                          
*        ========  *                                                            
         DROP  R6                                                               
*        ========  *                                                            
*                                                                               
*------------->     PUBLICATION NUMBER R                                        
*                                                                               
OPUBNUM1 DS    0H                                                  L20          
*                                                                               
         CLI    GLARGS,C'Z'        NO COMMAS                       L20          
         BNE    OPUBNUMA                                           L20          
*                                                                               
         CLI   MYLTYP,C'H'         IF HEADLINE OR MIDLINE                       
         BE    *+8                                                              
         CLI   MYLTYP,C'M'                                                      
         BE    *+12                                                             
         TM    GLINDS,X'40'        OR TOTALS                                    
         BNO   *+8                                                              
         LA    R3,NAMEAREA            BUILD IN GENERAL OUT AREA    L20          
*                                                                               
         UNPK  0(9,R3),0(5,R2)     MOVE PUB                        L20          
*                                                                               
         MVC   8(5,R3),=C'     ' INITIALIZE EDIT AND ZONE          L20          
         LA    R1,8(R3)            POINT TO NEXT PRINT POSITION                 
*                                                                               
         MVC   BYTE,PBAGYPRF+12    NUMBER OF DIGITS FOR PUB NUMBER              
         NI    BYTE,X'0F'          KILL ZONE NYBBLE                             
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,BYTE                                                        
         BZ    OPUBDIGX            NO ADJUSTMENT IN NUMBER OF DIGITS            
*                                                                               
         LHI   RE,8                MAX DIGITS FOR PUBNUM                        
         SR    RE,RF               EXCESS DIGITS                                
         BNP   OPUBDIGX            NONE                                         
*                                                                               
         CLI   0(R3),C'0'          DONE IF NON-ZERO DIGIT                       
         BH    *+16                                                             
         MVC   0(8,R3),1(R3)       SHIFT DIGITS LEFT ONE PLACE                  
         BCTR  R1,0                BACK UP PRINT POSITION                       
         BCT   RE,*-16                                                          
*                                                                               
*          DATA SET PUBEDIT    AT LEVEL 020 AS OF 01/04/89                      
OPUBDIGX DS    0H                                                               
*                                                                               
         CLI   4(R2),0                                             L20          
         BE    NOZZONE                                             L20          
EDZON    DS    0H                                                               
*                                  'HEXOUT'                                     
         SR    RF,RF                                                            
         MVC   WORK,4(R2)                                                       
         NI    WORK,X'0F'                                                       
         IC    RF,WORK                                                          
         LA    RF,183(RF)          A-F                                          
         CLI   WORK,10                                                          
         BNL   *+8                                                              
         LA    RF,57(RF)           0-9                                          
         STC   RF,1(R1)                                                         
         IC    RF,4(R2)                                                         
         SRL   RF,4                                                             
         LA    RF,183(RF)          A-F                                          
         CLI   4(R2),160                                                        
         BNL   *+8                                                              
         LA    RF,57(RF)           0-9                                          
         STC   RF,0(R1)                                                         
NOZZONE  LA    R1,2(R1)            BUMP TO NEXT PRINT POSITON      L23          
         CLI   5(R2),0                                             L20          
         BE    OPUBNUMB                                            L20          
*          DATA SET PUBEDIT    AT LEVEL 020 AS OF 01/04/89                      
*                                  EDITION                                      
ED4      DS    0H                                                               
         LA    RF,EDTAB                                                         
ED4A     DS    0H                                                               
         CLC   0(1,RF),5(R2)                                                    
         BE    ED4B                FOUND                                        
         BH    ED4C                NOT IN TABLE                                 
         LA    RF,4(RF)                                                         
         B     ED4A                                                             
ED4B     DS    0H                                                               
ED4B2    DS    0H                                                               
         MVC   0(3,R1),1(RF)                                                    
ED4C     DS    0H                                                               
EDEXT    DS    0H                                                               
         B     OPUBNUMB                                            L20          
         SPACE 3                                                                
OPUBNUMA LA    R3,CODENNAM                                         L20          
         GOTO1  =V(PUBEDIT),DMCB,(PBAGYPRF+12,(R2)),(C'S',(R3))                 
OPUBNUMB TM     GLINDS,X'40'          DOING TOTALS                              
*        BNO    COMEXIT                                                         
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(11),=C'PUBLICATION'                       BUG02         
         B     COMEXIT                                                          
*                                                                               
         SPACE 3                                                                
EDTAB    DS    0C                                                               
         DC    CL4'AM  '                                                        
         DC    CL4'BE  '                                                        
         DC    CL4'CD  '                                                        
         DC    CL4'DME '                                                        
         DC    CL4'ESAM'                                                        
         DC    CL4'FSAE'                                                        
         DC    CL4'GSD '                                                        
         DC    CL4'HSME'                                                        
         DC    CL4'ISU '                                                        
         DC    CL4'JOM '                                                        
         DC    CL4'KOE '                                                        
         DC    CL4'LOD '                                                        
         DC    CL4'MOME'                                                        
         DC    CL4'NPR '                                                        
         DC    CL4'PP  '                                                        
         DC    CL4'RR  '                                                        
         DC    CL4'SS  '                                                        
         DC    CL4'TT  '                                                        
         DC    CL4'UMON'                                                        
         DC    CL4'WW  '                                                        
         DC    CL4'XPM '                                            L01         
         DC    X'FF'               EOL                                          
*                                                                               
*------------->     CLIENT VENDOR NUMBER                                        
*                                                                               
ICLIVN    DS   0H                                                  L19          
         MVI   ELCODE,X'14'                                        L19          
         L     R6,AIO3                                             L19          
         BAS   RE,GETELL                                           L19          
         B     *+8                                                 L19          
ICLIA    DS    0H                                                  L19          
         BAS   RE,NXTELL                                           L19          
         BNE   COMEXIT                                             L19          
         USING PUBREPEL,R6                                         L19          
         CLC   PUBRPOFF,PBCLT                                      L19          
         BNE   ICLIA                                               L19          
         MVC   0(12,R2),PUBCVEN VEN                                L19          
         B     COMEXIT                                             L19          
**                                                                              
*                                                                               
*------------->     CALCUATE GST ON BILL/PAY ELEMENT                            
*                                                                               
*     CALLING SUBROUTINE PARM 1 ADDRESS OF WHERE GST IS TO GO PL8               
*                               BYTE 0 P=PAID B=BILLED                          
*                                                                               
GETGST   NTR1                                                                   
*                                                                               
*========       ===========*                                                    
         L      R4,AIO1                                                         
         USING  PBUYRECD,R4                                                     
*========       ===========*                                                    
         TM    PBDCNDA,X'80'       SEE IF CANADIAN                              
         BZ    GETPGX                                                           
*                                                                               
         TM    GLARGS+5,X'20'      CONTINUE IF DOING INPUT GST                  
         BO    *+12                                                             
         CLI   GETGSTSW,C'P'       SEE IF GETTING PAID GST                      
         BNE   GETPG5                                                           
*                                                                               
         TM    PBDCNDA,X'01'       SEE IF PAID WITH GST                         
         BNO   GETPGX              NO - DON'T CALCULATE GST PAID                
*                                                                               
GETPG5   DS    0H                                                               
*                                                                               
         L     RF,WORK         GROSS                                            
         S     RF,WORK+4       MINUS AGYCOM                                     
*                                                                               
         MVC   FULL(1),PBDGST      TAKE GST CODE FROM BUY                       
         LA    R5,PGSTTAB                                                       
         CLI   FULL,0              CODE NOT ENTERED IN BUY                      
         BNE   *+8                                                              
         MVI   FULL,C'S'             DEFAULT TO STANDARD                        
         SPACE 3                                                                
*                                                                               
*---------------------------> VERIFY CODE IN PGSTTAB                            
*                                                                               
GETPG10B DS    0H                                                               
*                                                                               
         CLI   0(R5),X'FF'          IF END OF TABLE                             
         BNE   *+14                                                             
         XC    FULL,FULL                                                        
         B     GETPGX                  BAD GST CODE - NO GST                    
*                                                                               
         CLC   0(1,R5),FULL                                                     
         BNE   GETPG10C                                                         
*                                                                               
         CLC   PBUYKDAT,4(R5)   SEE IF INSERTION DATE IN ENTRY RANGE            
         BL    GETPG10C                                                         
*                                                                               
         B     GETPG10D                                                         
*                                                                               
GETPG10C DS    0H                                                               
*                                                                               
         LA    R5,8(R5)            NEXT ENTRY IN TABLE                          
         B     GETPG10B                                                         
*                                                                               
GETPG10D XC    FULL,FULL                                                        
*                                                                               
         OC    2(2,R5),2(R5)      GST TAX PCT                                   
         BZ    GETPGX             NO GST TAX                                    
*                                                                               
GETPG10E OC    PBDTAX,PBDTAX       SEE IF I HAVE TAX                            
         BNZ   GETPG20                                                          
*                                                                               
*                                   NOTE - RF HAS NET AT THIS POINT             
GETPG10G DS    0H                                                               
*                                                                               
         CLI   PBDCOSIN,C'C'       COMMISION BUYS HAVE NO GST TAX               
         BE    COMEXIT                                                          
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+2(2),2(R5)                                                  
         L     RE,FULL                                                          
         MR    RE,RE                                                            
         SLDL  RE,1                                                             
         D     RE,=F'100000'        GST TAX HAS 3 DECIMALS                      
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AHI   RF,1                                                             
         SRA   RF,1                                                             
         ST    RF,FULL                                                          
         LR    R0,RF                                                            
         B     GETPG30        GO ACCUMLATE IN GSTTAXPD                          
*                                                                               
*                          FOR TAX BUYS WORK INCLUDES TAX                       
GETPG20  DS    0H          EXTRACT NET ELEMENT                                  
*                     RETURNS NET IN RF  FOR GETPG10G                           
         L     R0,WORK                 PPGROSS                                  
         S     R0,WORK+4              MINUS PPAGYCOM                            
         ST    R0,DUB                                                           
         XC    FULL,FULL                                                        
         MVC   FULL+1(3),PBDTAX                                                 
         L     RF,FULL           RE = SALES TAX PCT                             
         SR    RE,RE                                                            
*                                                                               
         TM    1(R5),X'01'             SEE IF SALES TAX IS ON NET               
         BO    GETPG25                                                          
*                                                                               
         XC    FULL,FULL                                                        
         MVC   FULL+2(2),2(R5)    GSTTAX PCT                                    
         L     R0,FULL                                                          
         A     R0,=F'100000'                                                    
         ST    R0,FULL                                                          
*                                                                               
         M     RE,FULL                                                          
         D     RE,=F'100000'                                                    
*                                                                               
GETPG25  A     RF,=F'1000000'                                                   
         ST    RF,FULL                                                          
*                                                                               
         L     RF,DUB                                                           
         M     RE,=F'1000000'                                                   
         SLDL  RE,1                                                             
         D     RE,FULL                                                          
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AHI   RF,1                                                             
         SRA   RF,1                                                             
         B     GETPG10G            RF HAS NET                                   
*                                                                               
GETPG30  DS    0H                                                               
         CLI   GETGSTSW,C'P'                                                    
         BNE   GETPG40                                                          
         B     GETPGXC                                                          
*                                                                               
GETPG40  CLI   GETGSTSW,C'B'                                                    
         BNE   GETPGX                                                           
GETPGXC  CLI   PBDCOSIN,C'C'       COMMISSION ONLY                              
         BE    GETPGX                                                           
         ST    R0,GTGSTTAX                                                      
         B     GETPGX                                                           
GETPGX   DS    0H                  RETURN                                       
         XIT1                                                                   
*                                                                               
       ++INCLUDE PGSTTAB                                                        
         DROP  R4                                                               
*                                                                               
*------------->     EXPAND BILL FORMULA                                         
*                                                                               
OOBILFOR DS    0H                                                               
         MVC   BILPROFS,0(R2)                                      L26          
         CLI   GLARGS,C'S'                                                      
         BNE   FORMLARG                                                         
*                                                                               
         OC    BILPROFS,BILPROFS   SKIP IF NO FORMULA                           
         BZ    COMEXIT                                                          
*                                                                               
         GOTO1 =V(WRBILFM),DMCB,BILPROFS,(1,WORK)                               
         MVC   0(15,R3),WORK                                       L26          
         B     COMEXIT                                             L26          
*                                                                               
FORMLARG DS    0H                                                               
*                                                                               
         OC    BILPROFS,BILPROFS   SKIP IF NO FORMULA                           
         BZ    COMEXIT                                                          
*                                                                               
         GOTO1 =V(GETCOST),DMCB,BILPROFS,(1,(R3))                               
         B      COMEXIT                                                         
*                                                                               
*                                                                               
*                                                                               
*------------->     PROCESS COST TO CLIENT                                      
*                                                                               
OOCOST   XC    BILPROFS,BILPROFS                                                
*                                                                               
         TM    PBQBLLO2,PBQBFRMQ   IF USING BFORM RECS                          
         BNO   OOCOST1                                                          
*                                                                               
         GOTOR B1XGET,WRKDMCB,B1XPROF  FIND B1X PROFILE                         
*                                                                               
         CLI   B1XPROF+11,C'Y'     SKIP IF NOT USING BFORM RECS                 
         BNE   OOCOST1                                                          
*                                                                               
         GOTOR BFMGET,WRKDMCB,BILPROFS    GET BILL FORMULA                      
*                                                                               
         B     ESM95P                                                           
*                                                                               
B1XPROF  DS    XL16                B1X PROFILE                                  
*                                                                               
OOCOST1  DS    0H                                                               
*                                                                               
* LOOK FOR BILLING OPTIONS IN THIS SEQUENCE                                     
*  1-FOR THIS EST  2-FOR THIS EST PRODUCT AAA 3-FOR THIS PRODUCT                
*  4-FOR PRODUCT AAA   5-DEFAULT                                                
*                                                                               
* LOOK FOR THIS EST IN ESTIMATE TABLE  // EST / PRD AAA IN PBESTADR             
* PRODUCTS ARE IN PRODUCT TABLE                                                 
*                                                                               
*                                                                               
*========              ========*                                                
         L     RF,PBABILLB NOTE -- ESTIMATE HAS EST AAA PROD OVERRIDE           
*                                  IF ORIGINAL EST HAS NOTHING IN               
*                                  BILLING PROFILE--DONE IN I/O                 
*========              ========*                                                
         OC    BILPROFS(5),0(RF)                                                
         BNZ   ESM95P                 BILLING OPTIONS IN THIS EST               
*                          PROFILE                                              
*========              ===========*                                             
ICLIPRD  L     RE,PBAPRDBF                                                      
         USING PRDBUFFD,RE                                                      
*========              ========*                                                
         XC    DEFPAAA,DEFPAAA                                                  
ICLCO    CLI   0(RE),0                                                          
         BE    ICLCO2                 CHECK FOR PRODUCT AAA                     
*                                                                               
         CLC   PBFPRD,=C'AAA'         LAST PROD DEFAULT                         
         BNE   *+14                                                             
         MVC   DEFPAAA,PBFBLBAS                                                 
         B     ICLCO2                                                           
*                                                                               
         LA    RE,PBFLEN(RE)                                                    
         B     ICLCO                                                            
*                                                                               
ICLCO2   DS    0H                                                               
*                                                                               
         L     RE,PBAPRDBF                                                      
*                                                                               
ICLCO1   CLI   0(RE),0                                                          
         BE    DEFPOSS                CHECK FOR END OF BUFFER                   
*                                                                               
         CLC   PBFPRD,PBPROD                                                    
         BE    *+12                                                             
         LA    RE,PBFLEN(RE)                                                    
         B     ICLCO1                                                           
*                                                                               
         OC    BILPROFS(5),PBFBLBAS    SEE IF PROD HAS BILL PROF                
         BNZ   ESM95P                                                           
*                                                                               
DEFPOSS  OC    BILPROFS(5),DEFPAAA                                              
         BNZ   ESM95P                                                           
*                                                                               
*                                                                               
DEFAULT  MVC   BILPROFS,=X'0505000000' DEFAULT G-CD                             
*                                                                               
ESM95P   CLI   GLARGS+1,C'F'         BILLING FORMULA               L26          
         BNE   ESM95PX                                                          
*                                                                               
         MVC   0(6,R2),BILPROFS                                   L26           
         B     COMEXIT                                             L26          
*                                                                               
ESM95PX  CLI   GLARGS+1,C'L'         BILLABLE                                   
         BNE   ESM95P1                                                          
*                                                                               
         L     RF,PBGRS                                                         
         S     RF,PBBGROSS                                                      
         ST    RF,WORK                                                          
         L     RF,PBCD                                                          
         S     RF,PBBCSHDS                                                      
         ST    RF,WORK+4                                                        
         L     RF,PBGYCOM                                                       
         S     RF,PBBAGCOM                                                      
         ST    RF,WORK+8                                                        
*                                                                               
         B     ESM95PP                                                          
*                                                                               
ESM95P1  CLI   GLARGS+1,C'B'         BILLED                                     
         BNE   ESM95P2                                                          
*                                                                               
         MVC   WORK(4),PBBGROSS                                                 
         MVC   WORK+4(4),PBBCSHDS                                               
         MVC   WORK+8(4),PBBAGCOM                                               
*                                                                               
         B     ESM95PP                                                          
*                                                                               
ESM95P2  MVC   WORK(4),PBGRS                                                    
         MVC   WORK+4(4),PBCD                                                   
         MVC   WORK+8(4),PBGYCOM                                                
*                                                                               
         CLI   GLARGS+1,C'T'       IF TAX TO BE EXCLUDED                        
         BNE *+16                                                               
         ICM   RF,15,WORK                                                       
         S     RF,PBTAX               SUBTRACT ORDERED TAX FROM GROSS           
         STCM  RF,15,WORK                                                       
*                                                                               
ESM95PP  DS    0H                                                               
*                                                                               
         XC    0(4,R2),0(R2)       INIT TO ZERO COST                            
*                                                                               
         OC    BILPROFS,BILPROFS   SKIP IF NO BILLING FORMULA                   
         BZ    COMEXIT                                                          
*                                                                               
         GOTO1 =V(GETCOST),DMCB,BILPROFS,WORK,(C'C',(R4))                       
*                                                                               
         MVC   0(4,R2),DMCB+4       TRUE AGENCY COST                            
*                                                                               
         B     COMEXIT                                                          
*                                                                               
*        ========  *                                                            
         DROP  RE                                                               
*        ========  *                                                            
DEFPAAA  DS    CL6                 PRODUCT AAA BILLING DEFAULT                  
*                                                                               
BILPROFS DS    CL5                                                              
WRKDMCB  DS    6F                  WORK PARAMETER BLOCK                         
*                                                                               
*                                                                               
*                                                                               
*                                                                               
*------------->     PROCESS COST2 TO CLIENT                                     
*                                                                               
OOCOST2  XC    BILPROFS,BILPROFS                                                
*                                                                               
         TM    PBQBLLO2,PBQBFRMQ   IF USING BFORM RECS                          
         BNO   OOCOS21                                                          
*                                                                               
         GOTOR B1XGET,WRKDMCB,B1XPROF  FIND B1X PROFILE                         
*                                                                               
         CLI   B1XPROF+11,C'Y'     SKIP IF NOT USING BFORM RECS                 
         BNE   OOCOS21                                                          
*                                                                               
         GOTOR BFMGET,WRKDMCB,BILPROFS    GET BILL FORMULA                      
*                                                                               
         B     ESM952P                                                          
*                                                                               
OOCOS21  DS    0H                                                               
*                                                                               
* LOOK FOR BILLING OPTIONS IN THIS SEQUENCE                                     
*  1-FOR THIS EST  2-FOR THIS EST PRODUCT AAA 3-FOR THIS PRODUCT                
*  4-FOR PRODUCT AAA   5-DEFAULT                                                
*                                                                               
* LOOK FOR THIS EST IN ESTIMATE TABLE  // EST / PRD AAA IN PBESTADR             
* PRODUCTS ARE IN PRODUCT TABLE                                                 
*                                                                               
*                                                                               
*========              ========*                                                
         L     RF,PBABILLB NOTE -- ESTIMATE HAS EST AAA PROD OVERRIDE           
*                                  IF ORIGINAL EST HAS NOTHING IN               
*                                  BILLING PROFILE--DONE IN I/O                 
*========              ========*                                                
         OC    BILPROFS(5),0(RF)                                                
         BNZ   ESM952P                BILLING OPTIONS IN THIS EST               
*                          PROFILE                                              
*========              ===========*                                             
ICLIPRD2 L     RE,PBAPRDBF                                                      
         USING PRDBUFFD,RE                                                      
*========              ========*                                                
         XC    DEFPAAA,DEFPAAA                                                  
ICLC2O   CLI   0(RE),0                                                          
         BE    ICLC2O2                CHECK FOR PRODUCT AAA                     
*                                                                               
         CLC   PBFPRD,=C'AAA'         LAST PROD DEFAULT                         
         BNE   *+14                                                             
         MVC   DEFPAAA,PBFBLBAS                                                 
         B     ICLC2O2                                                          
*                                                                               
         LA    RE,PBFLEN(RE)                                                    
         B     ICLC2O                                                           
*                                                                               
ICLC2O2  DS    0H                                                               
*                                                                               
         L     RE,PBAPRDBF                                                      
*                                                                               
ICLC2O1  CLI   0(RE),0                                                          
         BE    DEFPOSS2               CHECK FOR END OF BUFFER                   
*                                                                               
         CLC   PBFPRD,PBPROD                                                    
         BE    *+12                                                             
         LA    RE,PBFLEN(RE)                                                    
         B     ICLC2O1                                                          
*                                                                               
         OC    BILPROFS(5),PBFBLBAS    SEE IF PROD HAS BILL PROF                
         BNZ   ESM952P                                                          
*                                                                               
DEFPOSS2 OC    BILPROFS(5),DEFPAAA                                              
         BNZ   ESM952P                                                          
*                                                                               
*                                                                               
DEFAULT2 MVC   BILPROFS,=X'0505000000' DEFAULT G-CD                             
*                                                                               
ESM952P  CLI   GLARGS+1,C'F'         BILLING FORMULA               L26          
         BNE   ESM952PX                                                         
*                                                                               
         MVC   0(6,R2),BILPROFS                                   L26           
         J     COMEXIT                                             L26          
*                                                                               
ESM952PX CLI   GLARGS+1,C'L'         BILLABLE                                   
         BNE   ESM952P1                                                         
*                                                                               
         L     RF,OGROSS                                                        
         S     RF,OBGROSS                                                       
         ST    RF,WORK                                                          
         L     RF,OCSHDSC                                                       
         S     RF,OBCSHDSC                                                      
         ST    RF,WORK+4                                                        
         L     RF,OAGYCOM                                                       
         S     RF,OBAGYCOM                                                      
         ST    RF,WORK+8                                                        
*                                                                               
         B     ESM952PP                                                         
*                                                                               
ESM952P1 CLI   GLARGS+1,C'B'         BILLED                                     
         BNE   ESM952P2                                                         
*                                                                               
         MVC   WORK(4),OBGROSS                                                  
         MVC   WORK+4(4),OBCSHDSC                                               
         MVC   WORK+8(4),OBAGYCOM                                               
*                                                                               
         B     ESM952PP                                                         
*                                                                               
ESM952P2 MVC   WORK(4),OGROSS                                                   
         MVC   WORK+4(4),OBCSHDSC                                               
         MVC   WORK+8(4),OAGYCOM                                                
*                                                                               
         CLI   GLARGS+1,C'T'       IF TAX TO BE EXCLUDED                        
         BNE   *+16                                                             
         ICM   RF,15,WORK                                                       
         S     RF,PBTAX               SUBTRACT ORDERED TAX FROM GROSS           
         STCM  RF,15,WORK                                                       
*                                                                               
ESM952PP DS    0H                                                               
*                                                                               
         XC    0(4,R2),0(R2)       INIT TO ZERO COST                            
*                                                                               
         OC    BILPROFS,BILPROFS   SKIP IF NO BILLING FORMULA                   
         JZ    COMEXIT                                                          
*                                                                               
         GOTO1 =V(GETCOST),DMCB,BILPROFS,WORK,(C'C',(R4))                       
*                                                                               
         MVC   0(4,R2),DMCB+4       TRUE AGENCY COST                            
*                                                                               
         J     COMEXIT                                                          
*                                                                               
*        ========  *                                                            
         DROP  RE                                                               
*        ========  *                                                            
*                                                                               
*                                                                               
*------------->     PROCESS MARKET/ CITY+STAT                                   
*                                                                               
OOMARKET CLI   GLARGS,C'A'         IF CITY/STATE OPTION                         
         BNE   NOTCTST                                                          
*                                                                               
         GOTO1 =A(BLDLBL)             BUILD LABEL                               
*                                                                               
         B     OMARCOM                                                          
*                                                                               
NOTCTST  CLI   0(R2),C'N'                                                       
         BNE   OMARFAO             CHECK FOR OUTDOOR                            
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(6),=C'MARKET'                                           
*                                                                               
OMARCOM  MVC   NAMEAREA(16),3(R2)  CITY                                         
         CLI   GLARGS+1,C'1'       IF CITY/STATE ORDER                          
         BNE   *+10                                                             
         MVC   NAMEAREA(16),1(R2)     RESET CITY NAME                           
*                                                                               
OMARMOV  MVI   NAMEAREA+16,C','                                                 
*                                                                               
         LA    RF,1(R2)            DEFAULT STATE CODE POINTER                   
         CLI   GLARGS+1,C'1'       IF CITY ORDER                                
         BNE   *+8                                                              
         LA    RF,17(R2)              RESET STATE CODE POINTER                  
*                                                                               
         MVC   NAMEAREA+18(2),0(RF)                                             
*                                                                               
         OC    NAMEAREA,SPACES     MAKE UPPERCASE                               
*                                                                               
         L     RF,SQUASHER                                                      
         GOTO1 (RF),DMCB,NAMEAREA,21                                            
*                                                                               
         LA    RE,NAMEAREA+21                                                   
         LA    RF,NAMEAREA                                                      
*                                                                               
OMABCT   BCTR  RE,0                                                             
         CLI   0(RE),C','                                                       
         BE    OMAHIT                                                           
         CR    RE,RF                                                            
         BL    OMARMMOV                                                         
         B     OMABCT                                                           
OMAHIT   BCTR  RE,0                                                             
         MVC   0(4,RE),1(RE)                                                    
         MVI   4(RE),C' '                                                       
OMARMMOV MVC   0(21,R3),NAMEAREA                                                
         B     COMEXIT                                                          
*                                                                               
OMARFAO  CLI   0(R2),C'O'                                                       
         BNE   COMEXIT             NO MARKET                                    
GENOCOMM MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(6),=C'MARKET'                                           
         MVC   NAMEAREA(20),1(R2)                                               
         B     COMEXIT                                                          
*                                                                               
*------------->     PROCESS PRODUCT                                             
*                                                                               
OPRDCOM  MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(7),=C'PRODUCT'                                          
         MVC   PBPROD,0(R2)                                                     
         CLI   GLARGS,C'N'                                                      
         BE    OPRD2                                                            
         MVC   CODEAREA(3),0(R2)                                                
         MVC   0(3,R3),0(R2)                                                    
         LA    R3,3(R3)                                                         
         CLI   GLARGS,C'C'                                                      
         BNE   OPRD2                          GENOUT                            
OPRDCMM  CLI   MYLTYP,C'H'                                                      
         BE    AGENOUT                                                          
         B     COMEXIT                                                          
*                                                                               
*========              ========*                                                
OPRD2    L     RF,PBAPRDBF                                                      
         USING PRDBUFFD,RF                                                      
*========              ========*                                                
*                                                                               
OPRD4    CLI   0(RF),0                                                          
         BE    OPRD6                                                            
         CLC   PBFPRD,PBPROD                                                    
         BE    *+12                                                             
         LA    RF,PBFLEN(RF)                                                    
         B     OPRD4                                                            
         MVC   NAMEAREA(L'PBFNAME),PBFNAME                                      
         B     OPRDCMM                        GENOUT                            
*                                                                               
OPRD6    XC    KEY,KEY                                                          
*========              ========*                                                
         LA    R4,KEY                                                           
         USING PPRDRECD,R4                                                      
*========              ========*                                                
         MVC   PPRDKAGY,PBAGY                                                   
         MVC   PPRDKMED,PBQMED                                                  
         CLI   PBQMED,C'*'                                                      
         BE    *+12                                                             
         CLI   PBQMED,C'C'                                                      
         BNE   *+8                                                              
         MVI   PPRDKMED,C'M'                                                    
         MVI   PPRDKRCD,X'06'                                                   
         MVC   PPRDKCLT,PBCLT                                                   
         MVC   PPRDKPRD,PBPROD                                                  
*                                                                               
OPRD7    MVI   RDUPDATE,C'N'                                                    
         GOTO1 HIGH                                                             
         CLC   KEY(PPRDKPRD+L'PPRDKPRD-PPRDKEY),KEYSAVE                         
         BE    OPRD8                                                            
         MVC   KEY,KEYSAVE                                                      
         CLI   PPRDKMED,C'N'                                                    
         BE    OPRDCMM                        GENOUT                            
         MVI   PPRDKMED,C'N'                                                    
         B     OPRD7                                                            
*                                                                               
OPRD8    L     R4,AIO1                                                          
         ST    R4,AIO                                                           
         GOTO1 GETREC                                                           
         L     RE,PBCPRDBF         GET PREVIOUS COUNT                           
         LA    RE,1(RE)                                                         
         ST    RE,PBCPRDBF         AND SAVE NEW                                 
         MH    RE,=Y(PBFLEN)                                                    
         C     RE,PBLPRDBF         TEST BUFFER FULL                             
         BH    OPRD9                                                            
         MVC   PBFPRD,PBPROD       MOVE PRODUCT CODE                            
         MVC   PBFDIV,PPRDDIV      DIVISION CODE                                
         MVC   PBFNAME,PPRDNAME    AND PRODUCT NAME                             
*                                                                               
OPRD9    MVC   NAMEAREA(L'PPRDNAME),PPRDNAME                                    
         B     OPRDCMM                        GENOUT                            
         SPACE 2                                                                
*                                                                               
*-------------->    SHARED TOTAL ROUTINE                                        
*                                                                               
         SPACE 3                                                                
*              AT THIS STAGE...    LABLAREA HAS PREFIX                          
*                                  CODEAREA HAS CODE                            
*                                  NAMEAREA HAS NAME                            
*              INPUT               NDROW1WD NDROWWID                            
         SPACE 1                                                                
OTOTOUT  DS    0H                  R2=L'ROW1 AND L'ALLROWS        L03           
*                                                                               
         ZIC   R1,GLRECNO          PICK UP PRESENT RECORD NUMBER  L03           
         BCTR  R1,0                                               L03           
         SLL   R1,2                                               L03           
         LA    R1,GLAINTD(R1)      GET TO DETAILS FOR THIS REPORT L03           
*========              ========*                                                
         L     R1,0(R1)                                           L03           
         USING GLINTD,R1                                          L03           
*========              ========*                                                
         LH    R4,GLPDISP          NOW PICK UP PRINT DISPLACEMENT L03           
         A     R4,GLAINTP1         AND GET ACTUAL PRINT ADDRESS   L03           
         LA    R4,1(R4)                                           L03           
*                                                                               
         DROP  R1                                                 L03           
*                                                                               
         LTR   R4,R4                                              L03           
         BZ    COMEXIT                                            L03           
*                                                                               
         ZIC   R1,TOTROWID          TOTAL ROW WIDTH               L03           
*                                                                               
         CHI   R1,2                                               L06           
         BL    COMEXIT                                            L06           
*                                                                               
         BCTR  R1,0                EXCLUDE BOX LINE               L03           
         BCTR  R1,0                DECREMENT FOR EXECUTE          L03           
*                                                                               
NOIZZ    EX    R1,CLEARP1                                         L03           
         EX    R1,CLEARP2                                         L03           
         EX    R1,CLEARP3                                         L03           
*                                                                               
         CLI   TOTROWID,3                                         L03           
         BL    TOTOUTX                                            L03           
*                                                                               
         MVC   0(3,R3),=C'ALL'                                    L03           
*                                                                               
         CLI   TOTROWID,5                                         L03           
         BL    TOTOUTX                                            L03           
*                                                                               
         MVC   0(5,R3),=C'*ALL*'                                  L03           
*                                                                               
         CLI   TOTROWID,8                                         L03           
         BL    TOTOUTX                                            L03           
*                                                                               
         MVC   0(8,R3),=C'*TOTALS*'                               L03           
*                                                                               
         CLI   TOTROWID,16                                        L03           
         BL    TOTOUTX                                            L03           
*                                                                               
         MVC   0(8,R3),SPACES                                     L03           
*                                                                               
         LR    R3,R4                                              L03           
*                                                                               
         MVC   BLOCK(80),SPACES                                   L03           
         MVC   BLOCK(10),=C'TOTALS FOR'                           L03           
         MVC   BLOCK+12(59),OUTAREA                               L03           
*                                                                               
         GOTO1 SQUASHER,DMCB,BLOCK,80                             L03           
*                                                                               
         ZIC   R4,TOTROWID         IF WIDTH OF ALL ROWS IS OVER 20              
         BCTR  R4,0                                                             
*========              ========*                                  L09           
         L     R1,GLATHID                                         L09           
         USING GLINTD,R1           SEE IF A TOTAL LINE            L09           
*========              ========*                                  L09           
         TM    GLINDS2,GLEXTBOX    XBOX REQSTED                                 
         BO    *+6                                                              
         BCTR  R4,0                                                             
*                                                                               
         CLC   GLLEVEL,GLDETLEV    IF NOT JUST PRINT              L09           
         BE    TOTOOO                                             L09           
*                                                                               
         LA    RF,LEVELCON         PRINT ONLY ON THIS LEVEL BREAK L09           
*                                                                               
TOTLLLV  CLI   0(RF),0                                            L09           
         BE    TOTOOO                                             L09           
*                                                                               
         CLC   GLLEVEL,0(RF)                                      L09           
         BE    TOTOOP                                             L09           
*                                                                               
         LA    RF,1(RF)                                           L09           
         B     TOTLLLV                                            L09           
*                                                                               
TOTOOP   AHI   R4,-5                                              L09           
*                                                                               
         CLI   TOTROWID,25                                        L09           
         BL    TOTOUT2                                            L09           
         DROP  R1                                                 L09           
*                                                                               
TOTOOO   CLI   TOTROWID,20                                                      
         BL    TOTOUT2                                                          
*                                                                               
         LA    R3,4(R3)                                                         
         AHI   R4,-4               INDENT TOTALS BY 4                           
*                                                                               
*?????   TM    NDCOLIND,X'40'      AND TOTSTACK WAS NOT REQUESTED               
         B     TOTOUT2                                                          
*                                                                               
*??????  L     R1,=A(MYDEFLST)                                                  
*                                                                               
         CLI   1(R1),0             AND THERE IS MORE THAN 1 LINE                
         BE    TOTOUT2                                                          
*                                                                               
         CHI   R4,24               AND WE HAVE ROOM TO SPARE                    
         BL    TOTOUT2                                                          
*                                                                               
*?????   MVI   ANYTOTST,C'Y'       SET TOTAL STACK PENDING                      
*                                                                               
         SH    R4,=H'9'            AND ALLOW FOR THIS IN THE WIDTH              
*                                                                               
TOTOUT2  BCTR  R4,0                                                             
         ICM   RF,15,PBT2PTR                                                    
         BZ    TOTOUT2A                                                         
*                                                                               
         CLI   PBQINLIN,0           ANY INCH LINE TOTALING FOR SPACE            
         BE    TOTOUT2A                                                         
*                                                                               
         CLC   OUTAREA(4),=C'CONT' TEST FOR CONTRACT                            
         BE    TOTOUPB                                                          
*                                                                               
         CLC   OUTAREA(4),=C'PUBL' TEST FOR PUBLICATION                         
         BNE   TOTOUT2A                                                         
*                                                                               
TOTOUPB  CHI   R4,19           IS LENGTH GT 19                                  
         BL    TOTOUT2A            CANNOT FIT TOTAL AND INCHES                  
*                                                                               
         AHI   R4,-19                                                           
*                                                                               
TOTOUT2A LA    R1,4                                                             
         ST    R1,DMCB+8                                                        
         MVI   DMCB+8,198                                                       
*                                                                               
         GOTO1 CHOPPER,DMCB,(80,BLOCK),((R4),0(R3))                             
*                                                                               
         CLI   PBQINLIN,0           ANY INCH LINE TOTALING FOR SPACE            
         BE    TOTOUTX                                                          
         LA    RE,TOTRETRN                                                      
         L     R6,PBT2PTR                                                       
TOTFIND  NTR1                                                                   
         LA    RF,EBLOCK                                                        
         ST    RF,DMCB+4                                                        
         BAS   RE,GETLITOT        GET TOTALS FOR ANY LEVEL                      
TOTRETRN DS    0H                                                               
         ICM   R6,15,PBT2PTR                                                    
         BZ    TOTPRINA                                                         
         CLC   OUTAREA(4),=C'CONT' TEST FOR CONTRACT                            
         BE    TOTPRIN                                                          
         CLC   OUTAREA(4),=C'PUBL' TEST FOR PUBLICATION                         
         BNE   TOTPRINA                                                         
TOTPRIN  MVC   0(18,R6),LINEDES                                                 
TOTPRINA MVC   LINEDES,SPACES                                                   
*                                                                               
TOTOUTX  MVC   OUTAREA,SPACES                                                   
*                                                                               
*        PRINT AVERAGE DAYS TO DISBURSEMENT IF NEEDED                           
*                                                                               
OTOTADD  DS    0H                                                               
*                                                                               
         LR    R0,R4               SAVE LENGTH                                  
*                                                                               
         L     R4,=A(ODBLADD)      POINT TO AVG DAYS TO DISBURSE                
         OC    0(8,R4),0(R4)       SKIP IF NOTHING PRESENT                      
         BZ    OTOTADDX                                                         
*                                  PRWRICFL                                     
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFADD))                  
*                                                                               
         OC    8(4,R1),8(R1)                                                    
         BZ    OTOTADDX            AVG DAYS NOT WANTED                          
*                                                                               
         ZIC   RF,TOTROWID          TOTAL ROW WIDTH                             
*                                                                               
OTOTADD1 DS    0H                                                               
*                                                                               
         CH    RF,=Y(L'ODBLTXTS+4)  MINIMUM POSITIONS NEEDED                    
         BL    OTOTADDX                                                         
*                                                                               
*        FIND A SPARE LINE FOR PRINTING                                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         LA    R0,20               CHECK MAX 20 LINES                           
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R3),SPACES      LOOK FOR EMPTY LINE                          
         BNH   *+16                                                             
         LA    R3,198(R3)          BUMP TO NEXT LINE                            
         BCT   R0,*-22                                                          
         B     OTOTADDX            NO ROOM LEFT                                 
*                                                                               
         CH    RF,=Y(L'ODBLTXTL-1+5)  IF ROOM FOR LONG TEXT                     
         BL    *+22                                                             
         L     R1,=A(ODBLTXTL)                                                  
         MVC   0(L'ODBLTXTL,R3),0(R1)       USE IT                              
         LA    RE,L'ODBLTXTL(R3)                                                
         B     *+18                                                             
         L     R1,=A(ODBLTXTS)                                                  
         MVC   0(L'ODBLTXTS,R3),0(R1)     ELSE USE SHORT TEXT                   
         LA    RE,L'ODBLTXTS(R3)                                                
*                                                                               
*        PRINT AVERAGE DAYS TO DISBURSEMENT                                     
*                                                                               
         XC    EBLOCK,EBLOCK       INIT EDIT BLOCK                              
*                                                                               
         ST    R4,EBAIN            PASS INPUT ADDRESS                           
         MVI   EBLIN,L'ODBLADD     INPUT LENGTH                                 
         MVI   EBTIN,C'P'          INPUT FORMAT IS PACKED                       
         MVI   EBFLOAT,C'-'        FLOAT MINUS SIGN                             
*                                                                               
         ST    RE,EBAOUT           OUTPUT ADDRESS                               
         MVI   EBLOUT,4            SET OUTPUT LENGTH                            
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK  PRINT AVG DAYS TO DISBURSE                 
*                                                                               
OTOTADDX DS    0H                                                               
*                                                                               
         XC    0(8,R4),0(R4)       RESET DAYS FIELD                             
         LR    R4,R0               RESTORE LENGTH                               
*                                                                               
*        PRINT COUNT IF NEEDED                                                  
*                                                                               
OTOTCT   DS    0H                                                               
*                                                                               
         TM    PBQCFOPT,PBQCFCTQ   SKIP IF NO FIELD BEING COUNTED               
         BNO   OTOTCTX                                                          
*                                                                               
*        FIND A SPARE LINE FOR PRINTING                                         
*                                                                               
         LR    RF,R4               COPY OUTPUT AREA LENGTH                      
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         LA    R0,20               CHECK MAX 20 LINES                           
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,R3),SPACES      LOOK FOR EMPTY LINE                          
         BNH   *+16                                                             
         LA    R3,198(R3)          BUMP TO NEXT LINE                            
         BCT   R0,*-22                                                          
         B     OTOTCTX             NO ROOM LEFT                                 
*                                                                               
         GOTO1 =V(COUNT)           PRINT COUNT                                  
*                                                                               
OTOTCTX  DS    0H                                                               
*                                                                               
         SPACE 2                                                                
*========              ========*                                  L09           
         L     R1,GLATHID                                         L09           
         USING GLINTD,R1           SEE IF A TOTAL LINE            L09           
*========              ========*                                  L09           
         CLC   GLLEVEL,GLDETLEV    IF NOT JUST PRINT              L09           
         BE    COMEXIT                                            L09           
         LA    RF,LEVELCON         PRINT ONLY ON THIS LEVEL BREAK L09           
TOTAAAA  CLI   0(RF),0                                            L09           
         BE    COMEXIT                                            L09           
         CLC   GLLEVEL,0(RF)                                      L09           
         BE    TOTPPP                                             L09           
         LA    RF,1(RF)                                           L09           
         B     TOTAAAA                                            L09           
TOTPPP   DS    0H                                                 L09           
         CLI   TOTROWID,16                                        L09           
         BL    COMEXIT                                            L09           
         AR    R3,R4                                              L09           
         CLI   PBQTOTTY,TOTTYPLT     LIVE AND TEST  L09                         
         BNE   TOTOTT1                                                          
         MVC   1(5,R3),=C'-LIVE'                                  L09           
         MVC   199(5,R3),=C'-TEST'                                L09           
         MVC   397(5,R3),=C'-TOTL'                                              
         B     COMEXIT                                            L09           
TOTOTT1  DS    0H                                                 L09           
         CLI   PBQTOTTY,TOTTYPNT     TOTAL AND TEST               L09           
         BNE   COMEXIT                                            L09           
         MVC   1(5,R3),=C'-TEST'                                  L13           
         MVC   199(5,R3),=C'-TOTL'                                L13           
         B     COMEXIT                                            L09           
         SPACE 1                                                                
CLEARP1  MVC   000(0,R4),SPACES                                                 
CLEARP2  MVC   198(0,R4),SPACES                                                 
CLEARP3  MVC   396(0,R4),SPACES                                                 
*                                                                               
LINEDES  DC    CL32' '                                                          
*                                                                               
         DROP  R1                                                               
*                                                                               
*-------------->  PUBLISHER PROCESSING                                          
*                                                                               
OPUBLSRR MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(9),=C'PUBLISHER'                                        
         CLI   GLARGS,C'C'                                                      
         BNE   OPUBLS                                                           
         MVC   CODEAREA(4),34(R2)                                               
         MVC   0(4,R3),34(R2)                                                   
         B     COMEXIT                                                          
*                                                                               
OPUBLS   CLI   GLARGS,C'N'         NAME ONLY                                    
         BNE   OPUBLSB                                                          
         MVC   NAMEAREA(30),4(R2)                                               
         B     COMEXIT                                                          
*                                                                               
OPUBLSB  MVC   CODEAREA(4),34(R2)    NAME AND CODE                              
         MVC   NAMEAREA(30),4(R2)                                               
         CLI   0(R2),255                                                        
         BE    COMEXIT                                                          
         MVI   CODEAREA,C'('                                                    
         MVC   CODEAREA+1(4),34(R2)                                             
         MVI   CODEAREA+5,C')'                                                  
         B     COMEXIT                                                          
*                                                                               
*-------------->  PROCESS ESTIMATE  ===================                         
*                                                                               
OESTAA   MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(8),=C'ESTIMATE'    ** ESTIMATE **                       
*                                                                               
         OC    0(2,R2),0(R2)       SKIP IF NO ESTIMATE DATA AVAILABLE           
         BZ    OESTX                                                            
*                                                                               
         MVI   PAOSESAV,0          INIT SAVED SE NUMBER                         
*                                                                               
         CLI   GLARGS,C'N'         SKIP IF EST NUMBER NOT REQ'D                 
         BE    OEST2               NAME                                         
         CLI   GLARGS,C'R'         RETAIL SCHEME CODE                           
         BE    OEST2                                                            
         CLI   GLARGS,C'D'         DATES ONLY                                   
         BE    OEST2                                                            
         CLI   GLARGS,C'F'         DATES ONLY                                   
         BE    OEST2                                                            
*                                                                               
         CLC   =C'CA',GLARGS       IF ATT CODE                                  
         BNE   OESTATTX                                                         
*                                                                               
*        FORMAT ATT CODE WITH SPECIAL MEDIA CODE                                
*           FOLLOWED BY ESTIMATE NUMBER                                         
*                                                                               
*        R2==> C'MEDIA',XL2'EST NUMBER'                                         
*                                                                               
OESTATT  DS    0H                                                               
*                                                                               
         LA    R0,5                NUMBER OF MEDIA                              
         LA    R1,OESTATCD         POINT TO ATT CODE TABLE                      
*                                                                               
         CLC   0(1,R2),0(R1)       MATCH PRINTPAK MEDIA                         
         BE    *+14                                                             
         LA    R1,3(R1)            BUMP TO NEXT TABLE ENTRY                     
         BCT   R0,*-14                                                          
         DC    H'0'                SHOULD NOT BE HERE                           
*                                                                               
         MVC   0(2,R3),1(R1)       DISPLAY ATT MEDIA CODE                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,1(R2)          ESTIMATE NUMBER                              
         CVD   RF,DUB              CVD                                          
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  2(3,R3),DUB+6(2)    ZERO-FILLED EST NUMBER                       
*                                                                               
         MVC   CODEAREA(5),0(R3)   ALSO SET IN CODEAREA                         
*                                                                               
         B     OESTX                                                            
*                                                                               
OESTATCD DS    0X                  TABLE OF ATT MEDIA CODES                     
*                                  FORMAT IS C'PRINTPAK MEDIA'                  
*                                            CL2'ATT MEDIA CODE'                
         DC    C'M',CL2'MG'        MAGAZINE                                     
         DC    C'N',CL2'NW'        NEWSPAPAER                                   
         DC    C'T',CL2'MG'        TRADE                                        
         DC    C'S',CL2'SP'        SUPPLEMENTS                                  
         DC    C'O',CL2'OD'        OUTDOOR                                      
*                                                                               
OESTATTX DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'0'       IF WE ARE PRINTING LEADING ZEROS             
         BNE   OESTLDZX                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,0(R2)          GET BINARY ESTIMATE NUMBER                   
*                                                                               
         CVD   RF,DUB              CONVERT TO DECIMAL                           
         OI    DUB+7,X'0F'         FORCE SIGN                                   
*                                                                               
         UNPK  0(3,R3),DUB         PRINT ESTIMATE NUMBER                        
         MVC   CODEAREA(3),0(R3)                                                
*                                                                               
         B     OESTNUM1                                                         
*                                                                               
OESTLDZX DS    0H                                                               
*                                                                               
         EDIT  (2,0(R2)),(3,CODEAREA)   DISPLAY ESTIMATE NUMBER                 
         MVC   0(3,R3),CODEAREA                                   L11           
*                                                                               
OESTNUM1 DS    0H                                                               
*                                                                               
         LA    R3,4(R3)                                           L11           
*                                                                               
         CLI   GLARGS,C'C'         DONE IF NUMBER ONLY WANTED                   
         BE    OESTX                                                            
*                                                                               
OEST2    CLC   ESTDATA,0(R2)       SKIP IF NO CHANGE OF ESTIMATE                
         BE    OESTGETX                                                         
*                                                                               
         CLI   09(R2),0            IF SE NUMBER PASSED                          
         BE    *+8                                                              
         ICM   RF,15,PBUTLA        AND UTL ADDRESS KNOWN                        
         BZ    *+16                                                             
         MVC   PAOSESAV,4(RF)         SAVE SE NUMBER                            
         MVC   4(1,RF),09(R2)         SET NEEDED SE NUMBER                      
*                                                                               
         MVC   ESTDATA,0(R2)       YES-GET ESTIMATE RECORD                      
         XC    ESTNAME,ESTNAME     INIT ESTIMATE DATA AREA                      
         XC    ESTNAME2,ESTNAME2                                  L11           
         MVI   ESTBL1,C' '                                                      
         MVI   ESTBL2,C' '                                                      
         XC    ESTDATES,ESTDATES                                                
         MVC   ESTNAME(11),=C'**UNKNOWN**'                                      
         MVC   ESTDATES(11),=C'**UNKNOWN**'                                     
         MVC   ESTFILT,=C'***'                                                  
*                                                                               
         XC    KEY,KEY             ESTABLISH KEYAAREA AS ESTIMATE KEY           
*========              ========*                                                
         LA    R4,KEY                                                           
         USING PESTREC,R4                                                       
*========              ========*                                                
         MVC   PESTKAGY,10(R2)     AGENCY                                       
*                                                                               
         MVC   PESTKMED,PBQMED     MEDIA                                        
*                                                                               
         CLI   PBQMED,C'C'         IF MULTI MEDIA USE PASSED MEDIA              
         BE    *+8                                                              
         CLI   PBQMED,C'*'                                                      
         BNE   *+10                                                             
         MVC   PESTKMED,8(R2)                                   BUG04           
*                                                                               
         MVI   PESTKRCD,PESTKIDQ   RECORD ID                                    
         MVC   PESTKCLT,2(R2)      CLIENT                                       
         MVC   PESTKPRD,5(R2)      PRODUCT                                      
         MVC   PESTKEST,0(R2)      ESTIMATE                                     
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
OESTAGAN CLC   KEY(PESTKEST+2-PESTKEY),KEYSAVE  OKAY IF KEY FOUND               
         BE    OEST6                                                            
*                                                                               
         CLI   5(R2),0             PRODUCT NOT IN KEY-- FIND PRODUCT            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLC   KEY(7),KEYSAVE      MUST MATCH CLIENT                            
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
* ENSURE EST IS LOWER THAN REQUEST                                              
*                                                                               
         CLC   PESTKEST(2),0(R2)                                                
         BE    OEST6                                                            
*                                                                               
         GOTO1 SEQ                 READ NEXT KEY                                
*                                                                               
         B     OESTAGAN                                                         
*                                                                               
OEST6    L     R4,AIO1                                                          
         ST    R4,AIO                                                           
*                                                                               
         GOTO1 GETREC              READ IN ESTIMATE RECORD                      
*                                                                               
         MVC   ESTNAME,PESTNAME    SAVE ESTIMATE DATA                           
         MVC   ESTNAME2,PESTNAM2                                  L11           
         OC    ESTNAME2,SPACES                                    L11           
         MVC   ESTDATES,PESTST                                                  
         MVC   ESTFILT,PESTGRPS                                                 
         MVC   ESTRSCH,PESTRSCH    RETAIL SCHEME                                
*                                                                               
         CLI   PAOSESAV,0          IF SE NUMBER WAS SAVED                       
         BE    *+18                                                             
         L     RF,PBUTLA           RESTORE IT                                   
         MVC   4(1,RF),PAOSESAV                                                 
         MVI   PAOSESAV,0          REST SAVEAREA                                
*                                                                               
OESTGETX CLI   GLARGS,C'D'         ESTIMATE DATES                               
         BNE   OEST10                                                           
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(9),=C'EST DATES'                                        
*                                                                               
         LA    R6,5                DEFAULT TO MMMDD/YY                          
*                                                                               
         TM    PBQPOPT,PBQPOYYM    IF NUMERIC OUTPUT WANTED                     
         BNO   *+8                                                              
         LA    R6,X'20'               RESET OUTPUT DATE FORMAT                  
*                                                                               
         CLI   PBQDTTYP,0          IF OVERRIDE OF OUTPUT DATE TYPE              
         BE    *+8                                                              
         IC    R6,PBQDTTYP            USE IT                                    
*                                                                               
         LA    R4,NAMEAREA         PRINT POSITION                               
*                                                                               
         CHI   R6,X'0020'          IF NUMERIC OUTPUT                            
         BNE   OESTDT3                                                          
*                                                                               
         TM    PBQPOPT,PBQPOCTY    AND CENTURY INCLUDED                         
         BNO   OESTDT3                                                          
*                                                                               
         LA    R6,20(R6)              RESET OUPUT DATE TYPE                     
*                                                                               
OESTDT3  DS    0H                                                               
*                                                                               
         L     RF,DATCON                                                        
         GOTO1 (RF),DMCB,(0,ESTST),((R6),0(R4))                                 
*                                                                               
         TM    PBQPOPT,PBQPOYYM+PBQPOCTY IF YYMMD W/O CENTURY                   
         BNM   *+16                                                             
         MVI   6(R4),C'-'                                                       
         LA    R4,7(R4)                                                         
         B     OESTDT4                                                          
*                                                                               
         MVI   8(R4),C'-'                                                       
         LA    R4,9(R4)                                                         
*                                                                               
OESTDT4  DS    0H                                                               
*                                                                               
         L     RF,DATCON                                                        
         GOTO1 (RF),DMCB,(0,ESTND),((R6),(R4))                                  
         B     OESTX                                                            
*                                                                               
OEST10   CLI   GLARGS,C'F'         ESTIMATE FILTER                              
         BNE   OEST11                                                           
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(10),=C'EST FILTER'                        L05           
         MVC   CODEAREA(3),ESTFILT                             L05              
         CLI   CODEAREA,C' '                                      BUG06         
         BH    *+8                                                BUG06         
         MVI   CODEAREA,C'*'                                      BUG03         
         CLI   CODEAREA+1,C' '                                    BUG06         
         BH    *+8                                                BUG06         
         MVI   CODEAREA+1,C'*'                                    BUG03         
         CLI   CODEAREA+2,C' '                                    BUG06         
         BH    *+8                                                BUG06         
         MVI   CODEAREA+2,C'*'                                    BUG03         
         B     OESTX                                              L05           
*                                                                               
OEST11   CLI   GLARGS,C'N'         INCLUDE NAME                                 
         BE    *+12                                                             
         CLI   GLARGS,C'B'                                                      
         BNE   OESTNMX                                                          
*                                                                               
         CLI   MYLTYP,C'P'         DETAIL LINE                    L11           
         BNE   OEST1LN                                            L11           
         TM    PBQPOPT,PBQPOCUT                                                 
         BO    OEST1LN                                                          
*                                                                               
         LR    RF,R3               CURRENT LINE POINTER                         
*                                                                               
         CLI   GLARGS+1,C' '       IF FIRST LINE OF NAME NEEDED                 
         BNH   OEST12                                                           
         CLI   GLARGS+1,C'1'       IF FIRST LINE OF NAME NEEDED                 
         BNE   OEST13                                                           
*                                                                               
OEST12   DS    0H                                                               
*                                                                               
         MVC   0(20,RF),ESTNAME       PRINT FIRST LINE OF NAME                  
         LA    RF,198(RF)             BUMP TO NEXT PRINT LINE                   
*                                                                               
OEST13   DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C' '       IF SECOND LINE OF NAME NEEDED                
         BNH   OEST14                                                           
         CLI   GLARGS+1,C'2'       IF SECOND LINE OF NAME NEEDED                
         BNE   OEST15                                                           
*                                                                               
OEST14   DS    0H                                                               
*                                                                               
         MVC   0(20,RF),ESTNAME2      PRINT SECOND LINE OF NAME                 
*                                                                               
OEST15   DS    0H                                                               
*                                                                               
         B     OESTXIT                                            L11           
*                                                                               
OEST1LN  DS    0H                                                 L11           
*                                                                               
         MVC   WORK(45),SPACES                                    L11           
*                                                                               
         LA    RF,WORK             START OF ESTIMATE NAME WORKAREA              
*                                                                               
         CLI   GLARGS+1,C' '       IF FIRST LINE OF NAME NEEDED                 
         BNH   OEST1L2                                                          
         CLI   GLARGS+1,C'1'       IF FIRST LINE OF NAME NEEDED                 
         BNE   OEST1L3                                                          
*                                                                               
OEST1L2  DS    0H                                                               
*                                                                               
         MVC   0(20,RF),ESTNAME       PRINT FIRST LINE OF NAME                  
         LA    RF,21(RF)              BUMP TO NEXT PART OF WORKAREA             
*                                                                               
OEST1L3  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C' '       IF SECOND LINE OF NAME NEEDED                
         BNH   OEST1L4                                                          
         CLI   GLARGS+1,C'2'       IF SECOND LINE OF NAME NEEDED                
         BNE   OEST1L5                                                          
*                                                                               
OEST1L4  DS    0H                                                               
*                                                                               
         MVC   0(20,RF),ESTNAME2      PRINT SECOND LINE OF NAME                 
*                                                                               
OEST1L5  DS    0H                                                               
*                                                                               
         L     RF,SQUASHER                                        L11           
         CLI   MYLTYP,C'M'                                        L11           
         BNE   OESTMIDN                                           L11           
*                                                                               
         MVC   0(41,R3),WORK                                      L11           
*                                                                               
         B     OESTXIT                                            L11           
*                                                                               
OESTMIDN GOTO1 (RF),DMCB,WORK,42                                  L11           
*                                                                               
         MVC   NAMEAREA,WORK                                                    
*                                                                               
         B     OESTX                                                            
*                                                                               
OESTNMX  DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'R'         RETAIL SCHEME CODE                           
         BNE   OESTRTLN                                                         
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(13),=C'RETAIL SCHEME'                                   
         MVC   CODEAREA(2),ESTRSCH RETAIL SCHEME CODE                           
*                                                                               
         B     OESTX                                                            
*                                                                               
OESTRTLN DS    0H                                                               
*                                                                               
OESTX    DS    0H                                                               
         B     AGENOUT                                                          
*                                                                               
OESTXIT  DS    0H                                                               
         B     COMEXIT                                                          
*                                                                               
AGENOUT  LA    R1,32                                                            
         XIT1  REGS=(R1)                                                        
*        ========  *                                                            
         DROP  R4                                                               
*        ========  *                                                            
*                                                                               
*================ PAID DATA =========================================           
*                                                                               
OPAYM    ZAP   COLLECT1,=P'0'                                                   
         ZAP   DUBB,=P'0'          INIT WORKAREA                                
         ZAP   OBILLCTR,=P'0'      INIT ITEM CTR                                
*                                                                               
OPAYAGN  OC    0(3,R2),0(R2)                                                    
         BZ    OPAYED                                                           
         L     RF,DATCON                                                        
         GOTO1 (RF),DMCB,(3,0(R2)),(8,0(R3))                                    
         L     RF,3(R2)                  AMOUNT                                 
         CVD   RF,DUBB                                                          
         AP    COLLECT1,DUBB(8)                                                 
         EDIT  (B4,3(R2)),(12,16(R3)),2,COMMAS=YES,MINUS=YES                    
         TM    7(R2),X'40'       IS THIS A CREDIT                               
         BNO   SEEIFCKA            NO                                           
         MVC   28(2,R3),=C'CR'                                                  
         TM    3(R2),X'80'         NEGATIVE NUMBER                              
         BO    *+10                                                             
         MVC   27(3,R3),=C'CR '                                                 
         B     NOCRED                                                           
SEEIFCKA TM    7(R2),X'80'       IS THIS A CK  RETURN                           
         BNO   NOCRED              NO                                           
         MVC   28(2,R3),=C'CK'                                                  
         TM    3(R2),X'80'         NEGATIVE NUMBER                              
         BO    *+10                                                             
         MVC   27(3,R3),=C'CK '                                                 
NOCRED   NI    7(R2),X'3F'         REMOVE 8 AND 4 BITS                          
         EDIT  (B2,7(R2)),(5,9(R3)) REP                                         
*                                                                               
         AP    OBILLCTR,=P'1'            BUMP PAYMENT COUNTER                   
         LA    R3,198(R3)                 NEXT LINE                             
         LA    R2,10(R2)                   NEXT ELEMENT                         
         B     OPAYAGN                                                          
*                                                                               
OPAYED   DS    0H                                                               
*                                                                               
         CP    OBILLCTR,=P'1'      SKIP IF AT MOST ONE PAYMENT                  
         BNH   OPAYEDA                                                          
*                                                                               
         EDIT  (P8,COLLECT1),(12,16(R3)),2,COMMAS=YES,MINUS=YES                 
         MVC   7(6,R3),=C'*---->'                                               
*                                                                               
OPAYEDA  CLI   9(R2),FF          MORE THAN 14 ELEMENTS                          
         BNE   COMEXIT                                                          
         MVC   0(08,R3),=C'**MORE**' MORE THAN 14                               
         B     COMEXIT                                                          
*                                                                               
*-------------->     BILLED DATA       ====================                     
*                                                                               
OBILL    ZAP   COLLECT1,=P'0'      INIT TOTAL BUCKET                            
         ZAP   DUBB,=P'0'          INIT WORKAREA                                
         ZAP   OBILLCTR,=P'0'      INIT BILL COUNTER                            
*                                                                               
         CLI   GLARGS,C'X'         SKIP IF NOT TESTING                          
         BNE   OBILL1                                                           
*                                                                               
         MVC   OBILLMED,220(R2)    SAVE MEDIA                                   
         MVC   OBILLCLT,221(R2)    SAVE CLIENT                                  
*                                                                               
         B     OBILLEA                                                          
*                                                                               
OBILL1   DS    0H                                                               
*                                                                               
         MVC   OBILLMED,154(R2)    SAVE MEDIA                                   
         MVC   OBILLCLT,155(R2)    SAVE CLIENT                                  
*                                                                               
OBILLEA  OC    0(3,R2),0(R2)                                                    
         BZ    OBILLEB                                                          
*                                                                               
         CLC   0(4,R2),OBILLMED    END OF BUCKETS                               
         BE    OBILLEB                                                          
*                                                                               
         L     RF,DATCON                                                        
         GOTO1 (RF),DMCB,(3,0(R2)),(8,0(R3))                                    
*                                                                               
         GOTO1 =A(BLDINV),DMCB,(R2),9(R3),OBILLMED GENERATE INVOICE NO          
*                                                                               
         L     RF,6(R2)                  AMOUNT                                 
         CVD   RF,DUBB                                                          
*                                                                               
         AP    COLLECT1,DUBB(8)                                                 
*                                                                               
         EDIT  (B4,6(R2)),(12,17(R3)),2,COMMAS=YES,MINUS=YES                    
*                                                                               
         TM    5(R2),X'01'           REBATE                                     
         BNO   *+10                                                             
         MVC   29(2,R3),=C'RB'     REBATE                                       
*                                                                               
         AP    OBILLCTR,=P'1'      BUMP BILL COUNTER                            
         LA    R3,198(R3)                 NEXT LINE                             
         LA    R2,11(R2)                   NEXT ELEMENT                         
*                                                                               
         B     OBILLEA                                                          
*                                                                               
OBILLEB  DS    0H                                                               
*                                                                               
         CP    OBILLCTR,=P'1'      SKIP IF AT MOST ONE BILL                     
         BNH   OBILLEZ                                                          
*                                                                               
         EDIT  (P8,COLLECT1),(12,17(R3)),2,COMMAS=YES,MINUS=YES                 
         MVC   7(6,R3),=C'*---->'                                               
*                                                                               
OBILLEZ  CLI   10(R2),FF          MORE THAN 20 ELEMENTS                         
         BNE   COMEXIT                                                          
*                                                                               
         MVC   0(8,R3),=C'**MORE**' MORE THAN 20                                
*                                                                               
COMEXIT  XMOD1 1                                                                
         DS     0D                                                              
DUBB     DC    PL8'0'                                                           
OBILLMED DS    CL1                 MEDIA                                        
OBILLCLT DS    CL3                 CLIENT                                       
OBILLCTR DS    PL2                 BILL COUNTER                                 
         SPACE 3                                                                
*                                                                               
*-------------->     LAST I/O IN USE ================================           
*                                                                               
ILASTA1  DS    0H                                                               
*========              ========*                                                
         L     R6,AIO1                BUY RECORD                                
         USING PBUYRECD,R6                                                      
*========              ========*                                                
         CLC   PBDJOB,SPACES             IF NO ADCODE // NO LAST                
         BNH   COMEXIT                   AD USE                                 
*                                                                               
*========              ========*                                                
         L     R5,4(R1)               SECOND WORD OF CALLING PGM HAS            
         USING LASTIOD,R5             ADDRESS OF IOAREA                         
*========              ========*                                                
         MVC   SVADCD,PBDJOB             SAVE THIS JOBCODE                      
         MVC   SAVKEYS,IOKEYSVE          SAVE ORIGINAL DIR PTR                  
         MVC   SKPUB(17),PBDSPACE        USING SKPUB TO SAVE PBDSPACE           
         XC    SVLSTDAT,SVLSTDAT         CLEAR LAST INSERT DATE                 
         MVI   MLTREC,0                  INIT SWITCH                            
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY(14),PBUYREC           FORCE TO READ FIRST BUY FOR            
* BUY-IO READ BUY DIR                     THIS CLI/PROD/PUB == NO EDITN         
         GOTO1 HIGH                         READ DIRECTORY                      
ILASTA   CLC   KEY(14),KEYSAVE           SAME CLI,PRD,PUB                       
         BNE   ILASTR                     FINISH UP // CHANGE IN KEY            
         TM    KEY+25,X'80'              BYPASS DELETES                         
         BO    ILASTC                      READ SEQ                             
         L     R0,RCWORK                 IF PASSED ALL THESE TESTS GET          
         ST    R0,AIO                    BUYREC                                 
* BUY-IO READ BUY REC                                                           
         GOTO1 GETREC                     READ BUY INTO WORKAREA                
         L     R6,RCWORK                                                        
         CLC   SVADCD,PBDJOB             IF ADCODE NOT SAME SKIP AND            
         BNE   ILASTC                    GET NEXT                               
*                                                                               
         CLI   PBDSPACE,X'FF'      IF NOT OUTDOOR SPACE                         
         BE    *+10                                                             
         OC    PBDSPACE,SPACES        MAKE UPPERCASE                            
*                                                                               
         CLI   GLARGS+1,C'R'       SKIP SPACE CHECK FOR REPEAT USE              
         BE    ILASTF                                                           
*                                                                               
         LA    RF,7                      ENSURE SPACE IS THE SAME FOR           
         CLI   PBUYKMED,C'N'              BUY JUST READ IN AND ORIGINAL         
         BE    ILASTA5                                                          
         LA    RF,16                                                            
ILASTA5  EX    RF,ILASTEX                                                       
         BNE   ILASTC             IF SPACE NOT EQUAL READ NEXT BUY              
         B     ILASTF               CONTINUE CHECKING                           
ILASTEX  CLC   SKPUB(0),PBDSPACE         USED SKPUB TO SAVE PBDSPACE            
* BUY-IO READ SEQUENTIAL                                                        
ILASTC   GOTO1 SEQ                                                              
         B     ILASTA                                                           
*                                                                               
ILASTD   GOTO1 SEQ                                                              
         CLC   KEY(14),KEYSAVE           SAME CLI,PRD,PUB                       
         BNE   ILASTR                                                           
         TM    KEY+25,X'80'              BYPASS DELETES                         
         BO    ILASTD                                                           
         L     R0,RCWORK                 IF PASSED ALL THESE TESTS GET          
         ST    R0,AIO                    BUYREC                                 
* BUY-IO READ BUY RECORD                                                        
         GOTO1 GETREC                                                           
         CLC   SVADCD,PBDJOB             IF ADCODE NOT SAME SKIP AND            
         BNE   ILASTD                    GET NEXT                               
         MVI   MLTREC,C'Y'                                                      
*                                                                               
         CLI   GLARGS+1,C'R'       SKIP SPACE CHECK FOR REPEAT USE              
         BE    ILASTF                                                           
*                                                                               
         CLI   PBDSPACE,X'FF'      IF NOT OUTDOOR SPACE                         
         BE    *+10                                                             
         OC    PBDSPACE,SPACES        MAKE UPPERCASE                            
*                                                                               
         LA    RF,7                                                             
         CLI   PBUYKMED,C'N'                                                    
         BE    ILASTD5                                                          
         LA    RF,16                                                            
ILASTD5  EX    RF,ILASTEX                                                       
         BNE   ILASTD                                                           
*                                                                               
*                                                                               
ILASTF   CLC   PBUYKDAT,SAVKEYS+16       THIS ID WITH ORIGINAL BUY              
         BNL   ILASTD                     IF EQUAL OR HIGH BYPASS               
         CLC   SVLSTDAT,PBUYKDAT     LAST SAVED ID WITH THIS BUY                
         BH    ILASTD                   IF HIGH BYPASS                          
ILASTJ   MVC   SVLSTDAT,PBUYKDAT      MOVE THIS ID WHICH IS LOWER THAN          
         B     ILASTD                 ORIGINAL BUY'S ID                         
*                                                                               
ILASTR   DS    0H           CHANGE IN KEY                                       
         CLI   MLTREC,C'Y'                                                      
         BE    ILASTS                                                           
ILASTR5  DS    0H                                                               
         MVC   0(3,R2),=X'000001'  BRAND NEW AD                                 
*******  MVC   0(3,R2),=C'NEW'                                                  
         B     ILASTX                                                           
ILASTS   CLC   SVLSTDAT,SAVKEYS+16                                              
         BE    ILASTR5                                                          
         OC    SVLSTDAT,SVLSTDAT                                                
         BZ    ILASTR5                                                          
         L     RF,DATCON                                                        
         GOTO1 (RF),DMCB,(3,SVLSTDAT),(3,0(R2))                                 
ILASTX   MVC   KEY(25),SAVKEYS         RESTORE POINTER                          
         OI    DMINBTS,X'08'     PASS BACK DELETED RECORDS       BUG11          
         GOTO1 HIGH                                                             
         B     COMEXIT                                                          
*        ========  *                                                            
         DROP  R5,R6                                                            
*        ========  *                                                            
*                                                                               
GETGSTSW DC    X'0'                                                             
SAVER1X  DS    F                                                                
GTGSTTAX DS    F                                                                
*                                                                               
*-------------->    CALCULATE BILL/PAYMENT $ FOR ELEMENT ===                    
*                                                                               
WHATDOL  DS    0H                                                               
*                                                                               
         XC    GTGSTTAX,GTGSTTAX   INIT GST TOTAL                               
*                                                                               
         L     RF,8(R1)            POINTS TO BILL/PAY TYPE                      
*                                                                               
         MVC   GETGSTSW,0(RF)      SAVE PAY/BILL INDICATOR                      
*                                                                               
         L     RF,4(R1)                                                         
         MVC   WORK(12),0(RF)      SAVE BUY GROSS,COMMISSION,CD                 
*                                                                               
         LM    R2,R4,0(RF)         GROSS/COMMIS/CD                              
*                                                                               
         TM    GLARGS+5,X'3'       INCLUDE GST                                  
         BM    *+12                YES                                          
         CLI   PBQADDGS,C'O'        INCLUDE GST                                 
         BNE   NOTGST                                                           
*                                                                               
         BAS   RE,GETGST           CALCULATE GST                                
*                                                                               
NOTGST   CLI   GLARGS+1,C'1'  GROSS REQUESTED                                   
         BNE   NOTG1                                                            
*                                                                               
         A     R2,GTGSTTAX                                                      
*                                                                               
         B     SAVEDOL                                                          
*                                                                               
NOTG1    CLI   GLARGS+1,C'2'       GROSS-CD                                     
         BNE   NOTG2                                                            
*                                                                               
         SR    R2,R4                                                            
         A     R2,GTGSTTAX                                                      
*                                                                               
         B     SAVEDOL                                                          
*                                                                               
NOTG2    CLI   GLARGS+1,C'3'       NET-CD                                       
         BNE   NOTG3                                                            
*                                                                               
         SR    R2,R3               GROSS-COMM                                   
         SR    R2,R4               RESULT - CD                                  
         A     R2,GTGSTTAX                                                      
*                                                                               
         B     SAVEDOL                                                          
*                                                                               
NOTG3    CLI   GLARGS+1,C'4'       NET                                          
         BNE   NOTG4                                                            
*                                                                               
         SR    R2,R3               GROSS-COMM                                   
         A     R2,GTGSTTAX                                                      
         B     SAVEDOL                                                          
*                                                                               
NOTG4    CLI   GLARGS+1,C'5'       CD                                           
         BNE   NOTG5                                                            
*                                                                               
         LR    R2,R4               CASH DISCOUNT                                
         B     SAVEDOL                                                          
*                                                                               
NOTG5    CLI   GLARGS+1,C'6'       COMMISSION                                   
         BNE   BOMB                                                             
*                                                                               
         L     R5,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R5                                                      
*                                                                               
         CLI   PBDCOSIN,C'C'      IF NOT COMMISSION ONLY BUY                    
         BE    *+10                                                             
         LR    R2,R3               CALCULATE COMMISSION AS USUAL                
         B     SAVEDOL                                                          
*                                                                               
         LR    R6,R1               SAVE OUTPUT POINTER                          
*                                  ELSE                                         
*                           ALTER AGYCOM FROM BILL/PAY ELEM                     
*                           TO REFLECT PBDACP - FOR SPECIAL                     
*                           HANDLING OF 'C' RATE BUYS                           
         SR    R0,R0                                                            
         ZAP   DUB,PBDACP       AC=0.0                                          
         BZ    FIXACX5                                                          
         CVB   R0,DUB                                                           
         LR    R1,R2            GROSS FROM BILL/PAY ELEM                        
         L     RF,=F'100000'                                                    
         SR    RF,R0                                                            
         MR    RE,R1                                                            
         SLDL  RE,1                                                             
         D     RE,=F'100000'                                                    
         LTR   RF,RF                                                            
         BM    *+8                                                              
         AHI   RF,1                                                             
         SRA   RF,1                RF=NET                                       
*                                                                               
FIXACX   DS    0H                                                               
         LR    R0,R1                                                            
         SR    R0,RF                                                            
FIXACX5  LR    R2,R0              STORE 'FIXED' BILL/PAY AGYCOM                 
         LR    R1,R6               RESTORE OUTPUT POINTER                       
*                                                                               
SAVEDOL  ST    R2,0(R1)       MOVE GROSS                                        
         XIT1                                                                   
*                                                                               
BOMB     DC    H'0'                                                             
*                                                                               
         DROP  R5                                                               
*                                                                               
         TITLE 'PROCESS LINES'                                                  
*                                                                               
*-------------->     LOOK FOR LINES ENTRY     ===============                   
*                                                                               
GETLINES MVC   ADDEBLOK,4(R1)                                                   
         ICM   RF,15,INCHFILD HAS INCH ENTRY BEEN FOUND                         
         BNZ   LOADINCH                                                         
*========              ========*                                                
         L     RF,GLADTAB          START SEARCH FROM BEGINING OF DRIVE          
         USING DRIND,RF            TABLE --                                     
*========              ========*                                                
CLI20    CLI   0(RF),0             END                                          
         BNE   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         CLI   0(RF),X'20'                                                      
         BE    YIS20               FOUND INPUT                                  
ZIC1F    ZIC   RE,1(RF)            BUMP TO NEXT ELEMENT                         
         AR    RF,RE                                                            
         B     CLI20                                                            
*                                                                               
YIS20    CLC   DRINROUT,=C'INCHLINE' INCH ENTRY                                 
         BNE   ZIC1F                                                            
         MVC   SPADISPL,DRINDISP   SAVE INCH DISPLACEMENT                       
*                                                                               
* DETERMINE WHERE INCH DATA FIELDS ARE                                          
*                                                                               
FNDINC   L     R5,GLAIO             DRIVER IO AREA (OUTPUT RECORDS)             
         XR    R1,R1                                                            
         LH    R1,DRINDISP          CONTRACT DISPLACEMENT                       
         AR    R5,R1               POINT TO INCH FIELDS                         
         ST    R5,INCHFILD         SAVE INCH FIELD ADDRESS                      
*                                                                               
*  THIS IS NEEDED TO FIND INCH TOTALS WHEN THERE IS A BREAK ON CONTRACT         
*                                                                               
LOADINCH L     RF,INCHFILD                                                      
* 4/16/90TM    PBQSPLOP,X'80'     READING BUYS BY CONTRACT                      
* 4/16/90BNO   COMEXIT             DO NOT PRINT TOTALS FOR INDIVIDUAL           
*                                   LINES WHEN BUY DRIVEN                       
         LR    R5,RF               ENSURE BOTH ARE SAME                         
GETEDIT  CP    16(8,RF),=P'0'      COUNT                                        
         BE    COMEXIT                                                          
         ZAP   WORK(16),24(8,R5)   TYPE REQUEST                                 
         DP    WORK(16),18(6,R5)   ELIMINATE ITERATION                          
         ZAP   24(8,R5),WORK(10)                                                
         L     RF,ADDEBLOK                                                      
         XC    0(24,RF),0(RF)      CLEAR EBLOCK                                 
         LA    R1,WORK                                                          
         ST    R1,8(RF)            ADDRESS OF WORK                              
         ST    R5,0(RF)            INPUT                                        
         MVC   4(2,RF),=X'08D7'    LEN=8 PS                                     
         MVC   12(2,RF),=X'0B02'   OUTLEN =11 DECIMALS =2                       
         MVI   22(RF),C'I'                                                      
         GOTO1 GLAEDITR,DMCB,(RF)                                               
*   EDIT LINES                                                                  
         L     RF,ADDEBLOK                                                      
         XC    0(24,RF),0(RF)      CLEAR EBLOCK                                 
         LA    R1,WORK+11                                                       
         ST    R1,8(RF)            ADDRESS OF WORK                              
         LA    RE,8(R5)            POINT TO LINES                               
         ST    RE,0(RF)            INPUT                                        
         MVC   4(2,RF),=X'08D7'    LEN=8 PS                                     
         MVI   12(RF),8            OUTLEN =8                                    
         MVI   22(RF),C'L'                                                      
         GOTO1 GLAEDITR,DMCB,(RF)                                               
         CP    30(2,R5),=P'1'      INCHES ONLY                                  
         BNE   GPFLINE                                                          
*        MVC   1(10,R6),WORK+1                                                  
         MVC   LINEDES+1(10),WORK+1                                             
GPALL    TM    GLINDS,X'60'                                                     
         BM    *+8                                                              
         B     COMEXIT                                                          
GPFLINE  CP    30(2,R5),=P'2'      LINES ONLY                                   
         BNE   *+14                                                             
         MVC   LINEDES+1(8),WORK+11                                             
         B     GPALL                                                            
         MVC   LINEDES+1(20),WORK+2                                             
         B     COMEXIT                                                          
*                                                                               
*-------------->   FIND LINE TOTAL ENTRY   =================                    
*                                                                               
GETLITOT DS    0H                   RECORD POINTER                              
         MVC   ADDEBLOK,4(R1)                                                   
         ICM   RF,15,INCHFILD HAS INCH ENTRY BEEN FOUND                         
         BNZ   GETLTOTA                                                         
*========              ========*                                                
         L     RF,GLADTAB          START SEARCH FROM BEGINING OF DRIVE          
         USING DRIND,RF            TABLE --                                     
*========              ========*                                                
CLI20AA  CLI   0(RF),0             END                                          
         BE    COMEXIT             MUST FIND INCH ENTRY           BUG03         
         CLI   0(RF),X'20'                                                      
         BE    YIS20AA             FOUND INPUT                                  
ZIC1FAA  ZIC   RE,1(RF)            BUMP TO NEXT ELEMENT                         
         AR    RF,RE                                                            
         B     CLI20AA                                                          
*                                                                               
YIS20AA  CLC   DRINROUT,=C'INCHLINE' INCH ENTRY                                 
         BNE   ZIC1FAA                                                          
         MVC   SPADISPL,DRINDISP   SAVE INCH DISPLACEMENT                       
*                                                                               
*  THE PURPOSE OF THIS IS TO GET TO THE TOTAL RECORD FOR THIS                   
*   LEVEL.  ONCE DONE THE DISPLACEMENT TO THE INCH TOTAL IS ADDED               
* TO GET TO THE PROPER ACCUMULATOR                                              
*                                                                               
*========              ========*                                                
GETLTOTA L     RE,GLATHID                                                       
         USING GLINTD,RE                                                        
         L     R2,GLAFOUT                                                       
         USING DROD,R2                                                          
*========              ========*                                                
         ZIC   R1,GLLEVEL                                                       
         SLL   R1,2 MULT X 4                                                    
         LA    R1,GLARECL0(R1)                                                  
         L     RF,0(R1)                                                         
*        ========  *                                                            
         DROP  R2,RE,RF                                                         
*        ========  *                                                            
*****                                                                           
         AH    RF,SPADISPL          DISPLACEMENT TO INCH                        
         LR    R5,RF                                                            
         B     GETEDIT                                                          
         TITLE 'CONVERT DATE TO PERIOD'                                         
****                                                                            
*                                                                               
*--------------->    CONVERT DATE TO PERIOD==========================           
*                                                                               
*========              ========*                                                
CONVDATE L     R5,PDADATES                                                      
         USING DATELSTD,R5                                                      
*========              ========*                                                
         OC    0(3,R2),0(R2)         ANY DATE PRESENT                           
         BZ    COMEXIT                NONE -- GET OUT                           
         LA    R1,1                                                             
         LA    R3,WEEKLIST                                                      
         CLI   GLARGS+15,C'W'                                                   
         BE    CWEEKS                                                           
         LA    R3,MNTHLIST                                                      
         CLI   GLARGS+15,C'M'                                                   
         BE    CWEEKS                                                           
         LA    R3,QURTLIST                                                      
         CLI   GLARGS+15,C'Q'                                                   
         BE    CWEEKS                                                           
         LA    R3,YEARLIST                                                      
         CLI   GLARGS+15,C'Y'                                                   
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
CWEEKS   DS    0H                                                               
*                                                                               
         CLI   GLARGS+15,C'W'      WEEKS NEED TO MATCH FULL DATE.               
         BNE   CMONTHS                                                          
*                                                                               
         CLC   0(3,R2),0(R3)       DATE TO PERIOD TABLE                         
         BE    CHIT                                                             
         BL    PERLOW              TABLE CONSTRUCTED ERRONEOUSLY BUG05          
         CLC   0(3,R2),3(R3)       CHECK END RANGE                              
         BNH   CHIT                FOUND RANGE                                  
         LA    R3,6(R3)                                                         
         LA    R1,1(R1)                                                         
         B     CWEEKS                                                           
*                                                                               
CMONTHS  DS    0H                  MONTHS NEED ONLY MATCH ON MONTHS             
*                                    THE YEAR DOESN'T MATTER                    
         OC    0(3,R3),0(R3)       DONE IF END OF TABLE REACHED                 
         BE    PERLOW                                                           
         CLC   1(2,R2),1(R3)       DATE TO PERIOD TABLE                         
         BE    CHIT                                                             
         BL    *+14                TABLE CONSTRUCTED ERRONEOUSLY BUG05          
         CLC   1(2,R2),3+1(R3)     CHECK END OF RANGE                           
         BNH   CHIT                FOUND RANGE                                  
*                                                                               
         LA    R3,6(R3)                                                         
         LA    R1,1(R1)                                                         
         B     CMONTHS                                                          
*                                                                               
PERLOW   MVI   2(R2),X'0'          CLEAR DAY                      BUG05         
         B     CHITA                                              BUG05         
*                                                                               
CHIT     MVC   1(2,R2),1(R3)       ONLY MOVE MONTH AND DAY                      
CHITA    XC    3(6,R2),3(R2)    CLEAR OUT DATA FOR INSERT DATE                  
         B     COMEXIT                                                          
*******                                                                         
*******                                                                         
GETELL   LA    R6,33(R6)                                                        
         B     NXTLLA                                                           
*                                                                               
NXTELL   DS    0H                                                               
         SR    R0,R0                                                            
         IC    R0,1(R6)                                                         
         AR    R6,R0                                                            
NXTLLA   CLI   0(R6),0                                                          
         BE    NXTELLX1                                                         
         CLC   ELCODE,0(R6)                                                     
         BER   RE                                                               
         B     NXTELL                                                           
NXTELLX1 LTR   R6,R6                                                            
         BR    RE                                                               
         LTORG                                                                  
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
RCWORK   DS    F                                                                
ADDEBLOK DS    F                                                                
SPADISPL DS    H                   DISPLACEMENT TO INCH                         
INCHFILD DC    F'0'                ADDRESS OF INCH DATA                         
INCHADD  DC    F'0'                ADDRESS OF INCH ENTRY                        
COLLECT1 DC    PL8'0'                                                           
COLLPUB  DC    5PL8'0'                                                          
COLLREQ  DC    5PL8'0'                                                          
SAVER1A  DS    F                                                                
*                                                                               
         TITLE 'PRWRITER - GET B1X PROFILE - B1XGET'                            
***********************************************************************         
*                                                                     *         
*        ROUTINE TO GET B1X PROFILE                                   *         
*                                                                     *         
*NTRY P1  -  A(B1X PROFILE AREA)                                      *         
*                                                                     *         
*EXIT    B1X PROFILE                                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
B1XGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVC   BXGDMCB,0(R1)       SAVE INPUT PARAMETERS                        
         ST    R1,BXGREG1S         SAVE PARAMETER REGISTER                      
*                                                                               
*        READ B1X PROFILE                                                       
*                                                                               
         XC    BXGWRK,BXGWRK       PARAMETERS FOR GETPROF                       
*                                                                               
         MVC   BXGWRK(4),=C'PB1X'  B1X PROFILE                                  
         NI    BXGWRK,X'FF'-X'40'  MAKE SYSTEM LOWERCASE                        
         MVC   BXGWRK+4(2),PBQAGY  AGENCY                                       
         MVC   BXGWRK+6(1),PBMED   MEDIA                                        
         MVC   BXGWRK+7(3),PBCLT   CLIENT                                       
*                                                                               
*        CHECK IF OFFICE KNOWN                                                  
*                                                                               
         CLI   PBQCLT,C'*'         IF REQUESTED BY OFFICE                       
         BNE   *+14                                                             
         MVC   BXGWRK+11(1),PBQCLT+1       USE IT                               
         B     BXGOF9                                                           
*                                                                               
         CLI   PBCOFF,C' '        IF CLIENT OFFICE KNOWN USE IT                 
         BNH   *+10                                                             
         MVC   BXGWRK+11(1),PBCOFF       CLIENT OFFICE CODE                     
*                                                                               
         CLI   PBQSLAVE,C'Y'        IF DOING SLAVES                             
         BNE   BXGDTSLX                                                         
*                                                                               
         ICM   RF,15,PBCLTADR     POINT TO CLIENT RECORD                        
         BZ    BXGDTSLX              NOT KNOWN                                  
*                                                                               
         USING PCLTRECD,RF                                                      
*                                                                               
         CLI   PCLTOFF,C' '       IF CLIENT OFFICE KNOWN                        
         BNH   *+10                  USE IT                                     
         MVC   BXGWRK+11(1),PCLTOFF       SLAVE OFFICE CODE                     
*                                                                               
         DROP  RF                                                               
*                                                                               
BXGDTSLX DS    0H                                                               
*                                                                               
BXGOF9   DS    0H                                                               
*                                                                               
         CLI   BXGWRK+11,C' '     IF OFFICE PRESENT                             
         BNH   *+8                                                              
         MVI   BXGWRK+10,C'*'        INDICATE IN PARAMETERS                     
*                                                                               
BXGOFX   DS    0H                                                               
*                                                                               
         CLC   BXGKEY,BXGWRK       SKIP IF PROFILE ALREADY IN CORE              
         BE    BXGRDX                                                           
*                                                                               
         MVC   BXGKEY,BXGWRK       SAVE PROFILE                                 
*                                                                               
         XC    BXGPRO,BXGPRO       SPECIAL BILLING PROFILE                      
*                                                                               
         GOTO1 GETPROF,DMCB,BXGWRK,BXGPRO,DATAMGR                               
*                                                                               
BXGRDX   DS    0H                                                               
*                                                                               
*                                                                               
B1XGETX  DS    0H                                                               
*                                                                               
         L     R1,BXGREG1S         RE-POINT TO RETURN AREA                      
         L     R2,0(R1)                                                         
         MVC   0(L'BXGPRO,R2),BXGPRO  RETURN BILLING PROFILE                    
*                                                                               
         XIT1  ,                                                                
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
BXGWRK   DS    XL32                WORKAREA                                     
BXGREG1S DS    F                   PARAMETER LIST POINTER SAVE                  
BXGDMCB  DS    XL24                PARAMETER LIST SAVEAREA                      
BXGPRO   DS    XL16                BILLING 1X PROFILE                           
BXGKEY   DS    CL12                BILLING 1 PROFILE KEY (AGY/MEDIA)            
*                                                                               
         TITLE 'PRWRITER - GET BILL FORMULA - BFMGET'                           
***********************************************************************         
*                                                                     *         
*        ROUTINE TO GET BILL FORMAULA FROM BFORM RECORDS              *         
*                                                                     *         
*NTRY P1  -  A(BILL FORMULA)                                          *         
*                                                                     *         
*EXIT    BILL FORMULA                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
BFMGET   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVC   BFMDMCB,0(R1)       SAVE INPUT PARAMETERS                        
         ST    R1,BFMREG1S         SAVE PARAMETER REGISTER                      
*                                                                               
         OC    PBLOADER,PBLOADER   SKIP IF LOADER ADDRESS KNOWN                 
         BNZ   BFMGET10                                                         
*                                                                               
         L     RF,ATWA             POINT TO TWA                                 
         L     RF,TWAMASTC-TWATASK(RF) POINT TO MASTC                           
*                                                                               
         MVC   PBLOADER,MCVLOADR-MASTD(RF)  A(LOADER)                           
*                                                                               
BFMGET10 DS    0H                                                               
*                                                                               
         LA    R2,BFMFRMC          ESTABLISH PPGETBFR CONTROL BLOCK             
         USING PPGBFRDD,R2                                                      
*                                                                               
         XC    PPGBFORM,PPGBFORM   INIT BILL FORMULA                            
*                                                                               
         L     R4,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYREC,R4                                                       
*                                                                               
         CLI   PBUYKRCD,X'20'      MUST HAVE BUY RECORD                         
         BNE   BFMGETX                                                          
*                                                                               
*        MAKE SURE THERE IS A BILL FORMULA RECORD FOR CLIENT                    
*                                                                               
         XC    KEY,KEY                                                          
         LA    R6,KEY              ESTABLISH BFORM KEY                          
         USING PBFKEY,R6                                                        
*                                                                               
         MVC   PBFKAGY,PBUYKAGY    SET AGENCY                                   
         MVC   PBFKMED,PBUYKMED    SET MEDIA                                    
         MVI   PBFKTYPE,PBFKTYPQ   SET RECORD TYPE                              
         MVC   PBFKCLT,PBUYKCLT    SET CLIENT                                   
*                                                                               
         NI    DMINBTS,X'FF'-X'80'   SKIP DELETED RECORDS                       
*                                                                               
*        READ FOR FIRST BFORM RECORD FOR CLIENT                                 
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   PBFKEY(PBFKPRD-PBFKEY),KEYSAVE SKIP IF NONE FOUND                
         BNE   BFMGETX                                                          
*                                                                               
         DROP  R6                                                               
*                                                                               
         MVC   PPGBAGY,PBUYKAGY    AGENCY                                       
         MVC   PPGBMED,PBUYKMED    MEDIA                                        
         MVC   PPGBCLT,PBUYKCLT    CLIENT                                       
         MVC   PPGBPRD,PBUYKPRD    PRODUCT                                      
*                                                                               
         CLC   PPGBPRD,=C'ZZZ'     IF POOL PRODUCT                              
         BNE   *+10                                                             
         MVC   PPGBPRD,PBPROD         USE CURRENT PRODUCT                       
*                                                                               
         MVC   PPGBEST,PBUYKEST    ESTIMATE                                     
         MVC   PPGBMOS,PBDBDATE    MONTH OF SERVICE FROM BLB DATE               
*                                                                               
         MVC   PPGBACOM,PBCOMFAC   A(COMFACS)                                   
         MVC   PPGBLODR,PBLOADER   A(LOADER)                                    
*                                                                               
         GOTO1 =V(PPGETBFR),DMCB,PPGBFRDD GET BILL FORMULA                      
*                                                                               
BFMGETX  DS    0H                                                               
*                                                                               
         L     R1,BFMREG1S         RE-POINT TO RETURN AREA                      
         L     RF,0(R1)                                                         
         MVC   0(L'BILPROFS,RF),PPGBFORM  RETURN BILLING FORMULA                
         OC    0(L'BILPROFS,RF),0(RF) IF NO FORMULA FOUND                       
         BNZ   *+10                                                             
         MVC   0(L'BILPROFS,RF),=X'0505000000'  SET TO G-CD AS DEFAULT          
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE LAST KEY READ                        
         OI    DMINBTS,8         PASS BACK DELETED RECORDS       BUG11          
*                                                                               
         GOTO1 HIGH                RESET FILE POINTERS                          
*                                                                               
         XIT1  ,                                                                
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
BFMREG1S DS    F                   PARAMETER LIST POINTER SAVE                  
BFMDMCB  DS    XL24                PARAMETER LIST SAVEAREA                      
BFMFRMC  DC    XL(PPGBFRDL)'00'    CONTROL BLOCK                                
*                                                                               
         TITLE 'COMMON SUBROUTINES GROUP 2'                                     
*=====================================================                          
COMMON2  CSECT                                                                  
         NMOD1 500,COM2ON,R7                                                    
         PRINT NOGEN                                                            
         SPACE 2                                                                
******                                                                          
** ON ENTRY          WORD 1   BYTE 0                                            
*                                1-3  DISPLACEMENT                              
******                                                                          
         ST    R1,SAVER1A2                                                      
*========              ========*                                                
         USING GLOBALD,RA                                                       
         USING GEND,RC                                                          
         USING SPOOLD,R8                                                        
         USING SYSD,R9                                                          
*========              ========*                                                
         ST    RC,RCWORK2                                                       
         L     RC,GLAWORKD     INITIALIZE RC                                    
         SPACE 2                                                                
         L     RF,0(R1)                                                         
         LA    RE,TABLEI2                                                       
         B     0(RF,RE)                                                         
*                                                                               
RTOOPUBN EQU  PROPUBNA-*                                                        
RTIAOR   EQU  PRIAOR-*                                             L27          
RTOAOR   EQU  PROAOR-*                                             L27          
RTOBLL   EQU  PROBLL-*                                             L27          
RTIEST   EQU  PRIEST-*                                             L27          
*                                                                               
TABLEI2  DS    0H                                                               
PROPUBNA B     OOPUBNA                                                          
PRIAOR   B     IAORENT                                             L27          
         DC    AL4(0)              DE-ACTIVATED                    L27          
PROAOR   B     OAORENT                                             L27          
PROBLL   B     OBILLR                                              L27          
PRIEST   B     IIEST                                               L30          
         TITLE 'PRWRITER - OUTPUT ROUTINES '                                    
*                                                                               
*-------------->   EST INPUT FIELDS                                L27          
*                                                                               
IIEST    DS    0H                                                               
*                                                                               
         LA    R1,ESTFLD                                                        
         ST    R1,THISFLD                                                       
*                                                                               
*        OLD INVOICE RECORD                                                     
*                                                                               
         CLI   PBMODE,PBPROCIV     IF PROCESSING OLD INVOICES                   
         BNE   IIESTIVN                                                         
*                                                                               
         ICM   R6,15,PBIDTELA      IF DETAIL ELEMENT KNOWN                      
         BZ    IIESTIVX                                                         
         USING PIMDTLEL,R6            ESTABLISH DETAIL ELEMENT                  
*                                                                               
         MVC   0(2,R2),PIMBEST            USE MATCHED ESTIMATE NUMBER           
*                                                                               
         B     IIESTIVX                                                         
*                                                                               
IIESTIVN DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCNV     IF PROCESSING INVOICES                       
         BNE   IIESTNVN                                                         
*                                                                               
*        NEW INVOICE RECORD                                                     
*                                                                               
         ICM   R6,15,PBIDTELA      IF DETAIL ELEMENT KNOWN                      
         BZ    IIESTIVX                                                         
         USING PNVDTLD,R6             ESTABLISH DETAIL ELEMENT                  
*                                                                               
         ICM   RE,15,PBIHDELA         ESTABLISH HEADER ELEMENT                  
         BZ    IIESTIVX                                                         
*                                                                               
         USING PNVHDRD,RE             ESTABLISH HEADER ELEMENT                  
*                                                                               
         MVC   0(2,R2),PNVDEST        PASS DETAIL ESTIMATE                      
*                                                                               
         OC    PNVDEST,PNVDEST        IF EST NUM UNKNOWN                        
         BNZ   *+10                                                             
         MVC   0(2,R2),PNVHEST           PASS HEADER ESTIMATE                   
*                                                                               
         OC    0(2,R2),0(R2)          DONE IF EST NUM UNKNOWN                   
         BZ    IIESTIVX                                                         
*                                                                               
         MVC   2(3,R2),PNVDCLT        PASS DETAIL CLIENT                        
*                                                                               
         OC    PNVDCLT,PNVDCLT        IF CLIENT UNKNOWN                         
         BNZ   *+10                                                             
         MVC   2(3,R2),PNVHCLT           PASS HEADER CLIENT                     
*                                                                               
         MVC   5(3,R2),PNVDPRD        PASS DETAIL PRODUCT                       
*                                                                               
         OC    PNVDPRD,PNVDPRD        IF PRODUCT UNKNOWN                        
         BNZ   *+10                                                             
         MVC   5(3,R2),PNVHPRD           PASS HEADER PRODUCT                    
*                                                                               
         ICM   RE,15,PBIKYELA         ESTABLISH KEY                             
         BZ    IIESTIVX                                                         
*                                                                               
         USING PNVKEY,RE           ESTABLISH INVOICE KEY                        
*                                                                               
         MVC   8(1,R2),PNVKMED     PASS MEDIA                                   
*                                                                               
         B     IIEST31                                                          
*                                                                               
IIESTIVX DS    0H                                                               
*                                                                               
         B     IIEST20                                                          
*                                                                               
         DROP  RE                                                               
*                                                                               
IIESTNVN DS    0H                                                               
*                                                                               
         MVC   0(2,R2),PBEST       ESTIMATE                                     
*                                                                               
IIEST20  DS    0H                                                               
*                                                                               
         OC    0(2,R2),0(R2)       DONE IF NO ESTIMATE FOUND                    
         BZ    IIESTX                                                           
*                                                                               
         MVC   2(3,R2),PBCLT                                                    
         TM    PBQFLOPT,PBQFLSCJ   SC JOHNSON ESTIMATE FILE?                    
         BNZ   IIEST25             YES - PRD SET BUT PRIORF WILL FAIL!          
*                                                                               
         LA    R1,PRODTS           DETERMINE IF PRODUCT WAS ENTERED             
         ST    R1,BEGINFLD            PRIOR TO ESTIMATE IN KEY                  
         LA    R1,ESTFLD                                                        
         ST    R1,THISFLD                                                       
         BAS   RE,PRIORF                                                        
         BNE   *+10                                                             
IIEST25  MVC   5(3,R2),PBPROD                                                   
*                                                                               
IIEST30  DS    0H                                                               
*                                                                               
         MVC   8(1,R2),PBMED       MEDIA                                        
*                                                                               
IIEST31  DS    0H                                                               
*                                                                               
         ICM   RF,15,PBUTLA        IF UTL ADDRESS SET                           
         BZ    *+10                                                             
         MVC   9(1,R2),4(RF)          PASS SE NUMBER                            
*                                                                               
         MVC   10(2,R2),PBAGY      AGENCY                                       
*                                                                               
IIESTX   DS    0H                                                               
         B     COMEXIT2                                                         
*                                                                               
*-------------->   AOR INPUT FIELDS                                L27          
*                                                                               
IAORENT  DS    0H                                                               
         L     RF,AORECORD         ADDRESS OF I/O                               
         USING AORREC,RF                                                        
         ZIC   R1,GLARGS+1                                                      
         B     *+4(R1)    GLARGS+1                                              
         B     IAORAGYN     00     AGENCY NAME                                  
         B     IAOREFFD     04     EFFECTIVE DATE                               
         B     IAORINCA     08       INCOME ACCOUNT                             
         B     IAORFPA      0C       RECEIVABLE/PAY ACCOUNT                     
         B     IAORBAS      10       BASIS                                      
         B     IAORPCT      14       PERCENTAGE                                 
         B     IAORAMT      18       AOR AMOUNT                                 
         B     IAOBILLT     1C       AOR BILL TYPE                              
*--------------------> AGENCY NAME                                              
IAORAGYN DS    0H                                                               
         MVC   0(30,R2),AORLIN1                                                 
         CLI   0(R2),0             MAKE SURE IT ISN'T ALL NULLS                 
         BNE   *+8                                                              
         MVI   0(R2),C' '                                                       
         B     IAORENTX                                                         
*--------------------> EFFECTIVE DATE                                           
IAOREFFD DS    0H                                                               
         MVC   0(2,R2),AOREFF                                                   
         MVI   2(R2),0             NO DAY                                       
         B     IAORENTX                                                         
*--------------------> INCOME ACCOUNT                                           
IAORINCA DS    0H                                                               
         MVC   0(14,R2),AORCOMM                                                 
         CLI   0(R2),0             MAKE SURE IT ISN'T ALL NULLS                 
         BNE   *+8                                                              
         MVI   0(R2),C' '                                                       
         B     IAORENTX                                                         
*--------------------> RECEIVABLE/PAY ACCOUNT                                   
IAORFPA  DS    0H                                                               
         MVC   0(14,R2),AORRCVBL                                                
         CLI   0(R2),0             MAKE SURE IT ISN'T ALL NULLS                 
         BNE   *+8                                                              
         MVI   0(R2),C' '                                                       
         B     IAORENTX                                                         
*--------------------> BASIS                                                    
IAORBAS  DS    0H                                                               
*                                                                               
         L     RE,AIO1             ESTABLISH BILL RECORD                        
         USING PBILLRCD,RE                                                      
*                                                                               
         TM    PBILCMSW,X'20'      SKIP IF NOT AN AOR BILL                      
         BZ    IAORBASX                                                         
*                                                                               
         MVC   0(1,R2),AORBAS                                                   
*                                                                               
         CLI   0(R2),0             FORCE ENTRY IF NULLS                         
         BNE   *+8                                                              
         MVI   0(R2),X'FF'                                                      
*                                                                               
IAORBASX DS    0H                                                               
         B     IAORENTX                                                         
*--------------------> PERCENTAGE                                               
*                                                                               
IAORPCT  DS    0H                                                               
         MVC   0(4,R2),AORPCT                                                   
         B     IAORENTX                                                         
*                                                                               
*--------------------> AOR AMOUNT                                               
*                                                                               
IAORAMT  DS    0H                                                               
         ZAP   0(8,R2),=P'0'                                                    
         L     RE,AIO1                                                          
         USING PBILLRCD,RE                                                      
         CLI   PBILKRCD,X'08'      SKIP IF NOT BILL RECORD                      
         BNE   IAORENTX                                                         
         TM    PBILCMSW,X'20'     IS THIS AN AOR BILL                           
         BNO   *+10                                                             
         ZAP   0(8,R2),PBILLRCV                                                 
         B     IAORENTX                                                         
*                                                                               
*--------------------> BILL TYPE                                                
*                                                                               
IAOBILLT DS    0H                                                               
         L     RE,AIO1                                                          
         USING PBILLRCD,RE                                                      
         MVC   0(1,R2),PBILLTYP                                                 
         B     IAORENTX                                                         
*                                                                               
IAORENTX DS    0H                                                               
         XIT1                                                                   
         DROP  RE,RF                                                            
*                                                                               
*-------------->   AOR OUTPUT FIELDS                               L27          
*                                                                               
OAORENT  DS    0H                                                               
         L     RF,AORECORD         ADDRESS OF I/O                               
         USING AORREC,RF                                                        
         ZIC   R1,GLARGS                                                        
         B     *+4(R1)    GLARGS                                                
         B     OAORAGYN     00     AGENCY NAME                                  
         B     OAOREFFD     04     EFFECTIVE DATE                               
         B     OAORINCA     08       INCOME ACCOUNT                             
         B     OAORFPA      0C       RECEIVABLE/PAY ACCOUNT                     
         B     OAORBAS      10       BASIS                                      
         B     OAORPCT      14       PERCENTAGE                                 
         B     OAORAMT      18       AOR AMOUNT                                 
         B     OAOBILLT     1C       AOR BILL TYPE                              
*--------------------> AGENCY NAME                                              
OAORAGYN DS    0H                                                               
         MVC   0(30,R3),0(R2)                                                   
         B     OAORENTX                                                         
*                                                                               
*--------------------> EFFECTIVE DATE                                           
OAOREFFD DS    0H                                                               
         LA    R0,17               DEFAULT OUTPUT TO MMMDD/YY                   
         CLI   2(R2),0             IF NO DAYS GIVEN USE                         
         BNE   *+8                                                              
         LA    R0,18                                                            
         L     RF,DATCON                                                        
         GOTO1 (RF),DMCB,(3,0(R2)),((R0),(R3))                                  
         B     OAORENTX                                                         
*--------------------> INCOME ACCOUNT                                           
OAORINCA DS    0H                                                               
         MVC   0(14,R3),0(R2)                                                   
         B     OAORENTX                                                         
*--------------------> RECEIVABLE/PAY ACCOUNT                                   
OAORFPA  DS    0H                                                               
         MVC   0(14,R3),0(R2)                                                   
         B     OAORENTX                                                         
*--------------------> BASIS                                                    
OAORBAS  DS    0H                                                               
*                                                                               
         CLI   0(R2),X'FF'         TEST FOR GROSS DEFAULT                       
         BNE   OAORBAS1                                                         
*                                                                               
         MVC   0(5,R3),=C'GROSS'                                                
         B     OAORBASX                                                         
*                                                                               
OAORBAS1 DS    0H                                                               
*                                                                               
         TM    0(R2),X'80'                                                      
         BNO   *+10                                                             
         MVC   0(6,R3),=C'AG COM'                                               
*                                                                               
OAORBASX DS    0H                                                               
*                                                                               
         B     OAORENTX                                                         
*--------------------> PERCENTAGE                                               
OAORPCT  DS    0H                                                               
         EDIT  (4,(R2)),(7,(R3)),4,FLOAT=-                                      
         B     OAORENTX                                                         
*--------------------> AOR AMT                                                  
OAORAMT  DS    0H                                                               
         B     AGENOUT2                                                         
*--------------------> AOR BILL TYPE                                            
OAOBILLT MVC   0(1,R3),0(R2)                                                    
         B     OAORENTX                                                         
*                                                                               
OAORENTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
*-------------->   BILLING RECORD OUTPUT FIELDS                    L27          
*                                                                               
OBILLR   DS    0H                                                               
         ZIC   R1,GLARGS                                                        
         B     *+4(R1)    GLARGS                                                
         B     OBILLINV     00     INVOICE NUMBER                               
         B     OBILLAMT     04     PURCHASE ORDER AMOUNT                        
*                                                                               
OBILLINV DS    0H                                                               
*                                                                               
***      GOTO1 =A(BLDINV),DMCB,(R2),(R3),5(R2)   FORMATS INVOICE NUMBER         
         GOTO1 =A(BLDINV),DMCB,(R2),(R3),(C'O',5(R2)) FORMATS INV NUM           
*                                                                               
         B     OBILLRX                                                          
*                                                                               
OBILLAMT DS    0H                  PURCHASE ORDER AMOUNT                        
*                                                                               
         XC    EBLOCK,EBLOCK       INIT EDITOR BLOCK                            
*                                                                               
         ST    R2,EBAIN            INPUT ADDRESS                                
*                                                                               
         MVI   EBLIN,8             INPUT LENGTH                                 
         MVI   EBTIN,C'P'          INPUT TYPE                                   
*                                                                               
         L     R1,GLADTENT         ESTABLISH OUTPUT ENTRY DESCRIPTION           
         USING DROD,R1                                                          
*                                                                               
         ST    R3,EBAOUT           OUTPUT ADDRESS                               
*                                                                               
         LLC   RF,DROLEN           OUTPUT LENGTH                                
         STC   RF,EBLOUT           OUTPUT LENGTH                                
*                                                                               
         MVI   EBTIN,C'P'          PACKED INPUT                                 
         MVI   EBDECS,2            NUMBER OF DECIMALS                           
*                                                                               
         CP    8(8,R2),=P'0'       IF NON-ZERO                                  
         BE    *+8                                                              
         MVI   EBFLOAT,C'N'        FLOAT N FOR NET                              
*                                                                               
         MVC   EBALIGN,DROALIGN    ALIGNMENT                                    
*                                                                               
         MVC   EBOPT,DROEDIT       EDIT OPTIONS                                 
*                                                                               
         MVI   EBTRIM,EBTQROD      IF TOO LARGE - NO DECIMALS                   
*                                                                               
         CLI   DOWNOPT,C'Y'        FORCE ZEROS IF DOWNLOADING                   
         BNE   *+8                                                              
         OI    EBOPT,EBOQZEN       ZEROS NOT REPLACED BY BLANKS                 
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK   PRINT NUMBER                              
*                                                                               
OBILLRX  DS    0H                                                               
         XIT1                                                                   
         DROP  R1,RF                                                            
*                                                                               
*-------------->   PUB NAME AND NUMBER                                          
*                                                                               
OOPUBNA  DS   0H                                                                
*                                                                               
         CLC   GLARGS+1(2),=C'CD'  IF CASH DISCOUNT                             
         BNE   OOPUB01                                                          
*                                                                               
         MVC   0(6,R3),=X'402020214B2020'  EDIT PATTERN                         
         ED    0(6,R3),0(R2)               CD                                   
*                                                                               
         XIT1                                                                   
*                                                                               
OOPUB01  DS    0H                                                               
*========              ========*                                                
         L     RF,RCWORK2                                                       
         USING MYWORKD,RF                                                       
*========              ========*                                                
         XC    EBLOCK,EBLOCK       CLEAR LIST                                   
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         LA    R6,WORKAREA                                                      
         MVI   0(R6),C' '                                                       
         MVC   1(132,R6),0(R6)                                                  
         ST    R6,EBAIN            SAVE ADD OF WORKAREA                         
         LA    R6,18(R6)         ALLOW FOR POSSIBLE SORT BY PUB NO L02          
         CLI   PBQADC,C'O'         OUT DOOR                       L15           
         BNE   *+14                                               L15           
         MVC   LABLAREA(6),=C'VENDOR'                             L15           
         B     *+10                                               L15           
         MVC   LABLAREA(11),=C'PUBLICATION'                                     
         MVC   0(20,R6),6(R2)        NAME                        L02            
         OC    0(20,R6),SPACES                                   L02            
         CLI   GLARGS+1,C'Z'         ZONE TO BE INCLUDED         L02            
         BNE   NOZONES                                           L02            
         MVC   21(20,R6),34(R2)      ZONE                        L02            
         OC    20(21,R6),SPACES                                  L02            
         LA    R6,20(R6)             FAKE                        L02            
NOZONES  DS    0H                                                               
         MVC   NAMEAREA+5(20),6(R2)                                             
         OC    NAMEAREA,SPACES                                                  
         CLI   GLARGS,C'N'           NAME ONLY - SEE OUTPUT ARGS                
         BE    LARF76                IN DICTIONARY REPORT                       
*                                                                               
         MVI   22(R6),C'('                                                      
         GOTO1 =V(PUBEDIT),DMCB,(PBAGYPRF+12,28(R2)),(C'S',23(R6))              
         PRINT NOGEN                                                            
         MVC   CODEAREA(11),23(R6)                                              
         OC    CODEAREA,SPACES                                                  
         MVC   NAMEAREA(4),34(R6)                                               
         OC    NAMEAREA,SPACES                                                  
         MVC   NAMEAREA+25(7),SPACES                                            
         CLI   NAMEAREA,C' '                                                    
         BNE   NOMOVE20                                                         
         MVC   NAMEAREA(20),NAMEAREA+5                                          
         MVC   NAMEAREA+20(12),SPACES                                           
NOMOVE20 LA    RE,38(R6)                                                        
         LA    RF,15                                                            
         CLI   0(RE),X'40'                                                      
         BH    *+10                                                             
         BCTR  RE,0                                                             
         BCT   RF,*-10                                                          
         MVI   1(RE),C')'                                                       
         CLI   GLARGS,C'X'         CONTINUE WITH CONTRACT EDITING               
         BE    OBCONTR                                                          
         CLI   GLARGS,C'S'         SORTING BY PUB NUMBER                        
         BNE   LARF76                                                           
         L     RF,EBAIN              BEGINING OF WORK AREA        L02           
*                                                                               
         MVC   0(17,RF),22(R6)       PUT EDITED PUB IN FRONT                    
         MVI   17(RF),C' '                                                      
         OC    0(16,RF),SPACES                                                  
         MVC   22(20,R6),SPACES        CLEAR EDITED PUB            L02          
LARF76   DS    0H                                                  L02          
*                                                                               
         CLI   MYLTYP,C'H'       FOR HEADLINE CLEAR PUB ID                      
         BNE   LARF77                                                           
*                                                                               
         L     RF,EBAIN              BEGINING OF WORK AREA        L02           
         MVC   0(17,RF),SPACES     CLEAR LEADING PUB ID                         
         MVC   22(20,R6),SPACES    CLEAR TRAILING ID                            
*                                                                               
LARF77   DS    0H                                                  L02          
         LA    R4,76                   WAS R4,38                   L02          
         B     SQUASH                                                           
*                                                                               
OBCONTR  MVI   1(RE),C' '                                                       
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(11),=CL11'CONTRACT'                                     
         CLI   0(R2),255              MISSING CONTRACT                          
         BNE   OBNOMISS                                                         
         MVC   2(31,RE),=C'*** NO ASSOCIATED CONTRACT ***)'                     
         MVC   NAMEAREA(31),2(RE)                                               
         LR    R4,RE                                                            
         B     OCSPACE                                                          
**                                                                              
OBNOMISS MVC   2(3,RE),=C'NO='                                                  
         ZIC   RF,44(R2)                                                        
         CVD   RF,DMCB                                                          
         OI    DMCB+7,X'0F'                                                     
         UNPK  5(3,RE),DMCB+6(2)                                                
         MVI   8(RE),C')'                                                       
         LA    R4,9(RE)            POINT TO PRINT LINE                          
         L     RF,DATCON                                                        
         GOTO1 (RF),DMCB,(3,34(R2)),(5,1(R4)) START DATE                        
         L     RF,DATCON                                                        
         GOTO1 (RF),DMCB,(3,37(R2)),(5,10(R4)) END   DATE                       
         MVI   9(R4),C'-'                                                       
         MVC   18(4,R4),=C' CD-'                                                
         MVC   22(7,R4),=X'402020214B2020'                                      
         ED    22(7,R4),40(R2)       CASH DISCOUNT                              
         MVC   29(2,R4),SPACES                                                  
         CLI   GLARGS+1,C'A'       ATTN OF                                      
         BNE   SQUASH11                                                         
*                                                                               
         CLI   GLARGS+2,C'1'       IF ATTENTION NAME ONLY                       
         BNE   OBCONTR1                                                         
*                                                                               
         MVC   OUTAREA,SPACES      CLEAR HEADLINE OUTPUT AREA                   
         L     R4,EBAIN            POINT TO START OF OUTPUT                     
         XC    0(132,R4),0(R4)     CLEAR AREA                                   
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(14),=CL14'CONTRACT ATTN.'  SET TITLE                    
         MVC   NAMEAREA(30),45(R2) MOVE OUT ATTENTION NAME                      
         OC    NAMEAREA(30),SPACES UPPERCASE                                    
         MVC   0(30,R4),45(R2)     MOVE OUT ATTENTION NAME                      
         OC    0(30,R4),SPACES     UPPERCASE                                    
         CLC   NAMEAREA,SPACES     IF NO DATA                                   
         BH    *+10                                                             
         MVC   CODEAREA(3),=C'N/A' INDICATE NOT AVAILABLE                       
         LA    R4,30               SQUASH 30 BYTES                              
         B     SQUASH                                                           
*                                                                               
OBCONTR1 DS    0H                                                               
*                                                                               
         XC    31(45,R4),31(R4)                                                 
         OC    45(30,R2),45(R2)                                                 
         BZ    OCSPACE                                                          
         MVC   31(5,R4),=C'ATTN-'                                               
         MVC   36(30,R4),45(R2)                                                 
OCSPACE  OC    36(40,R4),SPACES                                                 
SQUASH11 LA    R4,111                                                           
SQUASH   L     R6,EBAIN                                                         
         TM    GLINDS,X'40'       DOING TOTALS                                  
         BNO   LRFSQUA                                            BUG01         
         MVC   CODENNAM,SPACES                                    BUG01         
         B     AGENOUT2                                           BUG01         
         SPACE 3                                                                
LRFSQUA  L     RF,SQUASHER                                        BUG01         
         GOTO1 (RF),DMCB,(R6),(R4)                                              
*========              ========*                                                
         L     RF,GLADTENT                                                      
         USING DROD,RF                                                          
*========              ========*                                                
         ZIC   R6,DROLEN                                                        
         BCTR  R6,0                                                             
         L     RF,EBAIN                                                         
         CLI   MYLTYP,C'H'    IF DEALING WITH HEADER JUST GET OUT  L02          
******   BE    AGENOUT2                                            L02          
         BNE   SQUASH01                                                         
*                                                                               
         CLI   GLARGS,C'X'         SKIP IF DOING CONTRACT ID                    
         BE    AGENOUT2                                                         
*                                                                               
         MVC   NAMEAREA,0(RF)      USE SQUASHED NAME                            
*                                                                               
         B     AGENOUT2                                                         
*                                                                               
SQUASH01 DS    0H                                                               
         TM    PBQPOPT,PBQPOCUT                                                 
         BNO   SECHOPER                                                         
         LR    R4,R6                                                            
         L     R6,DMCB             POINT TO BEGINING OF SQUASHED                
         EX    R4,DOCHOP                                                        
         B     COMEXIT2                                                         
SECHOPER CR    R4,R6       IF LENGTH IS LESS THAN DROLEN DO NOT                 
         BH    DOCHOPER                                                         
         L     R6,EBAIN     ADDRESS OF INPUT WORK AREA                          
         BCTR  R4,0                                                             
         EX    R4,DOCHOP                                                        
         CLI   MYLTYP,C'H'                                                      
         BE    AGENOUT2            EXIT W/X'20'IN R1                            
         B     COMEXIT2                                                         
*                                                                               
DOCHOP   MVC   0(0,R3),0(R6)                                                    
*********                                                                       
*********                                                                       
DOCHOPER L     R6,EBAIN     ADDRESS OF INPUT WORK AREA                          
         L     RF,GLADTENT   RE-ESTABLISH POINTER FOR DROLEN                    
         USING DROD,RF                                                          
         CLI   MYLTYP,C'M'       IS THIS A MIDLINE               BUG12          
         BNE   *+8                                               BUG12          
         MVI   DROLEN,100                                        BUG12          
*                                                                               
         LH    R5,=Y(PPBYOUTC-SYSD)  DISPLACEMENT OF PPBYOUT AREA               
         AR    R5,R9                                                            
         USING PPBYOUTD,R5         ESTABLISH PPBYOUT AREA                       
*                                                                               
         GOTO1 CHOPPER,DMCB,((R4),0(R6)),(DROLEN,PBYOCOMS),4                    
         PRINT NOGEN                                                            
****     OC    8(4,R1),8(R1)   NUMBER OF LINES MUST NOT BE ZERO                 
****     BNZ   *+6                                                              
****     DC    H'0'                                                             
*                                                                               
         ICM   RF,15,8(R1)                NUMBER OF LINES                       
         BZ    COMEXIT2                                                         
*                                                                               
         L     RE,4(R1)                ADDRESS OF CHOPPED                       
         ZIC   R6,4(R1)                LENGTH OF CHOPPED                        
         BCTR  R6,0                    FOR EX                                   
OCOMOVE  EX    R6,*+8                                                           
         B     *+10                                                             
         CLC   0(0,RE),SPACES                                                   
         BNH   OCNOMOVE                                                         
         EX    R6,OCMMVC                                                        
*                                                                               
*                                                                               
OCNOMOVE LA    R3,198(R3)                                                       
         LA    RE,1(R6,RE)                                                      
         BCT   RF,OCOMOVE                                                       
COMEXIT2 XMOD1 1                                                                
*                                                                               
AGENOUT2 LA    R1,32                                                            
         XIT1  REGS=(R1)                                                        
*        ========  *                                                            
         DROP  RF                                                               
         DROP  R5                                                               
*        ========  *                                                            
OCMMVC   MVC   0(0,R3),0(RE)                                                    
*                                                                               
         SPACE 3                                                                
PRODTS   DC    X'08090AFF'         PRODUCT TYPES                                
ESTFLD   DC    X'5051525354FF'           EST TYPES                              
CLIFLD   DC    X'050607FF' CLIENT                                               
MEDFLD   DC    X'0102FF'           MEDIA                                        
CONFLD   DC    X'303132FF'         CONTRACT                                     
COPFLD   DC    X'38FF'             COPY                                         
PUBFLD   DC    X'2021222324252627FF'                               PUB          
DISFLD   DC    X'414243FF'         DISTRICT                                     
DIVFLD   DC    X'454647FF'         DIVISION                                     
JOBFLD   DC    X'6061FF'           JOB                                          
MARFLD   DC    X'70FF'             MARKET                                       
*                                                                               
THISFLD  DC    F'0'                                                             
BEGINFLD DC    F'0'                                                             
**************************                                                      
PRIORF   NTR1                                                                   
         LA    R1,16                                                            
         LA    R2,LEVELTYP         TABLE WITH ALL KEY TYPES                     
         L     R3,BEGINFLD         PRIOR FIRST                                  
PRIR3R2  CLC   0(1,R3),0(R2)       GO THRU LIST                                 
         BE    PRIKEEP             HIT ON PRIOR                                 
         LA    R3,1(R3)            GO THRU TYPES                                
         CLI   0(R3),255                                                        
         BNE   PRIR3R2                                                          
         L     R3,BEGINFLD         PRIOR FIRST                                  
* BUMP LIST POINTER                                                             
         LA    R2,1(R2)                                                         
         CLI   0(R2),0                                                          
         BE    C2NEXIT                                                          
         BCT   R1,PRIR3R2                                                       
         B     C2NEXIT                                                          
****                                                                            
PRIKEEP  DS    0H                  ARGUMENT MUST FOLLOW                         
         CLI   BEGINFLD,255                                                     
         BE    COMEXIT2            BEGINFLD SWITCH WILL BE RESET                
*                                  ON NEXT LOAD                                 
         L     R3,THISFLD                                                       
         ST    R3,BEGINFLD                                                      
         MVI   BEGINFLD,255                                                     
         B     PRIR3R2             LOOP THRU AGAIN                              
**                                                                              
C2NEXITX DS    0H                                                               
         CLI   BEGINFLD,255        PROCESSING SECOND FIELD                      
         BE    COMEXIT2                                                         
C2NEXIT  CR    RB,R1                                                            
         B     COMEXIT2                                                         
         SPACE 3                                                                
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
RCWORK2  DS    F                                                                
SAVER1A2 DS    F                                                                
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R7                                                               
*                                                                               
         TITLE 'PRWRITER - AGING ACTIVITY DATE - INPUT - IAADT'                 
***********************************************************************         
*                                                                     *         
*        AGING ACTIVITY DATE                                          *         
*                                                                     *         
*NTRY    IF BILL ELEMENT PROCESSING USE INVOICE DATE                  *         
*        IF PAY  ELEMENT PROCESSING USE CLEARANCE DATE                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IAADT    NMOD1 0,**#IAADT                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         ST    R2,IAAINASV         SAVE DRIVER AREA ADDRESS                     
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
*                                                                               
         CLC   IAADBUYK,0(R4)      IF WE HAVE NEW BUY                           
         BE    *+22                                                             
         MVC   IAADBUYK,0(R4)         UPDATE SAVED KEY                          
         XC    IAADSQN,IAADSQN        RESET SEQUENCE NUMBER                     
         XC    IAADDTE,IAADDTE        RESET SAVED DATE                          
*                                                                               
         MVC   IAADTARG,GLARGS     SAVE INCOMING ARGUMENTS                      
*                                                                               
*        CHECK FOR W0 PROFILE                                                   
*                                                                               
         XC    IAACKY,IAACKY       INIT PROFILE KEY                             
*                                                                               
         MVI   IAACSYS,C'P'         SET SYSTEM                                  
         MVI   IAACSYS+1,C'0'                                                   
         MVC   IAACPRF,=C'W0'       W0 - WRITER PROFILE                         
         MVC   IAACAGY,PBAGY        AGENCY                                      
         MVC   IAACMED,PBMED        MEDIA                                       
         MVC   IAACCLT,PBCLT        CLIENT                                      
*                                                                               
*        CHECK IF OFFICE KNOWN                                                  
*                                                                               
         CLI   PBQCLT,C'*'         IF REQUESTED BY OFFICE                       
         BNE   *+14                                                             
         MVC   IAACOFC,PBQCLT+1       USE IT                                    
         B     IAADTOF9                                                         
*                                                                               
         CLI   PBCOFF,C' '        IF CLIENT OFFICE KNOWN USE IT                 
         BNH   *+10                                                             
         MVC   IAACOFC,PBCOFF       CLIENT OFFICE CODE                          
*                                                                               
         CLI   PBQSLAVE,C'Y'        IF DOING SLAVES                             
         BNE   IAADTSLX                                                         
*                                                                               
         ICM   RF,15,PBCLTADR     POINT TO CLIENT RECORD                        
         BZ    IAADTSLX              NOT KNOWN                                  
*                                                                               
         USING PCLTRECD,RF                                                      
*                                                                               
         CLI   PCLTOFF,C' '       IF CLIENT OFFICE KNOWN                        
         BNH   *+10                  USE IT                                     
         MVC   IAACOFC,PCLTOFF       SLAVE OFFICE CODE                          
*                                                                               
         DROP  RF                                                               
*                                                                               
IAADTSLX DS    0H                                                               
*                                                                               
IAADTOF9 DS    0H                                                               
*                                                                               
         CLI   IAACOFC,C' '       IF OFFICE PRESENT                             
         BNH   *+8                                                              
         MVI   IAACSTAR,C'*'         INDICATE IN PARAMETERS                     
*                                                                               
IAADTOFX DS    0H                                                               
*                                                                               
         CLC   IAACKYS,IAACKY      IF NEW KEY                                   
         BE    IAACDTEA                                                         
*                                                                               
         MVC   IAACKYS,IAACKY         SAVE NEW KEY                              
*                                                                               
         XC    PBQPRFW0,PBQPRFW0      INIT PROFILE AREA                         
*                                                                               
         GOTO1 GETPROF,DMCB,IAACKY,PBQPRFW0,DATAMGR                             
*                                                                               
IAACDTEA DS    0H                                                               
*                                                                               
*        IF HANDLING BILL ELEMENT                                               
*                                                                               
IAADTBL  DS    0H                                                               
*                                                                               
         ICM   R3,15,PBBLLELA      ESTABLISH BILL ELEMENT                       
         BZ    IAADTBLN               SKIP - NONE AVAILABLE                     
*                                                                               
         USING PBILELD,R3                                                       
*                                                                               
         CLC   IAADDTE,PBLDATE     IF BILL DATE HAS CHANGED                     
         BE    *+20                                                             
         XC    IAADSQN,IAADSQN        RESET SEQUENCE NUMBER                     
         MVC   IAADDTE,PBLDATE        RESET SAVED DATE                          
         MVI   IAADTRSW,0             RESET TRANSACTION DATA SWITCH             
*                                                                               
         LH    RF,IAADSQN          BUMP SEQUENCE NUMBER                         
         LA    RF,1(RF)                                                         
         STH   RF,IAADSQN                                                       
*                                                                               
*        DEFAULT IS INVOICE DATE BUT QUALIFIERS MAY INDICATE DUE DATE           
*                                                                               
         ICM   R3,15,PBBHDELA      POINT TO BILL HEADER RECORD                  
         BZ    IAADTDRP               SKIP - NONE AVAILABLE                     
*                                                                               
         ICM   R5,15,PBTRNELA      IF THERE IS A CASH TRANSACT ELM              
         BZ    IAADTRNX                                                         
         USING TRNELD,R5              ESTABLISH CASH TRANSACT ELM               
*                                                                               
         MVI   0(R2),1                SET SORT SEQUENCE FOR BILL DATES          
         LA    R2,1(R2)               BUMP POINTER                              
*                                                                               
         CLI   TRNEL,X'FF'         IF UNAPPLIED ELEMENT                         
         BNE   *+14                                                             
         MVC   0(3,R2),PBBTODAY       USE TODAY'S DATE                          
         B     IAADTRN2                                                         
         MVC   GLARGS(3),=C'QDC'   SET FOR CLIENT CHECK DATE                    
*                                                                               
         CLI   PBQPRFW0+9,C'Y'     IF CLT DEPOSIT DATE REQ'D                    
         BNE   *+8                                                              
         MVI   GLARGS+2,C'D'          SET TO GET DEPOSIT DATE                   
*                                                                               
         GOTO1 =A(ICSH)            GET APPROPRIATE DATE                         
         MVC   GLARGS(16),IAADTARG RESTORE INCOMING ARGUMENTS                   
*                                                                               
         MVC   FULL(3),0(R2)       SAVE DATE                                    
*                                                                               
         GOTO1 DATCON,DMCB,(1,FULL),(3,0(R2)) TRANS DATE                        
*                                                                               
IAADTRN2 DS    0H                                                               
*                                                                               
         MVC   3(2,R2),IAADSQN        PASS ALONG SEQUENCE NUMBER                
         MVI   IAADTRSW,1             INDICATE TRANSACTION DATA USED            
*                                                                               
         B     IAADTX                                                           
*                                                                               
IAADTRNX DS    0H                                                               
*                                                                               
         CLI   IAADTRSW,0          SKIP IF TRANSACTION DATA USED                
         BNE   IAADX                                                            
*                                                                               
         MVI   0(R2),1             SET SORT SEQUENCE FOR BILL DATES             
         LA    R2,1(R2)            BUMP POINTER                                 
*                                                                               
         MVC   0(3,R2),PBILINVD-PBILLKEY(R3) RETURN INVOICE DATE                
*                                               AS DEFAULT                      
         MVC   3(2,R2),IAADSQN     PASS ALONG SEQUENCE NUMBER                   
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,GLARGS+6       GET KEYWORD NUMBER                           
******   BZ    IAADTDUX            NONE GIVEN - USE DEFAULT                     
         B     IAADTDU1            FORCE DUE DATE                               
*                                                                               
         LA    RE,FLTAREAL         LENGTH OF FILTER SAVEAREA                    
         BCTR  RF,0                DECREMENMT FOR INDEXING                      
         MR    RE,RE               CALCULATE INDEX AMOUNT                       
*                                                                               
         L     R5,AFLTTAB          POINT TO FILTER SAVEAREAS                    
         LA    R5,0(RF,R5)         POINT TO THIS KEYWORD'S AREA                 
*                                                                               
         USING FLTAREA,R5          ESTABLISH FILTER SAVEAREA                    
*                                                                               
*        DETERMINE FILTER TYPE AND APPLY                                        
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,FLTFNO         GET NUMBER OF FILTERS                        
         BZ    IAADTDUX            NONE GIVEN - USE DEFAULT                     
*                                                                               
         LA    R6,FLTCTL           POINT TO FIRST FILTER                        
*                                                                               
IAADDULP DS    0H                                                               
*                                                                               
         USING FLTCTL,R6           ESTABLISH FILTER                             
*                                                                               
         CLC   FLTFTIC,=AL2(PRQWRCFL)  COLUMN FILTER                            
         BNE   IAADDUEN                                                         
*                                                                               
         CLC   FLTFVAL,=AL2(PRQCFDUE)  INVOICE DUE DATE                         
         BNE   IAADDUEN                                                         
*                                                                               
IAADTDU1 DS    0H                                                               
*                                                                               
         ICM   R3,15,PBBHDELA      POINT TO BILL HEADER                         
         BZ    IAADTDUX               SKIP - NONE AVAILABLE                     
*                                                                               
         MVC   0(3,R2),PBILDUED-PBILLKEY(R3) RETURN INVOICE DUE DATE            
*                                                                               
         B     IAADDUDN                                                         
*                                                                               
IAADDUEN DS    0H                                                               
*                                                                               
IAADDUCN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,FLTFVLEN         GET LENGTH OF FILTER                         
         LA    R6,FLTFVAL(RF)      BUMP TO NEXT FILTER                          
         BCT   R0,IAADDULP                                                      
*                                                                               
IAADDUDN DS    0H                                                               
*                                                                               
IAADTDUX DS    0H                                                               
*                                                                               
         B     IAADTX                                                           
*                                                                               
IAADTBLN DS    0H                                                               
*                                                                               
*        IF HANDLING PAY ELEMENT                                                
*                                                                               
IAADTPY  DS    0H                                                               
*                                                                               
         ICM   R3,15,PBPAYELA      ESTABLISH PAY ELEMENT                        
         BZ    IAADTPYN               SKIP - NONE AVAILABLE                     
*                                                                               
         USING PPAYELEM,R3                                                      
*                                                                               
         CLC   IAADDTE,PPDDATE     IF PAY DATE HAS CHANGED                      
         BE    *+16                                                             
         XC    IAADSQN,IAADSQN        RESET SEQUENCE NUMBER                     
         MVC   IAADDTE,PPDDATE        RESET SAVED DATE                          
*                                                                               
         LH    RF,IAADSQN          BUMP SEQUENCE NUMBER                         
         LA    RF,1(RF)                                                         
         STH   RF,IAADSQN                                                       
*                                                                               
         USING PPCLEL01,R3                                                      
*                                                                               
         ICM   R3,15,PBCLSELA      ESTABLISH CLEARANCE ELEMENT                  
         BZ    IAADTDRP            DROP IF NONE AVAILABLE                       
*                                                                               
         OC    PPCLCHDT,PPCLCHDT   OR IF CHECK NOT CUT YET                      
         BZ    IAADTDRP                                                         
*                                                                               
         CLC   =C'VOID',PPCLCHK    DROP IF CHECK VOIDED                         
         BE    IAADTDRP                                                         
*                                                                               
         LA    RF,PPCLCHDT         DEFAULT TO CHECK DATE                        
*                                                                               
         TM    PBQOPTS,PBQOBNKD    IF BANK CLEARED DATE REQ'D                   
         BO    *+12                                                             
         CLI   PBQPRFW0+10,C'Y'    IF CLT BANK CLRD DATE REQ'D                  
         BNE   IAADTPY2                                                         
*                                                                               
         CLI   PPCLEL01+1,PPCLBKDT-PPCLEL01 DEFAULT IF NO BANK DEP DATE         
         BNH   IAADTPY1                                                         
*                                                                               
         OC    PPCLBKDT,PPCLBKDT    DEFAULT IF CHECK NOT DEPOSITED              
         BZ    IAADTPY1                                                         
*                                                                               
         LA    RF,PPCLBKDT                       POINT TO BANK DEP DTE          
*                                                                               
         B     IAADTPY2                                                         
*                                                                               
IAADTPY1 DS    0H                                                               
*                                  DEFAULT TO  LAST OF PREVIOUS MONTH           
***      GOTO1 DATCON,DMCB,(5,0),WORK    TODAY AS YYMMDD                        
         GOTO1 DATCON,DMCB,(3,PBBTODAY),WORK      TODAY AS REF DATE             
         LHI   RF,-1                                                            
         ST    RF,DMCB+8                                                        
         GOTO1 ADDAY,DMCB,(C'M',WORK),(X'80',WORK+6)   BACKUP A MONTH           
         GOTO1 DATCON,DMCB,(0,WORK+6),(2,HALF)                                  
*                                                                               
         LA    RF,HALF            DEFAULT DATE                                  
*                                                                               
IAADTPY2 DS    0H                                                               
*                                                                               
         MVI   0(R2),2             SET SORT SEQUENCE FOR CHECK DATES            
         LA    R2,1(R2)            BUMP POINTER                                 
*                                                                               
         GOTO1 DATCON,DMCB,(2,0(RF)),(3,0(R2))  CHECK DATE                      
*                                                                               
         MVC   3(2,R2),IAADSQN     PASS ALONG SEQUENCE NUMBER                   
*                                                                               
         B     IAADTX                                                           
*                                                                               
IAADTPYN DS    0H                                                               
*                                                                               
IAADTDRP DS    0H                                                               
*                                                                               
         CP    PBQKYWDN,=P'1'      IF THIS IS ONLY BUY RELATED KEYWORD          
         BH    *+8                                                              
         MVI   SORTSW,C'N'            DON'T ADD RECORD TO SORT                  
*                                                                               
         B     IAADX                                                            
*                                                                               
IAADTX   DS    0H                                                               
*                                                                               
*        CALCULATE AGING DAYS POSITIVE FOR CLEARANCE                            
*                             NEGATIVE FOR BILLING                              
*                                                                               
IAADY    DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'#'       SKIP IF NOT LOOKING FOR AGING DAYS           
         BNE   IAADX                                                            
*                                                                               
         L     R4,AIO                                                           
*                                                                               
         L     R2,IAAINASV         RE-POINT TO INPUT AREA                       
*                                                                               
         MVC   IAADINSV,0(R2)      SAVE ACTIVITY DATE                           
*                                                                               
         ZAP   0(8,R2),=P'0'       INIT DRIVER INPUT                            
*                                                                               
         OC    IAADWDTS,IAADWDTS   SKIP IF NO ACTIVITY DATE                     
         BZ    IAADX                                                            
*                                                                               
         GOTO1 DATCON,DMCB,(3,IAADWDTS),IAACDTE   CONVERT TO YYMMDD             
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
*                                                                               
         OC    PBDBDATE,PBDBDATE   SKIP IF NO BILLABLE DATE GIVEN               
         BZ    IAACDTX                                                          
*                                                                               
         MVC   IAACBDB,PBDBDATE    COPY BILLABLE DATE                           
*                                                                               
         CLC   PBQPRFW0+3(2),=X'0000' SKIP IF PROFILE HAS NO DATE               
         BNH   IAACDT0                                                          
*                                                                               
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         IC    RE,PBQPRFW0+3       GET TENS DIGIT                               
         MH    RE,=H'10'                                                        
         IC    RF,PBQPRFW0+4       GET UNITS DIGIT                              
         AR    RF,RE               DATE                                         
*                                                                               
         LA    RF,1(RF)            ADD 1 DAY FOR CALCULATIONS                   
*                                                                               
         CH    RF,=H'29'           SKIP IF POSSIBLY OUT OF MONTH                
         BNL   IAACDT0                                                          
*                                                                               
         STC   RF,IAACBDB+2        RESET DAYS                                   
*                                                                               
         B     IAACDT1                                                          
*                                                                               
IAACDT0 DS     0H                                                               
*                                                                               
         MVI   IAACBDB+2,1         SET TO FIRST OF THE MONTH                    
*                                                                               
         SR    RF,RF               CONVERT TO START OF NEXT MONTH               
         IC    RF,IAACBDB+1        GET MONTH                                    
         LA    RF,1(RF)            BUMP BY ONE                                  
         STC   RF,IAACBDB+1                                                     
*                                                                               
         CH    RF,=H'12'           IF ORIGINAL MONTH WAS DECEMBER               
         BNH   IAACDT1                                                          
*                                                                               
         MVI   IAACBDB+1,1            SET MONTH TO JANUARY                      
         IC    RF,IAACBDB             BUMP YEAR                                 
         LA    RF,1(RF)                                                         
         STC   RF,IAACBDB                                                       
*                                                                               
IAACDT1 DS     0H                                                               
*                                                                               
         OC    PBQPRFW0+2(3),PBQPRFW0+2 DONE IF NO PROFILE ENTRY                
         BZ    IAACDT5                                                          
         CLC   PBQPRFW0+2(3),=X'C30000' DONE IF DEFAULT PROFILE                 
         BE    IAACDT5                                                          
*                                                                               
         CLI   PBQPRFW0+2,C'C'     DONE IF CURRENT MONTH                        
         BE    IAACDT5                                                          
*                                                                               
         SR    RF,RF                                                            
         IC    RF,IAACBDB+1        GET MONTH                                    
*                                                                               
         CLI   PBQPRFW0+2,C'P'     IF PREVIOUS MONTH                            
         BNE   IAACDT2                                                          
*                                                                               
         SH    RF,=H'1'               DECREMENT MONTH                           
         STC   RF,IAACBDB+1           RESET MONTH                               
         BP    *+18                                                             
         IC    RF,IAACBDB             IF JANUARY DECREMENT YEAR                 
         BCTR  RF,0                                                             
         STC   RF,IAACBDB                                                       
         MVI   IAACBDB+1,12              AND USE DECEMEBER                      
*                                                                               
         B     IAACDT5                                                          
*                                                                               
IAACDT2 DS     0H                                                               
*                                                                               
         LA    RF,1(RF)            ELSE ADD MONTH                               
         CLI   PBQPRFW0+2,C'A'          IF NEXT MONTH PLUS ONE                  
         BNE   *+8                                                              
         LA    RF,1(RF)                    ADD ANOTHER MONTH                    
*                                                                               
         STC   RF,IAACBDB+1           RESET MONTH                               
*                                                                               
         CH    RF,=H'12'                IF PAST DECEMBER                        
         BNH   IAACDT5                                                          
*                                                                               
         SH    RF,=H'12'                   RESET MONTH NUMBER                   
         STC   RF,IAACBDB+1                                                     
         IC    RF,IAACBDB                  ADD 1 TO YEAR                        
         LA    RF,1(RF)                                                         
         STC   RF,IAACBDB                                                       
*                                                                               
IAACDT5 DS     0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(3,IAACBDB),IAACBDC    CONVERT BILLABLE DTE          
*                                                                               
         CLI   PBQPRFW0+12,C'Y'       IF USING TODAY AS REFERENCE DATE          
         BNE   IAACDT6                                                          
*                                                                               
***      GOTO1 DATCON,DMCB,(5,0),IAACBDC TODAY AS REFERENCE DATE                
         GOTO1 DATCON,DMCB,(3,PBBTODAY),IAACBDC   TODAY AS REF DATE             
*                                                                               
IAACDT6  DS    0H                                                               
*                                                                               
         L     RF,PBCOMFAC         GET COMFACS ADDRESS                          
         L     RF,CPERVERT-COMFACSD(RF)   GET PERVERT ADDRESS                   
*                                                                               
         CLC   IAACBDC,IAACDTE     CHECK IF CHK BEFORE BILLABLE DATE            
         BNL   IAACDT9                                                          
*                                                                               
         GOTO1 (RF),DMCB,IAACBDC,IAACDTE     GET # 0F DAYS                      
*                                                                               
         LH    RF,DMCB+8           NUMBER OF DAYS BETWEEN DATES                 
         SHI   RF,1                WANT EXCLUSIVE DAY COUNT                     
         CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB         PASS NUMBER OF DAYS TO DRIVER                
*                                                                               
         B     IAACDTX                                                          
*                                                                               
IAACDT9 DS     0H                  CHECK ISSUED BEFORE BILLABLE DATE            
*                                  DAYS ARE NEGATIVE                            
*                                                                               
         GOTO1 (RF),DMCB,IAACDTE,IAACBDC     GET # 0F DAYS                      
*                                                                               
         LH    RF,DMCB+8           NUMBER OF DAYS BETWEEN DATES                 
         SHI   RF,1                WANT EXCLUSIVE DAY COUNT                     
         LNR   RF,RF               NUMBER IS NEGATIVE                           
         CVD   RF,DUB                                                           
****     AP    DUB,=P'2'           RECTIFY COUNT FOR NEGATIVE AMOUNT            
         ZAP   0(8,R2),DUB         PASS NUMBER OF DAYS TO DRIVER                
*                                                                               
IAACDTX DS     0H                                                               
*                                                                               
         OC    PBBLLELA,PBBLLELA   IF DOING BILL DATE                           
         BZ    *+16                                                             
         SP    0(8,R2),DUB            MAKE NEGATIVE                             
         SP    0(8,R2),DUB            MAKE NEGATIVE                             
*                                                                               
IAADYX  DS     0H                                                               
*                                                                               
IAADX    DS    0H                                                               
*                                                                               
         MVC   GLARGS,IAADTARG     RESET TO ARGUMENTS                           
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IAADTARG DS    CL16                ARGUMENTS SAVEAREA                           
*                                                                               
IAAINASV DS    A                   A(INPUT AREA)                                
IAADBUYK DS    XL(L'PBUYKEY)       BUY KEY SAVEAREA                             
IAADSQN  DS    H                   SEQUENCE NUMBER                              
IAADDTE  DS    XL3                 SAVED DATE                                   
IAADTRSW DC    X'00'               TRANSACTION DATA SWITCH                      
*                                                                               
IAADINSV DS    0XL4                ACTIVITY DATE INPUT SAVEAREA                 
         DS    XL1                 SORT SEQUENCE                                
IAADWDTS DS    XL3                 ACTIVITY DATE                                
*                                                                               
IAACDTE  DS    CL6                 CLEARANCE DATE AS YYMMDD CHARACTER           
IAACBDB  DS    XL3                 BILLABLE DATE IN BINARY                      
IAACBDC  DS    CL6                 BILLABLE DATE AS YYMMDD                      
*                                                                               
IAACKY   DS    XL16                PROFILE KEY                                  
         ORG   IAACKY                                                           
IAACSYS DS     CL1                 SYSTEM                                       
         DS    XL1                 NOT USED                                     
IAACPRF  DS    CL2                 PROFILE ID                                   
IAACAGY  DS    CL2                 AGENCY                                       
IAACMED  DS    CL1                 MEDIA                                        
IAACCLT  DS    CL3                 CLIENT                                       
IAACSTAR DS    CL1                 OFFICE INDICATOR                             
IAACOFC  DS    CL1                 OFFICE CODE                                  
*                                                                               
IAACKYS DS     XL(L'IAACKY)        PROFILE KEY SAVEAREA                         
*                                                                               
         DROP  R4,R5,R6,R3                                                      
*                                                                               
         TITLE 'PRWRITER - POL SPLIT OUTPUT -OPOLSPLT'                          
***********************************************************************         
*                                                                     *         
*        PRODUCT SPLIT FOR ZZZ BUYS                                   *         
*                                                                     *         
*NTRY    C'ZZZ' & UP TO 10 GROUPS OF CL3'PRD',AL1(SPLIT),AL1(BASE)    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OPOLSPLT NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         XC    OPOLWORK,OPOLWORK   INIT WORKAREA                                
         LA    R6,OPOLWORK         POINT TO WORKAREA                            
         LA    R5,0(R2)            POINT TO INPUT                               
*                                                                               
         CLC   =C'ZZZ',0(R5)       DONE IF NO DATA                              
         BNE   OPOLSPLX                                                         
*                                                                               
         MVC   0(3,R6),0(R5)       DISPLAY ZZZ                                  
         MVI   3(R6),C'-'                                                       
         LA    R6,4(R6)            NEXT OUPUT AREA                              
         LA    R5,3(R5)            POINT TO FIRST PRODUCT                       
*                                                                               
         LA    R4,10               MAX 10 PRODUCTS                              
*                                                                               
OPOLSPLP DS    0H                                                               
*                                                                               
         CLC   0(3,R5),SPACES      DONE IF NO PRODUCT CODE                      
         BNH   OPOLSPDN                                                         
*                                                                               
         MVC   0(3,R6),0(R5)       PRODUCT CODE                                 
*                                                                               
         LA    R6,2(R6)                                                         
*                                                                               
         CLI   0(R6),C' '          CHECK FOR 2 CH PRD CODE                      
         BE    *+8                                                              
         LA    R6,1(R6)               3 CH CODE                                 
*                                                                               
         CLI   4(R5),0             IF EQUAL PRODUCT SPLIT                       
         BNE   *+16                                                             
         MVI   0(R6),C','             NO SPLIT DISPLAYED                        
         LA    R6,1(R6)               BUMP OUTPUT POINTER                       
         B     OPOLSPCN               NEXT PRODUCT                              
*                                                                               
         MVI   0(R6),C'-'                                                       
         LA    R6,1(R6)                                                         
*                                                                               
         SR    R0,R0                                                            
         IC    R0,3(R5)            COST SHARE                                   
*                                  DISPLAY COST SHARE                           
         EDIT  (R0),(3,0(R6)),ALIGN=LEFT                                        
*                                                                               
         AR    R6,R0               BUMP OUTPUT POINTER                          
         MVI   0(R6),C'/'                                                       
         LA    R6,1(R6)                                                         
*                                                                               
         SR    R0,R0                                                            
         IC    R0,4(R5)            TOTAL WEIGHT                                 
*                                  DISPLAY TOTAL WEIGHT                         
         EDIT  (R0),(3,0(R6)),ALIGN=LEFT                                        
*                                                                               
         AR    R6,R0               BUMP OUTPUT POINTER                          
         MVI   0(R6),C','                                                       
         LA    R6,1(R6)                                                         
*                                                                               
OPOLSPCN DS    0H                                                               
*                                                                               
         LA    R5,5(R5)            BUMP TO NEXT PRODUCT                         
*                                                                               
         BCT   R4,OPOLSPLP                                                      
*                                                                               
OPOLSPDN DS    0H                                                               
*                                                                               
         BCTR  R6,0                BACKUP TO LAST COMMA                         
         MVI   0(R6),C' '          CLEAR LAST COMMA                             
*                                                                               
         L     R4,GLADTENT         ESTABLISH DRIVETABLE ENTRY                   
         USING DROD,R4                                                          
*                                                                               
         TM    PBQPOPT,PBQPOCUT    IF CUTTING OUTPUT TO ONE LINE                
         BNO   OPOLSP20                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,15,DROLEN           GET OUTPUT LENGTH                         
         BCTR  RF,0                   ENTRY LENGTH CONTAINS BOX LINE            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),OPOLWORK    MOVE TO OUTPUT                               
*                                                                               
         B     OPOLSP30                                                         
*                                                                               
OPOLSP20 DS    0H                                                               
*                                                                               
         LR    RF,R6                                                            
         LA    RE,OPOLWORK                                                      
         SR    RF,RE               OUTPUT LENGTH                                
*                                                                               
         MVC   0(4,R3),OPOLWORK    PRINT ZZZ-                                   
         LA    R3,4(R3)            BUMP OUTPUT POINTER                          
         SHI   RF,4                DECREMENT LENGTH                             
*                                                                               
         SR    R0,R0                                                            
         IC    R0,DROLEN                                                        
         SHI   R0,4                DECREMENT COLUMN WIDTH                       
*                                                                               
*        CHOP TO OUTPUT                                                         
*                                                                               
         GOTO1 CHOPPER,DMCB,(0,OPOLWORK+4),((R0),(R3)),(198,14),       X        
               C'LEN=',(RF)                                                     
*                                                                               
OPOLSP30 DS    0H                                                               
*                                                                               
OPOLSPLX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
OPOLWORK DS    CL256               WORKAREA                                     
*                                                                               
         TITLE 'PRWRITER - ADITIONAL CHARGES  - INPUT - IACH'                   
***********************************************************************         
*                                                                     *         
*        ADDITIONAL CHARGES FROM VARIOUS ELEMENTS                     *         
*                                                                     *         
*NTRY       BILL ELEMENT                                              *         
*        OR PAY  ELEMENT                                              *         
*        OR ACHG ELEMENT                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IACH     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        FIND CODE TO PRINT                                                     
*                                                                               
         SR    RF,RF               INIT CODE POINTER                            
*                                                                               
*        ADDITIONAL CHARGE ELEMENT                                              
*                                                                               
         ICM   R6,15,PBACHELA      IF ADDL CHRG ELM                             
         BZ    IACHACHN                                                         
*                                                                               
         USING PACELEM,R6          ESTABLISH ADDL CHRG ELM                      
*                                                                               
         LA    RF,PACCODE          POINT TO ELEMENTS CODE                       
         B     IACHCDEX                                                         
*                                                                               
IACHACHN DS    0H                                                               
*                                                                               
*        PAY ELEMENT                                                            
*                                                                               
         ICM   R6,15,PBPAYELA      IF PAY ELEMENT                               
         BZ    IACHPAYN                                                         
*                                                                               
         USING PPAYELEM,R6         ESTABLISH PAY ELM                            
*                                                                               
         CLI   1(R6),PPACCODE-PPAYELEM SKIP IF NO CODE IN RECORD                
         BNH   IACHCDEX                                                         
*                                                                               
         LA    RF,PPACCODE         POINT TO ELEMENTS CODE                       
*                                                                               
         B     IACHCDEX                                                         
*                                                                               
IACHPAYN DS    0H                                                               
*                                                                               
*                                                                               
*        BILLING ELEMENT                                                        
*                                                                               
         ICM   R6,15,PBBLLELA      IF BILL ELEMENT                              
         BZ    IACHBLLN                                                         
*                                                                               
         USING PBILELEM,R6         ESTABLISH BILL ELM                           
*                                                                               
         CLI   1(R6),PBACCODE-PBILELEM SKIP IF NO CODE IN RECORD                
         BNH   IACHCDEX                                                         
*                                                                               
         OC    PBACCODE,PBACCODE   SKIP IF NO CODE                              
         BZ    IACHCDEX                                                         
*                                                                               
         LA    RF,PBACCODE         POINT TO ELEMENTS CODE                       
*                                                                               
         B     IACHCDEX                                                         
*                                                                               
IACHBLLN DS    0H                                                               
*                                                                               
         B     IACHX                                                            
*                                                                               
IACHCDEX DS    0H                                                               
*                                                                               
         LTR   RF,RF               SKIP IF NO CODE FOUND                        
         BZ    *+10                                                             
         MVC   0(L'PACCODE,R2),0(RF) PASS CODE TO SORT                          
*                                                                               
*        FIND CODE DESCRIPTION IN SPECIAL CHARGE DEFINITION RECORD              
*                                                                               
         CLI   GLARGS+1,C'C'       SKIP IF CODE ONLY WANTED                     
         BE    *+8                                                              
         CLI   GLARGS+1,0                                                       
         BE    IACHX                                                            
*                                                                               
IACHKEY  DS    0H                  BUILD KEY FOR ADD'L CHG REC                  
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              ESTABLISH ADD'L CHARGE REC KEY               
         USING PSPLKEY,R4                                                       
*                                                                               
         MVC   PSPLKAGY,AGENCY     SET AGENCY                                   
         MVC   PSPLKMED,PBMED      SET MEDIA                                    
         MVI   PSPLKRCD,PSPLKIDQ   SET RECORD ID                                
*                                                                               
         CLC   PSPLKEY,IACHRCRD    SKIP IF RECORD IN CORE                       
         BE    IACHRECX                                                         
*                                                                               
IACHREC  DS    0H                  READ ADD'L CHARGE RCORD                      
*                                                                               
         GOTO1 HIGH                READ ADD'L CHARGE RECORD                     
*                                                                               
         CLC   PSPLKEY,KEYSAVE     SKIP IF RECORD NOT FOUND                     
         BNE   IACHRECX                                                         
*                                                                               
         ICM   R0,15,AIO           SAVE CURRENT IOAREA                          
*                                                                               
         LA    RF,IACHRCRD         SET I/O AREA ADDRESS                         
         ST    RF,AIO                                                           
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
         BE    *+10                IF NOT ON FILE                               
         XC    IACHRCRD(256),IACHRCRD     CLEAR I/OAREA                         
*                                                                               
         STCM  R0,15,AIO           RESTORE CURRENT AIO                          
*                                                                               
IACHRECX DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE LAST KEY READ                        
         OI    DMINBTS,8           PASS BACK DELETED RECORDS                    
*                                                                               
         GOTO1 HIGH                RESET FILE POINTERS                          
*                                                                               
         LA    R4,IACHRCRD         SWITCH POINTER TO FOUND RECORD               
*                                                                               
         LA    R6,PSPLELEM         POINT TO FIRST ADD'L CHARGE ELEMENT          
         USING PSPLELEM,R6         ESTABLISH ADD'L CHARGE ELEMENT               
         SR    RF,RF                                                            
*                                                                               
IACHLOOP DS    0H                                                               
*                                                                               
         CLI   PSPLELEM,0          DONE AT END OF RECORD                        
         BE    IACHDONE                                                         
*                                                                               
         CLC   PSPLCODE,0(R2)      MATCH ON CODE                                
         BE    IACHFND                                                          
*                                                                               
IACHCONT DS    0H                                                               
*                                                                               
         IC    RF,PSPLELEM+1       ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         POINT TO NEXT ELEMENT                        
         B     IACHLOOP                                                         
*                                                                               
IACHFND  DS    0H                                                               
*                                                                               
         MVC   2(L'PSPLDESC,R2),PSPLDESC   RETURN DESCRIPTION                   
*                                                                               
IACHDONE DS    0H                                                               
*                                                                               
         MVC   2+L'PSPLDESC(2,R2),0(R2)  COPY CODE                              
*                                                                               
         CLI   GLARGS+1,C'S'       IF SORTING ON DESCRIPTION                    
         BNE   *+10                                                             
         XC    0(2,R2),0(R2)          ERASE LEADING COPY OF CODE                
*                                                                               
IACHX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IACHRCRD DS    XL4096              ADD'L CHARGE RECORD                          
*                                                                               
         TITLE 'PRWRITER - ADITIONAL CHARGES  - OUTPUT - OACH'                  
***********************************************************************         
*                                                                     *         
*        ADDITIONAL CHARGES FROM VARIOUS ELEMENTS                     *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OACH     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        BUILD LABEL AREA FOR TOTALS AND HEADLINES                              
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREAS                            
         MVC   CODEAREA,SPACES                                                  
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OACHLBLX                                                         
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL FROM HEADLINES                   
*                                                                               
OACHLBLX DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'B'         IF CODE WANTED                               
         BE    *+8                                                              
         CLI   GLARGS,C'C'                                                      
         BE    *+8                                                              
         CLI   GLARGS,0                                                         
         BNE   *+10                                                             
         MVC   CODEAREA(2),0(R2)   PRINT IT                                     
*                                                                               
         CLI   GLARGS,C'B'         IF DESCRIPTION WANTED                        
         BE    *+8                                                              
         CLI   GLARGS,C'N'                                                      
         BE    *+8                                                              
         CLI   GLARGS,C'S'                                                      
         BNE   *+10                                                             
         MVC   NAMEAREA(L'PSPLDESC),2(R2)   PRINT IT                            
*                                                                               
OACHX    DS    0H                                                               
         GOTO1 GENOUTA                                                          
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - AD FILTER - INPUT - IADFLTR'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO EXTRACT INFO FOR AD FOUND IN BUY OR BILL RECORD   *         
*                                                                     *         
*NTRY    GLARGS+1  C'F' - AD FILTER                                   *         
*                  C'H' - PRODUCTION HOUSE REP CODE                   *         
*                                                                     *         
*EXIT    FOR REP CODE - FORMAT USED BY OADRREP                        *         
*                                                                     *         
***********************************************************************         
         EJECT                                                                  
         DS    0D                                                               
IADFLTR  NMOD1 300,**+IAFL                                                      
*                                                                               
         LR    R7,RC               SAVE WORKING STORAGE POINTER                 
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R6,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R6                                                      
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   SKIP IF BUY RECORD NOT IN CORE               
         BNE   IADFLTRX                                                         
*                                                                               
*        SET UP BXLE REGISTERS IF FIRST TIME FOR PRODUCT                        
*                                                                               
IADFINI  DS    0H                                                               
*                                                                               
         ICM   R5,15,PBAADBF       START OF ADD BUFFER                          
         BZ    IADFLTRX            NO BUFFER PROVIDED - SKIP FIELD              
*                                                                               
         USING ADBFD,R5            ESTABLISH AD BUFFER                          
*                                                                               
         CLC   ADBFPRD,PBUYKPRD    RE-INITIALIZE AD BUFFER ON PRD CHG           
         BNE   *+10                                                             
         CLC   ADBFCLT,PBCLT       OR CLIENT CHANGE                             
         BNE   *+10                                                             
         CLC   ADBFMED,PBMED       OR MEDIA CHANGE                              
         BE    IADFINIX                                                         
*                                                                               
         LA    R3,ADBFENT          POINT TO FIRST ENTRY IN BUFFER               
         LA    RE,ADBFLN           LENGTH OF BUFFER ENTRY                       
         LR    RF,R3                                                            
         BCTR  RF,0                END OF BUFFER                                
         ST    R3,ADBFBXLE         BXLE REGS FOR AD BUFFER                      
         STM   RE,RF,ADBFBXLE+4    BXLE REGS FOR AD BUFFER                      
*                                                                               
         XC    ADBFENT(ADBFHDLN),ADBFENT  INIT FIRST BUFFER ENTRY               
         XC    ADBFJBKY,ADBFJBKY                                                
         XC    ADBFJBHD,ADBFJBHD                                                
*                                                                               
         MVC   ADBFMED,PBMED       RESET BUFFER CONTROL FIELDS                  
         MVC   ADBFCLT,PBCLT                                                    
         MVC   ADBFPRD,PBUYKPRD                                                 
*                                                                               
IADFINIX DS    0H                                                               
*                                                                               
*        SEARCH AD BUFFER TO SEE IF AD CAME UP BEFORE                           
*                                                                               
IADFSRCH DS    0H                                                               
*                                                                               
         L     R3,ADBFBXLE         LOAD BUFFER BXLE REGS                        
         LM    RE,RF,ADBFBXLE+4                                                 
*                                                                               
         CR    RF,R3               BUFFER IS EMPTY IF END BEFORE START          
         BNH   IADFSRCX              GO ADD AD TO BUFFER                        
*                                                                               
         USING ADBFENT,R3          ESTABLISH BUFFER ENTRY                       
*                                                                               
IADFSRCL DS    0H                                                               
*                                                                               
         CLC   PBDJOB,PJOBKJOB-PJOBKEY+ADBFJBKY  FIND AD CODE                   
         BE    IADFADDX            FOUND - SKIP ADDING TO BUFFER                
*                                                                               
IADFSRCC DS    0H                                                               
*                                                                               
         BXLE  R3,RE,IADFSRCL                                                   
*                                                                               
*                                  AD NOT IN BUFFER                             
*                                                                               
         L     R0,PBAADBF          BUFFER START                                 
         A     R0,PBLADBF          PLUS BUFFER LENGTH                           
*                                                                               
         LA    R1,0(RE,R3)         END OF NEW BUFFER ELEMENT                    
*                                                                               
         CR    R1,R0               ELEMENT MUST FIT IN BUFFER                   
         BL    *+6                                                              
         DC    H'0'                INCREASE SIZE OF AD BUFFER                   
*                                                                               
         XC    ADBFENT(ADBFHDLN),ADBFENT  INIT NEW BUFFER ENTRY                 
         XC    ADBFJBKY,ADBFJBKY                                                
         XC    ADBFJBHD,ADBFJBHD                                                
*                                                                               
IADFSRCX DS    0H                                                               
*                                                                               
*        READ JOB RECORD FOR NEW AD                                             
*                                                                               
IADFJOB  DS    0H                                                               
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              ESTABLISH KEYAREA AS                         
         USING PJOBRECD,R4           JOB RECORD KEY                             
*                                                                               
         MVC   PJOBKAGY,PBAGY      SET AGENCY                                   
         MVC   PJOBKMED,PBMED      SET MEDIA                                    
         MVI   PJOBKRCD,PJOBKIDQ   SET TO READ JOB RECORD                       
         MVC   PJOBKCLT,PBUYKCLT   SET CLIENT                                   
         MVC   PJOBKPRD,PBUYKPRD   SET PRODUCT                                  
         MVC   PJOBKJOB,PBDJOB     SET JOB CODE                                 
*                                                                               
         GOTO1 HIGH                READ POINTER                                 
*                                                                               
         CLC   PJOBKEY,KEYSAVE     IF RECORD NOT FOUND                          
         BNE   IADFRSTR               SKIP                                      
*                                                                               
         MVC   4(4,R7),AIO         SAVE CURRENT AIO ADDRESS                     
*                                                                               
         LA    RF,80(R7)           SET I/O AREA ADDRESS                         
         ST    RF,AIO                                                           
*                                                                               
         GOTO1 GETREC              READ RECORD                                  
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         L     R4,AIO              POINT TO FOUND RECORD                        
         MVC   AIO,4(R7)           RESTORE CURRENT AIO ADDRESS                  
*                                                                               
*        ADD AD TO BUFFER                                                       
*                                                                               
         MVC   ADBFDISK,KEY+27     SAVE JOB RECORD DISK ADDRESS                 
         L     RF,PBUTLA                                                        
         MVC   ADBFSE,4(RF)        SAVE JOB RECORD SE                           
         MVC   ADBFJBKY,PJOBKEY    SAVE JOB RECORD KEY                          
         MVC   ADBFJBHD,PJOBELEM   SAVE JOB HEADER ELEMENT                      
*                                                                               
         L     RF,ADBFENA          NEW END OF BUFFER                            
         A     RF,ADBFLEN                                                       
         ST    RF,ADBFENA                                                       
*                                                                               
IADFRSTR DS    0H                  RESTORE FILE POSITIONING                     
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE LAST USED POINTER                    
         OI    DMINBTS,8           PASS BACK DELETED RECORDS                    
*                                                                               
         GOTO1 HIGH                RE-POINT FILE                                
*                                                                               
IADFADDX DS    0H                                                               
*                                                                               
*        PASS FILTER TO DRIVER                                                  
*                                                                               
IADFFLT  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'F'       SKIP IF AD FILTER NOT DESIRED                
         BNE   IADFFLTN                                                         
*                                                                               
         MVI   0(R2),L'PJOBFILT    SET DATA LENGTH                              
         MVC   1(L'PJOBFILT,R2),PJOBFILT-PJOBELEM+ADBFJBHD MOVE FILTER          
*                                                                               
         B     IADFLTRX                                                         
*                                                                               
IADFFLTN DS    0H                                                               
*                                                                               
*        PASS PRODUCTION HOUSE REP TO DRIVER                                    
*                                                                               
IADFPRH  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'H'       SKIP IF NOT PRODUCTION HOUSE                 
         BNE   IADFPRHN                                                         
*                                                                               
*        SEARCH BUFFER FOR DISK ADDRESS                                         
*                                                                               
         ICM   RE,15,PBAREPBF      ESTABLISH REP BUFFER                         
         USING REPBUFD,RE                                                       
         BNZ   *+12                                                             
         MVI   0(R2),X'FF'            INDICATE NO REP AVAILABLE                 
         B     IADFPRHX               IF NO BUFFER AVAILABLE                    
*                                                                               
         OC    REPBUFD(REPBUFLN),REPBUFD   IF NO TABLE AVAILABLE                
         BNZ   IADFPRHA                                                         
*                                                                               
         GOTO1 =V(BLDREP)             GO BUILD IT                               
*                                                                               
         ICM   RE,15,PBAREPBF      ESTABLISH REP BUFFER                         
*                                                                               
IADFPRHA DS    0H                                                               
*                                                                               
IADFPRHL DS    0H                                                               
*                                                                               
         OC    REPBUFD(REPBUFLN),REPBUFD IF END OF TABLE                        
         BNE   *+12                                                             
         MVI   0(R2),X'FF'            INDICATE NO REP AVAILABLE                 
         B     IADFPRHX                                                         
*                                                                               
         CLC   REPBUFN,PJOBPROD-PJOBELEM+ADBFJBHD MATCH REP                     
         BE    IADFPRHF                                                         
*                                                                               
IADFPRHC DS    0H                                                               
*                                                                               
         LA    RE,REPBUFLN(RE)     BUMP TABLE ENTRY POINTER                     
         B     IADFPRHL                                                         
*                                                                               
IADFPRHF DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'C'       IF NUMBER ONLY REQUIRED                      
         BNE   IADFPRH1                                                         
*                                                                               
         MVC   0(4,R2),REPBUFN       RETURN IT                                  
         B     IADFPRHX                                                         
*                                                                               
IADFPRH1 DS    0H                  ELSE                                         
*                                                                               
         MVC   0(10,R2),REPBUFNA         RETURN SHORT NAME                      
         MVC   10(4,R2),REPBUDA          AND REP REC DISK ADDRESS               
         MVI   16(R2),C'R'               REP RECORD TYPE                        
         MVC   17(1,R2),REPBUFSE         PASS SE NUMBER                         
*                                                                               
IADFPRHX DS    0H                                                               
*                                                                               
         B     IADFLTRX                                                         
*                                                                               
IADFPRHN DS    0H                                                               
*                                                                               
         DROP  RE                                                               
*                                                                               
IADFLTRX DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R3,R4,R5,R6                                                      
*                                                                               
         TITLE 'PRWRITER - ACTIVITY - INPUT - IACTIVE'                          
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FIND BUY RECORD ACTIVITY                          *         
*                                                                     *         
*NTRY    GLARGS   = C'B' - BUY RELATED DATA                           *         
*        R4     ==> BUY RECORD                                        *         
*                                                                     *         
*EXIT   4PL2   -  1ST PL8 = # OF ADDED         RECORDS                *         
*              -  2ND PL8 = # OF SPACE CHANGED RECORDS                *         
*              -  3ND PL8 = # OF DATE  CHANGED RECORDS                *         
*              -  4ND PL8 = # OF DELETED       RECORDS                *         
*                                                                     *         
***********************************************************************         
         EJECT                                                                  
         DS    0D                                                               
IACTIVE  NMOD1 0,**+IATV                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVC   0(32,R2),=4PL8'0'   INIT INPUT TO DRIVER                         
*                                                                               
*        INITIALIZE PACKED DATE FIELDS ON CHANGE IN DATES                       
*                                                                               
IATVINIT DS    0H                                                               
*                                                                               
         CLC   IATVSTB,PBQATVST    SKIP IF DATES HAVEN'T CHANGED                
         BNE   *+10                                                             
         CLC   IATVENB,PBQATVEN                                                 
         BE    IATVINIX                                                         
*                                                                               
         XC    IATVSTC,IATVSTC     INIT COMPRESSED FORM OF DATES                
         XC    IATVENC,IATVENC                                                  
*                                                                               
         GOTO1 DATCON,DMCB,(3,PBQATVST),(2,IATVSTC)  COMPRESS START DTE         
*                                                                               
         OC    PBQATVEN,PBQATVEN   IF THERE IS AN END DATE                      
         BZ    IATVINI1                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,PBQATVEN),(2,IATVENC)  COMPRESS END   DTE         
*                                                                               
IATVINI1 DS    0H                                                               
*                                                                               
IATVINIX DS    0H                                                               
*                                                                               
         USING PBUYRECD,R4         ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   SKIP IF NO BUY RECORD AVAILABLE              
         BNE   IACTIVEX                                                         
*                                                                               
         OC    PBQATVST,PBQATVST   SKIP IF NO START DATE GIVEN                  
         BZ    IACTIVEX                                                         
*                                                                               
*        IF DOING FLOWCHART, MAKE SURE BUY IN PERIOD                            
*                                                                               
IATVFLO  DS    0H                                                               
*                                                                               
         OC    GLARGS+9(3),GLARGS+9  IF DATES PASSED IN ARGUMENTS               
         BZ    IATVFLOX                                                         
*                                                                               
         CLC   PBUYKDAT(3),GLARGS+9     ENSURE DATE FALLS ON/WITHIN             
         BL    IACTIVEX                                                         
         CLC   PBUYKDAT(3),GLARGS+12                                            
         BH    IACTIVEX                                                         
*                                                                               
IATVFLOX DS    0H                                                               
*                                                                               
*        IGNORE IF BUY DOES NOT COUNT TOWARD CONTRACT                           
*                                                                               
*        CLI   PBDSPACE,C'*'       DOES NOT COUNT                               
*        BE    IACTIVEX                                                         
*                                                                               
*        DETERMINE IF BUY WAS DELETED IN PERIOD                                 
*                                                                               
IATVDEL  DS    0H                                                               
*                                                                               
         TM    PBUYCNTL,X'80'      SKIP IF BUY NOT DELETED                      
         BNO   IATVDELN                                                         
*                                                                               
         CLC   PBDDATE,PBQATVST    NOT IF LAST CHANGE BEFORE START              
         BL    IATVDELX                                                         
*                                                                               
         OC    PBQATVEN,PBQATVEN   DELETED IF NO END DATE GIVEN                 
         BZ    *+14                                                             
         CLC   PBDDATE,PBQATVEN    ELSE DELETED IF NOT AFTER END DATE           
         BH    IATVDELX                                                         
*                                                                               
         ZAP   24(8,R2),=P'1'      INDICATE BUY DELETED IN PERIOD               
*                                                                               
IATVDELX DS    0H                                                               
*                                                                               
         B     IACTIVEX            DON'T RECORD ANY OTHER CHANGES               
*                                                                               
IATVDELN DS    0H                                                               
*                                                                               
*                                                                               
*        DETERMINE IF BUY WAS ADDED IN PERIOD                                   
*                                                                               
IATVADD  DS    0H                                                               
*                                                                               
         CLC   PBDBUYDT,PBQATVST   NOT IF CREATION BEFORE START                 
         BL    IATVADDN                                                         
*                                                                               
         OC    PBQATVEN,PBQATVEN   ADDED IF NO END DATE GIVEN                   
         BZ    *+14                                                             
         CLC   PBDBUYDT,PBQATVEN   ELSE ADDED IF NOT AFTER END DATE             
         BH    IATVADDN                                                         
*                                                                               
         ZAP   0(8,R2),=P'1'       INDICATE BUY ADDED IN PERIOD                 
*                                                                               
         B     IACTIVEX            DON'T RECORD ANY CHANGES                     
*                                                                               
IATVADDN DS    0H                                                               
*                                                                               
*        RECORD DATE AND SPACE DESCRIPTION CHANGES                              
*        ONLY ONE OF EACH TYPE RECORDED                                         
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT                       
         SR    R3,R3                                                            
*                                                                               
IATVLOOP DS    0H                                                               
*                                                                               
         USING PCHGELD,R6          ESTABLISH CHANGE ELEMENT                     
*                                                                               
         CLI   PCHGELEM,PCHGELQ    SKIP IF NOT CHANGE ELEMENT                   
         BNE   IATVLPCN                                                         
*                                                                               
         CLC   PCHGDAT,IATVSTC     DO NOT USE IF CHANGE BEFORE START            
         BL    IATVLPCN                                                         
*                                                                               
         OC    IATVENC,IATVENC     USE IF NO END DATE GIVEN                     
         BZ    *+14                                                             
         CLC   PCHGDAT,IATVENC     ELSE USE IF NOT AFTER END DATE               
         BH    IATVLPCN                                                         
*                                                                               
         TM    PCHGIND1,X'30'      CHECK FOR SPACE CHANGE                       
         BZ    *+10                                                             
         ZAP   8(8,R2),=P'1'                                                    
*                                                                               
         TM    PCHGIND1,X'08'      CHECK FOR DATE  CHANGE                       
         BZ    *+10                                                             
         ZAP   16(8,R2),=P'1'                                                   
*                                                                               
IATVLPCN DS    0H                                                               
*                                                                               
         IC    R3,1(R6)            ELEMENT LENGTH                               
         LA    R6,0(R3,R6)         POINT TO NEXT ELEMENT                        
*                                                                               
         CLI   PCHGELEM,0          CONTINUE IF NOT END OF RECORD                
         BNE   IATVLOOP                                                         
*                                                                               
IACTIVEX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IATVSTB  DC    XL3'00'             ACTIVITY PERIOD START - BINARY               
IATVENB  DC    XL3'00'             ACTIVITY PERIOD END   - BINARY               
IATVSTC  DC    XL2'00'             ACTIVITY PERIOD START - COMPRESSED           
IATVENC  DC    XL2'00'             ACTIVITY PERIOD END   - COMPRESSED           
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R6                                                            
*                                                                               
         TITLE 'PRWRITER - ACTIVITY - OUTPUT - OACTIVE'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT BUY RECORD ACTIVITY                         *         
*                                                                     *         
*NTRY   4PL2   -  1ST PL2 = # OF ADDED         RECORDS                *         
*              -  2ND PL2 = # OF SPACE CHANGED RECORDS                *         
*              -  3ND PL2 = # OF DATE  CHANGED RECORDS                *         
*              -  4ND PL2 = # OF DELETED       RECORDS                *         
*                                                                     *         
*EXIT   IF ANY INDICATOR IS POSITIVE, THEN CHARACTER PRINTED          *         
*       'A' - ADDED                                                   *         
*       'C' - SPACE DESCRIPTION CHANGE                                *         
*       'M' - DATE  CHANGE                                            *         
*       'D' - DELETED                                                 *         
*                                                                     *         
*        IF TOTALS THEN EACH INDICATOR IS PRIINTED VERTICALLY WITH    *         
*           TOTAL NUMBER AFTER.                                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OACTIVE  NMOD1 0,**+OATV                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         OC    0(32,R2),0(R2)      SKIP IF NO DATA PASSED                       
         BZ    OACTIVEX                                                         
*                                                                               
         LA    R0,4                MAX 4 INDICATORS                             
         LA    R4,OATVINDS         POINT TO INDICATOR TABLE                     
*                                                                               
OATVLOOP DS    0H                                                               
*                                                                               
         CP    0(8,R2),=P'0'       SKIP IF NO ACTIVITY                          
         BE    OATVLPCN                                                         
*                                                                               
         MVC   0(1,R3),0(R4)        PRINT INDICATOR                             
*                                                                               
         CLI   GLARGS,C'T'         SKIP IF ONLY TOTALS WANTED                   
         BE    OATVTOT                                                          
         TM    GLINDS,GLTOTLIN     SKIP IF TOTAL LINE                           
         BO    OATVTOT                                                          
*                                                                               
         LA    R3,1(R3)            BUMP TO NEXT PRINT POSITION                  
*                                                                               
         B     OATVLPCN                                                         
*                                                                               
OATVTOT  DS    0H                                                               
*                                                                               
         MVC   OATVEDIT,=X'40202020' SET EDIT PATTERN                           
         ED    OATVEDIT,6(R2)      PRINT ACTIVITY NUMBER                        
         MVC   1(3,R3),OATVEDIT+1  MOVE TO PRINT AREA                           
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT PRINT LINE                      
*                                                                               
OATVLPCN DS    0H                                                               
*                                                                               
         LA    R2,8(R2)            POINT TO NEXT COUNTER                        
         LA    R4,1(R4)            POINT TO NEXT INDICATOR IN TABLE             
         BCT   R0,OATVLOOP                                                      
*                                                                               
OACTIVEX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OATVINDS DC    C'ACMD'             INDICATOR TABLE                              
OATVEDIT DS    CL4                 EDIT WORKAREA                                
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - ADDRESS/REP - INPUT - IADRREP'                       
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FIND CONTRACT, PAY OR TRAFFIC ADDRESS             *         
*        REP ENTRIES SENT HERE BUT SKIP ADDRESS OVERRIDE ELEMENT LOGIC*         
*                                                                     *         
*        HIERARCHY OF ADDRESSES(REPS) IS                              *         
*          1. BUY OVERRIDE (PAY ONLY)                                 *         
*          2. PUB ADDRESS OVERRIDE FOR CLIENT                         *         
*          3. PUB REP     OVERRIDE FOR CLIENT                         *         
*          4. PUB ADDRESS OVERRIDE FOR OFFICE                         *         
*          5. PUB REP     OVERRIDE FOR OFFICE                         *         
*          6. PUB ADDRESS OVERRIDE FOR AGENCY                         *         
*          7. PUB REP     OVERRIDE FOR AGENCY                         *         
*          8. PUB ADDRESS                                             *         
*                                                                     *         
*NTRY    GLARGS   = C'P' - PUB RELATED DATA                           *         
*        GLARGS+1 = C'C' - CONTRACT ADDRESS                           *         
*                   C'P' - PAY      ADDRESS                           *         
*                   C'T' - TRAFFIC  ADDRESS                           *         
*                   C'S' - SHIPPING ADDRESS                           *         
*                   C'A' - DEFAULT  ADDRESS                           *         
*        GLARGS+2 = C'A' - ADDRESS ONLY                               *         
*                   C'B' - REP CODE & NAME OR NAME & ADDRESS          *         
*                   C'C' - REP CODE FOR REPS                          *         
*                   C'F' - FAX NUMBER                                 *         
*                   C'N' - NAME ONLY                                  *         
*                   C'T' - TELEPHONE NUMBER                           *         
*                   C'W' - ATTENTION NAME (WHO)                       *         
*        GLARGS+3 = C'A' - ADDRESS ENTRY                              *         
*                   C'R' - REP     ENTRY                              *         
*                                                                     *         
*EXIT   0-9    -  1ST 10 BYTES OF NAME                                *         
*                                                                     *         
*       10-13  -  RECORD DISK ADDRESS                                 *         
*       14-15  -  ELEMENT DISPLACEMENT IN RECORD                      *         
*       16     -  RECORD IDENTIFIER 'B', 'P', 'C', 'R'                *         
*       17     -  SE NUMBER FOR FILES IF DOING AOR REPORT             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IADRREP  NMOD1 0,**+IADR                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVI   IADRELCD,0          INIT WORKAREA                                
         XC    IADRTAB(IADRTABL),IADRTAB  INIT WORKAREA                         
         MVC   IADRID,=3X'FF'      INIT ADDRESS ID                              
*                                                                               
         TM    PBQREQFL,X'08'      IF PUB NOT REQUESTED AS C/M/ROW              
         BNO   IADRERR             THEN PUB RECORD NOT READ AND NO DATA         
*                                    AVAILABLE                                  
*        A PAY REP OVERRIDE IN THE BUY OVERRIDES ALL ADDRESSES                  
*                                                                               
IADROVR  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'P'       MUST BE PAY ENTRY                            
         BNE   IADROVRX                                                         
*                                                                               
         TM    PBQREQFL,X'04'      MUST HAVE INSERT DATE AS ROW/M/H             
         BNO   IADROVRX              TO ENSURE BUY AVAILABLE                    
*                                                                               
         OC    PBAREPBF,PBAREPBF   SKIP IF NO REP BUFFER AVAILABLE              
         BZ    IADROVRX                                                         
*                                                                               
         L     R6,AIO1             POINT TO BUY RECORD                          
*                                                                               
         MVI   IADRELCD,PBSREPQ    LOOKING FOR SPECIAL REP ELEMENT              
*                                                                               
         BAS   RE,IADRGTEL         LOOK FOR  REP OVERRIDE ELM IN BUY            
         BNE   IADROVRX            NONE FOUND                                   
*                                                                               
         USING PBSREPD,R6          ESTABLISH SPECIAL REP ELEMENT                
*                                                                               
         MVI   IADRTYPE,IADRTPRQ   INDICATE REP BEING USED                      
         XC    IADRID,IADRID       SET LOWEST ADDRESS IDENTIFIER                
         MVC   IADRADDR,PBSREP     SAVE REP ID FROM ELEMENT                     
         MVI   IADRSRC,IADRREPQ    INIDCATE REP RECORD SOURCE                   
*                                                                               
         B     IADROK              GO USE ADDRESS                               
*                                                                               
IADROVRX DS    0H                                                               
*                                                                               
*        IF LOOKING FOR CONTRACT ATTENTION                                      
*          THEN ATTENTION IN CONTRACT RECORD OVERRIDES ALL                      
*                                                                               
IADRCAT  DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'R'       SKIP IF LOOKING FOR REP DATA                 
         BE    IADRCATX                                                         
*                                                                               
         CLI   GLARGS+2,C'W'       MUST BE ATTENTION                            
         BNE   IADRCATX                                                         
         CLI   GLARGS+1,C'C'       FOR     CONTRACT                             
         BNE   IADRCATX                                                         
*                                                                               
         L     R6,AIO2             POINT TO CONTRACT RECORD                     
*                                                                               
         CLI   PCONKRCD-PCONRECD(R6),PCONKIDQ SKIP IF REC NOT IN CORE           
         BNE   IADRCATX                                                         
*                                                                               
         MVI   IADRELCD,PCATELQ    SET FOR ATTENTION ELEMENT                    
*                                                                               
         BAS   RE,IADRGTEL         FIND ELEMENT                                 
         BNE   IADRCATX            NOT FOUND                                    
*                                                                               
         MVI   IADRTYPE,IADRTPAQ   INDICATE ADDRESS BEING USED                  
         XC    IADRID,IADRID       SET LOWEST ADDRESS IDENTIFIER                
         STCM  R6,15,IADRADDR      SAVE ELEMENT ADDRESS                         
         MVI   IADRSRC,IADRCONQ    INDICATE CONTRACT RECORD SOURCE              
*                                                                               
         B     IADROK                                                           
*                                                                               
IADRCATX DS    0H                                                               
*                                                                               
*        FIND ADDRESS OVERRIDES ELEMENTS IN PUB RECORD                          
*                                                                               
IADRAOV  DS    0H                                                               
*                                                                               
         MVI   IADRSRC,IADRPUBQ    DATA FROM PUB RECORD                         
*                                                                               
         CLI   GLARGS+3,C'R'       SKIP IF ONLY WANT REP DATA                   
         BE    IADRAOVX                                                         
*                                                                               
         CLI   GLARGS+1,C'P'       DETERMINE TYPE OF ADDRESS ELM SOUGHT         
         BNE   *+8                                                              
         MVI   IADRELCD,PUBPAOVQ   PAY                                          
*                                                                               
         CLI   GLARGS+1,C'C'                                                    
         BNE   *+8                                                              
         MVI   IADRELCD,PUBCAOVQ   CONTRACT                                     
*                                                                               
         CLI   GLARGS+1,C'T'                                                    
         BNE   *+8                                                              
         MVI   IADRELCD,PUBTAOVQ   TRAFFIC                                      
*                                                                               
         CLI   GLARGS+1,C'S'                                                    
         BNE   *+8                                                              
         MVI   IADRELCD,PUBSAOVQ   SHIPPING                                     
*                                                                               
IADRAOV1 DS    0H                                                               
*                                                                               
         L     R6,AIO3             POINT TO PUB RECORD                          
*                                                                               
         BAS   RE,IADRGTEL         GET FIRST ELEMENT OF TYPE                    
         BNE   IADRAOVD            NONE FOUND                                   
*                                                                               
IADRAOVL DS    0H                                                               
*                                                                               
         USING PUBAOVEL,R6         ESTABLISH ADDRESS OVERRIDE ELEMENT           
*                                                                               
         CLC   =C'*PURGE',PUBAONAM SKIP IF ADDRESS HAS BEEN PURGED              
         BE    IADRAOVC                                                         
*                                                                               
         CLC   PUBAOFF,=3X'FF'     POSSIBLE IF AGENCY OVERRIDE                  
         BE    IADRAOVF                                                         
*                                                                               
         CLI   PUBAOFF,X'FF'       SKIP IF NOT AN OFFICE OVERRIDE               
         BNE   *+10                                                             
         CLC   PUBAOFF+1(1),PBCOFF POSSIBILITY IF CLIENT'S OFC OVERRIDE         
         BE    IADRAOVF                                                         
*                                                                               
         TM    PBQREQFL,X'18'      CAN CHECK FOR CLIENT IF MEDIA AND            
         BNO   IADRAOVC              CLIENT REQUESTED AS R/M/H                  
*                                                                               
         CLI   GLARGS+1,C'C'       IF CONTRACT RELATED DATA                     
         BNE   IADRAOV3                                                         
         CLI   PBCPROF+5,C'2'         AND A SLAVE CLIENT                        
         BNE   IADRAOV3                                                         
*                                                                               
         CLC   PUBAOFF,PBCPROF+6          MATCH TO MASTER CLIENT                
         BE    IADRAOVF                                                         
*                                                                               
         B     IADRAOVC                                                         
*                                                                               
IADRAOV3 DS    0H                  ELSE                                         
*                                                                               
         CLC   PUBAOFF,PBCLT       MATCH CLIENT                                 
         BE    IADRAOVF                                                         
*                                                                               
IADRAOVC DS    0H                                                               
*                                                                               
         BAS   RE,IADRNXEL         FIND NEXT ELEMENT                            
         BE    IADRAOVL                                                         
         B     IADRAOVD            NONE FOUND                                   
*                                                                               
IADRAOVF DS    0H                                                               
*                                                                               
         CLC   PUBAOFF,IADRID      COMPARE IDS                                  
         BH    IADRAOVD            SKIP IF HIGHER THAN PREVIOUS ID              
         BL    *+14                USE  IF LOWER  THAN PREVIOUS ID              
         OC    IADRADDR,IADRADDR   USE  IF  EQUAL AND NO ADDR FOUND YET         
         BNZ   IADRAOVD              ELSE SKIP                                  
*                                                                               
         MVI   IADRTYPE,IADRTPAQ   INDICATE ADDRESS OVERRIDE ELEMENT            
         MVC   IADRID,PUBAOFF      SAVE ADDRESS AGY/OFC/CLT ID                  
         STCM  R6,15,IADRADDR      SAVE ELEMENT ADDRESS                         
*                                                                               
IADRAOVD DS    0H                                                               
*                                                                               
         OC    IADRADDR,IADRADDR   SKIP IF WE HAVE DATA                         
         BNZ   IADRAOVX                                                         
*                                                                               
         CLI   IADRELCD,PUBSAOVQ   SHIPPING ADDRESS DEFAULTS TO                 
         BNE   IADRAOVX                                                         
*                                                                               
         MVI   IADRELCD,PUBTAOVQ   TRAFFIC ADDRESS                              
         B     IADRAOV1            GO FIND IT                                   
*                                                                               
IADRAOVX DS    0H                                                               
*                                                                               
*        FIND REP ADDRESS OVERRIDE ELEMENTS IN PUB RECORD                       
*                                                                               
IADRROV  DS    0H                                                               
*                                                                               
         OC    PBAREPBF,PBAREPBF   SKIP IF NO REP BUFFER AVAILABLE              
         BZ    IADRROVX                                                         
*                                                                               
         CLI   IADRELCD,PUBSAOVQ   SKIP IF SHIPPING DATA WANTED                 
         BE    IADRROVX                                                         
*                                                                               
         MVI   IADRELCD,PUBREPQ    LOOKING FOR REP ELEMENT                      
*                                                                               
         L     R6,AIO3             POINT TO START OF PUB RECORD                 
*                                                                               
         BAS   RE,IADRGTEL         GET FIRST ELEMENT OF TYPE                    
         BNE   IADRROVD            NONE FOUND                                   
*                                                                               
IADRROVL DS    0H                                                               
*                                                                               
         USING PUBREPD,R6          ESTABLISH REP ELEMENT                        
*                                                                               
         CLC   PUBRPOFF,=3X'FF'    POSSIBLE IF AGENCY OVERRIDE                  
         BE    IADRROVF                                                         
*                                                                               
         CLI   PUBRPOFF,X'FF'      SKIP IF NOT AN OFFICE OVERRIDE               
         BNE   *+14                                                             
         CLC   PUBRPOFF+1(1),PBCOFF POSSIBILITY IF CLT'S OFC OVERRIDE           
         BE    IADRROVF                                                         
*                                                                               
         TM    PBQREQFL,X'18'      CAN CHECK FOR CLIENT IF MEDIA AND            
         BNO   IADRROVC              CLIENT REQUESTED AS R/M/H                  
*                                                                               
         CLI   GLARGS+1,C'C'       IF CONTRACT RELATED DATA                     
         BNE   IADRROV3                                                         
         CLI   PBCPROF+5,C'2'         AND A SLAVE CLIENT                        
         BNE   IADRROV3                                                         
*                                                                               
         CLC   PUBRPOFF,PBCPROF+6   MATCH TO MASTER CLIENT                      
         BE    IADRROVF                                                         
*                                                                               
         B     IADRROVC                                                         
*                                                                               
IADRROV3 DS    0H                  ELSE                                         
*                                                                               
         CLC   PUBRPOFF,PBCLT      MATCH CLIENT                                 
         BNE   IADRROVC                                                         
*                                                                               
IADRROVF DS    0H                                                               
*                                                                               
         CLC   PUBRPOFF,IADRID     COMPARE IDS                                  
         BH    IADRROVD            SKIP IF HIGHER THAN PREVIOUS ID              
         BL    *+14                USE  IF LOWER  THAN PREVIOUS ID              
         OC    IADRADDR,IADRADDR   USE  IF  EQUAL AND NO ADDR FOUND YET         
         BNZ   IADRROVD              ELSE SKIP                                  
*                                                                               
         SR    R1,R1                                                            
*                                                                               
         CLI   GLARGS+1,C'P'       POINT TO CORRECT REP ID                      
         BNE   *+8                                                              
         LA    R1,PUBPAREP         PAY REP                                      
*                                                                               
         CLI   GLARGS+1,C'C'                                                    
         BNE   *+8                                                              
         LA    R1,PUBCNREP         CONTRACT REP                                 
*                                                                               
         CLI   GLARGS+1,C'T'                                                    
         BNE   *+8                                                              
         LA    R1,PUBTRREP         TRAFFICE REP                                 
*                                                                               
         CLI   GLARGS+1,C'S'       SHIPPING ADDR IS DEFAULTING TO               
         BNE   *+8                   TRAFFIC ADDR HERE                          
         LA    R1,PUBTRREP         TRAFFICE REP                                 
*                                                                               
         LTR   R1,R1               MUST HAVE AN ADDRESS                         
         BZ    IADRROVC                                                         
*                                                                               
         OC    0(4,R1),0(R1)       SKIP IF WANTED REP MISSING                   
         BZ    IADRROVC                                                         
*                                                                               
         MVI   IADRTYPE,IADRTPRQ   INDICATE ADDRESS OVERRIDE ELEMENT            
         MVC   IADRID,PUBRPOFF     SAVE ADDRESS AGY/OFC/CLT ID                  
         MVC   IADRADDR,0(R1)      SAVE REP ID                                  
         MVI   IADRSRC,IADRREPQ    INIDCATE REP RECORD SOURCE                   
*                                                                               
*        FIRST ADDRESS FOUND WILL HAVE HIGHEST PRIORITY OF TYPE                 
*                                                                               
         B     IADRROVX            GO ON TO NEXT ADDR TYPE                      
*                                                                               
IADRROVC DS    0H                                                               
*                                                                               
         BAS   RE,IADRNXEL         FIND NEXT ELEMENT                            
         BE    IADRROVL              FOUND                                      
         B     IADRROVD              NOT FOUND                                  
*                                                                               
IADRROVD DS    0H                                                               
*                                                                               
IADRROVX DS    0H                                                               
*                                                                               
*        DEFAULT TO PUB'S ADDRESS IF NOTHING FOUND YET                          
*                                                                               
IADRDFL  DS    0H                                                               
*                                                                               
         OC    IADRADDR,IADRADDR   SKIP IF DATA FOUND ALREADY                   
         BNZ   IADRDFLX                                                         
*                                                                               
         CLI   GLARGS+3,C'A'       USE DEFAULT ONLY FOR ADDRESS ENTRIES         
         BNE   IADRERR             ELSE AND ERROR                               
*                                                                               
         MVI   IADRELCD,PUBNAMQ    FIND PUB NAME & ADDRESS ELEMENT              
*                                                                               
         L     R6,AIO3             POINT TO START OF PUB RECORD                 
*                                                                               
         BAS   RE,IADRGTEL                                                      
         BNE   IADRDFLX            EXIT IF NONE FOUND                           
*                                                                               
         MVI   IADRTYPE,IADRTPPQ   INDICATE PUB DEFAULT ADDRESS                 
         MVC   IADRID,=3X'FF'      ID IS THAT OF AGENCY                         
         MVI   IADRELCD,PUBNAMQ    FIND PUB NAME ELEMENT                        
         STCM  R6,15,IADRADDR      SAVE ELEMENT ADDRESS                         
*                                                                               
IADRDFLX DS    0H                                                               
*                                                                               
IADROK   DS    0H                                                               
*                                                                               
         OC    IADRADDR,IADRADDR   MUST HAVE DATA                               
         BZ    IADRERR                                                          
*                                                                               
*        IF REP ADDRESS THEN SEARCH BUFFER FOR DISK ADDRESS                     
*                                                                               
         CLI   IADRTYPE,IADRTPRQ   SKIP IF NOT REP NUMBER                       
         BNE   IADREPX                                                          
*                                                                               
         ICM   RE,15,PBAREPBF      ESTABLISH REP BUFFER                         
         USING REPBUFD,RE                                                       
         BZ    IADREPNO               NO BUFFER                                 
*                                                                               
         OC    REPBUFD(REPBUFLN),REPBUFD   IF NO TABLE AVAILABLE                
         BNZ   IADREPA                                                          
*                                                                               
         GOTO1 =V(BLDREP)             GO BUILD IT                               
*                                                                               
         ICM   RE,15,PBAREPBF      ESTABLISH REP BUFFER                         
*                                                                               
IADREPA  DS    0H                                                               
*                                                                               
IADREPLP DS    0H                                                               
*                                                                               
         OC    REPBUFD(REPBUFLN),REPBUFD   IF NO TABLE AVAILABLE                
         BZ    IADREPNO              PROCESS NO REP SITUATION                   
*                                                                               
         CLC   REPBUFN,IADRADDR    LOOK FOR REP NUMBER MATCH                    
         BE    IADREPFD                                                         
*                                                                               
IADREPCN DS    0H                                                               
*                                                                               
         LA    RE,REPBUFLN(RE)     BUMP TABLE ENTRY POINTER                     
         B     IADREPLP                                                         
*                                                                               
IADREPFD DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'C'       IF NUMBER ONLY REQUIRED                      
         BNE   IADREP10                                                         
*                                                                               
         MVC   0(4,R2),REPBUFN       RETURN IT                                  
         B     IADRREPX                                                         
*                                                                               
IADREP10 DS    0H                  ELSE                                         
*                                                                               
         MVC   0(10,R2),REPBUFNA         RETURN SHORT NAME                      
         MVC   10(4,R2),REPBUDA          AND REP REC DISK ADDRESS               
         MVC   16(1,R2),IADRSRC          RETURN RECORD TYPE                     
         MVC   17(1,R2),REPBUFSE         PASS SE NUMBER                         
         B     IADRREPX                                                         
*                                                                               
         DROP  RE                                                               
*                                                                               
IADREPNO DS    0H                  NO REP FOUND IN TABLE                        
*                                    DEFAULT TO PUB ADDRESS                     
*                                                                               
         L     R6,AIO3             POINT TO PUB RECORD                          
*                                                                               
         MVI   IADRELCD,PUBNAMQ    LOOK FOR PUB NAME ADDRESS                    
*                                                                               
         BAS   RE,IADRGTEL         FIND ELEMENT                                 
         BNE   IADRERR               NOT FOUND IS AN ERROR                      
*                                                                               
         MVI   IADRTYPE,IADRTPPQ   INDICATE PUB DEFAULT DATA                    
         MVI   IADRSRC,IADRPUBQ    INDICATE ADDRESS IN PUB RECORD               
         MVC   IADRID,=3X'FF'      FLAG AS AGENCY LEVEL ADDRESS                 
         STCM  R6,15,IADRADDR      SAVE ELEMENT ADDRESS                         
*                                                                               
IADREPX  DS    0H                                                               
*                                                                               
*        ADDRESS ELEMENTS                                                       
*                                                                               
IADRELM  DS    0H                                                               
*                                                                               
         CLI   IADRSRC,IADRCONQ    IF CONTRACT RECORD MUST GET PUB NAME         
         BNE   IADRCADX                                                         
*                                                                               
         L     R6,AIO3             POINT TO PUB RECORD                          
*                                                                               
         MVI   IADRELCD,PUBNAMQ    LOOK FOR PUB NAME ADDRESS                    
*                                                                               
         BAS   RE,IADRGTEL         FIND ELEMENT                                 
         BNE   IADRERR               NOT FOUND IS AN ERROR                      
*                                                                               
         MVC   0(10,R2),PUBNAME-PUBNAMD(R6) RETURN SHORT NAME FOR SORT          
*                                                                               
         ICM   R6,15,IADRADDR      RE-POINT TO ADDRESS ELEMENT                  
*                                                                               
         B     IADRELM1                                                         
*                                                                               
IADRCADX DS    0H                                                               
*                                                                               
         ICM   R6,15,IADRADDR      POINT TO ADDRESS ELEMENT                     
*                                                                               
         CLI   0(R6),PUBNAMQ       SKIP IF NOT PUB NAME ELEM                    
         BNE   IADRNNAM                                                         
*                                                                               
         MVC   0(10,R2),PUBNAME-PUBNAMD(R6) RETURN SHORT NAME FOR SORT          
*                                                                               
         CLI   GLARGS+2,C'F'       FAX IN SUPPLEMENTAL ELEMENT                  
         BE    *+8                                                              
         CLI   GLARGS+2,C'T'       TELEPHONE   "                                
         BE    *+8                                                              
         CLI   GLARGS+2,C'W'       ATTENTION                                    
         BNE   IADRELM1                                                         
*                                                                               
         MVI   IADRELCD,PUBSADQ    SET FOR SUPPLEMENTAL ELEMENT                 
*                                                                               
         L     R6,AIO3             POINT TO START OF PUB RECORD                 
*                                                                               
         BAS   RE,IADRGTEL         SEARCH FOR ELEMENT                           
         BNE   IADRERR             NEED ELEMENT                                 
*                                                                               
         STCM  R6,15,IADRADDR      RESET ELEMENT ADDRESS                        
*                                                                               
         B     IADRELM1                                                         
*                                                                               
IADRNNAM DS    0H                                                               
*                                                                               
         MVC   0(10,R2),PUBAONAM-PUBAOVEL(R6) RETURN SHORT NAME FOR SRT         
*                                                                               
IADRELM1 DS    0H                                                               
*                                                                               
         L     RF,AIO3             POINT TO PUB RECORD                          
*                                                                               
         CLI   IADRSRC,IADRCONQ    CHECK FOR CONTRACT RECORD                    
         BNE   IADRELM2                                                         
*                                                                               
         MVC   10(4,R2),PBQCONDA   RETURN DISK ADDRESS                          
*                                                                               
         ICM   RE,15,PBUTLA        IF UTL ADDRESS KNOWN                         
         BZ    *+10                                                             
         MVC   17(1,R2),4(RE)         PASS SE NUMBER FOR FILES                  
*                                                                               
         L     RF,AIO2             POINT TO CONTRACT RECORD                     
*                                                                               
         B     IADRELM3                                                         
*                                                                               
IADRELM2 DS    0H                                                               
*                                                                               
         MVC   10(4,R2),29(RF)     RETURN DISK ADDRESS                          
*                                                                               
         ICM   RE,15,PBUTLA        IF UTL ADDRESS KNOWN                         
         BZ    *+10                                                             
         MVC   17(1,R2),4(RE)          PASS SE NUMBER FOR FILES                 
*                                                                               
IADRELM3 DS    0H                                                               
*                                                                               
         SR    R6,RF               GET ELEMENT DISPLACEMENT                     
         BNM   *+6                                                              
         DC    H'0'                                                             
*                                                                               
         STCM   R6,3,14(R2)        RETURN ELEMENT DISPLACEMENT                  
         MVC   16(1,R2),IADRSRC    RETURN RECORD ID                             
*                                                                               
         B     IADRREPX                                                         
*                                                                               
IADRERR  MVI   0(R2),255           FLAG AS NO DATA FOUND                        
         B     IADRREPX                                                         
*                                                                               
IADRREPX DS    0H                                                               
         XIT1                                                                   
*                                                                               
IADRKEY  DC    XL(L'KEY)'00'       CURRENT KEY      SAVEAREA                    
         EJECT                                                                  
***********************************************************************         
*                                                                     *         
*        ROUTINE TO SEARCH RECORD FOR SPECIFIC ELEMENT                *         
*              SECOND ENTRY POINT TO FIND NEXT ELEMENT OF TYPE        *         
*                                                                     *         
*                                                                     *         
*NTRY    R6 ==> START OF RECORD TO SEARCH                             *         
*               IF LOOKING FOR NEXT ELEMENT R6 POINTS TO LAST ELEMENT *         
*                  FOUND                                              *         
*        IADRELCD = ELEMENT CODE TO SEARCH FOR                        *         
*                                                                     *         
*EXIT    R6 ==> FOUND ELEMENT                                         *         
*                                                                     *         
*        CC IS ^= IF NO ELEMENT FOUND                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
IADRGTEL DS    0H                  FIND FIRST ELEMENT OF TYPE                   
*                                                                               
         LA    R6,33(R6)           POINT TO FIRST ELEMENT IN RECORD             
         B     IADRGT10                                                         
*                                                                               
IADRNXEL DS    0H                  FIND NEXT ELEMENT OF TYPE                    
*                                                                               
         SR    R0,R0                                                            
         IC    R0,1(R6)            BUMP TO NEXT ELEMENT IN RECORD               
         AR    R6,R0                                                            
*                                                                               
IADRGT10 DS    0H                  FIND NEXT ELEMENT OF TYPE                    
*                                                                               
         CLI   0(R6),0             CHECK FOR EOR                                
         BE    IADRGTX1                                                         
*                                                                               
         CLC   IADRELCD,0(R6)      LOOK FOR ELEMENT CODE MATCH                  
         BE    IADRGTX                                                          
         B     IADRNXEL                                                         
*                                                                               
IADRGTX1 DS    0H                                                               
*                                                                               
         LTR   R6,R6               SET UNEQUAL CC                               
         B     IADRGTX                                                          
*                                                                               
IADRGTX2 DS    0H                                                               
*                                                                               
         CR    R6,R6               SET EQUAL   CC                               
*                                                                               
IADRGTX  DS    0H                                                               
*                                                                               
         BR    RE                                                               
         EJECT                                                                  
         LTORG                                                                  
         SPACE 2                                                                
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IADRELCD DC    X'00'               ELEMENT FIND ROUTINE WORKAREA                
*                                                                               
IADRTAB  DS    0X                  ADDRESS TABLE                                
IADRTYPE DC    XL1'00'             ADDRESS TYPE                                 
IADRTPAQ EQU   C'1'                SPECIFIC ADDRESS FROM AN ELEMENT             
IADRTPRQ EQU   C'2'                REP                                          
IADRTPPQ EQU   C'3'                PUB DEFAULT ADDRESS                          
IADRID   DC    XL3'00'             ADDRESS IDENTIFIER - CLT/OFF/AGY             
IADRADDR DC    XL4'00'             ADDRESS OF ELEMENT OR REP #                  
IADRSRC  DC    XL1'00'             SOURCE RECORD FOR REPS                       
IADRBUYQ EQU   C'B'                  BUY                                        
IADRCONQ EQU   C'C'                  CONTRACT                                   
IADRPUBQ EQU   C'P'                  PUB                                        
IADRREPQ EQU   C'R'                  REP                                        
IADRTABL EQU   *-IADRTAB           TABLE LENGTH                                 
*                                                                               
*                                                                               
*-------------->  Special Rep ================================                  
*                                                                               
OBYSREP  NMOD1 0,**+SREP                                                        
         L     RC,GLAWORKD         Reset working storage pointer                
         USING GEND,RC                                                          
         CLI   0(R2),X'FF'         Have special rep?                            
         JE    OBYSR_X                                                          
         OC    0(08,R2),0(R2)      Have rep key?                                
         JZ    OBYSR_X                                                          
         MVC   0(04,R3),4(R2)      Move rep code to output                      
         CLI   GLARGS+0,C'C'       Want code only?                              
         JE    OBYSR_X                                                          
         CLC   OBYSSVKY(8),0(R2)   Same rep key from previous?                  
         JNE   OBYSR20                                                          
         MVC   5(30,R3),OBYSSVRN                                                
         CLI   GLARGS+0,C'B'       Want both code and name?                     
         JE    OBYSR_X                                                          
         MVC   0(35,R3),SPACES     Clear everything                             
         MVC   0(30,R3),OBYSSVRN   Pass back name only                          
         J     OBYSR_X                                                          
OBYSR20  XC    KEY,KEY                                                          
         MVC   KEY(08),0(R2)                                                    
         MVC   OBYSSVKY,KEY                                                     
         GOTO1 HIGH                                                             
         CLC   KEY(08),KEYSAVE     Found rep record?                            
         JE    *+14                                                             
         MVC   0(26,R3),=C'** Rep code not on file **'                          
         J     OBYSR_X                                                          
         MVC   OBYSFUL1,AIO        Save AIO                                     
         L     R4,AIO3                                                          
         ST    R4,AIO                                                           
         GOTO1 GETREC                                                           
         MVC   OBYSSVRN,PREPNAME-PREPREC(R4)                                    
         MVC   5(30,R3),OBYSSVRN                                                
         CLI   GLARGS+0,C'B'       Want both code and name?                     
         JE    *+16                                                             
         MVC   0(35,R3),SPACES     Clear everything                             
         MVC   0(30,R3),OBYSSVRN   Pass back name only                          
         MVC   AIO,OBYSFUL1                                                     
OBYSR_X  XIT1                                                                   
         LTORG                                                                  
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OBYSFUL1 DC    X'00'                                                            
OBYSSVKY DC    XL(L'KEY)'00'                                                    
OBYSSVRN DC    CL(L'PREPNAME)' '                                                
*                                                                               
         TITLE 'PRWRITER - ADDRESS/REP - OUTPUT - OADRREP'                      
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT ADDR/REP DATA ON OUTPUT                     *         
*                                                                     *         
*NTRY   0-9    -  1ST 10 BYTES OF NAME                                *         
*       10-13  -  RECORD DISK ADDRESS                                 *         
*       14-15  -  ELEMENT DISPLACEMENT IN RECORD                      *         
*       16     -  RECORD IDENTIFIER 'B', 'P', 'C', 'R'                *         
*       17     -  SE NUMBER FOR FILES IF DOING AOR REPORT             *         
*                                                                     *         
*        GLARGS   = C'C' - CONTRACT ADDRESS                           *         
*                   C'B' - AD BILL REP ADDRESS                        *         
*                   C'P' - PAY      ADDRESS                           *         
*                   C'T' - TRAFFIC  ADDRESS                           *         
*                   C'S' - SHIPPING ADDRESS                           *         
*                   C'H' - PRODUCTION HOUSE ADDRESS                   *         
*        GLARGS+1 = C'A' - ADDRESS                                    *         
*                   C'B' - REP CODE & NAME OR NAME & ADDRESS          *         
*                   C'C' - REP CODE FOR REPS                          *         
*                   C'F' - FAX NUMBER                                 *         
*                   C'N' - NAME ONLY                                  *         
*                   C'T' - TELEPHONE NUMBER                           *         
*                   C'W' - ATTENTION NAME (WHO)                       *         
*        GLARGS+2 = C'A' - ADDRESS ENTRY                              *         
*                   C'R' - REP     ENTRY                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OADRREP  NMOD1 0,**+OADR                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVI   PAOSESAV,0          INIT SE SAVEAREA                             
*                                                                               
         CLI   MYLTYP,C'M'         IF MID-LINE MUST CLEAR IT                    
         BNE   *+10                                                             
         XC    0(140,R3),0(R3)      CLEAR MIDLINE                 L14           
*                                                                               
*        BUILD LABEL AREA FOR TOTALS AND HEADLINES                              
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREAS                            
         MVC   CODEAREA,SPACES                                                  
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OADLBLX                                                          
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL AREA                             
*                                                                               
OADLBLX  DS    0H                                                               
*                                                                               
*        FILL IN LABEL AREA BASED ON ADDR/REP TYPE                              
*                                                                               
         CLI   GLARGS+2,C'R'       SKIP UNLESS REP DATA ASKED FOR               
         BE    *+8                                                              
         CLI   16(R2),C'R'         OR REP DATA FOUND                            
         BNE   OADRLBLX                                                         
*                                                                               
         MVC   LABLAREA,SPACES     INIT LABLAREA                                
*                                                                               
         CLI   GLARGS,C'P'         PAY                                          
         BNE   *+10                                                             
         MVC   LABLAREA(7),=C'PAY REP'                                          
*                                                                               
         CLI   GLARGS,C'C'         CONTRACT                                     
         BNE   *+10                                                             
         MVC   LABLAREA(12),=C'CONTRACT REP'                                    
*                                                                               
         CLI   GLARGS,C'T'         TRAFFIC                                      
         BNE   *+10                                                             
         MVC   LABLAREA(11),=C'TRAFFIC REP'                                     
*                                                                               
         CLI   GLARGS,C'H'         PRODUCTION HOUSE                             
         BNE   *+10                                                             
         MVC   LABLAREA(11),=C'PROD. HOUSE'                                     
*                                                                               
         CLI   GLARGS,C'B'         AD BILLING REP                               
         BNE   *+10                                                             
         MVC   LABLAREA(12),=C'BILLING REP.'                                    
*                                                                               
         CLI   0(R2),255             IF MISSING REP                             
         BNE   OADRLBLX                                                         
*                                                                               
         MVC   CODEAREA(4),=C'****'  DISPLAY MESSAGE                            
         MVC   NAMEAREA(10),=C'** NONE **'                                      
*                                                                               
         CLI   MYLTYP,C'H'         IF NOT HEADLINE                              
         BE    *+16                                                             
         MVC   CODEAREA(3),=C'N/A'      PRINT N/A                               
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         B     OADRREPY            EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
OADRLBLX DS    0H                                                               
*                                                                               
         CLI   0(R2),X'FF'         EXIT IF NO DATA GIVEN                        
         BE    OADRREPX                                                         
*                                                                               
         CLI   GLARGS+1,C'C'       IF REP CODE ONLY ASKED FOR                   
         BNE   OADRRCDX                                                         
*                                                                               
         MVC   CODEAREA(4),0(R2)   PRINT IT                                     
*                                                                               
         B     OADRREPY            EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
OADRRCDX DS    0H                                                               
*                                                                               
*        READ RECORD USING DISK ADDRESS                                         
*                                                                               
         MVC   AIO,AIO3            USE I/O AREA 3 FOR REPREC & PUBREC           
*                                                                               
         CLI   16(R2),C'C'         IF CONTRACT ELEMENT                          
         BNE   *+10                                                             
         MVC   AIO,AIO2               USE I/O AREA 2 FOR PCONREC                
*                                                                               
         MVC   OADRFILE,FILENAME   SAVE CURRENT FILE NAME                       
*                                                                               
         MVC   FILENAME,=CL8'PUBFIL'  USE PUBFILE                               
*                                                                               
         CLI   16(R2),C'C'         IF REP                                       
         BE    *+8                                                              
         CLI   16(R2),C'R'         OR CONTRACT                                  
         BNE   *+10                                                             
         MVC   FILENAME,=CL8'PRTFILE'   USE PRINT FILE                          
*                                                                               
         MVC   KEY+27(4),10(R2)    SET DISK ADDRESS                             
*                                                                               
         CLI   17(R2),0            IF SE NUMBER PASSED                          
         BE    *+8                                                              
         ICM   RF,15,PBUTLA        AND UTL ADDRESS KNOWN                        
         BZ    *+16                                                             
         MVC   PAOSESAV,4(RF)      SAVE SE NUMBER                               
         MVC   4(1,RF),17(R2)      SET NEEDED SE NUMBER                         
*                                                                               
         MVI   ERROR,0             INIT EROR BYTE                               
         MVI   ERROPT,C'Y'         RETURN AFTER ERROR                           
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
         MVC   FILENAME,OADRFILE   RESTORE FILE NAME                            
         CLI   PAOSESAV,0          IF SE NUMBER SAVED                           
         BE    *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSESAV    RESTORE IT                                   
*                                                                               
         CLI   ERROR,0             EXIT ON ERRORS                               
         BNE   OADRREPX                                                         
*                                                                               
         L     R4,AIO              POINT TO RECORD                              
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,14(R2)         GET ELEMENT DISPLACEMENT       L14           
         LA    RF,0(RF,R4)         POINT TO ELEMENT               L14           
*                                                                               
         CLI   GLARGS+1,C'B'       SKIP IF NAME NOT INVOLVED                    
         BE    *+8                                                              
         CLI   GLARGS+1,C'C'       SKIP IF NAME NOT INVOLVED                    
         BE    *+8                                                              
         CLI   GLARGS+1,C'N'       SKIP IF NAME NOT INVOLVED                    
         BE    *+8                                                              
         CLI   GLARGS+1,C'A'       SKIP IF NAME NOT INVOLVED                    
         BE    *+8                                                              
         B     OADRNAMN                                                         
*                                                                               
         CLI   16(R2),C'R'         IF REP RECORD IN CORE                        
         BNE   *+20                                                             
         MVC   NAMEAREA(30),PREPNAME-PREPRECD(R4) PUT OUT REP NAME              
         MVC   CODEAREA(4),PREPKREP-PREPKEY(R4)   & REP NUMBER                  
         B     OADRNAMX                                                         
*                                                                               
         CLI   16(R2),C'C'         CONTRACT RECORD HAS NO NAME                  
         BE    OADRNAMX                                                         
*                                                                               
         CLI   16(R2),C'P'         UP THE CREEK IF NOT A PUB RECORD             
         BNE   OADRNAMX                                                         
*                                                                               
         CLI   0(RF),PUBPAOVQ      IF ADDRESS OVERRIDE ELEMENT                  
         BL    *+22                                                             
         CLI   0(RF),PUBSAOVQ                                                   
         BH    *+14                                                             
         MVC   NAMEAREA(30),PUBAONAM-PUBAOVEL(RF) PUT OUT NAME                  
         B     OADRNAMX                                                         
*                                                                               
         CLI   0(RF),PUBNAMQ        IF PUB NAME & ADDRESS ELEMENT               
         BNE   *+14                                                             
         MVC   NAMEAREA(20),PUBNAME-PUBNAMD(RF) PUT OUT PUB NAME                
         B     OADRNAMX                                                         
*                                                                               
OADRNAMX DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'N'       SKIP IF NAME ONLY WANTED                     
         BNE   *+10                                               L14           
         MVC   CODEAREA,SPACES     CLEAR CODE                                   
*                                                                               
*                                                                               
         CLI   MYLTYP,C'H'         FINISHED IF HEADLINE FIELD                   
         BE    OADRREPY            EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
         CLI   GLARGS+1,C'N'       FINISHED IF NAME OR NAME & CODE              
         BE    *+8                 WANTED                                       
         CLI   GLARGS+1,C'B'                                                    
         BNE   *+8                                                              
         B     OADRREPY            EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
OADRNAMN DS    0H                                                               
*                                                                               
*        ADDRESS                                                                
*                                                                               
OADRADR  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'A'       FINISHED UNLESS ADDRESS WANTED L14           
         BNE   OADRADRN                                           L14           
*                                                                               
         CLI   16(R2),C'C'         CONTRACT RECORD HAS NO ADDRESS IN IT         
         BE    OADRADRN                                                         
*                                                                               
         MVC   BLOCK(L'SPACES),SPACES  INIT WORKAREA              L14           
*                                                                               
         MVC   BLOCK+14(6),CODEAREA  ADD IN REP CODE                            
*                                                                               
         MVC   BLOCK+22(30),NAMEAREA    NAME                      L14           
*                                                                               
         CLI   16(R2),C'R'         IF REP RECORD IN CORE                        
         BNE   *+20                                                             
         MVC   BLOCK+54(30),PREPLIN1-PREPRECD(R4) ADDRESS                       
         MVC   BLOCK+86(30),PREPLIN2-PREPRECD(R4)                               
         B     OADRADD1                                                         
*                                                                               
         CLI   16(R2),C'P'         UP THE CREEK IF NOT A PUB RECORD             
         BNE   OADRADDX                                                         
*                                                                               
         CLI   0(RF),PUBPAOVQ      IF ADDRESS OVERRIDE LEMENT                   
         BL    *+28                                                             
         CLI   0(RF),PUBSAOVQ                                                   
         BH    *+20                                                             
         MVC   BLOCK+54(30),PUBAOLN1-PUBAOVEL(RF) ADDRESS                       
         MVC   BLOCK+86(30),PUBAOLN2-PUBAOVEL(RF)                               
         B     OADRADD1                                                         
*                                                                               
         CLI   0(RF),PUBNAMQ       IF PUB NAME AND ADDRESS ELM                  
         BNE   *+16                                                             
         MVC   BLOCK+54(30),PUBLINE1-PUBNAMD(RF) ADDRESS                        
         MVC   BLOCK+86(30),PUBLINE2-PUBNAMD(RF)                                
*                                                                               
OADRADD1 DS    0H                                                               
*                                                                               
         OC    BLOCK(132),SPACES   FORCE UPPERCASE                              
*                                                                               
         CLI   MYLTYP,C'M'         IF MIDLINE                                   
         BNE   OADRDTL                                                          
*                                                                               
         MVC   BLOCK(12),LABLAREA  COPY LABEL                     L14           
         MVI   BLOCK+12,C'='       SET PUNCTUATION                L14           
         MVI   BLOCK+20,C'='                                      L14           
*                                                                               
         CLC   BLOCK+54(30),SPACES   SKIP IF NO DATA                            
         BNH   *+8                                                              
         MVI   BLOCK+52,C','                                      L14           
*                                                                               
         CLC   BLOCK+86(30),SPACES   SKIP IF NO DATA                            
         BNH   *+8                                                              
         MVI   BLOCK+84,C','                                                    
*                                                                               
         GOTO1 SQUASHER,DMCB,BLOCK,132 STRIP OUT SPACES                         
*                                                                               
         XC    0(142,R3),0(R3)     CLEAR OUTPUT MID-LINE                        
*                                                                               
         ZIC   RF,DMCB+7           PRINT DATA                                   
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),BLOCK                                                    
*                                                                               
OADRMIDX DS    0H                                                               
*                                                                               
         B     OADRADDX            ALL DONE                                     
*                                                                               
*           PROCESS FOR DETAIL                                                  
*                                                                               
OADRDTL  DS    0H                                                               
*                                                                               
         GOTO1 SQUASHER,DMCB,BLOCK,52  STRIP BLANKS FROM CODE AND NAME          
*                                                                               
         ZIC   RE,DMCB+7           MAX 30 BYTES TO OUTPUT                       
         CH    RE,=H'30'                                                        
         BNH   *+8                                                              
         LA    RE,30                                                            
*                                                                               
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),BLOCK                                                    
*                                                                               
         LR    RE,R3               COPY START OF OUTPUT           L14           
*                                                                               
*                                                                               
         CLC   BLOCK+54(30),SPACES   SKIP IF NO DATA                            
         BNH   *+14                  BELOW NAME                   L14           
         MVC   198(30,RE),BLOCK+54                                              
         LA    RE,198(RE)                                                       
*                                                                               
         CLC   BLOCK+86(30),SPACES   SKIP IF NO DATA                            
         BNH   *+10                                                             
         MVC   198(30,RE),BLOCK+86                                              
*                                                                               
OADRDTLX DS    0H                                                               
*                                                                               
OADRADDX DS    0H                                                               
*                                                                               
         B     OADRREPX            ALL DONE                       L14           
*                                                                               
OADRADRN DS    0H                                                               
*                                                                               
*        FAX NUMBER                                                             
*                                                                               
OADRFAX  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'F'       PROCESS FAX                                  
         BNE   OADRFAXN                                                         
*                                                                               
         CLI   16(R2),C'R'         IF REP RECORD IN CORE                        
         BNE   *+22                                                             
         CLI   PREPELEM+1-PREPRECD(R4),PREPFAX-PREPELEM AND FAX IN ELM          
         BL    *+14                                                             
         MVC   0(L'PREPFAX,R3),PREPFAX-PREPRECD(R4)  PRINT FAX #                
         B     OADRFAXX                                                         
*                                                                               
         CLI   16(R2),C'P'         UP THE CREEK IF NOT A PUB RECORD             
         BNE   OADRFAXX                                                         
*                                                                               
         CLI   0(RF),PUBPAOVQ      IF ADDRESS OVERRIDE ELEMENT                  
         BL    *+30                                                             
         CLI   0(RF),PUBSAOVQ                                                   
         BH    *+22                                                             
         CLI   PUBAOVEL+1-PUBAOVEL(RF),PUBAOFAX-PUBAOVEL  AND FAX IN            
         BL    *+14                                                             
         MVC   0(L'PUBAOFAX,R3),PUBAOFAX-PUBAOVEL(RF)  PRINT FAX #              
         B     OADRFAXX                                                         
*                                                                               
         CLI   0(RF),PUBSADQ       IF PUB SUPPLEMENTAL ELEMENT                  
         BNE   *+22                                                             
         CLI   PUBSADEL+1-PUBSADD(RF),PUBSFAXN-PUBSADD AND FAX IN ELM           
         BL    *+14                                                             
         MVC   0(L'PUBSFAXN,R3),PUBSFAXN-PUBSADD(RF)  PRINT FAX #               
         B     OADRFAXX                                                         
*                                                                               
OADRFAXX DS    0H                                                               
*                                                                               
         MVC   NAMEAREA,0(R3)      COPY OUTPUT                                  
         B     OADRREPY            EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
         B     OADRREPX                                                         
*                                                                               
OADRFAXN DS    0H                                                               
*                                                                               
*        TELEPHONE NUMBER                                                       
*                                                                               
OADRTEL  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'T'       PROCESS TEL                                  
         BNE   OADRTELN                                                         
*                                                                               
         CLI   16(R2),C'R'         IF REP RECORD IN CORE                        
         BNE   *+14                                                             
         MVC   0(L'PREPTEL,R3),PREPTEL-PREPRECD(R4)  PRINT TEL #                
         B     OADRTELX                                                         
*                                                                               
         CLI   16(R2),C'P'         UP THE CREEK IF NOT A PUB RECORD             
         BNE   OADRTELX                                                         
*                                                                               
         CLI   0(RF),PUBPAOVQ      IF ADDRESS OVERRIDE ELEMENT                  
         BL    *+22                                                             
         CLI   0(RF),PUBSAOVQ                                                   
         BH    *+14                                                             
         MVC   0(L'PUBAOTEL,R3),PUBAOTEL-PUBAOVEL(RF)  PRINT TEL #              
         B     OADRTELX                                                         
*                                                                               
         CLI   0(RF),PUBSADQ       IF PUB SUPPLEMENTAL ELEMENT                  
         BNE   *+14                                                             
         MVC   0(L'PUBTEL,R3),PUBTEL-PUBSADD(RF)  PRINT TEL #                   
         B     OADRTELX                                                         
*                                                                               
OADRTELX DS    0H                                                               
*                                                                               
         MVC   NAMEAREA,0(R3)      COPY OUTPUT                                  
         B     OADRREPY            EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
         B     OADRREPX                                                         
*                                                                               
OADRTELN DS    0H                                                               
*                                                                               
*        ATTENTION NAME                                                         
*                                                                               
OADRATN  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'W'       PROCESS ATTENTION NAME (WHO)                 
         BNE   OADRATNN                                                         
*                                                                               
         MVC   OADRWORK,SPACES     INIT WORKAREA                                
         LA    R1,OADRWORK                                                      
*                                                                               
         CLI   16(R2),C'R'         IF REP RECORD IN CORE                        
         BNE   *+14                                                             
         MVC   0(L'PREPATTN,R1),PREPATTN-PREPRECD(R4)  PRINT ATTENTION          
         B     OADRATN1                                                         
*                                                                               
         CLI   16(R2),C'C'         CONTRACT RECORD                              
         BNE   *+14                                                             
         MVC   0(L'PCATNAM,R1),PCATNAM-PCATELD(RF)  PRINT ATTENTION             
         B     OADRATN1                                                         
*                                                                               
         CLI   16(R2),C'P'         UP THE CREEK IF NOT A PUB RECORD             
         BNE   OADRATNX                                                         
*                                                                               
         CLI   0(RF),PUBPAOVQ      IF ADDRESS OVERRIDE ELEMENT                  
         BL    *+22                                                             
         CLI   0(RF),PUBSAOVQ                                                   
         BH    *+14                                                             
         MVC   0(L'PUBAOATN,R1),PUBAOATN-PUBAOVEL(RF)  PRINT ATN NAME           
         B     OADRATN1                                                         
*                                                                               
         CLI   0(RF),PUBSADQ       IF PUB SUPPLEMENTAL ELEMENT                  
         BNE   *+14                                                             
         MVC   0(L'PUBATTN,R1),PUBATTN-PUBSADD(RF)  PRINT ATTN NAME             
         B     OADRATN1                                                         
*                                                                               
OADRATN1 DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,MYOLEN         GET OUTPUT LENGTH                            
         BZ    OADRATN2              NO LENGTH                                  
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),OADRWORK    MOVE OUT ATTENTION NAME                      
*                                                                               
OADRATN2 DS    0H                                                               
*                                                                               
OADRATNX DS    0H                                                               
*                                                                               
         MVC   NAMEAREA,OADRWORK   COPY OUTPUT                                  
         B     OADRREPY            EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
         B     OADRREPX                                                         
*                                                                               
OADRATNN DS    0H                                                               
*                                                                               
OADRREPY DS    0H                                                               
         LTR   RB,RB               ^= CC MEANS  GENERAL OUTPUT ROUTINE          
         XIT1                                                                   
*                                                                               
OADRREPX DS    0H                                                               
         CR    RB,RB               NORMAL EXIT                                  
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OADRFILE DC    CL8' '              FILE NAME SAVEAREA                           
OADRWORK DS    CL132               WORKAREA                                     
*                                                                               
         TITLE 'PRWRITER - AGENCY - INPUT - IAGY'                               
***********************************************************************         
*                                                                     *         
*        ROUTINE TO BUILD AGENCY ENTRIES                              *         
*                                                                     *         
*EXIT    R2==>     +0-9   AGENCY NAME TRUNCATED                       *         
*                  +10    MEDIA                                       *         
*                  +11-12 AGENCY                                      *         
*                  +13    SE NUMBER                                   *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IAGY     NMOD1 0,**+IAGY                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         ICM   RF,15,PBAGYADR      POINT TO AGENCY RECORD                       
         MVC   0(10,R2),PAGYNAME-PAGYREC(RF)  PART OF NAME FOR SORTING          
         MVC   10(1,R2),PBMED      MEDIA                                        
         MVC   11(2,R2),PBAGY      AGENCY CODE                                  
*                                                                               
         ICM   RF,15,PBUTLA        IF UTL ADDRESS SET                           
         BZ    *+10                                                             
         MVC   13(1,R2),4(RF)         PASS SE NUMBER                            
*                                                                               
IAGYX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - AGENCY - OUTPUT - OAGY'                              
***********************************************************************         
*                                                                     *         
*        ROUTINE TO BUILD AGENCY ENTRIES                              *         
*                                                                     *         
*NTRY    R2==>     +0-9   AGENCY NAME TRUNCATED                       *         
*                  +10    MEDIA                                       *         
*                  +11-12 AGENCY                                      *         
*                  +13    SE NUMBER                                   *         
*                                                                     *         
*        GLARGS    C'A'   AGENCY ADDRESS                              *         
*                  C'B'   AGENCY CODE AND NAME                        *         
*                  C'C'   AGENCY CODE                                 *         
*                  C'N'   AGENCY NAME                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OAGY     NMOD1 0,**+OAGY                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
         MVC   LABLAREA(6),=C'AGENCY'                                           
*                                                                               
         CLI   GLARGS,C'N'         IF  NOT NAME ONLY                            
         BE    *+8                                                              
         CLI   GLARGS,C'A'         AND NOT ADDRESS                              
         BE    *+10                                                             
         MVC   CODEAREA(2),11(R2)      SET AGENCY CODE                          
*                                                                               
         CLI   GLARGS,C'C'         DONE IF CODE ONLY WANTED                     
         BE    OAGYX                                                            
*                                                                               
         CLC   OAGYDATA,10(R2)     SKIP IF SAME AGENCY AS BEFORE                
         BE    OAGY30                                                           
*                                                                               
         ICM   R4,15,PBAGYADR      POINT TO AGENCY RECORD                       
         BZ    OAGY10              NONE AVAILABLE                               
*                                                                               
         USING PAGYREC,R4                                                       
*                                                                               
         CLC   PAGYKAGY,11(R2)     IF AGY RECORD IN CORE                        
         BE    OAGY20                USE IT                                     
*                                                                               
OAGY10   DS    0H                                                               
*                                                                               
         CLI   13(R2),0            IF SE NUMBER PASSED                          
         BE    *+8                                                              
         ICM   RF,15,PBUTLA        AND UTL ADDRESS KNOWN                        
         BZ    *+16                                                             
         MVC   PAOSESAV,4(RF)      SAVE SE NUMBER                               
         MVC   4(1,RF),13(R2)      SET NEEDED SE NUMBER                         
*                                                                               
*        READ AGENCY HEADER                                                     
*                                                                               
*========              ========*                                                
         XC    KEY,KEY                                                          
         LA    R4,KEY                                                           
*========              ========*                                                
         MVC   PAGYKAGY,11(R2)     SET AGENCY                                   
         MVC   PAGYKMED,10(R2)     SET MEDIA                                    
         MVI   PAGYKRCD,PAGYKIDQ   SET FOR AGENCY RECORD                        
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(PESTKEST+2-PESTKEY),KEYSAVE                                  
         BE    *+6                                                              
         DC    H'0'                MUST FIND RECORD                             
*                                                                               
         L     R4,AIO1             READ RECORD INTO I/O1                        
         ST    R4,AIO                                                           
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         CLI   PAOSESAV,0          IF SE NUMBER WAS SAVED                       
         BE    *+18                                                             
         L     RF,PBUTLA           RESTORE IT                                   
         MVC   4(1,RF),PAOSESAV                                                 
         MVI   PAOSESAV,0          REST SAVEAREA                                
*                                                                               
OAGY20   DS    0H                                                               
*                                                                               
         MVC   OAGYDATA,0(R2)      SAVE AGENCY DATA                             
*                                                                               
         MVC   OAGYNAME,PAGYNAME   SAVE NAME                                    
         MVC   OAGYADDR,PAGYADDR   SAVE ADDRESS                                 
*                                                                               
OAGY30   DS    0H                                                               
*                                                                               
         MVC   NAMEAREA(L'OAGYNAME),OAGYNAME  PRINT AGENCY NAME                 
*                                                                               
         CLI   GLARGS,C'A'          SKIP IF NOT ADDRESS ENTRY                   
         BNE   *+10                                                             
         MVC   NAMEAREA(L'OAGYADDR),OAGYADDR  PRINT ADDRESS                     
*                                                                               
OAGYX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*        ========  *                                                            
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OAGYDATA DS    XL4                 AGENCY DATA                                  
OAGYNAME DS    XL(L'PAGYNAME)      NAME SAVEAREA                                
OAGYADDR DS    XL(L'PAGYADDR)      AGENCY ADDRESS SAVEAREA                      
*        ========  *                                                            
         DROP  R4                                                               
*        ========  *                                                            
         TITLE 'PRWRITER - BILL FIELDS - INPUT - IBILLU'                        
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FIND BILL RECORD FIELDS                           *         
*                                                                     *         
*NTRY    GLARGS    = C'L' INDICATING BILL RECORD FIELD                *         
*        GLARGS+1  = CODE FOR INDIVIDUALS FIELDS                      *         
*        GLARGS+2  = C'$' INDICATES MONEY FIELD - RETURNED AS PL5     *         
*                  = C'#' INDICATES PURCHASE ORDER FIELD              *         
*        GLARGS+3  =   C'#' - PURCHASE ORDER NUMBER                   *         
*                  =   C'P' - PURCHASE ORDER PERIOD                   *         
*                  =   C'$' - PURCHASE ORDER AMOUNT - PL8             *         
*                  =   C'S' - PURCHASE ORDER STATUS                   *         
*        GLARGS+5  = AOR INDICATORS - X'80'  AOR ONLY                 *         
*                                     X'40'  NO AOR BILLS             *         
*                                                                     *         
*        R2==>  INPUT TO DRIVER SORT                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IBILLU   NMOD1 0,**#IBL                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        FOLLOWING NEEDED TO ALLOW FOR CHANGES TO SIZE OF                       
*           INPUT PACKED FIELD                                                  
*                                                                               
         L     RF,GLADTENT         POINT TO DRIVETABLE ENTRY                    
         ZIC   R6,DRINFLEN-DRIND(RF)  GET SORT FIELD LENGTH                     
         BCTR  R6,0                DECREMENT FOR EXECUTE INSTRUCTIONS           
         SLL   R6,4                MOVE TO LEFT NIBBLE                          
*                                                                               
         L     R5,AIO              ADDRESS OF I/O                               
         USING PBILLRCD,R5                                                      
*                                                                               
         CLI   PBILKRCD,PBILKIDQ   EXIT IF NOT BILL RECORD                      
         BNE   IBILLUX                                                          
*                                                                               
         CLI   GLARGS+2,C'$'       IF MONEY FIELD                               
         BNE   *+18                                                             
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),=P'0'          INITIALIZE TO PACKED FORMAT               
*                                                                               
         TM    GLARGS+5,X'80'      IF ONLY AOR BILLS REPORTED                   
         BNO   *+12                                                             
         TM    PBILCMSW,X'20'         SKIP IF NON-AOR BILL                      
         BNO   IBILLUX                                                          
*                                                                               
         TM    GLARGS+5,X'40'      IF NO   AOR BILLS REPORTED                   
         BNO   *+12                                                             
         TM    PBILCMSW,X'20'         SKIP IF AOR BILL                          
         BO    IBILLUX                                                          
*                                                                               
*        CHECK FOR OTHER BILL FILTERING                                         
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),0,0                                 
*                                                                               
         OC    8(4,R1),8(R1)                                                    
         BZ    IBLUFLTX            NO FILTER FOUND                              
*                                                                               
         ICM   RF,15,DMCB+8        POINT TO FOUND FILTER                        
         BZ    IBLUFLTX            NO FILTER USE DEFAULT                        
*                                                                               
         USING FLTCTL,RF           ESTABLISH FILTER                             
*                                                                               
         CLC   =AL2(PRQCFUFC),FLTFVAL   IF CONCERNING UFC BILLS                 
         BNE   IBLUFUFN                                                         
*                                                                               
         TM    FLTCTL,FLTEQQ       IF REPORTING ONLY UFC BILLS                  
         BNO   *+16                                                             
         TM    PBILCMSW,X'01'         DROP IF NON-UFC BILL                      
         BNO   IBILLUX                                                          
         B     IBLUFLTX                    ELSE ACCEPT                          
*                                                                               
         TM    FLTCTL,FLTNOTQ      IF EXCLUDING UFC BILLS                       
         BNO   *+16                                                             
         TM    PBILCMSW,X'01'         DROP IF UFC BILL                          
         BO    IBILLUX                                                          
         B     IBLUFLTX                    ELSE ACCEPT                          
*                                                                               
         B     IBLUFLTX            ELSE SKIP FILTERING                          
*                                                                               
IBLUFUFN DS    0H                                                               
*                                                                               
         CLC   =AL2(PRQCFNET),FLTFVAL   IF CONCERNING NET BILLS                 
         BNE   IBLUFNTN                                                         
*                                                                               
         TM    FLTCTL,FLTEQQ       IF REPORTING ONLY NET BILLS                  
         BNO   *+16                                                             
         TM    PBILCMSW,X'08'         DROP IF NON-NET BILL                      
         BNO   IBILLUX                                                          
         B     IBLUFLTX                    ELSE ACCEPT                          
*                                                                               
         TM    FLTCTL,FLTNOTQ      IF EXCLUDING NET BILLS                       
         BNO   *+16                                                             
         TM    PBILCMSW,X'08'         DROP IF NET BILL                          
         BO    IBILLUX                                                          
         B     IBLUFLTX                    ELSE ACCEPT                          
*                                                                               
         B     IBLUFLTX            ELSE SKIP FILTERING                          
*                                                                               
IBLUFNTN DS    0H                                                               
*                                                                               
         CLC   =AL2(PRQCFCOM),FLTFVAL   IF CONCERNING COMMISSION BILLS          
         BNE   IBLUFCMN                                                         
*                                                                               
         TM    FLTCTL,FLTEQQ       IF REPORTING ONLY COMMISSION BILLS           
         BNO   *+16                                                             
         TM    PBILCMSW,X'02'         DROP IF NON-COMMISSION BILL               
         BNO   IBILLUX                                                          
         B     IBLUFLTX                    ELSE ACCEPT                          
*                                                                               
         TM    FLTCTL,FLTNOTQ      IF EXCLUDING COMMISSION BILLS                
         BNO   *+16                                                             
         TM    PBILCMSW,X'02'         DROP IF COMMISSION BILL                   
         BO    IBILLUX                                                          
         B     IBLUFLTX                    ELSE ACCEPT                          
*                                                                               
         B     IBLUFLTX            ELSE SKIP FILTERING                          
*                                                                               
IBLUFCMN DS    0H                                                               
*                                                                               
IBLUFLTX DS    0H                                                               
*                                                                               
         DROP  RF                                                               
*                                                                               
*        MONEY FIELDS NEED TO CALL PPVAL TO GET CORRECT VALUES                  
*                                                                               
IBLUDLR  DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'$'       IF MONEY FIELD                               
         BNE   IBLUDLRX                                                         
*                                                                               
         CLC   IBLUKEY,PBILLKEY    SKIP IF PPBVAL ALREADY CALLED                
         BE    IBLUDLRX                FOR THIS BILL RECORD                     
*                                                                               
         MVC   IBLUKEY,PBILLKEY    SAVE BILL HEADER KEY                         
*                                                                               
*        GOTO PPBVAL TO GET EFFECTIVE RATES                                     
*                                                                               
         GOTO1 =V(PPBVAL),DMCB,(C'B',PBILLRCD),IBLUVAL                          
*                                                                               
IBLUDLRX DS    0H                                                               
*                                                                               
         LA    R7,IBLUVAL          ESTABLISH PPBVAL OUTPUT                      
         USING PPBVALD,R7                                                       
*                                                                               
*        DETERMINE WHICH FIELD TO PROCESS                                       
*                                                                               
         ZIC   R1,GLARGS+1                                                      
         B     *+4(R1)    GLARGS+1                                              
         B     IBLUINV      00     INVOICE NUMBER                               
         B     IBLUGRS      04     GROSS                                        
         B     IBLUNET      08     NET                                          
         B     IBLUGLC      0C     GROSS LESS CASH DISCOUNT                     
         B     IBLUNLC      10     NET   LESS CASH DISCOUNT                     
         B     IBLUACT      14     ACTUAL                                       
         B     IBLUCD       18     CASH DISCOUNT                                
         B     IBLUAC       1C     AGENCY COMMISSION                            
         B     IBLUTAX      20     TAX                                          
         B     IBLUCTP      24     COMMISSION ONLY BILL TYPE                    
         B     IBLUGST      28     GST FIELDS                                   
         B     IBLURTL      2C     RETAIL ACCOUNT FIELDS                        
         B     IBLUBTP      30     BILL TYPE                                    
         B     IBLUPST      34     PST FIELDS                                   
         B     IBLUHST      38     HST AMOUNT                                   
         B     IBLUCS2      3C     COST2 AMOUNTS                                
         B     IBLUPO       40     PURCHASE ORDER FIELDS                        
*                                                                               
*        INVOICE NUMBER - BILLING MONTH AND BILL NUMBER                         
*                                                                               
IBLUINV DS     0H                                                               
*                                                                               
         MVC   0(2,R2),PBILKBMN    BILL MONTH                                   
         MVC   3(2,R2),PBILKBNO    BILL NUMBER                                  
         MVC   5(1,R2),PBILKMED    MEDIA                                        
         MVC   6(3,R2),PBILKCLT    CLIENT                                       
*                                                                               
         CLI   GLARGS+3,C'1'       DONE IF NOT FULL # WANTED                    
         BNL   *+14                BHINVM / BHINVMND KEYWORDS                   
         MVC   9(1,R2),PBCOFF      BHINV KEYWORD NEEDS CLIENT OFFICE            
         B     IBILLUX             DONE                                         
*                                                                               
         MVC   WORK(16),0(R2)      SAVE                                         
*                                  PRINT BILL NUMBER AS ON THE BILL             
*                                                                               
         GOTO1 =A(BLDINV),DMCB,(C'B',WORK),0(R2),PBMED,AIO                      
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        GROSS                                                                  
*                                                                               
IBLUGRS  DS    0H                                                               
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),PPBVEBG     GROSS                                        
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        NET                                                                    
*                                                                               
IBLUNET  DS    0H                                                               
*                                                                               
         TM    PBILCMSW,X'20'      NOT VALID FOR AOR BILLS                      
         BO    IBLUNETX                                                         
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),PPBVEBG     GROSS                                        
         EX    R6,*+8                                                           
         B     *+10                                                             
         SP    0(0,R2),PPBVEBB     GROSS-(GROSS-CD)=CD                          
         EX    R6,*+8                                                           
         B     *+10                                                             
         AP    0(0,R2),PPBVEBN     CD+(NET-CD)=NET                              
*                                                                               
IBLUNETX DS    0H                                                               
         B     IBILLUX                                                          
*                                                                               
*        GROSS LESS CASH DISCOUNT                                               
*                                                                               
IBLUGLC  DS    0H                                                               
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),PPBVEBB    GROSS LESS CD                                 
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        NET LESS CD                                                            
*                                                                               
IBLUNLC  DS    0H                                                               
*                                                                               
         TM    PBILCMSW,X'20'      NOT VALID FOR AOR BILLS                      
         BO    IBLUNLCX                                                         
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),PPBVEBN    NET   LESS CD                                 
*                                                                               
IBLUNLCX DS    0H                                                               
         B     IBILLUX                                                          
*                                                                               
*        ACTUAL BILL AMOUNT                                                     
*                                                                               
IBLUACT  DS    0H                                                               
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),PPBVBACT  RECEIVABLE AMOUNT                              
*                                                                               
         ICM   RF,15,PPBVGST       CVD                                          
*                                                                               
         CVD   RF,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         AP    0(0,R2),DUB       PLUS GST                                       
*                                                                               
         ICM   RF,15,PPBVPST       CVD                                          
*                                                                               
         CVD   RF,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         AP    0(0,R2),DUB       PLUS PST                                       
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        CASH DISCOUNT                                                          
*                                                                               
IBLUCD   DS    0H                                                               
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),PPBVEBC INIT CD ACCUMULATOR                              
*                                                                               
IBLUCDX  DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        AGENCY COMMISSION = GROSS LESS CD - NET LESS CD                        
*                                                                               
IBLUAC   DS    0H                                                               
*                                                                               
         TM    PBILCMSW,X'20'      SEE IF AOR BILL                              
         BNO   IBLUAC3                                                          
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),PPBVBACT   SET AC TO RCVBL                               
*                                                                               
         B     IBLUACX                                                          
*                                                                               
IBLUAC3  DS    0H                                                               
*                                                                               
*        AC = RCV - CD - (NET-CD) IN MOST CASES                                 
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),PPBVBACT    SET AC TO RCVBL                              
*                                                                               
         TM    PBILCMSW,X'02'         IF NOT COMMISSION ONLY BILL               
         BO    *+8                                                              
         TM    PBILBASA,X'04'         WITH CD ALREADY TAKEN OUT                 
         BO    *+18                                                             
         EX    R6,*+8                                                           
         B     *+10                                                             
         SP    0(0,R2),PPBVEBC      REMOVE CD                                   
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         SP    0(0,R2),PPBVEBN           -NET = TRUE AC                         
*                                                                               
IBLUACX  DS    0H                                                               
         B     IBILLUX                                                          
*                                                                               
*        TAX                                                                    
*                                                                               
IBLUTAX  DS    0H                                                               
*                                                                               
         TM    PBILCMSW,X'20'     SKIP TAX IF AOR BILL                          
         BO    IBLUTAXX                                                         
*                                                                               
         ICM   RF,15,PPBVETAX     CVD                                           
         CVD   RF,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),DUB        TAX TO DRIVER                                 
*                                                                               
IBLUTAXX DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        COMMISSION ONLY BILL TYPE                                              
*                                                                               
IBLUCTP DS     0H                                                               
*                                                                               
         TM    PBILCMSW,X'02'      COMMISSION ONLY BILL?                        
         BNO   *+12                                                             
         MVI   2(R2),C'O'          SET INDICATOR                                
         B     IBLUCTPX                                                         
*                                                                               
         TM    PBILCMSW,X'80'      COMMISSION ADJUSTMENT BILL?                  
         BNO   *+8                                                              
         MVI   2(R2),C'A'          SET INDICATOR                                
*                                                                               
IBLUCTPX DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        GST FIELDS                                                             
*              C'$' -  GST BILLED                                               
*              C'C' -  GST CODE                                                 
*              C'B' -  GST BASIS AMOUNT                                         
*                                                                               
IBLUGST  DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'$'       IF BILLED VAT                                
         BNE   IBLUG$N                                                          
*                                                                               
         ICM   RF,15,PPBVGST       CVD                                          
         CVD   RF,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),DUB PASS TO DRIVER                                       
*                                                                               
         B     IBLUGSTX                                                         
*                                                                               
IBLUG$N  DS    0H                                                               
*                                                                               
         LA    R1,PBILLEL          POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                  FIND VAT ELEM                                
IBLUGSTL DS    0H                                                               
*                                                                               
         CLI   0(R1),0             END OF RECORD                                
         BE    IBLUGSTD                                                         
*                                                                               
         CLI   0(R1),X'0A'         LOOKING FOR VAT ELEMENT                      
         BE    IBLUGSTF                                                         
*                                                                               
IBLUGSTC DS    0H                                                               
*                                                                               
         IC    RF,1(R1)            NEXT ELEMENT                                 
         LA    R1,0(RF,R1)                                                      
         B     IBLUGSTL                                                         
*                                                                               
IBLUGSTF DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'C'       IF VAT CODE                                  
         BNE   IBLUGCDN                                                         
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PBILLVCD-PBILVEL(R1)   PASS TO DRIVER                    
*                                                                               
         B     IBLUGSTX                                                         
*                                                                               
IBLUGCDN DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'B'       IF VAT BASIS                                 
         BNE   IBLUGBSN                                                         
*                                                                               
         ICM   RE,15,PBILLVBS-PBILVEL(R1)  GET VAT BASIS                        
         CVD   RE,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),DUB            PASS TO DRIVER                            
*                                                                               
         B     IBLUGSTX                                                         
*                                                                               
IBLUGBSN DS    0H                                                               
*                                                                               
IBLUGSTD DS    0H                                                               
*                                                                               
IBLUGSTX DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        RETAIL SCCOUNT ENTRIES                                                 
*              C'C' - ACCOUNT CODE                                              
*              C'$' - OUTLET AMOUNT                                             
*                                                                               
IBLURTL  DS    0H                                                               
*                                                                               
         TM    PBRETAIL,X'03'      SKIP IF NOT A RETAIL BILL                    
         BZ    IBLURTLX                                                         
*                                                                               
         CLI   GLARGS+3,C'$'       IF OUTLET AMOUNT WANTED                      
         BNE   IBLURT$N                                                         
*                                                                               
         ICM   RE,15,PBRACTUL          GET AMOUNT AND CONVERT TO PACKED         
         CVD   RE,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),DUB         PASS TO DRIVER                               
*                                                                               
         B     IBLURTLX                                                         
*                                                                               
IBLURT$N DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'C'       IF ACCOUNT CODE WANTED                       
         BNE   IBLURTCN                                                         
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PBRACCT     PASS TO DRIVER                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
IBLURTCN DS    0H                                                               
*                                                                               
IBLURTLX DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        BILL TYPE                                                              
*         EG.- B4-REG, B7-AOR, OR M4-M7                                         
*                                                                               
IBLUBTP  DS    0H                                                               
*                                                                               
         CLI   PBILLTYP,C'0'       SKIP IF NEW BILL FORMAT                      
         BNH   IBLUBTP5                                                         
*                                                                               
*        OLD SYTLE BILLING                                                      
*                                                                               
         CLI   PBILLTYP,C'3'       SKIP IF NOT ORIGINAL BILL                    
         BE    *+10                                                             
         MVC   0(3,R2),=C'ORI'                                                  
*                                                                               
         CLI   PBILLTYP,C'4'       SKIP IF NOT DETAIL   BILL                    
         BE    *+10                                                             
         MVC   0(3,R2),=C'DET'                                                  
*                                                                               
         CLI   PBILLTYP,C'1'       SKIP IF NOT MANUAL   BILL                    
         BE    *+10                                                             
         MVC   0(3,R2),=C'MAN'                                                  
*                                                                               
         LA    R3,3(R2)            BUMP TO NEXT AVAILABLE PRINT POS             
*                                                                               
         B     IBLUBTP7                                                         
*                                                                               
*        NEW STYPE BILLING FORMAT                                               
*                                                                               
IBLUBTP5 DS    0H                                                               
*                                                                               
         MVC   0(2,R2),PBILLTYP    BILL TYPE AND MODE                           
         LA    R3,2(R2)            START OF QUALIFIER                           
*                                                                               
IBLUBTP7 DS    0H                                                               
*                                                                               
         MVC   0(4,R3),=C'-REG'    DEFAULT TO REGULAR BILL                      
*                                                                               
         TM    PBILCMSW,X'02'      SKIP IF NOT COMMISSION ONLY BILL             
         BZ    *+14                                                             
         MVC   1(3,R3),=C'COM'                                                  
         B     IBLUBTPX                                                         
*                                                                               
         CLI   PBILSEP,C'A'        SKIP IF NOT AN ADJUSTMENT BILL               
         BNE   *+10                                                             
         MVC   1(3,R3),=C'ADJ'                                                  
*                                                                               
         CLI   PBILSEP,C'C'        SKIP IF NOT CASH DISCOUNT BILL               
         BNE   *+10                                                             
         MVC   1(3,R3),=C'CD '                                                  
*                                                                               
         TM    PBILCMSW,X'20'      SKIP IF NOT AN AOR BILL                      
         BNO   *+10                                                             
         MVC   1(3,R3),=C'AOR'                                                  
*                                                                               
         TM    PBILCMSW,X'01'      SKIP IF NOT A  UFC BILL                      
         BNO   *+10                                                             
         MVC   1(3,R3),=C'UFC'                                                  
*                                                                               
         TM    PBILCMSW,X'08'      SKIP IF NOT A  NET BILL                      
         BNO   *+10                                                             
         MVC   1(3,R3),=C'NET'                                                  
*                                                                               
IBLUBTPX DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        PST FIELDS                                                             
*              C'$' -  PST BILLED                                               
*              C'C' -  PST CODE                                                 
*              C'B' -  PST BASIS AMOUNT                                         
*                                                                               
IBLUPST  DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'$'       IF BILLED VAT                                
         BNE   IBLUP$N                                                          
*                                                                               
         ICM   RF,15,PPBVPST          CVD                                       
         CVD   RF,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),DUB            PASS TO DRIVER                            
*                                                                               
         B     IBLUPSTX                                                         
*                                                                               
IBLUP$N  DS    0H                                                               
*                                                                               
         LA    R1,PBILLEL          POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                  FIND VAT ELEM                                
IBLUPSTL DS    0H                                                               
*                                                                               
         CLI   0(R1),0             END OF RECORD                                
         BE    IBLUPSTD                                                         
*                                                                               
         CLI   0(R1),X'84'         LOOKING FOR VAT ELEMENT                      
         BE    IBLUPSTF                                                         
*                                                                               
IBLUPSTC DS    0H                                                               
*                                                                               
         IC    RF,1(R1)            NEXT ELEMENT                                 
         LA    R1,0(RF,R1)                                                      
         B     IBLUPSTL                                                         
*                                                                               
IBLUPSTF DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'C'       IF VAT CODE                                  
         BNE   IBLUPCDN                                                         
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PBLPVCOD-PBLPSTEL(R1)   PASS TO DRIVER                   
*                                                                               
         B     IBLUPSTX                                                         
*                                                                               
IBLUPCDN DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'B'       IF VAT BASIS                                 
         BNE   IBLUPBSN                                                         
*                                                                               
         ICM   RE,15,PBLPVBAS-PBLPSTEL(R1)  GET VAT BASIS                       
         CVD   RE,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),DUB            PASS TO DRIVER                            
*                                                                               
         B     IBLUPSTX                                                         
*                                                                               
IBLUPBSN DS    0H                                                               
*                                                                               
IBLUPSTD DS    0H                                                               
*                                                                               
IBLUPSTX DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        HST AMOUNT                                                             
*              C'$' -  HST BILLED                                               
*                                                                               
IBLUHST  DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'$'       IF BILLED HST                                
         BNE   IBLUH$N                                                          
*                                                                               
         ICM   RF,15,PPBVHST       CVD                                          
         CVD   RF,DUB                                                           
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         ZAP   0(0,R2),DUB PASS TO DRIVER                                       
*                                                                               
         B     IBLUHSTX                                                         
*                                                                               
IBLUH$N  DS    0H                                                               
*                                                                               
IBLUHSTX DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        GLARGS+3 - COST 2 FIELDS                                               
*              C'G' -  GROSS                                                    
*              C'N' -  NET                                                      
*                                                                               
IBLUCS2  DS    0H                                                               
*                                                                               
         ZAP   0(8,R2),=P'0'       INIT OUTPUT                                  
*                                                                               
         LA    R1,PBILLEL          POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                  FIND VAT ELEM                                
IBLUCS2L DS    0H                                                               
*                                                                               
         CLI   0(R1),0             END OF RECORD                                
         BE    IBLUCS2D                                                         
*                                                                               
         CLI   0(R1),X'09'         LOOKING FOR OTHERS ELEMENT                   
         BNE   IBLUCS2C                                                         
*                                                                               
         TM    PBILLIND-PBILOTH(R1),X'82' MUST BE COST 2 ELM                    
         BM    IBLUCS2F                                                         
*                                                                               
IBLUCS2C DS    0H                                                               
*                                                                               
         IC    RF,1(R1)            NEXT ELEMENT                                 
         LA    R1,0(RF,R1)                                                      
         B     IBLUCS2L                                                         
*                                                                               
IBLUCS2F DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'G'       IF GROSS                                     
         BNE   IBLUC2GN                                                         
*                                                                               
         TP    PBILLOPG-PBILOTH(L'PBILLOPG,R1) MAKE SURE ITS PACKED             
         BNZ   *+10                                                             
         ZAP   0(8,R2),PBILLOPG-PBILOTH(L'PBILLOPG,R1) PASS TO DRIVER           
*                                                                               
         B     IBLUCS2X                                                         
*                                                                               
IBLUC2GN DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'N'       IF NET                                       
         BNE   IBLUC2NN                                                         
*                                                                               
         TP    PBILLOPN-PBILOTH(L'PBILLOPN,R1) MAKE SURE ITS PACKED             
         BNZ   *+10                                                             
         ZAP   0(8,R2),PBILLOPN-PBILOTH(L'PBILLOPN,R1) PASS TO DRIVER           
*                                                                               
         B     IBLUCS2X                                                         
*                                                                               
IBLUC2NN DS    0H                                                               
*                                                                               
IBLUCS2D DS    0H                                                               
*                                                                               
IBLUCS2X DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
*        PURCHASE ORDER FIELDS                                                  
*                                                                               
*        GLARGS+3 - COST 2 FIELDS                                               
*              C'#' -  PURCHASE ORDER NUMBER                                    
*              C'P' -  PURCHASE ORDER PERIOD                                    
*              C'$' -  PURCHASE ORDER AMOUNT                                    
*              C'S' -  PURCHASE ORDER STATUS                                    
*                                                                               
IBLUPO   DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'$'       IF PURCHASE ORDER AMOUNT                     
         BNE   IBLUPO10                                                         
*                                                                               
         ZAP   0(8,R2),=P'0'          INIT OUTPUT                               
         ZAP   8(8,R2),=P'0'          INIT OUTPUT                               
*                                                                               
IBLUPO10 DS    0H                                                               
*                                                                               
         LR    R6,R5               LOOK IN BILL   RECORD                        
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
*                                                                               
IBLUPOBL DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    IBLUPOXX               NONE FOUND                                
*                                                                               
         CLI   0(R6),9             LOOK FOR EXTENSION ELM                       
         BE    IBLUPOBF                                                         
*                                                                               
IBLUPOBC DS    0H                                                               
*                                                                               
         LLC   RF,1(R6)            ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         B     IBLUPOBL                                                         
*                                                                               
IBLUPOBF DS    0H                                                               
*                                                                               
         USING PBILOTH,R6          ESTABLISH EXTENSION ELM                      
*                                                                               
         CLC   PBILLJOB(3),=X'FFD7D6' SKIP IF NO PO FOR BILL                    
         BNE   IBLUPOXX                                                         
*                                                                               
*        CALL PPGETPO# TO GET A(PO# ELEMENT)                                    
*                                                                               
         XC    IBLUPOEL,IBLUPOEL   INIT RETURN AREA                             
*                                                                               
         MVI   ELCODE,PCLTPOEQ     FIND PURCHAE ORDER ELEMENT                   
         MVI   BYTE,0              INIT SAVEAREA                                
         L     R6,PBCLTADR         LOOK IN CLIENT RECORD                        
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
*                                                                               
IBLUPOLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    IBLUPODN                                                         
*                                                                               
         CLI   0(R6),PCLTPOEQ      LOOK FOR PURCHASE ORDER ELM                  
         BE    IBLUPOFD                                                         
*                                                                               
IBLUPOCN DS    0H                                                               
*                                                                               
         LLC   RF,1(R6)            ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         B     IBLUPOLP                                                         
*                                                                               
IBLUPOFD DS    0H                                                               
*                                                                               
         USING PCLTPOEL,R6         ESTABLISH PURCHASE ORDER ELM                 
         MVC   BYTE,PCLTPOLV       SAVE PO# LEVEL                               
*                                                                               
IBLUPODN DS    0H                                                               
*                                                                               
         GOTOR =V(PPGETPO#),DMCB,(C'L',PBILLREC),(BYTE,IBLUPOEL),      X        
               PBCOMFAC,0                                                       
*                                                                               
         CLI   DMCB,X'FF'          SKIP IF ERRORS                               
         BE    IBLUPO#X                                                         
*                                                                               
         L     R6,DMCB+12          ESTABLISH PO# ELEMENT                        
         USING PO#DELMD,R6                                                      
*                                                                               
         CLI   PO#DELID,PO#DLIDQ   SKIP IF NOT A PO# ELEM                       
         BNE   IBLUPOX                                                          
*                                                                               
*        PURCHASE ORDER NUMBER                                                  
*                                                                               
         CLI   GLARGS+3,C'#'       IF PO# WANTED                                
         BNE   IBLUPO#N                                                         
*                                                                               
         LLC   RF,PO#DLEN          GET ELEMENT LENGTH                           
         SHI   RF,PO#DHDLQ         LESS HEADER LENGTH                           
         BZ    IBLUPO#X               NO PO#                                    
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PO#DPO#     RETURN PO#                                   
*                                                                               
IBLUPO#X DS    0H                                                               
         B     IBLUPOX                                                          
*                                                                               
IBLUPO#N DS    0H                                                               
*                                                                               
*        PURCHASE ORDER PERIOD                                                  
*                                                                               
         CLI   GLARGS+3,C'P'       IF PO# PERIOD WANTED                         
         BNE   IBLUPOPN                                                         
*                                                                               
         MVC   0(6,R2),PO#DSTRT       RETURN PERIOD                             
*                                                                               
IBLUPOPX DS    0H                                                               
         B     IBLUPOX                                                          
*                                                                               
IBLUPOPN DS    0H                                                               
*                                                                               
*        PURCHASE ORDER AMOUNT                                                  
*                                                                               
         CLI   GLARGS+3,C'$'       IF PO# AMOUNT WANTED                         
         BNE   IBLUPO$N                                                         
*                                                                               
         ZAP   0(8,R2),PO#D$          RETURN AMOUNT                             
*                                                                               
         CLI   PO#DGORN,C'N'       IF AMOUNT IS NET                             
         BNE   *+14                                                             
         ZAP   8(8,R2),=P'1'          RETURN 1                                  
         B     IBLUPO$X                                                         
*                                                                               
IBLUPO$X DS    0H                                                               
         B     IBLUPOX                                                          
*                                                                               
IBLUPO$N DS    0H                                                               
*                                                                               
*        PURCHASE ORDER STATUS                                                  
*                                                                               
         CLI   GLARGS+3,C'S'       IF PO# STATUS WANTED                         
         BNE   IBLUPOSN                                                         
*                                                                               
         MVC   0(8,R2),=CL8'ACTIVE'   ASSUME ACTIVE                             
*                                                                               
         TM    PO#DACTV,PO#DINAQ   IF INACTIVE                                  
         BNO   *+10                                                             
         MVC   0(8,R2),=CL8'INACTIVE'   SET STATUS                              
*                                                                               
IBLUPOSX DS    0H                                                               
         B     IBLUPOX                                                          
*                                                                               
IBLUPOSN DS    0H                                                               
*                                                                               
*        PURCHASE ORDER SEQUENCE NUMBER                                         
*                                                                               
         CLI   GLARGS+3,C'Q'       IF PO# SQN WANTED                            
         BNE   IBLUPOQN                                                         
*                                                                               
         MVC   0(L'PO#DID,R2),PO#DID  RETURN INTERNAL SQN                       
*                                                                               
IBLUPOQX DS    0H                                                               
         B     IBLUPOX                                                          
*                                                                               
IBLUPOQN DS    0H                                                               
*                                                                               
IBLUPOX  DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE      RESTORE POINTER                                
         OI    DMINBTS,8         PASS BACK DELETED RECORDS                      
         GOTO1 HIGH                                                             
*                                                                               
IBLUPOXX DS    0H                                                               
*                                                                               
         B     IBILLUX                                                          
*                                                                               
IBILLUX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IBLUKEY  DC    XL(L'PBILLKEY)'00'  BILL HEADER KEY SAVEAREA                     
*                                                                               
         DS    0D                                                               
IBLUVAL  DS    XL(PPBVALDL)        PPBVAL SAVEAREA                              
*                                                                               
IBLUPOEL DS    XL64                PPGETPO# RERURN AREA                         
*                                                                               
         DROP  R5,R7                                                            
*                                                                               
         TITLE 'BUY BILLING ELEMENTS - IBILLED'                                 
***********************************************************************         
*                                                                     *         
*        BUY BILLING ELEMENTS                                         *         
*                                                                     *         
*        GLARGS+1 - ELEMENT CODE FOR TYPE OF BILLING ELEMENTS         *         
*                   X'26'    BILLED                                   *         
*                   X'28'    OPEN                                     *         
*                   X'29'    REBATE                                   *         
*                                                                     *         
*EXIT    R2==>  SERIES OF 11 BYTE DETAILS - MAX 20                    *         
*               XL3 - BILLING DATE                                    *         
*               XL2 - INVOICE NUMBER                                  *         
*               XL1 - BILL STATUS                                     *         
*               XL4 - BILLING AMOUNT                                  *         
*               XL1 - X'FF' - MORE THAN MAX # OF DETAILS AVAILABLE    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IBILUED  NMOD1 0,**#IBLD                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         ZAP   IBILUCTR,=P'0'      INIT NUMBER OF ELEMENTS CTR                  
*                                                                               
         L     R4,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R4                                                      
*                                                                               
         MVC   220(1,R2),PBUYKMED  PASS MEDIA                                   
         MVC   221(3,R2),PBUYKCLT  PASS CLIENT                                  
*                                                                               
*        FIND NUMBER OF RELEVANT BILLING ELEMENTS                               
*                                                                               
         LA    R6,PBUYKEY+33       POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
IBILULP  DS    0H                  FIND BILLING ELEMENT                         
*                                                                               
         USING PBILELD,R6          ESTABLISH BILLING ELEMENT                    
*                                                                               
         CLI   PBILELEM,0          DONE IF END OF RECORD REACHED                
         BE    IBILUDN                                                          
*                                                                               
         CLC   PBILELEM,GLARGS+2   MATCH CODE IN GLARGS                         
         BNE   IBILUCN                                                          
*                                                                               
         GOTO1 =A(FLTBLD)          FILTER ON DATES                              
*                                                                               
         BNE   *+10                IF ELEMENT PASSES DATE FILTER                
         AP    IBILUCTR,=P'1'         BUMP ELEMENT COUNTER                      
*                                                                               
IBILUCN  DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PBILELEM+1       GET ELEMENT LENGTH                           
         LA    R6,PBILELEM(RF)     BUMP TO NEXT ELEMENT                         
*                                                                               
         B     IBILULP                                                          
*                                                                               
IBILUDN  DS    0H                                                               
*                                                                               
*        FIND FIRST BILLING ELEMENT TO PRINT                                    
*                                                                               
*        IF MORE THAN MAXIMUM ALLOWED (20)                                      
*           NEED TO SKIP FIRST ONES BECAUSE                                     
*             THEY ARE STORED IN DATE ORDER                                     
*                                                                               
         LA    R6,PBUYKEY+33       POSITION TO FIRST BILLING ELEMENT            
         SR    R0,R0                                                            
*                                                                               
IBILU1LP DS    0H                  FIND BILLING ELEMENT                         
*                                                                               
         USING PBILELD,R6          ESTABLISH BILLING ELEMENT                    
*                                                                               
         CLI   PBILELEM,0          DONE IF END OF RECORD REACHED                
         BE    IBILU1DN                                                         
*                                                                               
         CLC   PBILELEM,GLARGS+2   MATCH CODE IN GLARGS                         
         BNE   IBILU1CN                                                         
*                                                                               
         GOTO1 =A(FLTBLD)          FILTER ON DATES                              
         BNE   IBILU1CN            ELEMENT FAILS DATE FILTER                    
*                                                                               
         SP    IBILUCTR,=P'1'      DECREMENT ELEMENT COUNTER                    
         BNZ   IBILU10             NOT AT END OF ELEMENTS                       
*                                                                               
         LTR   R0,R0               IF THERE WERE MORE THAN 20 ELEMENTS          
         BZ    IBILU10                                                          
*                                                                               
         MVI   10(R2),255             SET INDICATOR TO PRINT MORE MSG           
         B     IBILU1DN               DONE                                      
*                                                                               
IBILU10  DS    0H                                                               
*                                                                               
         CP    IBILUCTR,=PL2'20'   SKIP IF STILL OVER MAXIMUM                   
         BL    *+12                                                             
         LA    R0,1                SET TO PRINT MORE LINE                       
         B     IBILU1CN                                                         
*                                                                               
*        GOTO PPBVAL TO GET EFFECTIVE RATES                                     
*                                                                               
         GOTO1 =V(PPBVAL),DMCB,(C'E',PBILELEM),IBILUVAL                         
*                                                                               
         LA    R7,IBILUVAL         ESTABLISH PPBVAL OUTPUT                      
         USING PPBVALD,R7                                                       
*                                                                               
         MVC   0(6,R2),PBLDATE     SAVE BILLED DATE AND INVOICE NO              
*                                                                               
*        GET DOLLARS VIA WHATDOL ROUTINE                                        
*                                                                               
         GOTO1 =A(COMMON1),DMCB,RWHATDOL,PPBVEEG,=C'B'                          
*                                                                               
         MVC   6(4,R2),0(R1)       RETURN RELEVANT DOLLARS                      
*                                                                               
         LA    R2,11(R2)           BUMP TO NEXT OUTPUT AREA                     
*                                                                               
IBILU1CN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PBILELEM+1       GET ELEMENT LENGTH                           
         LA    R6,PBILELEM(RF)     BUMP TO NEXT ELEMENT                         
*                                                                               
         B     IBILU1LP                                                         
*                                                                               
IBILU1DN DS    0H                                                               
*                                                                               
IBILUEDX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IBILUCTR DC    PL2'0'              ELEMENT COUNTER                              
IBILUVAL DS    XL(PPBVALDL)        PPBVAL SAVEAREA                              
*                                                                               
         DROP  R4,R6,R7                                                         
*                                                                               
         TITLE 'PRWRITER - BILLED DATA - INPUT - IBLLD'                         
***********************************************************************         
*                                                                     *         
*        BILLED DATA FIELDS                                           *         
*                                                                     *         
*NTRY    GLARGS     C'M'  - DATA IN BUY BILLING ELEMENT               *         
*          GLARGS+1    C'B'  - BILLED                                 *         
*                      C'O'  - OPEN                                   *         
*                      C'R'  - REBATE                                 *         
*              GLARGS+2  C'#'  - INVOICE NUMBER                       *         
*                 GLARGS+3 C'L' - LABATT FORMAT                       *         
*                          C'V' - LABATT VOUCHER                      *         
*                                                                     *         
*                        C'D'  - BILL   DATE                          *         
*                        C'P'  - BILL   PRODUCT                       *         
*                        C'T'  - BILL   TYPE                          *         
*                        C'C'  - BILL   ADDITIONAL CHARGE CODE        *         
*                        C'O'  - BILL   PURCHASE ORDER NUMBER         *         
*                          C'#' - PURCHASE ORDER NUMBER               *         
*                          C'P' - PURCHASE ORDER PERIOD               *         
*                          C'S' - PURCHASE ORDER STATUS               *         
*                          C'Q' - PURCHASE ORDER SQN                  *         
*                                                                     *         
*        GLARGS     C'I'  - DATA IN BUY BILL ELM AND BILL HDR RECORD  *         
*                   C'Q'  - DATA IN BUY BILL, BILL HDR REC & CASH ELM *         
*          GLARGS+1    C'B'  - BILLED                                 *         
*                      C'O'  - OPEN                                   *         
*                      C'R'  - REBATE                                 *         
*              GLARGS+2  C'$'  - ACTUAL AMOUNT                        *         
*                        C'U'  - BILL   DUE DATE                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IBLD     NMOD1 0,**#IBLD                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        HANDLE DATA IN BILL ELEMENT                                            
*                                                                               
         ICM   R7,15,PBBLLELA      ESTABLISH BUY BILL ELEMENT                   
         BZ    IBLDX                  SKIP - NONE AVAILABLE                     
         USING PBILELD,R7                                                       
*                                                                               
         CLI   GLARGS,C'M'         SKIP IF NOT IN BILL ELEMENT                  
         BNE   IBLDBLLN                                                         
*                                                                               
         OC    PBMBTELA,PBMBTELA   IF CASH ELEMENT KNOWN                        
         BZ    *+12                                                             
         CLI   GLARGS,C'Q'            SKIP UNLESS CASH DATA WANTED              
         BNE   IBLDX                                                            
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+2,C'#'       INVOICE NUMBER                               
         BE    IBLDINV                                                          
*                                                                               
         CLI   GLARGS+2,C'P'       BILL PRODUCT                                 
         BE    IBLDIDT                                                          
*                                                                               
         CLI   GLARGS+2,C'T'       INVOICE TYPE/STATUS                          
         BE    IBLDITP                                                          
*                                                                               
         CLI   GLARGS+2,C'D'       BILL DATE                                    
         BE    IBLDBDT                                                          
*                                                                               
         CLI   GLARGS+2,C'C'       BILL ADDITIONAL CHARGE CODE                  
         BE    IBLDACH                                                          
*                                                                               
         CLI   GLARGS+2,C'O'       BILL PURCHASE ORDER                          
         BE    IBLDPO                                                           
*                                                                               
         B     IBLDX               UNKNOWN DATA TYPE                            
*                                                                               
IBLDACH  DS    0H                  ADDITIONAL CHARGE CODE                       
*                                                                               
         CLI   PBILELEM+1,PBACCODE-PBILELEM SKIP IF NO ADDL CHARGE              
         BNH   IBLDBLDX                                                         
*                                                                               
         OC    PBACCODE,PBACCODE   SKIP IF NO ADDITIONAL CHARGE CODE            
         BZ    IBLDBLDX                                                         
*                                                                               
         MVC   0(L'PBACCODE,R2),PBACCODE    ADDITIONAL CHARGE CODE              
*                                                                               
         B     IBLDBLDX                                                         
*                                                                               
IBLDBDT  DS    0H                  BILL DATE                                    
*                                                                               
         MVC   0(L'PBLDATE,R2),PBLDATE     BILLED DATE                          
         BZ    IBLDINVX                                                         
*                                                                               
         B     IBLDBLDX                                                         
*                                                                               
IBLDINV  DS    0H                  INVOICE NUMBER                               
*                                                                               
         OC    PBLDATE,PBLDATE     SKIP IF NOT BILLED                           
         BZ    IBLDINVX                                                         
*                                                                               
*        EXPANDED INVOICE NUMBER                                                
*                                                                               
         GOTO1 =A(BLDINV),DMCB,PBLDATE,(R2),PBMED  GENERATE INVOICE NO          
*                                                                               
IBLDINVX DS    0H                                                               
*                                                                               
         B     IBLDBLDX                                                         
*                                                                               
IBLDITP  DS    0H                  BILL STATUS/TYPE                             
*                                                                               
         MVC   0(L'PBBILST,R2),PBBILST  PASS TO OUTPUT                          
*                                                                               
         B     IBLDBLDX                                                         
*                                                                               
IBLDBLDX DS    0H                                                               
*                                                                               
         B     IBLDX                                                            
*                                                                               
IBLDBLLN DS    0H                                                               
*                                                                               
*        FIELD REQUIRES BILL ELEMENT AND BILL HEADER RECORD DATA                
*                                                                               
IBLDBHD  DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'I'         SKIP IF NOT OF CORRECT TYPE                  
         BE    *+8                                                              
         CLI   GLARGS,C'Q'         SKIP IF NOT OF CORRECT TYPE                  
         BNE   IBLDBHDN                                                         
*                                                                               
         ICM   R3,15,PBBHDELA      POINT TO BILL HEADER RECORD                  
         BZ    IBLDX               NOTHING BILLED YET                           
*                                                                               
         OC    PBMBTELA,PBMBTELA   IF CASH ELEMENT KNOWN                        
         BZ    *+12                                                             
         CLI   GLARGS,C'Q'            SKIP UNLESS CASH DATA WANTED              
         BNE   IBLDX                                                            
*                                                                               
         USING PBILLRCD,R3         ESTABLISH AS BILL RECORD                     
*                                                                               
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+2,C'$'       ACTUAL BILL AMOUNT                           
         BE    IBLDACT                                                          
*                                                                               
         CLI   GLARGS+2,C'U'       BILL DUE DATE                                
         BE    IBLDDUE                                                          
*                                                                               
         CLI   GLARGS+2,C'D'       BILL DATE                                    
         BE    IBLDIDT                                                          
*                                                                               
         CLI   GLARGS+2,C'#'       FULL BILL NUMBER                             
         BE    IBLDIV#                                                          
*                                                                               
         B     IBLDX               UNKNOWN DATA TYPE                            
*                                                                               
*        BILL INVOICE DATE                                                      
*                                                                               
IBLDIDT  DS    0H                  BILL INVOICE DATE                            
*                                                                               
         MVC   0(L'PBILINVD,R2),PBILINVD                                        
*                                                                               
         B     IBLDBLDX                                                         
*                                                                               
*        BILLED ACTUAL                                                          
*                                                                               
IBLDACT  DS    0H                                                               
*                                                                               
*        GET EFFECTIVE RATES VIA PPBVAL                                         
*                                                                               
         GOTO1 =V(PPBVAL),DMCB,(C'E',PBILELD),IBLDVAL                           
*                                                                               
         LA    R1,IBLDVAL          ESTABLISH RETURNED DATA                      
         USING PPBVALD,R1                                                       
*                                                                               
*        CALCULATE BILLED COST VIA GETCOST                                      
*                                                                               
         MVC   IBLBLGRS,PPBVEEG    RE-ARRANGE FIELD ORDER                       
         MVC   IBLBLCD,PPBVEEC                                                  
         MVC   IBLBLAC,PPBVEEA                                                  
*                                                                               
         DROP  R1                                                               
*                                                                               
         ZAP   0(8,R2),=P'0'       DEFAULT TO ZERO                              
*                                                                               
         OC    PBILBASA(5),PBILBASA SKIP IF NO BILL FORMULA                     
         BZ    IBLDACTX                                                         
*                                                                               
*        GOTO1 =V(GETCOST),DMCB,PBILBASA,IBLBLGRS,AIO1                          
         GOTO1 =V(GETCOST),DMCB,(C'T',PBILBASA),IBLBLGRS,AIO1                   
*                                                                               
         ICM   RF,15,DMCB+4        GET RETURNED COST                            
         CVD   RF,DUB              RETURN AMOUNT                                
         ZAP   0(8,R2),DUB                                                      
*                                                                               
         TM    GLARGS+5,X'10'      SKIP UNLESS OUTPUT GST WANTED                
         BNO   IBLDACTX                                                         
*                                                                               
         ZAP   IBLGST,=P'0'        INIT GST FOR BILL ELEMENT                    
*                                                                               
*        FIND VAT ELEMENT                                                       
*                                                                               
         LA    RE,PBILLEL          FIRST ELEMENT IN BILL HEADER RECORD          
         SR    RF,RF                                                            
*                                                                               
         CLI   0(RE),X'00'         END OF RECORD                                
         BE    IBLBLL50                                                         
         CLI   0(RE),X'0A'         LOOK FOR VAT ELEMENT                         
         BE    *+16                                                             
         IC    RF,1(RE)            ELEMENT LENGTH                               
         LA    RE,0(RF,RE)         POINT TO NEXT ELEMENT                        
         B     *-24                                                             
*                                                                               
         OC    PBILLVAT-PBILVEL(L'PBILLVAT,RE),PBILLVAT-PBILVEL(RE)             
         BZ    IBLBLL50                                                         
*                                                                               
         ZAP   BYTE,=P'5'          DEFAULT GST = 5% OF BILLED AMOUNT            
*                                                                               
         CLC   PBILLDAT,=X'FAF8F0F1F0F1'   IF BILLED BEFORE JAN1/08             
         BNL   *+10                                                             
         ZAP   BYTE,=P'6'          DEFAULT GST = 6% OF BILLED AMOUNT            
*                                                                               
         CLC   PBILLDAT,=X'FAF6F0F7F0F1'   IF BILLED BEFORE JUL1/06             
         BNL   *+10                                                             
         ZAP   BYTE,=P'7'             GST = 7% OF BILLED AMOUNT                 
*                                                                               
         MP    DUB,BYTE            GST                                          
*                                                                               
         SRP   DUB,64-2,5          ROUND TO 2 DECIMALS                          
         ZAP   IBLGST,DUB          SAVE GST AMOUNT                              
         AP    0(8,R2),DUB         ADD TO ACTUAL BILL AMOUNT                    
*                                                                               
IBLBLL50 DS    0H                                                               
*                                                                               
IBLDACTX DS    0H                                                               
*                                                                               
         B     IBLDX                                                            
*                                                                               
IBLDDUE  DS    0H                  INVOICE DUE DATE                             
*                                                                               
         MVC   0(3,R2),PBILDUED    RETURN DUE DATE                              
*                                                                               
         B     IBLDX                                                            
*                                                                               
IBLDIV#  DS    0H                  INVOICE NUMBER                               
*                                                                               
         OC    PBBHDELA,PBBHDELA      POINT TO BILL RECORD                      
         BZ    IBLDIVX                DONE IF NONE AVAILABLE                    
*                                                                               
         GOTO1 =A(BLDINV),DMCB,(C'B',PBLDATE),0(R2),PBMED,PBBHDELA              
*                                                                               
IBLDIVX  DS    0H                                                               
*                                                                               
         B     IBLDX                                                            
*                                                                               
*        PURCHASE ORDER FIELDS                                                  
*                                                                               
*        GLARGS+3                                                               
*              C'#' -  PURCHASE ORDER NUMBER                                    
*              C'P' -  PURCHASE ORDER PERIOD                                    
*              C'S' -  PURCHASE ORDER STATUS                                    
*              C'Q' -  PURCHASE ORDER SQN                                       
*                                                                               
IBLDPO   DS    0H                                                               
*                                                                               
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
         USING PBILELEM,R7         ESTABLISH BUY BILL ELM                       
*                                                                               
         CLI   PBILELEM+1,27       SKIP IF NO PO FOR BILL                       
         BL    IBLDPOX                                                          
*                                                                               
*        CALL PPGETPO# TO GET A(PO# ELEMENT)                                    
*                                                                               
         XC    IBLDPOEL,IBLDPOEL   INIT RETURN AREA                             
*                                                                               
         MVI   ELCODE,PCLTPOEQ     FIND PURCHASE ORDER ELEMENT                  
         MVI   BYTE,0              INIT SAVEAREA                                
         L     R6,PBCLTADR         LOOK IN CLIENT RECORD                        
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
*                                                                               
IBLDPOLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE AT END OF RECORD                        
         BE    IBLDPODN                                                         
*                                                                               
         CLI   0(R6),PCLTPOEQ      LOOK FOR PURCHASE ORDER ELM                  
         BE    IBLDPOFD                                                         
*                                                                               
IBLDPOCN DS    0H                                                               
*                                                                               
         LLC   RF,1(R6)            ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         B     IBLDPOLP                                                         
*                                                                               
IBLDPOFD DS    0H                                                               
*                                                                               
         USING PCLTPOEL,R6         ESTABLISH PURCHASE ORDER ELM                 
         MVC   BYTE,PCLTPOLV       SAVE PO# LEVEL                               
*                                                                               
IBLDPODN DS    0H                                                               
*                                                                               
         GOTOR =V(PPGETPO#),DMCB,(C'E',PBUYREC),(BYTE,IBLDPOEL),       X        
               PBCOMFAC,(0,PBILELEM)                                            
*                                                                               
         CLI   DMCB,X'FF'          SKIP IF ERRORS                               
         BE    IBLDPO#X                                                         
*                                                                               
         L     R6,DMCB+12          ESTABLISH PO# ELEMENT                        
         USING PO#DELMD,R6                                                      
*                                                                               
         CLI   PO#DELID,PO#DLIDQ   SKIP IF NOT A PO# ELEM                       
         BNE   IBLDPOX                                                          
*                                                                               
*        PURCHASE ORDER NUMBER                                                  
*                                                                               
         CLI   GLARGS+3,C'#'       IF PO# WANTED                                
         BNE   IBLDPO#N                                                         
*                                                                               
         LLC   RF,PO#DLEN          GET ELEMENT LENGTH                           
         SHI   RF,PO#DHDLQ         LESS HEADER LENGTH                           
         BZ    IBLDPO#X               NO PO#                                    
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PO#DPO#     RETURN PO#                                   
*                                                                               
IBLDPO#X DS    0H                                                               
         B     IBLDPOX                                                          
*                                                                               
IBLDPO#N DS    0H                                                               
*                                                                               
*        PURCHASE ORDER PERIOD                                                  
*                                                                               
         CLI   GLARGS+3,C'P'       IF PO# PERIOD WANTED                         
         BNE   IBLDPOPN                                                         
*                                                                               
         MVC   0(6,R2),PO#DSTRT       RETURN PERIOD                             
*                                                                               
IBLDPOPX DS    0H                                                               
         B     IBLDPOX                                                          
*                                                                               
IBLDPOPN DS    0H                                                               
*                                                                               
*        PURCHASE ORDER AMOUNT                                                  
*                                                                               
         CLI   GLARGS+3,C'$'       IF PO# AMOUNT WANTED                         
         BNE   IBLDPO$N                                                         
*                                                                               
         ZAP   0(8,R2),PO#D$          RETURN AMOUNT                             
*                                                                               
         CLI   PO#DGORN,C'N'       IF AMOUNT IS NET                             
         BNE   *+14                                                             
         ZAP   8(8,R2),=P'1'          RETURN 1                                  
         B     IBLDPO$X                                                         
*                                                                               
IBLDPO$X DS    0H                                                               
         B     IBLDPOX                                                          
*                                                                               
IBLDPO$N DS    0H                                                               
*                                                                               
*        PURCHASE ORDER STATUS                                                  
*                                                                               
         CLI   GLARGS+3,C'S'       IF PO# STATUS WANTED                         
         BNE   IBLDPOSN                                                         
*                                                                               
         MVC   0(8,R2),=CL8'ACTIVE'   ASSUME ACTIVE                             
*                                                                               
         TM    PO#DACTV,PO#DINAQ   IF INACTIVE                                  
         BNO   *+10                                                             
         MVC   0(8,R2),=CL8'INACTIVE'   SET STATUS                              
*                                                                               
IBLDPOSX DS    0H                                                               
         B     IBLDPOX                                                          
*                                                                               
IBLDPOSN DS    0H                                                               
*                                                                               
*        PURCHASE ORDER SEQUENCE NUMBER                                         
*                                                                               
         CLI   GLARGS+3,C'Q'       IF PO# SQN WANTED                            
         BNE   IBLDPOQN                                                         
*                                                                               
         MVC   0(L'PO#DID,R2),PO#DID  RETURN INTERNAL SQN                       
*                                                                               
IBLDPOQX DS    0H                                                               
         B     IBLDPOX                                                          
*                                                                               
IBLDPOX  DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE      RESTORE POINTER                                
         OI    DMINBTS,8         PASS BACK DELETED RECORDS                      
         GOTO1 HIGH                                                             
*                                                                               
         B     IBLDX                                                            
*                                                                               
IBLDPOQN DS    0H                                                               
*                                                                               
IBLDBHDN DS    0H                                                               
*                                                                               
IBLDX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IBLBLGRS DS    F                   WORK GROSS                                   
IBLBLCD  DS    F                   WORK CASH DISCOUNT                           
IBLBLAC  DS    F                   WORK AGENCY COMMISSION                       
IBLGST   DS    PL8                 WORK GST                                     
IBLPST   DS    PL8                 WORK PST                                     
IBLDPOEL DS    XL64                PO ELEMENT SAVEAREA                          
*                                                                               
         DS    0D                                                               
IBLDVAL  DS    XL(PPBVALDL)        PPBVAL SAVEAREA                              
*                                                                               
         DROP  R3,R7                                                            
*                                                                               
         TITLE 'PRWRITER - BILLED DATA - OUTPUT - OBLLD'                        
***********************************************************************         
*                                                                     *         
*        BILLED DATA FIELDS                                           *         
*                                                                     *         
*NTRY                                                                 *         
*          GLARGS      C'B'  - BILLED                                 *         
*                      C'O'  - OPEN                                   *         
*                      C'R'  - REBATE                                 *         
*            GLARGS+1                                                 *         
*                      C'T'  - BILL   TYPE                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OBLD     NMOD1 0,**#OBLD                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS,C'T'         INVOICE TYPE/STATUS                          
         BE    OBLDITP                                                          
*                                                                               
         B     OBLDX               UNKNOWN DATA TYPE                            
*                                                                               
*        BILL STATUS/TYPE                                                       
*                                                                               
OBLDITP  DS    0H                  BILL STATUS/TYPE                             
*                                                                               
         TM    0(R2),X'80'         REVERSED BILL                                
         BNO   *+14                                                             
         MVC   0(8,R3),=C'REVERSED'                                             
         B     OBLDITPX                                                         
*                                                                               
         TM    0(R2),X'40'         REVERSAL BILL                                
         BNO   *+14                                                             
         MVC   0(8,R3),=C'REVERSAL'                                             
         B     OBLDITPX                                                         
*                                                                               
         TM    0(R2),X'01'         UP FRONT COMMISSION BILL                     
         BNO   *+14                                                             
         MVC   0(8,R3),=C'UPF COM '                                             
         B     OBLDITPX                                                         
*                                                                               
         TM    0(R2),X'02'         UP FRONT NET        BILL                     
         BNO   *+14                                                             
         MVC   0(8,R3),=C'UPF NET '                                             
         B     OBLDITPX                                                         
*                                                                               
OBLDITPX DS    0H                                                               
*                                                                               
OBLDX    DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
       ++INCLUDE PPBILEXD                                                       
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - NEW INVOICE DATA  - INPUT - IBNV'                    
***********************************************************************         
*                                                                     *         
*        REPORT NEW INVOICE DETAIL DATA STORED IN BUY                 *         
*                                                                     *         
*NTRY       BUY INVOICE ELEMENT                                       *         
*        OR INVOICE DETAIL ELEMENET                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IBNV     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   GLARGS+1,C'P'       PAYABLE SWITCH                               
         BNE   IBNVBPSN                                                         
*                                                                               
         CLI   PBMODE,PBPROCNV     IF DOING INVOICES                            
         BNE   IBNVVPSN                                                         
*                                                                               
*        IF USING A PAYABLE FILTER, THIS SWITCH IS SET TO 1 FOR ALL             
*        INVOICES WITH NO BUY SERIAL # I.E. RNO'S                               
*                                                                               
         ICM   R6,15,PBIDTELA      SKIP IF NO INVOICE DETAIL ELEMENT            
         BZ    IBNVVPSX                                                         
*                                                                               
         CLI   PBQDSTA,PBMTDRSQ    SKIP IF FILTERING ON RESOLVED STATUS         
         BE    IBNVVPSX                                                         
*                                                                               
         USING PNVDTLD,R6             ESTABLISH NEW INVOICE HEADER              
*                                                                               
         OC    PNVDSER#,PNVDSER#   IF NO BUY SERIAL NUMBER                      
         BNZ   *+10                                                             
         ZAP   0(8,R2),=P'1'          SET SWITCH ON                             
*                                                                               
IBNVVPSX DS    0H                                                               
*                                                                               
         B     IBNVX                                                            
*                                                                               
IBNVVPSN DS    0H                                                               
*                                                                               
*        IF USING A PAYABLE FILTER, THIS SWITCH IS SET TO 1 FOR ALL             
*        BUYS THAT MAKE IT THIS FAR.                                            
*        ON OUTPUT IT WILL FLAG ANY INVOICE LINES ASSOCIATED                    
*        WITH A PAYABLE BUY. THUS NEQ=0 WILL FILTER OUT ANY                     
*        INVOICE LINES FOR NON-PAYABLE BUYS.                                    
*                                                                               
         ZAP   0(8,R2),=P'0'       INIT SWITCH                                  
*                                                                               
         CLI   PBMODE,PBPROCBY     IF DOING BUYS                                
         BNE   *+10                                                             
         ZAP   0(8,R2),=P'1'          SET SWITCH ON                             
*                                                                               
         B     IBNVX                                                            
*                                                                               
IBNVBPSN DS    0H                                                               
*                                                                               
*                                                                               
*        NEW INVOICE BUY ELEMENT                                                
*                                                                               
         CLI   PBMODE,PBPROCBY     SKIP IF NOT PROCESSING INSERTION             
         BNE   IBNVBNVN                                                         
*                                                                               
         ICM   R6,15,PBPNVELA      SKIP IF NO NEW INVOICE ELEMENT               
         BZ    IBNVBNVX                                                         
*                                                                               
         USING PBNVELM,R6          ESTABLISH NEW INVOICE ELM                    
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
*        INVOICE NUMBER                                                         
*                                                                               
         CLI   GLARGS+1,C'#'       INVOICE NUMBER                               
         BNE   IBNVB#N                                                          
*                                                                               
         MVC   0(L'PBNVINV#,R2),PBNVINV# RETURN INVOICE NUMBER                  
*                                                                               
         B     IBNVBNVX                                                         
*                                                                               
IBNVB#N  DS    0H                                                               
*                                                                               
*        INVOICE LINE ITEM NUMBER                                               
*                                                                               
         CLI   GLARGS+1,C'S'       INVOICE DETAIL SEQUENCE NUMBER               
         BNE   IBNVBSQN                                                         
*                                                                               
         MVC   0(L'PBNVDSQN,R2),PBNVDSQN RETURN SEQUENCE NUMBER                 
*                                                                               
         B     IBNVBNVX                                                         
*                                                                               
IBNVBSQN DS    0H                                                               
*                                                                               
*        BUY MATCHING STATUS                                                    
*                                                                               
         CLI   GLARGS+1,C'M'       BUY MATCHING STATUS                          
         BNE   IBNVBMSN                                                         
*                                                                               
         MVC   IBNVGLSV,GLARGS     SAVE GLARGS                                  
         MVC   GLARGS(05),=XL5'C252020100' SET IELM ARGS                        
*                                                                               
         GOTOR =V(IELM)            GET MATCHING STATUS                          
*                                                                               
         MVC   GLARGS(16),IBNVGLSV RESTORE GLARGS                               
*                                                                               
         B     IBNVBNVX                                                         
*                                                                               
IBNVBMSN DS    0H                                                               
*                                                                               
*        BUY DISCREPANCY STATUS                                                 
*                                                                               
         CLI   GLARGS+1,C'D'       INVOICE DETAIL DISCREPANCY STATUS            
         BNE   IBNVBDSN                                                         
*                                                                               
         MVC   IBNVGLSV,GLARGS     SAVE GLARGS                                  
         MVC   GLARGS(5),=XL5'C252030100' SET IELM ARGS                         
*                                                                               
         GOTOR =V(IELM)            GET MATCHING STATUS                          
*                                                                               
         MVC   GLARGS(16),IBNVGLSV RESTORE GLARGS                               
*                                                                               
         B     IBNVBNVX                                                         
*                                                                               
IBNVBDSN DS    0H                                                               
*                                                                               
*        UNKNOWN KEYWORD                                                        
*                                                                               
IBNVBNVX DS    0H                                                               
*                                                                               
         B     IBNVX                                                            
*                                                                               
IBNVBNVN DS    0H                                                               
*                                                                               
*        INVOICE RECORD ELEMENTS                                                
*                                                                               
         CLI   PBMODE,PBPROCNV     SKIP IF NOT PROCESSING NEW INVOICES          
         BNE   IBNVPNVN                                                         
*                                                                               
         CLI   GLARGS+1,C'#'       IF INVOICE NUMBER WANTED                     
         BNE   IBNVP#N                                                          
*                                                                               
         ICM   R6,15,PBIHDELA      SKIP IF NO INVOICE HEADER ELEMENT            
         BZ    IBNVPNVX                                                         
*                                                                               
         USING PNVHDRD,R6             ESTABLISH NEW INVOICE HEADER              
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         MVC   0(L'PNVHINV#,R2),PNVHINV# RETURN INVOICE NUMBER                  
*                                                                               
         B     IBNVPNVX                                                         
*                                                                               
IBNVP#N  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'S'       INVOICE DETAIL SEQUENCE NUMBER               
         BNE   IBNVPSQN                                                         
*                                                                               
         ICM   R6,15,PBIDTELA      SKIP IF NO INVOICE DETAIL ELEMENT            
         BZ    IBNVPNVX                                                         
*                                                                               
         USING PNVDTLD,R6             ESTABLISH NEW INVOICE HEADER              
*                                                                               
         MVC   0(L'PNVDKSQN,R2),PNVDKSQN RETURN SEQUENCE NUMBER                 
*                                                                               
         B     IBNVPNVX                                                         
*                                                                               
IBNVPSQN DS    0H                                                               
*                                                                               
*        LINE ITEM DETAIL MATCHING STATUS                                       
*                                                                               
         CLI   GLARGS+1,C'M'       INVOICE DETAIL MATCH STATUS                  
         BNE   IBNVMSTN                                                         
*                                                                               
         CLI   GLARGS+2,C'D'       MUST BE FOR DETAIL LINE ITEM                 
         BNE   IBNVMSTN                                                         
*                                                                               
         ICM   R6,15,PBIDTELA      SKIP IF NO INVOICE DETAIL ELEMENT            
         BZ    IBNVMSTX                                                         
*                                                                               
         USING PNVDTLD,R6             ESTABLISH NEW INVOICE HEADER              
*                                                                               
         OC    PNVDSER#,PNVDSER#   IF NO BUY SERIAL NUMBER                      
         BNZ   *+8                                                              
         MVI   0(R2),C'R'             FLAG AS RNO                               
*                                                                               
IBNVMSTX DS    0H                                                               
*                                                                               
         B     IBNVPNVX                                                         
*                                                                               
IBNVMSTN DS    0H                                                               
*                                                                               
         B     IBNVPNVX                                                         
*                                                                               
IBNVPNVN DS    0H                                                               
*                                                                               
IBNVPNVX DS    0H                                                               
*                                                                               
         B     IBNVX                                                            
*                                                                               
IBNVX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
IBNVGLSV DS    XL16                GLARGS SAVEAREA                              
*                                                                               
         TITLE 'PRWRITER - NEW INVOICE DATA  - OUTPUT - OBNV'                   
***********************************************************************         
*                                                                     *         
*        REPORT NEW INVOICE DETAIL DATA STORED IN BUY                 *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OBNV     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS,C'D'         DISCREPANCY STATUS                           
         BNE   *+8                                                              
         LA    R4,OBNVDTAB         POINT TO DISCREPANCY TRANSLATE TABLE         
*                                                                               
         CLI   GLARGS,C'M'         MATCHING STATUS                              
         BNE   *+8                                                              
         LA    R4,OBNVMTAB         POINT TO MATCHING TRANSLATE TABLE            
*                                                                               
*        TRANSLATE STATUS CODE                                                  
*                                                                               
OBNVTRLP DS    0H                                                               
*                                                                               
         CLI   0(R4),X'FF'         DONE AT END OF TABLE                         
         BE    OBNVTRDN                                                         
*                                                                               
         CLC   0(1,R2),0(R4)       MATCH CODE                                   
         BE    OBNVTRFD                                                         
*                                                                               
OBNVTRCN DS    0H                                                               
*                                                                               
         LA    R4,13(R4)           BUMP TO NEXT ENTRY IN TABLE                  
         B     OBNVTRLP                                                         
*                                                                               
OBNVTRFD DS    0H                  ENTRY FOUND IN TABLE                         
*                                                                               
         MVC   0(12,R3),1(R4)      RETURN TRANSALTION OF CODE                   
*                                                                               
         B     OBNVTRX                                                          
*                                                                               
OBNVTRDN DS    0H                  NO MATCH FOUND IN TABLE                      
*                                                                               
OBNVTRX  DS    0H                                                               
*                                                                               
         B     OBNVX                                                            
*                                                                               
*        DISCREPANCY TRANSLATION TABLE                                          
*                                                                               
OBNVDTAB DS    0H                                                               
         DC    CL1'N',CL12'NEEDS REVIEW'                                        
         DC    CL1'V',CL12'REVIEWING'                                           
         DC    CL1'R',CL12'RESOLVED'                                            
         DC    XL1'FF'             EOT                                          
*                                                                               
OBNVMTAB DS    0H                                                               
         DC    CL1'P',CL12'PENDING'                                             
         DC    CL1'M',CL12'MATCHED'                                             
         DC    CL1'D',CL12'DISCREPANT'                                          
         DC    CL1'N',CL12'NO INVOICE'                                          
         DC    AL1(0),CL12'NO INVOICE'                                          
         DC    CL1'R',CL12'RNO'                                                 
         DC    XL1'FF'             EOT                                          
*                                                                               
OBNVX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'T41D20 - INVOICE DETAIL MAINT/LIST - FMTRTE'                    
***********************************************************************         
*                                                                     *         
*        DISPLAY  RATE                                                *         
*                                                                     *         
*NTRY    R2==>  RATE OUTPUT FIELD                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IBRATE   NTR1  BASE=*,LABEL=*      DISPLAY BUY RATE                             
*                                                                               
         USING PBUYRECD,R4         ESTABLISH BUY RECORD                         
         L     R4,AIO1                                                          
*                                                                               
         LA    R6,33(R4)           POINT TO FIRST ELEMENT IN BUY                
         USING PBDELEM,R6          ESTABLISH BUY DESCRIPTION ELEMENT            
*                                                                               
*        FORMAT NEWSPAPER COSTS                                                 
*                                                                               
         ZAP   IBRTCOST,PBDCOS     INIT COST FIELD                              
*                                                                               
         CLI   PBDCTYP,C'N'        IF ENTERED AT NET                            
         BNE   IBRTNETX                                                         
*                                                                               
         ZAP   IBRTWORK,IBRTCOST   INIT WORK FIELD                              
*                                                                               
         ZAP   IBRTPCT,=P'100000'     GET NET AMOUNT                            
         SP    IBRTPCT,PBDACP         AS 100% LESS AGY COMM                     
         MP    IBRTWORK,IBRTPCT       TIMES GROSS                               
         SRP   IBRTWORK,64-5,5        ROUNDED TO ORIGINAL PRECISION             
*                                                                               
         ZAP   IBRTCOST,IBRTWORK   REDUCE TO DOUBLE WORD                        
*                                                                               
IBRTNETX DS    0H                                                               
*                                                                               
         LA    R3,IBRTOUT          FIRST POSITION OF OUTPUT                     
*                                                                               
         CLI   PBDCTYP,C' '        IF COST TYPE PRESENT                         
         BNH   *+14                                                             
         MVC   0(1,R3),PBDCTYP        DISPLAY IT                                
         LA    R3,1(R3)               BUMP OUTPUT POINTER                       
*                                                                               
         CLI   PBDCOSIN,C' '       IF COST INDICATOR PRESENT                    
         BNH   *+14                                                             
         MVC   0(1,R3),PBDCOSIN       DISPLAY IT                                
         LA    R3,1(R3)               BUMP OUTPUT POINTER                       
*                                                                               
         TM    PBDRLIND,X'08'      IF FROZEN RATE                               
         BNO   *+12                                                             
         MVI   0(R3),C'*'             DISPLAY INDICATOR                         
         LA    R3,1(R3)               BUMP OUTPUT POINTER                       
*                                                                               
         CP    IBRTCOST,=P'0'      IF ZERO COST                                 
         BNE   *+14                                                             
         MVC   0(4,R3),=C'FREE'       DISPLAY 'FREE'                            
         B     IBRTCOS4                                                         
*                                                                               
         CLI   PBDCOSTY,C'U'       SKIP IF UNIT COST                            
         BE    IBRTCOS2                                                         
*                                                                               
         CLI   PBDCOSTY,C' '       IF COST TYPE PRESENT                         
         BNH   *+14                                                             
         MVC   0(1,R3),PBDCOSTY       DISPLAY IT                                
         LA    R3,1(R3)               BUMP OUTPUT POINTER                       
*                                                                               
         B     IBRTCOS3                                                         
*                                                                               
IBRTCOS2 DS    0H                                                               
*                                                                               
         EDIT  IBRTCOST,(17,0(R3)),5,ALIGN=LEFT,FLOAT=-                         
*                                                                               
         LR    RF,R3               POINT TO END OF EXPRESSION                   
         AR    RF,R0                                                            
         SHI   RF,3                BACKUP 3 PLACES                              
         CLC   =C'000',0(RF)       IF RATE ENDS IN 3 ZEROS                      
         BNE   *+10                                                             
         MVC   0(3,RF),SPACES         ERASE ZEROS                               
*                                                                               
         B     IBRTCOS4                                                         
*                                                                               
IBRTCOS3 DS    0H                  ELSE USE 2 DECIMAL PLACES                    
*                                                                               
         EDIT  IBRTCOST,(17,0(R3)),2,ALIGN=LEFT,FLOAT=-                         
*                                                                               
IBRTCOS4 DS    0H                                                               
*                                                                               
         CLI   IBRTOUT+10,C'.'     IF COST ENDS IN DECIMAL                      
         BNE   *+8                                                              
         MVI   IBRTOUT+10,C' '        ERASE IT                                  
*                                                                               
         MVC   0(11,R2),IBRTOUT    DISPLAY RATE                                 
*                                                                               
IBRATEX  DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
IBRTWORK DS    PL16                WORKAREA                                     
IBRTCOST DS    PL8                 WORKAREA FOR COST                            
IBRTPCT  DS    PL8                 WORKAREA FOR AGY COMM                        
IBRTOUT  DS    CL64                OUTPUT WORKAREA                              
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R6                                                            
*                                                                               
***********************************************************************         
*                                                                     *         
*        DISPLAY  BUY RATE TYPE                                       *         
*                                                                     *         
*NTRY    R2==>  RATE OUTPUT FIELD                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IBRTTY   NTR1  BASE=*,LABEL=*      DISPLAY BUY RATE TYPE                        
*                                                                               
         L     R6,AIO1             Point to buy record                          
         LA    R6,33(R6)           First element in buy record                  
         USING PBDELEM,R6          Establish buy description element            
*                                                                               
         XC    0(4,R2),0(R2)       Init output field                            
         CLI   PBDCTYP,C'N'        Net?                                         
         JNE   IBRTTY20                                                         
         MVC   0(1,R2),PBDCTYP                                                  
         CLI   PBDCOSIN,C'C'       Commission?                                  
         JNE   IBRTTYX                                                          
         MVC   1(1,R2),PBDCOSIN                                                 
         J     IBRTTYX                                                          
*                                                                               
IBRTTY20 MVI   0(R2),C'G'          Default rate type is gross                   
         CLI   PBDCOSIN,C' '       Gross?                                       
         JNH   *+10                                                             
         MVC   0(1,R2),PBDCOSIN                                                 
*                                                                               
IBRTTYX  XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
         TITLE 'PROCESS SPACE DESCRIPTION ON INPUT SIDE - IBUYDSC'              
***********************************************************************         
*                                                                     *         
*        BUY SPACE DESCRIPTION                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IBUYDSC  NMOD1 0,**#IBDSC                                                       
*                                                                               
         LA    R7,PBLOCK           ESTABLISH PRNTBLOCK                          
         USING PBLOCK,R7                                                        
*                                                                               
         CLI   GLARGS,C'X'         IF INVOICE DETAIL SPACE                      
         BNE   *+12                                                             
         CLI   PBMODE,PBPROCIV     THEN MUST BE PROCESSING INVOICES             
         BNE   IBUYDSXX                                                         
*                                                                               
         CLI   GLARGS,C'X'         IF INVOICE DETAIL SPACE                      
         BNE   *+12                                                             
         CLI   PBMODE,PBPROCIV     THEN MUST BE PROCESSING INVOICES             
         BNE   IBUYDSXX                                                         
*                                                                               
         CLI   GLARGS,C'Y'         IF INVOICE DETAIL SPACE                      
         BNE   *+12                                                             
         CLI   PBMODE,PBPROCNV     THEN MUST BE PROCESSING INVOICES             
         BNE   IBUYDSXX                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         LH    R5,=Y(PPBYOUTC-SYSD)  DISPLACEMENT OF PPBYOUT AREA               
         AR    R5,R9                                                            
         USING PPBYOUTD,R5         ESTABLISH PPBYOUT AREA                       
*                                                                               
         L     R1,GLADTENT         ESTABLISH INPUT DRIVER ENTRY                 
         USING DRIND,R1                                                         
*                                                                               
         ZIC   R3,DRINLEN          GET INPUT LENGTH                             
*                                  INPUT IS 2*DROLEN+1                          
         DROP  R1                                                               
*                                                                               
         BCTR  R3,0                DECREMENT TO GET 2*DROLEN                    
         SRL   R3,1                /2 = DROLEN                                  
         BCTR  R3,0                EXECUTE LENGTH OF AN OUTPUT LINE             
*                                                                               
         CLI   PBMODE,PBPROCNV     IF PROCESSING AN INVOICE REC                 
         BNE   IBYDSNVN                                                         
*                                                                               
         ICM   R6,15,PBIDTELA      ESTABLISH DETAIL ELEMENT                     
         BZ    IBYDSIV9              NONE AVAILABLE                             
         USING PNVDTLD,R6          ESTABLISH DETAIL ELEMENT                     
*                                                                               
         LA    RF,L'PNVDSPC-1      EXECUTE LENGTH OF SPACE DESCRIPTION          
         CR    RF,R3               DEFAULT TO SHORTER LENGTH                    
         BNH   *+6                                                              
         LR    RF,R3                                                            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PNVDSPC     SPACE IN INV DETAIL ELM                      
*                                                                               
         B     IBYDSIV8                                                         
*                                                                               
IBYDSNVN DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCIV     IF PROCESSING AN INVOICE REC                 
         BNE   IBYDSIVN                                                         
*                                                                               
         ICM   R1,15,PBIDTELA         USE SPACE IN INVOICE DETAIL ELM           
         BZ    IBYDSIV9               EXIT IF NONE FOUND                        
*                                                                               
         LA    RF,L'PIMSPACE-1     EXECUTE LENGTH OF SPACE DESCRIPTION          
         CR    RF,R3               DEFAULT TO SHORTER LENGTH                    
         BNH   *+6                                                              
         LR    RF,R3                                                            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PIMSPACE-PIMDTLEL(R1)  SPACE IN INV DETAIL ELM           
*                                                                               
IBYDSIV8 DS    0H                                                               
*                                                                               
         CLI   PBMED,C'O'          SKIP FOR OUTDOOR                             
         BE    IBUYDS11                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R2),SPACES      SPACE FILL IN INV DETAIL ELM                 
*                                                                               
IBUYDS11 DS    0H                                                               
*                                                                               
         LA    RE,1(R3,R2)         POINT TO SECOND HALF                         
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),SPACES      PAD REMAINDER                                
*                                                                               
         LA    RE,1(R3,RE)         POINT TO MEDIA POSITION                      
         MVC   0(1,RE),PBMED       ADD MEDIA                                    
*                                                                               
IBYDSIV9 DS    0H                                                               
*                                                                               
         B     IBUYDSCX            ALL DONE                                     
*                                                                               
IBYDSIVN DS    0H                                                               
*                                                                               
         TM    PBQREAD,PBQRDBUY    IF NOT READING BUYS                          
         BO    IBUYDSC1                                                         
*                                                                               
         ICM   R1,15,PBQCRTA          USE SPACE IN PASSED CONT RATE ELM         
         BZ    IBUYDSCX               EXIT IF NONE FOUND                        
*                                                                               
         LA    RF,L'PRBDESC-1      EXECUTE LENGTH OF SPACE DESCRIPTION          
         CR    RF,R3               DEFAULT TO SHORTER LENGTH                    
         BNH   *+6                                                              
         LR    RF,R3                                                            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PRBDESC-PRBELEM(R1)  SPACE IN CONTRACT RATE ELM          
*                                                                               
         LA    RE,1(R3,R2)         POINT TO SECOND HALF                         
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),SPACES      PAD REMAINDER                                
*                                                                               
         L     R1,AIO2             POINT TO CONTRACT RECORD                     
         LA    RE,1(R3,RE)         POINT TO MEDIA POSITION                      
*                                                                               
         MVC   0(1,RE),PCONKMED-PCONREC(R1) ADD MEDIA                           
*                                                                               
         B     IBUYDSCX            ALL DONE                                     
*                                                                               
*        SPACE DESCRIPTION COMES FROM BUY                                       
*                                                                               
IBUYDSC1 DS    0H                                                               
*                                                                               
         L      R4,AIO1                                                         
         USING  PBUYRECD,R4                                                     
*                                                                               
         LA    RF,L'PBYOSPC1-1     EXECUTE LENGTH OF SPACE DESCRIPTION          
         CR    RF,R3               DEFAULT TO SHORTER LENGTH                    
         BNH   *+6                                                              
         LR    RF,R3                                                            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PBYOSPC1    SPACE DESCRIPTION                            
*                                                                               
         CLI   GLARGS+1,C'N'       IF SPACE/NW                                  
         BNE   *+8                                                              
         CLI   PBUYKMED,C'N'       AND MEDIA IS NEWSPAPERS                      
         BE    IBUYDS12               NO SECOND HALF OF DESCRIPTION             
*                                                                               
         LA    RE,1(R3,R2)         POINT TO SECOND HALF                         
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),PBYOSPC2    PASS SECOND PART OF SPACE DESCRIP            
*                                                                               
IBUYDS12 DS    0H                                                               
*                                                                               
         CLI   PBUYKMED,C'N'       IF NOT NEWSPAPERS                            
         BE    IBUYDSC2                                                         
*                                                                               
         EX    R3,*+8                                                           
         B     *+10                                                             
         OC    0(0,R2),SPACES        MAKE DESCRIPTION UPPERCASE                 
*                                                                               
         B     IBUYDSC9                                                         
*                                                                               
IBUYDSC2 DS    0H                 ELSE PROCESSING NEWSPAPAERS                   
*                                                                               
         CLI   PBFLAVOR,C'O'       IF CONTRACT DRIVEN REPORT                    
         BE    *+8                                                              
         CLI   PBFLAVOR,C'C'                                                    
         B     IBUYDSC3                                                         
*                                                                               
*        NOBODY KNOWS WHY THIS CODE WAS EVER IN HERE                            
*                                                                               
****     BNE   IBUYDSC3                                                         
*                                                                               
         LA    RE,1(R3,R2)                                                      
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),SPACES         CLEAR SECOND HALF OF DESC                 
*                                                                               
         CLC   PBDSPACE,SPACES        IF  UNIQUE SPACE ENTERED IN BUY           
         BNE   IBUYDSC9                   GET OUT                               
*                                                                               
         EX    R3,*+8                 ELSE CLEAR FOR CONTRACT REPORTING         
         B     *+10                                                             
         MVC   0(0,R2),SPACES                                                   
*                                                                               
         MVI   0(R2),255              AND FORCE BLANKS TO BOTTOM                
*                                                                               
         B     IBUYDSC9                                                         
*                                                                               
IBUYDSC3 DS    0H                  NEWSPAPER - BUY DRIVEN                       
*                                                                               
         CLI   PBYOSPC,C' '        IF NO SPACE FROM BUY                         
         BH    *+10                                                             
         MVC   0(7,R2),PBYOUNTS       PRINT UNITS                               
*                                                                               
*        ADD PREMIUM CHARGE AFTER UNITS                                         
*                                                                               
         CLC   0(7,R2),SPACES      IF SPACE DESC FOUND                          
         BNH   IBUYDS31                                                         
*                                                                               
         CLI   GLARGS+1,C'N'          DONE IF SPACE/NW                          
         BE    IBUYDSCX                                                         
         B     IBUYDSC4               ELSE CONTINUE                             
*                                                                               
IBUYDS31 DS    0H                  NO SPACE DESC YET                            
*                                                                               
         LR    RF,R2               INIT POINTER                                 
*                                                                               
         CLC   PBYOPRM,SPACES      IF PREMIUM PRESENT                           
         BNH   *+14                                                             
         MVC   0(2,R2),PBYOPRM        PREMIUM IS NOT INDENTED                   
         LA    RF,3(R2)               NEXT AVAILABLE SPACE                      
*                                                                               
         CLI   GLARGS+1,C'N'       DONE IF SPACE/NW                             
         BE    IBUYDSCX                                                         
         B     IBUYDSC5                                                         
*                                                                               
IBUYDSC4 DS    0H                  FIND END OF UNIT DESCRIPTION                 
*                                                                               
         LA    RF,0(R3,R2)         ==> LAST BYTE OF 1ST LINE OF DSC             
*                                                                               
         CLI   0(RF),C' '                                                       
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*                                                                               
         LA    RF,2(RF)            START OF PREMIUM CHARGE                      
*                                                                               
         CLC   PBYOPRM,SPACES      IF PREMIUM PRESENT                           
         BNH   *+14                                                             
         MVC   0(2,RF),PBYOPRM        PASS PREMIUM CHARGE                       
         LA    RF,3(RF)               NEXT AVAILABLE SPACE                      
*                                                                               
IBUYDSC5 DS    0H                                                               
*                                                                               
         CLI   PBDCOSTY,C'U'            SKIP IF NO UNIT COST                    
         BNE   IBUYDSC7                                                         
*                                                                               
*        NEED TEN SPACES FOR UNIT COST                                          
*                                                                               
         LA    RE,0(RF)            START OF UNIT COST                           
*                                                                               
         LA    RF,7(R2)            NORMAL START OF UNIT COST                    
*                                                                               
         CR    RF,RE               USE NORMAL START IF POSSIBLE                 
         BNL   *+6                                                              
         LR    RF,RE               ELSE USE CALCULATED START                    
*                                                                               
         LA    R0,1(R3,R2)         END OF 1ST LINE OF SPACE                     
         SR    R0,RF               LENGTH OF REMAINING SPACE                    
*                                                                               
         CH    R0,=H'10'           CHECK IF ENOUGH SPACE AVAILABLE              
         BNL   IBUYDSC6              YES                                        
*                                                                               
         LA    RF,1(R3,R2)              IF NOT GO TO NEXT LINE                  
*                                                                               
         CLI   0(RF),C' '               IF IT IS USED GO TO THIRD LINE          
         BNH   IBUYDSC6                                                         
*                                                                               
         LA    RF,1(R3,RF)         THIS LINE NEVER USED                         
*                                                                               
IBUYDSC6 DS    0H                                                               
*                                                                               
         EDIT  (P5,PBDCOS),(9,(RF)),5,ALIGN=LEFT,DROP=3                         
*                                                                               
*           THIS EDIT WILL EDIT OUT TO A MAX OF NN.NNNNN                        
*                                                                               
         AR    RF,R0               ADD ON # OF CHS IN RESULT                    
*                                                                               
         CLI   0(RF),C' '          FIND REAL END OF EXPRESSION                  
         BH    *+8                                                              
         BCT   RF,*-8                                                           
*                                                                               
*        PRINT UNIT INDICATOR                                                   
*                                                                               
         MVI   1(RF),C'/'          SEPARAATOR                                   
         MVC   2(1,RF),PBDUIND     UNIT ID                                      
         OI    2(RF),X'40'         MAKE UPPERCASE                               
*                                                                               
IBUYDSC7 DS    0H                 LINES X COLS                                  
*                                                                               
         CLI   PBYOLBC,C' '        SKIP IF NOT LINES X COLS                     
         BNH   IBUYDSC9                                                         
*                                                                               
*        TRY TO MOVE WHAT'S IN SECOND LINE TO FIRST LINE OF DESC                
*                                                                               
         LA    R0,1(R3)            NUMBER OF BYTES IN FIRST LINE                
         LA    RF,0(R3,R2)         LAST BYTE OF FIRST PART OF SPACE             
*                                                                               
         CLI   0(RF),C' '          FIND END OF 1ST LINE DISPLAY                 
         BH    *+12                                                             
         BCTR  RF,0                                                             
         BCT   R0,*-10                                                          
         BCTR  RF,0                RECTIFYING THE COUNT IF ALL SPACES           
*                                                                               
         LA    RF,2(RF)            FIRST SPACE AVAILABLE                        
*                                                                               
         LA    RE,1(R3,R2)         FIND END OF SECOND PART OF                   
         LA    R0,1(R3)              SPACE DESCRIPTION                          
*                                                                               
         CLI   0(RE),C' '          END DELINEATED BY SPACE                      
         BE    *+12                                                             
         LA    RE,1(RE)                                                         
         BCT   R0,*-12                                                          
*                                                                               
         LA    R0,1(R3,R2)                                                      
         SR    RE,R0               LENGTH OF SECOND PART                        
         BZ    IBUYDSC8            NONE                                         
*                                                                               
         LA    R0,1(R3,R2)                                                      
         SR    R0,RF               SPACE AVAILABLE                              
*                                                                               
         CR    R0,RE               SECOND PART MUST FIT                         
         BL    IBUYDSC8                                                         
*                                                                               
         LA    R1,1(R3,R2)         START OF SECOND LINE                         
*                                                                               
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RF),0(R1)       MOVE SECOND PART TO END OF FIRST             
*                                                                               
IBUYDSC8 DS    0H                                                               
*                                                                               
         LA    R1,1(R3,R2)         START OF SECOND LINE                         
*                                                                               
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),SPACES      CLEAR SECOND LINE OF OUTPUT                  
*                                                                               
         LA    RF,L'PBYOLBC-1      EXECUTE LENGTH OF LINES X COLS               
         CR    RF,R3               DEFAULT TO SHORTER LENGTH                    
         BNH   *+6                                                              
         LR    RF,R3                                                            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),PBYOLBC     DISPLAY LINES X COLS                         
*                                                                               
IBUYDSC9 DS    0H                                                               
*                                                                               
         LA    R1,1(R3,R2)         FIND LAST BYTE OF DRIVER INPUT               
         LA    R1,1(R3,R1)                                                      
*                                                                               
         MVC   0(1,R1),PBUYKMED    ENSURE MEDIA IS PRESENT                      
*                                                                               
IBUYDSCX DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'2'       IF ONLY SECOND LINE WANTED                   
         BNE   IBUYDSCZ                                                         
*                                                                               
         LA    RE,1(R3,R2)            POINT TO SECOND LINE                      
*                                                                               
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(RE)          MOVE 2ND LINE TO FIRST                    
*                                                                               
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),SPACES         CLEAR SECOND LINE                         
*                                                                               
IBUYDSCZ DS    0H                                                               
*                                                                               
         GOTO1 =V(DOFLOW)          FLOWCHAR                                     
*                                                                               
IBUYDSXX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R5,R7                                                         
*                                                                               
         TITLE 'PROCESS SPACE DESCRIPTION ON OUPUT SIDE - OBUYDSC'              
***********************************************************************         
*                                                                     *         
*        BUY SPACE DESCRIPTION - OUTPUT                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OBUYDSC  NMOD1 0,**#OBDSC                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R1,GLADTENT         ESTABLISH OUTPUT DRIVER ENTRY                
         USING DROD,R1                                                          
*                                                                               
         SR    R6,R6                                                            
*                                                                               
         ICM   R6,1,DROLEN         GET OUTPUT AREA WIDTH                        
         BNZ   *+8                   SKIP IF THERE IS ONE                       
         ICM   R6,1,OBUYOLEN       USE SAVED LENGTH IF NONE GIVEN               
         BNZ   *+8                   IN CASE OF TOTALS PROBABLY                 
         LA    R6,17               DEFAULT TO 17 IF NOTHING FOUND               
*                                                                               
         CH    R6,=Y(L'PBYOSPC1)   MAX OUTPUT IS L'PBYOSPC1                     
         BNH   *+8                                                              
         LA    R6,L'PBYOSPC1                                                    
*                                                                               
         STC   R6,OBUYOLEN         SAVE OUTPUT AREA WIDTH                       
         BCTR  R6,0                DECREMENT FOR EXECUTE                        
*                                                                               
         CLI   GLARGS,C'N'    IF SPACE/NW ASKED FOR                             
         BNE   OBUYDSC0                                                         
*                                                                               
         ST    R3,PBT2PTR          ELSE SAVE PRINT POINTER FOR TOTALS           
*                                                                               
         LA    RF,1(R6,R2)        POINT TO MEDIA IN INPUT                       
         LA    RF,1(R6,RF)                                                      
*                                                                               
         CLI   0(RF),C'N'         AND SKIP IF  NEWSPAPER                        
         B     OBUYDSC0            OUTPUT FINE AT THIS POINT                    
*****    BE    OBUYDSC1                                                         
*                                                                               
OBUYDSC0 DS    0H                                                               
*                                                                               
         TM    PBQPOPT,PBQPOCUT    CHECK OUT CUT OPTION                         
         BO    OBUYDSC4            YES                                          
*                                                                               
         B     OBUYDSC5            NO                                           
*                                                                               
*        SPACE/NW PROCESSING FOR NEWSPAPERS                                     
*                                                                               
OBUYDSC1 DS    0H                                                               
*                                                                               
         LA    RF,CODEAREA         POINT TO GENERAL OUTPUT AREA                 
         MVC   CODEAREA,SPACES     INIT OUTPUT AREA                             
*                                                                               
         LR    RE,R2                                                            
         LA    R0,7                NEED TO COUNT UP TO 7TH POSITION             
         LA    R1,1(R6)            OUTPUT AREA LENGTH                           
*                                                                               
         CLI   0(R2),255           IF FIRST LINE OF DECRIPTION MISSING          
         BNE   *+8                                                              
         LA    RE,1(R6,RE)            USE SECOND LINE OF DESCRIPTION            
*                                                                               
OBUYDSCL DS    0H                                                               
*                                                                               
         CLI   0(RE),C' '          FIRST SPACE IN DESCRIPTION                   
         BNH   OBUYDSCX            MEANS END OF BUY DESCRIPTION                 
*                                                                               
         BCT   R0,*+12             ALSO SPECIAL CASE OF C'N'                    
         CLI   0(RE),C'N'            IN SEVENTH POSITION OF DESCRIPTION         
         BE    OBUYDSCX              MEANS END OF BUY DESCRIPTION               
*                                                                               
         MVC   0(1,RF),0(RE)       PRINT CHARACTER OF DESCRIPTION               
*                                                                               
OBUYDSCC DS    0H                                                               
*                                                                               
         LA    RF,1(RF)                                                         
         LA    RE,1(RE)                                                         
         BCT   R1,OBUYDSCL         COUNTS SPACE AVAILABLE                       
*                                                                               
         B     OBUYDSCX            OUTPUT AREA FULL                             
*        CUT OUTPUT TO 1 LINE I.E                                               
*        SQUEEZE ALL WE CAN OF DESCRIPTION ONTO ONE LINE                        
*                                                                               
OBUYDSC4 DS    0H                                                               
*                                                                               
         LA    RF,1(R6)            LENGTH OF 1 LINE OF DESCRIPTION              
         LR    RE,R2               START OF DESCRIPTION                         
*                                                                               
         CLI   0(R2),255           IF NO FIRST LINE AVAILABLE                   
         BNE   *+12                                                             
         LA    RE,1(R6,R2)            POINT TO SECOND LINE OF DESC              
         B     *+8                    AND SKIP MOVING 2 LINES                   
*                                                                               
         LA    RF,1(R6,RF)         ELSE LENGTH OF BOTH LINES OF DESC            
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   CODEAREA(0),0(R2)   MOVE DESCRIPTION TO OUTPUT                   
*                                                                               
         OC    CODEAREA,SPACES     SPACE FILL                                   
*                                                                               
         B     OBUYDSCX                                                         
*                                                                               
*        TOTAL OUTPUT SPACE DESCRIPTION                                         
*                                                                               
OBUYDSC5 DS    0H                                                               
*                                                                               
         CLI   0(R2),255           IF FIRST LINE DOESN'T EXIST                  
         BNE   *+8                                                              
         MVI   0(R2),C' '             REPLACE MARKER WITH SPACE                 
*                                                                               
         LR    R4,R3               KEEP TRACK OF WHERE TO PRNT                  
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),SPACES         INIT OUTPUT AREA                          
*                                                                               
         EX    R6,*+8              IF FIRST LINE NOT ALL SPACES                 
         B     *+10                                                             
         CLC   0(0,R2),SPACES                                                   
         BNH   *+22                                                             
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(R2)          MOVE TO OUTPUT                            
         LA    R4,198(R4)             AND BUMP TO NEXT OUTPUT LINE              
*                                                                               
         LA    RE,1(R6,R2)         BUMP TO SECOND LINE OF DESC                  
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),SPACES         INIT OUTPUT AREA                          
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         CLC   0(0,RE),SPACES      IF SECOND LINE NOT SPACES                    
         BNH   *+22                                                             
*                                                                               
         EX    R6,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(RE)          MOVE TO OUTPUT                            
         LA    R4,198(R4)             AND BUMP TO NEXT LINE                     
*                                                                               
         CLI   PBQSPCTL,C'C'       DONE IF NOT CONTRACT                         
         BNE   OBUYDSC9                                                         
*                                                                               
         LA    R1,1(R6,R2)         POINT TO MEDIA IN INPUT                      
         LA    R1,1(R6,R2)                                                      
*                                                                               
         CLI   34(R2),C'N'         DONE IF NOT NEWSPAPER                        
         BNE   OBUYDSC9                                                         
*                                                                               
         ST    R3,PBT2PTR          ELSE SAVE PRINT POINTER FOR TOTALS           
*                                                                               
         GOTO1 =A(COMMON1),DMCB,16,EBLOCK  HANDLE TOTALS                        
*                                                                               
OBUYDSC9 DS    0H                                                               
         CR    RB,RB               = CC                                         
         XIT1                                                                   
*                                                                               
OBUYDSCX DS    0H                                                               
         LTR   RB,RB               ^= CC (GO TO GENOUT)                         
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OBUYOLEN DC    X'00'               OUTPUT AREA WIDTH SAVEAREA                   
*                                                                               
         DROP  R1                                                               
*                                                                               
         TITLE 'CHANGES TO BUY RECORD - INPUT - ICHANGE'                        
***********************************************************************         
*                                                                     *         
*        CHANGES TO BUY - INPUT                                       *         
*                                                                     *         
*NTR     GLARGS+1  - C'P' - PRINT USER'S NAME                         *         
*                                                                     *         
*EXIT    R2==> XL4(DISK ADDRESS),XL1(SE NUMBER),CL2(SECURITY AGENCY)  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICHANGE  NMOD1 0,**#ICHG                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYRECD,R4         ESTABLISH RECORD                             
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ SKIP IF NOT A BUY RECORD                       
         BNE   ICHANGEX                                                         
*                                                                               
         B     ICHANGE5            SKIP TESTS                                   
*                                                                               
         LA    RF,PBDDATE          DEFAULT TO LAST CHANGE DATE                  
*                                                                               
         OC    PBDDATE,PBDDATE     IF NO CHANGES HAVE BEEN MADE                 
         BNZ   *+8                                                              
         LA    RF,PBDBUYDT            USE CREATION DATE                         
*                                                                               
         CLC   0(L'PBDDATE,RF),PBQCHGST SKIP IF DATE NOT IN PERIOD              
         BL    ICHANGEX                                                         
*                                                                               
         OC    PBQCHGEN,PBQCHGEN   CHECK AGAINST END DATE IF GIVEN              
         BZ    *+14                                                             
         CLC   PBDBUYDT,PBQCHGEN   SKIP IF BOUGHT AFTER PERIOD                  
         BH    ICHANGEX                                                         
*                                                                               
ICHANGE5 DS    0H                                                               
*                                                                               
         MVC   0(4,R2),PBABUY      DISK ADDRESS OF BUY REC                      
*                                                                               
         ICM   RF,15,PBUTLA        IF UTL ADDRESS SET                           
         BZ    *+10                                                             
         MVC   4(1,R2),4(RF)       PASS SE NUMBER                               
*                                                                               
*        GET SECURITY AGENCY ID                                                 
*                                                                               
ICHASAG  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'P'       SKIP IF NOT PRINTING NAME                    
         BNE   ICHASAGN                                                         
*                                                                               
         CLC   ICHAGY,PBAGY        DONE IF AGENCY UNCHANGED                     
         BE    ICHASAGX                                                         
*                                                                               
         MVC   ICHAGY,PBUYKAGY     SAVE CURRENT AGENCY                          
*******                                                                         
*******  L     RF,ACOMFACS                                                      
*******  USING COMFACSD,RF                                                      
*******  GOTO1 CGETFACT,DMCB,(2,0),0,0   GET FAFACTS AREA                       
*******                                                                         
*******  DROP  RF                                                               
*******                                                                         
*******  L     R1,0(R1)                                                         
*******  USING FACTSD,R1           ESTABLISH FAFACTS                            
*******                                                                         
*******  MVC   ICHSAGY,FATAGYSC    SAVE SECURITY AGENCY                         
*******                                                                         
*******  DROP  R1                                                               
*                                                                               
ICHASAGX DS    0H                                                               
*                                                                               
*****    MVC   5(2,R2),ICHSAGY     RETURN SECURITY AGENCY                       
         MVC   5(2,R2),PBQSECAG    RETURN SECURITY AGENCY                       
*                                                                               
ICHASAGN DS    0H                                                               
*                                                                               
ICHANGEX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4                                                               
*                                                                               
ICHAGY   DS    CL2                 CURRENT AGENCY                               
ICHSAGY  DS    CL2                 CURRENT SECURITY AGENCY                      
*                                                                               
         TITLE 'CHANGES TO BUY RECORD OUPUT - OCHANGE'                          
***********************************************************************         
*                                                                     *         
*        CHANGES TO BUY - OUTPUT                                      *         
*                                                                     *         
*NTRY    R2==> XL4(DISK ADDRESS),XL1(SE NUMBER)                       *         
*        GLARGS 1-4  - MASK FOR WHICH CHANGES REPORTED                *         
*                                                                     *         
*EXIT    R3==>  CHANGE DATE                                           *         
*                CHANGER IF GLARGS+4 = C'P'                           *         
*                 TYPE OF CHANGE                                      *         
*                 TYPE OF CHANGE                                      *         
*                 ........                                            *         
*               IF MORE THAN 20 LINES 20TH WILL HAVE **MORE**         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCHANGE  NMOD1 0,**#OCHG                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        READ BUY RECORD                                                        
*                                                                               
         XC    OCHGINDS,OCHGINDS   INIT WORKAREA                                
*                                                                               
         OC    0(4,R2),0(R2)       SKIP IF NO CHANGES TO PRINT                  
         BZ    OCHANGEX                                                         
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY+27(4),0(R2)     SET DISK ADDRESS                             
*                                                                               
         CLI   4(R2),0             SKIP IF NO SE NUMBER PASSED                  
         BE    OCHG1                                                            
*                                                                               
         L     R4,PBUTLA           POINT TO UTLA                                
         ZIC   R0,4(R4)            SAVE CURRENT SE NUMBER                       
         MVC   4(1,R4),4(R2)       CHANGE SE NUMBER FOR FILES                   
*                                                                               
OCHG1    DS    0H                                                               
*                                                                               
         MVC   AIO,AIO1           READ INTO I/O1                                
         OI    DMINBTS,8          PASS DELETED RECORDS                          
*                                                                               
         GOTO1 GETREC                                                           
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         CLI   4(R2),0             SKIP IF NO SE NUMBER PASSED                  
         BE    *+8                                                              
         STC   R0,4(R4)            RESET SE NUMBER                              
*                                                                               
*        FIND THE CHANGE ELEMENTS                                               
*          AND PRINT CHANGES IF WITHIN CHANGE PERIOD                            
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYRECD,R4         ESTABLISH RECORD                             
*                                                                               
         LA    R0,21               MAX 20 LINES OF OUTPUT                       
*                                                                               
*        PRINT 'NEW BUY' IF BOUGHT IN PERIOD                                    
*                                                                               
OCHGNEW  DS    0H                                                               
*                                                                               
         CLC   PBDBUYDT,PBQCHGST   SKIP IF BUY DATE NOT IN PERIOD               
         BL    OCHGNEWX                                                         
*                                                                               
         OC    PBQCHGEN,PBQCHGEN   CHECK AGAINST END DATE IF GIVEN              
         BZ    *+14                                                             
         CLC   PBDBUYDT,PBQCHGEN   SKIP IF BUY DATE NOT IN PERIOD               
         BH    OCHGNEWX                                                         
*                                                                               
         AHI   R0,-1               DECREMENT LINE COUNTER                       
         BNP   OCHGMORE            NO MORE ROOM                                 
*                                                                               
         GOTO1 DATCON,DMCB,(3,PBDBUYDT),(17,(R3))  PRINT DATE                   
*                                                                               
         LA    R3,198(R3)             BUMP TO NEXT PRINT LINE                   
*                                                                               
         CLI   GLARGS+5,C'P'       IF PRINTING FULL NAME OF CHANGER             
         BNE   OCHGNEW1                                                         
*                                                                               
         AHI   R0,-1                  DECREMENT LINE COUNTER                    
         BNP   OCHGMORE               NO MORE ROOM                              
*                                                                               
*        FIND PID ELEMENT                                                       
*                                                                               
         LA    R6,PBUYREC+33          POINT TO FIRST ELM IN BUY                 
         SR    RF,RF                                                            
*                                                                               
OCHGADLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0                CHECK FOR END OF RECORD                   
         BE    OCHGADDN                                                         
*                                                                               
         CLI   0(R6),PPIDELQ          FIND PID ELEMENT                          
         BE    OCHGADFD                                                         
*                                                                               
OCHGADCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     OCHGADLP                                                         
*                                                                               
OCHGADDN DS    0H                                                               
*                                                                               
         SR    R6,R6                  ELEMENT NOT FOUND                         
*                                                                               
OCHGADFD DS    0H                                                               
*                                                                               
         BRAS  RE,TRNPID              PRINT BUYER'S NAME                        
*                                                                               
         LA    R3,198(R3)             BUMP TO NEXT PRINT LINE                   
*                                                                               
OCHGNEW1 DS    0H                                                               
*                                                                               
         AHI   R0,-1                  DECREMENT LINE COUNTER                    
         BNP   OCHGMORE               NO MORE ROOM                              
*                                                                               
         MVC   2(7,R3),=C'NEW BUY' SHOW IT WAS ADDED TO SYSTEM                  
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT LINE                            
*                                                                               
OCHGNEWX DS    0H                  MORE CHANGES EXIST                           
*                                                                               
         LA    R6,PBUYKEY+33       POINT TO FIRST ELEMENT IN BUY                
*                                                                               
OCHGLP   DS    0H                                                               
*                                                                               
         USING PCHGELD,R6          ESTABLISH CHANGE ELEMENT                     
*                                                                               
         CLI   PCHGELEM,0          DONE IF END OF RECORD FOUND                  
         BE    OCHGLPDN                                                         
*                                                                               
         CLI   PCHGELEM,PCHGELQ    LOOK FOR A CHANGE ELEMENT                    
         BNE   OCHGLPCN                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(2,PCHGDAT),(3,OCHGDATE) CONVERT TO BINARY           
*                                                                               
         CLC   OCHGDATE,PBQCHGST   SKIP IF CHANGE NOT IN PERIOD                 
         BL    OCHGLPCN                                                         
*                                                                               
         OC    PBQCHGEN,PBQCHGEN   CHECK AGAINST END DATE IF GIVEN              
         BZ    *+14                                                             
         CLC   OCHGDATE,PBQCHGEN   SKIP IF CHANGE NOT IN PERIOD                 
         BH    OCHGLPCN                                                         
*                                                                               
         CLC   OCHGDATE,PBDBUYDT   IF ELEMENT FOR BUY DATE                      
         BNE   OCHGLP25                                                         
*                                                                               
         TM    PCHGIND3,X'04'      AND TEST BUY MADE LIVE                       
         BNO   OCHGLP25                                                         
*                                                                               
         AHI   R3,-2*198           BACK UP 2 LINES TO ERASE                     
         AHI   R0,2                   NEW BUY MESSAGE                           
*                                                                               
         CLI   GLARGS+5,C'P'       IF PRINTING FULL NAME OF CHANGER             
         BNE   *+12                                                             
         AHI   R3,-198                BACK UP ANOTHER LINE                      
         SHI   R0,1                                                             
*                                                                               
OCHGLP25 DS    0H                                                               
*                                                                               
         AHI   R0,-1               TEST IF THERE IS ROOM TO PRINT               
         BNP   OCHGMORE            MORE THAN 20 LINES TO PRINT                  
*                                                                               
         MVC   OCHGINDS(3),PCHGIND1     COPY INDICATOR                          
         MVC   OCHGINDS+3(1),PCHGIND4                                           
*                                                                               
         SR    RF,RF               IND5 IS LAST BYTE OF ELEMENT                 
         IC    RF,PCHGLEN                                                       
         BCTR  RF,0                                                             
         LA    RF,PCHGELEM(RF)                                                  
         MVC   OCHGINDS+4(1),0(RF)                                              
*                                                                               
         NC    OCHGINDS,GLARGS     CLEAR UNWANTED INDICATORS                    
         BZ    OCHGLPCN            NOTHING OF INTEREST CHANGED                  
*                                                                               
         TM    PBQBCHOP,PBQBCHNG   IF CHANGE FILTER IS NEGATIVE                 
         BNO   OCHGLP26                                                         
*                                                                               
         MVC   WORK(8),=8X'FF'     INIT WORKAREA                                
         XC    WORK(8),PBQBCHGS    KILL UNWANTED CHANGES                        
         NC    OCHGINDS,WORK       CLEAR UNWANTED CHGS FROM OPTIONS             
         BZ    OCHGLPCN                                                         
*                                                                               
OCHGLP26 DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(3,OCHGDATE),(17,(R3))  PRINT DATE                   
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT PRINT LINE                      
*                                                                               
         CLI   GLARGS+5,C'P'       IF PRINTING FULL NAME OF CHANGER             
         BNE   OCHGLP27                                                         
*                                                                               
         AHI   R0,-1                  TEST IF THERE IS ROOM TO PRINT            
         BNP   OCHGMORE               MORE THAN 20 LINES TO PRINT               
*                                                                               
         BRAS  RE,TRNPID              TRANSLATE PID AND PRINT                   
         LA    R3,198(R3)             BUMP TO NEXT PRINT LINE                   
*                                                                               
OCHGLP27 DS    0H                                                               
*                                                                               
*        TRANSLATE CHANGE BITS TO ENGLISH AND PRINT                             
*                                                                               
         ICM   RF,15,OCHGINDS      GET INDICATORS - 4 BYTES                     
         LA    R5,OCHGTAB          POINT TO TRANSLATION TABLE                   
*                                                                               
OCHGTRLP DS    0H                                                               
*                                                                               
         LTR   RF,RF               TEST IF HIGH ORDER BIT ON                    
         BP    OCHGTRCN            HIGH ORDER BIT NOT ON                        
         BZ    OCHGTRDN            NO MORE BITS ON                              
*                                  BIT ON - PRINT TRANSLATION                   
         AHI   R0,-1               DECREMENT LINE COUNTER                       
         BNP   OCHGMORE            NO MORE ROOM                                 
*                                                                               
         MVC   2(OCHGTABL,R3),0(R5)   WHAT BIT MEANS                            
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT LINE                            
*                                                                               
OCHGTRCN DS    0H                                                               
*                                                                               
         LA    R5,OCHGTABL(R5)     BUMP TO NEXT TABLE ENTRY                     
         SLL   RF,1                SHIFT NEXT BIT TO HIGH ORDER POS             
         B     OCHGTRLP                                                         
*                                                                               
OCHGTRDN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,8,OCHGINDS+4     GET 5TH INDICATOR                            
         LA    R5,OCHGTAB1         TRANSLATIONS FOR 2ND SET OF INDS             
*                                                                               
OCHGTR2L DS    0H                                                               
*                                                                               
         LTR   RF,RF               TEST IF HIGH ORDER BIT ON                    
         BP    OCHGTR2C            HIGH ORDER BIT NOT ON                        
         BZ    OCHGTR2D            NO MORE BITS ON                              
*                                  BIT ON - PRINT TRANSLATION                   
         AHI   R0,-1               DECREMENT LINE COUNTER                       
         BNP   OCHGMORE            NO MORE ROOM                                 
*                                                                               
         MVC   2(OCHGTABL,R3),0(R5)   WHAT BIT MEANS                            
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT LINE                            
*                                                                               
OCHGTR2C DS    0H                                                               
*                                                                               
         LA    R5,OCHGTABL(R5)     BUMP TO NEXT TABLE ENTRY                     
         SLL   RF,1                SHIFT NEXT BIT TO HIGH ORDER POS             
         B     OCHGTR2L                                                         
*                                                                               
OCHGTR2D DS    0H                                                               
*                                                                               
OCHGLPCN DS    0H                                                               
*                                                                               
         CLI   PCHGELEM,PCHGELQ    SAVE LAST CHANGE ELEMENT'S ADDRESS           
         BNE   *+8                                                              
         ST    R6,OCHGADDR         SAVE LAST ELEMENT'S ADDRESS                  
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PCHGLEN          ELEMENT LENGTH                               
         LA    R6,PCHGELD(RF)      BUMP TO NEXT ELEMENT                         
*                                                                               
         B     OCHGLP                                                           
*                                                                               
OCHGLPDN DS    0H                  END OF CHANGE ELEMENTS                       
*                                                                               
*        LASTLY REPORT DELETED DATE IF NEEDED                                   
*                                                                               
         TM    PBUYCNTL,X'80'      IF DELETED                      L22          
         BNO   OCHGDELX                                                         
*                                                                               
         CLC   PBDDATE,PBQCHGST    SKIP IF LAST CHANGE NOT IN PERIOD            
         BL    OCHGDELX                                                         
*                                                                               
         OC    PBQCHGEN,PBQCHGEN   CHECK AGAINST END DATE IF GIVEN              
         BZ    *+14                                                             
         CLC   PBDDATE,PBQCHGEN    SKIP IF CHANGE NOT IN PERIOD                 
         BH    OCHGDELX                                                         
*                                                                               
         AHI   R0,-1               DECREMENT LINE COUNTER                       
         BNP   OCHGMORE            NO MORE ROOM                                 
*                                                                               
         GOTO1 DATCON,DMCB,(3,PBDDATE),(17,(R3))  PRINT DATE                    
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT PRINT LINE                      
*                                                                               
         CLI   GLARGS+5,C'P'       IF PRINTING FULL NAME OF DELETER             
         BNE   OCHGDEL1                                                         
*                                                                               
         AHI   R0,-1                  TEST IF THERE IS ROOM TO PRINT            
         BNP   OCHGMORE               MORE THAN 20 LINES TO PRINT               
*                                                                               
*        FIND PID ELEMENT                                                       
*                                                                               
         LA    R6,PBUYREC+33          POINT TO FIRST ELM IN BUY                 
         SR    RF,RF                                                            
*                                                                               
OCHGDLLP DS    0H                                                               
*                                                                               
         CLI   0(R6),0                CHECK FOR END OF RECORD                   
         BE    OCHGDLDN                                                         
*                                                                               
         CLI   0(R6),PPIDELQ          FIND PID ELEMENT                          
         BE    OCHGDLFD                                                         
*                                                                               
OCHGDLCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     OCHGDLLP                                                         
*                                                                               
OCHGDLDN DS    0H                                                               
*                                                                               
         SR    R6,R6                  ELEMENT NOT FOUND                         
*                                                                               
OCHGDLFD DS    0H                                                               
*                                                                               
         LTR   R6,R6                  IF PID ELEMENT FOUND                      
         BZ    *+8                                                              
         MVI   0(R6),X'FF'               CONVERT ELEMENT CODE TO X'FF'          
*                                                                               
         BRAS  RE,TRNPID              TRANSLATE PID AND PRINT                   
*                                                                               
         LTR   R6,R6                  IF PID ELEMENT FOUND                      
         BZ    *+8                                                              
         MVI   0(R6),PPIDELQ             RESTORE ELEMENT CODE                   
*                                                                               
         LA    R3,198(R3)             BUMP TO NEXT PRINT LINE                   
*                                                                               
OCHGDEL1 DS    0H                                                               
*                                                                               
         AHI   R0,-1               DECREMENT LINE COUNTER                       
         BNP   OCHGMORE            NO MORE ROOM                                 
*                                                                               
         MVC   2(7,R3),=C'DELETED' SHOW IT WAS DELETED                          
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT LINE                            
*                                                                               
OCHGDELX DS    0H                                                               
*                                                                               
         B     OCHANGEX                                                         
*                                                                               
OCHGMORE DS    0H                  MORE CHANGES EXIST                           
*                                                                               
         AHI   R3,-198             BACK UP TO LAST LINE PRINTED                 
         MVC   0(20,R3),=CL20'  **MORE**' MORE MESSAGE                          
*                                                                               
OCHANGEX DS    0H                                                               
         XIT1                                                                   
*                                                                               
OCHGADDR DS    A                   CHANGE ELEMENT ADDRESS SAVEAREA              
*                                                                               
OCHGTAB  DS    0X                  TABLE OF CHANGE TYPES                        
         DC    CL10'ALLOCATION'                                                 
OCHGTABL EQU   *-OCHGTAB           LENGTH OF TABLE ENTRY                        
         DC    CL10'RATE'                                                       
         DC    CL10'UNITS'                                                      
         DC    CL10'DESCRIP.'                                                   
         DC    CL10'INSERT DTE'                                                 
         DC    CL10'PREMIUM'                                                    
         DC    CL10'COMMENT'                                                    
         DC    CL10'IO COMMENT'                                                 
         DC    CL10'CLOSE DATE'                                                 
         DC    CL10'SALE DATE'                                                  
         DC    CL10'BILLBLE DT'                                                 
         DC    CL10'PAYABLE DT'                                                 
         DC    CL10'JOB #'                                                      
         DC    CL10'AGY COMM'                                                   
         DC    CL10'CASH DSC'                                                   
         DC    CL10'IO DATE'                                                    
         DC    CL10'2ND INS DT'                                                 
         DC    CL10'JOB # ADD '                                                 
         DC    CL10'SPEC. REP '                                                 
         DC    CL10'PLANNED $ '                                                 
         DC    CL10'TAX       '                                                 
         DC    CL10'MADE LIVE '                                                 
         DC    CL10'MAT CLOSE '                                                 
         DC    CL10'POS INST  '                                                 
         DC    CL10'SFH STATUS'                                                 
         DC    CL10'COST2 FCTR'                                                 
         DC    CL10'IMPS      '                                                 
         DC    CL10'ADDL CHGS '                                                 
         DC    CL10'LEGAL WARN'                                                 
         DC    CL10'SRC COMMS '                                                 
         DC    CL10'EIO ISSUED'                                                 
         DC    CL10'          '                                                 
OCHGTAB1 DC    CL10'ESR ISSUED'                                                 
         DC    CL10'TS STATUS '                                                 
         DC    CL10'PO# CHANGE'                                                 
         DC    CL10'INV REQ''D '                                                
         DC    CL10'INV RECV''D'                                                
         DC    CL10'FX RATE   '                                                 
         DC    CL10'TRKD COL  '                                                 
         DC    CL10'          '                                                 
OCHGTABX EQU   *-1                 END OF TABLE                                 
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OCHGINDS DS    XL5                 CHANGE INDICATORS                            
OCHGDATE DS    XL3                 BINARY CHANGE DATE                           
*                                                                               
         TITLE 'CHANGES TO BUY RECORD OUTPUT - TRNPID'                          
***********************************************************************         
*                                                                     *         
*        ROUTINE TO GET PERSONS NAME FROM THEIR PID                   *         
*                                                                     *         
*NTRY    R2 ==> XL4(DISK ADDRESS),XL1(SE NUMBER),CL2(SECURITY AGENCY) *         
*        R4 ==> PBUYREC                                               *         
*        R6 ==> ELEMENT                                               *         
*                                                                     *         
*EXIT    R3 ==> NAME SQUASHED                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
TRNPID   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBUYRECD,R4         ESTABLISH BUY RECORD                         
         USING PCHGELD,R6          ESTABLISH CHANGE ELEMENT                     
*                                                                               
*        HANDLE CHANGE ELEMENT                                                  
*                                                                               
         LTR   R6,R6               NO PID IF NO ELEMENT                         
         BZ    TPIDNOTF                                                         
*                                                                               
         CLI   PCHGELEM,PCHGELQ    SKIP IF NOT CHANGE ELEMENT                   
         BNE   TPIDCHGN                                                         
*                                                                               
*        PID LOCATION DEPENDS ON LENGTH OF ELEMENT                              
*                                                                               
         CLI   PCHGLEN,PCHGOLDS    IF STANDARD LENGTH                           
         BE    TPIDNOTF               THERE IS NO PID                           
*                                                                               
         CLI   PCHGLEN,PCHGOLDL    IF STANDARD LENGTH WITH RATES                
         BE    TPIDNOTF               THERE IS NO PID                           
*                                                                               
         LA    R5,PCHGELEM+PCHGOLDS   ASSUME PID AFTER STANDARD FIELDS          
*                                                                               
         CLI   PCHGLEN,PCHGNEWS    COMPARE TO LENGTH OF ELM WITH CASH           
         BL    TPIDNOTF               LESS  - THERE IS NO PID                   
         BE    *+8                    EQUAL - OK - PID AFTER STD FLDS           
         LA    R5,PCHGELEM+PCHGOLDL   MORE  - PID IS AFTER CASH FIELDS          
*                                                                               
TPIDCHGX DS    0H                                                               
         B     TPIDGET                                                          
*                                                                               
TPIDCHGN DS    0H                                                               
*                                                                               
         CLI   0(R6),PPIDELQ       CHECK FOR PID ELEMENT                        
         BNE   TPIDPIDN                                                         
*                                                                               
         USING PPIDELD,R6          ESTABLISH PID ELEMENT                        
*                                                                               
         LA    R5,PPIDPID          POINT TO PID OF CREATOR                      
*                                                                               
         B     TPIDGET                                                          
*                                                                               
TPIDPIDN DS    0H                                                               
*                                                                               
         CLI   0(R6),X'FF'         CHECK FOR DELETER'S PID                      
         BNE   TPIDDELN                                                         
*                                                                               
         CLI   PPIDELL,(PPIDDEL-PPIDELM) CHECK IF PID PRESENT                   
         BNH   TPIDNOTF                                                         
*                                                                               
         USING PPIDELD,R6          ESTABLISH PID ELEMENT                        
*                                                                               
         LA    R5,PPIDDEL          POINT TO DELETER'S PID                       
*                                                                               
         B     TPIDGET                                                          
*                                                                               
TPIDDELN DS    0H                                                               
*                                                                               
         B     TPIDNOTF            UNKNOWN PID TYPE                             
*                                                                               
*        R5 ==> PID - FIND CTFILE RECORD                                        
*                                                                               
TPIDGET  DS    0H                                                               
*                                                                               
         OC    0(2,R5),0(R5)       SKIP IF NO PID FOUND                         
         BZ    TPIDNOTF                                                         
*                                                                               
*        READ PERSON AUTH REC ON CTFILE                                         
*                                                                               
         LA    R7,KEY                                                           
         USING CT0REC,R7           ESTABLISH KEY AS PERSON AUTH REC             
         XC    CT0KEY,CT0KEY       INIT KEY                                     
*                                                                               
         MVI   CT0KTYP,CT0KTEQU    SET RECORD TYPE                              
         MVC   CT0KAGY,5(R2)       SET SECURITY AGENCY                          
*                                                                               
         CLC   CT0KAGY,=CL2' '     IF SECURITY AGENCY NOT PRESENT               
         BH    *+10                                                             
         MVC   CT0KAGY,PBUYKAGY       USE BUYREC'S AGENCY                       
*                                                                               
         MVC   CT0KNUM,0(R5)       SET PID                                      
*                                                                               
         MVC   FILENAME,=CL8'CTFILE'    SET FILENAME                            
         MVC   AIO,AIO2                 READ RECORD INTO IOA2                   
         MVI   USEIO,C'Y'               READ INTO I/O AREA                      
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         XC    FILENAME,FILENAME   RESET FILE NAME                              
         MVI   USEIO,0             RESET SWITCH                                 
*                                                                               
         L     R7,AIO              POINT TO FOUND RECORD                        
*                                                                               
         CLC   CT0KEY,KEYSAVE      SKIP IF RECORD NOT FOUND                     
         BNE   TPIDNOTF                                                         
*                                                                               
*        FIND USER'S ID                                                         
*                                                                               
*        FIND PERSON'S ID ELEMENT                                               
*                                                                               
         LA    RE,CT0DATA          POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
TPIDCTLP DS    0H                                                               
*                                                                               
         CLI   0(RE),0             CHECK FOR END OF RECORD                      
         BE    TPIDCTDN                                                         
*                                                                               
         CLI   0(RE),X'C3'         - MATCH ON ELEMENT CODE                      
         BE    TPIDCTFD                                                         
*                                                                               
TPIDCTCN DS    0H                                                               
*                                                                               
         IC    RF,1(RE)            GET ELEMENT LENGTH                           
         AR    RE,RF               BUMP TO NEXT ELEMENT                         
         B     TPIDCTLP            GO FIND NEXT ELEMENT                         
*                                                                               
TPIDCTDN DS    0H                  NO PERSON ID FOUND                           
*                                                                               
         B     TPIDNOTF                                                         
*                                                                               
TPIDCTFD DS    0H                                                               
*                                                                               
*        FIND PERSON RECORD                                                     
*                                                                               
         LA    R7,KEY                                                           
         USING SAPEREC,R7          ESTABLISH KEY AS PERSON REC KEY              
         XC    SAPEKEY,SAPEKEY     INIT KEY                                     
*                                                                               
         MVI   SAPETYP,SAPETYPQ    SET RECORD TYPE                              
         MVI   SAPESUB,SAPESUBQ    SET RECORD SUB TYPE                          
*                                                                               
         MVC   SAPEAGY,5(R2)       SET SECURITY AGENCY                          
*                                                                               
         CLC   SAPEAGY,=CL2' '     IF SECURITY AGENCY NOT PRESENT               
         BH    *+10                                                             
         MVC   SAPEAGY,PBUYKAGY       USE BUYREC'S AGENCY                       
*                                                                               
         MVC   SAPEPID,2(RE)       SET USERID FROM PREVIOUS RECORD              
*                                                                               
         MVC   FILENAME,=CL8'CTFILE'    SET FILENAME                            
         MVC   AIO,AIO2                 READ RECORD INTO IOA2                   
         MVI   USEIO,C'Y'               READ INTO I/O AREA                      
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         XC    FILENAME,FILENAME   RESET FILE NAME                              
         MVI   USEIO,0             RESET SWITCH                                 
*                                                                               
         L     R7,AIO2             POINT TO FOUND RECORD                        
*                                                                               
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),KEYSAVE SKIP IF REC NOT FOUND           
         BNE   TPIDNOTF                                                         
*                                                                               
         LA    RE,SAPEDATA         POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
*        FIND NAME ELEMENT                                                      
*                                                                               
TPIDNMLP DS    0H                                                               
*                                                                               
         CLI   0(RE),0             CHECK FOR END OF RECORD                      
         BE    TPIDNMDN                                                         
*                                                                               
         USING SANAMD,RE           ESTABLISH AS NAME ELEMENT                    
*                                                                               
         CLI   SANAMEL,SANAMELQ    LOOKING FOR NAME ELEMENT                     
         BE    TPIDNMFD                                                         
*                                                                               
TPIDNMCN DS    0H                                                               
*                                                                               
         IC    RF,SANAMLN          GET ELEMENT LENGTH                           
         AR    RE,RF               BUMP TO NEXT ELEMENT                         
         B     TPIDNMLP            GO PROCESS NEXT ELEMENT                      
*                                                                               
TPIDNMDN DS    0H                  NAME ELEMENOT FOUND                          
*                                                                               
         B     TPIDNOTF                                                         
*                                                                               
TPIDNMFD DS    0H                                                               
*                                                                               
         SR    R0,R0               GET ELEMENT LENGTH                           
         IC    R0,SANAMLN                                                       
         AHI   R0,-SANAMLNQ        DECRMENT BY FIXED LENGTH                     
         BNP   TPIDNOTF            NO NAME IN ELEMENT                           
*                                                                               
         LA    RE,SANAMES          POINT TO START OF PERSON'S NAME              
         SR    RF,RF                                                            
         LR    R1,R3               COPY START OF OUTPUT                         
*                                                                               
TPIDFMLP DS    0H                  FORMAT PERSON'S NAME                         
*                                                                               
         USING SANAMES,RE          ESTABLISH NAMES SECTION                      
*                                                                               
         IC    RF,SANAMELN         GET LENGTH OF THIS PART OF NAME              
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),SANAME      MOVE OUT PART OF NAME                        
*                                                                               
         LA    R1,1(RF,R1)         BUMP TO NEXT OUTPUT AREA                     
*                                                                               
TPIDFMCN DS    0H                                                               
*                                                                               
         SR    R0,RF               DECREMENT REMAINING ELEMENT LENGTH           
         AHI   R0,-2               FOR NAME LENGTH BYTE & EX LENGTH             
         BNP   TPIDFMDN              END OF ELEMENT REACHED                     
*                                                                               
         LA    RE,2(RF,RE)         POINT TO NEXT PART OF NAME                   
         LA    R1,1(R1)            ADD IN A SPACING CHARACTER                   
*                                                                               
         B     TPIDFMLP                                                         
*                                                                               
TPIDFMDN DS    0H                                                               
*                                                                               
         B     TPIDSQSH                                                         
*                                                                               
TPIDNOTF DS    0H                  PRINT 'UNKNOWN' IF NO PID                    
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYRECD,R4         ESTABLISH RECORD                             
*                                                                               
         MVC   0(3,R3),PBDBUYER    USE BUYER'S INITIALS                         
         LA    R1,03(R3)           POINT TO NEXT OUTPUT POSITION                
*                                                                               
TPIDSQSH DS    0H                                                               
*                                                                               
         LR    R0,R1               END OF OUTPUT MINUS START                    
         SR    R0,R3               EQUALS OUTPUT LENGTH                         
*                                                                               
         GOTO1 SQUASHER,DMCB,0(R3),(R0) SQUASH NAME                             
*                                                                               
TRNPIDX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R6,R7,RE                                                      
*                                                                               
         TITLE 'PRWRITER - CLIENT CODE AND/OR NAME - ICLICODE'                  
***********************************************************************         
*                                                                     *         
*        CLIENT CODE AND/OR NAME (ALSO HAS CODE FOR MASTER CLIENT)    *         
*                                                                     *         
*        DRIVER INPUT IS XL1 TOTAL LENGTH                             *         
*                        CL? CLIENT NAME ?=DRILEN-4-1                 *         
*                        CL3 CLIENT CODE                              *         
*                        CL1 MED    CODE                              *         
*        IF DRINLEN SET TO 4 THEN ONLY CODE IN DRIVER INPUT.          *         
*                                                                     *         
*        CHANGE LOG                                                   *         
*                                                                     *         
*MAR/04  BOBY  ADDED MEDIA CODE TO END OF INPUT IF NAME INCLUDED      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICLICODE NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC             ESTABLISH WORKING STORAGE                    
*                                                                               
         L     R1,GLADTENT         ESTABLISH INPUT DRIVER ENTRY                 
         USING DRIND,R1                                                         
*                                                                               
         ZIC   R3,DRINLEN          GET INPUT LENGTH                             
*                                                                               
ICLIMCL  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'M'       SKIP IF NOT MASTER CLIENT                    
         BE    *+8                                                              
         CLI   GLARGS+3,C'M'       SKIP IF NOT MASTER CLIENT                    
         BNE   ICLIMCLN                                                         
*                                                                               
         LA    R4,PBQCLT           POINT TO CLIENT CODE                         
         LA    R5,PBCLTNM          POINT TO CLIENT NAME                         
*                                                                               
         ICM   RF,15,PBCLTADR      SKIP IF CLIENT RECORD NOT AVAILABLE          
         BZ    ICLIMCLX                                                         
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   *+14                                                             
         ICM   RF,15,PAORCLTA         USE AOR CLIENT IF KNOWN                   
         BNZ   *+6                                                              
         DC    H'0'                       MUST FIND ADDRESS                     
*                                                                               
         USING PCLTRECD,RF         ESTABLISH CLIENT RECORD                      
*                                                                               
         LA    R4,PCLTKCLT         POINT TO CLIENT CODE                         
         LA    R5,PCLTNAME         POINT TO CLIENT NAME                         
*                                                                               
         CLI   PCLTPROF+5,C'2'     IF SLAVE CLIENT                              
         BNE   ICLIMCLX                                                         
*                                                                               
         LA    R4,PCLTPROF+6          USE MASTER CODE (NAME NOT NEEDED)         
*                                                                               
ICLIMCLX DS    0H                                                               
*                                                                               
         B     ICLICOD1                                                         
*                                                                               
ICLIMCLN DS    0H                                                               
*                                                                               
*        CLI   PBQSLAVE,C'Y'       SKIP IF NOT SLAVE CLIENT                     
*        BNE   ICLISLVN                                                         
*                                                                               
         ICM   RF,15,PBCLTADR      SKIP IF CLIENT RECORD NOT AVAILABLE          
         BZ    ICLISLVN                                                         
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BNE   ICLICL1                                                          
*                                                                               
         OC    PBQQCLT,PBQQCLT     AND NOT (SINGLE CLIENT                       
         BZ    *+10                                                             
         OC    PBQQAGY,PBQQAGY         FOR SINGLE AGENCY)                       
         BNZ   ICLICL1                                                          
*                                                                               
         ICM   RF,15,PAORCLTA         USE AOR CLIENT IF KNOWN                   
         BNZ   *+6                                                              
         DC    H'0'                       MUST FIND ADDRESS                     
*                                                                               
ICLICL1  DS    0H                                                               
*                                                                               
         USING PCLTRECD,RF         ESTABLISH CLIENT RECORD                      
*                                                                               
         LA    R4,PCLTKCLT         POINT TO CLIENT CODE                         
         LA    R5,PCLTNAME         POINT TO CLIENT NAME                         
*                                                                               
         B     ICLICOD1                                                         
*                                                                               
ICLISLVN DS    0H                                                               
*                                                                               
         LA    R4,PBCLT            POINT TO CLIENT CODE                         
         LA    R5,PBCLTNM          POINT TO CLIENT NAME                         
*                                                                               
ICLICOD1 DS    0H                                                               
*                                                                               
         CLC   0(3,R4),SPACES      SKIP IF NO CLIENT AVAILABLE                  
         BNH   ICLICODX                                                         
*                                                                               
         STC   R3,0(R2)            FILL IN DRIVER INPUT LENGTH                  
         LA    R2,1(R2)            BUMP POINTER                                 
         BCTR  R3,0                LENGTH AVAILABLE FOR DATA                    
*                                                                               
         SH    R3,=H'4'            LENGTH FOR CLIENT NAME                       
         BNP   ICLICOD3            NO ROOM FOR NAME                             
*                                                                               
         CLI   GLARGS+2,C'N'       SKIP UNLESS SORTING ON NAME                  
         BNE   ICLICOD2                                                         
*                                                                               
         BCTR  R3,0                DECREMENT FOR EXECUTE                        
         EX    R3,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(R5)       FILL IN CLIENT NAME                          
         LA    R3,1(R3)            RESTORE NAME LENGTH                          
*                                                                               
ICLICOD2 DS    0H                                                               
*                                                                               
         LA    R2,0(R3,R2)         START OF CLIENT CODE AREA                    
*                                                                               
*        SKIP IF MEDIA TO BE KEPT OUT OF KYWD SORT                              
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFNMD)),0                
*                                                                               
         OC    8(4,R1),8(R1)       SKIP IF FILTER FOUND                         
         BNZ   ICLINAMX                                                         
*                                                                               
         MVC   3(1,R2),PBMED          PASS ON MEDIA CODE                        
*                                                                               
         CLI   PBQMED,C'C'         IF REQUEST FOR MEDIA 'C'                     
         BNE   *+8                                                              
         MVI   3(R2),C'C'             SET MEDIA TO 'C'                          
*                                                                               
ICLINAMX DS    0H                                                               
*                                                                               
ICLICOD3 DS    0H                                                               
*                                                                               
         MVC   0(3,R2),0(R4)          FILL IN CLIENT CODE                       
*                                                                               
ICLICODX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DROP  R1,RF                                                            
*                                                                               
         TITLE 'PRWRITER - CLIENT INTERFACE CODE - INPUT - ICLINCOD'            
***********************************************************************         
*                                                                     *         
*                    CLIENT INTERFACE CODE                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICLINCOD NMOD1 0,**#ICCOD                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         USING PCLTRECD,RF         ESTABLISH CLIENT HEADER                      
*                                                                               
         ICM   RF,15,PBCLTADR      IF NO CLIENT HEADER IS AVAILABLE             
         BZ    *+10                                                             
         OC    PCLTNUM(3),PCLTNUM  OR THERE IS NO NUMBER                        
         BNZ   *+12                                                             
         MVI   0(R2),255              FORCE TO SORT LAST                        
         B     ICLINCDX                                                         
*                                                                               
         CLI   PCLTNUM,255         JWT                                          
         BE    ICLIJWT                                                          
*                                                                               
         MVC   DUB(1),PCLTNUM      COPY FIRST BYTE OF CODE                      
         NI    DUB,X'F0'           CLEAR RIGHT NIBBLE                           
*                                                                               
         CLI   DUB,X'80'           IF WE HAVE X'80' PATTERN LEFT                
         BE    ICLINBIN                                                         
*                                                                               
         MVC   0(3,R2),PCLTNUM        NUMBER IS CHARACTER                       
*                                                                               
         B     ICLINCDX                                                         
*                                                                               
ICLIJWT  MVC   DUB(2),PCLTNUM+1   INTERFACE CODE                                
         UNPK  0(5,R2),DUB(3)                                                   
         MVI   4(R2),0                                                          
         B     ICLINCDX                                                         
*                                                                               
ICLINBIN DS    0H                  NUMBER IS IN BINARY                          
*                                                                               
         MVC   DUB(3),PCLTNUM      MOVE TO WORKAREA                             
         XI    DUB,X'80'           TURN OFF BIT                                 
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,7,DUB            GET BINARY FORM                              
         CVD   RF,DUB              CVD                                          
*                                                                               
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  0(5,R2),DUB+5(3)    DISPLAY NUMBER                               
*                                                                               
ICLINCDX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - CLIENT HEADER FIELDS - ICLI'                         
***********************************************************************         
*                                                                     *         
*                    CLIENT HEADER FIELDS                             *         
*                                                                     *         
*NTRY    GLARGS+0    C'H' - HEADER RECORD                             *         
*        GLARGS+1    C'2' - CLIENT HEADER                             *         
*        GLARGS+3    C'A' - CLIENT ACCPAK OFFICE CODE                 *         
*        GLARGS+3    C'M' - CLIENT MEDIA NAME                         *         
*        GLARGS+4      C'B' - CLIENT MEDIA CODE AND NAME              *         
*        GLARGS+4      C'N' - CLIENT MEDIA NAME                       *         
*                                                                     *         
*EXIT    0-1         CLIENT OFFICE CODE                               *         
*        2           C'/' IF 3-4 PRESENT                              *         
*        3-4         AGENCY POWER CODE FOR ACCPAK                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICLI     NMOD1 0,**#ICLI                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         USING PCLTRECD,RF         ESTABLISH CLIENT HEADER                      
*                                                                               
         CLI   GLARGS+2,C'M'       CLIENT MEDIA NAME OVERRIDE                   
         BE    ICLIMED                                                          
*                                                                               
         ICM   RF,15,PBCLTADR      IF NO CLIENT HEADER IS AVAILABLE             
         BNZ   *+12                                                             
         MVI   0(R2),255              FORCE TO SORT LAST                        
         B     ICLIX                                                            
*                                                                               
*        DETERMINE FIELD WANTED                                                 
*                                                                               
         CLI   GLARGS+2,C'A'       CLIENT ACCOUNTING OFFICE                     
         BE    ICLIAOFC                                                         
*                                                                               
         B     ICLIX                                                            
*                                                                               
*        CLIENT ACCPAK OFFICE                                                   
*                                                                               
ICLIAOFC DS    0H                  CLIENT ACCOUNTING OFFICE                     
*                                                                               
         MVC   0(2,R2),PCLTAOFC    OFFICE CODE                                  
*                                                                               
         OC    PCLTACCA,PCLTACCA   SKIP IF NO ACCOUNTING AGENCY                 
         BZ    ICLIAOFX                                                         
*                                                                               
         MVI   2(R2),C'/'                                                       
         MVC   3(2,R2),PCLTACCA    ACCOUNTING AGENCY                            
*                                                                               
ICLIAOFX DS    0H                                                               
*                                                                               
         B     ICLIX                                                            
*                                                                               
         DROP  RF                                                               
*                                                                               
ICLIMED  DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'B'       IF BOTH CODE AND NAME                        
         BNE   *+10                                                             
         MVC   0(1,R2),PBMED          RETURN MEDIA CODE                         
*                                                                               
         ICM   R4,15,PBCLTADR      SKIP IF NO CLIENT HEADER                     
         BZ    ICLIMED1                                                         
*                                                                               
         USING PCLTREC,R4          ESTABLISH CLIENT RECORD                      
*                                                                               
         LA    R6,PCLTELEM         POINT TO FIRST ELM IN RECORD                 
*                                                                               
         USING PCLTMEL,R6          ESTABLISH MEDIA OVERRIDE ELEMENT             
*                                                                               
         CLI   PCLTMEL,0           DONE AT END OF RECORD                        
         BE    ICLIMED1               DEFAULT TO NORMAL MEDIA NAME              
         CLI   PCLTMEL,X'41'       FIND MEDIA OVERRIDE ELEMENT                  
         BE    *+18                                                             
         LLC   RF,PCLTMLEN         GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         B     *-26                                                             
*                                                                               
         MVC   1(L'PCLTMNAM,R2),PCLTMNAM RETURN MEDIA NAME                      
*                                                                               
*        INTERPRET INTERACTIVE ABBREVIATIONS                                    
*                                                                               
         CLC   PCLTMNAM(10),=C'INTERACTIV'                                      
         BE    *+10                                                             
         CLC   PCLTMNAM(9),=C'INTERACTV' INTERACTV AND INTERACTVE               
         BE    *+10                                                             
         CLC   PCLTMNAM(6),=C'INTRAC' COVERS INTRACTIVE (AND OTHERS)            
         BNE   *+10                                                             
         MVC   1(11,R2),=C'INTERACTIVE'                                         
*                                                                               
         B     ICLIMEDX                                                         
*                                                                               
ICLIMED1 DS    0H                                                               
*                                                                               
*        FIND MEDIA NAME IN MEDIA BUFFER                                        
*                                                                               
         L     R1,PBAMEDBF                                                      
         USING MEDBUFFD,R1                                                      
*                                                                               
         CLI   0(R1),0             END OF TABLE TEST                            
         BE    ICLIMEDX                                                         
         CLC   MBFMED,PBMED        MATCH ON MEDIA CODE                          
         BE    *+12                                                             
         LA    R1,MBFLEN(R1)                                                    
         B     *-22                                                             
*                                                                               
         MVC   1(L'MBFNAME,R2),MBFNAME   PRINT MEDIA NAME                       
*                                  NAME WILL BE CLIENT OVERRIDE                 
*                                  IF IT EXISTS - ELSE DEFAULT NAME             
*                                                                               
ICLIMEDX DS    0H                                                               
*                                                                               
         B     ICLIX                                                            
*                                                                               
ICLIX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R6,R1                                                         
*                                                                               
         TITLE 'PRWRITER - CLIENT HEADER FIELDS - OCLI'                         
***********************************************************************         
*                                                                     *         
*                    CLIENT HEADER FIELDS                             *         
*                                                                     *         
*NTRY    GLARGS+0    C'A' - CLIENT ADDRESS                            *         
*        GLARGS+0    C'M' - CLIENT MEDIA NAME                         *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCLI     NMOD1 0,**#OCLI                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        DETERMINE FIELD WANTED                                                 
*                                                                               
         CLI   GLARGS+0,C'A'       CLIENT ADDRESS                               
         BE    OCLIADDR                                                         
*                                                                               
         CLI   GLARGS+0,C'M'       MEDIA NAME                                   
         BE    OCLIMED                                                          
*                                                                               
         B     OCLIX                                                            
*                                                                               
*        CLIENT ADDRESS                                                         
*                                                                               
OCLIADDR DS    0H                  CLIENT ADDRESS                               
*                                                                               
         MVC   0(30,R3),0(R2)      ADDRESS LINE1                                
         CLC   30(30,R2),SPACES    PRINT SECOND LINE IF PRESENT                 
         BNH   *+10                                                             
         MVC   198(30,R3),30(R2)   ADDRESS LINE2                                
*                                                                               
OCLIADDX DS    0H                                                               
*                                                                               
         B     OCLIX                                                            
*                                                                               
OCLIMED  DS    0H                                                               
*                                                                               
*        BUILD LABEL AREA                                                       
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREAS                            
         MVC   CODEAREA,SPACES                                                  
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL AREA                             
*                                                                               
         MVC   CODEAREA(1),0(R2)   MEDIA CODE (MAY BE SPACES)                   
*                                                                               
         MVC   NAMEAREA(11),1(R2)  NAME                                         
*                                                                               
         GOTOR GENOUTA                                                          
*                                                                               
OCLIMEDX DS    0H                                                               
*                                                                               
         B     OCLIX                                                            
*                                                                               
OCLIX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - CLEARANCE DATA - INPUT - ICLR'                       
***********************************************************************         
*                                                                     *         
*        CLEARANCE STATUS RECORD FIELDS                               *         
*                                                                     *         
*NTRY    GLARGS     C'K'  - DATA IN CLEARANCE STATUS ELEMENT          *         
*          GLARGS+1    C'#'  - CHECK NUMBER                           *         
*                      C'S'  - CHECK STATUS                           *         
*                      C'D'  - CHECK DATE                             *         
*                      C'B'  - CHECK CLEARED DATE                     *         
*                      C'I'  - CLEARANCE INVOICE NUMBER               *         
*            GLARGS+2     C'#' -  CLEARANCE DAYS                      *         
*                                                                     *         
*        GLARGS     C'J'  - DATA IN BUY PAY ELEMENT                   *         
*          GLARGS+1    C'O'  - CLEARANCE OPTIONS                      *         
*                      C'D'  - CLEARANCE DATE                         *         
*          GLARGS+1    C'R'  - CLEARANCE REP                          *         
*            GLARGS+2     C'B' -  BOTH REP NUMBER AND NAME            *         
*            GLARGS+2     C'C' -  REP CODE ONLY                       *         
*            GLARGS+2     C'N' -  REP NAME ONLY                       *         
*          GLARGS+1    C'S'  - CLEARANCE SEQUENCE NUMBER              *         
*          GLARGS+1    C'T'  - CLEARANCE TYPE                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICLR     NMOD1 0,**#ICLR                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        HANDLE DATA IN CLEARANCE STATUS ELEMENT                                
*                                                                               
         CLI   GLARGS,C'K'         SKIP IF NOT IN CLEAR STATUS ELM              
         BNE   ICLRCLRN                                                         
*                                                                               
         ICM   R7,15,PBCLSELA      ESTABLISH CLEARANCE STATUS ELEMENT           
         BZ    ICLRK05                DROP DATA IF MISSING                      
*                                                                               
         USING PPCLEL01,R7                                                      
*                                                                               
         SR    R6,R6               INIT CLEARANCE INVOICE ELEMENT PTR           
*                                                                               
         LA    R3,PPCLCHK          POINT TO CHECK NUMBER                        
*                                                                               
         ICM   R6,15,PBCLINVA      SKIP IF NO INVOICE DATA                      
         BZ    ICLRK03                                                          
*                                                                               
         USING PPCLEL03,R6         ESTABLISH INVOICE ELEMENT                    
*                                                                               
         LLC   RF,PPCLEL03+1       GET ELEMENT LENGTH                           
*                                                                               
         LA    R6,0(RF,R6)         POINT TO FOLLOWING 05 ELEMENT                
*                                                                               
         USING PPCLEL05,R6         ESTABLISH CHECK ELEMENT                      
*                                                                               
         CLI   PPCLEL05,X'05'      DROP IF NOT CHECK ELEMENT                    
         BNE   ICLRK05                                                          
*                                                                               
         LA    R3,PCL5CHK          POINT TO CHECK NUMBER                        
*                                                                               
ICLRK03  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'I'       SKIP IF INVOICE # WANTED                     
         BE    *+8                                                              
         CLI   GLARGS+1,C'P'       SKIP IF PRODUCT   WANTED                     
         BE    *+8                                                              
         CLI   GLARGS+1,C'E'       SKIP IF ESTIMATE  WANTED                     
         BE    *+8                                                              
         CLI   GLARGS+1,C'W'       SKIP IF PID       WANTED                     
         BE    ICLRK10                                                          
*                                                                               
         OC    0(L'PPCLCHK,R3),0(R3)  IF CHECK NOT CUT                          
         BNZ   *+16                                                             
         TM    PBQOPTS,PBQCBU            SKIP IF NOT CBU OPTION                 
         BNO   ICLRK05                                                          
         B     ICLRK10                   ELSE KEEP                              
*                                                                               
         TM    PBQOPTS,PBQCBU      CBU OPTION?                                  
         BO    ICLRK10             YES - INCLUDE VOIDED                         
         CLC   =C'VOID',0(R3)      SKIP IF CHECK VOIDED                         
         BNE   ICLRK10                                                          
*                                                                               
ICLRK05  DS    0H                                                               
*                                                                               
         B     ICLRX                  SKIP - NONE AVAILABLE                     
*                                                                               
ICLRK10  DS    0H                                                               
*                                                                               
         USING PPCLEL01,R7         ESTABLISH MASTER CLEARANCE ELEMENT           
*                                                                               
         USING PPCLEL05,R6         ESTABLISH CHECK ELEMENT                      
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+1,C'#'       CHECK NUMBER                                 
         BE    ICLRCHK                                                          
*                                                                               
         CLI   GLARGS+1,C'D'       CHECK DATE                                   
         BE    ICLRCDT                                                          
*                                                                               
         CLI   GLARGS+1,C'B'       CHECK CLEARED DATE                           
         BE    ICLRCLD                                                          
*                                                                               
         CLI   GLARGS+1,C'S'       CHECK STATUS                                 
         BE    ICLRCST                                                          
*                                                                               
         CLI   GLARGS+1,C'I'       CLEARANCE INVOICE NUMBER                     
         BE    ICLRCIV                                                          
*                                                                               
         CLI   GLARGS+1,C'P'       PRODUCT                                      
         BE    ICLRPRD                                                          
*                                                                               
         CLI   GLARGS+1,C'E'       ESTIMATE                                     
         BE    ICLREST                                                          
*                                                                               
         CLI   GLARGS+1,C'W'       PID                                          
         BE    ICLRPID                                                          
*                                                                               
         B     ICLRX               UNKNOWN DATA TYPE                            
*                                                                               
*        CHECK BANK CLEARED DATE                                                
*                                                                               
ICLRCLD  DS    0H                  CHECK BANK CLEARED DATE                      
*                                                                               
         SR    R3,R3                                                            
*                                                                               
         CLI   PPCLEL01+1,PPCLBKDT-PPCLEL01   IF BANK CLRD DATE IN ELM          
         BNH   *+8                                                              
         LA    R3,PPCLBKDT            POINT TO IT                               
*                                                                               
         LTR   R6,R6               IF CHECK ELEMENT PRESENT                     
         BZ    *+8                                                              
         LA    R3,PCL5BKDT            POINT TO BANK CLRD DATE                   
*                                                                               
         LTR   R3,R3               IF WE HAVE BANK CLEARED DATE                 
         BZ    ICLRCLD9                                                         
*                                                                               
         OC    0(L'PPCLBKDT,R3),0(R3)   AND DATE FILLED IN                      
         BZ    ICLRCLD9                                                         
*                                                                               
         MVC   0(L'PPCLBKDT,R2),0(R3)            RETURN IT                      
         MVI   3(R2),C' '                        CLEAR  TODAY FLAG              
*                                                                               
         B     ICLRCLDX                                                         
*                                                                               
ICLRCLD9 DS    0H                                                               
         CLI   PBQPRFW0+15,C'Y'                                                 
         BE    ICLRCDT                                                          
*                                  DEFAULT TO  LAST OF PREVIOUS MONTH           
***      GOTO1 DATCON,DMCB,(5,0),WORK    TODAY AS YYMMDD                        
         GOTO1 DATCON,DMCB,(3,PBBTODAY),WORK      TODAY AS REF DATE             
         LHI   RF,-1                                                            
         ST    RF,DMCB+8                                                        
         GOTO1 ADDAY,DMCB,(C'M',WORK),(X'80',WORK+6)   BACKUP A MONTH           
         GOTO1 DATCON,DMCB,(0,WORK+6),(2,0(R2))                                 
*                                                                               
         CLI   GLARGS+2,C'1'       SKIP IF NO ASTERISK OPTION                   
         BE    *+8                                                              
         MVI   3(R2),C'*'             FLAG AS DEFAULT DATE                      
*                                                                               
ICLRCLDX DS    0H                                                               
*                                                                               
         B     ICLRX               UNKNOWN DATA TYPE                            
*                                                                               
*        CHECK DATE                                                             
*                                                                               
ICLRCDT  DS    0H                                                               
*                                                                               
         XC    HALF,HALF           INIT DATE SAVEAREA                           
*                                                                               
         LA    R3,PPCLCHDT         POINT TO CHECK DATE                          
*                                                                               
         LTR   R6,R6               IF CHECK ELEMENT PRESENT                     
         BZ    *+8                                                              
         LA    R3,PCL5CHDT            POINT TO CHECK DATE                       
*                                                                               
         MVC   0(L'PPCLCHDT,R2),0(R3)   RETURN CHECK DATE                       
*                                                                               
         OC    0(L'PPCLCHDT,R2),0(R2) IF NO CHECK DATE                          
         BNZ   ICLRCDT#                                                         
*                                                                               
         TM    PBQOPTS,PBQCBU      IF CBU OPTION                                
         BNO   ICLRCDT#                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,PBBTODAY),(02,0(R2))  USE TODAY                   
         MVI   3(R2),C'*'          FLAG AS DEFAULT                              
         MVC   HALF,0(R2)          SAVE AS CHECK DATE                           
         LA    R3,HALF             POINT TO THIS DATE                           
*                                                                               
ICLRCDT# DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'#'       SKIP IF NOT CLEARANCE DAYS                   
         BNE   ICLRCDTX                                                         
*                                                                               
         L     R4,AIO                                                           
*                                                                               
         XC    ICLRCKY,ICLRCKY     INIT PROFILE KEY                             
*                                                                               
         MVI   ICLRCSYS,C'P'        SET SYSTEM                                  
         MVI   ICLRCSYS+1,C'0'                                                  
         MVC   ICLRCPRF,=C'W0'      W0 - WRITER PROFILE                         
         MVC   ICLRCAGY,PBAGY       AGENCY                                      
         MVC   ICLRCMED,PBMED       MEDIA                                       
         MVC   ICLRCCLT,PBCLT       CLIENT                                      
*                                                                               
*        CHECK IF OFFICE KNOWN                                                  
*                                                                               
         CLI   PBQCLT,C'*'         IF REQUESTED BY OFFICE                       
         BNE   *+14                                                             
         MVC   ICLRCOFC,PBQCLT+1       USE IT                                   
         B     ICLRDTO9                                                         
*                                                                               
         CLI   PBCOFF,C' '        IF CLIENT OFFICE KNOWN USE IT                 
         BNH   *+10                                                             
         MVC   ICLRCOFC,PBCOFF       CLIENT OFFICE CODE                         
*                                                                               
         CLI   PBQSLAVE,C'Y'         IF DOING SLAVES                            
         BNE   ICLRDTSX                                                         
*                                                                               
         ICM   RF,15,PBCLTADR           POINT TO CLIENT RECORD                  
         BZ    ICLRDTSX                 NOT KNOWN                               
*                                                                               
         USING PCLTRECD,RF                                                      
*                                                                               
         CLI   PCLTOFF,C' '       IF CLIENT OFFICE KNOWN                        
         BNH   *+10                  USE IT                                     
         MVC   ICLRCOFC,PCLTOFF      SLAVE OFFICE CODE                          
*                                                                               
         DROP  RF                                                               
*                                                                               
ICLRDTSX DS    0H                                                               
*                                                                               
ICLRDTO9 DS    0H                                                               
*                                                                               
         CLI   ICLRCOFC,C' '      IF OFFICE PRESENT                             
         BNH   *+8                                                              
         MVI   ICLRCSTR,C'*'         INDICATE IN PARAMETERS                     
*                                                                               
ICLRDTOX DS    0H                                                               
*                                                                               
         CLC   ICLRCKYS,ICLRCKY    IF NEW KEY                                   
         BE    ICLRCDTB                                                         
*                                                                               
         MVC   ICLRCKYS,ICLRCKY       SAVE NEW KEY                              
*                                                                               
         GOTO1 GETPROF,DMCB,ICLRCKY,PBQPRFW0,DATAMGR                            
*                                                                               
ICLRCDTB DS    0H                                                               
*                                                                               
         ZAP   0(8,R2),=P'0'       INIT DRIVER INPUT                            
*                                                                               
         LTR   R7,R7               SKIP IF NO CLEARANCE ELEMENT                 
         BZ    ICLRCDTX                                                         
*                                  R3 ==> CORRECT CHECK DATE                    
         OC    0(L'PPCLCHDT,R3),0(R3)  SKIP IF CHECK NOT ISSUED                 
         BZ    ICLRCDTX                                                         
*                                                                               
         TM    PBQOPTS,PBQOBNKD    IF BANK CLEARED DATE IS BASE                 
         BO    *+12                                                             
         CLI   PBQPRFW0+10,C'Y'    IF BANK DEPOSIT DATE IS BASE                 
         BNE   ICLRCDTC                                                         
*                                                                               
         CLI   PPCLEL01+1,PPCLBKDT-PPCLEL01   SKIP IF NO BANK DEP DATE          
         BNH   *+8                                                              
         LA    R3,PPCLBKDT         POINT TO BANK DEPOSIT DATE                   
*                                                                               
         LTR   R6,R6               IF CHECK ELEMENT PRESENT                     
         BZ    *+8                                                              
         LA    R3,PCL5BKDT            POINT TO BANK DEPOSIT DATE                
*                                                                               
         OC    0(L'PPCLBKDT,R3),0(R3) SKIP IF CHECK DEPOSITED                   
         BNZ   ICLRCDTC                                                         
*                                                                               
ICLRCDT8 DS    0H                                                               
*                                  DEFAULT TO  LAST OF PREVIOUS MONTH           
***      GOTO1 DATCON,DMCB,(5,0),WORK    TODAY AS YYMMDD                        
         GOTO1 DATCON,DMCB,(3,PBBTODAY),WORK      TODAY AS REF DATE             
         LHI   RF,-1                                                            
         ST    RF,DMCB+8                                                        
         GOTO1 ADDAY,DMCB,(C'M',WORK),(X'80',WORK+6)   BACKUP A MONTH           
         GOTO1 DATCON,DMCB,(0,WORK+6),(2,HALF)                                  
*                                                                               
         LA    R3,HALF            DEFAULT TO TODAY'S DATE                       
*                                                                               
ICLRCDTC DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(2,0(R3)),ICLRCDTE  CONVERT TO YYMMDD                
*                                                                               
*        DETERMINE BASE DATE FOR CALCULATIONS                                   
*                                                                               
         CLI   PBQPRFW0+6,C'Y'     SKIP IF ON-SALE DATE IS BASE                 
         BE    ICLRCDOS                                                         
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
*                                                                               
         OC    PBDBDATE,PBDBDATE   SKIP IF NO BILLABLE DATE GIVEN               
         BZ    ICLRCDTX                                                         
*                                                                               
         MVC   ICLRCBDB,PBDBDATE   COPY BILLABLE DATE                           
*                                                                               
         CLC   PBQPRFW0+3(2),=X'0000' SKIP IF PROFILE HAS NO DATE               
         BNH   ICLRCDT0                                                         
*                                                                               
         SR    RF,RF                                                            
         SR    RE,RE                                                            
         IC    RE,PBQPRFW0+3       GET TENS DIGIT                               
         MH    RE,=H'10'                                                        
         IC    RF,PBQPRFW0+4       GET UNITS DIGIT                              
         AR    RF,RE               DATE                                         
*                                                                               
         LA    RF,1(RF)            ADD 1 DAY FOR CALCULATIONS                   
*                                                                               
         CH    RF,=H'29'           SKIP IF POSSIBLY OUT OF MONTH                
         BNL   ICLRCDT0                                                         
*                                                                               
         STC   RF,ICLRCBDB+2       RESET DAYS                                   
*                                                                               
         B     ICLRCDT1                                                         
*                                                                               
ICLRCDT0 DS    0H                                                               
*                                                                               
         MVI   ICLRCBDB+2,1        SET TO FIRST OF THE MONTH                    
*                                                                               
         SR    RF,RF               CONVERT TO START OF NEXT MONTH               
         IC    RF,ICLRCBDB+1       GET MONTH                                    
         LA    RF,1(RF)            BUMP BY ONE                                  
         STC   RF,ICLRCBDB+1                                                    
*                                                                               
         CH    RF,=H'12'           IF ORIGINAL MONTH WAS DECEMBER               
         BNH   ICLRCDT1                                                         
*                                                                               
         MVI   ICLRCBDB+1,1           SET MONTH TO JANUARY                      
         IC    RF,ICLRCBDB            BUMP YEAR                                 
         LA    RF,1(RF)                                                         
         STC   RF,ICLRCBDB                                                      
*                                                                               
ICLRCDT1 DS    0H                                                               
*                                                                               
         OC    PBQPRFW0+2(3),PBQPRFW0+2 DONE IF NO PROFILE ENTRY                
         BZ    ICLRCDT5                                                         
         CLC   PBQPRFW0+2(3),=X'C30000' DONE IF DEFAULT PROFILE                 
         BE    ICLRCDT5                                                         
*                                                                               
         CLI   PBQPRFW0+2,C'C'     DONE IF CURRENT MONTH                        
         BE    ICLRCDT5                                                         
*                                                                               
         SR    RF,RF                                                            
         IC    RF,ICLRCBDB+1       GET MONTH                                    
*                                                                               
         CLI   PBQPRFW0+2,C'P'     IF PREVIOUS MONTH                            
         BNE   ICLRCDT2                                                         
*                                                                               
         SH    RF,=H'1'               DECREMENT MONTH                           
         STC   RF,ICLRCBDB+1          RESET MONTH                               
         BP    *+18                                                             
         IC    RF,ICLRCBDB            IF JANUARY DECREMENT YEAR                 
         BCTR  RF,0                                                             
         STC   RF,ICLRCBDB                                                      
         MVI   ICLRCBDB+1,12             AND USE DECEMEBER                      
*                                                                               
         B     ICLRCDT5                                                         
*                                                                               
ICLRCDT2 DS    0H                                                               
*                                                                               
         LA    RF,1(RF)            ELSE ADD MONTH                               
         CLI   PBQPRFW0+2,C'A'          IF NEXT MONTH PLUS ONE                  
         BNE   *+8                                                              
         LA    RF,1(RF)                    ADD ANOTHER MONTH                    
*                                                                               
         STC   RF,ICLRCBDB+1          RESET MONTH                               
*                                                                               
         CH    RF,=H'12'                IF PAST DECEMBER                        
         BNH   ICLRCDT5                                                         
*                                                                               
         SH    RF,=H'12'                   RESET MONTH NUMBER                   
         STC   RF,ICLRCBDB+1                                                    
         IC    RF,ICLRCBDB                 ADD 1 TO YEAR                        
         LA    RF,1(RF)                                                         
         STC   RF,ICLRCBDB                                                      
*                                                                               
ICLRCDT5 DS    0H                                                               
*                                                                               
         B     ICLRCDCT                                                         
*                                                                               
*        ON-SALE DATE USED TO CALCULATE CLEARANCE DAYS                          
*                                                                               
ICLRCDOS DS    0H                                                               
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
*                                                                               
         OC    PBDSDATE,PBDSDATE   IF ON-SALE DATE GIVEN                        
         BZ    ICLRCDO1                                                         
*                                                                               
         MVC   ICLRCBDB,PBDSDATE       SET IT AS BASE DATE                      
*                                                                               
         B     ICLRCDCT                                                         
*                                                                               
ICLRCDO1 DS    0H                                                               
*                                                                               
         MVC   ICLRCBDB,PBUYKDAT   ELSE START WITH INSERTION DATE               
*                                                                               
         GOTO1 DATCON,DMCB,(3,ICLRCBDB),WORK   CONVERT DATE TO YYMMDD           
*                                                                               
         SR    RF,RF               DEFAULT TO MONTHLY                           
         IC    RF,ICLRCBDB+2       DAY OF MONTH IS # TO BACKUP                  
         ST    RF,FULL             SAVE NUMBER OF DAYS TO BACKUP                
*                                                                               
         SR    RF,RF                                                            
         L     R6,AIO3             POINT TO PUBREC                              
*                                                                               
         CLI   PUBKMED-PUBKEY(R6),C'M' SKIP IF NOT A MAGAZINE                   
         BNE   ICLRCDO5                                                         
*                                                                               
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
*                                                                               
*        FIND PUB GENERAL INFO ELEMENT                                          
*                                                                               
         USING PUBGEND,R6          ESTABLISH GENERAL INFO ELEMENT               
*                                                                               
         CLI   PUBGENEL,0          DONE AT END OF RECORD                        
         BE    ICLRCDO5               ASSUME MONTHLY                            
         CLI   PUBGENEL,PUBGENQ    SEARCH FOR GENERAL INFO ELEMENT              
         BE    *+16                                                             
         IC    RF,PUBGENEL+1                                                    
         LA    R6,PUBGENEL(RF)     POINT TO NEXT ELEMENT                        
         B     *-24                                                             
*                                                                               
         CLC   =C'W ',PUBMFREQ     IF WEEKLY MAGAZINE                           
         BNE   ICLRCDO5                                                         
*                                                                               
         DROP  R6                                                               
*                                                                               
*        WEEKLIES USE LAST DAY OF PREVIOUS WEEK                                 
*                                                                               
         GOTO1 GETDAY,DMCB,WORK,WORK+6   GET DAY OF WEEK                        
*                                                                               
         SR    RF,RF                                                            
         IC    RF,DMCB             DAY OF WEEK MON=1 - SUN=7                    
*                                                                               
         CH    RF,=H'7'            IF A SUNDAY                                  
         BNE   *+6                                                              
         SR    RF,RF                     ZERO DAYS                              
*                                                                               
         ST    RF,FULL                                                          
*                                                                               
ICLRCDO5 DS    0H                                                               
*                                                                               
         ICM   RF,15,FULL          NUMBER OF DAYS TO BACK UP                    
         BZ    ICLRCDOX            DONE IF NO DAYS GIVEN                        
*                                                                               
         LNR   RF,RF               NUMBER OF DAYS TO BACK UP                    
*                                                                               
         GOTO1 ADDAY,DMCB,WORK,WORK+6,(RF)   LAST DAY OF PREV WEEK/MON          
*                                                                               
         GOTO1 DATCON,DMCB,WORK+6,(3,ICLRCBDB)  CONVERT TO BINARY DATE          
*                                                                               
ICLRCDOX DS    0H                                                               
*                                                                               
ICLRCDCT DS    0H                                                               
*                                                                               
*        FIND CASH DAYS                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,ICLRCBDB),ICLRCBDC  CONVERT BILLABLE DTE          
*                                                                               
         CLI   PBQPRFW0+12,C'Y'       IF USING TODAY AS REFERENCE DATE          
         BNE   ICLRDT6                                                          
*                                                                               
***      GOTO1 DATCON,DMCB,(5,0),ICLRCBDC TODAY AS REFERENCE DATE               
         GOTO1 DATCON,DMCB,(3,PBBTODAY),ICLRCBDC  TODAY AS REF DATE             
*                                                                               
ICLRDT6  DS    0H                                                               
*                                                                               
         L     RF,PBCOMFAC         GET COMFACS ADDRESS                          
         L     RF,CPERVERT-COMFACSD(RF)   GET PERVERT ADDRESS                   
*                                                                               
         CLC   ICLRCBDC,ICLRCDTE   CHECK IF CHK BEFORE BILLABLE DATE            
         BNL   ICLRCDT9                                                         
*                                                                               
         GOTO1 (RF),DMCB,ICLRCBDC,ICLRCDTE   GET # 0F DAYS                      
*                                                                               
         LH    RF,DMCB+8           NUMBER OF DAYS BETWEEN DATES                 
         CVD   RF,DUB                                                           
         ZAP   0(8,R2),DUB         PASS NUMBER OF DAYS TO DRIVER                
*                                                                               
         B     ICLRCDTA                                                         
*                                                                               
ICLRCDT9 DS    0H                                                               
*                                  CHECK ISSUED BEFORE BASE DATE                
*                                  DAYS ARE NEGATIVE                            
*                                                                               
         GOTO1 (RF),DMCB,ICLRCDTE,ICLRCBDC   GET # 0F DAYS                      
*                                                                               
         LH    RF,DMCB+8           NUMBER OF DAYS BETWEEN DATES                 
         LNR   RF,RF               NUMBER IS NEGATIVE                           
         CVD   RF,DUB                                                           
         AP    DUB,=P'2'           RECTIFY COUNT FOR NEGATIVE AMOUNT            
         ZAP   0(8,R2),DUB         PASS NUMBER OF DAYS TO DRIVER                
*                                                                               
ICLRCDTA DS    0H                                                               
*                                                                               
         CLI   PBQPRFW0+6,C'Y'     IF ON-SALE DATE IS BASE                      
         BNE   *+10                                                             
         SP    0(8,R2),=P'1'          DECREMENT BECAUSE # IS INCLUSIVE          
*                                                                               
         B     ICLRCDTX                                                         
*                                                                               
ICLRCDTX DS    0H                                                               
*                                                                               
         B     ICLRCLRX                                                         
*                                                                               
ICLRCDTE DS    CL6                 CLEARANCE DATE AS YYMMDD CHARACTER           
ICLRCBDB DS    XL3                 BILLABLE DATE IN BINARY                      
ICLRCBDC DS    CL6                 BILLABLE DATE AS YYMMDD                      
*                                                                               
ICLRCKY  DS    XL16                PROFILE KEY                                  
         ORG   ICLRCKY                                                          
ICLRCSYS DS    CL1                 SYSTEM                                       
         DS    XL1                 NOT USED                                     
ICLRCPRF DS    CL2                 PROFILE ID                                   
ICLRCAGY DS    CL2                 AGENCY                                       
ICLRCMED DS    CL1                 MEDIA                                        
ICLRCCLT DS    CL3                 CLIENT                                       
ICLRCSTR DS    CL1                 STAR IF OFFICE PRESENT                       
ICLRCOFC DS    CL1                 OFFICE                                       
*                                                                               
ICLRCKYS DS    XL(L'ICLRCKY)       PROFILE KEY SAVEAREA                         
*                                                                               
*              CHECK NUMBER                                                     
*                                                                               
ICLRCHK  DS    0H                                                               
*                                                                               
         USING PPCLEL05,R6         ESTABLISH 05 ELEMENT                         
*                                                                               
         LTR   R6,R6               SKIP IF WE HAVE CHECK ELEMENT                
         BNZ   ICLRCHK5                                                         
*                                                                               
         CLC   =C'VOID',PPCLCHK    CHECK VOIDED?                                
         BE    ICLRCHKX            YES - DO NOT REPORT                          
*                                                                               
         MVC   0(L'PPCLCHK,R2),PPCLCHK                                          
*                                                                               
         TM    PPCLSTAT,X'80'      IF RECONCILED                                
         BNO   *+8                                                              
         MVI   L'PPCLCHK(R2),C'*'     SET INDICATOR                             
*                                                                               
         B     ICLRCHKX                                                         
*                                                                               
ICLRCHK5 DS    0H                                                               
*                                                                               
         CLC   =C'VOID',PCL5CHK    CHECK VOIDED?                                
         BE    ICLRCHKX            YES - DO NOT REPORT                          
         MVC   0(L'PPCLCHK,R2),PCL5CHK                                          
*                                                                               
         TM    PCL5STAT,X'80'      IF RECONCILED                                
         BNO   *+8                                                              
         MVI   L'PPCLCHK(R2),C'*'     SET INDICATOR                             
*                                                                               
ICLRCHKX DS    0H                                                               
*                                                                               
         B     ICLRCLRX                                                         
*                                                                               
*        STATUS                                                                 
*                                                                               
ICLRCST  DS    0H                                                               
*                                                                               
         LTR   R6,R6               SKIP IF WE HAVE CHECK ELEMENT                
         BNZ   ICLRCST5                                                         
*                                                                               
         TM    PPCLSTAT,X'80'      IF RECONCILED                                
         BNO   *+10                                                             
         MVC   0(12,R2),=CL12'RECONCILED'   INDICATE THAT IT IS                 
*                                                                               
         B     ICLRCSTX                                                         
*                                                                               
ICLRCST5 DS    0H                                                               
*                                                                               
         TM    PCL5STAT,X'80'      IF RECONCILED                                
         BNO   *+10                                                             
         MVC   0(12,R2),=CL12'RECONCILED'   INDICATE THAT IT IS                 
*                                                                               
ICLRCSTX DS    0H                                                               
*                                                                               
         B     ICLRCLRX                                                         
*                                                                               
*              CLEARANCE INVOICE NUMBER                                         
*                                                                               
ICLRCIV  DS    0H                                                               
*                                                                               
         ICM   RF,15,PBCLINVA      SKIP IF NO INVOICE ELEMENT                   
         BZ    ICLRCIVX                                                         
*                                                                               
         USING PPCLEL03,RF         ESTABLISH INVOICE ELEMENT                    
*                                                                               
         MVC   0(L'PPCLINV,R2),PPCLINV RETURN INVOICE NUMBER                    
*                                                                               
ICLRCIVX DS    0H                                                               
*                                                                               
         B     ICLRCLRX                                                         
*                                                                               
         DROP  RF                                                               
*                                                                               
*              PRODUCT CODE                                                     
*                                                                               
ICLRPRD  DS    0H                                                               
*                                                                               
         MVC   0(3,R2),PPCLPRD     RETURN PRODUCT CODE                          
*                                                                               
ICLRPRDX DS    0H                                                               
*                                                                               
         B     ICLRCLRX                                                         
*                                                                               
*              ESTIMATE NUMBER                                                  
*                                                                               
ICLREST  DS    0H                                                               
*                                                                               
         CLI   PPCLEL01+1,PPCLELL2 SKIP IF OLD ELEMENT LENGTH                   
         BL    ICLRESTX                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,PPCLEST        GET ESTIMATE NUMBER                          
         BZ    ICLRESTX            SKIP IF NONE                                 
*                                                                               
         CVD   RF,DUB              CVD                                          
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  0(3,R2),DUB+6(2)    RETURN CHARACTER ESTNUM                      
*                                                                               
ICLRESTX DS    0H                                                               
*                                                                               
         B     ICLRCLRX                                                         
*                                                                               
*        PID                                                                    
*                                                                               
ICLRPID  DS    0H                                                               
*                                                                               
         MVC   0(2,R2),PPCLPID     PID                                          
*                                                                               
         ICM   RF,15,PBUTLA        IF UTL ADDRESS SET                           
         BZ    *+10                                                             
         MVC   2(1,R2),4(RF)          PASS SE NUMBER                            
*                                                                               
ICLRPIDX DS    0H                                                               
*                                                                               
         B     ICLRCLRX                                                         
*                                                                               
ICLRCLRX DS    0H                                                               
*                                                                               
         B     ICLRX                                                            
*                                                                               
ICLRCLRN DS    0H                                                               
*                                                                               
*        HANDLE DATA IN BUY PAY ELEMENT                                         
*                                                                               
ICLRPAY  DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'J'         SKIP IF NOT IN BUY PAY ELM                   
         BE    *+8                                                              
         CLI   GLARGS,C'N'         SKIP IF NOT IN BUY PAY ELM                   
         BNE   ICLRPAYN                                                         
*                                                                               
         ICM   R7,15,PBPAYELA      ESTABLISH BUY PAY ELEMENT                    
         BZ    ICLRX                  SKIP - NONE AVAILABLE                     
         USING PPAYELD,R7                                                       
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+1,C'C'       CHECK CONTROL DATE                           
         BE    ICLRCTLD                                                         
*                                                                               
         CLI   GLARGS+1,C'D'       CLEAR DATE                                   
         BE    ICLRPDT                                                          
*                                                                               
         CLI   GLARGS+1,C'O'       CLEARANCE OPTIONS                            
         BE    ICLRPOP                                                          
*                                                                               
         CLI   GLARGS+1,C'R'       CLEARANCE REP                                
         BE    ICLRPRP                                                          
*                                                                               
         CLI   GLARGS+1,C'S'       CLEARANCE SEQUENCE NUMBER                    
         BE    ICLRPSQ                                                          
*                                                                               
         CLI   GLARGS+1,C'T'       CLEARANCE TYPE                               
         BE    ICLRPTP                                                          
*                                                                               
         CLI   GLARGS+1,C'C'       ADDITIONAL CHARGE CODE                       
         BE    ICLRACH                                                          
*                                                                               
         B     ICLRX               UNKNOWN DATA TYPE                            
*                                                                               
*        ADDITIONAL CHARGE CODE                                                 
*                                                                               
ICLRACH  DS    0H                                                               
*                                                                               
         CLI   PPAYELEM+1,PPACCODE-PPAYELEM SKIP IF NO ADDL CHARGE              
         BNH   ICLRPAYX                                                         
*                                                                               
         MVC   0(L'PPACCODE,R2),PPACCODE    ADDITIONAL CHARGE CODE              
*                                                                               
         B     ICLRPAYX                                                         
*                                                                               
*        CHECK CONTROL DATE                                                     
*                                                                               
ICLRCTLD DS    0H                                                               
*                                                                               
         MVC   0(L'PPDCKDAT,R2),PPDCKDAT  CHECK CONTROL DATE                    
*                                                                               
         B     ICLRPAYX                                                         
*                                                                               
*        CLEARANCE DATE                                                         
*                                                                               
ICLRPDT  DS    0H                                                               
*                                                                               
         MVC   0(L'PPDDATE,R2),PPDDATE  CLEARANCE DATE                          
*                                                                               
         B     ICLRPAYX                                                         
*                                                                               
*        PAYMENT OPTIONS                                                        
*                                                                               
ICLRPOP  DS    0H                                                               
*                                                                               
         CLI   PPAYELEM+1,PPDSTAT-PPAYELD  SKIP IF ELEMENT TOO SHORT            
         BNH   ICLRPOPX                                                         
*                                                                               
         MVC   0(L'PPDSTAT,R2),PPDSTAT  CLEARANCE OPTIONS                       
*                                                                               
         CLI   GLARGS+2,C'S'            PAYSRC KEYWORD?                         
         BNE   ICLRPOPX                 NO                                      
         MVI   0(R2),C'M'               DEFAULT TO MANUAL                       
         TM    PPDSTAT,X'08'            PAY SOURCE IS SCRIPT?                   
         JZ    *+8                                                              
         MVI   0(R2),C'S'               YES - REPORT SCRIPT                     
         TM    PPDSTAT,X'04'            PAY SOURCE IS AUTOPAY?                  
         JZ    *+8                                                              
         MVI   0(R2),C'A'               YES - REPORT AUTOPAY                    
*                                                                               
ICLRPOPX DS    0H                                                               
*                                                                               
         B     ICLRPAYX                                                         
*                                                                               
*        REP CODE AND/OR NAME                                                   
*                                                                               
*EXIT    R2==> CL4  - REPCODE - NULLS IF REPNAME ONLY                           
*              CL10 - REPNAME FOR SORTING - X'01' IF NO REP                     
*              CL4  - REPREC  DISK ADDRESS                                      
*              XL1  - NOT USED                                                  
*              XL1  - SE NUMBER                                                 
*                                                                               
ICLRPRP  DS    0H                  REP DATA                                     
*                                                                               
         MVC   0(L'PPREP,R2),PPREP REP NUMBER                                   
         NI    0(R2),X'FF'-X'80'-X'40'  KILL CK AND CR INDICATORS               
*                                                                               
         OC    0(L'PPREP,R2),0(R2) IF NO REP GIVEN                              
         BNZ   ICLRPRP1                                                         
*                                                                               
         OC    PPDDATE,PPDDATE        SKIP IF UNPAID                            
         BZ    *+8                                                              
         MVI   L'REPBUFN(R2),1             FORCE TO SORT FIRST                  
*                                                                               
         B     ICLRPRPX                                                         
*                                                                               
ICLRPRP1 DS    0H                                                               
*                                                                               
*        FIND REP IN REP BUFFER                                                 
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,0(R2)          CONVERT NUMBER TO CHARACTER                  
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'                 FORCE SIGN                           
         UNPK  0(L'REPBUFN,R2),DUB                                              
*                                                                               
         ICM   RE,15,PBAREPBF      ESTABLISH REP BUFFER                         
         USING REPBUFD,RE                                                       
         BZ    ICLRPRPX            SKIP IF NO BUFFER AVAILABLE                  
*                                                                               
         OC    REPBUFD(REPBUFLN),REPBUFD   IF NO TABLE AVAILABLE                
         BNZ   ICLRPRPA                                                         
*                                                                               
         GOTO1 =V(BLDREP)             GO BUILD IT                               
*                                                                               
         ICM   RE,15,PBAREPBF      ESTABLISH REP BUFFER                         
*                                                                               
ICLRPRPA DS    0H                                                               
*                                                                               
ICLRPRPL DS    0H                                                               
*                                                                               
         OC    REPBUFD(REPBUFLN),REPBUFD   IF END OF TABLE                      
         BZ    ICLRPRPX               SKIP IF REP NOT FOUND                     
*                                                                               
         CLC   REPBUFN,0(R2)       LOOK FOR REP NUMBER MATCH                    
         BE    ICLRPRPF                                                         
*                                                                               
ICLRPRPC DS    0H                                                               
*                                                                               
         LA    RE,REPBUFLN(RE)     BUMP TABLE ENTRY POINTER                     
         B     ICLRPRPL                                                         
*                                                                               
ICLRPRPF DS    0H                                                               
*                                                                               
         LA    R1,L'REPBUFN(R2)    INIT DRIVER DATA POINTER                     
*                                                                               
         MVC   0(L'REPBUFNA,R1),REPBUFNA   RETURN SHORT NAME                    
         LA    R1,L'REPBUFNA(R1)   ADJUST DATA POINTER                          
*                                                                               
         MVC   0(L'REPBUDA,R1),REPBUDA  AND REP REC DISK ADDRESS                
         LA    R1,L'REPBUDA(R1)    ADJUST DATA POINTER                          
*                                                                               
         LA    R1,1(R1)            ADJUST DATA POINTER FOR UNUSED DATA          
*                                                                               
         MVC   0(1,R1),REPBUFSE  PASS SE NUMBER                                 
*                                                                               
         CLI   GLARGS+2,C'N'       IF NAME ONLY WANTED                          
         BNE   *+10                                                             
         XC    0(L'REPBUFN,R2),0(R2)   KILL REP CODE                            
*                                                                               
         B     ICLRPRPX                                                         
*                                                                               
         DROP  RE                                                               
*                                                                               
ICLRPRPX DS    0H                                                               
*                                                                               
         MVC   WORK,0(R2)                                                       
*                                                                               
         B     ICLRPAYX                                                         
*                                                                               
*        CLEARANCE SEQUENCE NUMBER                                              
*                                                                               
ICLRPSQ  DS    0H                  CLEARANCE SEQUENCE NUMBER                    
*                                                                               
         CLI   PPAYELEM+1,PPDSTAT-PPAYELD  SKIP IF ELEMENT TOO SHORT            
         BNH   ICLRPSQX                                                         
*                                                                               
         MVC   0(L'PPDSEQNO,R2),PPDSEQNO  PASS SQN TO SORT                      
*                                                                               
ICLRPSQX DS    0H                  CLEARANCE SEQUENCE NUMBER                    
*                                                                               
         B     ICLRPAYX                                                         
*                                                                               
*        CLEARANCE TYPE                                                         
*                                                                               
ICLRPTP  DS    0H                  CLEARANCE TYPES                              
*                                                                               
         TM    PPREP,X'80'         CHECK IF CK PAYMENT                          
         BNO   *+10                                                             
         MVC   0(2,R2),=C'CK'          FLAG AS 'CK'                             
*                                                                               
         TM    PPREP,X'40'         CHECK IF CR PAYMENT                          
         BNO   *+10                                                             
         MVC   0(2,R2),=C'CR'          FLAG AS 'CR'                             
*                                                                               
         B     ICLRPAYX                                                         
*                                                                               
ICLRPAYX DS    0H                                                               
*                                                                               
         B     ICLRX                                                            
*                                                                               
ICLRPAYN DS    0H                                                               
*                                                                               
ICLRX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R7                                                               
*                                                                               
         TITLE 'PRWRITER - CLEARANCE DOLLAR DATA - INPUT - ICLRDLR'             
***********************************************************************         
*                                                                     *         
*        CLEARANCE STATUS RECORD FIELDS                               *         
*                                                                     *         
*NTRY    ALL ARGUMENTS SET UP FOR IDOLLAR ROUTINE                     *         
*                                                                     *         
*        THIS ROUTINE CHANGES THE ELEMENT IDS OF THOSE WITH THE       *         
*        SAME ID AS THAT OF REQUESTED ELEMENT. THIS MAKES THE BUY     *         
*        LOOK AS IF IT HAD ONLY ONE PAID OR BILLED ELEMENT            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICLRDLR  NMOD1 0,**#ICL$                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        DETERMINE ELEMENT TO BE PROCESSED                                      
*           IT IS EITHER A PAY OR BILL ELEMENT BUT NOT BOTH                     
*           IF NEITHER ACTIVE, EXIT                                             
*                                                                               
ICL$ELMC DS    0H                                                               
*                                                                               
         ICM   R7,15,PBPAYELA      POINT TO CURRENT PAID ELEMENT                
         BZ    ICL$ELM1                                                         
*                                                                               
         CLI   GLARGS,C'N'         SKIP IF CHECK DATA NOT NEEDED                
         BE    ICL$ELMX                                                         
*                                                                               
         USING PPCLEL01,R7                                                      
*                                                                               
         ICM   R7,15,PBCLSELA      POINT TO CLEARANCE STATUS ELEMENT            
         BZ    ICLRDLRX               DONE IF NONE                              
*                                                                               
         SR    R6,R6               INIT CLEARANCE INVOICE ELEMENT PTR           
*                                                                               
         LA    R3,PPCLCHK          POINT TO CHECK NUMBER                        
*                                                                               
         ICM   R6,15,PBCLINVA      SKIP IF NO INVOICE DATA                      
         BZ    ICLR@03                                                          
*                                                                               
         USING PPCLEL03,R6         ESTABLISH INVOICE ELEMENT                    
*                                                                               
         LLC   RF,PPCLEL03+1       GET ELEMENT LENGTH                           
*                                                                               
         LA    R6,0(RF,R6)         POINT TO FOLLOWING 05 ELEMENT                
*                                                                               
         USING PPCLEL05,R6         ESTABLISH CHECK ELEMENT                      
*                                                                               
         CLI   PPCLEL05,X'05'      DROP IF NOT CHECK ELEMENT                    
         BNE   ICLR@05                                                          
*                                                                               
         LA    R3,PCL5CHK          POINT TO CHECK NUMBER                        
*                                                                               
ICLR@03  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'I'       SKIP IF INVOICE # WANTED                     
         BE    ICLR@10                                                          
*                                                                               
         OC    0(L'PPCLCHK,R3),0(R3)  IF CHECK NOT CUT                          
         BNZ   *+16                                                             
         TM    PBQOPTS,PBQCBU         KEEP IF CBU OPTION                        
         BO    ICLR@05                                                          
         B     ICLRDLRX               ELSE SKIP                                 
*                                                                               
         TM    PBQOPTS,PBQCBU      CBU OPTION?                                  
         BO    ICLR@05             YES - INCLUDE VOIDED                         
         CLC   =C'VOID',0(R3)      SKIP IF CHECK VOIDED                         
         BE    ICLRDLRX                                                         
*                                                                               
ICLR@05  DS    0H                                                               
*                                                                               
         ICM   R7,15,PBPAYELA      RE-POINT TO CURRENT PAID ELEMENT             
*                                                                               
ICLR@10  DS    0H                                                               
*                                                                               
         B     ICL$ELMX                                                         
*                                                                               
ICL$ELM1 DS    0H                                                               
*                                                                               
         ICM   R7,15,PBBLLELA      POINT TO CURRENT BILL ELEMENT                
         BZ    ICLRDLRX            NONE ACTIVE                                  
*                                                                               
         OC    PBMBTELA,PBMBTELA   IF DOING CASH DATA                           
         BZ    *+12                                                             
         CLI   GLARGS,C'Q'            SKIP UNLESS DOING CASH DOLLARS            
         BNE   ICLRDLRX                                                         
*                                                                               
         CLC   GLARGS(3),=C'MB3'   BDNCD KEYWORD?                               
         BNE   ICL$ELMX            NO                                           
         CLI   PBBLLSW,X'FF'       ALREADY GONE WITH BILL ELEMENT?              
         BE    ICLRDLRX            YES, BILLED NET LESS CD REPORTED             
*                                                                               
ICL$ELMX DS    0H                                                               
*                                                                               
*        SAVE ELEMENT ID AND TURN ALL SIMILAR ONES TO X'FF'                     
*                                                                               
         MVC   ICL$ID,0(R7)        SAVING ELEMENT ID                            
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYRECD,R4         ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   EXIT IF NOT A BUY RECORD THERE               
         BNE   ICLRDLRX                                                         
*                                                                               
*        SEARCH FOR ELEMENTS WITH SAME ID AND MASK THEM                         
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN BUY                
         SR    RF,RF                                                            
*                                                                               
ICL$MSKL DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE IF END OF BUY REACHED                   
         BE    ICL$MSKD                                                         
*                                                                               
         CLC   ICL$ID,0(R6)        SKIP IF NOT OF DESIRED TYPE                  
         BNE   ICL$MSKC                                                         
*                                                                               
         CR    R6,R7               SKIP IF INPUT ELEMENT FOUND                  
         BE    ICL$MSKC                                                         
*                                                                               
         MVI   0(R6),X'FF'         CHANGE ELM ID TO MASK IT                     
*                                                                               
ICL$MSKC DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELM IN RECORD                   
         B     ICL$MSKL                                                         
*                                                                               
ICL$MSKD DS    0H                                                               
*                                                                               
         LA    RF,PBLDATE-PBILELD(R7)  DEFAULT TO BILLED DATE                   
         CLI   0(R7),PPAYELQ       IF PAY ELEMENT                               
         BNE   *+8                                                              
         LA    RF,PPDDATE-PPAYELD(R7)   USE PAID DATE                           
*                                                                               
         MVC   GLARGS+9(3),0(RF)   SET DATE FILTER                              
         MVC   GLARGS+12(3),0(RF)                                               
*                                                                               
         GOTO1 =V(IDOLLAR)         GO GET DOLLAR AMOUNT                         
*                                                                               
*        SEARCH FOR ELEMENTS WITH MASKED ID AND RESET THE ID                    
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN BUY                
         SR    RF,RF                                                            
*                                                                               
ICL$RSTL DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE IF END OF BUY REACHED                   
         BE    ICL$RSTD                                                         
*                                                                               
         CLI   0(R6),X'FF'         SKIP NOT MASKED ELEMENT                      
         BNE   ICL$RSTC                                                         
*                                                                               
         MVC   0(1,R6),ICL$ID      RESET ELEMENT ID                             
*                                                                               
ICL$RSTC DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELM IN RECORD                   
         B     ICL$RSTL                                                         
*                                                                               
ICL$RSTD DS    0H                                                               
*                                                                               
ICLRDLRX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
ICL$ID   DS    X                   ID OF ACTIVE PAID/BILL ELEMENT               
*                                                                               
         DROP  R4,R7                                                            
*                                                                               
         TITLE 'PRWRITER - CLEARANCE DATA - OUTPUT - OCLR'                      
***********************************************************************         
*                                                                     *         
*        CLEARANCE DATA                                               *         
*                                                                     *         
*          GLARGS      C'O'  - CLEARANCE OPTIONS                      *         
*                      C'W'  - CLEARER                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCLR     NMOD1 0,**#OCLR                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        HANDLE DATA IN CLEARANCE STATUS ELEMENT                                
*                                                                               
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+1,C'O'       CLEARANCE OPTIONS                            
         BE    OCLRPOP                                                          
*                                                                               
         CLI   GLARGS+1,C'W'       PID                                          
         BE    OCLRPID                                                          
*                                                                               
         B     OCLRX               UNKNOWN DATA TYPE                            
*                                                                               
*        PAYMENT OPTIONS                                                        
*                                                                               
*        R2==> PPDSTAT - SEE PPAYELD FOR DESCRIPTION                            
*                                                                               
OCLRPOP  DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'S'       PAYSRC KEYWORD?                              
         BNE   OCLRPOP5            NO                                           
         CLI   0(R2),C'M'          PAY SOURCE IS MANUAL?                        
         BNE   *+10                NO                                           
         MVC   0(6,R3),=C'MANUAL'  REPORT MANUAL                                
         CLI   0(R2),C'S'          PAY SOURCE IS SCRIPT?                        
         BNE   *+10                NO                                           
         MVC   0(6,R3),=C'SCRIPT'  YES - REPORT SCRIPT                          
         CLI   0(R2),C'A'          PAY SOURCE IS AUTOPAY?                       
         BNE   *+10                NO                                           
         MVC   0(7,R3),=C'AUTOPAY' YES - REPORT AUTOPAY                         
         B     OCLRX               DONE                                         
*                                                                               
OCLRPOP5 TM    0(R2),X'20'         PAID ACROSS ZONES/EDITIONS                   
         BNO   *+10                                                             
         MVC   0(26,R3),=C'PAID ACROSS ZONES/EDITIONS'                          
*                                                                               
OCLRPOPX B     OCLRX                                                            
*                                                                               
*        PID                                                                    
*                                                                               
OCLRPID  DS    0H                                                               
*                                                                               
*        R2 ==> PID - FIND CTFILE RECORD                                        
*                                                                               
OCLPGET  DS    0H                                                               
*                                                                               
         OC    0(2,R2),0(R2)       SKIP IF NO PID FOUND                         
         BZ    OCLPNOTF                                                         
*                                                                               
*        READ PERSON AUTH REC ON CTFILE                                         
*                                                                               
         LA    R7,KEY                                                           
         USING CT0REC,R7           ESTABLISH KEY AS PERSON AUTH REC             
         XC    CT0KEY,CT0KEY       INIT KEY                                     
*                                                                               
         MVI   CT0KTYP,CT0KTEQU    SET RECORD TYPE                              
         MVC   CT0KAGY,PBQSECAG    SET SECURITY AGENCY                          
*                                                                               
         CLC   CT0KAGY,=CL2' '     IF SECURITY AGENCY NOT PRESENT               
         BH    *+10                                                             
         MVC   CT0KAGY,PBQAGY         USE REQUESTING AGENCY                     
*                                                                               
         MVC   CT0KNUM,0(R2)       SET PID                                      
*                                                                               
         MVC   FILENAME,=CL8'CTFILE'    SET FILENAME                            
         MVC   AIO,AIO2                 READ RECORD INTO IOA2                   
         MVI   USEIO,C'Y'               READ INTO I/O AREA                      
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         XC    FILENAME,FILENAME   RESET FILE NAME                              
         MVI   USEIO,0             RESET SWITCH                                 
*                                                                               
         L     R7,AIO              POINT TO FOUND RECORD                        
*                                                                               
         CLC   CT0KEY,KEYSAVE      SKIP IF RECORD NOT FOUND                     
         BNE   OCLPNOTF                                                         
*                                                                               
*        FIND USER'S ID                                                         
*                                                                               
*        FIND PERSON'S ID ELEMENT                                               
*                                                                               
         LA    RE,CT0DATA          POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
OCLPCTLP DS    0H                                                               
*                                                                               
         CLI   0(RE),0             CHECK FOR END OF RECORD                      
         BE    OCLPCTDN                                                         
*                                                                               
         CLI   0(RE),X'C3'         - MATCH ON ELEMENT CODE                      
         BE    OCLPCTFD                                                         
*                                                                               
OCLPCTCN DS    0H                                                               
*                                                                               
         IC    RF,1(RE)            GET ELEMENT LENGTH                           
         AR    RE,RF               BUMP TO NEXT ELEMENT                         
         B     OCLPCTLP            GO FIND NEXT ELEMENT                         
*                                                                               
OCLPCTDN DS    0H                  NO PERSON ID FOUND                           
*                                                                               
         B     OCLPNOTF                                                         
*                                                                               
OCLPCTFD DS    0H                                                               
*                                                                               
*        FIND PERSON RECORD                                                     
*                                                                               
         LA    R7,KEY                                                           
         USING SAPEREC,R7          ESTABLISH KEY AS PERSON REC KEY              
         XC    SAPEKEY,SAPEKEY     INIT KEY                                     
*                                                                               
         MVI   SAPETYP,SAPETYPQ    SET RECORD TYPE                              
         MVI   SAPESUB,SAPESUBQ    SET RECORD SUB TYPE                          
*                                                                               
         MVC   SAPEAGY,PBQSECAG    SET SECURITY AGENCY                          
*                                                                               
         CLC   SAPEAGY,=CL2' '     IF SECURITY AGENCY NOT PRESENT               
         BH    *+10                                                             
         MVC   SAPEAGY,PBQAGY         USE REQUESTING AGENCY                     
*                                                                               
         MVC   SAPEPID,2(RE)       SET USERID FROM PREVIOUS RECORD              
*                                                                               
         MVC   FILENAME,=CL8'CTFILE'    SET FILENAME                            
         MVC   AIO,AIO2                 READ RECORD INTO IOA2                   
         MVI   USEIO,C'Y'               READ INTO I/O AREA                      
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         XC    FILENAME,FILENAME   RESET FILE NAME                              
         MVI   USEIO,0             RESET SWITCH                                 
*                                                                               
         L     R7,AIO2             POINT TO FOUND RECORD                        
*                                                                               
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),KEYSAVE SKIP IF REC NOT FOUND           
         BNE   OCLPNOTF                                                         
*                                                                               
         LA    RE,SAPEDATA         POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
*        FIND NAME ELEMENT                                                      
*                                                                               
OCLPNMLP DS    0H                                                               
*                                                                               
         CLI   0(RE),0             CHECK FOR END OF RECORD                      
         BE    OCLPNMDN                                                         
*                                                                               
         USING SANAMD,RE           ESTABLISH AS NAME ELEMENT                    
*                                                                               
         CLI   SANAMEL,SANAMELQ    LOOKING FOR NAME ELEMENT                     
         BE    OCLPNMFD                                                         
*                                                                               
OCLPNMCN DS    0H                                                               
*                                                                               
         IC    RF,SANAMLN          GET ELEMENT LENGTH                           
         AR    RE,RF               BUMP TO NEXT ELEMENT                         
         B     OCLPNMLP            GO PROCESS NEXT ELEMENT                      
*                                                                               
OCLPNMDN DS    0H                  NAME ELEMENOT FOUND                          
*                                                                               
         B     OCLPNOTF                                                         
*                                                                               
OCLPNMFD DS    0H                                                               
*                                                                               
         SR    R0,R0               GET ELEMENT LENGTH                           
         IC    R0,SANAMLN                                                       
         AHI   R0,-SANAMLNQ        DECRMENT BY FIXED LENGTH                     
         BNP   OCLPNOTF            NO NAME IN ELEMENT                           
*                                                                               
         LA    RE,SANAMES          POINT TO START OF PERSON'S NAME              
         SR    RF,RF                                                            
         LR    R1,R3               COPY START OF OUTPUT                         
*                                                                               
OCLPFMLP DS    0H                  FORMAT PERSON'S NAME                         
*                                                                               
         USING SANAMES,RE          ESTABLISH NAMES SECTION                      
*                                                                               
         IC    RF,SANAMELN         GET LENGTH OF THIS PART OF NAME              
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),SANAME      MOVE OUT PART OF NAME                        
*                                                                               
         LA    R1,1(RF,R1)         BUMP TO NEXT OUTPUT AREA                     
*                                                                               
OCLPFMCN DS    0H                                                               
*                                                                               
         SR    R0,RF               DECREMENT REMAINING ELEMENT LENGTH           
         AHI   R0,-2               FOR NAME LENGTH BYTE & EX LENGTH             
         BNP   OCLPFMDN              END OF ELEMENT REACHED                     
*                                                                               
         LA    RE,2(RF,RE)         POINT TO NEXT PART OF NAME                   
         LA    R1,1(R1)            ADD IN A SPACING CHARACTER                   
*                                                                               
         B     OCLPFMLP                                                         
*                                                                               
OCLPFMDN DS    0H                                                               
*                                                                               
         B     OCLPSQSH                                                         
*                                                                               
OCLPNOTF DS    0H                  PRINT 'UNKNOWN' IF NO PID                    
*                                                                               
         MVC   0(7,R3),=C'UNKNOWN'                                              
         LA    R1,07(R3)           POINT TO NEXT OUTPUT POSITION                
*                                                                               
OCLPSQSH DS    0H                                                               
*                                                                               
         LR    R0,R1               END OF OUTPUT MINUS START                    
         SR    R0,R3               EQUALS OUTPUT LENGTH                         
*                                                                               
         GOTO1 SQUASHER,DMCB,0(R3),(R0) SQUASH NAME                             
*                                                                               
OCLRPIDX DS    0H                                                               
         B     OCLRX                                                            
*                                                                               
OCLRX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R7,RE                                                            
*                                                                               
         TITLE 'PRWRITER - MAX INSERTS PER ISSUE - OCMAX'                       
***********************************************************************         
*                                                                     *         
*        ROUTINE TO HANDLE MAX INSERTS PER ISSUE OUTPUT               *         
*                                                                     *         
*NTRY    0-1 - MAX INSERTS * RECORD COUNTER                           *         
*        2-3 - RECORD COUNTER                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCMAX    NMOD1 0,**#OCMAX                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R1,GLATHID                                                       
         USING GLINTD,R1                                                        
*                                                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         ICM   RF,3,0(R2)          MAX INSERTS PER ISSUE * # 0F RECS            
*                                                                               
         SR    R5,R5                                                            
         ICM   R5,3,2(R2)          NUMBER OF RECORDS                            
         BZ    OCMAXX              NO RECORDS AVAILABLE                         
*                                                                               
         DR    RE,R5               MAX INSERTS PER ISSUE                        
*                                                                               
         CVD   RF,DUB              CVB                                          
*                                                                               
         XC    EBLOCK,EBLOCK       INIT EDIT BLOCK                              
*                                                                               
         LA    RF,DUB                                                           
         ST    RF,EBAIN            PASS INPUT ADDRESS                           
         MVI   EBLIN,8             INPUT LENGTH                                 
         MVI   EBTIN,C'P'          INPUT FORMAT IS PACKED                       
         MVI   EBFLOAT,C'-'        FLOAT MINUS SIGN                             
*                                                                               
         ST    R3,EBAOUT           OUTPUT ADDRESS                               
*                                                                               
         L     R1,GLADTENT                                                      
         USING DROD,R1                                                          
*                                                                               
         ZIC   R6,DROLEN                                                        
         STC   R6,EBLOUT           SET OUTPUT LENGTH                            
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK  PRINT AVAILS FOR ISSUE                     
*                                                                               
OCMAXX   DS    0X                                                               
         XMOD1                                                                  
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R1                                                               
*                                                                               
         TITLE 'PRWRITER - CONTRACT/BUY COMMENTS - ICOMM'                       
***********************************************************************         
*                                                                     *         
*        REPORTS STANDARD OR FREEFORM COMMENTS FROM BUY OR CONTRACT   *         
*                                                                     *         
*NTRY                                                                 *         
*        GLARGS+0 - RECORD INDICATOR 'C'/'B'                          *         
*        GLARGS+1 - ELEMENT INDICATOR                                 *         
*        GLARGS+2 - C'C' - CHOP COMMENT INTO OUTPUT AREA              *         
*                                                                     *         
*EXIT    0(1,R2)           -  LENGTH OF DRIVER LENGTH                 *         
*        1(DRINLEN-6,R2)   -  START OF COMMENT FOR SORTING            *         
*        DRINLEN-6(4,R2)   -  DISK ADDRESS OF SOURCE RECORD           *         
*        DRINLEN-2(1,R2)   -  SE           OF SOURCE RECORD           *         
*        DRINLEN-1(1,R2)   -  LINES NEEDED TO PRINT COMMENT           *         
*                                                                     *         
*        TWO CASES                                                    *         
*        1. - COMMENT WILL BE CHOPPED INTO OUTPUT COLUMN              *         
*              FOR A MAXIMUM OF 20 LINES                              *         
*                                                                     *         
*        2. COMMENT IS PRINTED ONE LINE AT A TIME TO ALLOW            *         
*              ANOTHER COLUMN TO LIST ITEMS WHILE COMMENT IS PRINTING *         
*              STRATEGY IS TO FIND NUMBER OF LINES IT TAKES  TO PRINT *         
*              COMMENT AND THEN ISSUE ONE DETAIL LINE FOR EACH COMMENT*         
*              LINE. PRWRIIO CO-OPERATES BY RETURNING SAME RECORD     *         
*              FOR OUTPUT THE REQUIRED NUMBER OF TIMES                *         
*              EXAMPLE IS CONTRACT COMMENTS AND CONTRACT RATES        *         
*              IN ADJACENT COLUMNS. (ONLY WORKS FOR CONTRACT FLAVOR)  *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICOMM    NMOD1 0,**#ICOMM                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R3,AIO1             DEFAULT TO BUY RECORD                        
         CLI   GLARGS,C'C'         USE CONTRACT RECORD IF REQUIRED              
         BNE   *+18                                                             
         L     R3,AIO2                                                          
         CLC   =X'FFFF',PCONNUM-PCONREC(R3) SKIP IF NO CONTRACT RECORD          
         BE    ICOMMFF                                                          
*                                                                               
         CLI   GLARGS+2,C'C'       IF CHOPPING COMMENT                          
         BE    ICOMM05                FORCE BUILDING OF COMMENT                 
*                                                                               
         CLC   ICOMMKYS,0(R3)      IF RECORD UNCHANGED                          
         BNE   ICOMM05                                                          
*                                                                               
*                                     RETURN SAME INPUT AS LAST TIME            
*                                     AND DECREMENT LINE COUNTER                
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,PBMINLNS       DECREMENT LINES NEEDED COUNTER               
         BZ    ICOMM10                NO MORE LINES NEEDED                      
         BCTR  RF,0                                                             
         STH   RF,PBMINLNS                                                      
*                                                                               
         CLI   GLARGS,C'C'         SKIP IF CONTRACT COMMENTS                    
         BE    *+16                                                             
         LH    RF,PBMINLNS         ANY MORE LINES TO PRINT?                     
         BNP   *+8                                                              
         MVI   PBRTCODE,PBRTMORQ      ASK WRIIO TO RETURN                       
*                                                                               
         L     R6,GLADTENT         ESTABLISH INPUT DESCRIPTION ELEMENT          
         USING DRIND,R6                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,DRINLEN        DRIVER INPUT LENGTH                          
         BZ    ICOMMFF             NO INPUT                                     
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),ICOMMSAV    RETURN SAVED DRIVER INPUT                    
*                                                                               
ICOMM10  DS    0H                                                               
*                                                                               
         B     ICOMMX                                                           
*                                                                               
*        CONSTRUCT COMMENT AND FIND NUMBER OF LINES                             
*              IT TAKES TO PRINT                                                
*                                                                               
ICOMM05  DS    0H                                                               
*                                                                               
         MVC   ICOMMKYS,0(R3)      RESET KEY SAVE AREA                          
         XC    PBMINLNS,PBMINLNS   INIT MINIMUM NUMBER OF LINES                 
*                                                                               
         SR    R0,R0                                                            
*                                                                               
         ICM   RF,15,PBUTLA        IF UTL ADDRESS SET                           
         BZ    *+8                                                              
         IC    R0,4(RF)               PASS SE NUMBER                            
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR CLIENT OF AOR SITUATION                   
         BNE   ICOMM20                                                          
*                                                                               
         IC    R0,PAOSE            DEFAULT TO AGENCY SE NUMBER                  
         CLI   GLARGS,C'C'         CONTRACTS USE AOR SE                         
         BNE   *+8                                                              
         IC    R0,PAORSE                                                        
*                                                                               
ICOMM20  DS    0H                                                               
*                                                                               
         STC   R0,ICOMMSE          SAVE SE NUMBER                               
*                                                                               
         MVC   ICOMMLO,GLARGS+1    INIT STARTING COMMENT ID                     
         MVC   ICOMMHI,GLARGS+1    INIT ENDING   COMMENT ID                     
*                                                                               
         CLI   GLARGS+1,X'FF'      IF ALL COMMENTS WANTED                       
         BNE   *+12                                                             
         MVI   ICOMMLO,X'66'          ADJUST ID RANGE                           
         MVI   ICOMMHI,X'6A'                                                    
*                                                                               
         MVC   ICOMMID,ICOMMLO     INIT COMMENT ID WANTED                       
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         L     R6,GLADTENT         ESTABLISH INPUT DESCRIPTION ELEMENT          
         USING DRIND,R6                                                         
*                                                                               
         CLI   DRINEL,X'30'        FIND OUTPUT DESCRIPTION ELEMENT              
         BE    *+14                                                             
         IC    RF,DRINELEN         RECORD LENGTH                                
         AR    R6,RF                                                            
         B     *-14                                                             
*                                                                               
         USING DROD,R6             ESTABLISH OUT DESCRIPTION ELEMENT            
*                                                                               
         MVC   ICOMMOLN,DROLEN     SAVE OUTPUT COLUMN WIDTH                     
*                                                                               
         DROP  R6                                                               
*                                                                               
         LA    R6,ICOMMCHP         POINT TO CHOPPED COMMENT AREA                
*                                                                               
         XC    0(240,R6),0(R6)     CLEAR ICOMMCHP TO PREVENT LOOP!              
*                                                                               
         CLI   GLARGS+1,X'FF'      IF ALL COMMENTS WANTED                       
         JNE   ICOMM25                                                          
*                                                                               
         CLI   GLARGS+3,C'N'          SKIP IF NO IDS WANTED                     
         BE    ICOMM25                                                          
*                                                                               
         SR    RF,RF                       RESERVE 3 COLUMNS FOR ID             
         ICM   RF,1,ICOMMOLN                                                    
         AHI   RF,-3                                                            
         BNP   ICOMMX                                                           
         STC   RF,ICOMMOLN                                                      
*                                                                               
         LA    R6,3(R6)            BUMP COMMENT START POSITION                  
*                                                                               
ICOMM25  DS    0H                                                               
*                                                                               
         LA    R0,20               MAXIMUM NUMBER OF OUTPUT LINES               
*                                                                               
ICOMMLP  DS    0H                                                               
*                                                                               
         CLC   ICOMMID,ICOMMHI     DONE IF COMMENT RANGE EXCEEDED               
         BH    ICOMMDN                                                          
*                                                                               
*        GET COMMENTS FOR TYPE                                                  
*                                                                               
         GOTO1 =A(GETCOM),DMCB,(ICOMMID,(R3)),(ICOMMSE,=C'NOSQ'),0,0            
*                                                                               
*        CHOP COMMENT                                                           
*                                                                               
         ICM   R5,15,DMCB+8        ADDRESS OF COMMENT TABLE                     
         BZ    ICOMMCN                SKIP IF TABLE NOT PRESENT                 
*                                                                               
         ICM   RF,15,DMCB+12       COMMENT LENGTH                               
         BZ    ICOMMCN             NO COMMENT                                   
*                                                                               
         GOTO1 CHOPPER,DMCB,(0,0(R5)),(ICOMMOLN,(R6)),(80,(R0)),       X        
               C'LEN=',(RF)                                                     
*                                                                               
         ICM   R1,15,DMCB+8        NUMBER OF LINES IN BLOCK                     
         BZ    ICOMMCN                                                          
*                                                                               
         LH    RE,PBMINLNS         UPDATE MINIMUM # OF LINES TO PRINT           
         AR    RE,R1                                                            
         STH   RE,PBMINLNS                                                      
*                                                                               
         STC   RE,ICOMMMLN         NUMBER OF LINES TO PRINT COMMENT             
*                                                                               
         SR    R0,R1               DECREMENT LINES LEFT IN BLOCK                
         BNP   ICOMMDN             NO MORE ROOM TO PRINT COMMENT                
*                                                                               
         LA    RF,80               WIDTH OF LINE IN CHOPPED BLOCK               
         MR    RE,R1               AMMOUNT OF BLOCK USED BY COMMENT             
         LA    R6,0(RF,R6)         NEXT AVAILABLE AREA IN BLOCK                 
*                                                                               
ICOMMCN  DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,ICOMMID          BUMP COMMENT ID                              
         LA    RF,1(RF)                                                         
         STC   RF,ICOMMID                                                       
*                                                                               
         B     ICOMMLP                                                          
*                                                                               
ICOMMDN  DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'C'       IF CHOPPING COMMENT                          
         BNE   *+18                                                             
         MVC   PBMINLNS,=H'1'         SET MINIMUM LINES TO 1                    
         MVI   ICOMMMLN,1             NUMBER OF LINES TO PRINT COMMENT          
         B     ICOMM50                                                          
*                                                                               
         TM    PBQPOPT,PBQPOCUT    IF CUTTING TO COLUMN WIDTH                   
         BNO   *+18                                                             
         MVC   PBMINLNS,=H'1'         SET MINIMUM LINES TO 1                    
         MVI   ICOMMMLN,1             NUMBER OF LINES TO PRINT COMMENT          
         B     ICOMM50                                                          
*                                                                               
ICOMM50  DS    0H                                                               
*                                                                               
*        FORMAT DRIVER INPUT                                                    
*                                                                               
         L     R6,GLADTENT         ESTABLISH INPUT DESCRIPTION ELEMENT          
         USING DRIND,R6                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,DRINLEN        INPUT LENGTH                                 
*                                                                               
         LR    R1,R2               SAVE DRIVER INPUT POINTER                    
*                                                                               
         STC   RF,0(R2)            PASS LENGTH TO OUTPUT                        
*                                                                               
         LA    R5,ICOMMCHP         ADDRESS OF COMMENT TABLE                     
*                                                                               
         CLC   3(100,R5),SPACES                                                 
         BNH   ICOMMFF             FORCE NO COMMENT TO BOTTOM                   
*                                                                               
         SH    RF,=H'8'            EX LENGTH FOR SAMPLING OF COMMENT            
         BM    ICOMMFF                NO ROOM                                   
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   1(0,R2),0(R5)       PASS START OF COMMENT                        
*                                                                               
         LA    R2,2(RF,R2)         POINT TO NEXT AVAILABLE AREA                 
*                                                                               
         MVC   0(4,R2),PBABUY      DEFAULT TO BUY DISK ADDRESS                  
*                                                                               
         CLI   GLARGS,C'C'         IF CONTRACT RELATED FIELD                    
         BNE   *+10                                                             
         MVC   0(4,R2),PBQCONDA       USE CONTRACT DISK ADDRESS                 
*                                                                               
         MVC   4(1,R2),ICOMMSE     PASS SE NUMBER                               
         MVC   5(1,R2),ICOMMMLN    NUMBER OF LINES TO PRINT COMMENT             
*                                                                               
         L     R6,GLADTENT         ESTABLISH INPUT DESCRIPTION ELEMENT          
         USING DRIND,R6                                                         
*                                                                               
         LR    R2,R1               RESTORE DRIVER INPUT POINTER                 
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,DRINLEN        INPUT LENGTH                                 
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   ICOMMSAV(0),0(R2)   SAVE INPUT                                   
*                                                                               
         LH    RF,PBMINLNS         DECREMENT NUMBER OF LINES STILL              
         BCTR  RF,0                   TO PRINT                                  
         STH   RF,PBMINLNS                                                      
*                                                                               
         CLI   GLARGS,C'C'         SKIP IF CONTRACT COMMENT                     
         BE    *+14                                                             
         LTR   RF,RF               IF MORE LINES TO PRINT                       
         BNP   *+8                                                              
         MVI   PBRTCODE,PBRTMORQ      ASK WRIIO TO RETURN                       
*                                                                               
         B     ICOMMX                                                           
*                                                                               
ICOMMFF  MVI   1(R2),X'FF'         FORCES COMMENT TO SORT LAST                  
*                                                                               
ICOMMX   DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
ICOMMKYS DS    XL(L'PBUYKEY)       KEYSAVE AREA                                 
*                                                                               
ICOMMLO  DS    X                   STARTING COMMENT ID                          
ICOMMHI  DS    X                   ENDING   COMMENT ID                          
ICOMMID  DS    X                   CURRENT  COMMENT ID                          
*                                                                               
ICOMMOLN DS    X                   OUTPUT COLUMN LENGTH                         
ICOMMSE  DS    X                   SE NUMBER TO USE                             
*                                                                               
ICOMMSAV DS    CL256               INPUT SAVEAREA                               
*                                                                               
ICOMMMLN DS    X                   NUMBER OF LINES TO PRINT COMMENT             
ICOMMCHP DS    30XL80              CHOPPER WORKAREA                             
*                                                                               
         DROP  R6                                                               
*                                                                               
         TITLE 'PRWRITER - CONTRACT/BUY COMMENTS - OCOMM'                       
***********************************************************************         
*                                                                     *         
*        REPORTS STANDARD OR FREEFORM COMMENTS FROM BUY OR CONTRACT   *         
*                                                                     *         
*NTRY                                                                 *         
*        GLARGS+0 - RECORD INDICATOR 'C'/'B'                          *         
*        GLARGS+1 - ELEMENT INDICATOR                                 *         
*        GLARGS+2 - C'C' CHOP COMMENT                                 *         
*                                                                     *         
*        0(1,(R2)          -  INPUT LENGTH INCLUDING THIS BYTE        *         
*        1(DRINLEN-6,R2)   -  START OF COMMENT FOR SORTING            *         
*        DRINLEN-6(4,R2)   -  DISK ADDRESS OF SOURCE RECORD           *         
*        DRINLEN-2(1,R2)   -  SE           OF SOURCE RECORD           *         
*        DRINLEN-1(1,R2)   -  LINES NEEDED TO PRINT COMMENT           *         
*                                                                     *         
*EXIT    COMMENT CHOPPED TO COLUMN WIDTH                              *         
*        ACTUALLY PRINTS ONLY ONE LINE AT A TIME UNTIL COMMENT        *         
*           EXHAUSTED.                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCOMM    NMOD1 0,**#OCOMM                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         LA    R7,PBLOCK           ESTABLISH PRNTBLOCK                          
         USING PBLOCK,R7                                                        
*                                                                               
         CLI   1(R2),X'FF'         SKIP IF NO COMMENT AVAILABLE                 
         BE    OCOMMX                                                           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,0(R2)          INPUT DATA LENGTH                            
         SH    RF,=H'8'            COMMENT SAMPLE EXECUTE LENGTH                
         BM    OCOMMX              NONE AVAILABLE                               
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    1(0,R2),1(R2)       CHECKS FOR PASSED COMMENT                    
         BZ    OCOMMX                 NONE                                      
*                                                                               
*        THE DISK ADDRESS OF RECORD IS PASSED AFTER SAMPLE OF COMMENT           
*                                                                               
         LA    R6,2(RF,R2)         POINT TO DISK ADDRESS                        
*                                                                               
         CLI   GLARGS+2,C'C'       IF WE ARE TO CHOP THE COMMENT                
         BE    OCOMM05                SKIP CHECKING DISK ADDRS                  
*                                                                               
         CLC   OCOMMDAS,0(R6)      PRINT NEXT LINE IF SAME DISK ADDR            
         BE    OCOMMPRT                                                         
*                                                                               
OCOMM05  DS    0H                                                               
*                                                                               
         MVC   OCOMMDAS,0(R6)      SAVE NEW DISK ADDR & SE                      
*                                                                               
         XC    KEY,KEY                                                          
         MVC   KEY+27(4),0(R6)                                                  
*                                                                               
         CLI   4(R6),0             SKIP IF NO SE NUMBER PASSED                  
         BE    OCOMM10                                                          
*                                                                               
         L     RF,PBUTLA           POINT TO UTLA                                
         MVC   OCOMSESV,4(RF)      SAVE CURRENT SE NUMBER                       
         MVC   4(1,RF),4(R6)       CHANGE SE NUMBER FOR FILES                   
*                                                                               
OCOMM10  DS    0H                                                               
*                                                                               
         L     RF,AIO1                                                          
         ST    RF,AIO                                                           
         OI    DMINBTS,8          PASS DELETED RECORDS                          
*                                                                               
         GOTO1 GETREC             READ IN RECORD                                
*                                                                               
*        FORMAT COMMENT                                                         
*                                                                               
         LR    RF,R3               ASSUME CHOPPING DIRECTLY TO OUTPUT           
         LA    RE,198              SPACING BETWEEN OUTPUT LINES                 
*                                                                               
         CLI   GLARGS+2,C'C'       IF NOT CHOPPING DIRECTLY TO OUTPUT           
         BE    *+12                                                             
         LA    RF,OCOMMCHP            CHOPPED COMMENT BUILD AREA                
         LA    RE,80                  SPACING BETWEEN OUPUT LINES               
*                                                                               
         L     R6,GLADTENT         ESTABLISH OUTPUT DESC ELEMENT                
         USING DROD,R6                                                          
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,DROLEN         GET OUTPUT LENGTH                            
*                                                                               
         DROP  R6                                                               
*                                                                               
         MVC   OCOMMLO,GLARGS+1    INIT STARTING COMMENT ID                     
         MVC   OCOMMHI,GLARGS+1    INIT ENDING   COMMENT ID                     
*                                                                               
         CLI   GLARGS+1,X'FF'      IF ALL COMMENTS WANTED                       
         BNE   OCOMM15                                                          
*                                                                               
         MVI   OCOMMLO,X'66'          ADJUST ID RANGE                           
         MVI   OCOMMHI,X'69'                                                    
*                                                                               
         CLI   GLARGS+3,C'N'          SKIP IF NO IDS WANTED                     
         BE    *+12                                                             
         LA    RF,3(RF)                    BUMP BUILD AREA POINTER              
         AHI   R1,-3                       ADJUST WIDTH                         
*                                                                               
OCOMM15  DS    0H                                                               
*                                                                               
         ST    RF,OCOMMCHA         SAVE ADDRESS AND SPACING                     
         STC   RE,OCOMMCHS                                                      
         STC   R1,OCOMMCHW         SAVE WIDTH                                   
*                                                                               
         MVC   OCOMMID,OCOMMLO     INIT COMMENT ID WANTED                       
*                                                                               
         LA    R0,OCOMMCHN         MAXIMUM NUMBER OF OUTPUT LINES               
*                                                                               
OCOMMLP  DS    0H                                                               
*                                                                               
         CLC   OCOMMID,OCOMMHI     DONE IF COMMENT RANGE EXCEEDED               
         BH    OCOMMDN                                                          
*                                                                               
*        GET COMMENTS FOR TYPE                                                  
*                                                                               
         GOTO1 =A(GETCOM),DMCB,(OCOMMID,AIO),(OCOMMSE,=C'NOSQ'),0,0             
*                                                                               
         ICM   RF,15,DMCB+12       COMMENT LENGTH                               
         BZ    OCOMMCN             NO COMMENT                                   
*                                                                               
         ICM   R5,15,DMCB+8           ADDRESS OF WORK AREA FROM GETCOM          
         BZ    OCOMMCN                SKIP IF TABLE NOT PRESENT                 
*                                                                               
         L     R1,OCOMMCHA            COPY OUTPUT POINTER                       
*                                                                               
         CLI   GLARGS+1,X'FF'         IF PRINTING ALL COMMENTS                  
         BNE   OCOMMCT1                                                         
*                                                                               
         CLI   GLARGS+3,C'N'             SKIP IF IDS NOT WANTED                 
         BE    OCOMMCT1                                                         
*                                                                               
         AHI   R1,-3                     BACK UP TO START OF PRINTAREA          
*                                                                               
         CLI   OCOMMID,X'67'             SET COMMENT ID                         
         BNE   *+10                                                             
         MVC   0(3,R1),=C'IC='               INSERTION ORDER COMMENT            
*                                                                               
         CLI   OCOMMID,X'68'                                                    
         BNE   *+10                                                             
         MVC   0(3,R1),=C'PI='               POSITION INSTRUCTION               
*                                                                               
         CLI   OCOMMID,X'69'                                                    
         BNE   *+10                                                             
         MVC   0(3,R1),=C'TS='               TEARSHEET INSTRUCTIONS             
*                                                                               
         LA    R1,3(R1)                RESET OUTPUT POINTER                     
*                                                                               
OCOMMCT1 DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,OCOMMCHW       GET PRINTAREA WIDTH                          
*                                                                               
         TM    PBQPOPT,PBQPOCUT    IF CUTTING TO COLUMN WIDTH                   
         BNO   OCOMMCTN                                                         
*                                                                               
         BCTR  RF,0                   DECREMENT FOR EXECUTE                     
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(R5)          PRINT COMMENT                             
*                                                                               
         MVI   OCOMMLNS,0             INDICATE NO MORE LINES TO PRINT           
*                                                                               
         B     OCOMMX                                                           
*                                                                               
OCOMMCTN DS    0H                                                               
*                                                                               
*        CHOP COMMENT                                                           
*                                                                               
         ICM   RF,15,DMCB+12       COMMENT LENGTH                               
         BZ    OCOMMCN             NO COMMENT                                   
*                                                                               
         GOTO1 CHOPPER,DMCB,(0,0(R5)),(OCOMMCHW,OCOMMCHA),             X        
               (OCOMMCHS,(R0)),C'LEN=',(RF)                                     
*                                                                               
         ICM   R1,15,DMCB+8        NUMBER OF LINES IN COMMENT                   
         BZ    OCOMMCN                                                          
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,OCOMMLNS       NUMBER OF LINES SO FAR                       
         AR    RF,R1               BUMP LINE COUNTER                            
         STC   RF,OCOMMLNS                                                      
*                                                                               
         SR    R0,R1               DECREMENT LINES LEFT IN BLOCK                
         BNP   OCOMMDN             NO MORE ROOM TO PRINT COMMENT                
*                                                                               
         SR    RF,RF                                                            
         IC    RF,OCOMMCHS         WIDTH OF LINE IN CHOPPED BLOCK               
         MR    RE,R1               AMOUNT OF BLOCK USED BY COMMENT              
*                                                                               
         L     RE,OCOMMCHA         CURRENT COMMENT START                        
         LA    RE,0(RF,RE)         NEW START                                    
         ST    RE,OCOMMCHA                                                      
*                                                                               
OCOMMCN  DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,OCOMMID          BUMP COMMENT ID                              
         LA    RF,1(RF)                                                         
         STC   RF,OCOMMID                                                       
*                                                                               
         B     OCOMMLP                                                          
*                                                                               
OCOMMDN  DS    0H                                                               
*                                                                               
         CLI   OCOMMSE,0           SKIP IF NO SE NUMBER PASSED                  
         BE    OCOMM20                                                          
*                                                                               
         L     RF,PBUTLA           POINT TO UTLA                                
         MVC   4(1,RF),OCOMSESV    RESTORE CURRENT SE NUMBER                    
*                                                                               
OCOMM20  DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'C'       DONE IF CHOPPING                             
         BE    OCOMMX                                                           
*                                                                               
OCOMMPRT DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,OCOMMLNS       NUMBER OF LINES LEFT                         
         BZ    OCOMMPRX            NONE                                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR NEXT TIME                      
         STC   RF,OCOMMLNS                                                      
*                                                                               
         L     R6,GLADTENT         ESTABLISH OUTPUT DESC ELEMENT                
         USING DROD,R6                                                          
*                                                                               
         IC    RF,DROLEN           GET COLUMN WIDTH                             
*                                                                               
         CLI   GLARGS+2,X'FF'      IF ALL COMMENTS WANTED                       
         BNE   *+12                                                             
         AHI   RF,-3               SHORTEN WITDH BY ID LENGTH                   
         LA    R3,3(R3)            BUMP OUTPUT POINTER                          
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),OCOMMCHP    PRINT NEXT LINE                              
*                                                                               
         LA    R0,OCOMMCHN         NUMBER OF LINES IN WORKAREA                  
         LA    R1,OCOMMCHP         FIRST LINE      IN WORKAREA                  
         LA    RF,L'OCOMMCHP       WIDTH OF WORKAREA LINE                       
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
*                                                                               
         EX    RF,*+16             MOVE UP STACK OF LINES                       
         LA    R1,L'OCOMMCHP(R1)   BUMP TO NEXT LINE                            
         BCT   R0,*-8                                                           
         B     *+10                                                             
         MVC   0(0,R1),L'OCOMMCHP(R1)                                           
*                                                                               
OCOMMPRX DS    0H                                                               
*                                                                               
OCOMMX   DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OCOMMDAS DC    XL5'00'             DISK ADDR & SE SAVEAREA                      
         ORG   *-1                                                              
OCOMMSE  DS    X                   SE                                           
OCOMSESV DS    X                   SE SAVEAREA                                  
*                                                                               
OCOMMLO  DS    X                   STARTING COMMENT ID                          
OCOMMHI  DS    X                   ENDING   COMMENT ID                          
OCOMMID  DS    X                   CURRENT  COMMENT ID                          
*                                                                               
OCOMMCHA DS    A                   A(AREA FOR CHOPPED COMMENT)                  
OCOMMCHS DS    X                   SPACING BETWEEN PRINT LINES                  
OCOMMCHW DS    X                   CHOPPED COMMENT WIDTH                        
*                                                                               
OCOMMLNS DC    X'00'               NUMBER OF LINES LEFT TO PRINT                
OCOMMCHN EQU   20                  NUMBER OF LINES IN WORKAREA                  
OCOMMCHP DS    (OCOMMCHN)XL80      COMMENT CHOP AREA                            
         DC    CL80' '             EXTRA LINE                                   
*                                                                               
         DROP  R6,R7                                                            
*                                                                               
         TITLE 'PRWRITER - COMMENTS - OUTPUT - OCOM'                            
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT COMMENTS ON OUTPUT                          *         
*                                                                     *         
*NTRY    0-3(R2)    COMMENT RECORD DISK ADDRESS                       *         
*                                                                     *         
*        GLARGS+8 = 6 BYTE STANDARD COMMENT CODE                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCOM     NMOD1 0,**+OCOM                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        SEARCH FOR COMMENT IN TABLE                                            
*                                                                               
OCOMTBL  DS    0H                                                               
*                                                                               
         LA    R4,OCOMENT          POINT TO FIRST ENTRY IN TABLE                
         USING OCOMENT,R4          ESTABLISH AS TABLE ENTRY                     
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,OCOMNMBR       FIND NUMBER OF ENTRIES IN TABLE              
         BZ    OCOMTBDN            COMMENT NOT IN TABLE IF EMPTY                
*                                                                               
OCOMTBLP DS    0H                                                               
*                                                                               
         CLC   OCOMID,GLARGS+8     MATCH COMMENT ID IN TABLE                    
         BE    OCOMTBLX            FOUND GO PRINT                               
*                                                                               
OCOMTBCN DS    0H                                                               
*                                                                               
         LA    R4,OCOMENTL(R4)     BUMP TO NEXT ITEM IN TABLE                   
         BCT   RF,OCOMTBLP                                                      
*                                                                               
OCOMTBDN DS    0H                  NOT IN TABLE                                 
*                                                                               
*        READ COMMENT RECORD AND ADD TO TABLE                                   
*                                                                               
OCOMRD   DS    0H                                                               
*                                                                               
         STCM  R4,15,OCOMSTRT      SAVE A(FIRST ENTRY FOR COMMENT)              
*                                                                               
         MVC   AIO,AIO3            USE I/O AREA 3 FOR RECORD                    
*                                                                               
         XC    KEY,KEY             INIT KEY AREA                                
         LA    R5,KEY                                                           
         USING PCOMRECD,R5         ESTABLISH AS COMMENT RECORD                  
*                                                                               
         MVC   PCOMKAGY,PBAGY      SET AGENCY                                   
*                                                                               
         MVC   PCOMKMED,PBQMED     SET MEDIA                                    
*                                                                               
         CLI   PCOMKMED,C'C'       IF REPORTING ALL MEDIA                       
         BE    *+8                                                              
         CLI   PCOMKMED,C'*'                                                    
         BNE   *+8                                                              
         MVI   PCOMKMED,C'M'       USE MAGAZINE FOR COMMENTS                    
*                                                                               
         MVI   PCOMKRCD,X'40'      SET UP AS COMMENT RECORD                     
         MVC   PCOMKNUM,GLARGS+8   SET COMMENT NUMBER                           
*                                                                               
         GOTO1 HIGH                READ RECORD                                  
*                                                                               
         CLC   KEY(L'PCOMKEY),KEYSAVE MAKE SURE WE GOT CORRECT ONE              
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
*        SAVE COMMENT LINES                                                     
*                                                                               
         L     R5,AIO3                                                          
         LA    R5,33(R5)           POINT TO FIRST ELEMENT IN RECORD             
         SR    R0,R0                                                            
*                                                                               
OCOMRDLP DS    0H                                                               
*                                                                               
         USING PCOMCELM,R5         ESTABLSH COMMENT DATA ELEMENT                
*                                                                               
         CLI   PCOMCELM,0          EOR                                          
         BE    OCOMRDDN                                                         
*                                                                               
         CLI   PCOMCELM,X'40'      ONLY WANT COMMENT ELEMENTS                   
         BNE   OCOMRDCN                                                         
*                                                                               
         CLC   =C'++START',PCOMDT  IF ++START                                   
         BE    OCOMRDCN              SKIP - FOR ESTIMATE REPORT                 
*                                                                               
         CLC   =C'++END',PCOMDT    IF ++END                                     
         BE    OCOMRDCN              SKIP - FOR ESTIMATE REPORT                 
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PCOMCELM+1       ELEMENT'S LENGTH                             
         SH    RF,=Y(PCOMDT-PCOMCELM) DETERMINE COMMENT'S LENGTH                
         BNP   OCOMRDCN            MUST HAVE SOME LENGTH                        
*                                                                               
         LA    R1,PCOMDT           POINT TO START OF COMMENT                    
*                                                                               
         CLI   0(R1),C'+'          SKIP UNLESS LINES TO BE SKIPPED              
         BNE   OCOMRD30                                                         
*                                                                               
         PACK  DUB,1(1,R1)         NUMBER OF LINES TO SKIP                      
         CVB   RE,DUB                                                           
*                                                                               
         MVC   OCOMID,GLARGS+8     IDENTIFY COMMENT                             
         MVI   OCOMLINE,0          FORCE BLANK LINE                             
         LA    R4,OCOMENTL(R4)     POINT TO TABLE ENTRY                         
         AH    R0,=H'1'            BUMP LINE COUNTER                            
         BCT   RE,*-18             LOOP FOR NUMBER OF LINES                     
*                                                                               
         LA    R1,2(R1)            POINT TO BODY OF COMMENT                     
         SH    RF,=H'2'            ADJUST COMMENT LENGTH                        
         BNP   OCOMRDCN            MUST HAVE SOMETHING TO PRINT                 
*                                                                               
OCOMRD30 DS    0H                                                               
*                                                                               
         MVC   OCOMID,GLARGS+8     SET COMMENT ID                               
*                                                                               
         BCTR  RF,0                DECREMENT LENGTH FOR EXECUTE                 
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   OCOMLINE(0),0(R1)   MOVE COMMENT TO TABLE                        
*                                                                               
         AH    R0,=H'1'            BUMP LINE COUNTER                            
         LA    R4,OCOMENTL(R4)     POINT TO TABLE ENTRY                         
*                                                                               
OCOMRDCN DS    0H                                                               
*                                                                               
         IC    RF,PCOMCELM+1       BUMP TO NEXT ELEMENT                         
         LA    R5,0(RF,R5)                                                      
         B     OCOMRDLP                                                         
*                                                                               
OCOMRDDN DS    0H                                                               
*                                                                               
         ZIC   RF,OCOMNMBR         UPDATE NUMBER OF ELEMENTS IN TABLE           
         AR    RF,R0                                                            
         STC   RF,OCOMNMBR                                                      
*                                                                               
         ICM   R4,15,OCOMSTRT      POINT TO START OF COMMENT IN TABLE           
*                                                                               
OCOMRDX  DS    0H                                                               
*                                                                               
OCOMTBLX DS    0H                                                               
*                                                                               
*        PRINT COMMENT                                                          
*                                                                               
OCOMPRT  DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,MYOLEN         GET OUTPUT AREA LENGTH                       
         BZ    OCOMX               JUST IN CASE NO WIDTH                        
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         LR    RE,R3               POINT TO START OF OUTPUT                     
*                                                                               
OCOMPRTL DS    0H                                                               
*                                                                               
         CLC   OCOMID,GLARGS+8     MATCH COMMENT ID                             
         BNE   OCOMPRTD            ALL DONE                                     
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),OCOMLINE    PUT OUT COMMENT LINE                         
*                                                                               
OCOMPRTC DS    0H                                                               
*                                                                               
         LA    RE,198(RE)          BUMP TO NEXT OUTPUT LINE                     
         LA    R4,OCOMENTL(R4)     BUMP TO NEXT TABLE ENTRY                     
         B     OCOMPRTL                                                         
*                                                                               
OCOMPRTD DS    0H                                                               
*                                                                               
OCOMX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OCOMTAB  DS    0X                  COMMENT STORAGE TABLE                        
*                                                                               
OCOMNMBR DC    X'00'               NUMBER OF ENTRIES IN TABLE                   
OCOMSTRT DC    XL4'00'             FIRST LINE OF COMMENT IN TABLE               
*                                                                               
OCOMENT  DS    0X                  ENTRY IN TABLE                               
OCOMID   DS    XL(L'PCOMKNUM)      COMMENT ID                                   
OCOMLINE DS    XL70                COMMENT LINE                                 
OCOMENTL EQU   *-OCOMENT           LENGTH OF TABLE ENTRY                        
         DS    32XL(OCOMENTL)      REST OF TABLE                                
OCOMTABX EQU   *-1                                                              
*                                                                               
         TITLE 'PRWRITER - COMPUTE OUTPUT - OCOMPUTE'                           
***********************************************************************         
*                                                                     *         
*        ROUTINE TO HANDLE COMPUTE OUTPUT                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCOMPUTE NMOD1 0,**#ICMP                                                        
*                                                                               
         L     R1,GLATHID                                                       
         USING GLINTD,R1                                                        
*                                                                               
         CLC   GLLEVEL,GLDETLEV                                                 
         BE    OCOMPOK                 ONLY PRINT WHEN DETAIL                   
*                                                                               
         TM    GLARGS+11,X'80'     NO TOTAL TO PRINT                            
         BO    OCOMPX                                                           
*                                                                               
OCOMPOK  MVI   GLHOOK,GLEDIT       COMPUTE                                      
         B     OCOMPX                                                           
*                                                                               
OCOMPX   DS    0X                                                               
         XMOD1                                                                  
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - CONTRACT DISK ADDRESS - ICONDA'                      
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PASS CONTRACT DISK ADDRESS TO SORT                *         
*                                                                     *         
*EXIT    0-3(R2)    CONTRACT RECORD DISK ADDRESS                      *         
*        4(R2)      SE NUMBER                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICONDA   NMOD1 0,**#ICDA                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         OC    PBQCONDA,PBQCONDA   EXIT IF DISK ADDRESS NOT KNOWN               
         BZ    ICONDAX                                                          
*                                                                               
         MVC   0(4,R2),PBQCONDA    RETURN DISK ADDRESS                          
*                                                                               
         ICM   RE,15,PBUTLA        IF UTL ADDRESS KNOWN                         
         BZ    *+10                                                             
         MVC   4(1,R2),4(RE)          PASS SE NUMBER FOR FILES                  
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR CLIENT OF AOR SITUATION                   
         BNE   *+10                                                             
         MVC   4(1,R2),PAORSE         USE AOR SE                                
*                                                                               
ICONDAX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - CONTRACT DISK ADDRESS - OCONDA'                      
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT DATA FROM CONTRACT DATA                     *         
*          PRINT DATA FROM ALL ELEMENTS OF GIVEN TYPE                 *         
*          USE SEPARATE LINE FOR EACH ELEMENT                         *         
*                                                                     *         
*NTRY    0-3(R2)    CONTRACT RECORD DISK ADDRESS                      *         
*        4(R2)      SE NUMBER                                         *         
*                                                                     *         
*        GLARGS     X'20'- CURRENT LEVEL RATE ELEMENT                 *         
*        GLARGS+1   C'C' - TREAT AS COMMENTS SO ONLY THOSE WITH       *         
*                           ZERO RATE                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCONDA   NMOD1 0,**#OCDA                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         OC    0(5,R2),0(R2)       SKIP IF NO DISK ADDRESS AVAILABLE            
         BZ    OCONDAX                                                          
*                                                                               
*        READ RECORD USING DISK ADDRESS                                         
*                                                                               
         MVC   AIO,AIO2              USE I/O AREA 2 FOR PCONREC                 
*                                                                               
         MVC   OCDAFILE,FILENAME   SAVE CURRENT FILE NAME                       
*                                                                               
         MVC   FILENAME,=CL8'PRTFILE'   USE PRINT FILE                          
*                                                                               
         MVC   KEY+27(4),0(R2)     SET DISK ADDRESS                             
*                                                                               
         CLI   4(R2),0             IF SE NUMBER PASSED                          
         BE    *+8                                                              
         ICM   RF,15,PBUTLA        AND UTL ADDRESS KNOWN                        
         BZ    *+16                                                             
         MVC   PAOSESAV,4(RF)      SAVE SE NUMBER                               
         MVC   4(1,RF),4(R2)       SET NEEDED SE NUMBER                         
*                                                                               
         MVI   ERROR,0             INIT EROR BYTE                               
         MVI   ERROPT,C'Y'         RETURN AFTER ERROR                           
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
         MVC   FILENAME,OCDAFILE   RESTORE FILE NAME                            
         CLI   PAOSESAV,0          IF SE NUMBER SAVED                           
         BE    *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSESAV    RESTORE IT                                   
*                                                                               
         CLI   ERROR,0             EXIT ON ERRORS                               
         BNE   OCONDAX                                                          
*                                                                               
         L     R4,AIO              POINT TO RECORD                              
         USING PCONREC,R4          ESTABLISH CONTRACT RECORD                    
*                                                                               
         LA    R6,PCONREC+33       POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                                                               
OCDALOOP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE IF END OF RECORD                        
         BE    OCDADONE                                                         
*                                                                               
         CLC   0(1,R6),GLARGS      MATCH TO DESIRED ELEMENT                     
         BNE   OCDACONT                                                         
*                                                                               
         CLI   0(R6),X'20'         IF CURRENT LEVEL ELEMENT WANTED              
         BNE   OCDACLVN                                                         
*                                                                               
         USING PRBELEM,R6          ESTABLISH AS CONTRACT RATE ELEMENT           
*                                                                               
         CLI   GLARGS+1,C'C'       IF INTERESTED IN DATA AS COMMENTS            
         BNE   OCDACLV1                                                         
*                                                                               
         CP    PRBRATE,=P'0'          RATE MUST BE ZERO                         
         BNE   OCDACLVX                                                         
*                                                                               
OCDACLV1 DS    0H                                                               
*                                                                               
         MVC   0(L'PRBDESC,R3),PRBDESC PRINT SPACE DESCRIPTION                  
         LA    R3,198(R3)          BUMP TO NEXT PRINT LINE                      
*                                                                               
OCDACLVX DS    0H                                                               
*                                                                               
         B     OCDACONT                                                         
*                                                                               
OCDACLVN DS    0H                                                               
*                                                                               
OCDACONT DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            BUMP TO NEXT ELEMENT IN RECORD               
         LA    R6,0(RF,R6)                                                      
         B     OCDALOOP                                                         
OCDADONE DS    0H                                                               
*                                                                               
OCONDAX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OCDAFILE DS    CL8                 CURRENT FILE NAME SAVEAREA                   
*                                                                               
         DROP  R4,R6                                                            
*                                                                               
         TITLE 'PRWRITER - CONTRACT UNIT / ACTIVITY - OCONUNAC'                 
***********************************************************************         
*                                                                     *         
*        ROUTINE TO COMBINE CON-UNIT AND BACTIVE INTO ONE - OUTPUT    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCONUNAR NMOD1 0,**#OCA                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R1,GLADTENT         ESTABLISH OUTPUT DSECT                       
         USING DROD,R1                                                          
*                                                                               
         SR    R5,R5                                                            
*                                                                               
         TM    GLINDS,GLTOTLIN     IF TOTAL FIELD                               
         BO    *+12                  USE SAVED COLUMN LENGTH                    
         ICM   R5,1,DROLEN         IF NO COLUMN WIDTH GIVEN                     
         BNZ   *+8                                                              
         ICM   R5,1,OCAOLEN        USE SAVED COLUMN WIDTH                       
         BNZ   *+8                                                              
         LA    R5,15               DEFAULT TO 15 IF NONE GIVEN                  
*                                                                               
         STC   R5,OCAOLEN          SAVE COLUMN WIDTH                            
*                                                                               
         SH    R5,=H'2'            ACTIVITY USES LAST 2 SPACES                  
         LA    R3,0(R5,R3)         ACTIVITY OPUTPUT AREA                        
*                                                                               
         GOTO1 =A(OACTIVE)         GET ACTIVITY INDICATOR                       
*                                                                               
         STC   R5,DROLEN           SET TRUNCATED LENGTH FOR CON-UNIT            
*                                                                               
OCONUNAX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OCAOLEN  DC    H'0'                COLUMN WIDTH                                 
         DROP  R1                                                               
*                                                                               
         TITLE 'PRWRITER - CUSTOM COLUMN INPUT - ICC'                           
***********************************************************************         
*                                                                     *         
*        CUSTOM COLUMN INPUT                                          *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*        GLARGS     C'B'  BUY RECORD DATA                             *         
*        GLARGS+1-2 XL2   CUSTOM COLUMN SEQ NUMBER                    *         
*        GLARGS+3   XL1   DATA TYPE                                   *         
*        GLARGS+4   XL1   TOTALLING OPTION - T OR A                   *         
*                                                                     *         
*EXIT                                                                 *         
*        R2==>  DATA FROM BUY                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICC      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   SKIP IF NOT A BUY IN CORE                    
         BNE   ICCX                                                             
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELM IN BUY                    
         SR    RF,RF                                                            
*                                                                               
ICCLOOP  DS    0H                                                               
*                                                                               
         USING BYCCELD,R6          ESTABLISH CCOL ELM                           
*                                                                               
         CLI   BYCCELM,0           CHECK FOR END OF RECORD                      
         BE    ICCDONE                                                          
*                                                                               
         CLI   BYCCELM,BYCCIDQ     MATCH ON CCOL ELM CODE                       
         BNE   ICCCONT                                                          
*                                                                               
         CLC   BYCCSQN,GLARGS+1    MATCH ON CCOL SEQ #                          
         BE    ICCFND                                                           
*                                                                               
ICCCONT  DS    0H                                                               
*                                                                               
         IC    RF,BYCCLEN          GET ELEMENT LENGTH                           
         LA    R6,BYCCELD(RF)      POINT TO NEXT ELEMENT                        
         B     ICCLOOP                                                          
*                                                                               
ICCDONE  DS    0H                  END OF CCOL ELMS                             
         B     ICCX                                                             
*                                                                               
ICCFND   DS    0H                  CCOL FOUND                                   
*                                                                               
*        RETRIEVE DATA FROM ELEMENT                                             
*                                                                               
         SR    RF,RF                                                            
         IC    RF,BYCCLEN          GET ELEMENT LENGTH                           
*                                                                               
         AHI   RF,-BYCCHDRL        DECREMENT BY HEADER LENGTH                   
         BNP   ICCX                MUST HAVE SOME DATA                          
*                                                                               
         LR    R0,RF               SAVE RF                                      
*                                                                               
         TM    PBUYCNTL,X'80'      IF BUY IS DELETED                            
         BNO   ICC10                                                            
*                                                                               
*                                  IF ZEROING NUMERIC FIELDS                    
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFDLZ)),0                
*                                                                               
         OC    8(4,R1),8(R1)       CHECK IF FILTER FOUND                        
         BZ    ICC10                  NONE FOUND                                
*                                                                               
         LR    RF,R0               RESTORE RF                                   
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         SLA   RF,4                SHIFT TO LEFT NYBBLE FOR LENGTH              
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         TP    BYCCDATA(0)         IF CCOL DATA IS PACKED                       
*                                                                               
         BNZ   ICC10                                                            
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         ZAP   BYCCDATA(0),=P'0'      ZERO INPUT DATA                           
*                                                                               
         B     ICC20                                                            
*                                                                               
ICC10    DS    0H                                                               
*                                                                               
         LR    RF,R0               RESTORE RF                                   
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),BYCCDATA    PASS DRIVER COLUMN DATA                      
*                                                                               
ICC20    DS    0H                                                               
*                                                                               
         CLI   GLARGS+4,C'A'       IF AVERAGE TOTAL                             
         BNE   *+10                                                             
         ZAP   8(8,R2),=P'1'          PASS ON A COUNTER                         
*                                                                               
ICCX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
         TITLE 'PRWRITER - CUSTOM COLUMN OUTPUT - OCC'                          
***********************************************************************         
*                                                                     *         
*        CUSTOM COLUMN OUTPUT                                         *         
*                                                                     *         
*NTRY                                                                 *         
*        R2     ==>  INPUT                                            *         
*        GLARGS     C'B'  BUY RECORD DATA                             *         
*        GLARGS+1-2 XL2   CUSTOM COLUMN SEQ NUMBER                    *         
*        GLARGS+3   XL1   DATA TYPE                                   *         
*        GLARGS+4   XL1   TOTALLING OPTION - T OR A                   *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCC      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC                                                          
*                                                                               
         LR    R4,R3               DEFAULT TO DRIVER PRINT AREA                 
*                                                                               
*        BUILD LABEL FOR TOTALS AND HEADLINES                                   
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OCCLBLX                                                          
*                                                                               
*        BUILD LABEL AREA FOR TOTALS AND HEADLINES                              
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREAS                            
         MVC   CODEAREA,SPACES                                                  
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL AREA                             
*                                                                               
         LA    R4,NAMEAREA         BUILD OUTPUT IN NAMEAREA                     
*                                                                               
OCCLBLX  DS    0H                                                               
*                                                                               
*        AVERAGING                                                              
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BNO   OCCAVGN                                                          
*                                                                               
         CLI   GLARGS+4,C'A'       AND AVERAGING                                
         BNE   OCCAVGN                                                          
*                                                                               
         OC    0(8,R2),0(R2)       SKIP IF NO DATA                              
         BZ    OCCAVGX                                                          
*                                                                               
         ZAP   OCCDIV,0(8,R2)      DIVIDE TOTAL                                 
         SRP   OCCDIV,1,0          SCALE UP FOR ROUNDING                        
         DP    OCCDIV,8(8,R2)      BY COUNTER                                   
         SRP   OCCQUOT,64-1,5      ROUND                                        
         ZAP   0(8,R2),OCCQUOT     RESET OUTPUT                                 
*                                                                               
OCCAVGX  DS    0H                                                               
*                                                                               
         B     OCCEDIT                                                          
*                                                                               
OCCAVGN  DS    0H                                                               
*                                                                               
*        PRINT PERIOD                                                           
*                                                                               
         CLI   GLARGS+3,C'P'       IF PERIOD                                    
         BNE   OCCPERN                                                          
*                                                                               
         GOTO1 DATCON,DMCB,(X'13',(R2)),(17,(R4))  PRINT PERIOD                 
*                                                                               
OCCPERX  DS    0H                                                               
*                                                                               
         B     OCCGOUT                                                          
*                                                                               
OCCPERN  DS    0H                                                               
*                                                                               
*        PRINT DATE                                                             
*                                                                               
         CLI   GLARGS+3,C'D'       IF DATE                                      
         BNE   OCCDATN                                                          
*                                                                               
         GOTO1 DATCON,DMCB,(X'03',(R2)),(17,(R4))  PRINT PERIOD                 
*                                                                               
OCCDATX  DS    0H                                                               
*                                                                               
         B     OCCGOUT                                                          
*                                                                               
OCCDATN  DS    0H                                                               
*                                                                               
*        TEXT FIELDS                                                            
*                                                                               
OCCTXT   DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'T'       IF TEXT FIELD                                
         BNE   OCCTXTN                                                          
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OCCEDIT                NO - LET DRIVER DO IT                     
*                                                                               
         L     R1,GLADTENT         ESTABLISH DRIVETABLE ENTRY                   
         USING DROD,R1                                                          
*                                                                               
         CLI   DROEL,X'30'         SKIP IF NOT AN OUTPUT ELEMENT                
         BNE   OCCTXT10                                                         
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,DROLEN         GET COLUMN WIDTH                             
         BZ    OCCTXTX             MUST HAVE A LENGTH                           
*                                                                               
         LA    RF,L'NAMEAREA         DEFAULT TO LENGTH OF NAMEAREA              
*                                                                               
         CR    RF,R0               USE SMALLER OF TWO LENGTHS                   
         BNH   *+6                                                              
         LR    RF,R0                                                            
*                                                                               
         DROP  R1                                                               
*                                                                               
         LA    R1,0(R2)            START OF DATA                                
*                                                                               
         B     OCCTXT20                                                         
*                                                                               
OCCTXT10 DS    0H                  TOTAL ELEMENT - FIND FIRST SPACE             
*                                                                               
         LA    RF,0(R2)            START OF INPUT                               
*                                                                               
         CLI   0(RF),C' '          FIND FIRST SPACE                             
         BNH   *+12                                                             
         AHI   RF,1                NEXT INPUT CHARACTER                         
         B     *-12                                                             
*                                                                               
         LA    R1,0(R2)            START OF INPUT                               
         SR    RF,R1               INPUT LENGTH                                 
         BZ    OCCTXTX             NO INPUT                                     
*                                                                               
OCCTXT20 DS    0H                                                               
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   NAMEAREA(0),0(R1)                                                
*                                                                               
OCCTXTX  DS    0H                                                               
*                                                                               
         B     OCCGOUT                USE GENOUT                                
*                                                                               
OCCTXTN  DS    0H                                                               
*                                                                               
         B     OCCEDIT             HAVE DRIVER PRINT                            
*                                                                               
*        USE GENOUT FOR TOTALS AND HEADLINES                                    
*                                                                               
OCCGOUT  DS    0H                                                               
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OCCX                                                             
*                                                                               
         GOTOR GENOUTA             PRINT WITH LABELS                            
*                                                                               
         B     OCCX                                                             
*                                                                               
OCCEDIT  DS    0H                                                               
*                                                                               
         MVI   GLHOOK,GLEDIT       LET DRIVER HANDLE IT                         
*                                                                               
         B     OCCX                                                             
*                                                                               
OCCX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OCCQUOT  DS    0PL8                QUOTIENT                                     
OCCDIV   DS    PL16                DIVIDEND                                     
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - COST PER THOUSAND INPUT - ICPM'                      
***********************************************************************         
*                                                                     *         
*        COST PER THOUSAND INPUT                                      *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*        GLARGS   -  SAME AS THOSE FOR FINDING IMPS VIA IELM          *         
*                                                                     *         
*EXIT                                                                 *         
*        R2==>  PL8(IMPS),PL8(COST)                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICPM     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         GOTO1 =V(IELM)            FIND IMPRESSIONS                             
*                                                                               
         OC    0(5,R2),0(R2)       SKIP IF NO IMPRESSIONS FOUND                 
         BZ    ICPMX                                                            
*                                                                               
         ZAP   ICPMIMPS,0(5,R2)    SAVE IMPRESSIONS                             
*                                                                               
         XC    0(8,R2),0(R2)       CLEAR INPUT AREA                             
*                                                                               
         MVC   ICPMARGS,GLARGS     SAVE ARGUMENTS                               
*                                                                               
         MVC   GLARGS(5),ICPMORDG  SET TO GET ORDERED GROSS                     
*                                                                               
         GOTO1 =V(IDOLLAR)         GET $ORDG                                    
*                                                                               
         MVC   GLARGS,ICPMARGS     RESTORE ARGUMENTS                            
*                                                                               
         ZAP   ICPMCOST,0(8,R2)    SAVE COST                                    
*                                                                               
         ZAP   0(8,R2),ICPMIMPS    FILL INPUT BUCKETS                           
         ZAP   8(8,R2),ICPMCOST                                                 
*                                                                               
ICPMX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
ICPMORDG DC    C'BO1',XL13'00'     ARGUMENTS FOR ORDERED GROSS                  
ICPMARGS DS    CL16                ARGUMENTS SAVEAREA                           
ICPMIMPS DS    PL8                 IMPRESSIONS SAVEAREA                         
ICPMCOST DS    PL8                 INSERTION COST                               
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - COST PER THOUSAND OUTPUT - OCPM'                     
***********************************************************************         
*                                                                     *         
*        COST PER THOUSAND OUTPUT                                     *         
*                                                                     *         
*NTRY                                                                 *         
*        R2     ==>  PL8(IMPRESSIONS),PL8(GROSS COST)                 *         
*                                                                     *         
*EXIT                                                                 *         
*        R2==>  PL8(CPM)                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OCPM     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         OC    0(8,R2),0(R2)       MAKE SURE DIVISOR PACKED                     
         BZ    OCPMX                                                            
*                                                                               
         CP    0(8,R2),=P'0'       NO DIVISION BY ZERO                          
         BE    OCPMX                                                            
*                                                                               
         ZAP   OCPMDIVD,8(8,R2)    COPY COST                                    
*                                                                               
         SRP   OCPMDIVD,4,0        SCALE UP FOR THOUSANDS AND ROUNDING          
*                                                                               
         DP    OCPMDIVD,0(8,R2)    DIVIDE BY IMPS                               
*                                                                               
         SRP   OCPMQUOT,64-1,5     ROUND                                        
*                                                                               
******   DRNDP 0(8,R2),8(8,R2),OCPMQUOT,WORK=OCPMDIVD                           
*                                                                               
         ZAP   0(8,R2),OCPMQUOT    RETURN CPM TO DRIVER                         
*                                                                               
         MVI   GLHOOK,GLEDIT       HAVE DRIVER EDIT                             
*                                                                               
OCPMX    DS    0H                                                               
                                                                                
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OCPMDIVD DS    0PL16               DIVIDEND                                     
OCPMQUOT DS    PL8                 QUOTIENT                                     
OCPMRMDR DS    PL8                 REMAINDER                                    
OCPMDVSR DS    PL8                 DIVISOR                                      
*                                                                               
         TITLE 'PRWRITER - CASH APPLIED DATA - INPUT - ICSH'                    
***********************************************************************         
*                                                                     *         
*        CASH APLIED DATA FIELDS                                      *         
*                                                                     *         
*NTRY    GLARGS     C'Q'  - DATA IN CASH APPLIED ELEMENTS             *         
*          GLARGS+1    C'D'  - CASH DATE                              *         
*            GLARGS+2     C'C' -  CLIENT CHECK DATE                   *         
*                         C'D' -  CLIENT CHECK DEPOSIT DATE           *         
*                      C'$'  - CASH AMOUNT                            *         
*                      C'%'  - CASH APPLIED PERCENT                   *         
*                      C'#'  - CLIENT CHECK NUMBER                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ICSH     NMOD1 0,**#ICSH                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        HANDLE DATA IN CASH APPLIED ELEMENTS                                   
*                                                                               
         ICM   R5,15,PBMBTELA      ESTABLISH MEDIA TRANSFER ELEMENT             
         BZ    ICSHX                  DROP DATA IF MISSING                      
*                                                                               
         USING MBTELD,R5                                                        
*                                                                               
         ICM   R3,15,PBTRNELA      ESTABLISH CASH TRANSACTION ELEMENT           
         BZ    ICSHX                  DROP DATA IF MISSING                      
*                                                                               
         USING TRNELD,R3                                                        
*                                                                               
         CLI   GLARGS,C'Q'         EXIT IF NOT CASH APPLIED FIELD               
         BNE   ICSHX                                                            
*                                                                               
         CLI   TRNEL,X'FF'         IF UNAPPLIED CASH ELEM                       
         BNE   ICSHNADX                                                         
*                                                                               
*        SKIP IF NON ADD CASHFLOW KEYWORD                                       
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFNAD)),0                
*                                                                               
         OC    8(4,R1),8(R1)                                                    
         BNZ   ICSHX               DROP IF COLUMN MODIFIER FOUND                
*                                                                               
ICSHNADX DS    0H                                                               
*                                                                               
*        FIND FOLLOWING RECEIVABLE ALLOCATION ELEMENT                           
*                                                                               
         LR    R6,R3               FIND FOLLOWING RECEIVABLE ALLOCATION         
         SR    RF,RF                                                            
*                                                                               
ICSHRALL DS    0H                                                               
*                                                                               
         USING RALELD,R6           ESTABLISH RECEIVABLE ALLOC ELM               
*                                                                               
         IC    RF,TRNLN            ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
*                                                                               
         CLI   RALEL,0             DONE IF END OF RECORD REACHED                
         BE    ICSHRALD                                                         
*                                                                               
         CLI   RALEL,TRNELQ        DONE IF NEW TRANSACTION ELM REACHED          
         BE    ICSHRALD                                                         
*                                                                               
         CLI   RALEL,RALELQ        FIND RECEIVABLE ALLOC ELM                    
         BE    ICSHRALF                                                         
*                                                                               
ICSHRALC DS    0H                                                               
*                                                                               
         B     ICSHRALL                                                         
*                                                                               
ICSHRALD DS    0H                                                               
*                                                                               
         SR    R6,R6               NO RECEIVABLE ALLOC ELEMENT FOUND            
*                                                                               
ICSHRALF DS    0H                                                               
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+1,C'D'       CASH DATES OF VARIOUS SORTS                  
         BE    ICSHCDT                                                          
*                                                                               
         CLI   GLARGS+1,C'%'       CASH PER CENT                                
         BE    ICSHPCT                                                          
*                                                                               
         CLI   GLARGS+1,C'#'       CLIENT CHECK NUMBER                          
         BE    ICSHCHK                                                          
*                                                                               
*        ELSE MUST BE DOLLAR AMOUNT                                             
*                                                                               
         TM    PBQOPTS,PBQOXPD     IF PAY PENDING OPTION                        
         BNO   ICSHXPDX                                                         
*                                                                               
         LTR   R6,R6                  SKIP IF NO ALLOCATION ELEMENT             
         BZ    ICSHX                                                            
*                                                                               
ICSHXPDX DS    0H                                                               
*                                                                               
         L     RF,=A(ICLRDLR)      ASSUME BILLED AMOUNT NEED                    
*                                                                               
         CLC   GLARGS(3),=C'QB$'   IF ACTUAL AMOUNT WANTED                      
         BNE   *+8                                                              
         L     RF,=A(IBLD)            USE DIFFERENT ROUTINE                     
*                                                                               
         GOTO1 (RF)                FIND CORESSPONDING BILLED AMOUNT             
*                                                                               
         B     ICSHPCT             GET PER CENT RECEIVED                        
*                                                                               
*        VARIOUS DATES                                                          
*                                                                               
ICSHCDT  DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'A'       IF CASH APPLIED DATE                         
         BNE   ICSHCDT1                                                         
*                                                                               
         MVC   0(3,R2),TRNDATE        RETURN TRANSACTION DATE                   
*                                                                               
         B     ICSHCDT5                                                         
*                                                                               
ICSHCDT1 DS    0H                                                               
*                                                                               
         LTR   R6,R6               SKIP IF NO RECEIVABLE ALLOC AVAIL            
         BZ    ICSHCDT5                                                         
*                                                                               
         CLI   GLARGS+2,C'C'       IF CLIENT CHECK DATE                         
         BNE   ICSHCDT2                                                         
*                                                                               
         CLI   RALTYPE,RALTALC        IF REGULAR ALLOCATION ELEMENT             
         BNE    *+14                                                            
         MVC   0(3,R2),RALADAT           RETURN CLIENT CHECK DATE               
         B     ICSHCDT5                                                         
*                                                                               
         CLI   RALTYPE,RALTOFS        IF OFFSET             ELEMENT             
         BNE    *+18                                                            
         MVC   0(3,R2),RALODAT           RETURN OFFSET DATE                     
         MVI   3(R2),C'O'                SET OFFSET INDICATOR                   
         B     ICSHCDT5                                                         
*                                                                               
         CLI   RALTYPE,RALTWOF        IF WRITE OFF          ELEMENT             
         BNE    *+18                                                            
         MVC   0(3,R2),RALWDAT           RETURN WRITE OFF DATE                  
         MVI   3(R2),C'W'                SET WRITE OFF INDICATOR                
         B     ICSHCDT5                                                         
*                                                                               
ICSHCDT2 DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'D'       IF CHECK DEPOSIT DATE                        
         BNE   ICSHCDT3                                                         
*                                                                               
         CLI   RALTYPE,RALTALC        IF REGULAR ALLOCATION ELEMENT             
         BNE    *+14                                                            
         MVC   0(3,R2),RALADEP           RETURN CHECK DEPOSITED DATE            
         B     ICSHCDT5                                                         
*                                                                               
         CLI   RALTYPE,RALTOFS        IF OFFSET             ELEMENT             
         BNE    *+18                                                            
         MVC   0(3,R2),RALODAT           RETURN OFFSET DATE                     
         MVI   3(R2),C'O'                SET OFFSET INDICATOR                   
         B     ICSHCDT5                                                         
*                                                                               
         CLI   RALTYPE,RALTWOF        IF WRITE OFF          ELEMENT             
         BNE    *+18                                                            
         MVC   0(3,R2),RALWDAT           RETURN WRITE OFF DATE                  
         MVI   3(R2),C'W'                SET WRITE OFF INDICATOR                
         B     ICSHCDT5                                                         
*                                                                               
ICSHCDT3 DS    0H                                                               
*                                                                               
ICSHCDT5 DS    0H                                                               
*                                                                               
         CLI   TRNEL,X'FF'         IF UNAPPLIED CASH ELEM                       
         BNE   ICSHCDT7                                                         
*                                                                               
         TM    PBQOPTS,PBQOXPD        SKIP IF PAYPENDING OPTION                 
         BO    ICSHCDT7                                                         
*                                                                               
         CP    TRNAMNT,=P'0'       IF CREDIT                                    
         BH    ICSHCDT6                                                         
*                                                                               
         CLI   PBQPRFW0+13,C'Y'    SKIP IF USING TODAY'S DATE FOR CR'S          
         BE    ICSHCDT6                                                         
*                                                                               
         L     R3,PBBHDELA               POINT TO BILL HEADER RECORD            
         USING PBILLREC,R3                                                      
*                                                                               
         GOTO1 DATCON,DMCB,(0,PBILLDAT),(1,0(R2)) USE BILL RUN DATE             
*                                                                               
         B     ICSHX                                                            
*                                                                               
ICSHCDT6 DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(3,PBBTODAY),(1,0(R2)) USE TODAY'S DATE              
*                                                                               
         MVI   3(R2),C'*'             SET UNAPPLIED INDICATOR                   
*                                                                               
ICSHCDT7 DS    0H                                                               
*                                                                               
         B     ICSHX               DONE                                         
*                                                                               
*              CASH PER CENT RECEIVED                                           
*                                                                               
ICSHPCT  DS    0H                                                               
*                                                                               
         USING TRNELD,R3                                                        
*                                                                               
*        CALCULATE PERCENTAGE OF CASH APPLIED                                   
*                                                                               
         ZAP   ICSHPOST,MBTPOST    INIT POSTED AMOUNT                           
*                                                                               
*        FIND POSTING TRANSACTION ELEMENT FOLLOWING                             
*              MEDIA POSTING ELEMENT                                            
*                                                                               
         LR    RE,R5               COPY MBTELD POINTER                          
         SR    RF,RF                                                            
         ZAP   ICSHPST1,=P'0'      INIT POST BUCKET                             
*                                                                               
ICSHPSTL DS    0H                                                               
*                                                                               
         IC    RF,TRNLN-TRNELD(RE)                                              
         LA    RE,0(RF,RE)         POINT TO NEXT ELEMENT                        
*                                                                               
         CLI   TRNEL-TRNELD(RE),0  DONE AT END OF ELEMENTS                      
         BE    ICSHPSTD                                                         
*                                                                               
         CLI   TRNEL-TRNELD(RE),TRNELQ    SKIP IF NOT TRANSACTION ELM           
         BNE   ICSHPSTC                                                         
*                                                                               
         CLI   TRNTYPE-TRNELD(RE),X'06'     SKIP IF NOT ORIG POST TYPE          
         BE    *+8                                                              
         CLI   TRNTYPE-TRNELD(RE),X'09'     SKIP IF NOT ORIG POST TYPE          
         BNE   ICSHPSTC                                                         
*                                                                               
         CR    RE,R3               SKIP IF PAST CURRENT TRANSACTION ELM         
         BNL   ICSHPSTC                                                         
*                                                                               
         AP    ICSHPST1,TRNAMNT-TRNELD(L'TRNAMNT,RE)   RESET POST AMNT          
*                                                                               
ICSHPSTC DS    0H                                                               
*                                                                               
         B     ICSHPSTL                                                         
*                                                                               
ICSHPSTD DS    0H                                                               
*                                                                               
         CP    ICSHPST1,=P'0'      IF TRANSACTION ELEMENTS FOUND                
         BE    *+10                                                             
         ZAP   ICSHPOST,ICSHPST1      USE SUM AS POSTED AMOUNT                  
*                                                                               
         CP    ICSHPOST,=P'0'      IF NOTHING POSTED                            
         BE    ICSHX                                                            
*                                                                               
         CLI   TRNEL,X'FF'         X'FF' ELEMENT?                               
         BNE   *+14                NO                                           
         CP    TRNAMNT,=P'0'       HAVE $0 AMOUNT?                              
         BE    *+14                YES - TREAT AS IF CASH = POSTING             
         CP    ICSHPOST,TRNAMNT    IF CASH =POSTING                             
         BNE   *+14                                                             
         ZAP   ICSHSPCT,=PL4'100000'  RETURN 100%                               
         B     ICSHPCT1                                                         
*                                                                               
         ZAP   DUB,TRNAMNT         IF POST AND TRANSACTION AMOUNTS              
         AP    DUB,ICSHPOST           CANCEL EACH OTHER                         
         BNZ   *+14                                                             
         ZAP   ICSHSPCT,=PL4'-100000' RETURN -100%                              
         B     ICSHPCT1                                                         
*                                                                               
         ZAP   DUB,TRNAMNT         COPY CASH APPLIED                            
         CVB   RF,DUB                                                           
*                                                                               
         LPR   RE,RF                                                            
         ST    RE,FULL             SAVE ABSOLUTE VALUE                          
*                                                                               
         M     RE,=F'100000'       *100.000 FOR DECIMALS                        
*                                                                               
         ZAP   DUB,ICSHPOST                                                     
         CVB   R1,DUB                                                           
         LPR   R0,R1               SAVE ABSOLUTE VALUE                          
*                                                                               
         LPR   R4,RE               MAKE SURE QUOTIENT IS 1 REGISTER             
*                                                                               
         CR    R0,R4               COMPARE ABSOLUTE VALUES                      
         BNH   ICSHPCT0                                                         
*                                                                               
         LTR   R0,R0               IF POSTED ZERO                               
         BZ    ICSHPCT0                                                         
*                                                                               
         CHI   R0,1000             MAKE SURE AT LEAST $10                       
         BNL   ICSHPCTA                                                         
*                                                                               
ICSHPCT0 DS    0H                                                               
*                                                                               
         ZAP   ICSHSPCT,=PL4'100000'  RETURN 100%                               
         B     ICSHPCT1                                                         
*                                                                               
ICSHPCTA DS    0H                                                               
*                                                                               
         DR    RE,R1               CASH/BILL*100.00                             
         SLL   RE,1                DOUBLE REMANDER                              
         CR    RE,R1                                                            
         BL    *+8                                                              
         A     RF,=F'1'            ROUND UP                                     
*                                                                               
         CVD   RF,DUB                                                           
         ZAP   ICSHSPCT,DUB        RETURN PERCENTAGE                            
*                                                                               
ICSHPCT1 DS    0H                                                               
*                                                                               
         CLC   GLARGS(2),=C'Q%'    IF PURE PCT                                  
         BNE   *+20                                                             
         ZAP   0(8,R2),ICSHSPCT       RETURN PER CENT                           
         SRP   0(8,R2),64-1,5         ROUND                                     
         B     ICSHAMTX               DONE                                      
*                                                                               
         CP    ICSHSPCT,=PL4'100000'  DONE IF 100.000%                          
         BE    ICSHAMTX                                                         
*                                                                               
         OC    0(8,R2),0(R2)       SKIP IF NO BILLED DATA                       
         BZ    ICSHPCT2                                                         
*                                                                               
         ZAP   WORK(16),ICSHSPCT   USE PACKED FOR CALCS                         
         MP    WORK(16),0(8,R2)                                                 
         SRP   WORK(16),64-5,5     ROUND TO 2 DECIMALS                          
         ZAP   0(8,R2),WORK(16)                                                 
*                                                                               
ICSHPCT2 DS    0H                                                               
*                                                                               
         OC    8(8,R2),8(R2)       SKIP IF NO BILLED DATA                       
         BZ    ICSHPCT3                                                         
*                                                                               
         CVB   RF,ICSHSPCT         USE BINARY FOR CALCS                         
         ZAP   DUB,8(8,R2)                                                      
         CVB   RE,DUB                                                           
         MR    RE,RE                                                            
         CVD   RF,DUB                                                           
         ZAP   8(8,R2),DUB                                                      
*                                                                               
         SRP   8(8,R2),64-5,5      ROUND TO 2 DECIMALS                          
*                                                                               
ICSHPCT3 DS    0H                                                               
*                                                                               
ICSHAMTX DS    0H                                                               
         B     ICSHX                                                            
*                                                                               
*        CLIENT CHECK NUMBER                                                    
*                                                                               
ICSHCHK  DS    0H                                                               
*                                                                               
         CLI   TRNLN,TRNLN1Q       SKIP IF NO NARRATIVE AVAILABLE               
         BNH   ICSHCHKX                                                         
*                                                                               
         CLI   RALTYPE,RALTALC     SKIP IF NOT REGULAR ALLOCATION ELM           
         BNE   ICSHCHKX                                                         
*                                                                               
         MVC   0(6,R2),RALAREF     RETURN CLIENT CHECK NUMBER                   
*                                                                               
ICSHCHKX DS    0H                                                               
*                                                                               
         B     ICSHX               DONE                                         
*                                                                               
ICSHX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
         DS    0D                                                               
ICSHSPCT DS    PL8                 CASH APPLIED PER CENT SAVEAREA               
ICSHPOST DS    PL8                 AMOUNT POSTED TO ACC FILE                    
ICSHPST1 DS    PL8                 ACTUAL AMOUNT POSTED TO ACC FILE             
ICSHWORK DS    CL32                CASH APPLIED WORKAREA                        
*                                                                               
NARRD    DS    0D                  NARRATIVE DSECT                              
         DC    C'CHECK NUMBER '                                                 
NARCHK#  DS    CL6                 CLIENT CHECK NUMBER                          
         DC    C' DATED '                                                       
NARCHKDT DS    CL8                 CLIENT CHECK DATE                            
         DC    C' DEPOSITED ON '                                                
NARDEPDT DS    CL8                 CLIENT CHECK DEPOSIT DATE                    
*                                                                               
         DROP  R5,R6,R3                                                         
*                                                                               
         TITLE 'PRWRITER - OUTPUT = INPUT - IDATA'                              
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT INPUT UNCHANGED FROM ARGUMENTS              *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*        GLARGS   -  X'00' BECAUSE IT IS INDEPENDENT OF ALL RECORDS   *         
*        GLARGS+1 -  AL1 OF CONSTANT TO SEND TO SORT                  *         
*        GLARGS+2 -  START OF CONSTANT FOR SORT                       *         
*                                                                     *         
*        R2==>  DRIVER INPUT AL1(LENGTH),C'DATA'                      *         
*        R3==>  DRIVER PRINT AREA                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IDATA    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,GLARGS+1       GET DATA LENGTH                              
         BZ    IDATAX              NO DATA                                      
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),GLARGS+2    SEND DATA TO SORT                            
*                                                                               
*                                                                               
IDATAX   DS    0H                                                               
         GOTO1 GENOUTA                                                          
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - OUTPUT = INPUT - ODATA'                              
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT INPUT UNCHANGED. MAY HAVE TO ADD LABEL      *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*        GLARGS   -  INDICATES WHERE OUTPUT IS TO PRINT IN HEADLINES  *         
*                    C'C' - CODEAREA                                  *         
*                    C'N' - NAMEAREA                                  *         
*        GLARGS+1 -  FILL CHARACTER IN CASE THERE IS NO DATA          *         
*        GLARGS+2 -  LENGTH OF DATA IF NOT GIVEN IN INPUT             *         
*                                                                     *         
*        R2==>  DRIVER INPUT AL1(LENGTH),C'DATA'                      *         
*                 LENGTH CONSIDERED MISSING IF OVER C' ' IN VALUE     *         
*        R3==>  DRIVER PRINT AREA                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ODATA    NMOD1 0,**#ODA                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        BUILD LABEL AREA FOR TOTALS AND HEADLINES                              
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREAS                            
         MVC   CODEAREA,SPACES                                                  
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   ODALBLX                                                          
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL AREA                             
*                                                                               
ODALBLX  DS    0H                                                               
*                                                                               
         LA    RE,NAMEAREA         DEFAULT TO NAMEAREA                          
*                                                                               
         CLI   GLARGS,C'C'         CHECK IF CODEAREA TO BE USED                 
         BNE   *+8                                                              
         LA    RE,CODEAREA         PRINT IN CODEAREA                            
*                                                                               
         LA    RF,L'NAMEAREA       MAX LENGTH OF OUTPUT AREA                    
*                                                                               
         CLI   0(R2),C' '          IF FIRST BYTE IS LESS THAN SPACE             
         BNL   ODATA1                 THEN WE HAVE A LENGTH                     
*                                                                               
         CLM   RF,1,0(R2)          IF DATA SHORTER THAN AREA                    
         BNH   *+12                                                             
         ICM   RF,1,0(R2)             USE DATA LENGTH                           
         BZ    ODATAX                 THERE MUST BE DATA                        
*                                                                               
         LA    R1,1(R2)            START OF DATA                                
*                                                                               
         B     ODATA2              WE HAVE DATA LENGTH                          
*                                                                               
ODATA1   DS    0H                  HAVE PURE DATA WITH NO LENGTH BYTE           
*                                                                               
         L     R1,GLADTENT         ESTABLISH DRIVETABLE ENTRY                   
         USING DROD,R1                                                          
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,DROLEN         GET COLUMN WIDTH                             
         BZ    ODATAX              MUST HAVE A LENGTH                           
*                                                                               
         LR    RF,R0               DEFAULT TO COLUMN WIDTHH                     
*                                                                               
         CLI   GLARGS+2,0          IF MAX DATA LENGTH GIVEN                     
         BE    *+8                                                              
         ICM   RF,1,GLARGS+2          USE AS DEFAULT LENGTH                     
*                                                                               
         CR    RF,R0               USE SMALLER OF TWO LENGTHS                   
         BNH   *+6                                                              
         LR    RF,R0                                                            
*                                                                               
         DROP  R1                                                               
*                                                                               
         LA    R1,0(R2)            START OF DATA                                
*                                                                               
ODATA2   DS    0H                                                               
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(R1)                                                    
*                                                                               
ODATXTX  DS    0H                                                               
*                                                                               
*        IF A FILL CHARACTER IS GIVEN AND THERE IS NOTHIN TO PRINT              
*           THE SYSTEM FILLS IN THE OUTPUT WITH THE FILL CHARACTER              
*                                                                               
ODAFILL  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,0          IF THERE IS A FILL CHARACTER GIVEN           
         BE    ODAFILLX                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         CLC   0(0,RE),SPACES      AND THERE IS NO DATA IN FIELD                
         BH    ODAFILLX                                                         
*                                                                               
         LA    R0,1(RF)            NUMBER OF OUTPUT POSITIONS                   
         LA    R1,0(RE)            START OF OUTPUT                              
*                                                                               
         MVC   0(1,R1),GLARGS+1    PUT OUT FILL CHARACTER                       
         LA    R1,1(R1)            BUMP OUTPUT POINTER                          
         BCT   R0,*-10                                                          
*                                                                               
ODAFILLX DS    0H                                                               
*                                                                               
ODATAX   DS    0H                                                               
         GOTO1 GENOUTA                                                          
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - DATE FIELD - OUTPUT - ODATE'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT A DATE                                      *         
*                                                                     *         
*NTRY    GLARGS   = INPUT  DATE FORMAT FOR DATCON                     *         
*        GLARGS+1 = OUTPUT DATE FORMAT FOR DATCON                     *         
*        GLARGS+2 = DISPLACEMENT OF DATE IN INPUT                     *         
*        GLARGS+3 = DISPLACEMENT OF POSSIBLE TRAILING CH IN INPUT     *         
*        PBQPOPT    PBQPOYYM   DATE IN YYMMDD FORMAT                  *         
*                   PBQPOCTY   DATE HAS CENTURY IN YEAR               *         
*                                                                     *         
*        R2==>  DRIVER INPUT                                          *         
*        R3==>  DRIVER PRINT AREA                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ODATE    NMOD1 0,**#ODT                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVC   NAMEAREA,SPACES     INIT OUTPUT AREAS                            
         MVC   LABLAREA,SPACES                                                  
         MVC   CODEAREA,SPACES                                                  
*                                                                               
*        BUILD LABEL AREA FOR HEADLINES                                         
*                                                                               
         CLI   MYPOSO,C'H'         SKIP IF NOT HEADLINE                         
         BNE   ODTLBLX                                                          
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL AREA                             
*                                                                               
ODTLBLX  DS    0H                                                               
*                                                                               
         LTR   R2,R2               SKIP IF NO OUTPUT                            
         BZ    ODATEX                                                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,GLARGS+2         DISPLACEMENT OF DATE IN INPUT                
         LA    R2,0(RF,R2)         POINT TO DATE                                
*                                                                               
         OC    0(2,R2),0(R2)       SKIP IF NO INPUT DATE                        
         BZ    ODATEX              (ALL DATES AT LEAST 2 BYTES INPUT)           
*                                                                               
         SR    R0,R0                                                            
         IC    R0,GLARGS           INPUT DATE FORMAT                            
*                                                                               
         SR    R5,R5                                                            
         ICM   R5,1,GLARGS+1       OUTPUT DATE FORMAT                           
         BZ    ODATE1              NUMERIC OUTPUT YYMMDD                        
*                                                                               
         CLI   GLARGS,3            IF BINARY INPUT                              
         BNE   *+8                                                              
         CLI   2(R2),0             AND NO DAYS                                  
         BNE   *+8                                                              
         LA    R5,1(R5)                CHANGE TO NEXT OUTPUT TYPE               
*                                                                               
ODATE1   DS    0H                                                               
*                                                                               
         TM    PBQPOPT,PBQPOYYM    IF NUMERIC OUTPUT WANTED                     
         BNO   *+8                                                              
         LA    R5,X'20'               RESET OUTPUT DATE FORMAT                  
*                                                                               
         CLI   PBQDTTYP,0          IF OVERRIDE OF OUTPUT DATE TYPE              
         BE    *+8                                                              
         IC    R5,PBQDTTYP            USE IT                                    
*                                                                               
         LA    R4,NAMEAREA         DEFAULT PRINT POSITION                       
*                                                                               
         CLM   R5,1,ODTYYM         IF NUMERIC OUTPUT                            
         BNE   ODATE3                                                           
*                                                                               
         TM    PBQPOPT,PBQPOCTY    AND CENTURY INCLUDED                         
         BNO   ODATE3                                                           
*                                                                               
         LA    R4,2(R4)               BUMP OUTPUT POINTER                       
*                                                                               
ODATE3   DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,((R0),(R2)),((R5),(R4))  PRINT DATE                  
*                                                                               
         CLM   R5,1,ODTYYM         IF NUMERIC OUTPUT                            
         BNE   ODATE6                                                           
*                                                                               
         TM    PBQPOPT,PBQPOCTY    AND CENTURY INCLUDED                         
         BNO   ODATE5                                                           
*                                                                               
         MVC   NAMEAREA(2),=C'19'     TWENTIETH IS DEFAULT CENTURY              
*                                                                               
         CLC   NAMEAREA+2(2),=C'50'   IF BEFORE MID-CENTURY                     
         BNL   *+10                                                             
         MVC   NAMEAREA(2),=C'20'        USE TWENTY-FIRST CENTURY               
*                                                                               
ODATE5   DS    0H                                                               
*                                                                               
         CLI   GLARGS,3            IF BINARY INPUT                              
         BNE   *+8                                                              
         CLI   2(R2),0             AND NO DAYS                                  
         BNE   *+10                                                             
         MVC   4(2,R4),=C'  '          KILL DAYS IN DATE                        
*                                                                               
ODATE6   DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,0          IF THERE IS A TRAILING CHARACTER             
         BE    ODATE7                                                           
*                                                                               
         SR    RF,RF                                                            
         IC    RF,GLARGS+3            GET DISPLACEMENT IN INPUT                 
*                                                                               
         LA    RE,0(RF,R2)            POINT TO TRAILING CHARACTER               
*                                                                               
         LA    RF,L'NAMEAREA          MAX OUTPUT LENGTH                         
         LA    R1,NAMEAREA-1(RF)      LAST OF INPUT                             
*                                                                               
         CLI   0(R1),C' '             FIND END OF DATE                          
         BH    *+10                                                             
         BCTR  R1,0                   BACK UP A BYTE                            
         BCT   RF,*-10                                                          
*                                                                               
         MVC   1(1,R1),0(RE)          ADD ON TRAILING CHARACTER                 
*                                                                               
ODATE7   DS    0H                                                               
*                                                                               
ODATEX   DS    0H                                                               
*                                                                               
         GOTO1 GENOUTA                                                          
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
ODTYYM   DC    X'20'               NUMERIC DATE OUTPUT FORMAT                   
*                                                                               
         TITLE 'PRWRITER - DAILY BAL DOLLAR DATA - INPUT - IAGLDLR'             
***********************************************************************         
*                                                                     *         
*        DAILY BALANCE MONEY FIELDS                                   *         
*                                                                     *         
*NTRY    ALL ARGUMENTS SET UP FOR IDOLLAR ROUTINE                     *         
*                                                                     *         
*        THIS ROUTINE USES ICLRDLR TO RETRIEVE CLEARED DOLLAR AND     *         
*        THEN USES ICLR ROUTINE TO GET CLEARANCE DAYS.                *         
*                                                                     *         
*EXIT    0(8,R2)   -  CLEARED DOLLARS * CLEARANCE DAYS   LIVE BUYS    *         
*        8(8,R2)   -  CLEARED DOLLARS * CLEARANCE DAYS   TEST BUYS    *         
*       16(8,R2)   -  CLEARED DOLLARS                                 *         
*       24(8,R2)   -  BILLED  DOLLARS * BILLING   DAYS                *         
*       32(8,R2)   -  BILLED  DOLLARS                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IAGLDLR  NMOD1 0,**#IAG$                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         XC    IAGLSAVE(IAGLSAVL),IAGLSAVE   INIT SAVEAREA                      
*                                                                               
         MVC   IAGLARGS,GLARGS     SAVE INPUT ARGUMENTS                         
*                                                                               
         ST    R2,IAGLINA          SAVE INPUT AREA ADDRESS                      
         LA    R2,IAGLDLRS         POINT TO IDOLLAR OUTPUT AREA                 
*                                                                               
         OC    PBPAYELA,PBPAYELA   IF DOING A PAY  ELEMENT                      
         BZ    *+18                                                             
         MVC   GLARGS(2),=C'JP'       CHANGE DATA SOURCE TYPE                   
         L     RF,=A(ICLRDLR)         SET ROUTINE ADDRESS                       
         B     IAGLDLR1                                                         
*                                                                               
         OC    PBBLLELA,PBBLLELA   IF DOING A BILL ELEMENT                      
         BZ    IAGLDLR0                                                         
*                                                                               
         MVC   GLARGS(2),=C'MB'       CHANGE DATA SOURCE TYPE                   
         L     RF,=A(ICLRDLR)         SET ROUTINE ADDRESS                       
*                                                                               
         OC    PBMBTELA,PBMBTELA   IF NOT DOING A CASH APPLIED ELEMENT          
         BNZ   IAGLDLRA                                                         
*                                                                               
         CLI   IAGDSW,0               IF CASH DATA EXISTS                       
         BZ    *+12                                                             
         MVI   IAGDSW,0                  CLEAR CASH DATA SWITCH                 
         B     IAGLDLRX                  EXIT                                   
*                                                                               
         B     IAGLDLR1               ELSE GET DATA                             
*                                                                               
IAGLDLRA DS    0H                                                               
*                                                                               
         MVC   GLARGS(2),=C'QB'       CHANGE DATA SOURCE TYPE                   
         MVI   IAGDSW,1               INDICATE CASH DATA PRESENT                
         L     RF,=A(ICSH)            SET ROUTINE ADDRESS                       
*                                                                               
         B     IAGLDLR1                                                         
*                                                                               
IAGDSW   DC    X'00'               CASH DATA FOUND FOR BILL                     
         DS    X                   SPARE                                        
*                                                                               
IAGLDLR0 DS    0H                                                               
*                                                                               
         B     IAGLDLRX            NO DATA TO FIND                              
*                                                                               
IAGLDLR1 DS    0H                                                               
*                                                                               
         GOTO1 (RF)                GET CLEARED DOLLARS                          
*                                                                               
         OC    IAGLLIVE,IAGLLIVE   DONE IF NO DOLLARS FOUND                     
         BZ    IAGLDLRX                                                         
*                                                                               
         L     R2,IAGLINA          RE-POINT TO DRIVER INPUT                     
*                                                                               
         OC    PBPAYELA,PBPAYELA   IF DOING A PAY  ELEMENT                      
         BZ    *+10                                                             
         ZAP   16(8,R2),IAGLLIVE      RETURN CLEARED LIVE DOLLARS               
*                                                                               
         OC    PBBLLELA,PBBLLELA   IF DOING A BILL ELEMENT                      
         BZ    *+10                                                             
         ZAP   32(8,R2),IAGLLIVE      RETURN BILLED  LIVE DOLLARS               
*                                                                               
*        SAVE GLARGS AND GO GET CLEARANCE DAYS                                  
*                                                                               
         LA    R2,IAGLDAYS         SET RETURN ADDRESS                           
         MVC   GLARGS(3),=CL3'BD#'   SET ARGUMENTS FOR CLEARANCE DAYS           
*                                                                               
         GOTO1 =A(IAADT)           GET CLEARANCE DAYS                           
         L     R2,IAGLINA          RE-POINT TO DRIVER INPUT                     
*                                                                               
         OC    IAGLDAYS,IAGLDAYS   DONE IF NO DAYS FOUND                        
         BZ    IAGLDLRX                                                         
*                                                                               
         ZAP   IAGLDYS,IAGLDAYS    SHORTEN DAYS FIELD LENGTH                    
*                                                                               
         ZAP   IAGLWORK,IAGLLIVE                                                
         MP    IAGLWORK,IAGLDYS    LIVE AMOUNT                                  
         ZAP   IAGLLIVE,IAGLWORK                                                
*                                                                               
         ZAP   IAGLWORK,IAGLTEST                                                
         MP    IAGLWORK,IAGLDYS    TEST AMOUNT                                  
         ZAP   IAGLTEST,IAGLWORK                                                
*                                                                               
         OC    PBPAYELA,PBPAYELA   IF DOING A PAY  ELEMENT                      
         BZ    *+16                                                             
         ZAP   0(8,R2),IAGLLIVE       RETURN CLEARED LIVE DOLLARS               
         ZAP   8(8,R2),IAGLTEST       RETURN CLEARED TEST DOLLARS               
*                                                                               
         OC    PBBLLELA,PBBLLELA   IF DOING A BILL ELEMENT                      
         BZ    *+10                                                             
         ZAP   24(8,R2),IAGLLIVE      RETURN BILLED  LIVE DOLLARS               
*                                                                               
IAGLDLRX DS    0H                                                               
         MVC   GLARGS(16),IAGLARGS RESTORE INPUT ARGUMENTS                      
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IAGLSAVE DS    0D                  SAVEAREA                                     
IAGLINA  DS    A                   DRIVER INPUT AREA ADDRESS SAVEAREA           
IAGLDAYS DS    PL8                 CLEARANCE DAYS                               
IAGLDYS  DS    PL3                 CLEARANCE DAYS - SHORT FORM                  
IAGLDLRS DS    0X                  CLEARANCE DOLLARS                            
IAGLLIVE DS    PL8                 LIVE CLEARANCE DOLLARS                       
IAGLTEST DS    PL8                 TEST CLEARANCE DOLLARS                       
IAGLARGS DS    XL16                ARGUMENT SAVE AREA                           
IAGLWORK DS    PL16                WORKAREA                                     
IAGLSAVL EQU   *-IAGLSAVE          SAVEAREA LENGTH                              
*                                                                               
         TITLE 'PRWRITER - AGING DOLLAR DATA - OUTPUT - OAGLDLR'                
***********************************************************************         
*                                                                     *         
*        DAILY BALANCE MONEY FIELDS - OUTPUT                          *         
*                                                                     *         
*NTRY    0(8,R2)   -  CLEARED DOLLARS * CLEARANCE DAYS   LIVE BUYS    *         
*        8(8,R2)   -  CLEARED DOLLARS * CLEARANCE DAYS   TEST BUYS    *         
*       16(8,R2)   -  CLEARED DOLLARS LIVE BUYS                       *         
*       24(8,R2)   -  BILLED  DOLLARS * BILLING DAYS                  *         
*       32(8,R2)   -  BILLED  DOLLARS LIVE BUYS                       *         
*                                                                     *         
*EXIT    NON-TOTAL LINE PRINTS LIVE OR TEST AMOUNTS                   *         
*        TOTAL LINE DIVIDES AMOUNT BY DAYS BEFORE PRINTING            *         
*                                                                     *         
*        OUTPUT IS TOTAL OF CLEARED*DAYS AND BILLED*DAYS              *         
*        TOTAL LINE GIVES AVERAGE CLEARED DAYS - AVG BILLED DAYS      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OAGLDLR  NMOD1 0,**#OAG$                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         ZAP   OAGLADDC,=P'0'      INIT WORKAREAS                               
         ZAP   OAGLADDB,=P'0'                                                   
*                                                                               
         TM    GLINDS,GLTOTLIN     SKIP IF NOT TOTAL LINE                       
         BNO   OAGLDLRD                                                         
*                                                                               
         ZAP   OAGLADDC,0(8,R2)    COPY TOTAL CLEARED LIVE                      
*                                                                               
         CP    19(5,R2),=P'0'      AVOID ILLEGAL DIVIDE                         
         BE    OAGLDLR1                                                         
*                                                                               
         DP    OAGLADDC,19(5,R2)   DIVIDE BY CLEARED AMOUNT                     
*                                                                               
         AP    OAGLADDC+11(5),OAGLADDC+11(5)  DOUBLE REMAINDER                  
         CP    OAGLADDC+11(5),19(5,R2) CHECK FOR ROUNDING                       
         BL    *+10                                                             
         AP    OAGLADDC(11),=P'1'    ROUND UP                                   
*                                                                               
         ZAP   OAGLADDC,OAGLADDC(11)  RESET LENGTH                              
*                                                                               
OAGLDLR1 DS    0H                                                               
*                                                                               
         ZAP   OAGLADDB,24(8,R2)   COPY TOTAL BILLED LIVE                       
*                                                                               
         CP    35(5,R2),=P'0'      AVOID ILLEGAL DIVIDE                         
         BE    OAGLDLR2                                                         
*                                                                               
         DP    OAGLADDB,35(5,R2)   DIVIDE BY CLEARED AMOUNT                     
*                                                                               
         AP    OAGLADDB+11(5),OAGLADDB+11(5)  DOUBLE REMAINDER                  
         CP    OAGLADDB+11(5),35(5,R2) CHECK FOR ROUNDING                       
         BL    *+10                                                             
         AP    OAGLADDB(11),=P'1'    ROUND UP                                   
*                                                                               
         ZAP   OAGLADDB,OAGLADDB(11)  RESET LENGTH                              
*                                                                               
OAGLDLR2 DS    0H                                                               
*                                                                               
         L     RF,=A(ODBLADD)      A(ADD ACCUMULATOR)                           
*                                                                               
         ZAP   0(8,RF),OAGLADDC    SUM OF THE 2 ADD'S                           
         AP    0(8,RF),OAGLADDB                                                 
*                                                                               
OAGLDLRD DS    0H                                                               
*                                                                               
         AP    0(8,R2),24(8,R2)    TOTAL CLEARED AND BILLED                     
*                                                                               
         B     OAGLDLRX                                                         
*                                                                               
OAGLDLRX DS    0H                                                               
         MVI   GLHOOK,GLEDIT                                                    
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OAGLADD  DC    XL16'00'            TOTAL WORKAREA                               
OAGLADDC DC    XL16'00'            TOTAL CLEARED WORKAREA                       
OAGLADDB DC    XL16'00'            TOTAL BILLED  WORKAREA                       
*                                                                               
OAGLTXTL DC    C'AVG. DAYS TO DISBURSEMENT = '                                  
OAGLTXTS DC    C'ADD = '                                                        
*                                                                               
         TITLE 'PRWRITER - DAILY BAL DOLLAR DATA - INPUT - IDBLDLR'             
***********************************************************************         
*                                                                     *         
*        DAILY BALANCE MONEY FIELDS                                   *         
*                                                                     *         
*NTRY    ALL ARGUMENTS SET UP FOR IDOLLAR ROUTINE                     *         
*                                                                     *         
*        THIS ROUTINE USES ICLRDLR TO RETRIEVE CLEARED DOLLAR AND     *         
*        THEN USES ICLR ROUTINE TO GET CLEARANCE DAYS.                *         
*                                                                     *         
*EXIT    0(8,R2)   -  CLEARED DOLLARS * CLEARANCE DAYS   LIVE BUYS    *         
*        8(8,R2)   -  CLEARED DOLLARS * CLEARANCE DAYS   TEST BUYS    *         
*       16(8,R2)   -  CLEARANCE DAYS                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IDBLDLR  NMOD1 0,**#IDB$                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         XC    IDBLSAVE(IDBLSAVL),IDBLSAVE   INIT SAVEAREA                      
*                                                                               
*        ZAP   0(8,R2),=P'0'       INIT OUTPUT                                  
*        ZAP   8(8,R2),=P'0'       INIT OUTPUT                                  
*                                                                               
*        GET DOLLAR AMOUNTS FROM IDOLLAR                                        
*                                                                               
         OC    PBPAYELA,PBPAYELA   MUST HAVE PAY AND CLEARANCE ELEMENTS         
         BZ    IDBLDLRX                                                         
         CLI   GLARGS,C'N'         THESE KEYWORDS DON'T NEED CLS ELM            
         BE    *+14                                                             
         OC    PBCLSELA,PBCLSELA                                                
         BZ    IDBLDLRX                                                         
*                                                                               
         ST    R2,IDBLINA          SAVE INPUT AREA ADDRESS                      
         LA    R2,IDBLDLRS         POINT TO IDOLLAR OUTPUT AREA                 
*                                                                               
         GOTO1 =A(ICLRDLR)         GET CLEARED DOLLARS                          
*                                                                               
         OC    IDBLLIVE,IDBLLIVE   DONE IF NO DOLLARS FOUND                     
         BZ    IDBLDLRX                                                         
*                                                                               
         L     R2,IDBLINA          RE-POINT TO DRIVER INPUT                     
         ZAP   16(8,R2),IDBLLIVE   RETURN LIVE DOLLARS                          
*                                                                               
*        SAVE GLARGS AND GO GET CLEARANCE DAYS                                  
*                                                                               
         LA    R2,IDBLDAYS         SET RETURN ADDRESS                           
         MVC   IDBLARGS,GLARGS     SAVE INPUT ARGUMENTS                         
         MVC   GLARGS(3),=CL3'KD#'   SET ARGUMENTS FOR CLEARANCE DAYS           
*                                                                               
         GOTO1 =A(ICLR)            GET CLEARANCE DAYS                           
         MVC   GLARGS(16),IDBLARGS RESTORE INPUT ARGUMENTS                      
         L     R2,IDBLINA          RE-POINT TO DRIVER INPUT                     
*                                                                               
         OC    IDBLDAYS,IDBLDAYS   DONE IF NO DAYS FOUND                        
         BZ    IDBLDLRX                                                         
*                                                                               
         ZAP   IDBLDYS,IDBLDAYS    SHORTEN DAYS FIELD LENGTH                    
*                                                                               
         MP    IDBLLIVE,IDBLDYS    LIVE AMOUNT                                  
         MP    IDBLTEST,IDBLDYS    TEST AMOUNT                                  
*                                                                               
         ZAP   0(8,R2),IDBLLIVE    RETURN LIVE DOLLARS                          
         ZAP   8(8,R2),IDBLTEST    RETURN TEST DOLLARS                          
*                                                                               
IDBLDLRX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IDBLSAVE DS    0D                  SAVEAREA                                     
IDBLINA  DS    A                   DRIVER INPUT AREA ADDRESS SAVEAREA           
IDBLDAYS DS    PL8                 CLEARANCE DAYS                               
IDBLDYS  DS    PL3                 CLEARANCE DAYS - SHORT FORM                  
IDBLDLRS DS    0X                  CLEARANCE DOLLARS                            
IDBLLIVE DS    PL8                 LIVE CLEARANCE DOLLARS                       
IDBLTEST DS    PL8                 TEST CLEARANCE DOLLARS                       
IDBLARGS DS    XL16                ARGUMENT SAVE AREA                           
IDBLSAVL EQU   *-IDBLSAVE          SAVEAREA LENGTH                              
*                                                                               
         TITLE 'PRWRITER - DAILY BAL DOLLAR DATA - OUTPUT - ODBLDLR'            
***********************************************************************         
*                                                                     *         
*        DAILY BALANCE MONEY FIELDS - OUTPUT                          *         
*                                                                     *         
*NTRY    0(8,R2)   -  CLEARED DOLLARS * CLEARANCE DAYS   LIVE BUYS    *         
*        8(8,R2)   -  CLEARED DOLLARS * CLEARANCE DAYS   TEST BUYS    *         
*       16(8,R2)   -  CLEARED DOLLARS LIVE BUYS                       *         
*                                                                     *         
*EXIT    NON-TOTAL LINE PRINTS LIVE OR TEST AMOUNTS                   *         
*        TOTAL LINE DIVIDES AMOUNT BY DAYS BEFORE PRINTING            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ODBLDLR  NMOD1 0,**#ODB$                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         TM    GLINDS,GLTOTLIN     NOTHING TO DO IF NON-TOTAL LINE              
         BNO   ODBLDLRX                                                         
*                                                                               
         ZAP   ODBLADD,0(8,R2)     COPY TOTAL LIVE                              
*                                                                               
         CP    19(5,R2),=P'0'      AVOID ILLEGAL DIVIDE                         
         BE    ODBLDLRX                                                         
*                                                                               
         DP    ODBLADD,19(5,R2)    DIVIDE BY CLEARED AMOUNT                     
*                                                                               
         AP    ODBLADD+3(5),ODBLADD+3(5)  DOUBLE REMAINDER                      
         CP    ODBLADD+3(5),19(5,R2) CHECK FOR ROUNDING                         
         BL    *+10                                                             
         AP    ODBLADD(3),=P'1'    ROUND UP                                     
*                                                                               
         ZAP   ODBLADD,ODBLADD(3)  RESET LENGTH                                 
ODBLDLRX DS    0H                                                               
         MVI   GLHOOK,GLEDIT                                                    
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
ODBLADD  DC    XL8'00'             TOTAL WORKAREA                               
*                                                                               
ODBLTXTL DC    C'AVG. DAYS TO DISBURSEMENT = '                                  
ODBLTXTS DC    C'ADD = '                                                        
*                                                                               
         TITLE  'PRWRITER - GROUP CODE INPUT -IGRP'                             
***********************************************************************         
*                                                                     *         
*        GROUP CODE INPUT                                             *         
*                                                                     *         
*NTRY    GLARGS      C'H' - HEADER RECORD                             *         
*        GLARGS+1    C'5' - GROUP  RECORD DATA                        *         
*        GLARGS+2    C'C' - CLIENT  GROUP                             *         
*                    C'P' - PRODUCT GROUP                             *         
*                    C'B' - PUB     GROUP                             *         
*        GLARGS+3    C'0' - LOWEST GROUP BREAK AVAILABLE              *         
*                    C'1' - MAJOR  GROUP BREAK                        *         
*                    C'2' - MINOR  GROUP BREAK                        *         
*        GLARGS+4    C'C' - CODE ONLY                                 *         
*                    C'N' - NAME AND CODE                             *         
*                    C'B' - NAME                                      *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IGRP     NMOD1 512,**#IGRP                                                      
*                                                                               
         ST    RC,IGRPAIO          SAVE WORKING STORAGE POINTER                 
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         CLI   GLARGS+2,C'C'       IF CLIENT  GROUP                             
         BNE   IGRPCLTN                                                         
*                                                                               
*        TRANSLATE GROUP CODE TO 2 CHARACTERS                                   
*                                                                               
         LA    RE,SPCGRTAB         POINT TO CLIENT GROUP CODE TABLE             
*                                                                               
IGRPCLLP DS    0H                                                               
*                                                                               
         CLI   0(RE),X'FF'         DONE IF EOT REACHED                          
         BE    IGRPCLDN                                                         
*                                                                               
         CLC   PBQGPCLS,2(RE)      MATCH 1 BYTE CODE                            
         BE    IGRPCLFD                                                         
*                                                                               
IGRPCLCN DS    0H                                                               
*                                                                               
         LA    RE,3(RE)            BUMP TO NEXT TABLE ENTRY                     
         B     IGRPCLLP                                                         
*                                                                               
IGRPCLFD DS    0H                                                               
         MVC   0(2,R2),0(RE)       PASS 2 CHARACTER CODE                        
*                                                                               
         CLI   1(R2),C' '          IF THERE IS A SECOND CHARACTER               
         BNH   *+8                                                              
         LA    R2,1(R2)            BUMP OUTPUT POINTER                          
*                                                                               
IGRPCLDN DS    0H                                                               
*                                                                               
         LA    R1,PBGCCODE            SET POINTER                               
         L     R4,PBAGPCBK            POINT TO GROUP BREAK ELEMENT              
         B     IGRPBRK                                                          
*                                                                               
IGRPCLTN DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'P'       IF PRODUCT GROUP                             
         BNE   *+18                                                             
         MVC   0(L'PBQGPPRS,R2),PBQGPPRS  RETURN GROUP SCHEME                   
         LA    R1,PBGPCODE            SET POINTER                               
         L     R4,PBAGPPBK            POINT TO GROUP BREAK ELEMENT              
*                                                                               
         CLI   GLARGS+2,C'B'       IF PUB     GROUP                             
         BNE   *+18                                                             
         MVC   0(L'PBQGPPBS,R2),PBQGPPBS  RETURN GROUP SCHEME                   
         LA    R1,PBGBCODE            SWITCH POINTER                            
         L     R4,PBAGPBBK            POINT TO GROUP BREAK ELEMENT              
*                                                                               
IGRPBRK  DS    0H                                                               
*                                                                               
         OC    0(L'PBGBCODE,R1),0(R1) SKIP IF NO CODE AVAILABLE                 
         BNZ   *+14                                                             
         XC    0(L'PBQGPPBS+1,R2),0(R2)  CLEAR GROUP SCHEME                     
         B     IGRPX                                                            
*                                                                               
         LA    R2,L'PBQGPCLS(R2)   BUMP OUTPUT POINTER                          
*                                                                               
         UNPK  IGRPCODE(L'IGRPCODE+1),0(L'PBGCCODE+1,R1) UNPK CODE              
*                                                                               
         USING GRPBRKD,R4          ESTABLISH GROUP BREAK ELEMENT                
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,GRPBK1LN       FIRST BREAK LENGTH                           
         BZ    IGRPX               NO DATA TO WORK WITH                         
*                                                                               
         CLI   GLARGS+3,C'1'       SKIP IF FIRST BREAK WANTED                   
         BE    IGRPBRKX                                                         
*                                                                               
         CLI   GLARGS+3,C'0'       SKIP IF LOWEST BREAK                         
         BNE   *+16                                                             
         CLI   GRPBK2LN,0          AND NO SECOND BREAK EXISTS                   
         BE    IGRPBRKX                                                         
         B     IGRPBRK1                                                         
*                                                                               
         CLI   GLARGS+3,C'2'       MUST BE SECOND BREAK                         
         BNE   IGRPX                                                            
*                                                                               
IGRPBRK1 DS    0H                                                               
*                                                                               
         SR    RE,RE                                                            
         ICM   RE,1,GRPBK2LN       GET SECOND PART LENGTH                       
         AR    RF,RE               TOTAL CODE LENGTH                            
*                                                                               
IGRPBRKX DS    0H                                                               
*                                                                               
         CLI   GLARGS+4,C'N'       SKIP IF NAME ONLY WANTED                     
         BE    IGRPCDEX                                                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),IGRPCODE    RETURN CORRECT CODE                          
*                                                                               
         CLI   GLARGS+4,C'C'       DONE IF CODE ONLY WANTED                     
         BE    IGRPX                                                            
*                                                                               
IGRPCDEX DS    0H                                                               
*                                                                               
         LA    R2,L'IGRPCODE(R2)   BUMP OUTPUT POINTER                          
*                                                                               
*        FIND NAME FOR GROUP BREAK                                              
*                                                                               
*        BUILD KEY FOR GROUP ID DEFINITION RECORD                               
*                                                                               
         XC    KEY,KEY             ESTABLISH KEY AS GROUP ID DEF                
         LA    R4,KEY                                                           
         USING GRPRECD,R4                                                       
*                                                                               
         MVC   GRPKAGY,PBAGY       SET AGENCY                                   
         MVC   GRPKMED,PBMED       SET MEDIA                                    
*                                                                               
         CLI   GLARGS+2,C'C'       IF CLIENT  GROUP                             
         BNE   *+28                                                             
         MVI   GRPKRCOD,GRPKCTYQ      SET FOR CLIENT GROUPS                     
         MVC   GRPKID,PBQGPCLS        SET SCHEME ID                             
         MVC   GRPKCODE,PBGCCODE      SET GROUP CODE                            
         LA    R3,IGRPCKYS            POINT TO CLIENT KEY SAVEAREA              
         B     IGRPGPKX                                                         
*                                                                               
         CLI   GLARGS+2,C'P'       IF PRODUCT GROUP                             
         BNE   *+34                                                             
         MVI   GRPKRCOD,GRPKPTYQ      SET FOR PRODUCT GROUPS                    
         MVC   GRPKCLT,PBCLT          SET CLIENT CODE                           
         MVC   GRPKID,PBQGPPRS        SET SCHEME ID                             
         MVC   GRPKCODE,PBGPCODE      SET GROUP CODE                            
         LA    R3,IGRPPKYS            POINT TO PRODUCT KEY SAVEAREA             
         B     IGRPGPKX                                                         
*                                                                               
         CLI   GLARGS+2,C'B'       IF PUB     GROUP                             
         BNE   *+28                                                             
         MVI   GRPKRCOD,GRPKBTYQ      SET FOR PUB     GROUPS                    
         MVC   GRPKID,PBQGPPBS        SET SCHEME ID                             
         MVC   GRPKCODE,PBGBCODE      SET GROUP CODE                            
         LA    R3,IGRPBKYS            POINT TO PUB KEY SAVEAREA                 
         B     IGRPGPKX                                                         
*                                                                               
         B     IGRPX               UNKNOWN GROUP TYPE                           
*                                                                               
IGRPGPKX DS    0H                                                               
*                                                                               
*        READ RECORD IF NEEDED                                                  
*                                                                               
         CLC   GRPKEY,0(R3)        SKIP IF KEY UNCHANGED                        
         BE    IGRPRDX                                                          
*                                                                               
         GOTO1 HIGH                READ GRP RECORD                              
*                                                                               
         TM    GRPKCNTL,X'80'      SKIP IF DELETED                              
         BO    IGRPX                                                            
*                                                                               
         CLC   GRPKEY,KEYSAVE      MUST FIND RECORD                             
         BNE   IGRPX                                                            
*                                                                               
         ICM   R0,15,AIO           SAVE CURRENT IOAREA                          
*                                                                               
         MVC   AIO,IGRPAIO         SET ROUTINE'S A(IOAREA)                      
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         STCM  R0,15,AIO           RESTORE CURRENT AIO                          
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE LAST KEY READ                        
         OI    DMINBTS,8         PASS BACK DELETED RECORDS       BUG11          
*                                                                               
         GOTO1 HIGH                RESET FILE POINTERS                          
*                                                                               
         L     R4,IGRPAIO          SWITCH POINTER TO FOUND RECORD               
*                                                                               
*        FIND GROUP BREAK NAMES ELEMENT                                         
*                                                                               
         LA    R6,GRPKEY+33        POINT TO FIRST ELEMENT IN RECORD             
         USING GRPGRPD,6           ESTABLISH AS BREAK NAMES ELEMENT             
         SR    RF,RF                                                            
*                                                                               
IGRPBKLP DS    0H                                                               
*                                                                               
         CLI   GRPGRPCD,0          CHECK FOR END OF RECORD                      
         BE    IGRPBKDN                                                         
*                                                                               
         CLI   GRPGRPCD,GRPGRPCQ   LOOKING FOR BREAK NAMES ELM                  
         BE    IGRPBKFD                                                         
*                                                                               
IGRPBKCN DS    0H                                                               
*                                                                               
         IC    RF,GRPGRPLN         ELEMENT LENGTH                               
         LA    R6,GRPGRPD(RF)      BUMP TO NEXT ELEMENT                         
         B     IGRPBKLP                                                         
*                                                                               
IGRPBKDN DS    0H                  NO ELEMENT FOUND                             
*                                                                               
         XC    0(L'GRPKEY,R3),0(R3) CLEAR SAVED KEY                             
         XC    L'GRPKEY(GRPGRPLQ,R3),L'GRPKEY(R3)  CLEAR SAVED NAMES            
*                                                                               
         B     IGRPX                                                            
*                                                                               
IGRPBKFD DS    0H                                                               
*                                                                               
         MVC   0(L'GRPKEY,R3),GRPKEY SAVE KEY                                   
         MVC   L'GRPKEY(GRPGRPLQ,R3),GRPGRPD SAVE BREAK NAMES ELM               
*                                                                               
IGRPRDX  DS    0H                                                               
*                                                                               
*        RETURN BREAK NAME TO DRIVER                                            
*                                                                               
         LA    R6,L'GRPKEY(R3)     POINT TO BREAK NAMES ELEMENT                 
*                                                                               
         LA    R1,GRPGNAM1         DEFAULT TO FIRST BREAK NAME                  
*                                                                               
         CLI   GLARGS+3,C'1'       SKIP IF FIRST BREAK WANTED                   
         BE    IGRPNAMX                                                         
*                                                                               
         CLI   GLARGS+3,C'0'       SKIP IF LOWEST BREAK                         
         BNE   *+18                                                             
         OC    GRPGNAM2,GRPGNAM2   AND NO SECOND BREAK EXISTS                   
         BZ    IGRPNAMX                                                         
         B     IGRPNAM1                                                         
*                                                                               
         CLI   GLARGS+3,C'2'       MUST BE SECOND BREAK                         
         BNE   IGRPX                                                            
*                                                                               
IGRPNAM1 DS    0H                                                               
*                                                                               
         LA    R1,GRPGNAM2         POINT TO SECOND BREAK NAME                   
*                                                                               
IGRPNAMX DS    0H                                                               
*                                                                               
         MVC   0(L'GRPGNAM1,R2),0(R1)  RETURN NAME TO DRIVER                    
*                                                                               
IGRPX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
       ++INCLUDE SPCGRTAB                                                       
*                                                                               
IGRPCODE DS    CL4                 UNPACKED CODE                                
         DS    XL1                 EXTRA FOR UNPACKING                          
*                                                                               
IGRPAIO  DS    A                   ROUTINE A(IOAREA)                            
*                                                                               
IGRPCKYS DS    XL(L'GRPKEY)        CLIENT  GROUP KEY SAVEAREA                   
IGRPCGPS DS    XL(GRPGRPLQ)        CLIENT  BREAK NAMES ELEMENT SAVEAREA         
IGRPPKYS DS    XL(L'GRPKEY)        PRODUCT GROUP KEY SAVEAREA                   
IGRPPGPS DS    XL(GRPGRPLQ)        PRODUCT BREAK NAMES ELEMENT SAVEAREA         
IGRPBKYS DS    XL(L'GRPKEY)        PUB     GROUP KEY SAVEAREA                   
IGRPBGPS DS    XL(GRPGRPLQ)        PUB     BREAK NAMES ELEMENT SAVEAREA         
*                                                                               
         TITLE  'PRWRITER - GROUP CODE OUTPUT -OGRP'                            
***********************************************************************         
*                                                                     *         
*        GROUP CODE OUTPUT                                            *         
*                                                                     *         
*NTRY    GLARGS      C'H' - HEADER RECORD                             *         
*        GLARGS+1    C'5' - GROUP  RECORD                             *         
*        GLARGS+2    C'C' - CLIENT  GROUP                             *         
*                    C'P' - PRODUCT GROUP                             *         
*                    C'B' - PUB     GROUP                             *         
*        GLARGS+3    C'0' - LOWEST GROUP BREAK AVAILABLE              *         
*                    C'1' - MAJOR  GROUP BREAK                        *         
*                    C'2' - MINOR  GROUP BREAK                        *         
*        GLARGS+4    C'C' - CODE ONLY                                 *         
*                    C'N' - NAME AND CODE                             *         
*                    C'B' - NAME                                      *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OGRP     NMOD1 0,**#OGRP                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         CLI   GLARGS+2,C'C'       DETERMINE GROUP BREAK ELM TO USE             
         BNE   *+8                                                              
         L     R4,PBAGPCBK         CLIENT                                       
*                                                                               
         CLI   GLARGS+2,C'P'       DETERMINE GROUP BREAK ELM TO USE             
         BNE   *+8                                                              
         L     R4,PBAGPPBK         PRODUCT                                      
*                                                                               
         CLI   GLARGS+2,C'B'       DETERMINE GROUP BREAK ELM TO USE             
         BNE   *+8                                                              
         L     R4,PBAGPBBK         PUB                                          
*                                                                               
         USING GRPBRKD,R4                                                       
*                                                                               
         LA    RE,GRPBK1           DEFAULT TO FIRST TITLE                       
*                                                                               
         CLI   GLARGS+3,C'1'       SKIP IF FIRST BREAK WANTED                   
         BE    OGRPBRKX                                                         
*                                                                               
         CLI   GLARGS+3,C'0'       SKIP IF LOWEST BREAK                         
         BNE   *+16                                                             
         CLI   GRPBK2LN,0          AND NO SECOND BREAK EXISTS                   
         BE    OGRPBRKX                                                         
         B     OGRPBRK1                                                         
*                                                                               
         CLI   GLARGS+3,C'2'       MUST BE SECOND BREAK                         
         BNE   OGRPX                                                            
*                                                                               
OGRPBRK1 DS    0H                                                               
*                                                                               
         LA    RE,GRPBK2           POINT TO SECOND TITLE                        
*                                                                               
OGRPBRKX DS    0H                                                               
*                                                                               
         MVC   LABLAREA(L'GRPBK1),0(RE)  SET TITLE FOR BREAK                    
*                                                                               
         MVC   CODEAREA,SPACES                                                  
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         LA    R1,5(R2)            POINT TO START OF NAME IN INPUT              
*                                                                               
         CLI   GLARGS+4,C'N'       SKIP IF NAME ONLY WANTED                     
         BE    OGRPCDEX                                                         
*                                                                               
         MVC   CODEAREA(5),0(R2)   PRINT CODE                                   
*                                                                               
         CLI   1(R2),C'0'          WE HAVE 2 CH CLIENT CODE IF SECOND           
         BNL   OGRPCDEX               POSITION IS NOT NUMERIC                   
         CLI   1(R2),C' '             AND NOT BLANK                             
         BNH   OGRPCDEX                                                         
*                                                                               
         MVC   CODEAREA+5(1),5(R2) MOVE EXTRA BYTE OF CODE                      
         AHI   R1,1                BUMP NAME START POINTER                      
*                                                                               
OGRPCDEX DS    0H                                                               
*                                                                               
         CLI   GLARGS+4,C'C'       SKIP IF CODE ONLY WANTED                     
         BE    *+10                                                             
         MVC   NAMEAREA(24),0(R1)  PRINT BREAK NAME                             
*                                                                               
         GOTO1 GENOUTA             PRINT BREAK TITLE/CODE/NAME                  
*                                                                               
OGRPX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OGRPCODE DS    CL4                 UNPACKED CODE                                
         DS    XL1                 EXTRA FOR UNPACKING                          
*                                                                               
         TITLE  'PRWRITER - GROUP CODE INPUT -IGP'                              
***********************************************************************         
*                                                                     *         
*        GROUP CODE INPUT - REPORTS GROUP FOR SKED FOR SCHEME         *         
*                                                                     *         
*NTRY    GLARGS      C'H'  - HEADER RECORD                            *         
*        GLARGS+1    C'5'  - GROUP  RECORD DATA                       *         
*        GLARGS+2    X'3A' - CLIENT  GROUP                            *         
*                    X'3B' - PRODUCT GROUP                            *         
*                    X'3C' - PUB     GROUP                            *         
*        GLARGS+3    GROUP SCHEME CODE                                *         
*                                                                     *         
*EXIT   0(5,R2) - GROUP CODE                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IGP      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC                                                          
*                                                                               
*        BUILD KEY FOR GROUP PASSIVE POINTERS                                   
*                                                                               
         XC    IGPKEY,IGPKEY       ESTABLISH KEY AS GROUP ID DEF                
         LA    R4,IGPKEY                                                        
         USING GRPPKEY,R4                                                       
*                                                                               
         MVC   GRPPAGY,PBAGY       SET AGENCY                                   
         MVC   GRPPMED,PBMED       SET MEDIA                                    
         MVC   GRPPTYP,GLARGS+2    SET GROUP TYPE                               
*                                                                               
         OC    GRPPVAL,SPACES      BLANK FILL                                   
*                                                                               
         MVC   GRPPID,GLARGS+3     SET GROUP SCHEME                             
*                                                                               
         CLI   GRPPTYP,GRPPCGQ     IF CLIENT  GROUP                             
         BNE   *+14                                                             
         MVC   GRPPVAL(L'PBCLT),PBCLT SET CLIENT                                
         B     IGPGRPPX                                                         
*                                                                               
         CLI   GRPPTYP,GRPPPGQ     IF PRODUCT GROUP                             
         BNE   *+20                                                             
         MVC   GRPPCLT,PBCLT          SET CLIENT                                
         MVC   GRPPVAL(L'PBPROD),PBPROD SET PRODUCT                             
         B     IGPGRPPX                                                         
*                                                                               
         CLI   GRPPTYP,GRPPBGQ     IF PUB     GROUP                             
         BNE   *+14                                                             
         MVC   GRPPVAL(L'PBPUB+2),PBPUB SET PUB                                 
         B     IGPGRPPX                                                         
*                                                                               
         B     IGPX                UNKNOWN GROUP TYPE                           
*                                                                               
IGPGRPPX DS     0H                                                              
*                                                                               
         CLC   GRPPKEY(GRPPCODE-GRPPKEY),IGPSAVE                                
         BE    IGPRDX              SKIP IF SAME AS LAST TIME                    
*                                                                               
*        READ POINTER TO SEE IF INCLUDED IN SCHEME                              
*                                                                               
         MVC   KEY,IGPKEY                                                       
*                                                                               
         NI    DMINBTS,X'F7'       DO NOT PASS BACK DELETED RECORDS             
         GOTO1 HIGH                READ GP RECORD                               
*                                                                               
         MVC   IGPSAVE,KEY         SAVE RETURNED POINTER                        
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE LAST KEY READ                        
         OI    DMINBTS,8           PASS BACK DELETED RECORDS                    
*                                                                               
         GOTO1 HIGH                RESET FILE POINTERS                          
*                                                                               
IGPRDX   DS    0H                                                               
*                                                                               
         LA    R4,IGPSAVE          POINT TO RETURNED POINTER                    
*                                                                               
***      TM    GRPKCNTL,X'80'      SKIP IF DELETED                              
***      BO    IGPX                                                             
*                                                                               
         CLC   GRPPKEY(GRPPCODE-GRPPKEY),IGPKEY                                 
         BNE   IGPX                SKIP IF NOT PART OF SCHEME                   
*                                                                               
         MVC   0(1,R2),GRPPID      RETURN GROUP ID                              
         UNPK  1(5,R2),GRPPCODE(3)    RETURN GROUP CODE                         
         MVI   5(R2),0             CLEAR EXTRA DATA                             
*                                                                               
*        DETERMINE IF ALL POSSIBLE DIGITS USED                                  
*                                                                               
IGPBRK   DS    0H                                                               
*                                                                               
         ICM   R6,15,PBAGPBBK      ESTABLISH PUB GROUP BREAK ELM                
         BZ    IGPBRKX             NONE FOUND                                   
         USING GRPBRKD,R6                                                       
*                                                                               
         LLC   RF,GRPBK1LN         GET LENGTH OF 1ST BREAK IN CODE              
         LLC   RE,GRPBK2LN         GET LENGTH OF 2ND BREAK IN CODE              
*                                                                               
         AR    RF,RE               GET TOTAL LENGTH OF BREAKS                   
*                                                                               
IGPBRKLP DS    0H                                                               
*                                                                               
         CHI   RF,4                DONE IF ALL DIGITS USED                      
         BNL   IGPBRKDN                                                         
*                                                                               
         LA    R1,1(RF,R2)         POINT TO NEXT UNUSED DIGIT                   
         MVI   0(R1),C' '          BLANK OUT UNUSED DIGIT                       
*                                                                               
IGPBRKCN DS    0H                                                               
*                                                                               
         AHI   RF,1                NEXT DIGIT                                   
         B     IGPBRKLP                                                         
*                                                                               
IGPBRKDN DS    0H                                                               
*                                                                               
IGPBRKX  DS    0H                                                               
*                                                                               
IGPX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    XL256                                                            
IGPKEY   DS    XL32                PASSIVE KEY BUILD AREA                       
IGPSAVE  DS    XL32                PASSIVE KEY SAVEAREA                         
*                                                                               
         TITLE 'PRWRITER - HEXOUT - IHEX'        '                              
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT INPUT IN HEX                                *         
*              PULLS DATA FROM KEY AREA                               *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*        GLARGS+1 -  DATA TYPE                                        *         
*                    C'K' - KEY                                       *         
*                    C'D' - DISK ADDRESS                              *         
*                                                                     *         
*        R2==>  DRIVER INPUT X'DATA'                                  *         
*        R3==>  DRIVER PRINT AREA                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IHEX     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC                                                          
*                                                                               
         LA    R1,IOKEYSVE         POINT TO LAST READ KEY                       
*                                                                               
         CLI   GLARGS+1,C'K'       IF KEY WANTED                                
         BNE   *+14                                                             
         MVC   0(L'PBUYKEY,R2),0(R1)    RETURN IT                               
         B     IHEXX                                                            
*                                                                               
         CLI   GLARGS+1,C'D'       IF DISK ADDRESS WANTED                       
         BNE   *+14                                                             
         MVC   0(4,R2),27(R1)         RETURN IT                                 
         B     IHEXX                                                            
*                                                                               
IHEXX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - HEXOUT - OHEX'        '                              
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT INPUT IN HEX                                *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*        GLARGS   -  LENGTH OF INPUT                                  *         
*                                                                     *         
*        R2==>  DRIVER INPUT X'DATA'                                  *         
*        R3==>  DRIVER PRINT AREA                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OHEX     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC                                                          
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,GLARGS         GET INPUT LENGTH                             
         BZ    OHEX                NO DATA                                      
*                                                                               
         LR    R4,R2               COPY START OF INPUT                          
         LR    R1,R3               COPY START OF OUTPUT                         
*                                                                               
OHEXLOOP DS    0H                                                               
*                                                                               
         LA    RE,7                MAX LENGTH FOR UNPK INSTRUCTION              
*                                                                               
         CR    RE,R0               DEFAULT TO LESSER LENGTH                     
         BNH   *+6                                                              
         LR    RE,R0                                                            
*                                                                               
         LR    RF,RE               COPY LENGTH                                  
         SLL   RF,1                DOUBLE LENGTH                                
*                                                                               
         AHI   RF,1                INCREMENTS LENGTHS FOR UNPACK                
         AHI   RE,1                                                             
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         BCTR  RE,0                                                             
*                                                                               
         SLL   RF,4                MOVE LENGTH TO LEFT NYBBLE                   
*                                                                               
         OR    RF,RE               COMBINE REGISTERS                            
*                                                                               
         EX    RF,*+8              UNPACK INPUT                                 
         B     *+10                                                             
         UNPK  0(0,R1),0(0,R4)     RESULTS ARE X'F0' TO X'FF'                   
*                                  LAST BYTE IS UNUSABLE                        
OHEXCONT DS    0H                                                               
*                                                                               
         SRL   RF,4                RESTORE OUTPUT EXECUTE LENGTH                
         LA    R1,0(RF,R1)         POINT TO LAST BYTE - ITS GARBAGE             
         LA    R4,0(RE,R4)         POINT TO NEXT INPUT BYTE TO USE              
*                                                                               
         SR    R0,RE               DECREMENT INPUT LENGTH COUNTER               
         BNZ   OHEXLOOP            MORE TO DO                                   
*                                                                               
OHEXDONE DS    0H                                                               
*                                                                               
         SR    R1,R1                                                            
         ICM   R1,1,GLARGS         GET INPUT LENGTH                             
*                                                                               
         SLL   R1,1                DOUBLE LENGTH FOR OUTPUT LENGTH              
         LR    RF,R1               SAVE OUTPUT  LENGTH                          
*                                                                               
         LA    R1,0(R1,R3)         POINT TO ONE BYTE AFTER OUTPUT               
         MVI   0(R1),C' '          FORCE TO BLANK                               
*                                                                               
         LA    R1,OHEXTRAN         POINT TO HEX TRANSLATE TABLE                 
         AHI   R1,-240             ADJUST STARTING POINT                        
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         TR    0(0,R3),0(R1)       TRANSLATE OUTPUT TO HEX                      
*                                                                               
OHEXX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
OHEXTRAN DC    C'0123456789ABCDEF'  HEX TRANSLATE TABLE                         
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRITER - I/O HISTORY INPUT -IHIO'                            
***********************************************************************         
*                                                                     *         
*        INSERTION ORDER HISTORY                                      *         
*                                                                     *         
*NTRY    GLARGS      C'B' - BUY    RECORD                             *         
*        GLARGS+1    C'H' - HISTORY DATA                              *         
*        GLARGS+2    - DATA TYPE -                                    *         
*                    C'D' - DATE                                      *         
*                    C'#' - NUMBER                                    *         
*                    C'S' - SOURCE                                    *         
*                    C'T' - TYPE                                      *         
*        GLARGS+3    XL1 - MAX NUMBER OF I/O ENTRIES                  *         
*                                                                     *         
*EXIT    R2==>   CL1 - MEDIA                                          *         
*                XL3 - DATE                                           *         
*                XL5 - NUMBER                                         *         
*                XL2 - SOURCE/TYPE                                    *         
*                CL3 - CLT - IF EIO                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IHIO     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBUYRECD,R4         ESTABLISH BUY RECORD                         
*                                                                               
         LA    R6,PBUYREC+33       SEARCH FOR INSERTION ORDER ELEMS             
         SR    R5,R5               INIT ELEMENT POINTER                         
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,GLARGS+3       GET NUMBER OF ENTRIES ALLOWED                
         BNZ   *+8                                                              
         LA    R0,1                DEFAULT IS 1                                 
*                                                                               
IHIOLP   DS    0H                                                               
*                                                                               
         USING PIOELD,R6           ESTABLISH INSERTION ORDER ELEMENT            
*                                                                               
         CLI   PIOELEM,0           DONE AT END OF RECORD                        
         BE    IHIODN                                                           
*                                                                               
         CLI   PIOELEM,PIOELQ      SKIP IF NOT INSERTION ORDER ELEMENT          
         BE    *+8                                                              
         CLI   PIOELEM,PIOELQ      OR    EIO                                    
         BNE   IHIOCN                                                           
*                                                                               
         OC    PIODATE,PIODATE     SKIP IF NO DATE PRESENT                      
         BZ    IHIOCN                                                           
*                                                                               
*        I/O HISTORY                                                            
*                                                                               
IHIOH    DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'H'       IF LOOKING FOR HISTORY                       
         BNE   IHIOHN                                                           
*                                                                               
         BAS   RE,IHIOOUT             FORMAT OUTPUT FOR ELEMENT                 
*                                                                               
         LA    R2,14(R2)              BUMP TO NEXT OUTPUT AREA                  
*                                                                               
         BCT   R0,IHIOCN              COUNT NUMBER OF ENTRIES                   
*                                                                               
         B     IHIODN                 MAX REACHED                               
*                                                                               
IHIOHN   DS    0H                                                               
*                                                                               
*        LAST I/O                                                               
*                                                                               
         CLI   GLARGS+1,C'L'       IF LOOKING FOR LAST INSERTION ORDER          
         BNE   IHIOLN                                                           
*                                                                               
         LTR   R5,R5                  SAVE ADDRESS IF FIRST ELEMENT             
         BZ    IHIOL10                                                          
*                                                                               
         CLC   PIODATE,PIODATE-PIOELD(R5)    SKIP IF DATE NOT AFTER             
         BL    IHIOLX                            LATEST FOUND ALREADY           
         BH    IHIOL10                           NEW LATEST                     
*                                                                               
         CLI   PIOELEM,PWIOELCQ    IF EIO ELEMENT                               
         BNE   IHIOL05                                                          
*                                                                               
         CLC   PIONUM,PWIONUMB-PWIOELEM(R5) SKIP IF NOT A NEW HIGH #            
         BNH   IHIOLX                                                           
*                                                                               
         B     IHIOL10                                                          
*                                                                               
IHIOL05  DS    0H                                                               
*                                                                               
         CLC   PIONUM(2),PIONUM-PIOELD(R5)    SKIP IF NUMBER NOT AFTER          
         BNH   IHIOLX                            HIGHEST FOUND ALREADY          
*                                                                               
IHIOL10  DS    0H                                                               
*                                                                               
         LR    R5,R6                  SAVE ELEMENT ADDRESS                      
*                                                                               
IHIOLX   DS    0H                                                               
         B     IHIOCN                                                           
*                                                                               
IHIOLN   DS    0H                  LOOKING FOR FIRST I/O                        
*                                                                               
*        FIRST I/O                                                              
*                                                                               
         LTR   R5,R5                  SAVE ADDRESS IF FIRST ELEMENT             
         BZ    IHIOF10                                                          
*                                                                               
         CLC   PIODATE,PIODATE-PIOELD(R5)    SKIP IF DATE NOT BEFORE            
         BH    IHIOFX                            EARLIEST FOUND ALREADY         
         BL    IHIOF10                           NEW EARLIEST                   
*                                                                               
         CLC   PIONUM,PWIONUMB-PWIOELEM(R5) SKIP IF NOT A NEW LOW #             
         BNL   IHIOFX                                                           
*                                                                               
         B     IHIOF10                                                          
*                                                                               
IHIOF05  DS    0H                                                               
*                                                                               
         CLC   PIONUM(2),PIONUM-PIOELD(R5)    SKIP IF NUMBER NOT BEFORE         
         BNL   IHIOFX                            LOWEST FOUND ALREADY           
*                                                                               
IHIOF10  DS    0H                                                               
*                                                                               
         LR    R5,R6                  SAVE ELEMENT ADDRESS                      
*                                                                               
IHIOFX   DS    0H                                                               
*                                                                               
IHIOCN DS      0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R6)            BUMP TO NEXT ELEMENT                         
         LA    R6,PIOELD(RF)                                                    
         B     IHIOLP                                                           
*                                                                               
IHIODN DS      0H                                                               
*                                                                               
         CLI   GLARGS+1,C'H'       DONE IF HISTORY                              
         BE    IHIOX                                                            
*                                                                               
         LTR   R6,R5               POINT TO FOUND I/O ELEMENT                   
         BZ    IHIOX                  NONE FOUND                                
*                                                                               
         BAS   RE,IHIOOUT          FORMAT OUTPUT FROM ELEMENT                   
*                                                                               
IHIOX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
*        ROUTINE TO FORMAT OUTPUT FROM AN ELEMENT                               
*                                                                               
*NTRY    R6==>   PIOELD                                                         
*        R2==>   OUTPUT AREA                                                    
*                                                                               
*EXIT    R2==>   CL1 - MEDIA                                                    
*                XL3 - DATE                                                     
*                XL5 - NUMBER                                                   
*                XL2 - SOURCE/TYPE                                              
*                XL3 - CLT - IF EIO                                             
*                                                                               
IHIOOUT  DS    0H                                                               
*                                                                               
         MVC   0(1,R2),PBUYKMED    MEDIA                                        
         MVC   1(3,R2),PIODATE     DATE                                         
         MVC   4(5,R2),PIONUM      NUMBER                                       
         MVC   9(1,R2),PIOTYP      TYPE                                         
         MVC   10(1,R2),PIOTURN     SOURCE                                      
*                                                                               
         CLI   PIOELEM,PWIOELCQ    IF EIO                                       
         BNE   *+10                                                             
         MVC   11(3,R2),PBUYKCLT      PASS CLIENT CODE                          
*                                                                               
IHIOOUTX DS    0H                                                               
         BR    RE                  RETURN                                       
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRITER - I/O HISTORY OUTPUT -OHIO'                           
***********************************************************************         
*                                                                     *         
*        INSERTION ORDER HISTORY                                      *         
*                                                                     *         
*NTRY    R2==>   CL1 - MEDIA                                          *         
*                XL3 - DATE                                           *         
*                XL5 - NUMBER                                         *         
*                XL2 - SOURCE/TYPE                                    *         
*                XL3 - CLT - IF EIO                                   *         
*        GLARGS      C'H' - HISTORY DATA                              *         
*        GLARGS+1    - DATA TYPE -                                    *         
*                    C'D' - DATE                                      *         
*                    C'#' - NUMBER                                    *         
*                    C'S' - SOURCE                                    *         
*                    C'T' - TYPE                                      *         
*        GLARGS+2    XL1 - MAX NUMBER OF I/O ENTRIES                  *         
*                                                                     *         
*                                                                     *         
*EXIT    R3==>  PRINTED OUTPUT                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OHIO     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         SR    R0,R0               GET MAX NUMBER OF ENTRIES HANDLED            
         ICM   R0,1,GLARGS+2                                                    
         BNZ   *+8                                                              
         LA    R0,1                DEFAULT IS 1                                 
*                                                                               
OHIOLP   DS    0H                                                               
*                                                                               
         OC    0(8,R2),0(R2)       CONTINUE IF NO DATA                          
         BZ    OHIOCN                                                           
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+1,C'#'       I/O NUMBER                                   
         BE    OHIO#                                                            
*                                                                               
         CLI   GLARGS+1,C'D'       I/O DATE                                     
         BE    OHIODT                                                           
*                                                                               
         CLI   GLARGS+1,C'S'       I/O SOURCE                                   
         BE    OHIOSR                                                           
*                                                                               
         CLI   GLARGS+1,C'T'       I/O TYPE                                     
         BE    OHIOTP                                                           
*                                                                               
         B     OHIOX               UNKNOWN KEYWORD                              
*                                                                               
*        I/O NUMBER                                                             
*                                                                               
OHIO#    DS    0H                                                               
*                                                                               
         CLC   11(3,R2),SPACES     IF CLIENT GIVEN                              
         BNE   OHIO#EIN               THEN EIO INSERTION ORDER                  
*                                                                               
*        EIO# - M-YYCLT000R000                                                  
*                                                                               
         MVC   0(1,R3),0(R2)       DISPLAY MEDIA                                
*                                                                               
         MVI   1(R3),C'-'                                                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,4(R3)          GET YEAR                                     
         CVD   RF,DUB              CVD                                          
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  2(2,R3),DUB         DISPLAY YEAR                                 
*                                                                               
         MVC   4(3,R3),11(R2)      CLIENT                                       
*                                                                               
         CLI   6(R3),C' '          REPLACE BLANK WITH DASH                      
         BH    *+8                                                              
         MVI   6(R3),C'-'                                                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,7,5(R2)          GET SQN NUMBER                               
         CVD   RF,DUB              CVD                                          
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  7(4,R3),DUB         DISPLAY SQN                                  
*                                                                               
         CLI   8(R2),0             SKIP IF NO REVISION NUMBER                   
         BE    OHIO#RVX                                                         
*                                                                               
         MVI   1(R3),C'-'                                                       
*                                                                               
         MVC   12(3,R3),=C'REV'    SET REVISION ID                              
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,8(R2)          GET REVISION NUMBER                          
         CVD   RF,DUB              CVD                                          
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  15(3,R3),DUB        DISPLAY REVISION NUMBER                      
*                                                                               
OHIO#RVX DS    0H                                                               
*                                                                               
         B     OHIOCN                                                           
*                                                                               
OHIO#EIN DS    0H                                                               
*                                                                               
*        OLD INSERTION ORDER NUMBER                                             
*                                                                               
         MVC   0(1,R3),0(R2)       MEDIA                                        
*                                                                               
         GOTO1 DATCON,DMCB,(3,1(R2)),(0,1(R3))  DATE - YYMMDD                   
*                                                                               
         MVI   1(R3),C'-'          KILL DECADE                                  
*                                                                               
         MVI   7(R3),C'-'                                                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,4(R2)          INSERTION ORDER NUMBER                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  8(4,R3),DUB         PRINT NUMBER                                 
*                                                                               
         B     OHIOCN                                                           
*                                                                               
*        INSERTION ORDER DATE                                                   
*                                                                               
OHIODT DS      0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(3,1(R2)),(5,0(R3))  DISPLAY DATE                    
*                                                                               
         B     OHIOCN                                                           
*                                                                               
*        INSERTION ORDER  - SOURCE                                              
*                                                                               
OHIOSR DS      0H                                                               
*                                                                               
         LA    R4,OHIOSRTB         POINT TO TABLE OF SOURCES                    
*                                                                               
         CLI   0(R4),X'FF'         DONE AT END OF TABLE                         
         BE    OHIOSRX                                                          
         CLC   9(1,R2),0(R4)       FIND SOURCE IN TABLE                         
         BE    *+12                                                             
         LA    R4,4(R4)            NEXT ENTRY IN TABLE                          
         B     *-22                                                             
*                                                                               
         MVC   0(3,R3),1(R4)       DISPLAY SOURCE                               
*                                                                               
OHIOSRX  DS    0H                                                               
*                                                                               
         B     OHIOCN                                                           
*                                                                               
OHIOSRTB DS    0H                  TABLE OF SOURCES                             
*                                                                               
         DC    X'00',C'ONL'        ON-LINE                                      
         DC    C'T',C'TRN'         TURNAROUND                                   
         DC    C'R',C'REQ'         REQUESTED                                    
         DC    C'M',C'MAN'         MANUAL                                       
         DC    C'W',C'WEB'         WEB DELIVERY                                 
         DC    X'FF'               END OF TABLE                                 
*                                                                               
*        INSERTION ORDER - TYPE                                                 
*                                                                               
OHIOTP DS      0H                                                               
*                                                                               
         LA    R4,OHIOTPTB         POINT TO TABLE OF TYPES                      
*                                                                               
         CLI   0(R4),X'FF'         DONE AT END OF TABLE                         
         BE    OHIOTPX                                                          
         CLC   8(1,R2),0(R4)       FIND TYPE IN TABLE                           
         BE    *+12                                                             
         LA    R4,4(R4)            NEXT ENTRY IN TABLE                          
         B     *-22                                                             
*                                                                               
         MVC   0(3,R3),1(R4)       DISPLAY TYPE                                 
*                                                                               
OHIOTPX  DS    0H                                                               
*                                                                               
         B     OHIOCN                                                           
*                                                                               
OHIOTPTB DS    0H                  TABLE OF TYPES                               
*                                                                               
         DC    C'N',C'NEW'         NEW                                          
         DC    C'C',C'CHA'         CHANGE                                       
         DC    C'D',C'CAN'         CANCELLED                                    
         DC    C'U',C'UNC'         UNCHANGED                                    
         DC    X'FF'               END OF TABLE                                 
*                                                                               
OHIOCN   DS    0H                                                               
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT PRINT LINE                      
         LA    R2,8(R2)            POINT TO NEXT INPUT                          
         BCT   R0,OHIOLP           GO PROCESS NEXT INPUT                        
*                                                                               
OHIODN   DS    0H                                                               
*                                                                               
OHIOX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRITER - I/O HISTORY INPUT -IEIO'                            
***********************************************************************         
*                                                                     *         
*        ENHANCED INSERTION ORDERS                                    *         
*                                                                     *         
*NTRY    GLARGS      C'B' - BUY    RECORD                             *         
*        GLARGS+1    C'H' - HISTORY DATA                              *         
*                    C'F' - FIRST IO DATA                             *         
*                    C'L' - LAST  IO DATA                             *         
*        GLARGS+2    - I/O OR SPACE RESERVATIONS                      *         
*                    C'I' - INSERTION ORDERS                          *         
*                    C'S' - SPACE RESERVATIONS                        *         
*        GLARGS+3    - DATA TYPE -                                    *         
*                    C'#' - NUMBER                                    *         
*                    C'D' - DATE                                      *         
*                    C'G' - HOW GENERATED                             *         
*                    C'T' - TYPE                                      *         
*                    C'S' - STATUS                                    *         
*                    C'R' - STATUS DATE                               *         
*                    C'L' - LEGAL WARNING CODE                        *         
*                    C'Q' - QUARTERLY LEGAL WARNING CODE              *         
*                    C'2' - BOTH QUARTERLY AND REGULAR WARNING CODE   *         
*        GLARGS+4    XL1 - MAX NUMBER OF I/O ENTRIES                  *         
*                            ZERO DEFAULTS TO 1                       *         
*                                                                     *         
*EXIT    R2==>   CL1 - MEDIA   FOR NUMBERS ELSE ACTUAL DATA           *         
*                XL3 - DATE                                           *         
*                XL5 - NUMBER                                         *         
*                XL2 - SOURCE/TYPE                                    *         
*                CL3 - CLT - IF EIO OR ESR                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IEIO     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBUYRECD,R4         ESTABLISH BUY RECORD                         
*                                                                               
         LA    R6,PBUYREC+33       SEARCH FOR INSERTION ORDER ELEMS             
         SR    R5,R5               INIT ELEMENT POINTER                         
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,GLARGS+4       GET NUMBER OF ENTRIES ALLOWED                
         BNZ   *+8                                                              
         LA    R0,1                DEFAULT IS 1                                 
*                                                                               
IEIOLP   DS    0H                                                               
*                                                                               
*        I/O AND SPACE RESERVATION ELEMENTS ARE IDENTICAL                       
*              IN STRUCTURE                                                     
*                                                                               
         USING PIOELD,R6           ESTABLISH INSERTION ORDER ELEMENT            
*                                                                               
         CLI   PIOELEM,0           DONE AT END OF RECORD                        
         BE    IEIODN                                                           
*                                                                               
         CLI   GLARGS+1,C'I'       IF INSERTION ORDERS                          
         BNE   IEIOION                                                          
*                                                                               
         CLI   PIOELEM,PWIOELCQ       SKIP IF NOT INSORD ELEMENT                
         BE    *+8                                                              
         CLI   PIOELEM,PIOELQ         OR    EIO ELEMENT                         
         BNE   IEIOCN                                                           
*                                                                               
         B     IEIOSRX                                                          
*                                                                               
IEIOION  DS    0H                  CHECK FOR ESR ELEMENT                        
*                                                                               
         CLI   PIOELEM,PESRELCQ    SKIP IF NOT ESR ELEMENT                      
         BNE   IEIOCN                                                           
*                                                                               
IEIOSRX  DS    0H                                                               
*                                                                               
         OC    PIODATE,PIODATE     SKIP IF NO DATE PRESENT                      
         BZ    IEIOCN                                                           
*                                                                               
*        I/O HISTORY                                                            
*                                                                               
IEIOH    DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'H'       IF LOOKING FOR HISTORY                       
         BNE   IEIOHN                                                           
*                                                                               
         BAS   RE,IEIOOUT             FORMAT OUTPUT FOR ELEMENT                 
*                                                                               
         BCT   R0,IEIOCN              COUNT NUMBER OF ENTRIES                   
*                                                                               
         B     IEIODN                 MAX REACHED                               
*                                                                               
IEIOHN   DS    0H                                                               
*                                                                               
*        LAST I/O                                                               
*                                                                               
         CLI   GLARGS+2,C'L'       IF LOOKING FOR LAST INSERTION ORDER          
         BNE   IEIOLN                                                           
*                                                                               
         LTR   R5,R5                  SAVE ADDRESS IF FIRST ELEMENT             
         BZ    IEIOL10                                                          
*                                                                               
         CLC   PIODATE,PIODATE-PIOELD(R5)    SKIP IF DATE NOT AFTER             
         BL    IEIOLX                            LATEST FOUND ALREADY           
         BH    IEIOL10                           NEW LATEST                     
*                                                                               
         CLI   PIOELEM,PWIOELCQ    IF EIO ELEMENT                               
         BE    *+8                                                              
         CLI   PIOELEM,PESRELCQ    OR ESR ELEMENT                               
         BNE   IEIOL05                                                          
*                                                                               
         CLC   PIONUM,PWIONUMB-PWIOELEM(R5) SKIP IF NOT A NEW HIGH #            
         BNH   IEIOLX                                                           
*                                                                               
         B     IEIOL10                                                          
*                                                                               
IEIOL05  DS    0H                                                               
*                                                                               
         CLC   PIONUM(2),PIONUM-PIOELD(R5)    SKIP IF NUMBER NOT AFTER          
         BNH   IEIOLX                            HIGHEST FOUND ALREADY          
*                                                                               
IEIOL10  DS    0H                                                               
*                                                                               
         LR    R5,R6                  SAVE ELEMENT ADDRESS                      
*                                                                               
IEIOLX   DS    0H                                                               
         B     IEIOCN                                                           
*                                                                               
IEIOLN   DS    0H                  LOOKING FOR FIRST I/O                        
*                                                                               
*        FIRST I/O                                                              
*                                                                               
         LTR   R5,R5                  SAVE ADDRESS IF FIRST ELEMENT             
         BZ    IEIOF10                                                          
*                                                                               
         CLI   PIOELEM,PWIOELCQ    IF EIO ELEMENT                               
         BE    *+8                                                              
         CLI   PIOELEM,PESRELCQ    OR ESR ELEMENT                               
         BNE   IEIOF05                                                          
*                                                                               
         CLC   PIODATE,PIODATE-PIOELD(R5)    SKIP IF DATE NOT BEFORE            
         BH    IEIOFX                            EARLIEST FOUND ALREADY         
         BL    IEIOF10                           NEW EARLIEST                   
*                                                                               
         CLC   PIONUM,PWIONUMB-PWIOELEM(R5) SKIP IF NOT A NEW LOW #             
         BNL   IEIOFX                                                           
*                                                                               
         B     IEIOF10                                                          
*                                                                               
IEIOF05  DS    0H                                                               
*                                                                               
         CLC   PIONUM(2),PIONUM-PIOELD(R5)    SKIP IF NUMBER NOT BEFORE         
         BNL   IEIOFX                            LOWEST FOUND ALREADY           
*                                                                               
IEIOF10  DS    0H                                                               
*                                                                               
         LR    R5,R6                  SAVE ELEMENT ADDRESS                      
*                                                                               
IEIOFX   DS    0H                                                               
*                                                                               
IEIOCN DS      0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,1(R6)            BUMP TO NEXT ELEMENT                         
         LA    R6,PIOELD(RF)                                                    
         B     IEIOLP                                                           
*                                                                               
IEIODN DS      0H                                                               
*                                                                               
         CLI   GLARGS+2,C'H'       DONE IF HISTORY                              
         BE    IEIOX                                                            
*                                                                               
         LTR   R6,R5               POINT TO FOUND I/O ELEMENT                   
         BZ    IEIOX                  NONE FOUND                                
*                                                                               
         BAS   RE,IEIOOUT          FORMAT OUTPUT FROM ELEMENT                   
*                                                                               
IEIOX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRITER - I/O HISTORY INPUT -IEIOOUT'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FORMAT OUTPUT FROM AN ELEMENT                     *         
*                                                                     *         
*NTRY    R6==>   PIOELD                                               *         
*        R2==>   OUTPUT AREA                                          *         
*                                                                     *         
*EXIT    R2==>   CL1 - MEDIA                                          *         
*                XL3 - DATE                                           *         
*                XL5 - NUMBER                                         *         
*                XL3 - CLT - IF EIO                                   *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
IEIOOUT  NTR1  BASE=*,LABEL=*,WORK=(RC,500)                                     
*                                                                               
         ST    RC,IEIOOAIO         SAVE WORKING STORAGE POINTER                 
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         USING PIOELD,R6           ESTABLISH INSERTION ORDER ELEMENT            
*                                                                               
         CLI   GLARGS+3,C'#'       I/O NUMBER                                   
         BE    IEIOO#                                                           
*                                                                               
         CLI   GLARGS+3,C'D'       I/O DATE                                     
         BE    IEIOODT                                                          
*                                                                               
         CLI   GLARGS+3,C'T'       I/O TYPE                                     
         BE    IEIOOTP                                                          
*                                                                               
         CLI   GLARGS+3,C'S'       I/O STATUS                                   
         BE    IEIOOST                                                          
*                                                                               
         CLI   GLARGS+3,C'L'       I/O LEGAL WARNING CODE                       
         BE    IEIOOLW                                                          
*                                                                               
         CLI   GLARGS+3,C'Q'       I/O QUARTERLY LEGAL WARNING                  
         BE    IEIOOQW                                                          
*                                                                               
         CLI   GLARGS+3,C'2'       I/O BOTH LEGAL AND QUARTERLY                 
         BE    IEIOO2W                                                          
*                                                                               
         B     IEIOOUTX            UNKNOWN KEYWORD                              
*                                                                               
*        INSERTION ORDER NUMBER                                                 
*                                                                               
IEIOO#   DS    0H                                                               
*                                                                               
         MVC   0(1,R2),PBUYKMED    MEDIA                                        
         MVC   1(3,R2),PIODATE     DATE                                         
         MVC   4(5,R2),PIONUM      NUMBER                                       
*                                                                               
         CLI   PIOELEM,PIOELQ      SKIP IF OLD IO                               
         BE    *+10                                                             
         MVC   09(3,R2),PBUYKCLT      PASS CLIENT CODE                          
*                                                                               
         LA    R2,12(R2)           BUMP OUTPUT POINTER                          
*                                                                               
         B     IEIOOUTX                                                         
*                                                                               
IEIOODT  DS    0H                                                               
*                                                                               
*        INSERTION ORDER DATE                                                   
*                                                                               
         MVC   0(3,R2),PIODATE     RETURN IO DATE                               
         LA    R2,3(R2)            BUMP OUTPUT POINTER                          
*                                                                               
         B     IEIOOUTX                                                         
*                                                                               
IEIOODTN DS    0H                                                               
*                                                                               
*        INSERTION ORDER - TYPE                                                 
*                                                                               
IEIOOTP  DS    0H                                                               
*                                                                               
         LA    R4,IEIOTPTB         POINT TO TABLE OF TYPES                      
*                                                                               
         CLI   0(R4),X'FF'         DONE AT END OF TABLE                         
         BE    IEIOOTPX                                                         
         CLC   PIOTYP,0(R4)        FIND TYPE IN TABLE                           
         BE    *+12                                                             
         LA    R4,4(R4)            NEXT ENTRY IN TABLE                          
         B     *-22                                                             
*                                                                               
         MVC   0(3,R2),1(R4)       DISPLAY TYPE                                 
*                                                                               
         LA    R2,3(R2)            BUMP OUTPUT POINTER                          
*                                                                               
IEIOOTPX DS    0H                                                               
*                                                                               
         B     IEIOOUTX                                                         
*                                                                               
IEIOTPTB DS    0H                  TABLE OF TYPES                               
*                                                                               
         DC    C'N',C'NEW'         NEW                                          
         DC    C'C',C'CHA'         CHANGE                                       
         DC    C'D',C'CAN'         CANCELLED                                    
         DC    X'FF'               END OF TABLE                                 
*                                                                               
*        INSERTION ORDER - STATUS                                               
*                                                                               
IEIOOST  DS    0H                                                               
*                                                                               
         USING PWIOELEM,R6         ESTABLISH EIO ELEMENT                        
*                                                                               
         XC    KEY,KEY             ESTABLISH EIO/ESR KEY                        
         LA    R4,KEY                                                           
         USING WIOKEY,R4                                                        
*                                                                               
         MVC   WIOKAGY,PBAGY       SET AGENCY                                   
         MVC   WIOKMED,PBMED       SET MEDIA                                    
         MVI   WIOKRCD,WIOKRCDQ    SET RECORD ID                                
         CLI   GLARGS+1,C'S'       IF ESR                                       
         BNE   *+8                                                              
         MVI   WIOKRCD,ESRKRCDQ       CHANGE RECORD ID                          
         MVC   WIOKCLT,PBCLT       SET CLIENT                                   
         MVC   WIOKPUB,PBPUB       SET CLIENT                                   
         MVC   WIOKIO#,PWIONUMB    SET IO#                                      
         MVC   WIOKRV#,PWIO#REV    SET REVISION #                               
*                                                                               
         CLC   WIOKEY(WIOKELMK-WIOKEY),IEIOOKEY                                 
         BE    IEIOOST1            CHECK IF WE HAVE ALREADY READ REC            
*                                                                               
         XC    IEIOOKEY,IEIOOKEY   INIT SAVEAREAS                               
         XC    IEIOOHDR,IEIOOHDR                                                
*                                                                               
         GOTO1 HIGH                READ FIRST OF THE MINIO KEYS                 
*                                                                               
         CLC   WIOKEY(WIOKELMK-WIOKEY),KEYSAVE                                  
         BNE   IEIOOUTX            SKIP IF RECORD NOT FOUND                     
*                                                                               
         MVC   IEIOOASV,AIO        SAVE CURRENT A(IOAREA)                       
         MVC   AIO,IEIOOAIO        SET A(IOAREA)                                
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
         MVC   AIO,IEIOOASV        RESTORE A(IOAREA)                            
*                                                                               
         L     R4,IEIOOAIO         POINT TO FOUND RECORD                        
         LA    R6,WIOFIRST         POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
*        FIND HEADER ELEMENT - HAS TO BE IN FIRST MINIO RECORD                  
*                                                                               
         SR    RF,RF                                                            
*                                                                               
IEIOOSTL DS    0H                                                               
*                                                                               
         USING WIOHDRD,R6          ESTABLISH HEADER ELEMENT                     
*                                                                               
         CLI   WIOHKCDE,0          SKIP IF NOT FOUND                            
         BE    IEIOOUTX                                                         
*                                                                               
         CLI   WIOHKCDE,WIOHKIDQ   MATCH RECORD CODE FOR HEADER ELM             
         BNE   IEIOOSTC                                                         
*                                                                               
         OC    WIOHKSPR,WIOHKSPR   MUST BE NULLS                                
         BZ    IEIOOSTF                                                         
*                                                                               
IEIOOSTC DS    0H                                                               
*                                                                               
         IC    RF,WIOHKLEN         GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     IEIOOSTL                                                         
*                                                                               
IEIOOSTF DS    0H                                                               
*                                                                               
         MVC   IEIOOKEY,WIOKEY     SAVE KEY                                     
         MVC   IEIOOHDR,WIOHDRD    SAVE HEADER                                  
*                                                                               
IEIOOST1 DS    0H                                                               
*                                                                               
         LA    R6,IEIOOHDR         POINT TO HEADER                              
*                                                                               
*        FIND STATUS IN TABLE                                                   
*                                                                               
         LA    R1,STATUSTB         POINT TO LIST STATUSES                       
*                                                                               
IEIOSTLP DS    0H                                                               
*                                                                               
         CLI   0(R1),X'FF'         DONE AT END OF TABLE                         
         BE    IEIOSTDN                                                         
*                                                                               
         CLC   WIOHSTAT,0(R1)      FIND STATUS CODE IN TABLE                    
         BE    IEIOSTFD                                                         
*                                                                               
IEIOSTCN DS    0H                                                               
*                                                                               
         LA    R1,16(R1)           BUMP TO NEXT ENTRY IN TABLE                  
         B     IEIOSTLP                                                         
*                                                                               
IEIOSTFD DS    0H                                                               
*                                                                               
         MVC   0(15,R2),1(R1)      RETURN EXPANDED STATUS                       
*                                                                               
         LA    R2,15(R2)           BUMP INPUT POINTER                           
*                                                                               
IEIOSTDN DS    0H                                                               
*                                                                               
IEIOOSTX DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE CURRENT KEY                          
*                                                                               
         OI    DMINBTS,8           PASS BACK DELETED RECORDS                    
         GOTOR HIGH                RESTORE FILE POINTERS                        
*                                                                               
         B     IEIOOUTX                                                         
*                                                                               
IEIOOAIO DS    A                   A(IOAREA FOR WIO RECORD)                     
IEIOOASV DS    A                   CURRENT A(IOAREA)                            
IEIOOKEY DS    XL32                KEY OF LAST EIO                              
IEIOOHDR DS    XL256               LAST EIO HEADER READ                         
*                                                                               
***********************************************************************         
*                                                                     *         
*        STATUS TABLE                                                 *         
*              CL1    CODE                                            *         
*              CL15   EXPANSION                                       *         
*                                                                     *         
***********************************************************************         
         DS    0D                                                               
STATUSTB DS    0CL116                                                           
         DC    AL1(WIOSGENQ),CL15'GENERATED' DEFAULT                            
         DC    AL1(0),CL15'GENERATED'      DEFAULT                              
         DC    AL1(WIOSAPPQ),CL15'APPROVED '                                    
         DC    AL1(WIOSDLVQ),CL15'DELIVERED'                                    
         DC    AL1(WIOSREJQ),CL15'REJECTED '                                    
         DC    AL1(WIOSRSTQ),CL15'RESENT  '                                     
         DC    AL1(WIOSRSTQ),CL15'RE-SENT '                                     
         DC    AL1(WIOSSNTQ),CL15'SENT '                                        
         DC    AL1(WIOSUDLQ),CL15'UNDELIVERED'                                  
         DC    AL1(WIOSACCQ),CL15'ACCESSED   '                                  
         DC    AL1(WIOSEXPQ),CL15'TIME EXPIRED'                                 
STATUSTX DC    X'FF'               END OF TABLE                                 
*                                                                               
*        INSERTION ORDER - LEGAL WARNING CODE                                   
*                                                                               
IEIOOLW  DS    0H                                                               
*                                                                               
         USING PIOELD,R6           ESTABLISH INSERTION ORDER ELEMENT            
*                                                                               
         MVC   0(1,R2),PIOLWCD     LEGAL WARNING CODE                           
*                                                                               
         LA    R2,1(R2)            BUMP OUTPUT POINTER                          
*                                                                               
IEIOOLWX DS    0H                                                               
*                                                                               
         B     IEIOOUTX                                                         
*                                                                               
*        INSERTION ORDER - QUARTERLY LEGAL WARNING CODE                         
*                                                                               
IEIOOQW  DS    0H                                                               
*                                                                               
         MVC   0(1,R2),PIOQUCD     QUARTERLY LEGAL WARNING CODE                 
*                                                                               
         LA    R2,1(R2)            BUMP OUTPUT POINTER                          
*                                                                               
IEIOOQWX DS    0H                                                               
*                                                                               
         B     IEIOOUTX                                                         
*                                                                               
*        INSERTION ORDER - LEGAL & QUARTERLY WARNING CODE                       
*                                                                               
IEIOO2W  DS    0H                                                               
*                                                                               
         MVC   0(2,R2),PIOLWCD     LEGAL & QUARTERLY WARNING CODE               
*                                                                               
         LA    R2,2(R2)            BUMP OUTPUT POINTER                          
*                                                                               
IEIOO2WX DS    0H                                                               
*                                                                               
         B     IEIOOUTX                                                         
*                                                                               
IEIOOUTX DS    0H                                                               
         XIT1  REGS=(R2)           RETURN                                       
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRITER - I/O HISTORY OUTPUT -OEIO'                           
***********************************************************************         
*                                                                     *         
*        INSERTION ORDER HISTORY                                      *         
*                                                                     *         
*NTRY    R2==>   CL1 - MEDIA - IO # ONLY                              *         
*                XL3 - DATE                                           *         
*                XL5 - NUMBER                                         *         
*                XL3 - CLT - IF EIO                                   *         
*        GLARGS      C'B' - BUY RECORD DATA                           *         
*        GLARGS+1    C'H' - HISTORY DATA                              *         
*                    C'F' - FIRST IO DATA                             *         
*                    C'L' - LAST  IO DATA                             *         
*        GLARGS+2    - I/O OR SPACE RESERVATIONS                      *         
*                    C'I' - INSERTION ORDERS                          *         
*                    C'S' - SPACE RESERVATIONS                        *         
*        GLARGS+3    - DATA TYPE -                                    *         
*                    C'#' - NUMBER                                    *         
*                    C'D' - DATE                                      *         
*                    C'G' - HOW GENERATED                             *         
*                    C'T' - TYPE                                      *         
*                    C'L' - LEGAL WARNING CODE                        *         
*                    C'Q' - QUARTERLY LEGAL WARNING CODE              *         
*                    C'2' - BOTH QUARTERLY AND REGULAR WARNING CODE   *         
*        GLARGS+4    XL1 - MAX NUMBER OF I/O ENTRIES                  *         
*                            ZERO DEFAULTS TO 1                       *         
*                                                                     *         
*EXIT    R3==>  PRINTED OUTPUT                                        *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OEIO     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         SR    R0,R0               GET MAX NUMBER OF ENTRIES HANDLED            
         ICM   R0,1,GLARGS+4                                                    
         BNZ   *+8                                                              
         LA    R0,1                DEFAULT IS 1                                 
*                                                                               
OEIOLP   DS    0H                                                               
*                                                                               
         OC    0(2,R2),0(R2)       SKIP IF NO DATA                              
         BZ    OEIODN                                                           
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+3,C'#'       I/O NUMBER                                   
         BE    OEIO#                                                            
*                                                                               
         CLI   GLARGS+3,C'D'       I/O DATE                                     
         BE    OEIODT                                                           
*                                                                               
         CLI   GLARGS+3,C'T'       I/O TYPE                                     
         BE    OEIOTP                                                           
*                                                                               
         CLI   GLARGS+3,C'L'       I/O LEGAL WARNING CODE                       
         BE    OEIOTP                                                           
*                                                                               
         CLI   GLARGS+3,C'Q'       I/O QUARTERLY LEGAL WARNING                  
         BE    OEIOTP                                                           
*                                                                               
         CLI   GLARGS+3,C'S'       I/O STATUS                                   
         BE    OEIOST                                                           
*                                                                               
         CLI   GLARGS+3,C'2'       I/O LEGAL AND QUARTERLY WARNING              
         BE    OEIOTP                                                           
*                                                                               
         B     OEIOX               UNKNOWN KEYWORD                              
*                                                                               
*        ENHANCED INERTION ORDER NUMBER                                         
*                                                                               
OEIO#    DS    0H                                                               
*                                                                               
         CLC   09(3,R2),SPACES     IF EIO INSERTION ORDER                       
         BNH   OEIO#EIN                                                         
*                                                                               
*        IO# - M-YYCLT0000(0)R000                                               
*                                                                               
         CLI   GLARGS+1,C'S'       IF SPACE RESERVATION                         
         BNE   *+14                                                             
         MVC   0(2,R3),=C'SR'                                                   
         LA    R3,2(R3)                                                         
*                                                                               
         MVC   0(1,R3),0(R2)       DISPLAY MEDIA                                
*                                                                               
         MVI   1(R3),C'-'                                                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,4(R2)          GET YEAR                                     
         CVD   RF,DUB              CVD                                          
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  2(2,R3),DUB         DISPLAY YEAR                                 
*                                                                               
         MVC   4(3,R3),09(R2)      CLIENT                                       
*                                                                               
         CLI   6(R3),C' '          REPLACE BLANK WITH DASH                      
         BH    *+8                                                              
         MVI   6(R3),C'-'                                                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,7,5(R2)          GET SQN NUMBER                               
         CVD   RF,DUB              CVD                                          
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         LA    RF,4                ASSUME 4 DIGITS                              
         CP    DUB,=P'10000'       IF GT 10,000                                 
         BL    *+8                                                              
         LA    RF,5                   USE 5 DIGITS                              
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         SLL   RF,4                SHIFT TO LEFT NYBBLE                         
         EX    RF,*+8                                                           
         B     *+10                                                             
         UNPK  7(0,R3),DUB         DISPLAY SQN                                  
*                                                                               
         SRL   RF,4                RESTORE TO RIGHT NYBBLE                      
         LA    R1,8(RF,R3)         NEXT OUTPUT AREA                             
*                                                                               
         CLI   8(R2),0             SKIP IF NO REVISION NUMBER                   
         BE    OEIO#RVX                                                         
*                                                                               
         MVI   0(R1),C'-'                                                       
*                                                                               
         MVC   1(3,R1),=C'REV'     SET REVISION ID                              
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,8(R2)          GET REVISION NUMBER                          
         CVD   RF,DUB              CVD                                          
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  4(3,R1),DUB         DISPLAY REVISION NUMBER                      
*                                                                               
OEIO#RVX DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'S'       IF SPACE RESERVATION                         
         BNE   *+8                                                              
         SHI   R3,2                   BACK UP TO START OF NUMBER                
*                                                                               
         LA    R2,12(R2)           BUMP INPUT POINTER                           
*                                                                               
OEIO#EIX DS    0H                                                               
         B     OEIOCN                                                           
*                                                                               
*        OLD INSERTION ORDER NUMBER                                             
*                                                                               
OEIO#EIN DS    0H                                                               
*                                                                               
*        OLD INSERTION ORDER NUMBER                                             
*                                                                               
         MVC   0(1,R3),0(R2)       MEDIA                                        
*                                                                               
         GOTO1 DATCON,DMCB,(3,1(R2)),(0,1(R3))  DATE - YYMMDD                   
*                                                                               
         MVI   1(R3),C'-'          KILL DECADE                                  
*                                                                               
         MVI   7(R3),C'-'                                                       
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,3,4(R2)          INSERTION ORDER NUMBER                       
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  8(4,R3),DUB         PRINT NUMBER                                 
*                                                                               
         LA    R2,12(R2)           BUMP INPUT POINTER                           
*                                                                               
         B     OEIOCN                                                           
*                                                                               
*        INSERTION ORDER DATE                                                   
*                                                                               
OEIODT DS      0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),(5,0(R3))  DISPLAY DATE                    
*                                                                               
         LA    R2,3(R2)            BUMP INPUT POINTER                           
*                                                                               
         B     OEIOCN                                                           
*                                                                               
*        INSERTION ORDER - TYPE                                                 
*                                                                               
OEIOTP DS      0H                                                               
*                                                                               
         MVC   0(3,R3),0(R2)       DISPLAY TYPE                                 
*                                                                               
         LA    R2,3(R2)            BUMP INPUT POINTER                           
*                                                                               
OEIOTPX  DS    0H                                                               
*                                                                               
         B     OEIOCN                                                           
*                                                                               
OEIOTPTB DS    0H                  TABLE OF TYPES                               
*                                                                               
         DC    C'N',C'NEW'         NEW                                          
         DC    C'C',C'CHA'         CHANGE                                       
         DC    C'D',C'CAN'         CANCELLED                                    
         DC    X'FF'               END OF TABLE                                 
*                                                                               
*        INSERTION ORDER - LEGAL WARNING CODE                                   
*                                                                               
OEIOLW DS      0H                                                               
*                                                                               
         MVC   0(1,R3),0(R2)       DISPLAY LEGAL WARNING CODE                   
*                                                                               
         LA    R2,1(R2)            BUMP INPUT POINTER                           
*                                                                               
OEIOLWX  DS    0H                                                               
*                                                                               
*        INSERTION ORDER - QUARTERLY LEGAL WARNING CODE                         
*                                                                               
OEIOQW DS      0H                                                               
*                                                                               
         MVC   0(1,R3),0(R2)       DISPLAY QUARTERLY CODE                       
*                                                                               
         LA    R2,1(R2)            BUMP INPUT POINTER                           
*                                                                               
OEIOQWX  DS    0H                                                               
*                                                                               
*        INSERTION ORDER - LEGAL & QUARTERLY WARNING CODE                       
*                                                                               
OEIO2W DS      0H                                                               
*                                                                               
         MVC   0(1,R3),0(R2)       DISPLAY LEGAL & QUARTERLY CODES              
*                                                                               
         LA    R2,1(R2)            BUMP INPUT POINTER                           
*                                                                               
OEIO2WX  DS    0H                                                               
*                                                                               
*        INSERTION ORDER - STATUS                                               
*                                                                               
OEIOST DS      0H                                                               
*                                                                               
         MVC   0(15,R3),0(R2)      DISPLAY STATUS                               
*                                                                               
         LA    R2,15(R2)           BUMP INPUT POINTER                           
*                                                                               
OEIOSTX  DS    0H                                                               
*                                                                               
         B     OEIOCN                                                           
*                                                                               
OEIOCN   DS    0H                                                               
*                                                                               
         LA    R3,198(R3)          BUMP TO NEXT PRINT LINE                      
         BCT   R0,OEIOLP           GO PROCESS NEXT INPUT                        
*                                                                               
OEIODN   DS    0H                                                               
*                                                                               
OEIOX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'INSERTION DATE KEYWORDS - INPUT - IINDATE'                      
***********************************************************************         
*                                                                     *         
*               INSERTION DATE KEYWORDS - INPUT                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
IINDATER NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBMODE,PBPROCNV     IF PROCESSING NEW INVOICES                   
         BNE   IINDNVN                                                          
*                                                                               
         ICM   R6,15,PBIDTELA      POINT TO INVOICE DETAIL                      
         BZ    IINDIVX             SKIP IF NONE AVAILABLE                       
         USING PNVDTLD,R6          ESTABLISH DETAIL ELEMENT                     
*                                                                               
         MVC   0(3,R2),PNVDBYDT    RETURN MATCHING BUY'S DATE                   
         MVC   3(1,R2),PNVDLIN#    AND LINE NUMBER                              
*                                                                               
         OC    0(3,R2),0(R2)       IF THERE IS NO BUY DATE                      
         BNZ   *+10                                                             
         MVC   0(3,R2),PNVDDTE        USE LINE ITEM RUN DATE                    
*                                                                               
         CLI   GLARGS+2,C'1'       SKIP IF MONTH BUYS COMBINED WITH             
         BE    IINDNV1                                                          
         CLI   GLARGS+2,C'2'       SKIP IF MONTH BUYS COMBINED WITH             
         BE    IINDNV1                  THOSE ON THE FIRST                      
*                                                                               
         CLI   2(R2),0             IF MONTHLY BUY                               
         BNE   *+12                                                             
         MVI   5(R2),C'M'             SET FREQUENCY                             
         MVI   2(R2),1                SET DATE TO FIRST OF MONTH                
*                                                                               
         TM    PBQPOPT,PBQPORFP+PBQPOCTY  IF RFPDATE OR CCYYMMDD                
         BZ    *+8                                                              
         MVI   5(R2),0                ELIMINATE FREQUENCY ID                    
*                                                                               
IINDNV1  DS    0H                                                               
*                                                                               
         B     IIND10                                                           
*                                                                               
IINDNVN  DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCIV     IF PROCESSING OLD INVOICES                   
         BNE   IINDIVN                                                          
*                                                                               
         ICM   R6,15,PBIDTELA      POINT TO INVOICE DETAIL                      
         BZ    IINDIVX             SKIP IF NONE AVAILABLE                       
         USING PIMDTLEL,R6         ESTABLISH INVOICE DETAIL                     
*                                                                               
         MVC   0(3,R2),PIMBDATE    USE MATCHED BUY'S DATE                       
         MVC   3(1,R2),PIMBLINE    AND LINE NUMBER                              
*                                                                               
         OC    0(3,R2),0(R2)       IF NO MATCHED BUY DATE                       
         BNZ   *+10                                                             
         MVC   0(3,R2),PIMIDATE       RETURN DETAIL DATE                        
*                                                                               
IINDIVX  DS    0H                                                               
*                                                                               
         B     IIND10                                                           
*                                                                               
IINDIVN  DS    0H                                                               
*                                                                               
         CLI   PBUYKRCD,X'20'      SKIP IF NOT A BUY RECORD                     
         BNE   IINDBUYN                                                         
*                                                                               
         MVC   0(3,R2),PBUYKDAT    INSERTION DATE                               
*                                                                               
IIND10   DS    0H                                                               
*                                                                               
         CLI   2(R2),0             IF A BUY FOR THE MONTH OF                    
         BNE   IIND11                                                           
*                                                                               
         CLI   GLARGS+2,C'1'          IF MONTH BUYS COMBINED WITH               
         BE    *+8                           THOSE ON THE FIRST                 
         CLI   GLARGS+2,C'2'          IF MONTH BUYS COMBINED WITH               
         BNE   *+8                           THOSE ON THE FIRST                 
         MVI   2(R2),1                   SET DATE TO FIRST OF MONTH             
*                                                                               
IIND11   DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'Y'       IF YEAR ONLY WANTED                          
         BNE   *+14                                                             
         XC    1(2,R2),1(R2)          CLEAR MONTH AND DAY                       
         B     IINDAT80                                                         
*                                                                               
         CLI   GLARGS+1,C'M'       IF MONTH ONLY WANTED                         
         BNE   *+16                                                             
         MVI   0(R2),0                CLEAR YEAR  AND DAY                       
         MVI   2(R2),0                                                          
         B     IINDAT80                                                         
*                                                                               
         CLI   GLARGS+1,C'D'       IF DAY ONLY WANTED                           
         BNE   *+14                                                             
         XC    0(2,R2),0(R2)          CLEAR YEAR AND MONTH                      
         B     IINDAT80                                                         
*                                                                               
         CLI   GLARGS+3,C'D'       IF DAY OF THE WEEK WANTED                    
         BNE   IINDATE1                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),(0,DUB)   YYMMDD                           
*                                                                               
         XC    0(3,R2),0(R2)       CLEAR INSERTION DATE                         
*                                                                               
         GOTO1 GETDAY,DMCB,(0,DUB),(0,FULL)    GET DAY OF WEEK                  
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,0(R1)          GET DAY # 1=MON..7=SUN                       
         BZ    IINDATEX            DROP IF NO DATE                              
*                                                                               
         STC   RF,0(R2)            RETURN DAY NUMBER                            
         MVC   1(3,R2),FULL        RETURN DAY OF WEEK - DDD                     
*                                                                               
         B     IINDATEX                                                         
*                                                                               
IINDATE1 DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCIV     SKIP IF PROCESSING INVOICES                  
         BE    *+8                                                              
         CLI   PBMODE,PBPROCNV     SKIP IF PROCESSING INVOICES                  
         BE    IIND20                                                           
*                                                                               
         CLI   GLARGS+2,C'1'       SKIP IF MONTH BUYS COMBINED WITH             
         BE    *+8                                                              
         CLI   GLARGS+2,C'2'       SKIP IF MONTH BUYS COMBINED WITH             
         BE    *+10                          THOSE ON THE FIRST                 
         MVC   5(1,R2),PBDFREQ        FREQUENCY                                 
*                                                                               
         MVC   3(1,R2),PBUYKLIN    LINE NUMBER                                  
*                                                                               
IIND20   DS    0H                                                               
*                                                                               
         TM    PBQPOPT,PBQPORFP+PBQPOCTY  IF RFPDATE OR CCYYMMDD                
         BZ    *+8                                                              
         MVI   5(R2),0                ELIMINATE FREQUENCY ID                    
*                                                                               
         CLI   GLARGS+1,C'X'       IF DATE WITHOUT LINE NUMBER WANTED           
         BNE   *+8                                                              
         MVI   3(R2),0                ELIMINATE LINE NUMBER                     
*                                                                               
IINDAT80 DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCNV     SKIP IF PROCESSING INVOICES                  
         BE    *+8                                                              
         CLI   PBMODE,PBPROCIV     SKIP IF PROCESSING INVOICES                  
         BE    IINDATEX                                                         
*                                                                               
         CLI   GLARGS+3,C'1'       DONE IF NO TEST/DELETE INDICATORS            
         BE    *+10                                                             
         CLC   GLARGS+1(2),=C'X1'  DONE IF NO TEST/DELETE INDICATORS            
         BE    IINDATEX                                                         
*                                                                               
         MVC   4(1,R2),PBDBFD      TEST                                         
*                                                                               
         TM    PBDSTAT2,X'40'      IF STEWARD BUY                               
         BNO   *+8                                                              
         MVI   4(R2),C'S'             FLAG WITH 'S'                             
*                                                                               
         CLI   GLARGS+1,C'S'       SKIP IF LIVE/TEST/ORDERED STATUS             
         BNE   *+12                                                             
         CLI   GLARGS+2,C'O'                                                    
         BE    IINDAT1A                                                         
*                                                                               
         TM    PBUYCNTL,X'80'      DELETED                                      
         BNO   *+8                                                              
         MVI   4(R2),C'D'                                                       
*                                                                               
IINDAT1A DS    0H                                                               
*                                                                               
         CLI   4(R2),C' '          SKIP IF BUY INDICATOR PRESENT                
         BH    IINDATE2                                                         
*                                                                               
         TM    PBDSTAT,X'08'       IF A HELD BUY                                
         BNO   *+8                                                              
         MVI   4(R2),C'H'             FLAG IT                                   
*                                                                               
IINDATE2 DS    0H                                                               
*                                                                               
         TM    PBQPOPT,PBQPORFP+PBQPOCTY  IF RFPDATE OR CCYYMMDD                
         BZ    IINDATE3                                                         
*                                                                               
         CLI   4(R2),C'W'             ELIMINATE WEEK OF                         
         BE    *+8                                                              
         CLI   4(R2),C'B'             AND BEST FOOD DAY                         
         BNE   *+8                                                              
         MVI   4(R2),0                                                          
*                                                                               
IINDATE3 DS    0H                                                               
*                                                                               
         MVC   6(3,R2),PBDIDAT2    SECOND INSERT DATE                           
*                                                                               
         OC    PBDIDAT2,PBDIDAT2   SKIP IF 2ND INSERT DATE FOUND                
         BNZ   IINDISNX                                                         
*                                                                               
*        CHECK IF ISSUE NAME TO BE PRINTED                                      
*                                                                               
         GOTO1 FNDFLTRA,DMCB,=AL2(PRQWRCFL),(2,=AL2(PRQCFISN)),0                
*                                                                               
         OC    8(4,R1),8(R1)                                                    
         BZ    IINDISNX            NO ISSUE NAME                                
*                                                                               
*        FIND ISSUE NAME ELEMENT                                                
*                                                                               
*                                                                               
         LA    R6,33(R4)           POINT TO FIRST ELEMENT IN BUYREC             
         SR    RF,RF                                                            
*                                                                               
         USING PISNMELD,R6         ESTABLISH ISSUE NAME ELEMENT                 
*                                                                               
IINDISNL DS    0H                                                               
*                                                                               
         CLI   PISNMELM,0          CHECK FOR END OF RECORD                      
         BE    IINDISNX              NO ISSUE NAME ELEMENT                      
*                                                                               
         CLI   PISNMELM,PISNMELQ   TEST FOR ISSUE NAME ELEMENT                  
         BE    IINDISNF              FOUND                                      
*                                                                               
IINDISNC DS    0H                                                               
*                                                                               
         IC    RF,PISNMELL         GET ELEMENT LENGTH                           
         LA    R6,PISNMELM(RF)     BUMP TO NEXT ELEMENT                         
         B     IINDISNL                                                         
*                                                                               
IINDISNF DS    0H                                                               
*                                                                               
         MVI   6(R2),X'FF'         SET ISSUE NAME FLAG                          
         MVC   7(11,R2),PISNAME    RETURN ISSUE NAME                            
         OC    7(11,R2),SPACES                                                  
*                                                                               
IINDISNX DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'S'       IF BUY STATUS ONLY                           
         BNE   IINDATE4                                                         
*                                                                               
         MVC   0(1,R2),4(R2)       MOVE STATUS TO FRONT                         
*                                                                               
         CLI   GLARGS+2,C'D'       IF DELETED STATUS ONLY                       
         BNE   IINDDELN                                                         
*                                                                               
         CLI   0(R2),C'D'             IF NOT DELETED                            
         BE    *+8                                                              
         MVI   0(R2),0                   CLEAR STATUS                           
*                                                                               
         B     IINDAT2A                                                         
*                                                                               
IINDDELN DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'O'       IF LIVE/TEST/ORDERED STATUS                  
         BNE   IINDLTON                                                         
*                                                                               
         TM    PBDSTAT,X'02'          IF ORDERED                                
         BNO   *+8                                                              
         MVI   0(R2),C'O'                SET ORDERED STATUS                     
*                                                                               
         CLI   0(R2),C'T'          BUY IS LIVE IF NOT TEST                      
         BE    *+8                                                              
         CLI   0(R2),C'O'          ORDERED                                      
         BE    *+8                                                              
         CLI   0(R2),C'H'          HELD                                         
         BE    *+8                                                              
         CLI   0(R2),C'S'          STEWARD                                      
         BE    *+8                                                              
         MVI   0(R2),C'L'                                                       
*                                                                               
         B     IINDAT2A                                                         
*                                                                               
IINDLTON DS    0H                                                               
*                                                                               
         CLI   0(R2),C'T'          BUY IS LIVE IF NOT TEST                      
         BE    *+8                                                              
         CLI   0(R2),C'D'          DELETED                                      
         BE    *+8                                                              
         CLI   0(R2),C'H'          HELD                                         
         BE    *+8                                                              
         CLI   0(R2),C'S'          STEWARD                                      
         BE    *+8                                                              
         MVI   0(R2),C'L'                                                       
*                                                                               
IINDAT2A DS    0H                                                               
*                                                                               
         XC    1(8,R2),1(R2)       CLEAR REST OF INPUT                          
*                                                                               
IINDATE4 DS    0H                                                               
*                                                                               
         B     IINDATEX                                                         
*                                                                               
IINDBUYN DS    0H                  NON-BUY RECORD                               
*                                                                               
         CLI   PBMODE,PBPROCES     SKIP IF NOT PROCESSING ESTIMATES             
         BNE   IINDATEX                                                         
*                                                                               
         MVC   0(3,R2),PBBDGTST    USE START OF BUDGET PERIOD                   
*                                                                               
IINDATEX DS    0H                                                               
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRITER - INVOICE RECORD KEYWORDS - INPUT - IINV'             
***********************************************************************         
*                                                                     *         
*        INVOICE RECORD KEYWORDS                                      *         
*                                                                     *         
*NTRY    GLARGS      C'X' - INVOICE RECORD                            *         
*        GLARGS+1    - DATA TYPE -                                    *         
*                    C'C' - COMMENT                                   *         
*                    C'S' - STATUS                                    *         
*                    C'$' - INVOICE AMOUNT                            *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IINV     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   PBMODE,PBPROCIV     SKIP IF NOT PROCESSING OLD INVOICES          
         BNE   IINVX                                                            
*                                                                               
         ICM   RF,15,PBIKYELA         POINT TO INVOICE RECORD KEY               
         BZ    IINVX                     SKIP IF NO KEY AVAILABLE               
*                                                                               
         USING PINVKEYD,RF            ESTABLISH INVOICE RECORD KEY              
*                                                                               
         CLI   PINVTYPE,PINVTYPQ      SKIP IF NOT OLD INVOICE RECORD            
         BNE   IINVX                                                            
*                                                                               
         DROP  RF                                                               
*                                                                               
*        DETERMINE DATA TYPE                                                    
*                                                                               
         CLI   GLARGS+1,C'C'       COMMENT                                      
         BE    IIVCOM                                                           
*                                                                               
         CLI   GLARGS+1,C'S'       STATUS                                       
         BE    IIVSTAT                                                          
*                                                                               
         CLI   GLARGS+1,C'$'       INVOICE TOTAL AMOUNT                         
         BE    IIVAMT                                                           
*                                                                               
         B     IINVX               UNKNOWN DATA TYPE                            
*                                                                               
IIVCOM   DS    0H                  COMMENT                                      
*                                                                               
         ICM   R6,15,PBICMELA      POINT TO COMMENT ELEMENT                     
         BZ    IIVCOMX             SKIP IF NONE AVAILABLE                       
         USING PIMCOMEL,R6         ESTABLISH COMMENT ELEMENT                    
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PIMCOMLN         GET ELEMENT LENGTH                           
         AHI   RF,-(PIMCOMOV-3)    ADJUST FOR ELEMENT OVERHEAD                  
         BNP   IIVCOMX             NOCOMMENT TO PRINT                           
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PIMCOML1    PASS COMMENT TO DRIVER                       
*                                                                               
IIVCOMX  DS    0H                                                               
*                                                                               
         B     IINVX                                                            
*                                                                               
IIVSTAT  DS    0H                  INVOICE STATUS                               
*                                                                               
         ICM   R6,15,PBIDTELA      ESTABLISH INVOICE DETAIL ELEMENT             
         BZ    IIVSTATX            NONE AVAILABLE                               
         USING PIMDTLEL,R6         ESTABLISH DETAIL ELEMENT                     
*                                                                               
         MVC   0(4,R2),=CL4' '     INIT OUTPUT                                  
*                                                                               
         LA    R1,1(R2)            FIRST OUTPUT POSITION                        
*                                                                               
         TM    PIMDSTAT,X'10'      IF MATCHED TO A BUY                          
         BNO   *+8                                                              
         MVI   0(R1),C'M'             SET INDICATOR                             
*                                                                               
         LA    R1,1(R1)            BUMP TO NEXT PRINT POSITION                  
*                                                                               
         TM    PIMDSTAT,X'08'      IF TEARSHEET RECEIVED                        
         BNO   *+8                                                              
         MVI   0(R1),C'T'             SET INDICATOR                             
*                                                                               
         LA    R1,1(R1)            BUMP TO NEXT PRINT POSITION                  
*                                                                               
         TM    PIMDSTAT,X'02'      IF MATCHED AND PAID                          
         BNO   *+8                                                              
         MVI   0(R1),C'P'             SET INDICATOR                             
*                                                                               
IIVSTATX DS    0H                                                               
*                                                                               
         B     IINVX                                                            
*                                                                               
*        INVOICE TOTAL AMOUNT                                                   
*                                                                               
IIVAMT   DS    0H                                                               
*                                                                               
         ICM   R5,15,PBIKYELA      POINT TO INVOICE KEY                         
         BZ    IIVAMTX             SKIP IF NONE AVAILABLE                       
         USING PINVKEYD,R5         ESTABLISH KEY                                
*                                                                               
         ICM   R6,15,PBIHDELA      POINT TO INVOICE HEADER ELEMENT              
         BZ    IIVAMTX             SKIP IF NONE AVAILABLE                       
         USING PIMHDREL,R6         ESTABLISH HEADER ELEMENT                     
*                                                                               
         CLC   IIVKEYS,PINVKEY     IF KEY CHANGED                               
         BNE   *+10                                                             
         CLC   IIVHDRS,PIMHDREL    OR HEADER CHANGED                            
         BE    IIVAMTX                                                          
*                                                                               
         MVC   IIVKEYS,PINVKEY        SAVE NEW KEY                              
         MVC   IIVHDRS,PIMHDREL       SAVE NEW HDR                              
         ZAP   0(5,R2),PIMAMT         RETURN INVOICE TOTAL                      
*                                                                               
IIVAMTX DS     0H                                                               
         B     IINVX                                                            
*                                                                               
*                                                                               
IINVX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IIVKEYS  DC    XL(L'PINVKEY)'00'   INVOICE KEY    SAVEAREA                      
IIVHDRS  DC    XL(PIMHDRLQ)'00'    INVOICE HEADER SAVEAREA                      
*                                                                               
         DROP  R6                                                               
*                                                                               
         TITLE  'PRWRITER - INVOICE RECORD KEYWORDS - OUTPUT - OLAB'            
***********************************************************************         
*                                                                     *         
*        INVOICE RECORD KEYWORDS - OUTPUT                             *         
*                                                                     *         
*NTRY    GLARGS      C'X' - INVOICE RECORD                            *         
*        GLARGS+1    - DATA TYPE -                                    *         
*                    C'S' - STATUS                                    *         
*        PBIKYELA    A(INVOICE RECORD  KEY)                           *         
*        PBIHDELA    A(INVOICE HEADER  ELEMENT)                       *         
*        PBIDTELA    A(INVOICE DETAIL  ELEMENT)                       *         
*        PBICMELA    A(INVOICE COMMENT ELEMENT)                       *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OINV     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        DETERMINE DATA TYPE                                                    
*                                                                               
         CLI   GLARGS+1,C'C'       COMMENT                                      
         BE    OIVCOM                                                           
*                                                                               
         B     OINVX               UNKNOWN DATA TYPE                            
*                                                                               
*        INPUT IS 3 LENGTH BYTES FOLLOWED BY COMMENTS                           
*                                                                               
OIVCOM   DS    0H                  COMMENT                                      
*                                                                               
         L     R6,GLADTENT         ESTABLISH DRIVETABLE ENTRY                   
         USING DROD,R6                                                          
*                                                                               
         TM    PBQPOPT,PBQPOCUT    IF CUTTING OUTPUT TO ONE LINE                
         BNO   OIVCOM20                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,15,DROLEN           GET OUTPUT LENGTH                         
         BCTR  RF,0                   ENTRY LENGTH CONTAINS BOX LINE            
*                                                                               
         CLM   RF,1,0(R2)             IF 1ST COMMENT TOO SHORT FOR COL          
         BNH   *+12                                                             
         ICM   RF,1,0(R2)                DEFAULT TO COMMENT LENGTH              
         BZ    OIVCOMX                      NO COMMENT TO PRINT                 
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R2)       MOVE COMMENT TO OUTPUT                       
*                                                                               
         B     OIVCOMX                                                          
*                                                                               
OIVCOM20 DS    0H                                                               
*                                                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         LHI   R0,3                MAX 3 COMMENTS                               
         LA    R1,3(R2)            START OF FIRST COMMENT                       
         LA    R4,OIVCOMWK         START OF COMMENT BUILD AREA                  
         LA    R5,0(R2)            START OF COMMENT LENGTH BYTES                
         XC    OIVCOMWK,OIVCOMWK   INIT COMMENT WORKAREA                        
*                                                                               
OIVCOMLP DS    0H                                                               
*                                                                               
         ICM   RE,1,0(R5)          GET LENGTH OF NEXT COMMENT                   
         BZ    OIVCOMCN            SKIP IF NO DATA                              
*                                                                               
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(R1)       MOVE NEXT COMMENT TO WORKAREA                
*                                                                               
         LA    R1,1(RE,R1)         BUMP TO NEXT COMMENT                         
         LA    R4,2(RE,R4)         BUMP TO NEXT PRINT AREA                      
         LA    RF,2(RE,RF)         BUMP TOTAL LENGTH COUNTER                    
*                                                                               
OIVCOMCN DS    0H                                                               
*                                                                               
         LA    R5,1(R5)            BUMP TO NEXT LENGTH BYTE                     
         BCT   R0,OIVCOMLP         NEXT COMMENT                                 
*                                                                               
OICCOMDN DS    0H                                                               
*                                                                               
*        CHOP COMMENTS TO OUTPUT                                                
*                                                                               
         GOTO1 CHOPPER,DMCB,(0,OIVCOMWK),(DROLEN,(R3)),(198,14),       X        
               C'LEN=',(RF)                                                     
*                                                                               
OIVCOMX  DS    0H                                                               
*                                                                               
         B     OINVX                                                            
*                                                                               
OINVX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OIVCOMWK DS    XL128               COMMENT WORKAREA                             
*                                                                               
         DROP  R6                                                               
*                                                                               
         TITLE  'PRWRITER - INVOICE RECORD KEYWORDS - INPUT - ILAB'             
***********************************************************************         
*                                                                     *         
*        LABATT SPECIAL KEYWORDS                                      *         
*                                                                     *         
*NTRY    GLARGS      A(0) - NULLS                                     *         
*        GLARGS+1    - DATA TYPE -                                    *         
*                    C'M' - MEDIA                                     *         
*                    C'G' - GENERAL LEDGER CODE                       *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ILAB     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        DETERMINE KEYWORD                                                      
*                                                                               
         MVC   ILABARGS,GLARGS     SAVE ARGUMENTS                               
*                                                                               
         CLI   GLARGS+1,C'G'       GENERAL LEDGER CODE?                         
         BE    ILABGL                                                           
*                                  UNKNOWN KEYWORD                              
         B     ILABX                                                            
*                                                                               
ILABGL   DS    0H                  GENERAL LEDGER CODE                          
*                                                                               
         XC    GLARGS(6),GLARGS    NO ARGUMENTS NEEDED                          
         XC    ILABUDF,ILABUDF     INIT UDEF FIELD                              
*                                                                               
         GOTOR IUDF                GET ESTIMATE 1 UDEF                          
*                                                                               
         MVC   ILABUDF,0(R2)       SAVE UDEF FIELD                              
*                                                                               
         XC    0(32,R2),0(R2)        CLEAR RETURN FIELD                         
*                                                                               
         MVC   0(3,R2),PBRGN       SET REGION CODE                              
*                                                                               
         MVC   3(32,R2),ILABUDF    ADD ON GL CODE                               
*                                                                               
ILABX    DS    0H                                                               
*                                                                               
         MVC   GLARGS,ILABARGS     RESTORE ORIGINAL ARGUMENTS                   
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
ILABUDF  DS    CL32                UDEF SAVEAREA                                
ILABARGS DS    CL16                ARGUMENT SAVEARE                             
*                                                                               
         TITLE  'PRWRITER - INVOICE RECORD KEYWORDS - OUTPUT - OLAB'            
***********************************************************************         
*                                                                     *         
*        LABATT SPECIAL KEYWORDS - OUTPUT                             *         
*                                                                     *         
*NTRY    GLARGS      A(0) - NULLS                                     *         
*        GLARGS+1    - DATA TYPE -                                    *         
*                    C'M' - MEDIA                                     *         
*                    C'G' - GENERAL LEDGER CODE                       *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OLAB     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        DETERMINE DATA TYPE                                                    
*                                                                               
         MVC   OLABARGS,GLARGS     SAVE ARGUMENTS                               
*                                                                               
         CLI   GLARGS+1,C'G'       GENERAL LEDGER CODE                          
         BE    OLABGL                                                           
*                                  UNKNOWN KEYWORD                              
         B     OLABX                                                            
*                                                                               
OLABGL   DS    0H                                                               
*                                                                               
         MVC   0(3,R3),=C'31.'     BUILD GLCODE                                 
         MVC   3(34,R3),0(R2)                                                   
         MVC   37(3,R3),=C'.00'                                                 
*                                                                               
OLABX    DS    0H                                                               
*                                                                               
         MVC   GLARGS,OLABARGS     RESTORE ARGUMENTS                            
*                                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
OLABARGS DS    XL16                ARGUMENTS SAVEAREA'                          
*                                                                               
         TITLE 'MARKET INPUT - IMARKET'                                         
***********************************************************************         
*                                                                     *         
*-------------->     MARKET                                           *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
IMARKET  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   GLARGS+1,C'A'        STATE CITY CODE REQUESTED                   
         BNE   IMARKA                                                           
*                                                                               
         L     R6,AIO3             POINT TO PUB RECORD                          
*                                                                               
         MVC   0(1,R2),0(R6)       SAVE MEDIA                                   
*                                                                               
         B     IMARKC                                                           
*                                                                               
IMARKA   CLI   PBMED,C'T'          TRADE HAS NONE                               
         BE    IMARKETX                                                         
         CLI   PBMED,C'M'          NOR MAGAZINE                                 
         BE    IMARKETX                                                         
*========              ========*                                                
         L     R6,AIO3                                                          
         USING PUBNAMD,R6          PUBADDRESS                     BUG07         
*========              ========*                                                
IMARKC   MVI   ELCODE,X'10'        FIND PUB ADDRESS ELEMENT       BUG07         
*        BRAS  RE,GETEL                                           BUG07         
*                                                                               
         SR    RF,RF                                                            
         LA    R6,33(R6)                                                        
*                                                                               
         CLI   0(R6),0                                                          
         BE    IMARKETX            NOT FOUND                                    
         CLI   0(R6),X'10'                                                      
         BE    *+16                                                             
         IC    RF,1(R6)                                                         
         LA    R6,0(RF,R6)                                                      
         B     *-24                                                             
*                                                                               
         CLI   GLARGS+1,C'A'         STATE/CITY CODE                            
         BE    MBNARKET                                                         
*                                                                               
         CLI   PBMED,C'N'          NEWSPAPER IS CITY& STATE                     
         BNE   MKMBO               MAYBE OUTDOOR                                
*                                                                               
         MVI   0(R2),C'N'                                                       
*                                                                               
MBNARKET DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'1'       IF NOT IN CITY ORDER                         
         BE    *+20                                                             
         MVC   1(2,R2),PUBSTATE       RETURN STATE                              
         MVC   3(16,R2),PUBCITY       AND CITY                                  
         B     IMARKETX                                                         
*                                                                               
         MVC   1(16,R2),PUBCITY    ELSE RETURN CITY                             
         MVC   17(2,R2),PUBSTATE         AND STATE                              
         B     IMARKETX                                                         
*                                                                               
MKMBO    CLI   PBMED,C'O'          OUTDOOR IS ZONE                              
         BNE   IMARKETX                                                         
         MVI   0(R2),C'O'                                                       
         MVC   1(20,R2),PUBZNAME                                                
         B     IMARKETX                                                         
*                                                                               
IMARKETX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
*        ========  *                                                            
         DROP  R6                                                 BUG07         
*        ========  *                                                            
         TITLE 'ACCUMULATE INCHES/LINES'                                        
***********************************************************************         
*                                                                     *         
*-------------->    ACCUMULATE INCHES / LINES                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
INCHLINE NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         ZAP   0(8,R2),=P'0'                                                    
         MVC   8(4*8,R2),0(R2)                                                  
*                                                                               
*  FIELDS ARE INCHES,LINES,COUNT,ID,RESERVED                                    
*                                                                               
         CLI   PBDSPACE,C'*'                                                    
         BE    INCHLINX                                                         
*                                                                               
         LH    RF,=Y(PPBYOUTC-SYSD)  DISPLACEMENT OF PPBYOUT AREA               
         AR    RF,R9                                                            
         USING PPBYOUTD,RF         ESTABLISH PPBYOUT AREA                       
*                                                                               
         CLI   PBYOSPC2,C'*'      NOT 'REAL' INSERTION                          
         BE    INCHLINX                                                         
*                                                                               
         DROP  RF                                                               
*                                                                               
         L     R0,PBUNITS                                                       
         CLI   PBDUIND,C'I'                                                     
         BE    ISINCH                                                           
         CLI   PBDUIND,X'89'       LOWERCASE I                                  
         BE    ISINCH                                                           
         ZAP   8(8,R2),PBDUNITS    BUY IS IN LINES // SAVE IT                   
         B     CS16G               CONVERT TO INCHES                            
*                                                                               
ISINCH   CLI   PBDUIND,X'89'                                                    
         BNE   CS16FA                                                           
         ZAP   0(8,R2),PBDUNITS    BUY IS IN INCHES + TWO DECIMALS              
         B     CS16C               CONVERT TO LINES                             
CS16FA   MH    R0,=H'100'                                                       
         CVD   R0,DUB                                                           
         ZAP   0(8,R2),DUB                                                      
         L     R0,PBUNITS          RE-INITIALIZE                                
*                                                                               
*              CONVERT TO LINES                                                 
*                                                                               
CS16C    MH    R0,=H'14'           14 LINES/INCH                                
         CLI   PBDUIND,X'89'       LOWER CASE I - UNITS TO 2 DECIMALS           
         BNE   CS16F                                                            
         CVD   R0,DUB                                                           
         AP    DUB,=P'50'          MUST ROUND TO NEAREST LINE                   
         DP    DUB,=P'100'                                                      
         ZAP   8(8,R2),DUB(6)      ACCUMULATE CONVERTED LINES                   
         B     CS16X                                                            
*                                                                               
CS16F    CVD   R0,DUB                                                           
         AP    8(8,R2),DUB         ACCUMULATE CONVERTED LINES                   
         B     CS16X                                                            
*                                                                               
*                                                                               
CS16G    DS    0H                                                               
         LR    R1,R0                                                            
         SR    R0,R0                                                            
         MH    R1,=H'100'                                                       
         D     R0,=F'14'           14 LINES/INCF                                
         LR    R0,R1                                                            
         CVD   R0,DUB                                                           
         AP    0(8,R2),DUB         ADD CONVERTED INCHES 2 DECIMAL               
CS16X    AP    16(8,R2),=P'1'      ITERATION                                    
*      ADD REQUEST TYPE OPTION                                                  
*                                                                               
         ZAP   24(8,R2),=P'0'      INIT OUTPUT                                  
*                                                                               
         CLI   PBQINLIN,0          SKIP IF NOT SET                              
         BE    *+10                                                             
         ZAP   24(8,R2),PBQINLIN   TYPE OF NEWSPAPER OPTION                     
*                                                                               
         ZAP   32(8,R2),=P'1'      FUTURE USE                                   
         B     INCHLINX                                                         
*                                                                               
INCHLINX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'MEDIA INPUT - IMED'                                             
***********************************************************************         
*                                                                     *         
*        MEDIA DATATYPE INPUT - MEDIA CODE ONLY                       *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
IMED     NMOD1 0,**#IMED                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVC   0(1,R2),PBMED       MEDIA                                        
*                                                                               
         CLI   PBQMED,C'C'         IF REPORTING COMBINED MEDIA                  
         BNE   *+8                                                              
         MVI   0(R2),C'C'             USE ONLY 1 MEDIA                          
*                                                                               
IMEDX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - WL SPECIAL MEDIA - INPUT - IWLMED'                   
***********************************************************************         
*                                                                     *         
*        WL SPECIAL MEDIA                                             *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT   'P'    -  DESIGNATES PRINT                                    *         
*       '?'    -  MEDIA CODE                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IWLMED   NMOD1 0,**#IWLM                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVI   0(R2),C'P'          SET SYSTEM                                   
         MVC   1(1,R2),PBMED       SET MEDIA                                    
*                                                                               
IWLMEDX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - NUMERIC OUTPUT - OLCOUNT'                            
***********************************************************************         
*                                                                     *         
*        COUNTS NUMBER OF OUTPUT LINES INCLUDING TOTAL LINES          *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*EXIT    NUMBER OF PRINTED LINES                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OLCOUNT  NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   GLLEVEL,0           PRINT ONLY AT GRAND TOTAL                    
         BNE   OLCOUNT1                                                         
*                                                                               
         ZAP   0(8,R2),OLCCTRP     SET COUNTER AS INPUT                         
*                                                                               
         MVI   GLHOOK,GLEDIT       HAVE DRIVER PRINT IT                         
*                                                                               
         B     OLCOUNT1                                                         
*                                                                               
OLCOUNT1 DS    0H                                                               
*                                                                               
         AP    OLCCTRP,=P'1'       BUMP LINE COUNTER                            
*                                                                               
OLCOUNTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
OLCCTRP  DC    PL8'0'              LINE COUNTER                                 
*                                                                               
         TITLE 'PRWRITER - NUMERIC OUTPUT - ONUM'                               
***********************************************************************         
*                                                                     *         
*        NUMERIC OUTPUT                                               *         
*                                                                     *         
*NTRY                                                                 *         
*        GLARGS(2)  - C'RT' - ROUND TOTAL TO WHOLE NUMBER             *         
*                                                                     *         
*        ELSE LET DRIVER DO THE PRINTING                              *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ONUM     NMOD1 0,**#ONUM                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         CLC   =C'RT',GLARGS       SKIP IF NOT ROUNDING TOTALS                  
         BNE   ONUM10                                                           
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BNO   ONUM10                                                           
*                                                                               
         SRP   0(4,R2),64-2,5      ROUND TO WHOLE NUMBER                        
         SRP   0(4,R2),2,0         ADD 2 DECIMALS BACK IN                       
*                                                                               
ONUM10   DS    0H                                                               
*                                                                               
         CLI   MYLTYP,C'H'         IF NOT HEADLINE OR MIDLINE                   
         BE    *+8                                                              
         CLI   MYLTYP,C'M'                                                      
         BE    ONUM20                                                           
*                                                                               
         MVI   GLHOOK,GLEDIT          HAVE DRIVER EDIT RESULT                   
*                                                                               
         B     ONUMX                                                            
*                                                                               
*        EDIT OUTPUT FOR GENOUT                                                 
*                                                                               
ONUM20   DS    0H                                                               
*                                                                               
         XC    EBLOCK,EBLOCK       INIT EDITOR BLOCK                            
*                                                                               
         ST    R2,EBAIN            INPUT ADDRESS                                
*                                                                               
         MVI   EBLIN,8             DEFAULT INPUT LENGTH                         
         CLI   GLARGS+3,0          IF INPUT LENGTH AVAILABLE                    
         BE    *+10                                                             
         MVC   EBLIN,GLARGS+3         SET IT                                    
*                                                                               
         MVI   EBTIN,C'P'          DEFAULT INPUT TYPE                           
         CLI   GLARGS+2,0          IF INPUT TYPE   AVAILABLE                    
         BE    *+10                                                             
         MVC   EBTIN,GLARGS+2         SET IT                                    
*                                                                               
         CLI   EBTIN,C'M'          IF ENTRY MASKED                              
         BNE   *+8                                                              
         MVI   0(R2),0                KILL MASK                                 
*                                                                               
         L     R1,GLADTENT         ESTABLISH OUTPUT ENTRY DESCRIPTION           
         USING DROD,R1                                                          
*                                                                               
         LA    RF,CODEAREA                                                      
         ST    RF,EBAOUT           OUTPUT ADDRESS                               
*                                                                               
         MVC   EBLOUT,DROLEN       OUTPUT LENGTH                                
*                                                                               
         MVC   EBDECS,DRODEC       NUMBER OF DECIMALS                           
*                                                                               
         TM    PBQGET,1            IF ROUNDING                                  
         BNO   *+12                                                             
         MVI   EBDECS,0               NO DECIMALS                               
         MVI   EBROUND,2                                                        
*                                                                               
         MVC   EBFLOAT,DROFLOAT    FLOAT CHARACTER                              
         CLI   EBFLOAT,0           FLOAT OVERRIDE                               
         BH    *+8                                                              
         MVI   EBFLOAT,C'-'                                                     
*                                                                               
         MVC   EBALIGN,DROALIGN    ALIGNMENT                                    
*                                                                               
         MVC   EBOPT,DROEDIT       EDIT OPTIONS                                 
*                                                                               
         MVI   EBTRIM,EBTQROD      IF TOO LARGE - NO DECIMALS                   
*                                                                               
         CLI   DOWNOPT,C'Y'        FORCE ZEROS IF DOWNLOADING                   
         BNE   *+8                                                              
         OI    EBOPT,EBOQZEN       ZEROS NOT REPLACED BY BLANKS                 
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK   PRINT NUMBER                              
*                                                                               
         GOTO1 GENOUTA             FORMAT OUTPUT                                
*                                                                               
ONUMX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R1                                                               
*                                                                               
         TITLE 'PRWRITER - OPEN RATES - INPUT - IOPENR'                         
***********************************************************************         
*                                                                     *         
*        OPEN RATES FROM PUBMASTER                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IOPENR   NMOD1 20,**#IOPNR                                                      
*                                                                               
         LR    R5,RC               SAVE WORKING STORAGE POINTER                 
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R4                                                      
*                                                                               
         MVC   0(116,R5),PBDELEM   SAVE 20 ELEMENT                              
         ZAP   PBDCOS,=P'0'        CLEAR COST                                   
         XC    DMCB(6*4),DMCB                                                   
         GOTO1 =V(RATELOOK),DMCB,(0,PBUYREC),(4,AIO3),,,ADDAY,DATCON            
         ZAP   0(9,R2),PBDCOS                                                   
*                                                                               
         CLI   PBDCOSTY,C'U'       INCHES                                       
         MVC   PBDELEM(116),0(R5)                                               
         BE    IOPNOX                                                           
         OI    0(R2),X'80'       INDICATE NOT INCH OR LINES                     
IOPNOX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - DATA IN PPBYOUT - INPUT - IPBYOUT'                   
***********************************************************************         
*                                                                     *         
*        ROUTINE TO EXTRACT DATA FROM AREA RETURNED BY PPBYOUT        *         
*            - THIS IS AN EXPANSION OF DATA IN BUYREC                 *         
*                                                                     *         
*NTRY    GLARGS   = RECORD ID                                         *         
*                   C'B' - BUY      RECORD                            *         
*        GLARGS+1 = DATA DISPLACEMENT                                 *         
*        GLARGS+2 = DATA LENGTH                                       *         
*                                                                     *         
*        R2==>  DRIVER INPUT AREA                                     *         
*                                                                     *         
*EXIT   0-?    -  DATA                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPBYOUT  NMOD1 0,**#IPBY                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         LA    R6,PPBYOUTC         POINT TO PPBYOUT AREA                        
         USING PPBYOUTD,R6         ESTABLISH AREA                               
*                                                                               
         CLI   GLARGS+3,C'N'       IF NET UNIT RATE WANTED                      
         BNE   IPBYNETN                                                         
*                                                                               
         L     R4,AIO1             ESTABLISH BUYREC                             
         USING PBUYREC,R4                                                       
*                                                                               
         CLI   PBUYKRCD,X'20'      SKIP IF NOT A BUY RECORD IN I/OAREA          
         BNE   IPBYOUTX                                                         
*                                                                               
         IC    R0,PBDCTYP          SAVE CURRENT VALUE                           
         MVI   PBDCTYP,C'N'        SET BUY TO NET                               
*                                                                               
         OI    PBYOCTL,X'01'       SET FOR NET VALUES IN PPBYOUT                
*                                                                               
         GOTO1 =V(PPBYOUT),DMCB,PPBYOUTD   CALCULATE NET VAUES                  
*                                                                               
IPBYNETN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,GLARGS+1         DISPLACEMENT OF DATA                         
         LA    R1,0(RF,R6)         POINT TO DATA                                
*                                                                               
         IC    RF,GLARGS+2         DATA LENGTH                                  
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(R1)       PASS DATA TO DRIVER                          
*                                                                               
         CLI   GLARGS+3,C'N'       IF NET UNIT RATE WANTED                      
         BNE   IPBYNET9                                                         
*                                                                               
         NI    PBYOCTL,X'FF'-X'01' TURN OFF NET VALUES CONTROL                  
*                                                                               
         STC   R0,PBDCTYP             RESTORE BUY FIELD                         
         GOTO1 =V(PPBYOUT),DMCB,PPBYOUTD RESET PPBYOUT FIELDS                   
*                                                                               
         MVI   IPBYSW,0            RESET SWITCH                                 
*                                                                               
IPBYNET9 DS    0H                                                               
*                                                                               
IPBYOUTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IPBYSW   DC    X'00'               PPBYOUT SWITCH                               
*                                  C'N' - CALCULATE NET VALUES                  
*                                                                               
         TITLE 'PRWRITER - PLANNED COSTS - INPUT - IPC'                         
***********************************************************************         
*                                                                     *         
*        PLANNED COSTS                                                *         
*                                                                     *         
*NTRY    GLARGS+0     C'B'                                            *         
*               +1      C'M'     MONTH                                *         
*                +2       C'A'      ACTUALIZATION DATE                *         
*                         C'B'      BILLING EFFECTIVE DATE            *         
*                                                                     *         
*               +1      C'C'     DOLLARS                              *         
*                +2       C'1'      GROSS                             *         
*                         C'4'      NET                               *         
*                         C'6'      AGENCY COMMISSION                 *         
*                         C'R'      PLANNED COSTS RATE                *         
*                                                                     *         
*                                                                     *         
*EXIT   2PL8   -  LIVE AND TEST DATA                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPC      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC             ESTABLISH GENCON WORKING STORAGE             
*                                                                               
*        DETERMINE INPUT ROUTINE                                                
*                                                                               
         CLI   GLARGS+1,C'M'       MONTH DATE                                   
         BE    IPCMON                                                           
*                                                                               
         CLI   GLARGS+1,C'C'       DOLLAR AMOUNT                                
         BE    IPCDLR                                                           
*                                                                               
         B     IPCX                UNKNOWN ROUTINE                              
*                                                                               
IPCMON   DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'A'       IF ACTUALIZATION DATE                        
         BNE   *+14                                                             
         MVC   0(2,R2),PBPCACDT       RETURN ACTUALIZATION MONTH                
         B     IPCMONX                                                          
*                                                                               
         CLI   GLARGS+2,C'B'       IF BILLING EFFECTIVE DATE                    
         BNE   IPCMBLN                                                          
*                                                                               
         MVC   0(2,R2),PBPCEBLD       RETURN ESTIMATE BILL EFD                  
*                                                                               
         OC    0(2,R2),0(R2)       IF NONE AVAILABLE                            
         BNZ   IPCMONX                                                          
         MVC   0(2,R2),PBPCPBLD       RETURN PRODUCT BILL EFFECTIVE DTE         
*                                                                               
         OC    0(2,R2),0(R2)       IF NONE AVAILABLE                            
         BNZ   IPCMONX                                                          
         MVC   0(2,R2),PBPCCBLD       RETURN CLIENT  BILL EFFECTIVE DTE         
*                                                                               
IPCMBLN  DS    0H                                                               
*                                                                               
         B     IPCMONX                                                          
*                                                                               
IPCMONX  DS    0H                                                               
*                                                                               
         B     IPCX                                                             
*                                                                               
IPCDLR   DS    0H                  USE IDOLLAR TO GET VALUE                     
*                                                                               
         CLI   GLARGS+2,C'R'       SKIP IF PLANNED COST RATE                    
         BE    IPCRATE                                                          
*                                                                               
         MVC   IPCARGS,GLARGS      SAVE ARGUMENTS                               
*                                                                               
         CLI   GLARGS+3,C' '       SKIP IF PURE PLANNED COST                    
         BNH   IPCDLR50                                                         
*                                                                               
*        DETERMINE IF BUY IS IN PLANNED COST DATE RANGE                         
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
*                                                                               
*        FIND PC BILLLING EFFECTIVE DATE                                        
*                                                                               
         LA    RF,PBPCEBLD         START WITH ESTIMATE BILL EFD                 
*                                                                               
         OC    0(2,RF),0(RF)       IF NONE                                      
         BNZ   *+8                                                              
         LA    RF,PBPCPBLD            USE PRODUCT BILL EFD                      
*                                                                               
         OC    0(2,RF),0(RF)       IF NONE                                      
         BNZ   *+8                                                              
         LA    RF,PBPCCBLD            USE CLIENT  BILL EFD                      
*                                                                               
*        DETERMINE IF WE SHOULD GET ORDERED $ INSTEAD OF PC $                   
*                                                                               
         OC    0(2,RF),0(RF)       IF NO PC BILLING EFD                         
         BZ    IPCDLR10               USE ORDERED DOLLARS                       
*                                                                               
         CLC   PBUYKDAT(2),0(RF)   IF BUY BEFORE PC BILLING EFD                 
         BL    IPCDLR10               ORDERED DOLLARS                           
*                                                                               
         OC    PBPCACDT,PBPCACDT   IF NO ACTUALIZATION DATE                     
         BZ    IPCDLR20               PLANNED COSTS DOLLARS                     
*                                                                               
         CLC   PBUYKDAT(2),PBPCACDT   IF AFTER ACTUALIZATION DATE               
         BH    IPCDLR20                  PLANNED COSTS DOLLARS                  
*                                                                               
IPCDLR10 DS    0H                                                               
*                                                                               
         MVI   GLARGS+1,C'O'          GET ORDERED DOLLARS                       
*                                                                               
IPCDLR20 DS    0H                                                               
*                                                                               
IPCDLR50 DS    0H                                                               
*                                                                               
         GOTO1 =V(IDOLLAR)         GO GET DOLLAR AMOUNT                         
*                                                                               
         CLI   GLARGS+3,C'B'       IF PC BILLABLE WANTED                        
         BNE   IPCDLR90                                                         
*                                                                               
         ZAP   IPCORD$,0(8,R2)     SAVE PC ORDERED DOLLARS                      
         ZAP   IPCORD$T,8(8,R2)                                                 
*                                                                               
         ZAP   0(8,R2),=P'0'       INIT INPUT                                   
         ZAP   8(8,R2),=P'0'                                                    
*                                                                               
         MVI   GLARGS+1,C'B'       GET BILLED DOLLARS                           
*                                                                               
         GOTO1 =V(IDOLLAR)                                                      
*                                                                               
         SP    IPCORD$,0(8,R2)     ORDERED LESS BILLED                          
         SP    IPCORD$T,8(8,R2)    ORDERED LESS BILLED                          
*                                                                               
         ZAP   0(8,R2),IPCORD$     BILLABLE                                     
         ZAP   8(8,R2),IPCORD$T                                                 
*                                                                               
IPCDLR90 DS    0H                                                               
*                                                                               
         MVC   GLARGS(16),IPCARGS  RESTORE ARGUMENTS                            
*                                                                               
IPCDLRX  DS    0H                                                               
*                                                                               
         B     IPCX                                                             
*                                                                               
*        PLANNED COST RATE                                                      
*                                                                               
IPCRATE  DS    0H                                                               
*                                                                               
         ZAP   0(8,R2),=P'0'       INIT INPUT                                   
         ZAP   8(8,R2),=P'0'                                                    
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBUYKRCD,X'20'      SKIP IF NOT A BUY RECORD                     
         BNE   IPCRATEX                                                         
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
IPCRTLP  DS    0H                  FIND PLANNED COST ELEMENT                    
*                                                                               
         USING BYPCELD,R6          ESTABLISH PLANNED COST ELEMENT               
*                                                                               
         CLI   BYPCELM,0           DONE AT END OF RECORD                        
         BE    IPCRTDN                                                          
*                                                                               
         CLI   BYPCELM,BYPCIDQ     LOOKING FOR PLANNED COST ELEMENT             
         BE    IPCRTFD                                                          
*                                                                               
IPCRTCN  DS    0H                                                               
*                                                                               
         IC    RF,BYPCLEN          GET ELEMENT LENGTH                           
         LA    R6,BYPCELM(RF)      BUMP TO NEXT ELEMENT                         
         B     IPCRTLP                                                          
*                                                                               
IPCRTFD  DS    0H                                                               
*                                                                               
         CP    BYPCCST,=P'0'       IF NO COST ENTERED                           
         BNE   IPCRTFRX                                                         
*                                                                               
         LA    R1,14(R2)              POINT TO END OF OUTPUT AREA               
         SHI   R1,4                                                             
*                                                                               
         MVC   0(4,R2),=C'FREE'          INDICATE FREE BUY                      
         B     IPCRATEX                                                         
*                                                                               
IPCRTFRX DS    0H                                                               
*                                                                               
         ZAP   IPCPL16,BYPCCST     COPY COST                                    
******                                                                          
******   CLI   BYPCNIND,C'N'       ENTERED AS NET?                              
******   BNE   IPCRT32             NO                                           
******                                                                          
******   ZAP   IPCPL5,=P'100000'   100%                                         
******   SP    IPCPL5,PBDACP       LESS AGENCY COMMISSION                       
******   MP    IPCPL16,IPCPL5      CALCULATE NET                                
******   SRP   IPCPL16,64-3,5      ROUND TO ORIGINAL PRECISION                  
******                                                                          
IPCRT32  DS    0H                                                               
*                                                                               
         ZAP   IPCPL5,IPCPL16      SMALLER WORKAREA FOR EDIT                    
*                                                                               
         CLI   BYPCTYP,C'U'        SKIP IF UNIT RATE                            
         BNE   *+12                                                             
         CLI   PBUYKMED,C'N'       AND A NEWSPAPER BUY                          
         BE    IPCRT37                                                          
*                                                                               
         EDITR (P5,IPCPL5),(14,0(R2)),2,FLOAT=-,                       X        
               IZERO=Y,ZERO=BLANK,COMMAS=YES                                    
*                                                                               
         B     IPCRT38                                                          
*                                                                               
IPCRT37  DS    0H                  NEWSPAPER UNIT RATE 5 DECIMALS               
*                                                                               
         EDITR (P5,IPCPL5),(14,0(R2)),5,FLOAT=-,                       X        
               IZERO=Y,ZERO=BLANK,COMMAS=YES                                    
*                                                                               
         LA    R1,14(R2)           END OF OUTPUT                                
         SHI   R1,3                BACK UP TO LAST 3 BYTES                      
*                                                                               
         CLC   =C'000',0(R1)                                                    
         BNE   *+10                                                             
         MVC   0(3,R1),=CL3' '     MOVE SOME BLANKS                             
*                                                                               
IPCRT38  DS    0H                                                               
*                                                                               
         LA    R0,14               OUTPUT LENGTH                                
         LA    R1,0(R2)            START OF OUTPUT                              
*                                                                               
         CLI   0(R1),C' '          FIND FIRST NON-SPACE                         
         BH    *+16                                                             
         LA    R1,1(R1)            BUMP POINTER                                 
         BCT   R0,*-12                                                          
         B     IPCRATEX            OUTPUT FULL                                  
*                                                                               
         BCTR  R1,0                   BACK UP A POSITION                        
         CR    R1,R2                  CONTINUE IF OUTPUT AREA AVAILABLE         
         BL    IPCRATEX                                                         
*                                                                               
         CLI   BYPCTYP,C'U'        IF NOT UNIT RATE                             
         BE    IPCRTTPX                                                         
         CLI   BYPCTYP,C' '        AND COST TYPE PRESENT                        
         BNH   IPCRTTPX                                                         
*                                                                               
         MVC   0(1,R1),BYPCTYP        PRINT IT                                  
*                                                                               
         BCTR  R1,0                   BACK UP A POSITION                        
         CR    R1,R2                  CONTINUE IF OUTPUT AREA AVAILABLE         
         BL    IPCRATEX                                                         
*                                                                               
IPCRTTPX DS    0H                                                               
*                                                                               
         CLI   BYPCIND,C' '        IF COST INDICATOR PRESENT                    
         BNH   IPCRTCIX                                                         
*                                                                               
         MVC   0(1,R1),BYPCIND        PRINT IT                                  
*                                                                               
         BCTR  R1,0                   BACK UP A POSITION                        
         CR    R1,R2                  CONTINUE IF OUTPUT AREA AVAILABLE         
         BL    IPCRATEX                                                         
*                                                                               
IPCRTCIX DS    0H                                                               
*                                                                               
         CLI   BYPCNIND,C'N'       IF PLANNED COST ENTERED AS NET               
         BNE   IPCRTNTX                                                         
*                                                                               
         MVC   0(1,R1),BYPCNIND       PRINT IT                                  
*                                                                               
IPCRTNTX DS    0H                                                               
*                                                                               
IPCRTDN  DS    0H                                                               
*                                                                               
IPCRATEX DS    0H                                                               
*                                                                               
         B     IPCX                                                             
*                                                                               
IPCX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
IPCPL16  DS    PL16                PACKED WORK AREA                             
IPCPL5   DS    PL5                 PACKED WORKAREA                              
IPCARGS  DS    CL16                ARGUMENTS SAVEAREA                           
IPCORD$  DS    PL8                 ORDERED DOLLARS SAVEAREA                     
IPCORD$T DS    PL8                 ORDERED DOLLARS SAVEAREA                     
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R6                                                            
*                                                                               
         TITLE 'PRWRITER - PLANNED COSTS -OUTPUT - OPC'                         
***********************************************************************         
*                                                                     *         
*        PLANNED COSTS                                                *         
*                                                                     *         
*NTRY    GLARGS+0     C'B'                                            *         
*               +1      C'M'     MONTH                                *         
*                +2       C'A'      ACTUALIZATION DATE                *         
*                         C'B'      BILLING EFFECTIVE DATE            *         
*                                                                     *         
*                                                                     *         
*EXIT   2PL8   -  LIVE AND TEST DATA                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OPC      NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC             ESTABLISH GENCON WORKING STORAGE             
*                                                                               
*        DETERMINE INPUT ROUTINE                                                
*                                                                               
         CLI   GLARGS+1,C'M'       MONTH DATE                                   
         BE    OPCMON                                                           
*                                                                               
         B     OPCX                UNKNOWN ROUTINE                              
*                                                                               
OPCMON   DS    0H                                                               
*                                                                               
OPCMONX  DS    0H                                                               
*                                                                               
         B     OPCX                                                             
*                                                                               
OPCX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - PG SPECIAL COSTS - INPUT - IPG'                      
***********************************************************************         
*                                                                     *         
*        PG SPECIAL COSTS - USE FIGURES IN PGCOST RECORD AFTER        *         
*         CUT OFF DATE                                                *         
*                                                                     *         
*NTRY    GLARGS+0-15 - SET TO GET APPROPRIATE COST THRU IDOLLAR       *         
*          EXCEPTION                                                            
*        GLARGS+3 = FIELD TYPE                                        *         
*                   C'A' - AVERAGE COST                               *         
*                   C'D' - EFFECTIVE DISCOUNT                         *         
*                   C'O' - OPEN    RATE                               *         
*                                                                     *         
*EXIT   2PL8   -  LIVE AND TEST DATA                                  *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPG      NMOD1 128,**#IPG                                                       
*                                                                               
         ST    RC,IPGWRKA          SAVE WORKING STORAGE POINTER                 
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R4                                                      
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   IF THERE IS NO BUY RECORD                    
         BE    *+8                                                              
         L     R4,AIO2             POINT TO CONTRACT RECORD AREA                
*                                                                               
*        READ IN PGCOST RECORD                                                  
*                                                                               
IPGREC   DS    0H                                                               
*                                                                               
*        FIND SPACE DESCRIPTION TO USE                                          
*                                                                               
IPGSPC   DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'A'       NO SPACE NEEDED FOR AVERAGE COST             
         BNE   IPGAVSPN                                                         
*                                                                               
         XC    IPGSPACE,IPGSPACE   CLEAR SPACE FIELD                            
*                                                                               
         B     IPGSPCX                                                          
*                                                                               
IPGAVSPN DS    0H                                                               
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   IF BUY RECORD PRESENT                        
         BNE   *+12                                                             
         LA    RF,PBDSPACE            USE BUY SPACE DESCRIPTION                 
         B     IPGSPC1                                                          
*                                                                               
         CLI   PBUYKRCD,PCONKIDQ   IF CONTRACT RECORD PRESENT                   
         BNE   IPGCONN                                                          
         ICM   R6,15,PBQCRTA          POINT TO CONTRACT RATE ELEMENT            
         BZ    IPGX                     MUST FIND IT                            
         LA    RF,PRBDESC-PRBELEM(R6)  USE RATE SPACE DESC                      
         B     IPGSPC1                                                          
*                                                                               
IPGCONN  DS    0H                                                               
*                                                                               
         B     IPGX                NO SPACE FOUND                               
*                                                                               
IPGSPC1  DS    0H                                                               
*                                                                               
         MVC   IPGSPACE,0(RF)     SAVE SPACE DESCRIPTION                        
         ZAP   IPGOPN,=P'0'        INIT OPEN RATE                               
*                                                                               
IPGSPCX  DS    0H                                                               
*                                                                               
*        READ RECORD                                                            
*                                                                               
         MVC   IPGAIO,AIO          SAVE CURRENT IOAREA ADDRESS                  
         MVC   AIO,IPGWRKA         READ INTO WORK AREA                          
*                                                                               
         XC    KEY,KEY             INIT KEY AREA                                
         LA    R3,KEY                                                           
         USING PGCOST,R3           ESTABLISH AS PGCOST KEY                      
*                                                                               
         MVC   PGCOAGY,PBAGY       SET AGENCY                                   
         MVC   PGCOMED,PBMED       SET MEDIA                                    
         MVI   PGCOTYPE,X'26'      SET RECORD ID                                
         MVC   PGCOCLT,PBCLT       SET CLIENT                                   
         MVC   PGCOPUB,PBPUB       SET PUB                                      
         MVC   PGCOSPAC,IPGSPACE   SET SPACE DESCRIPTION                        
*                                                                               
         GOTO1 HIGH                PGCOST RECORD                                
*                                                                               
         CLC   PGCOKEY,KEYSAVE     SKIP IF RECORD NOT FOUND                     
         BNE   IPGREC9                                                          
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
*        FIND NEEDED ELEMENT IN RECORD                                          
*                                                                               
         L     R3,AIO              POINT TO READ RECORD                         
*                                                                               
*        DETERMINE DATE TO COMPARE TO                                           
*                                                                               
         XC    IPGDATE,IPGDATE     INIT DATE                                    
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   IF THERE IS NO BUY RECORD                    
         BE    *+22                                                             
         ICM   RF,15,PBQCRTA          POINT TO CONTRACT RATE ELEMENT            
         BZ    IPGX                                                             
         MVC   IPGDATE,PRBDATE-PRBELEM(RF)   AND USE RATE EFF DATE              
         B     IPGDTEX                                                          
*                                                                               
         MVC   IPGDATE,PBUYKDAT    ELSE USE BUY INSERT DATE                     
*                                                                               
IPGDTEX  DS    0H                                                               
*                                                                               
         LA    R6,PGCOELEM         POINT TO FIRST ELEMENT                       
         SR    RE,RE                                                            
         SR    RF,RF                                                            
*                                                                               
IPGELMLP DS     0H                                                              
*                                                                               
         USING PGCOEL01,R6         ESTABLISH COST ELEMENT                       
*                                                                               
         CLI   0(R6),0             DONE IF END OF RECORD FOUND                  
         BE    IPGELMDN                                                         
*                                                                               
         CLI   0(R6),X'01'         SKIP IF WRONG ELEMENT ID                     
         BNE   IPGELMCN                                                         
*                                                                               
         OC    IPGDATE,IPGDATE     SKIP NEXT TEST IF NO DATE                    
         BZ    *+14                                                             
         CLC   PGCODATE,IPGDATE    SKIP IF DATE PAST WANTED DATE                
         BH    IPGELMCN                                                         
*                                                                               
         LTR   RE,RE               SKIP IF NO ELEMENT FOUND YET                 
         BZ    *+14                                                             
         CLC   PGCODATE,PGCODATE-PGCOEL01(RE) SKIP IF BEFORE PREVIOUS           
         BNH   IPGELMCN                DATE                                     
*                                                                               
         LR    RE,R6               SAVE ELEMENT ADDRESS                         
*                                                                               
IPGELMCN DS     0H                                                              
*                                                                               
         IC    RF,1(R6)            BUMP TO NEXT ELEMENT IN RECORD               
         LA    R6,0(RF,R6)                                                      
         B     IPGELMLP                                                         
*                                                                               
IPGELMDN DS     0H                                                              
*                                                                               
         LTR   RE,RE               SKIP IF NO COST ELEMENT FOUND                
         BZ    IPGREC9                                                          
*                                                                               
         LR    R6,RE               POINT TO FOUND ELEMENT                       
*                                                                               
         CLI   GLARGS+3,C'A'       SKIP IF NOT AVERAGE WANTED                   
         BNE   *+14                                                             
         ZAP   IPGAVG,PGCOAVG$     SAVE AVERAGE COST                            
         B     *+10                                                             
         ZAP   IPGOPN,PGCOOPEN     SAVE OPEN RATE                               
*                                                                               
IPGREC9 DS     0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE KEY                                  
         OI    DMINBTS,8         PASS BACK DELETED RECORDS       BUG11          
*                                                                               
         GOTO1 HIGH                RESTORE POINTERS ON FILE                     
*                                                                               
IPGRECX DS     0H                                                               
*                                                                               
*        CALCULATE RETURNED VALUE                                               
*                                                                               
IPGRATE DS     0H                                                               
*                                                                               
         CLI   GLARGS+3,C'O'       IF OPEN RATE WANTED                          
         BNE   *+14                                                             
         ZAP   0(8,R2),IPGOPN          RETURN OPEN COST                         
         B     IPGRATEX                                                         
*                                                                               
         CLI   GLARGS+3,C'A'       IF AVERAGE COST WANTED                       
         BE    *+8                                                              
         CLI   GLARGS+3,C'D'       OR EFF DISCOUNT WANTED                       
         BNE   IPG$AVGN                                                         
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   IF BUY IN CORE                               
         BNE   IPG$AVG3                                                         
         CLC   PBUYKDAT,PBQPGDT    AND INSERT AFTER CUT OFF DATE                
         BL    *+14                                                             
         ZAP   0(8,R2),IPGAVG          RETURN AVERAGE COST                      
         B     IPG$AVG9                                                         
*                                                                               
         GOTO1 =V(IDOLLAR)         ELSE USE NORMAL COST                         
         B     IPG$AVG9                                                         
*                                                                               
IPG$AVG3 DS    0H                                                               
*                                                                               
*        FIND CURRENT CONTRACT RATE LESS CD                                     
*                                                                               
         LA    RE,IPG$AVG4         FORCE RETURN ADDRESS                         
         NTR1                      SAVE REGISTERS                               
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD AREA                     
         ICM   R6,15,PBQCRTA       POINT TO CONTRACT RATE ELEMENT               
         BZ    IPGX                                                             
*                                                                               
         L     RF,=A(ICLV4BUY)     GET ROUTINE ADDRESS                          
         L     RB,=A(T40509)       RESET BASE REGISTER                          
         BR    RF                  GO FIND CURRENT CONTRACT RATE                
*                                                                               
IPG$AVG4 DS    0H                  RETURNS HERE                                 
*                                                                               
IPG$AVG9 DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'A'       DONE IF DOING AVERAGE COST                   
         BE    IPGRATEX                                                         
*                                                                               
IPG$AVGN DS    0H                                                               
*                                                                               
         CLI   GLARGS+3,C'D'       IF DISCOUNT WANTED                           
         BNE   IPGRATEX                                                         
*                                                                               
*        EFFECTIVE DISCOUNT = 100 - ((GROSS-CD/OPEN) * 100)                     
*                                                                               
         CP    IPGOPN,=P'0'        DEFAULT TO 0 IF NO OPEN RATE                 
         BNE   *+14                                                             
         ZAP   0(8,R2),=P'0'                                                    
         B     IPGRATEX                                                         
*                                                                               
         ZAP   WORK(15),0(8,R2)    GROSS LESS CD OR AVERAGE COST                
         MP    WORK(15),=P'1000'   *1000 FOR DECIMALS                           
         DP    WORK(15),IPGOPN     /OPEN RATE                                   
         SRP   WORK(10),64-1,5     ROUND RESULT                                 
         ZAP   0(8,R2),=P'100'     INIT OUTPUT AS 100                           
         SP    0(8,R2),WORK(10)    EFFECTIVE DISCOUNT                           
*                                                                               
IPGRATEX DS    0H                                                               
*                                                                               
*        CHECK IF WE NEED TO RETURN TEST BUY BUCKET                             
*                                                                               
         TM    PBQTOTTY,TOTTYPN   SKIP IF NORMAL TOTALS                         
         BO    IPGTSTX                                                          
*                                                                               
         L     R4,AIO1             ESTABLISH BUYREC                             
         USING PBUYRECD,R4                                                      
*                                                                               
         CLI   PBDBFD,C'T'        IF A TEST BUY                                 
         BNE   *+10                                                             
         ZAP   8(8,R2),0(8,R2)        RECORD IN SECOND BUCKET ALSO              
*                                                                               
IPGTSTX  DS    0H                                                               
*                                                                               
IPGX     DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IPGWRKA  DS    A                   WORKING STORAGE ADDRESS                      
*                                                                               
IPGSAV   DS    0X                  PG COST SAVEAREA                             
IPGDATE  DS    PL3                 DATE                                         
IPGSPACE DS    XL12                SPACE                                        
IPGARGSV DS    XL16                ARGUMENT SAVEAREA                            
IPGAVG   DS    PL5                 AVERAGE COST FOR SPACE                       
IPGOPN   DS    PL5                 OPEN RATE     FOR SPACE                      
IPGAIO   DS    AL4                 AIO SAVEAREA                                 
*                                                                               
IPGSAVL  EQU   *-IPGSAV            SAVE AREA LENGTH                             
*                                                                               
         DROP  R4,R3,R6                                                         
*                                                                               
         TITLE 'PRWRITER - POSITION INSTRUCTION CODE - INPUT - IPICODE'         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO EXTRACT POSITION INSTRUCTIONS CODE                *         
*                                                                     *         
*NTRY    R2==>  DRIVER INPUT AREA                                     *         
*        GLARGS    C'B' - BUY RELATED FIELD                           *         
*        GLARGS+1  AL1(MAX LENGTH OF CODE)                            *         
*                                                                     *         
*EXIT    0      -  DATA LENGTH (ODATA OUTPUT FORMAT)                  *         
*        1-6    -  DATA                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPICODE  NMOD1 0,**#IPICD                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             POINT TO BUY RECORD                          
         USING PBUYRECD,R4         ESTABLISH AS BUY RECORD                      
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   SKIP IF NOT A BUY RECORD THERE               
         BNE   IPICODEX                                                         
*                                                                               
         SR    RF,RF                                                            
         LA    R6,33(R4)           POINT TO FIRST ELEMENT IN RECORD             
*                                                                               
IPICDLP  DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE IF END OF RECORD REACHED                
         BE    IPICDDN                                                          
*                                                                               
         CLI   0(R6),PPOCELQ       SKIP IF NOT POSITION INSTRUCTION             
         BNE   IPICDCN                                                          
*                                                                               
         CLI   1(R6),7             ID,LENGTH,COM=,CD                            
         BL    IPICDCN             MAKE SURE ELEMENT IS LONG ENOUGH             
*                                                                               
         CLC   =C'COM=',2(R6)      LOOK FOR 'COM=' AT START                     
         BE    IPICDFD                                                          
*                                                                               
IPICDCN  DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT                         
         B     IPICDLP                                                          
*                                                                               
IPICDFD  DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         SH    RF,=H'6'            LENGTH OF CODE                               
         BNP   IPICDDN             NO CODE AVAILABLE                            
*                                                                               
         SR    RE,RE                                                            
         IC    RE,GLARGS+1         GET MAX LENGTH OF CODE                       
         STC   RE,0(R2)            PASS ON MAX LENGTH                           
*                                                                               
         CR    RF,RE               DEFAULT TO MAX LENGTH IF CDE TOO BIG         
         BNH   *+6                                                              
         LR    RF,RE                                                            
*                                                                               
         BCTR  RE,0                DECREMENT FOR EXECUTE                        
         EX    RE,*+8                                                           
         B     *+10                                                             
         MVC   1(0,R2),SPACES      INIT DRIVER AREA                             
*                                                                               
         LA    RE,1(RE)            RESTORE LENGTH                               
         SR    RE,RF               DIFFERENCE IN MAX AND TRUE LENGTH            
         LA    R1,1(RE,R2)         POINT TO START POINT                         
*                                                                               
         BCTR  RF,0                 DECREMENT FOR EXECUTE                       
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),6(R6)       PASS ON RIGHT JUSTIFIED CODE                 
*                                                                               
IPICDDN  DS    0H                                                               
*                                                                               
IPICODEX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE  'PRWRITER - NEW INV RECORD KEYWORDS - INPUT - IPNV'             
***********************************************************************         
*                                                                     *         
*        NEW INVOICE RECORD KEYWORDS -  INPUT                         *         
*                                                                     *         
*NTRY    GLARGS      C'X' - INVOICE RECORD                            *         
*        GLARGS+1    - DATA TYPE -                                    *         
*                      C'A' - AD CAPTION                              *         
*                      C'C' - CLIENT CODE                             *         
*                      C'V' - ACTIVITY ELEMENT                        *         
*                      C'D' - DISCREPANCY COMMENT                     *         
*        GLARGS+2    -   C'D' - DATE ADDED                            *         
*                        C'W' - WHO  ADDED                            *         
*                        C'M' - COMMENT                               *         
*                        C'A' - ACTIVITY                              *         
*        GLARGS+2    -   C'H' - HEADER                                *         
*                        C'D' - DETAIL                                *         
*                                                                     *         
*        PBIKYELA    A(INVOICE RECORD  KEY)                           *         
*        PBIHDELA    A(INVOICE HEADER  ELEMENT)                       *         
*        PBIDTELA    A(INVOICE DETAIL  ELEMENT)                       *         
*        PBICMELA    A(INVOICE DETAIL  COMMENT ELEMENT)               *         
*        PBICHELA    A(INVOICE HEADER  COMMENT ELEMENT)               *         
*        PBIADDTA    A(INVOICE ADDED   DATE)                          *         
*        PBANVMIN    A(INVOICE MINIO CONTROL BLOCK)                   *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPNV     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         CLI   GLARGS+1,C'A'       AD CAPTION                                   
         BNE   *+10                                                             
         MVC   0(2*L'PNVDACAP,R2),SPACES INIT OUTPUT                            
*                                                                               
         CLI   PBMODE,PBPROCNV     SKIP IF NOT PROCESSING NEW INVOICES          
         BNE   IPNVPNVN                                                         
*                                                                               
         ICM   R5,15,PBIKYELA         POINT TO INVOICE RECORD KEY               
         BZ    IPNVPNVX                  SKIP IF NO KEY AVAILABLE               
*                                                                               
         USING PNVKEY,R5              ESTABLISH INVOICE RECORD KEY              
*                                                                               
         CLI   PNVKRCD,PNVKRCDQ       SKIP IF NOT NEW INVOICE RECORD            
         BNE   IPNVPNVX                                                         
*                                                                               
         DROP  R5                                                               
*                                                                               
*        DETERMINE DATA TYPE                                                    
*                                                                               
         CLI   GLARGS+1,C'$'       INVOICE TOTAL                                
         BE    INVTOT                                                           
*                                                                               
         CLI   GLARGS+1,C'V'       INVOICE ACTIVITY                             
         BE    INVACV                                                           
*                                                                               
         CLI   GLARGS+1,C'A'       AD CAPTION                                   
         BE    INVADCP                                                          
*                                                                               
         CLI   GLARGS+1,C'C'       DETAIL CLIENT                                
         BE    INVDCLT                                                          
*                                                                               
         CLI   GLARGS+1,C'M'       COMMENT                                      
         BE    INVCOM                                                           
*                                                                               
         CLI   GLARGS+1,C'G'       DETAIL GROSS                                 
         BE    INVGRS                                                           
*                                                                               
         CLI   GLARGS+1,C'D'       DISCREPANCY COMMENT                          
         BE    INVDCM                                                           
*                                                                               
         B     IPNVX               UNKNOWN DATA TYPE                            
*                                                                               
*        INVOICE DETAIL AD CAPTION                                              
*        INPUT IS 50 BYTES OF CAPTION                                           
*                                                                               
INVADCP  DS    0H                  AD CAPTION                                   
*                                                                               
         MVC   0(2*L'PNVDACAP,R2),SPACES INIT OUTPUT                            
*                                                                               
         ICM   R4,15,PBIDTELA      ESTABLISH INVOICE DETAIL ELEMENT             
         BZ    INVADCPX            SKIP IF NONE AVAILABLE                       
         USING PNVDTLD,R4                                                       
*                                                                               
         MVC   0(L'PNVDACAP,R2),PNVDACAP 1ST PART OF CAPTION                    
         MVC   L'PNVDACAP(L'PNVDACAP,R2),PNVDACP2  2ND PART                     
*                                                                               
INVADCPX DS    0H                                                               
*                                                                               
         OC    0(2*L'PNVDACAP,R2),SPACES INIT OUTPUT                            
*                                                                               
         B     IPNVX                                                            
*                                                                               
*        INVOICE DETAIL CLIENT KEYWORDS                                         
*        OUTPUT IS AL1(INPUT LENGTH),AL3(CLIENT CODE)                           
*        DEFAULTS TO HEADER CLIENT IF MISSING                                   
*        CAN NOT BE '***'                                                       
*                                                                               
INVDCLT  DS    0H                  AD CAPTION                                   
*                                                                               
         ICM   R4,15,PBIDTELA      ESTABLISH INVOICE DETAIL ELEMENT             
         BZ    INVDCLTX            SKIP IF NONE AVAILABLE                       
         USING PNVDTLD,R4                                                       
*                                                                               
         ICM   R5,15,PBIKYELA         POINT TO INVOICE RECORD KEY               
         BZ    INVDCLTX                  SKIP IF NO KEY AVAILABLE               
*                                                                               
         USING PNVKEY,R5              ESTABLISH INVOICE RECORD KEY              
*                                                                               
         MVI   0(R2),5             LENGTH OF DATA                               
         MVC   1(3,R2),PNVDCLT     CLIENT CODE                                  
         MVC   4(1,R2),PNVKMED     MEDIA  CODE                                  
*                                                                               
         CLC   PNVDCLT,SPACES      IF CLIENT CODE IS MISSING                    
         BH    INVDCLTX                                                         
*                                                                               
         L     R6,PBIHDELA         ESTABLISH INVOICE HEADER ELEMENT             
         USING PNVHDRD,R6                                                       
*                                                                               
         CLC   PNVHCLT,=C'***'     SKIP IF CLIENT VARIOUS                       
         BE    *+10                                                             
         MVC   1(3,R2),PNVHCLT        CLIENT CODE                               
*                                                                               
INVDCLTX DS    0H                                                               
         B     IPNVX                                                            
*                                                                               
         DROP  R6                                                               
*                                                                               
*        INVOICE COMMENTS                                                       
*        OUTPUT IS AL2(PID),AL3(DATE),AL3(TIME),AL1(LEN)                        
*                  CL2(SECURITY AGENCY),AL220(COMMENT)                          
*                                                                               
INVCOM   DS    0H                  COMMENT                                      
*                                                                               
         ICM   R4,15,PBICMELA      ASSUME INVOICE DETAIL COMMENT                
*                                                                               
         CLI   GLARGS+2,C'H'       CHECK IF HEADER COMMENTS WANTED              
         BNE   INVCOMHX                                                         
*                                                                               
         ICM   R4,15,PBICHELA         USE HEADER COMMENT                        
*                                                                               
         ICM   R5,15,PBIKYELA      POINT TO INVOICE KEY                         
         BZ    INVCOMX             SKIP IF NONE AVAILABLE                       
         USING PNVKEY,R5           ESTABLISH KEY                                
*                                                                               
         CLC   INVKEYCS,PNVKEY     IF KEY CHANGED                               
         BE    INVCOMHX                                                         
*                                                                               
         MVC   INVKEYCS,PNVKEY        SAVE NEW KEY                              
*                                                                               
INVCOMHX DS    0H                                                               
*                                                                               
         LTR   R4,R4                                                            
         BZ    INVCOMX             SKIP IF NONE AVAILABLE                       
         USING PNVCOMD,R4                                                       
*                                                                               
         TM    PNVCSTAT,PNVCDLQ    SKIP IF DELETED                              
         BO    INVCOMX                                                          
*                                                                               
*        GET SECURITY AGENCY ID                                                 
*                                                                               
         CLC   INVAGY,PBAGY         DONE IF AGENCY UNCHANGED                    
         BE    INVSAGX                                                          
*                                                                               
         MVC   INVAGY,PBAGY         SAVE CURRENT AGENCY                         
******                                                                          
******   L     RF,ACOMFACS                                                      
******   USING COMFACSD,RF                                                      
******   GOTO1 CGETFACT,DMCB,(2,0),0,0   GET FAFACTS AREA                       
******                                                                          
******   DROP  RF                                                               
******                                                                          
******   L     R1,0(R1)                                                         
******   USING FACTSD,R1            ESTABLISH FAFACTS                           
******                                                                          
******   MVC   INVSAGY,FATAGYSC     SAVE SECURITY AGENCY                        
******                                                                          
******   DROP  R1                                                               
*                                                                               
INVSAGX  DS    0H                                                               
*                                                                               
******   MVC   8(2,R2),INVSAGY     RETURN SECURITY AGENCY                       
         MVC   8(2,R2),PBQSECAG    RETURN SECURITY AGENCY                       
*                                                                               
         MVC   0(2,R2),PNVCPID     PID                                          
         MVC   2(3,R2),PNVCDATE    DATE                                         
         MVC   5(3,R2),PNVCTIME    TIME                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,PNVCKLEN       GET ELEMENT LENGTH                           
         SHI   RF,PNVCOMLQ         LESS BASIC LENGTH                            
         BNP   INVCOMX             NO COMMENT AVAILABLE                         
         STC   RF,10(R2)           PASS COMMENT LENGTH                          
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   11(0,R2),PNVCCOM     PASS COMMENT                                
*                                                                               
INVCOMX  DS    0H                                                               
         B     IPNVPNVX                                                         
*                                                                               
         DROP  R4                                                               
*                                                                               
*        INVOICE TOTAL                                                          
*                                                                               
INVTOT   DS    0H                                                               
*                                                                               
         ICM   R5,15,PBIKYELA      POINT TO INVOICE KEY                         
         BZ    INVTOTX             SKIP IF NONE AVAILABLE                       
         USING PNVKEY,R5           ESTABLISH KEY                                
*                                                                               
         CLC   INVKEYS,PNVKEY      IF KEY CHANGED                               
         BE    INVTOTX                                                          
*                                                                               
         ICM   R6,15,PBIHDELA      POINT TO INVOICE HEADER ELEMENT              
         BZ    INVTOTX             SKIP IF NONE AVAILABLE                       
         USING PNVHDRD,R6          ESTABLISH HEADER ELEMENT                     
*                                                                               
         MVC   INVKEYS,PNVKEY         SAVE NEW KEY                              
         MVC   0(6,R2),PNVHTOT        RETURN INVOICE TOTAL                      
*                                                                               
INVTOTX DS     0H                                                               
         B     IPNVPNVX                                                         
*                                                                               
         DROP  R6                                                               
*                                                                               
*        LINE ITEM GROSS                                                        
*                                                                               
INVGRS   DS    0H                                                               
*                                                                               
         ICM   R5,15,PBIHDELA      POINT TO INVOICE HEADER                      
         BZ    INVGRSX             SKIP IF NONE AVAILABLE                       
         USING PNVHDRD,R5          ESTABLISH HEADER ELEMENT                     
*                                                                               
         CLI   PNVH$TYP,C'G'       SKIP IF NOT A GROSS INVOICE                  
         BNE   INVGRSX                                                          
*                                                                               
         DROP  R5                                                               
*                                                                               
         ICM   R6,15,PBIDTELA      POINT TO INVOICE DETAIL ELEMENT              
         BZ    INVGRSX             SKIP IF NONE AVAILABLE                       
         USING PNVDTLD,R6          ESTABLISH HEADER ELEMENT                     
*                                                                               
         TP    PNVDGRS             SKIP IF NOT A PACKED NUMBER                  
         BNE   INVGRSX                                                          
*                                                                               
         ZAP   0(6,R2),PNVDGRS        RETURN INVOICE DETAIL GROSS               
*                                                                               
INVGRSX DS     0H                                                               
         B     IPNVPNVX                                                         
*                                                                               
         DROP  R6                                                               
*                                                                               
*        ACTIVITY                                                               
*                                                                               
INVACV   DS    0H                                                               
*                                                                               
         L     R6,PBIADDTA         POINT TO INVOICE ADDED DATE                  
*                                                                               
         CLI   GLARGS+2,C'D'       IF ADDED DATE WANTED                         
         BNE   *+14                                                             
         MVC   0(3,R2),0(R6)          RETURN ADDED DATE                         
         B     INVACVX                                                          
*                                                                               
         CLI   GLARGS+2,C'W'       IF ADDED WHO WANTED                          
         BNE   *+14                                                             
         MVC   0(2,R2),3(R6)          RETURN ADDER PID                          
         B     INVACVX                                                          
*                                                                               
INVACVX  DS    0H                                                               
*                                                                               
         B     IPNVX                                                            
*                                                                               
*        DISCREPANCY COMMENTS                                                   
*                                                                               
INVDCM   DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'A'       SKIP IF NOT ACTIVITY KEYWORD                 
         BNE   INVDCMX                                                          
*                                                                               
         L     R5,PBANVMIN         POINT TO MINIO BLOCK                         
         USING MINBLKD,R5          ESTABLISH MINIO BLOCK                        
*                                                                               
         MVC   INVEKEY,MINEKEY     SAVE CURRENT MINIO ELM KEY                   
*                                                                               
         ICM   R4,15,PBIDTELA      ESTABLISH INVOICE DETAIL ELEMENT             
         BZ    INVDCMX             SKIP IF NONE AVAILABLE                       
         USING PNVDTLD,R4                                                       
*                                                                               
         XC    MINEKEY,MINEKEY     SET TO RE-READ DETAIL ELEMENT                
         MVC   MINEKEY(1),PNVDKCDE SET ELEMENT CODE                             
         MVC   MINEKEY+1(L'PNVDKEY-2),PNVDKSQN  SET REST OF KEY                 
*                                                                               
         GOTOR PBVMINIO,INVPARM,('MINHI',MINBLKD) RE-READ DETAIL ELM            
*                                                                               
         CLI   MINERR,0                                                         
         BNE   INVDCMDN            SKIP IF ERRORS                               
*                                                                               
INVDCMLP DS    0H                                                               
*                                                                               
         GOTOR PBVMINIO,INVPARM,('MINSEQ',MINBLKD)  READ NEXT ELEMENT           
*                                                                               
         CLI   MINERR,0            DONE IF ERRORS                               
         BNE   INVDCMDN                                                         
*                                                                               
         L     R6,MINELEM          POINT TO FOUND ELEMENT                       
         USING PNVACTHD,R6         ESTABLISH ACTIVITY ELEMENT                   
*                                                                               
         CLI   PNVAKCDE,PNVAKDTQ   DONE IF NOT DETAIL ELEMENT                   
         BNE   INVDCMDN                                                         
*                                                                               
         CLC   PNVAKDSQ,PNVDKSQN   DONE IF NOT SAME DETAIL SQN                  
         BNE   INVDCMDN                                                         
*                                                                               
         CLI   PNVAKACT,PNVAKACQ   SKIP IF NOT AN ACTIVITY ELM                  
         BNE   INVDCMCN                                                         
*                                                                               
         TM    PNVAHCH4,PNVADDCM   SKIP IF NO DCOM CHANGES                      
         BNO   INVDCMCN                                                         
*                                                                               
         MVC   0(2,R2),PNVAHPID    RETURN PID  OF CHANGER                       
         MVC   2(3,R2),PNVAHDTE    RETURN DATE OF CHANGE                        
*                                                                               
INVDCMCN DS    0H                                                               
*                                                                               
         B     INVDCMLP            READ NEXT ELEMENT                            
*                                                                               
INVDCMDN DS    0H                  NO MORE ACTIVITY ELEMENTS                    
*                                                                               
         OC    0(5,R2),0(R2)       IF DATA BEING RETURND                        
         BZ    *+10                                                             
         MVC   5(2,R2),PBQSECAG       RETURN SECURITY AGENCY                    
*                                                                               
         MVC   MINEKEY,INVEKEY     RESTORE CURRENT MINIO ELM KEY                
*                                                                               
         GOTOR PBVMINIO,INVPARM,('MINHI',MINBLKD) RE-READ ELEMENT               
*                                                                               
         CLI   MINERR,0            SHOULD NOT BE ERRORS                         
         BE    *+6                                                              
         DC    H'0'                                                             
*                                                                               
INVDCMX  DS    0H                                                               
*                                                                               
IPNVPNVN DS    0H                                                               
*                                                                               
IPNVPNVX DS    0H                                                               
*                                                                               
         B     IPNVX                                                            
*                                                                               
IPNVX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
INVPARM  DS    6F                  PARAMETER LIST                               
INVAGY   DS    CL2                 CURRENT AGENCY                               
INVSAGY  DS    CL2                 CURRENT SECURITY AGENCY                      
INVKEYS  DC    XL(L'PNVKEY)'00'    INVOICE KEY    SAVEAREA                      
INVKEYCS DC    XL(L'PNVKEY)'00'    INVOICE KEY    SAVEAREA                      
INVHDRS  DC    XL(PNVHDRLQ)'00'    INVOICE HEADER SAVEAREA                      
INVEKEY  DS    XL(L'MINEKEY)       MINIO ELEMENT KEY SAVEAREA                   
INVFILTL DS    XL(L'MINFILTL)      MINIO ELEMENT FILTER LENGTH                  
*                                                                               
         TITLE  'PRWRITER - NEW INV RECORD KEYWORDS - OUTPUT - OPNV'            
***********************************************************************         
*                                                                     *         
*        NEW INVOICE RECORD KEYWORDS - OUTPUT                         *         
*                                                                     *         
*NTRY    GLARGS      C'X' - INVOICE RECORD                            *         
*        GLARGS+1    - DATA TYPE -                                    *         
*                      C'A' - AD CAPTION                              *         
*                      C'S' - STATUS                                  *         
*                      C'M' - COMMENT                                 *         
*                                                                     *         
*          GLARGS+2      C'A' - ACTIVITY                              *         
*                          INPUT - XL2'PID',XL3'DATE',CL2'SEC AGY     *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OPNV     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        DETERMINE DATA TYPE                                                    
*                                                                               
         CLI   GLARGS+1,C'A'       AD CAPTION                                   
         BE    ONVADCP                                                          
*                                                                               
         CLI   GLARGS+1,C'S'       STATUS                                       
         BE    ONVSTAT                                                          
*                                                                               
         CLI   GLARGS+1,C'M'       COMMENT                                      
         BE    ONVCOM                                                           
*                                                                               
         CLI   GLARGS+1,C'C'       DISCREPANCY COMMENT                          
         BE    ONVDCM                                                           
*                                                                               
         B     OPNVX               UNKNOWN DATA TYPE                            
*                                                                               
*        INVOICE DETAIL AD CAPTION                                              
*        INPUT  IS 50 BYTES OF CAPTION                                          
*        OUPUT  IS 2 LINES OF 25 BYTES                                          
*                                                                               
ONVADCP  DS    0H                  AD CAPTION                                   
*                                                                               
         MVC   0(L'PNVDACAP,R3),0(R2) 1ST PART OF CAPTION                       
         MVC   198(L'PNVDACAP,R3),L'PNVDACAP(R2)  2ND PART                      
*                                                                               
         CLI   0(R3),C' '          IF NO CAPTION                                
         BH    *+8                                                              
         MVI   0(R3),X'41'            FORCE SOMETHING                           
*                                  FOOLS DRIVER ON DOWNLOADS                    
*                                                                               
ONVADCPX DS    0H                                                               
         B     OPNVX                                                            
*                                                                               
*        INVOICE STATUS                                                         
*        INPUT IS 1 BYTE CODE FOR INVOICE STATUS                                
*                                                                               
ONVSTAT  DS    0H                  STATUS                                       
*                                                                               
         LA    R1,ONVSTATB         POINT TO STATUS TRANSLATE TABLE              
*                                                                               
ONVSTLP  DS    0H                                                               
*                                                                               
         CLI   0(R1),X'FF'         DONE IF EOT REACHED                          
         BE    ONVSTDN                                                          
*                                                                               
         CLC   0(1,R2),0(R1)       FIND STATUS IN TABLE                         
         BE    ONVSTFD                                                          
*                                                                               
ONVSTCN  DS    0H                                                               
*                                                                               
         LA    R1,11(R1)           BUMP TO NEXT TABLE ENTRY                     
         B     ONVSTLP                                                          
*                                                                               
ONVSTDN  DS    0H                                                               
         B     ONVSTATX            EXIT - ENTRY NOT IN TABLE                    
*                                                                               
ONVSTFD  DS    0H                  ENTRY IN TABLE FOUND                         
*                                                                               
         MVC   0(10,R3),1(R1)      MOVE STATUS TO OUTPUT                        
*                                                                               
ONVSTATX DS    0H                                                               
         B     OPNVX                                                            
*                                                                               
ONVSTATB DS    0D                  TABLE FOR TRANSLATING INVOICE STATUS         
*                                                                               
         DC    CL1'P',CL10'PENDING'                                             
         DC    CL1'M',CL10'MATCHED'                                             
         DC    CL1'D',CL10'DISCREPANT'                                          
         DC    CL1'R',CL10'RNO'                                                 
         DC    CL1'N',CL10'NO INVOICE'                                          
*                                                                               
         DC    X'FF'               END OF TABLE                                 
*                                                                               
*        INVOICE COMMENT                                                        
*        INPUT  IS AL2(PID),AL3(DATE),AL3(TIME),                                
*                  CL2(SECURITY AGENCY),AL1(LEN),AL220(COMMENT)                 
*                                                                               
ONVCOM   DS    0H                  STATUS                                       
*                                                                               
         BRAS  RE,PIDTRN           PRINT BUYER'S NAME                           
*                                                                               
         OC    2(3,R2),2(R2)       IF THERE IS A DATE PRINT IT                  
         BZ    ONVCOM10                                                         
*                                                                               
         LA    R3,198(R3)          DATE AND TIME ON NEXT LINE                   
*                                                                               
         GOTOR DATCON,DMCB,(3,2(R2)),(17,0(R3))                                 
*                                                                               
ONVCOM10 DS    0H                                                               
*                                                                               
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,10(R2)         GET COMMENT LENGTH                           
         BZ    ONVCOMX             SKIP IF NO COMMENT                           
*                                                                               
         LA    R3,198(R3)          DATE AND TIME ON NEXT LINE                   
*                                                                               
         LA    R1,11(R2)           POINT TO START OF COMMENT                    
*                                                                               
ONVCOMLP DS    0H                                                               
*                                                                               
         ICM   RF,1,MYOLEN         GET OUTPUT WIDTH                             
*                                                                               
         CR    RF,R0               COMPARE TO REMAINING COMMENT LENGTH          
         BNH   *+6                                                              
         LR    RF,R0               USE SMALLER OF THE TWO LENGTHS               
*                                                                               
         LA    RE,0(RF,R1)         POINT TO LAST BYTE OF COMMENT LINE           
         BCTR  RE,0                                                             
*                                                                               
ONVCOM1L DS    0H                                                               
*                                                                               
         CLI   0(RE),C' '          FIND LAST BREAK IN COMMENT                   
         BNH   ONVCOM1F                                                         
*                                                                               
ONVCOM1C DS    0H                                                               
*                                                                               
         SHI   RE,1                BACK UP A BYTE                               
         BCT   RF,ONVCOM1L                                                      
*                                                                               
ONVCOM1D DS    0H                  NO BREAK IN COMMENT                          
*                                                                               
         IC    RF,MYOLEN           PRINT SOLID COMMENT LINE                     
*                                                                               
         CR    RF,R0               COMPARE TO REMAINING COMMENT LENGTH          
         BNH   *+6                                                              
         LR    RF,R0               USE SMALLER OF THE TWO LENGTHS               
*                                                                               
ONVCOM1F DS    0H                                                               
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R1)       PUT OUT FIRST LINE OF COMMENT                
*                                                                               
         AHI   RF,1                RESTORE TRUE LENGTH                          
*                                                                               
ONVCOMCN DS    0H                                                               
*                                                                               
         LA    R1,0(RF,R1)         BUMP TO NEXT SECTION OF COMMENT              
         LA    R3,198(R3)          BUMP TO NEXT LINE IN OUTPUT                  
         SR    R0,RF               LENGTH OF COMMENT YET TO PRINT               
         BNZ   ONVCOMLP                                                         
*                                                                               
ONVCOMDN DS    0H                                                               
*                                                                               
ONVCOMX  DS    0H                  STATUS                                       
*                                                                               
         B     OPNVX                                                            
*                                                                               
ONVDCM   DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'A'       SKIP IF ACTIVITY KEYWORD                     
         BE    ONVDATV                                                          
*                                                                               
         OC    0(L'DCMKDCM,R2),SPACES     FORCE UPPERCASE CODE                  
*                                                                               
         CLC   0(L'DCMKDCM,R2),SPACES     MUST HAVE A CODE                      
         BNH   ONVDCMX                                                          
*                                                                               
         LA    R5,DCMTAB           POINT TO TABLE OF COMMENTS                   
         USING DCMTAB,R5           ESTABLISH TABLE ENTRY                        
*                                                                               
ONVDCMLP DS    0H                                                               
*                                                                               
         CLI   DCMTCODE,X'FF'      DONE AT END OF TABLE                         
         BZ    ONVDCMDN                                                         
*                                                                               
         CLC   DCMTCODE,0(R2)      CHECK IF CODE ALREADY IN TABLE               
         BE    ONVDCMFD            YES                                          
*                                                                               
ONVDCMCN DS    0H                                                               
*                                                                               
         LA    R5,DCMTLNGQ(R5)     BUMP TO NEXT TABLE ENTRY                     
         B     ONVDCMLP                                                         
*                                                                               
ONVDCMDN DS    0H                  CODE NOT IN TABLE                            
*                                  READ DCM RECORD                              
         MVC   DCMTCODE,0(R2)      SAVE CODE IN TABLE                           
         MVI   DCMTLNGQ(R5),X'FF'  RESET END OF TABLE                           
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              BUILD DCM RECORD KEY                         
         USING DCMRECD,R4          ESTABLISH KEY                                
*                                                                               
         MVC   DCMKAGY,AGENCY      SET AGENCY                                   
         MVI   DCMKMED,C'A'        SET UNIVERSAL MEDIA                          
         MVI   DCMKRCD,DCMKR1Q     SET MAJOR RECORD ID                          
         MVI   DCMKRC2,DCMKR2Q     SET MINOR RECORD ID                          
         MVC   DCMKDCM,0(R2)       SET DCM CODE                                 
*                                                                               
         GOTOR HIGH                READ FOR RECORD                              
*                                                                               
         BNZ   ONVDCM10            DONE IF NO RECORD                            
*                                                                               
         CLC   DCMKEY,KEYSAVE      DONE IF RECORD NOT FOUND                     
         BNE   ONVDCM10                                                         
*                                                                               
         GOTOR GETREC              READ IN RECORD                               
*                                                                               
         L     R4,AIO              POINT TO FOUND RECORD                        
         LR    R6,R4               INITIALIZE R6                                
*                                                                               
         LA    R6,DCMFRST          POINT TO FIRST ELEMENT                       
         USING DCMCELD,R6          ESTABLISH COMMENT ELEMENT                    
*                                                                               
         CLI   DCMCELEM,0          DONE AT END OF RECORD                        
         BE    ONVDCM10                                                         
         CLI   DCMCELEM,DCMCELCQ   FIND DCM ELEMENT                             
         BE    *+18                                                             
         LLC   RF,DCMCELEN         ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         NEXT ELEMENT                                 
         B     *-26                                                             
*                                                                               
         LLC   RF,DCMCELEN         GET ELEMENT LENGTH                           
         SHI   RF,DCMCELNQ         DECREMENT BY ELM HEADER LENGTH               
         BNP   ONVDCMDN            NO COMMENT                                   
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   DCMTCOM(0),DCMCCOMM    ADD COMMENT TO TABLE                      
*                                                                               
ONVDCMFD DS    0H                                                               
*                                                                               
         L     R6,GLADTENT                                                      
         USING DROD,R6                                                          
*                                                                               
         TM    PBQPOPT,PBQPOCUT    IF OUTPUT CUT TO COLUMN WIDTH                
         BNO   ONVNOCT                                                          
*                                                                               
         ZIC   RF,DROLEN           OUTPUT LENGTH                                
         BCTR  RF,0            ENTRY LENGTH CONTAINS BOX LINE                   
         EX    RF,*+8                                                           
         B     ONVDCM10                                                         
         MVC   0(0,R3),DCMTCOM     MOVE COMMENT TO OUTPUT                       
*                                                                               
ONVNOCT  DS    0H                                                               
*                                                                               
         LA    RF,L'DCMTCOM        MAX COMMENT LENGTH                           
         LA    R1,DCMTCOM-1(RF)    LAST BYTE OF COMMENT                         
*                                                                               
*        FIND LAST CHAR OF COMMENT                                              
*                                                                               
         CLI   0(R1),C' '          SEARCH FOR LAST NON-SPACE                    
         BH    *+16                                                             
         SHI   R1,1                BACKUP BYTE                                  
         BCT   RF,*-12                                                          
         B     ONVDCM10            NO COMMENT                                   
*                                  RF NOW HAS COMMENT LENGTH                    
*                                                                               
         GOTO1 CHOPPER,DMCB,(0,DCMTCOM),(DROLEN,(R3)),(198,14),        X        
               C'LEN=',(RF)                                                     
*                                                                               
         DROP  R6                                                               
*                                                                               
ONVDCM10 DS    0H                                                               
*                                                                               
         CLC   0(L'DCMTCODE,R3),SPACES  IF NO COMMENT                           
         BH    *+10                                                             
         MVC   0(L'DCMTCODE,R3),DCMTCODE   RETURN CODE INSTEAD                  
*                                                                               
ONVDCMX  DS    0H                                                               
*                                                                               
         B     OPNVX                                                            
*                                                                               
*                                                                               
*        REPORT DISCREPANCY COMMENT ACTIVITY                                    
*                                                                               
*        XL2'PID',XL3'DATE',CL2'SEC AGY ALPHA'                                  
*                                                                               
ONVDATV  DS    0H                                                               
*                                                                               
         OC    0(5,R2),0(R2)       SKIP IF NO DATA                              
         BZ    ONVDATVX                                                         
*                                                                               
         MVC   8(2,R2),5(R2)       RE-POSITION SECURITY AGENCY ALPHA            
*                                                                               
         BRAS  RE,PIDTRN           PRINT CHANGER'S NAME                         
*                                                                               
         OC    2(3,R2),2(R2)       IF THERE IS A DATE PRINT IT                  
         BZ    ONVDATVX                                                         
*                                                                               
         LA    R3,198(R3)             DATE ON NEXT LINE                         
*                                                                               
         GOTOR DATCON,DMCB,(3,2(R2)),(17,0(R3))                                 
*                                                                               
ONVDATVX DS    0H                                                               
*                                                                               
         B     OPNVX                                                            
*                                                                               
OPNVX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
DCMTAB   DS    0H                  TABLE OF DCOMM CODES AND COMMENTS            
         DC    X'FF'               SET TABLE EMPTY AT FIRST                     
         ORG   DCMTAB                                                           
DCMTCODE DS    XL(L'DCMKDCM)       CODE                                         
DCMTCOM  DS    CL80                COMMENT                                      
DCMTLNGQ EQU   *-DCMTAB            LENGTH OF TABLE ENTRY                        
         DS    99XL(DCMTLNGQ)      REST OF TABLE                                
         DS    X'FF'               END OF TABLE                                 
*                                                                               
         DROP  R5                                                               
*                                                                               
         TITLE 'PRWRITER - PURCHASE ORDER - INPUT - IPO#'                       
***********************************************************************         
*                                                                     *         
*        PURCHASE ORDER FIELDS                                        *         
*                                                                     *         
*NTRY    GLARGS     C'B'  - DATA IN BUY RECORDS AND ESTIMATE RECORDS  *         
*          GLARGS+1    C'#'  - PO#                                    *         
*                      C'S'  - PO# START DATE                         *         
*                      C'E'  - PO# END   DATE                         *         
*                      C'P'  - PO# PERIOD                             *         
*                      C'T'  - PO# STATUS                             *         
*                      C'$'  - PO# DOLLARS                            *         
*            GLARGS+2     C'1' -  GROSS                               *         
*                         C'4' -  NET                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPO#     NTR1  BASE=*,LABEL=*,WORK=(RC,500)                                     
*                                                                               
         ST    RC,IPO#WSTA         SAVE A(WORKING STORAGE)                      
*                                                                               
         L     RC,GLAWORKD         ESTABLISH GENCON WORKAREA                    
         USING GEND,RC             ESTABLISH WORKING STORAGE                    
*                                                                               
         XC    IPO#PO#A,IPO#PO#A   INIT A(PO# TABLE ENTRY)                      
         XC    IPO#KYSV,IPO#KYSV   INIT CURRENT KEY                             
         XC    IPO#AIOS,IPO#AIOS   INIT CURRENT AIO                             
*                                                                               
         L     R2,AIO1             POINT TO BUY RECORD                          
         USING PBUYRECD,R2         ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   DONE IF NOT A BUY RECORD                     
         BNE   IPO#X                                                            
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT                       
         USING PBYPOELM,R6         ESTABLISH PO ELEMENT                         
*                                                                               
         SR    RF,RF                                                            
*                                                                               
IPO#BYLP DS    0H                                                               
*                                                                               
         CLI   PBYPOELC,0          DONE IF NO PO ELEMENT                        
         BE    IPO#BYDN                                                         
*                                                                               
         CLI   PBYPOELC,PBYPOELQ   SKIP IF NOT PO ELM                           
         BNE   IPO#BYCN                                                         
*                                                                               
         TM    PBYPOSTA,BYPOZZZQ   IF FOR A ZZZ BUY                             
         BNO   *+14                                                             
         CLC   PBYPOPRD,PBPROD        MUST MATCH CURRENT PRODUCT                
         BNE   IPO#BYCN                                                         
*                                                                               
         B     IPO#BYFD                                                         
*                                                                               
IPO#BYCN DS    0H                                                               
         IC    RF,PBYPOELL         GET ELEMENT LENGTH                           
         LA    R6,PBYPOELM(RF)     BUMP TO NEXT ELEMENT                         
         B     IPO#BYLP                                                         
*                                                                               
IPO#BYDN DS    0H                                                               
*                                                                               
         B     IPO#X               DONE IF NO PO#                               
*                                                                               
IPO#BYFD DS    0H                                                               
*                                                                               
*        FIND PO# IN TABLE                                                      
*                                                                               
         CLC   PBUYKMED,IPO#HMED   SEE IF TABLE HDR CHANGED                     
         BNE   IPO#TNW             MEDIA                                        
         CLC   PBUYKCLT,IPO#HCLT   CLIENT                                       
         BNE   IPO#TNW                                                          
         CLC   PBPROD,IPO#HPRD     PRODUCT - FOR ZZZ BUYS                       
         BE    IPO#TNWX                                                         
*                                                                               
*        RE-INITIALIZE PO# TABLE                                                
*                                                                               
IPO#TNW  DS    0H                                                               
*                                                                               
         XC    IPO#HDR(IPO#HDRL),IPO#HDR INIT TABLE HEADER                      
*                                                                               
         MVC   IPO#HMED,PBMED      RESET MEDIA                                  
         MVC   IPO#HCLT,PBCLT      CLIENT                                       
         MVC   IPO#HPRD,PBPROD      PRODUCT                                     
*                                                                               
*        FIND PO# LEVEL FOR CLIENT                                              
*                                                                               
         L     RE,PBCLTADR         LOOK IN CLIENT RECORD                        
         LA    RE,33(RE)           POINT TO FIRST ELM IN CLTHDR                 
*                                                                               
         CLI   0(RE),0             SKIP IF END OF RECORD FOUND                  
         BE    IPO#10                                                           
         CLI   0(RE),PCLTPOEQ      FIND PO# ELM                                 
         BE    *+18                                                             
         LLC   RF,1(RE)            ELM LENGTH                                   
         LA    RE,0(RF,RE)         NEXT ELM                                     
         B     *-26                                                             
*                                                                               
         USING PCLTPOEL,RE         ESTABLISH CLIENT PO# ELM                     
         MVC   IPO#HLVL,PCLTPOLV   SAVE CLIENT PO# LEVEL                        
*                                                                               
         DROP  RE                                                               
*                                                                               
IPO#10   DS    0H                                                               
*                                                                               
*        RESET BXLE REGISTERS FOR TABLE                                         
*                                                                               
         LA    RF,IPO#TAB          SET START OF TABLE                           
         ST    RF,IPO#STRT                                                      
         BCTR  RF,0                                                             
         ST    RF,IPO#END          SET END OF TABLE AS EMPTY                    
*                                                                               
IPO#TNWX DS    0H                                                               
*                                                                               
*        FIND PO# IN TABLE                                                      
*                                                                               
         LM    R3,R5,IPO#BXLE      LOAD BXLE REGISTERS FOR PO# TABLE            
*                                                                               
         CR    R5,R3               SKIP IF TABLE IS EMPTY                       
         BL    IPO#PODN                                                         
*                                                                               
IPO#POLP DS    0H                                                               
*                                                                               
         USING IPO#TENT,R3         ESTABLISH TABLE ENTRY                        
*                                                                               
         CLI   IPO#HLVL,P_POLVEQ   SKIP IF NOT EST LEVL PO#'S                   
         BE    *+8                                                              
         CLI   IPO#HLVL,0          SKIP IF NOT EST LEVL PO#'S                   
         BNE   *+14                                                             
         CLC   IPO#TEST,PBUYKEST   MATCH ESTIMATE                               
         BNE   IPO#POCN                                                         
*                                                                               
         CLC   IPO#TSQ#,PBYPOSQ#   MATCH PO#                                    
         BNE   IPO#POCN                                                         
*                                                                               
         ST    R3,IPO#PO#A         SAVE A(PO# TABLE ENTRY)                      
*                                                                               
         B     IPO#POFD                                                         
*                                                                               
IPO#POCN DS    0H                                                               
         BXLE  R3,R4,IPO#POLP      TRY NEXT IN TABLE                            
*                                                                               
IPO#PODN DS    0H                  PO# NOT IN TABLE                             
*                                                                               
*        READ PO# RECORD                                                        
*                                                                               
         MVC   IPO#KYSV,IOKEYSVE   SAVE CURRENT KEY                             
         MVC   IPO#AIOS,AIO        SAVE CURRENT AIO                             
*                                                                               
         XC    KEY,KEY                                                          
         LA    R7,KEY                                                           
         USING PPO#KEY,R7          ESTABLISH KEY FOR PO# RECORD                 
*                                                                               
         MVC   PPO#KAGY,PBUYKAGY   SET AGENCY                                   
         MVC   PPO#KMED,PBUYKMED   SET MEDIA                                    
         MVI   PPO#KRCD,PPO#KIDQ   SET RECORD ID                                
         MVC   PPO#KCLT,PBUYKCLT   SET CLIENT                                   
*                                                                               
         CLI   IPO#HLVL,P_POLVCQ   SKIP IF CLT LEVL PO#'S                       
         BE    *+10                                                             
         MVC   PPO#KPRD,PBPROD     SET PRODUCT                                  
*                                                                               
         CLI   IPO#HLVL,P_POLVCQ   SKIP IF CLT LEVL PO#'S                       
         BE    *+8                                                              
         CLI   IPO#HLVL,P_POLVPQ   SKIP IF PRD LEVL PO#'S                       
         BE    *+10                                                             
         MVC   PPO#KEST,PBUYKEST   SET ESTIMATE                                 
*                                                                               
         GOTOR HIGH                READ PO# RECORD                              
*                                                                               
         CLC   PPO#KEY,KEYSAVE     SKIP IF NO PO# RECORD                        
         BNE   IPO#X                                                            
*                                                                               
         MVC   AIO,IPO#WSTA        READ RECORD INTO WORKING STORAGE             
*                                                                               
         GOTOR GETREC                                                           
*                                                                               
         L     R7,AIO              POINT TO FOUND RECORD                        
*                                                                               
*        SEARCH PO# RECORD FOR ELEMENT                                          
*                                                                               
         LA    R7,PO#FIRST         POINT TO FIRST ELEMENT                       
         USING PO#DELMD,R7         ESTABLISH PO# ELEMENT                        
*                                                                               
         SR    RF,RF                                                            
*                                                                               
IPO#ELLP DS    0H                                                               
*                                                                               
         CLI   PO#DELID,0          SKIP IF END OF RECORD                        
         BE    IPO#ELDN                                                         
*                                                                               
         CLI   PO#DELID,PO#DLIDQ   MATCH ON ELEMENT ID                          
         BNE   IPO#ELCN                                                         
*                                                                               
         CLC   PO#DID,PBYPOSQ#     MATCH ON PO# INTERNAL ID                     
         BE    IPO#ELFD                                                         
*                                                                               
IPO#ELCN DS    0H                                                               
         IC    RF,PO#DLEN          GET ELEMENT LENGTH                           
         LA    R7,PO#DELM(RF)      BUMP TO NEXT ELEMENT                         
         B     IPO#ELLP                                                         
*                                                                               
IPO#ELDN DS    0H                                                               
         B     IPO#X                                                            
*                                                                               
IPO#ELFD DS    0H                                                               
*                                                                               
*        ADD PO# TO TABLE                                                       
*                                                                               
         ST    R3,IPO#PO#A         SAVE A(PO# TABLE ENTRY)                      
*                                                                               
         CLI   IPO#HLVL,P_POLVEQ   SKIP IF NOT EST LEVL PO#'S                   
         BE    *+8                                                              
         CLI   IPO#HLVL,0          SKIP IF NOT EST LEVL PO#'S                   
         BNE   *+10                                                             
         MVC   IPO#TEST,PBUYKEST   SAVE ESTIMATE                                
*                                                                               
         MVC   IPO#TSQ#,PBYPOSQ#   SAVE INTERNAL PO#                            
*                                                                               
         IC    RF,PO#DLEN          GET ELEMENT LENGTH                           
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   IPO#TELM(0),PO#DELM SAVE PO# ELEMENT                             
*                                                                               
         AR    R3,R4               POINT TO NEXT ENTRY IN TABLE                 
*                                                                               
         XC    IPO#TENT(IPO#TLNQ),IPO#TENT INIT NEXT ENTRY                      
*                                                                               
         BCTR  R3,0                RESET BXLE REGISTERS                         
         ST    R3,IPO#END                                                       
*                                                                               
IPO#POFD DS    0H                  WE PO# TABLE ENTRY                           
*                                                                               
*        RETURN PO# DATA                                                        
*                                                                               
         ICM   R3,15,IPO#PO#A      POINT TO PO# TABLE ENTRY                     
         BZ    IPO#X                                                            
*                                                                               
         LA    R7,IPO#TELM         POINT TO PO# ELEMENT                         
         USING PO#DELMD,R7         ESTABLISH PO# ELEMENT                        
*                                                                               
         L     R2,GLAIFLD          R2=A(INPUT)                                  
*                                                                               
*        DETERMINE DATA TO BE RETURNED                                          
*                                                                               
         CLI   GLARGS+1,C'#'       PO#                                          
         BE    IPO#PO#                                                          
*                                                                               
         CLI   GLARGS+1,C'S'       START DATE                                   
         BE    IPO#SDT                                                          
*                                                                               
         CLI   GLARGS+1,C'E'       END   DATE                                   
         BE    IPO#EDT                                                          
*                                                                               
         CLI   GLARGS+1,C'P'       PERIOD                                       
         BE    IPO#PER                                                          
*                                                                               
         CLI   GLARGS+1,C'T'       STATUS                                       
         BE    IPO#STA                                                          
*                                                                               
         CLI   GLARGS+1,C'$'       DOLLARS                                      
         BE    IPO#$                                                            
*                                                                               
*        PO#                                                                    
*                                                                               
IPO#PO#  DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,PO#DLEN          ELEMENT LENGTH                               
         SHI   RF,PO#DHDLQ         LESS HEADER LENGTH                           
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),PO#DPO#     RETURN PO#                                   
*                                                                               
         B     IPO#X                                                            
*                                                                               
IPO#SDT  DS    0H                                                               
*                                                                               
*        START DATE                                                             
*                                                                               
         MVC   0(L'PO#DSTRT,R2),PO#DSTRT RETURN BINARY START DATE               
*                                                                               
         B     IPO#X                                                            
*                                                                               
IPO#EDT  DS    0H                                                               
*                                                                               
*        END   DATE                                                             
*                                                                               
         MVC   0(L'PO#DEND,R2),PO#DEND  RETURN BINARY START DATE                
*                                                                               
         B     IPO#X                                                            
*                                                                               
IPO#PER  DS    0H                                                               
*        PERIOD                                                                 
*                                                                               
         MVC   0(2*L'PO#DSTRT,R2),PO#DSTRT  RETURN BINARY PERIOD                
*                                                                               
         B     IPO#X                                                            
*                                                                               
*        STATUS                                                                 
*                                                                               
IPO#STA  DS    0H                                                               
         TM    PO#DACTV,PO#DINAQ   IF PO# IS INACTIVE                           
         BNO   *+10                                                             
         MVC   0(8,R2),=C'INACTIVE'   SET INACTIVE STATUS                       
*                                                                               
         B     IPO#X                                                            
*                                                                               
*        DOLLARS                                                                
*                                                                               
IPO#$    DS    0H                                                               
*                                                                               
         ZAP   0(8,R2),=P'0'       INIT OUTPUT                                  
         ZAP   8(8,R2),=P'0'       INIT OUTPUT                                  
*                                                                               
         TP    PO#D$               MAKE SURE WE HAVE PACKED NUMBER              
         BNE   IPO#$X                                                           
*                                                                               
         ZAP   0(8,R2),PO#D$       RETURN DOLLARS                               
         ZAP   8(8,R2),=P'1'       COUNTER                                      
*                                                                               
         CLI   PO#DGORN,C'N'       IF NET AMOUNT                                
         BNE   IPO#$50                SKIP IF UNKNOWN $ TYPE                    
*                                                                               
         CLI   GLARGS+2,C'4'          DONE IF NET WANTED                        
         BE    IPO#$X                                                           
*                                                                               
         ZAP   IPO#PL16,0(8,R2)                                                 
         MP    IPO#PL16,=PL3'11765'    ELSE RETURN 117.65%                      
         SRP   IPO#PL16,64-4,5                                                  
         ZAP   0(8,R2),IPO#PL16                                                 
*                                                                               
         B     IPO#$X                                                           
*                                                                               
IPO#$50  DS    0H                                                               
*                                  ANYTHING ELSE IS GROSS                       
*                                                                               
         CLI   GLARGS+2,C'1'          DONE IF GROSS WANTED                      
         BE    IPO#$X                                                           
*                                                                               
         MP    0(8,R2),=PL2'85'       ELSE NET - RETURN 85%                     
         SRP   0(8,R2),64-2,5                                                   
         B     IPO#$X                                                           
*                                                                               
IPO#$X   DS    0H                                                               
         B     IPO#X                                                            
*                                                                               
IPO#X    DS    0H                                                               
*                                                                               
         OC    IPO#KYSV,IPO#KYSV   SKIP IF NO PO# REC READ                      
         BZ    IPO#XX                                                           
*                                                                               
         MVC   KEY,IPO#KYSV        RESTORE CURRENT KEY                          
         MVC   AIO,IPO#AIOS        RESTORE CURRENT AIO                          
*                                                                               
         GOTOR HIGH                RESTORE FILE POINTERS                        
*                                                                               
IPO#XX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
IPO#PL16 DS    PL16                PACKED WORKAREA                              
IPO#WSTA DS    A                   A(WORKING STORAGE)                           
IPO#KYSV DS    XL(L'KEY)           CURRENT KEY SAVEAREA                         
IPO#AIOS DS    A                   CURRENT AIO SAVEAREA                         
IPO#PO#A DS    A                   A(PO# TABLE ENTRY)                           
*                                                                               
IPO#HDR  DS    0H                  HEADER FOR PO# TABLE                         
IPO#HMED DS    CL1                 MEDIA                                        
IPO#HCLT DS    CL3                 CLIENT                                       
IPO#HPRD DS    CL3                 PRODUCT                                      
IPO#HLVL DS    CL1                 CLIENT PO# LEVEL                             
IPO#HDRL EQU   *-IPO#HDR           HEADER LENGTH                                
*                                                                               
IPO#BXLE DS    0D                  BXLE REGISTERS FOR PO# TABLE                 
IPO#STRT DC    A(IPO#TAB)          A(TABLE START)                               
IPO#LEN  DC    AL4(IPO#TLNQ)       ENTRY LENGTH                                 
IPO#END  DC    A(IPO#TAB-1)        A(TABLE END)                                 
*                                                                               
*        TABLE OF PO'S                                                          
*                                                                               
IPO#TAB  DS    0D                                                               
*                                                                               
IPO#TENT DS    0X                  START OF TABLE ENTRY                         
IPO#TEST DS    CL2                 ESTIMATE                                     
IPO#TSQ# DS    XL2                 PO# - INTERNAL                               
IPO#TELM DS    CL64                PO# ELM                                      
IPO#TLNQ EQU   *-IPO#TENT          LENGTH OF TABLE ENTRY                        
*                                                                               
         DS    300XL(IPO#TLNQ)     REST OF TABLE                                
*                                                                               
         DROP  R2,R7                                                            
*                                                                               
         TITLE 'PRWRITER - PURCHASE ORDER - INPUT - OPO#'                       
***********************************************************************         
*                                                                     *         
*        PURCHASE ORDER FIELDS                                        *         
*                                                                     *         
*NTRY    GLARGS     C'B'  - DATA IN BUY RECORDS AND ESTIMATE RECORDS  *         
*          GLARGS+1    C'#'  - PO#                                    *         
*                      C'S'  - PO# START DATE                         *         
*                      C'E'  - PO# END   DATE                         *         
*                      C'P'  - PO# PERIOD                             *         
*                      C'S'  - PO# STATUS                             *         
*                      C'$'  - PO# DOLLARS                            *         
*            GLARGS+2     C'1' -  GROSS                               *         
*                         C'4' -  NET                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OPO#     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC             ESTABLISH WORKING STORAGE                    
*                                                                               
*        DETERMINE DATA TO BE RETURNED                                          
*                                                                               
         CLI   GLARGS+1,C'$'       DOLLARS                                      
         BE    OPO#$                                                            
*                                                                               
*        RETURN DOLLAR AMOUNT                                                   
*              TOTAL AMOUNT DIVIDED BY COUNTER                                  
*                                                                               
OPO#$    DS    0H                                                               
*                                                                               
         TP    0(8,R2)             MAKE SURE INPUT IS PACKED                    
         BNE   OPO#$X                                                           
*                                                                               
         CP    8(8,R2),=P'0'       SKIP DIVISION BY ZERO                        
         BE    OPO#$X                                                           
*                                                                               
         ZAP   OPO#PL16,0(8,R2)    MOVE TOTAL $'S TO WORKAREA                   
         SRP   OPO#PL16,1,0        SCALE BY 10 FOR ROUNDING                     
         DP    OPO#PL16,8(8,R2)    DIVIDE BY COUNTER                            
         SRP   OPO#PL16(8),64-1,5  ROUND                                        
*                                                                               
         ZAP   0(8,R2),OPO#PL16(8) RETURN $ AVERAGE                             
*                                                                               
         MVI   GLHOOK,GLEDIT       HAVE DRIVER EDIT                             
*                                                                               
OPO#$X   DS    0H                                                               
         B     OPO#X                                                            
*                                                                               
OPO#X    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
OPO#PL16 DS    PL16                LARGE PACK # WORKAREA                        
*                                                                               
         TITLE 'CHANGES TO BUY RECORD OUTPUT - TRNPID'                          
***********************************************************************         
*                                                                     *         
*        ROUTINE TO GET PERSONS NAME FROM THEIR PID                   *         
*                                                                     *         
*NTRY    R2 ==> AL2(PID),XL6,CL2(SECURITY AGENCY)                     *         
*                                                                     *         
*EXIT    R3 ==> NAME SQUASHED                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
PIDTRN   NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING PBUYRECD,R4         ESTABLISH BUY RECORD                         
         USING PCHGELD,R6          ESTABLISH CHANGE ELEMENT                     
*                                                                               
         LA    R5,0(R2)                                                         
*                                                                               
*        R5 ==> PID - FIND CTFILE RECORD                                        
*                                                                               
PTRNGET  DS    0H                                                               
*                                                                               
         OC    0(2,R5),0(R5)       SKIP IF NO PID FOUND                         
         BZ    PIDTRNX                                                          
*                                                                               
*        READ PERSON AUTH REC ON CTFILE                                         
*                                                                               
         LA    R7,KEY                                                           
         USING CT0REC,R7           ESTABLISH KEY AS PERSON AUTH REC             
         XC    CT0KEY,CT0KEY       INIT KEY                                     
*                                                                               
         MVI   CT0KTYP,CT0KTEQU    SET RECORD TYPE                              
         MVC   CT0KAGY,8(R5)       SET SECURITY AGENCY                          
*                                                                               
         CLC   CT0KAGY,=CL2' '     IF SECURITY AGENCY NOT PRESENT               
         BH    *+10                                                             
         MVC   CT0KAGY,PBAGY          USE REPORT'S AGENCY                       
*                                                                               
         MVC   CT0KNUM,0(R5)       SET PID                                      
*                                                                               
         MVC   FILENAME,=CL8'CTFILE'    SET FILENAME                            
         MVC   AIO,AIO2                 READ RECORD INTO IOA2                   
         MVI   USEIO,C'Y'               READ INTO I/O AREA                      
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         XC    FILENAME,FILENAME   RESET FILE NAME                              
         MVI   USEIO,0             RESET SWITCH                                 
*                                                                               
         L     R7,AIO              POINT TO FOUND RECORD                        
*                                                                               
         CLC   CT0KEY,KEYSAVE      SKIP IF RECORD NOT FOUND                     
         BNE   PTRNNOTF                                                         
*                                                                               
*        FIND USER'S ID                                                         
*                                                                               
*        FIND PERSON'S ID ELEMENT                                               
*                                                                               
         LA    RE,CT0DATA          POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
PTRNCTLP DS    0H                                                               
*                                                                               
         CLI   0(RE),0             CHECK FOR END OF RECORD                      
         BE    PTRNCTDN                                                         
*                                                                               
         CLI   0(RE),X'C3'         - MATCH ON ELEMENT CODE                      
         BE    PTRNCTFD                                                         
*                                                                               
PTRNCTCN DS    0H                                                               
*                                                                               
         IC    RF,1(RE)            GET ELEMENT LENGTH                           
         AR    RE,RF               BUMP TO NEXT ELEMENT                         
         B     PTRNCTLP            GO FIND NEXT ELEMENT                         
*                                                                               
PTRNCTDN DS    0H                  NO PERSON ID FOUND                           
*                                                                               
         B     PTRNNOTF                                                         
*                                                                               
PTRNCTFD DS    0H                                                               
*                                                                               
*        FIND PERSON RECORD                                                     
*                                                                               
         LA    R7,KEY                                                           
         USING SAPEREC,R7          ESTABLISH KEY AS PERSON REC KEY              
         XC    SAPEKEY,SAPEKEY     INIT KEY                                     
*                                                                               
         MVI   SAPETYP,SAPETYPQ    SET RECORD TYPE                              
         MVI   SAPESUB,SAPESUBQ    SET RECORD SUB TYPE                          
*                                                                               
         MVC   SAPEAGY,8(R5)       SET SECURITY AGENCY                          
*                                                                               
         CLC   SAPEAGY,=CL2' '     IF SECURITY AGENCY NOT PRESENT               
         BH    *+10                                                             
         MVC   SAPEAGY,PBAGY          USE REPORT'S AGENCY                       
*                                                                               
         MVC   SAPEPID,2(RE)       SET USERID FROM PREVIOUS RECORD              
*                                                                               
         MVC   FILENAME,=CL8'CTFILE'    SET FILENAME                            
         MVC   AIO,AIO2                 READ RECORD INTO IOA2                   
         MVI   USEIO,C'Y'               READ INTO I/O AREA                      
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         XC    FILENAME,FILENAME   RESET FILE NAME                              
         MVI   USEIO,0             RESET SWITCH                                 
*                                                                               
         L     R7,AIO2             POINT TO FOUND RECORD                        
*                                                                               
         CLC   SAPEKEY(SAPEDEF-SAPEKEY),KEYSAVE SKIP IF REC NOT FOUND           
         BNE   PTRNNOTF                                                         
*                                                                               
         LA    RE,SAPEDATA         POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
*        FIND NAME ELEMENT                                                      
*                                                                               
PTRNNMLP DS    0H                                                               
*                                                                               
         CLI   0(RE),0             CHECK FOR END OF RECORD                      
         BE    PTRNNMDN                                                         
*                                                                               
         USING SANAMD,RE           ESTABLISH AS NAME ELEMENT                    
*                                                                               
         CLI   SANAMEL,SANAMELQ    LOOKING FOR NAME ELEMENT                     
         BE    PTRNNMFD                                                         
*                                                                               
PTRNNMCN DS    0H                                                               
*                                                                               
         IC    RF,SANAMLN          GET ELEMENT LENGTH                           
         AR    RE,RF               BUMP TO NEXT ELEMENT                         
         B     PTRNNMLP            GO PROCESS NEXT ELEMENT                      
*                                                                               
PTRNNMDN DS    0H                  NAME ELEMENOT FOUND                          
*                                                                               
         B     PTRNNOTF                                                         
*                                                                               
PTRNNMFD DS    0H                                                               
*                                                                               
         SR    R0,R0               GET ELEMENT LENGTH                           
         IC    R0,SANAMLN                                                       
         AHI   R0,-SANAMLNQ        DECRMENT BY FIXED LENGTH                     
         BNP   PTRNNOTF            NO NAME IN ELEMENT                           
*                                                                               
         LA    RE,SANAMES          POINT TO START OF PERSON'S NAME              
         SR    RF,RF                                                            
         LR    R1,R3               COPY START OF OUTPUT                         
*                                                                               
PTRNFMLP DS    0H                  FORMAT PERSON'S NAME                         
*                                                                               
         USING SANAMES,RE          ESTABLISH NAMES SECTION                      
*                                                                               
         IC    RF,SANAMELN         GET LENGTH OF THIS PART OF NAME              
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),SANAME      MOVE OUT PART OF NAME                        
*                                                                               
         LA    R1,1(RF,R1)         BUMP TO NEXT OUTPUT AREA                     
*                                                                               
PTRNFMCN DS    0H                                                               
*                                                                               
         SR    R0,RF               DECREMENT REMAINING ELEMENT LENGTH           
         AHI   R0,-2               FOR NAME LENGTH BYTE & EX LENGTH             
         BNP   PTRNFMDN              END OF ELEMENT REACHED                     
*                                                                               
         LA    RE,2(RF,RE)         POINT TO NEXT PART OF NAME                   
         LA    R1,1(R1)            ADD IN A SPACING CHARACTER                   
*                                                                               
         B     PTRNFMLP                                                         
*                                                                               
PTRNFMDN DS    0H                                                               
*                                                                               
         B     PTRNSQSH                                                         
*                                                                               
PTRNNOTF DS    0H                  PRINT 'UNKNOWN' IF NO PID                    
*                                                                               
         MVC   0(7,R3),=C'UNKNOWN'                                              
*                                                                               
         B     PIDTRNX                                                          
*                                                                               
PTRNSQSH DS    0H                                                               
*                                                                               
         LR    R0,R1               END OF OUTPUT MINUS START                    
         SR    R0,R3               EQUALS OUTPUT LENGTH                         
*                                                                               
         GOTO1 SQUASHER,DMCB,0(R3),(R0) SQUASH NAME                             
*                                                                               
PIDTRNX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R7,RE                                                            
*                                                                               
         TITLE 'PRINT TIME AS HH:MM:SS - DISTIM'                                
***********************************************************************         
*                                                                     *         
*        DISPLAYS BINARY XL3 TIME AS HH:MM:SS                         *         
*                                                                     *         
*NTRY                                                                 *         
*       P0      A(BINARY TIME FIELD)                                  *         
*       P1      A(DISPLAY AREA)                                       *         
*                                                                     *         
*EXIT           TIME AS HH:MM:SS                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
DISTIM   NTR1   BASE=*,LABEL=*                                                  
*                                                                               
         L     R3,0(R1)            POINT TO TIME                                
         L     R4,4(R1)            POINT TO OUTPUT AREA                         
*                                                                               
         SR    RF,RF                                                            
*                                                                               
         IC    RF,0(R3)            GET HOURS                                    
         AHI   RF,6                BUMP BY SIX HOURS                            
*                                                                               
         CHI   RF,24               MUST BE LESS THAN 24                         
         BL    *+8                                                              
         SHI   RF,24                                                            
*                                                                               
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  0(2,R4),DUB                                                      
         MVI   2(R4),C':'                                                       
*                                                                               
         IC    RF,1(R3)            GET MINUTES                                  
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  3(2,R4),DUB                                                      
         MVI   5(R4),C':'                                                       
*                                                                               
         IC    RF,2(R3)            GET SECONDS                                  
         CVD   RF,DUB                                                           
         OI    DUB+7,X'0F'         FORCE SIGN                                   
         UNPK  6(2,R4),DUB                                                      
*                                                                               
DISTIMX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - BUY PREMIUM - INPUT - IPREM'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO EXTRACT BUY PREMIUM                               *         
*                                                                     *         
*NTRY    R2==>  DRIVER INPUT AREA                                     *         
*        GLARGS    C'B' - BUY RELATED FIELD                           *         
*                                                                     *         
*EXIT    0-10   -  DATA                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPREM    NMOD1 0,**#IPREM                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         LA    R7,PBLOCK           ESTABLISH PRNTBLOCK                          
         USING PBLOCK,R7                                                        
*                                                                               
         LA    R5,PPBYOUTC         PPBYOUT AREA                                 
         USING PPBYOUTD,R5         ESTABLISH PPBYOUT AREA                       
*                                                                               
         MVC   0(L'PBYOPRM,R2),PBYOPRM  PREMIUM FROM PPBYOUT OUTPUT             
*                                                                               
IPREMX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R7                                                            
*                                                                               
         TITLE 'PRWRITER - PRODUCT INTERFACE CODE - INPUT - IPRINCOD'           
***********************************************************************         
*                                                                     *         
*        ROUTINE TO EXTRACT PRODUCT INTERFACE CODE                    *         
*                                                                     *         
*NTRY    R2==>  DRIVER INPUT AREA                                     *         
*                                                                     *         
*EXIT    0-5    -  DATA                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPRINCOD NMOD1 0,**#IPCD                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         OC    PBACCTNO,PBACCTNO   IF NO INTERFACE CODE FOUND                   
         BNZ   *+12                                                             
         MVI   0(R2),255              FORCE TO SORT LAST                        
         B     IPRINCDX                                                         
*                                                                               
         CLI   PBACCTNO,255                                                     
         BE    IPRINCD1                                                         
*                                                                               
         MVC   0(4,R2),PBACCTNO                                                 
         B     IPRINCDX                                                         
*                                                                               
IPRINCD1 DS    0H                                                               
*                                                                               
         XC    DUB,DUB                                                          
*                                                                               
         MVC   DUB+1(3),PBACCTNO+1                                              
*                                                                               
         L     RF,DUB                                                           
         CVD   RF,DUB                                                           
         OI    DUB+7,15                                                         
         UNPK  0(5,R2),DUB+5(3)                                                 
*                                                                               
IPRINCDX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - PUB CLASS - INPUT - IPUBCLS'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO EXTRACT PUB PLASSIFICATION FROM PUB RECORD        *         
*                                                                     *         
*NTRY    GLARGS   = RECORD ID                                         *         
*                   C'P' - PUB      RECORD                            *         
*                                                                     *         
*        R2==>  DRIVER INPUT AREA                                     *         
*                                                                     *         
*EXIT   0-3    -  DATA                                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPUBCLS  NMOD1 0,**#IPBC                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R5,AIO3             POINT TO PUBRECORD                           
         USING PUBRECD,R5          ESTABLISH PUB RECORD                         
*                                                                               
         MVI   0(R2),X'FF'         FORCE NO ENTRY TO SORT LAST                  
*                                                                               
         CLI   PUBKCOD,PUBKIDQ     EXIT IF WRONG RECORD                         
         BNE   IPUBCLSX                IN AREA                                  
*                                                                               
         CLI   PUBKMED,C'N'        IF MEDIA 'N' NEED LITTLE RECORD              
         BNE   IPCNEWSN                                                         
*                                                                               
*        READ LTLREC - PUB SUPPLEMENTAL RECORD                                  
*          IT CONTAINS PRODUCTION SUPPLEMENTAL INFO                             
*                                                                               
IPCLTL   DS    0H                                                               
*                                                                               
         MVC   IPCAIOSV,AIO        SAVE ADDRESS OF AIO                          
         MVC   IPCFILSV,FILENAME   SAVE FILENAME                                
*                                                                               
         MVC   FILENAME,=CL8'PUBDIR' SET FILE NAME                              
*                                                                               
         LA    RE,IPCLTLRC         SET I/O AREA ADDRESS                         
         ST    RE,AIO              FORCE TO USE A DIFFERENT IO AREA             
*                                                                               
         LA    R6,KEY              ESTABLISH KEY WORKAREA AS LTLREC             
         USING LTLRECD,R6          CONTAINS SUPPLEMENTAL PUB INFO               
         XC    LTLKEY,LTLKEY       INIT KEY AREA                                
*                                                                               
         MVC   LTLKAGY,PUBKAGY     SET AGENCY                                   
         MVC   LTLKMED,PUBKMED     SET MEDIA                                    
         MVC   LTLKPUB,PUBKPUB     SET PUB                                      
         MVC   LTLKZON,PUBKZON     SET ZONE                                     
         MVC   LTLKED,PUBKED       SET EDITION                                  
         MVI   LTLKCOD,LTLKIDQ     SET RECORD ID                                
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   IPCLTL10                                                         
*                                                                               
         MVC   LTLKAGY,PAORAGY     SET FOR AOR AGENCY                           
         MVC   LTLKPUB(6),PAORPUB     SET FOR AOR PUB NUMBER                    
*                                                                               
         L     RF,PBUTLA           SET TO READ AOR FILES                        
         MVC   4(1,RF),PAORSE                                                   
*                                                                               
IPCLTL10 DS    0H                                                               
*                                                                               
         CLC   LTLKEY,IPCLTLRC     SKIP IF RECORD ALREADY IN CORE               
         BE    IPCLTL15                                                         
*                                                                               
         XC    IPCLTLRC(64),IPCLTLRC   INIT RECORD AREA                         
*                                                                               
         GOTO1 HIGH                READ LTLREC POINTER                          
*                                                                               
         CLC   LTLKEY,KEYSAVE      MUST HAVE EXACT MATCH                        
         BNE   IPCLTL15                                                         
*                                                                               
         MVC   FILENAME,=CL8'PUBFIL' SET FILE NAME                              
*                                                                               
         GOTO1 GETREC              READ LTLREC                                  
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
IPCLTL15 DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE CURRENT KEY                          
         OI    DMINBTS,8           PASS BACK DELETED RECORDS                    
         MVC   AIO,IPCAIOSV        RESTORE I/O AREA POINTER                     
         MVC   FILENAME,IPCFILSV   RESTORE FILE NAME                            
*                                                                               
         CLI   PBQADVSW,C'Y'       IF DOING ADVERTISER REPORT                   
         BNE   *+14                                                             
         L     RF,PBUTLA              RE-SET TO READ AGENCY FILES               
         MVC   4(1,RF),PAOSE                                                    
*                                                                               
         GOTO1 HIGH                                                             
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         LA    R5,IPCLTLRC         POINT TO FOUND RECORD                        
*                                                                               
IPCNEWSN DS    0H                                                               
*                                                                               
*        FIND NEEDED ELEMENT IN RECORD                                          
*                                                                               
         LA    R6,33(R5)           POINT TO FIRST ELEMENT                       
         SR    RF,RF                                                            
*                                                                               
IPBCLOOP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             EXIT IF ELEMENT NOT FOUND                    
         BE    IPBCLPDN                                                         
*                                                                               
         CLI   PUBKMED,C'N'        IF MEDIA IS NEWSPAPER                        
         BNE   IPBCLPNN                                                         
*                                                                               
         CLI   0(R6),PUBSPRQ          LOOK FOR SUPPLEMENTAL INFO ELM            
         BNE   IPBCLPCN                                                         
*                                       AND RETURN PUBCLASS                     
         MVC   0(L'PUBCLASS,R2),PUBCLASS-PUBSPREL(R6)                           
*                                                                               
         B     IPBCLPDN                                                         
*                                                                               
IPBCLPNN DS    0H                  ELSE                                         
*                                                                               
         CLI   0(R6),PUBGENQ          LOOK FOR GENERAL INFO ELM                 
         BNE   IPBCLPCN                                                         
*                                       AND RETURN PUBMCLASS                    
         MVC   0(L'PUBMCLAS,R2),PUBMCLAS-PUBGEND(R6)                            
*                                                                               
         B     IPBCLPDN                                                         
*                                                                               
IPBCLPCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            BUMP TO NEXT ELEMENT IN RECORD               
         LA    R6,0(RF,R6)                                                      
         B     IPBCLOOP                                                         
*                                                                               
IPBCLPDN DS    0H                                                               
*                                                                               
*                                                                               
IPUBCLSX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IPCKEYSV DS    XL(L'KEY)           CURRENT KEY         SAVEAREA                 
IPCAIOSV DS    A                   CURRENT A(I/O AREA) SAVEAREA                 
IPCFILSV DS    CL8                 CURRENT FILE NAME   SAVEAREA                 
IPCLTLRC DS    XL2000              LITTLE RECORD I/O AREA                       
*                                                                               
         DROP  R5                                                               
*                                                                               
         TITLE 'PRWRITER - REP - OUTPUT - OREP'                                 
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT REP DATA ON OUTPUT                          *         
*                                                                     *         
*NTRY   0-3    -  REP CODE UNLESS FOR NAME ONLY                       *         
*       4-13   -  1ST 10 BYTES OF NAME                                *         
*       14-17  -  RECORD DISK ADDRESS                                 *         
*       18     -  SPARE                                               *         
*       19     -  SE NUMBER FOR FILES IF DOING AOR REPORT             *         
*                                                                     *         
*       CLARGS    = C'P' - PAYING REP                                 *         
*       GLARGS+1  = C'I' - REP IDENTIFIER                             *         
*          GLARGS+2  = C'B' - REP CODE & NAME OR NAME & ADDRESS                 
*                      C'C' - REP CODE FOR REPS                                 
*                      C'A' - ADDRESS                                           
*       GLARGS+1  = C'W' - ATTENTION NAME                                       
*                   C'F' - FAX                                                  
*                   C'T' - TELEPHONE                                            
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OREP     NMOD1 0,**+OREP                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVI   PAOSESAV,0          INIT SE SAVEAREA                             
*                                                                               
         CLI   GLARGS+1,C'I'       IF NOT REP IDENTIFYING FIELD                 
         BNE   OREPREAD               GO READ REP RECORD                        
*                                                                               
*        FILL IN LABEL AREA BASED ON REP TYPE                                   
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREA                             
*                                                                               
         CLI   GLARGS,C'P'         PAY                                          
         BNE   *+10                                                             
         MVC   LABLAREA(7),=C'PAY REP'                                          
*                                                                               
         CLI   GLARGS,C'C'         CONTRACT                                     
         BNE   *+10                                                             
         MVC   LABLAREA(12),=C'CONTRACT REP'                                    
*                                                                               
         CLI   GLARGS,C'T'         TRAFFIC                                      
         BNE   *+10                                                             
         MVC   LABLAREA(11),=C'TRAFFIC REP'                                     
*                                                                               
*        NO REP NUMBER AVAILABLE                                                
*                                                                               
         OC    14(4,R2),14(R2)     OKAY IF DISK ADDRESS GIVEN                   
         BNZ   OREPNULN                                                         
*                                                                               
         CLI   0(R2),0          IF  MISSING REP                                 
         BNE   OREPNULN                                                         
*                                                                               
         CLI   GLARGS,C'P'      AND DOING PAY REP                               
         BNE   OREPNULX                                                         
*                                                                               
         CLI   4(R2),0              SKIP IF NO ENTRY PASSED                     
         BE    OREPNULN                                                         
*                                                                               
         MVC   CODEAREA(4),=C'****'  DISPLAY MESSAGE                            
*                                                                               
         CLI   GLARGS+2,C'N'       IF NAME ONLY                                 
         BNE   *+10                                                             
         MVC   CODEAREA(4),SPACES    CLEAR REP CODE                             
*                                                                               
         CLI   GLARGS+2,C'C'       IF NOT CODE ONLY                             
         BE    *+10                                                             
         MVC   NAMEAREA(12),=C'** DIRECT **'  FILL IN DEFAULT NAME              
*                                                                               
OREPNULX DS    0H                                                               
*                                                                               
         B     OREPY               EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
OREPNULN DS    0H                                                               
*                                                                               
         CLI   GLARGS+2,C'C'       IF REP CODE ONLY ASKED FOR                   
         BNE   OREPRCDN                                                         
*                                                                               
         MVC   CODEAREA(4),0(R2)   PRINT IT                                     
*                                                                               
         B     OREPY               EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
OREPRCDN DS    0H                                                               
*                                                                               
*        READ RECORD USING DISK ADDRESS                                         
*                                                                               
OREPREAD DS    0H                                                               
*                                                                               
         OC    14(4,R2),14(R2)                                                  
         BZ    OREPX               EXIT IF NO ADDRESS PASSED                    
*                                                                               
         MVC   AIO,AIO3            USE I/O AREA 3 FOR REPREC                    
*                                                                               
         MVC   KEY+27(4),14(R2)    SET DISK ADDRESS                             
*                                                                               
         CLI   19(R2),0            IF SE NUMBER PASSED                          
         BE    *+8                                                              
         ICM   RF,15,PBUTLA        AND UTL ADDRESS KNOWN                        
         BZ    *+16                                                             
         MVC   PAOSESAV,4(RF)      SAVE SE NUMBER                               
         MVC   4(1,RF),19(R2)      SET NEEDED SE NUMBER                         
*                                                                               
         MVI   ERROR,0             INIT EROR BYTE                               
         MVI   ERROPT,C'Y'         RETURN AFTER ERROR                           
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
*                                                                               
         CLI   PAOSESAV,0          IF SE NUMBER SAVED                           
         BE    *+14                                                             
         L     RF,PBUTLA                                                        
         MVC   4(1,RF),PAOSESAV    RESTORE IT                                   
*                                                                               
         CLI   ERROR,0             EXIT ON ERRORS                               
         BNE   OREPX                                                            
*                                                                               
         L     R4,AIO              POINT TO RECORD                              
         USING PREPRECD,R4         ESTABLISH REP RECORD                         
*                                                                               
         CLI   GLARGS+1,C'I'       SKIP IF NOT REP IDENTIFIER                   
         BNE   OREPIDN                                                          
*                                                                               
         CLI   GLARGS+2,C'N'       SKIP IF NAME ONLY WANTED                     
         BE    *+10                                                             
         MVC   CODEAREA(4),PREPKREP PUT OUT REP NUMBER                          
*                                                                               
         MVC   NAMEAREA(30),PREPNAME PUT OUT REP NAME                           
*                                                                               
         B     OREPY               EXIT THRU GENERAL OUTPUT ROUTINE             
*                                                                               
OREPIDN  DS    0H                                                               
*                                                                               
*        ADDRESS                                                                
*                                                                               
OREPADR  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'A'       SKIP IF NOT ADDRESS                          
         BNE   OREPADRN                                                         
*                                                                               
         MVC   0(30,R3),PREPLIN1   ADDRESS                                      
         MVC   198(30,R3),PREPLIN2                                              
*                                                                               
OREPADRX DS    0H                                                               
*                                                                               
         B     OREPX               ALL DONE                                     
*                                                                               
OREPADRN DS    0H                                                               
*                                                                               
*        FAX NUMBER                                                             
*                                                                               
OREPFAX  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'F'       PROCESS FAX                                  
         BNE   OREPFAXN                                                         
*                                                                               
         CLI   PREPELEM+1,PREPFAX-PREPELEM AND FAX IN ELM                       
         BL    *+10                                                             
         MVC   0(L'PREPFAX,R3),PREPFAX  PRINT FAX #                             
*                                                                               
         B     OREPX                                                            
*                                                                               
OREPFAXN DS    0H                                                               
*                                                                               
*        TELEPHONE NUMBER                                                       
*                                                                               
OREPTEL  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'T'       PROCESS TEL                                  
         BNE   OREPTELN                                                         
*                                                                               
         MVC   0(L'PREPTEL,R3),PREPTEL  PRINT TEL #                             
         B     OREPTELX                                                         
*                                                                               
*                                                                               
OREPTELX DS    0H                                                               
*                                                                               
         B     OREPX                                                            
*                                                                               
OREPTELN DS    0H                                                               
*                                                                               
*        ATTENTION NAME                                                         
*                                                                               
OREPATN  DS    0H                                                               
*                                                                               
         CLI   GLARGS+1,C'W'       PROCESS ATTENTION NAME (WHO)                 
         BNE   OREPATNN                                                         
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,MYOLEN         GET OUTPUT LENGTH                            
         BZ    *+6                   NO LENGTH                                  
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),PREPATTN    MOVE OUT ATTENTION NAME                      
*                                                                               
OREPATNX DS    0H                                                               
*                                                                               
         B     OREPX                                                            
*                                                                               
OREPATNN DS    0H                                                               
*                                                                               
OREPY    DS    0H                                                               
         LTR   RB,RB               ^= CC MEANS  GENERAL OUTPUT ROUTINE          
         XIT1                                                                   
*                                                                               
OREPX    DS    0H                                                               
         CR    RB,RB               NORMAL EXIT                                  
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'OUTDOOR SIZE, REG, ILLUM - IOUTDOOR'                            
***********************************************************************         
*                                                                     *         
*        FOR OUTDOOR SIZE, REG & ILLUM                                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
IOUTDOOR NMOD1 0,**#IODR                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         ZAP   0(8,R2),=P'0'       INIT DRIVER INPUT               L17          
*                                                                               
         USING PBUYRECD,R4         ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBDSPACE,255        SKIP IF WE DON'T HAVE 3         L17          
         BNE   IOUTDOR9               PACKED FIELDS                L17          
*                                                                               
         CLI   GLARGS+1,C'S'         SHOW REQUESTED                L17          
         BNE   *+14                                                L17          
         ZAP   0(8,R2),PBDSHOW                                     L17          
         B     IOUTDOR9                                            L17          
*                                                                               
         CLI   GLARGS+1,C'R'         REG  REQUESTED                L17          
         BNE   *+14                                                L17          
         ZAP   0(8,R2),PBDREG                                      L17          
         B     IOUTDOR9                                            L17          
*                                                                               
         CLI   GLARGS+1,C'I'         ILLUM                         L17          
         BNE   *+14                                                L17          
         ZAP   0(8,R2),PBDILLUM                                    L17          
         B     IOUTDOR9                                            L17          
*                                                                               
         CLI   GLARGS+1,C'P'         POSTER                        L17          
         BNE   *+20                                                L17          
         ZAP   0(8,R2),PBDILLUM    START WITH ILLUMINATED          L17          
         AP    0(8,R2),PBDREG      ADD IN REGULAR                               
         B     IOUTDOR9                                            L17          
*                                                                               
         B     IOUTDORX            UNKNOWN TYPE                                 
*                                                                               
IOUTDOR9 DS    0H                                                               
*                                                                               
         GOTO1 =V(DOFLOW)                                                       
*                                                                               
IOUTDORX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         DROP  R4                                                               
*                                                                               
         TITLE 'PROCESS OUTDOOR SPACE 2ND LINE ON INPUT SIDE - IOUTSPC'         
***********************************************************************         
*                                                                     *         
*        OUTDOOR SPACE DESCRIPTION - SECOND LINE                      *         
*              FOUND IN FIRST COMMENT LINE                            *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
IOUTSPC  NMOD1 0,**#IOSPC                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L      R4,AIO1            ESTABLISH BUY RECORD                         
         USING  PBUYRECD,R4                                                     
*                                                                               
         LA    R6,PBDELEM          POINT TO FIRST ELEMENT IN RECORD             
         SR    R0,R0                                                            
*                                                                               
*        FIND FIRST COMMENT ELEMENT                                             
*                                                                               
         CLI   0(R6),0             END OF RECORD                                
         BE    IOUTSPCX            SKIP PASSING ANYTHING TO SORT                
         CLI   0(R6),X'66'         CHECK FOR COMMENT ELEMENT                    
         BE    *+14                                                             
         IC    R0,1(R6)            BUMP TO NEXT ELEMENT                         
         AR    R6,R0                                                            
         B     *-22                                                             
*                                                                               
         CLI   1(R6),19                                                         
         BH    IOUTSPCX                 TOO LONG                                
*                                                                               
         ZIC   RF,1(R6)            ELEMENT LENGTH                               
         SH    RF,=H'2'            COMMENT EXECUTE LENGTH                       
*                                                                               
         L     R1,GLADTENT         ESTABLISH INPUT DRIVER ENTRY                 
         USING DRIND,R1                                                         
*                                                                               
         ZIC   R3,DRINLEN          GET INPUT LENGTH                             
*                                                                               
         CR    RF,R3               USE SHORTER LENGTH                           
         BNH   *+6                                                              
         LR    RF,R3                                                            
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),2(R6)       PASS COMMENT TO DRIVER                       
*                                                                               
*                                                                               
IOUTSPCX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R1,R4                                                            
*                                                                               
*                                                                               
         TITLE 'PRWRITER - BUILD LABEL AREA - IPUBLSHR'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FORMAT PUBLISHER ENTRY                            *         
*                                                                     *         
*NTRY    PBPBLSHA     A(PUBLISHER RECORD)                                       
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPUBLSHR NMOD1 0,**#IPBLS                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         ICM   RF,15,PBPBLSHA      POINT TO PUBLISHER RECORD                    
         BZ    IPUBLSHX            SKIP IF NONE AVAILABLE                       
*                                                                               
         USING PREPRECD,RF         ESTABLISH PUBLISHER RECORD                   
*                                                                               
         OC    0(15,RF),0(RF)      IF NONE AVAILAVLE                            
         BNZ   IPBL10                                                           
*                                                                               
         MVI   0(R2),255               FORCE NO PUBLISHERS TO BOTTOM            
         MVC   4(16,R2),=C'** UNASSIGNED **'                                    
         MVC   34(3,R2),=C'N/A'                                                 
         B     IPUBLSHX                                                         
*                                                                               
IPBL10   DS    0H                                                               
*                                                                               
         MVC   4(30,R2),PREPNAME   PASS NAME                                    
         MVC   34(4,R2),PREPKREP   PASS CODE                                    
*                                                                               
         CLI   GLARGS,C'S'     IF SORTING ON PUBLISHER NUMBER                   
         BNE   *+10                                                             
         MVC   0(4,R2),PREPKREP       PUT CODE AT START OF OUTPUT               
*                                                                               
IPUBLSHX DS    0H                                                               
*                                                                               
         OC    0(38,R2),SPACES     FORCE UPPERCASE                              
*                                                                               
         XIT1                                                                   
*                                                                               
         DROP  RF                                                               
*                                                                               
         TITLE 'PRWRITER - PRODUCT NAME AND CODE - IPRODAN'                     
***********************************************************************         
*                                                                     *         
*        ROUTINE TO BUILD PRODUCT NAME AND CODE  - INPUT TO SORT      *         
*                                                                     *         
*EXIT    R2 ==> 0-2  - PRODUCT CODE IF SORTING BY CODE                *         
*               3-22 - PRODUCT NAME                                   *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IPRODAN  NMOD1 0,**#IPRD                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        ESTIMATE DROPS PRODUCT FROM ITS ENTRY IF PRODUCT NOT HIGHER            
*        IN KEY. LOGIC FOR DETERMINING IF PRD IN KEY IS IN VALROWS.             
*        DPG PROGRAMS MAY NOT USE THIS LOGIC. IF NO LEVELS SET                  
*        FORCE PRODUCT IN KEY INDICATOR.                                        
*                                                                               
         OC    LEVELTYP,LEVELTYP   IF NO TYPES STORED YET                       
         BNZ   *+8                                                              
         MVI   LEVELTYP,X'08'      INDICATE PRODUCT IN KEY                      
*                                                                               
******   CLI   PBMODE,PBPROCIV     SKIP IF PROCESSING INVOICES                  
******   BE    *+10                                                             
         MVC   3(20,R2),PBPRDNM     PRODUCT NAME                                
*                                                                               
         CLI   GLARGS+1,C'N'        DONE IF NAME ONLY                           
         BE    IPRODANX                                                         
*                                                                               
         CLI   PBMODE,PBPROCNV     IF PROCESSING NEW INVOICES                   
         BNE   IPRODNVN                                                         
*                                                                               
         ICM   R6,15,PBIDTELA      ESTABLISH DETAIL ELEMENT                     
         BZ    IPROD90                NONE AVAILABLE                            
         USING PNVDTLD,R6          ESTABLISH DETAIL ELEMENT                     
*                                                                               
         MVC   0(3,R2),PNVDPRD     RETURN PRODUCT CODE                          
*                                                                               
         CLC   0(3,R2),SPACES      DONE IF WE HAVE A PRODUCT CODE               
         BH    IPROD90                                                          
*                                                                               
         ICM   R6,15,PBIHDELA      ESTABLISH HEADER ELEMENT                     
         BZ    IPROD90                 NONE AVAILABLE                           
         USING PNVHDRD,R6                                                       
*                                                                               
         MVC   0(3,R2),PNVHPRD     RETURN PRODUCT CODE                          
*                                                                               
         B     IPROD90                                                          
*                                                                               
IPRODNVN DS    0H                                                               
*                                                                               
         CLI   PBMODE,PBPROCIV     IF PROCESSING INVOICES                       
         BNE   IPRODIVN                                                         
*                                                                               
         ICM   R6,15,PBIDTELA      ESTABLISH KEY                                
         BZ    IPROD90                NONE AVAILABLE                            
         USING PIMDTLEL,R6          ESTABLISH OLD DETAIL ELEMENT                
*                                                                               
         MVC   0(3,R2),PIMSPRD     RETURN PRODUCT CODE                          
*                                                                               
         CLC   0(3,R2),SPACES      DONE IF WE HAVE A PRODUCT CODE               
         BH    IPROD90                                                          
*                                                                               
         ICM   R6,15,PBIKYELA      ESTABLISH KEY                                
         BZ    IPROD90                 NONE AVAILABLE                           
         USING PINVKEYD,R6                                                      
*                                                                               
         MVC   0(3,R2),PINVPRD     RETURN PRODUCT CODE                          
*                                                                               
IPROD90  DS    0H                                                               
*                                                                               
         B     IPRODANX                                                         
*                                                                               
IPRODIVN DS    0H                                                               
*                                                                               
         MVC   0(3,R2),PBPROD                                                   
*                                                                               
IPRODANX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - REFERENCE NUMBER - INPUT - IREF'                     
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FIND COMMENT ELEMENT STARTING WITH REF=           *         
*                                                                     *         
*                                                                     *         
*EXIT   0-9    -  REFENCE NUMBER                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IREF     NMOD1 0,**#IREF                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R4                                                      
*                                                                               
         LA    R6,33(R6)           POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                                                               
IREFLOOP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             SKIP IF EOR REACHED                          
         BE    IREFDONE                                                         
*                                                                               
         CLI   0(R6),PCOMELQ       LOOKING FOR COMMENT ELEMENT                  
         BNE   IREFCONT                                                         
*                                                                               
         CLI   1(R6),6             MUST HAVE LENGTH AT LEAST 6                  
         BL    IREFCONT                                                         
*                                                                               
         CLC   =C'REF=',2(R6)      LOOKING FOR 'REF=' INTRO                     
         BE    IREFFND                                                          
*                                                                               
IREFCONT DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT IN RECORD               
         B     IREFLOOP                                                         
*                                                                               
IREFDONE DS    0H                                                               
         B     IREFX                                                            
*                                                                               
IREFFND  DS    0H                  REFERENCE NUMBER FOUND                       
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         SH    RF,=H'6'            DECREMENT BY REF= & ID & LENGTH              
         BZ    IREFFNDX            NO REFERENCE ENTERED                         
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),6(R6)       PASS REFERENCE TO SORT                       
*                                                                               
IREFFNDX DS    0H                  REFERENCE NUMBER FOUND                       
*                                                                               
         B     IREFX                                                            
*                                                                               
IREFX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R6                                                            
*                                                                               
         TITLE 'PRWRITER - SHIPPING ELM FIELDS - ISHP'                          
***********************************************************************         
*                                                                     *         
*        SHIPPING ELEMENT FIELDS                                      *         
*          SAME AS IELM EXCEPT MUST FIND ELEMENT WITH LATEST DATE     *         
*          LOGIC IS FIND ELEMENT AND THEN GO TO IELMM                 *         
*          TO MAKE IELM WORK ALL OTHER SHIP ELMS HAVE ID SET TO X'FF' *         
*                                                                     *         
*NTRY  - SEE IELM                                                     *         
*                                                                     *         
*EXIT  - SEE IELM                                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ISHP     NMOD1 0,**#ISHP                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R4                                                      
*                                                                               
         LA    R6,PBUYREC+33       POINT TO FIRST ELEMENT                       
         SR    R0,R0               ELEMENT POINTER SAVEAREA                     
         SR    RF,RF                                                            
*                                                                               
ISHPLOOP DS    0H                                                               
*                                                                               
         USING PSHIPELD,R6         ESTABLISH AS SHIPPING ELEMENT                
*                                                                               
         CLI   PSHIPEL,0           CHECK FOR END OF RECORD                      
         BE    ISHPDONE                                                         
*                                                                               
         CLI   PSHIPEL,PSHIPELQ    LOOK FOR SHIPPING ELEMENT                    
         BNE   ISHPCONT                                                         
*                                                                               
         LR    R0,R6               SAVE ELEMENT ADDRESS                         
*                                                                               
         MVI   PSHIPEL,X'FF'       KILL ELEMENT ID                              
*                                                                               
ISHPCONT DS    0H                                                               
*                                                                               
         IC    RF,PSHIPEL+1        BUMP TO NEXT ELEMENT                         
         LA    R6,PSHIPEL(RF)                                                   
         B     ISHPLOOP                                                         
*                                                                               
ISHPDONE DS    0H                                                               
*                                                                               
         LTR   R6,R0               POINT TO LAST FOUND ELEMENT                  
         BZ    ISHPX                 IGNORE IF NONE FOUND                       
*                                                                               
         MVI   PSHIPEL,PSHIPELQ    RESTORE ELEMENT ID                           
*                                                                               
         GOTO1 =V(IELM)            GET DATA VIA IELM                            
*                                                                               
ISHPX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R6                                                            
*                                                                               
         TITLE 'PRWRITER - SUBMEDIA KEYWORDS - ISMED'                           
***********************************************************************         
*                                                                     *         
*        SUBMEDIA CODE                                                *         
*          FIND APPROPRIATE PUB PAY ELEMENT                           *         
*            ELEMENTS STORED FOR CLIEN, OFFICE AND AGENCY             *         
*          EXTRACT CODE FROM ELEMENT                                  *         
*          FIND NAME IN TABLE IF NEEDED                               *         
*                                                                     *         
*NTRY  - GLARGS      C'H'   - HEADER TYPE OF DATA                     *         
*         GLARGS+1    X'06' - HEADER DATA TYPE                        *         
*          GLARGS+2    C    - OUTPUT TYPE                             *         
*                             'B' - CODE AND NAME                     *         
*                             'C' - CODE ONLY                         *         
*                             'N' - NAME ONLY                         *         
*                                                                     *         
*EXIT  - CODE AND/OR NAME                                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ISMED    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO3             ESTABLISH PUB RECORD                         
         USING PUBRECD,R4                                                       
*                                                                               
         LA    R6,PUBREC+33        POINT TO FIRST ELEMENT                       
         SR    R0,R0               ELEMENT POINTER SAVEAREA                     
         SR    RF,RF                                                            
*                                                                               
ISMDLOOP DS    0H                                                               
*                                                                               
         USING PUBPAYEL,R6         ESTABLISH AS PUB PAY ELEMENT                 
*                                                                               
         CLI   PUBPAYEL,0          CHECK FOR END OF RECORD                      
         BE    ISMDDONE                                                         
*                                                                               
         CLI   PUBPAYEL,PUBPYELQ   LOOK FOR PUB PAY ELEMENT                     
         BNE   ISMDCONT                                                         
*                                                                               
         CLC   PUBPYOFF,PBCLT      MATCH TO CLIENT                              
         BNE   ISMDLP10                                                         
*                                                                               
         LR    R0,R6                  SAVE ELEMENT ADDRESS                      
         B     ISMDDONE               USE THIS ELEMENT                          
*                                                                               
ISMDLP10 DS    0H                                                               
*                                                                               
         CLI   PUBPYOFF,X'FF'      SKIP IF NOT OFFICE OR AGENCY                 
         BNE   ISMDCONT                                                         
*                                                                               
         CLC   PBCOFF(1),PUBPYOFF+1   IF OFFICE CODE MATCHES                    
         BNE   ISMDLP20                                                         
*                                                                               
         LR    R0,R6                  SAVE ELEMENT POINTER                      
         B     ISMDCONT                                                         
*                                                                               
ISMDLP20 DS    0H                                                               
*                                                                               
         CLC   PUBPYOFF,=X'FFFFFF' SKIP IF NOT AGENCY ELEMENT                   
         BNE   ISMDCONT                                                         
*                                                                               
         LTR   R0,R0               SKIP IF BETTER ELM FOUND ALREADY             
         BNZ   ISMDCONT                                                         
*                                                                               
         LR    R0,R6                  SAVE ELEMENT POINTER                      
*                                                                               
ISMDCONT DS    0H                                                               
*                                                                               
         IC    RF,PUBPYELN         BUMP TO NEXT ELEMENT                         
         LA    R6,PUBPAYEL(RF)                                                  
         B     ISMDLOOP                                                         
*                                                                               
ISMDDONE DS    0H                                                               
*                                                                               
         LTR   R6,R0               POINT TO LAST FOUND ELEMENT                  
         BZ    ISMEDX                 IGNORE IF NONE FOUND                      
*                                                                               
         CLI   PUBPYSMD,0          SKIP IF NO SUBMEDIA FOUND                    
         BE    ISMEDX                                                           
*                                                                               
         CLI   GLARGS+3,C'N'       SKIP IF NAME ONLY WANTED                     
         BE    *+10                                                             
         MVC   0(1,R2),PUBPYSMD    RETURN SUB MEDIA CODE                        
*                                                                               
         CLI   GLARGS+3,C'C'       DONE IF ONLY CODE WANTED                     
         BE    ISMEDX                                                           
*                                                                               
*        FIND SUB MEDIA IN TABLE                                                
*                                                                               
         CLC   SMDTMED,PBMED       ON CHANGE IN MEDIA                           
         BE    ISMEDX                                                           
*                                                                               
         LA    R3,SMDTBLE          RESET BXLE REGISTERS SAVEAREA                
         ST    R3,SMDTSTRT         A(TABLE START)                               
         BCTR  R3,0                                                             
         ST    R3,SMDTEND          A(TABLE END)                                 
         LA    R3,SMDTLNG          ENTRY LENGTH                                 
         ST    R3,SMDTLEN                                                       
*                                                                               
         DROP  R4                                                               
*                                                                               
ISMDAGYX DS    0H                                                               
*                                                                               
*        SEARCH TABLE FOR SUBMEDIA ENTRY BASED ON CODE                          
*                                                                               
         LM    R3,R5,SMDTBXLE      LOAD BXLE REGISTERS                          
*                                                                               
         CR    R3,R5               SKIP IF TABLE EMPTY                          
         BH    ISMDSRCD                                                         
*                                                                               
         USING SMDTENT,R3          ESTABLISH TABLE ENTRY                        
*                                                                               
ISMDSRCL DS    0H                                                               
*                                                                               
         CLC   SMDTSMD,PUBPYSMD    MATCH ON SUBMEDIA CODE                       
         BE    ISMDSRCF                                                         
*                                                                               
ISMDSRCC DS    0H                                                               
         BXLE  R3,R4,ISMDSRCL      BUMP TO NEXT ENTRY                           
*                                                                               
ISMDSRCD DS    0H                  NOT FOUND IN TABLE                           
*                                                                               
         SR    R3,R3               INIT TABLE ENTRY POINTER                     
*                                                                               
*        READ SUBMEDIA RECORD INTO SMDREC                                       
*                                                                               
ISMDKEY  DS    0H                  BUILD KEY FOR SUB MEDIA REC                  
*                                                                               
         XC    KEY,KEY                                                          
         LA    R4,KEY              ESTABLISH SUBMEDIA RECORD KEY                
         USING PSUBMEDD,R4                                                      
*                                                                               
         MVC   PSMDKAGY,PBAGY      SET AGENCY                                   
         MVC   PSMDKMED,PBMED      SET MEDIA                                    
         MVI   PSMDKRCD,PSMDKR1Q   SET FIRST  RECORD ID                         
         MVI   PSMDKRC2,PSMDKR2Q   SET SECOND RECORD ID                         
         MVC   PSMDKSMD,PUBPYSMD   SET SUBMEDIA CODE                            
*                                                                               
ISMDREC  DS    0H                  READ SUBMEDIA RECORD                         
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   PSMDKEY,KEYSAVE     SKIP IF RECORD NOT FOUND                     
         BNE   ISMDRECX                                                         
*                                                                               
         ICM   R0,15,AIO           SAVE CURRENT IOAREA                          
*                                                                               
         LA    RF,SMDREC           SET I/O AREA ADDRESS                         
         ST    RF,AIO                                                           
*                                                                               
         GOTO1 GETREC              READ IN RECORD                               
         BE    *+10                IF NOT ON FILE                               
         XC    SMDREC(256),SMDREC     CLEAR I/OAREA                             
*                                                                               
         STCM  R0,15,AIO           RESTORE CURRENT AIO                          
*                                                                               
ISMDRECX DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE LAST KEY READ                        
         OI    DMINBTS,8           PASS BACK DELETED RECORDS                    
*                                                                               
         GOTO1 HIGH                RESET FILE POINTERS                          
*                                                                               
         LA    R4,SMDREC           POINT TO FOUND RECORD                        
         USING PSUBMEDD,R4         ESTABLISH SUBMEDIA RECORD                    
*                                                                               
         LA    R6,PSMDFRST         POINT TO FIRST ELEMENT IN RECORD             
         USING PSMDELEM,R6         ESTABLISH SUBMEDIA ELEMENT                   
*                                                                               
         CLI   PSMDELCD,PSMDELCQ   DONE IF NOT DESCRIPTION ELEMENT              
         BNE   ISMEDX                                                           
*                                                                               
         LR    R3,R5               POINT TO NEXT AVAILABLE ENTRY IN TBL         
         AHI   R3,1                                                             
*                                                                               
         USING SMDTENT,R3          ESTABLISH ELEMENT IN TABLE                   
*                                                                               
         MVC   SMDTSMD,PSMDKSMD    SAVE SUBMEDIA CODE                           
         MVC   SMDTNAME,PSMDDESC   SAVE SUBMEDIA DESCRIPTION                    
*                                                                               
         LA    R5,SMDTLNG-1(R3)    POINT TO NEW END OF TABLE                    
         ST    R5,SMDTEND          RESET BXLE END                               
*                                                                               
ISMDSRCF DS    0H                  HAVE ENTRY IN TABLE                          
*                                                                               
         MVC   2(L'SMDTNAME,R2),SMDTNAME RETURN SUBMEDIA NAME                   
*                                                                               
ISMEDX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
SMDREC   DS    XL1000              IOAREA FOR SUBMEDIA RECORD                   
*                                                                               
SMDTBXLE DS    0F                  BXLE REGISTERS FOR SUB MEDIA TABLE           
SMDTSTRT DS    A                   START OF TABLE                               
SMDTLEN  DS    AL4(SMDTLNG)        TABLE ENTRY LENGTH                           
SMDTEND  DS    A                   END OF TABLE                                 
*                                                                               
SMDTMED  DS    CL2                 MEDIA FOR TABLE                              
*                                                                               
SMDTBLE  DS    0F                  SUBMEDIA TABLE                               
*                                                                               
SMDTENT  DS    0X                  ENTRY IN TABLE                               
SMDTSMD  DS    XL(L'PSMDKSMD)      SUBMEDIA CODE                                
SMDTNAME DS    CL(L'PSMDDESC)      SUBMEDIA DESCRIPTION)                        
SMDTLNG  EQU   *-SMDTENT           LENGTH OF TABLE ENTRY                        
*                                                                               
         DS    XL(39*SMDTLNG)       REST OF ENTRIES IN TABLE                    
*                                                                               
         DROP  R3,R4,R6                                                         
*                                                                               
         TITLE 'PRWRITER - OUTPUT SUB MEDIA'                                    
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT SUBMEDIA KEYWORDS                           *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
*        GLARGS   -  C'B' - BOTH CODE AND DESCITION                   *         
*                    C'C' - CODE ONLY                                 *         
*                    C'N' - NAME ONLY                                 *         
*                                                                     *         
*        R3==>  DRIVER PRINT AREA                                     *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OSMED    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        BUILD LABEL AREA FOR TOTALS AND HEADLINES                              
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREAS                            
         MVC   CODEAREA,SPACES                                                  
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OSMDLBLX                                                         
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL AREA                             
*                                                                               
OSMDLBLX DS    0H                                                               
*                                                                               
         CLI   GLARGS,C'N'         SKIP IF NAME ONLY                            
         BE    *+10                                                             
         MVC   CODEAREA(1),0(R2)   PRINT CODE                                   
*                                                                               
         CLI   GLARGS,C'C'         SKIP IF CODE ONLY                            
         BE    *+10                                                             
         MVC   NAMEAREA(20),2(R2)                                               
*                                                                               
OSMEDX   DS    0H                                                               
         GOTO1 GENOUTA                                                          
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - BUY PREMIUM - INPUT - IPREM'                         
***********************************************************************         
*                                                                     *         
*        ROUTINE TO EXTRACT SOURCE OF BUY                             *         
*                                                                     *         
*NTRY    R2==>  DRIVER INPUT AREA                                     *         
*        GLARGS    C'B' - BUY RELATED FIELD                           *         
*                                                                     *         
*EXIT    0-10   -  DATA                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ISRC     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC                                                          
         USING PBLOCK,R7                                                        
*                                                                               
         L     R4,AIO1             POINT TO BUY                                 
         USING PBUYREC,R4          ESTABLISH BUY RECORD                         
*                                                                               
         CLI   PBUYKRCD,X'20'      SKIP IF NOT A BUY RECORD                     
         BNE   ISRCX                                                            
*                                                                               
         LA    R6,PBUYREC+33       POINT TO FIRST ELEMENT IN RECORD             
         USING PBDELEM,R6          ESTABLISH BUY DESCRIPTION ELM                
*                                                                               
ISRCLOOP DS    0H                                                               
*                                                                               
         USING PBDELEM,R6          ESTABLISH BUY DESCRIPTION ELM                
*                                                                               
         CLI   PBDELEM,X'00'       DONE AT END OF RECORD                        
         BE    ISRCDONE                                                         
*                                                                               
         CLI   PBDELEM,X'20'       SKIP IF NOT BUY DESCRIPTION ELM              
         BNE   ISRCLP10                                                         
*                                                                               
         TM    PBDSTAT2,X'80'      IF BUY ADDED BY ADBUYER                      
         BNO   *+14                                                             
         MVC   0(8,R2),=CL8'ADBUYER'    SET SOURCE                              
         B     ISRCX                                                            
*                                                                               
         TM    PBDSTAT2,X'20'      IF BUY ADDED BY IDESK                        
         BNO   ISRCCONT                                                         
         MVC   0(8,R2),=CL8'IDESK'      SET SOURCE                              
         B     ISRCCONT                                                         
*                                                                               
ISRCLP10 DS    0H                                                               
*                                                                               
         CLI   PBDELEM,X'CC'       IF CUSTOM COLUMN ELM                         
         BNE   ISRCLP40                                                         
*                                                                               
         USING BYCCELD,R6          ESTABLISH CUSTOM COLUMN ELM                  
*                                                                               
         CLC   =AL2(8215),BYCCSQN  AND IF CAMPAIGN ID                           
         BNE   ISRCCONT                                                         
*                                                                               
         CLI   GLARGS+1,C'1'       AND BUYSRC1                                  
         BNE   ISRCCONT                                                         
*                                                                               
         CLI   BYCCDATA,C'C'       AND ID STARTS WITH C'C'                      
         BNE   ISRCCONT                                                         
*                                                                               
         MVC   0(8,R2),=CL8'IDESK3'     SET SOURCE                              
*                                                                               
         B     ISRCX                                                            
*                                                                               
ISRCLP40 DS    0H                                                               
*                                                                               
         USING PBDELEM,R6          ESTABLISH BUY DESCRIPTION ELM                
*                                                                               
         CLI   PBDELEM,X'90'       IF PBU UPLOAD ELEMENT                        
         BNE   ISRCLP46                                                         
         CLC   0(8,R2),=CL8' '     Soure already set?                           
         BH    ISRCLP46                                                         
         MVC   0(8,R2),=CL8'PBU'   True PBU                                     
         B     ISRCCONT                                                         
*                                                                               
         USING PPIDELM,R6          Point to Personal ID element                 
ISRCLP46 CLI   PPIDELM,PPIDELQ                                                  
         JNE   ISRCCONT                                                         
         CLI   PPIDPRG,PPIDPRMQ    Added via Prisma?                            
         JNE   *+10                                                             
         MVC   0(8,R2),=CL8'PRISMA'     SET SOURCE                              
         CLI   PPIDPRG,PPIDRADQ    Added via Radia?                             
         JNE   *+10                                                             
         MVC   0(8,R2),=CL8'RADIA'      SET SOURCE                              
         DROP  R6                                                               
*                                                                               
ISRCCONT DS    0H                                                               
*                                                                               
         USING PBDELEM,R6          ESTABLISH BUY DESCRIPTION ELM                
         LLC   RF,PBDELEM+1        GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         POINT TO NEXT ELEMENT                        
         B     ISRCLOOP                                                         
*                                                                               
ISRCDONE DS    0H                  NONE OF ADBUYER,IDESK OR PBU                 
*                                                                               
         CLC   0(8,R2),=CL8' '     SKIP IF SOURCE KNOWN                         
         BH    *+10                                                             
         MVC   0(8,R2),=CL8'PRINTPAK'   DEFAULT TO PRINTPAK SOURCE              
*                                                                               
         B     ISRCX                                                            
*                                                                               
ISRCX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
***********************************************************************         
*                                                                     *         
*        Routint to extract Tearsheet Received                        *         
*                                                                     *         
*NTRY    R2==>  Drive input area                                      *         
*                                                                     *         
*EXIT    0-10   -  Data                                               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ITSR     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         L     R6,AIO1             Point to buy record                          
         LA    R6,33(R6)           First element in buy record                  
         USING PBDELEM,R6          Establish buy description element            
*                                                                               
         XC    0(11,R2),0(R2)      Init output                                  
         MVC   0(02,R2),=C'NO'     Default to no                                
         TM    PBDSTAT,X'10'       Tearsheet received?                          
         JNO   *+10                                                             
         MVC   0(03,R2),=C'YES'                                                 
*                                                                               
ITSRX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - SHIPPING ELM FIELDS - ITST1'                         
***********************************************************************         
*                                                                     *         
*        TESTING PPGETCON                                             *         
*                                                                     *         
*NTRY  -                                                              *         
*                                                                     *         
*EXIT  -                                                              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ITST1    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R4                                                      
*                                                                               
         LA    R5,GETCONC          ESTABLISH PPGETCON CONTROL BLOCK             
         USING GETCOND,R5                                                       
*                                                                               
         ST    R4,GCNBUYA          PASS A(BUYREC)                               
         MVC   GCNVUTL,PBUTLA      SET UTIL ADDRESS                             
         MVC   GCNCOMFA,PBCOMFAC   SET A COMFACS                                
         MVI   GCNGETCU,C'Y'       ASK FOR CU VALUES                            
         MVC   GCNCONA,AIO2        A(CONTRACT RECORD)                           
*                                                                               
         GOTO1 =V(PPGETCON),DMCB,GETCOND                                        
*                                                                               
         ZAP   0(8,R2),=P'0'       DEFAULT TO ZERO                              
*                                                                               
         CLC   =X'0000001',GCNCU   DONE IF FORCED ZERO                          
         BE    ITST1X                                                           
*                                                                               
         ZAP   0(8,R2),=P'1000'    DEFAULT TO 1.000                             
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,15,GCNCU         GET CU VALUE TO 4 DECS                       
         BZ    ITST1X              NO VALUE RETURNED                            
*                                                                               
         CVD   RF,DUB              CVD                                          
         SRP   DUB,64-1,5          ROUND TO 3 DECS                              
*                                                                               
         ZAP   0(8,R2),DUB         RETURN VALUE                                 
*                                                                               
ITST1X   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
GETCONC  DC    XL(GETCONLQ)'00'    PPGETCON CONTROL BLOCK                       
*                                                                               
         DROP  R4                                                               
*                                                                               
         TITLE 'PRWRITER - USER FIELDS - INPUT - IUCM'                          
***********************************************************************         
*                                                                     *         
*        USER DEFINED FIELDS FROM UCOMM RECORDS                       *         
*                                                                     *         
*NTRY  - COLUMN FILTER AREA HAS IDS WANTED                            *         
*                                                                     *         
*EXIT  R2 ==> IDS IN ORDER WANTED.                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IUCM     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC             ESTABLISH WORKING STORAGE                    
         USING DDUCOMD,IUCMBLK     ESTABLISH DDUCOM CONTROL BLOCK               
*                                                                               
*        RETRIEVE FIELD IDS - STORED IN FILTER AREA FOR KEYWORD                 
*        ONE ENTRY PER COLUMN WITH UCOMM KEYWORD                                
*                                                                               
*        CHECKS IF CHARACTERISTICS OF COLUMN ALREADY FOUND                      
*        IF NOT IT CREATES ENTRY IN TABLE                                       
*                                                                               
*        FIND ENTRY FOR KEYWORD IN LOCAL KEYWORD TABLE                          
*                                                                               
         LA    R3,UCKTAB           POINT TO START OF KEYWORD TABLE              
         USING UCKTAB,R3                                                        
*                                                                               
         LA    R0,UCKTAB#Q         MAX NUMBER OF ENTRIES IN TABLE               
*                                                                               
IUCMKYLP DS    0H                                                               
*                                                                               
         CLI   UCKKEY#,0           IF EOT BUILD NEW ENTRY                       
         BE    IUCMKYNW                                                         
*                                                                               
         CLC   UCKKEY#,GLARGS+6    ELSE MATCH KEYWORD NUMBER                    
         BE    IUCMKYFD                                                         
*                                                                               
IUCMKYCN DS    0H                                                               
*                                                                               
         LA    R3,UCKTABL(R3)    POINT TO NEXT ENTRY                            
         BCT   R0,IUCMKYLP                                                      
*                                                                               
         B     IUCMX               NO ROOM IN TABLE - SKIP KEYWORD              
*                                                                               
IUCMKYNW DS    0H                                                               
*                                                                               
*        BUILD ENTRY IN TABLE FOR NEW KEYWORD                                   
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,GLARGS+6       GET KEYWORD NUMBER                           
         BZ    IUCMX               NONE - SKIP KEYWORD                          
*                                                                               
         STC   RF,UCKKEY#          SAVE KEYWORD #                               
*                                                                               
*        FIND UCOMM IDS FOR THIS KEYWORD                                        
*                                                                               
         BCTR  RF,0                DECREMENT FOR INDEXING                       
         MHI   RF,FLTAREAL         CALCULATE INDEX AMOUNT                       
*                                                                               
         L     R7,AFLTTAB          POINT TO FILTER SAVEAREAS                    
         LA    R7,0(RF,R7)         POINT TO THIS KEYWORD'S AREA                 
*                                                                               
         USING FLTAREA,R7          ESTABLISH FILTER SAVEAREA                    
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,FLTFNO         GET NUMBER OF FILTERS                        
         BZ    IUCMX               NONE - SKIP KEYWORD                          
*                                                                               
         LA    R6,FLTCTL           POINT TO FIRST FILTER                        
*                                                                               
         LA    R5,UCKIDTB-UCKTAB(R3)  POINT TO USER FIELD TABLE                 
         USING UCKIDTB,R5          ESTABLISH ID SAVEAREA                        
*                                                                               
         SR    RF,RF                                                            
         SR    R1,R1               ID COUNTER                                   
*                                                                               
IUCMIDLP DS    0H                                                               
*                                                                               
         USING FLTCTL,R6           ESTABLISH FILTER                             
*                                                                               
         CLC   FLTFTIC,=AL2(PRQUCOM)  LOOKING FOR USER FIELD IDS                
         BNE   IUCMIDCN                                                         
*                                                                               
         MVC   UCKID,FLTFVAL+1     SAVE UCOMM ID                                
*                                                                               
         ICM   RF,1,UCKID          GET  UCOMM ID                                
*                                                                               
         CHI   RF,32               IF LT 32 THEN PRODUCT                        
         BH    IUCMIDPN                                                         
*                                                                               
         OI    UCKOPTS,UCKOPRD        INDICATE PRODUCT DATA NEEDED              
         OI    UCKIDOPT,UCKOPRD       INDICATE PRODUCT DATA                     
*                                                                               
         B     IUCMIDTX                                                         
*                                                                               
IUCMIDPN DS    0H                                                               
*                                                                               
         CHI   RF,64               IF LT 64 THEN ESTIMATE                       
         BH    IUCMIDEN                                                         
*                                                                               
         CHI   RF,37               HAVE ESTIMATE UCOMM 5-8?                     
         BL    IUCMEU14            NO - HAVE ESTIMATE UCOMM 1-4                 
         OI    UCKOPTS,UCKOEST     ESTIMATE DATA NEEDED                         
         OI    UCKOPTS,UCO8EST     TELL DDUCOM TO READ UCOMMS 5-8               
         OI    UCKIDOPT,UCKOPRD    OUTPUT WILL BE IN PRD FIELDS                 
         AHI   RF,-36              REDUCE TO SEQUENCE NUMBER                    
         B     IUCMIDTX            DONE                                         
*                                                                               
IUCMEU14 OI    UCKOPTS,UCKOEST     THEN ESTIMATE DATA NEEDED                    
         OI    UCKIDOPT,UCKOEST       INDICATE ESTIMATE DATA                    
         AHI   RF,-32                 REDUCE TO SEQUENCE NUMBER                 
*                                                                               
         B     IUCMIDTX                                                         
*                                                                               
IUCMIDEN DS    0H                                                               
*****                                                                           
*****    CHI   RF,96               IF LT 96 THEN DIVISION                       
*****    BH    IUCMIDVN                                                         
*****                                                                           
*****    OI    UCKOPTS,UCKODIV     THEN DIVISION DATA NEEDED                    
*****    OI    UCKIDOPT,UCKODIV       INDICATE DIVISION DATA                    
*****    AHI   RF,-64                 REDUCE TO SEQUENCE NUMBER                 
*****                                                                           
*****    B     IUCMIDTX                                                         
*****                                                                           
IUCMIDVN DS    0H                                                               
*****                                                                           
         CHI   RF,128              IF LT 128 THEN REGION                        
         BH    IUCMIDRN                                                         
*                                                                               
         OI    UCKOPTS,UCKOREG     THEN REGION   DATA NEEDED                    
         OI    UCKIDOPT,UCKOREG       INDICATE REGION   DATA                    
         AHI   RF,-96                 REDUCE TO SEQUENCE NUMBER                 
*                                                                               
         B     IUCMIDTX                                                         
*                                                                               
IUCMIDRN DS    0H                                                               
         OI    UCKOPTS,UCKODST     ELSE DISTRICT DATA NEEDED                    
         OI    UCKIDOPT,UCKODST       INDICATE DISTRICT DATA                    
         AHI   RF,-128                REDUCE TO SEQUENCE NUMBER                 
*                                                                               
         B     IUCMIDTX                                                         
*                                                                               
IUCMIDTX DS    0H                                                               
*                                                                               
         BCTR  RF,0                RELATIVE NUMBER OF TYPE                      
         STC   RF,UCKIDREL                                                      
*                                                                               
         LA    R5,UCKIDTBL(R5)     BUMP TO NEXT ID AREA                         
         AHI   R1,1                BUMP ID COUNTER                              
*                                                                               
IUCMIDCN DS    0H                                                               
*                                                                               
         IC    RF,FLTFVLEN         FILTER VALUE LENGTH                          
         LA    R6,FLTFVAL(RF)      BUMP TO NEXT FILTER                          
         BCT   R0,IUCMIDLP                                                      
*                                                                               
IUCMIDDN DS    0H                                                               
*                                                                               
*        LA    RF,UCKIDTB-UCKTAB(R3)  POINT TO  START  OF IDS                   
*        SR    R5,RF               CALCULATE NUMBER OF IDS                      
*        BNP   IUCMX                                                            
*                                                                               
         STC   R1,UCKID#           SAVE NUMBER OF IDS                           
*                                                                               
IUCMKYFD DS    0H                                                               
*                                                                               
         ST    R3,IUCMKYWA         SAVE A(TABLE ENTRY)                          
*                                                                               
IUCMKYX  DS    0H                                                               
*                                                                               
         DROP  R6,R7                                                            
*                                                                               
*        RETRIEVE UCOM DATA VIA DDUCOM                                          
*                                                                               
         XC    IUCMBLK,IUCMBLK     INIT      DDUCOM CONTROL BLOCK               
*                                                                               
         MVC   UCACOMF,ACOMFACS    A(COMFACS)                                   
         MVI   UCSYS,C'P'          SYSTEM IS PRINT                              
         MVC   UCAGY,AGENCY        AGENCY                                       
         MVC   UCMED,PBMED         MEDIA                                        
         MVC   UCCLT,PBCLT         SET CLIENT                                   
         MVC   UCPRD,PBPROD        SET PRODUCT                                  
         MVC   UCEST,PBEST         SET ESTIMATE                                 
         MVC   UCDIV,PBDIV         SET DIVISION                                 
         MVC   UCREG,PBRGN         SET REGION                                   
         MVC   UCDST,PBDST         SET DISTRICT                                 
*                                                                               
         CLC   UCKMED,PBMED        IF MEDIA    CHANGED                          
         BNE   *+10                                                             
         CLC   UCKCLT,PBCLT        OR CLIENT   CHANGED                          
         BNE   *+10                                                             
         CLC   UCKPRD,PBPROD       OR PRODUCT  CHANGED                          
         BNE   *+10                                                             
         CLC   UCKDIV,PBDIV        OR DIVISION CHANGED                          
         BNE   *+10                                                             
         CLC   UCKREG,PBRGN        OR REGION   CHANGED                          
         BNE   *+10                                                             
         CLC   UCKDST,PBDST        OR DISTRICT CHANGED                          
         BE    *+12                                                             
         MVI   UCOPT,UCOPRD+UCOEST+UCOREG+UCODST  RETURN ALL DATA               
         B     IUCMOPTX                                                         
*                                                                               
         CLC   UCKEST,PBEST        IF ESTIMATE CHANGED                          
         BE    *+8                                                              
         MVI   UCOPT,UCOPRD+UCOEST+UCOREG+UCODST  RETURN ALL DATA               
*                                                                               
IUCMOPTX DS    0H                                                               
*                                                                               
*        SP    IUCMCTR,=P'1'       TESTING                                      
*        BP    *+6                                                              
*        DC    H'0'                                                             
*                                                                               
***                                                                             
* IF WE'RE USING ESTIMATE UCOMMS 5-8 SET UCO8EST WHICH WILL RETURN THE          
* ESTIMATE UCOMM 5-8 DATA IN THE PRODUCT ENTRY                                  
***                                                                             
         LR    RE,R5               SAVE OFF R5                                  
         L     R5,IUCMKYWA         A(TABLE ENTRY)                               
         LA    R5,UCKIDTB-UCKTAB(R5)  POINT TO USER FIELD TABLE                 
         CLI   UCKID,X'25'         EST UCOMM 5-8?                               
         BL    IUCMUCM             NO                                           
         CLI   UCKID,X'28'         EST UCOMM 5-8?                               
         BH    IUCMUCM             NO                                           
         OI    UCOPT,UCO8EST       GET ESTIMATE UCOMM 5-8                       
*                                                                               
IUCMUCM  LR    R5,RE               RESTORE R5                                   
         NC    UCOPT,UCKOPTS       ELIMINATES PRODUCT AND/EST                   
*                                  RETRIEVAL IF NOT NEEDED                      
         BZ    IUCMRDX             NO NEW DATA NEEDED                           
         GOTO1 =V(DDUCOM),DDUCOMD  FIND UCOM    DATA                            
*                                                                               
         CLI   UCERROR,0           NO ERRORS TOLERATED                          
         BNE   IUCMX               SKIP IF NO DATA                              
*                                                                               
IUCMRDX  DS    0H                                                               
*                                                                               
         MVC   UCKMED,PBMED        SAVE MEDIA    CODE                           
         MVC   UCKCLT,PBCLT        SAVE CLIENT   CODE                           
         MVC   UCKPRD,PBPROD       SAVE PRODUCT  CODE                           
         MVC   UCKEST,PBEST        SAVE EST      CODE                           
         MVC   UCKDIV,PBDIV        SAVE DIVISION CODE                           
         MVC   UCKREG,PBRGN        SAVE REGION   CODE                           
         MVC   UCKDST,PBDST        SAVE DISTRICT CODE                           
*                                                                               
*        HAVE ALL REQUIRED DATA - NOW ADD TO SORT                               
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,UCKID#         NUMBER OF IDS                                
*                                                                               
         L     R3,IUCMKYWA         POINT TO A(TABLE ENTRY)                      
*                                                                               
         LA    R5,UCKIDTB-UCKTAB(R3)  POINT TO USER FIELD TABLE                 
         USING UCKIDTB,R5          ESTABLISH ID SAVEAREA                        
         SR    R6,R6                                                            
*                                                                               
IUCMINLP DS    0H                                                               
*                                                                               
*        IF FIRST TIME GET EDIT TYPE AND INPUT LENGTH                           
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,UCKIDLEN                                                    
         BNZ   IUCMIN05            INPUT LENGTH KNOWN                           
*                                                                               
         LA    R1,UCPEDITS         ASSUME PRODUCT                               
*                                                                               
         TM    UCKIDOPT,UCOEST     TEST FOR ESTIMATE                            
         BNO   *+8                                                              
         LA    R1,UCEEDITS            SET FOR ESTIMATE                          
*****                                                                           
*****    TM    UCKIDOPT,UCODIV     TEST FOR DIVISION                            
*****    BNO   *+8                                                              
*****    LA    R1,UCVEDITS            SET FOR DIVISION                          
*****                                                                           
         TM    UCKIDOPT,UCOREG     TEST FOR REGION                              
         BNO   *+8                                                              
         LA    R1,UCREDITS            SET FOR REGION                            
*                                                                               
         TM    UCKIDOPT,UCODST     TEST FOR DISTRICT                            
         BNO   *+8                                                              
         LA    R1,UCDEDITS            SET FOR DISTRICT                          
*                                                                               
         IC    RF,UCKIDREL         GET RELATIVE NUMBER FOR ID                   
         LA    R1,0(RF,R1)         POINT TO MAX LENGTH FOR ID                   
*                                                                               
         MVC   UCKIDEDT,0(R1)      SAVE EDIT TYPE                               
*                                                                               
         LA    R1,UCPMXLNS         ASSUME PRODUCT                               
*                                                                               
         TM    UCKIDOPT,UCOEST     TEST FOR ESTIMATE                            
         BNO   *+8                                                              
         LA    R1,UCEMXLNS            SET FOR ESTIMATE                          
****                                                                            
****     TM    UCKIDOPT,UCODIV     TEST FOR DIVISION                            
****     BNO   *+8                                                              
****     LA    R1,UCVMXLNS            SET FOR DIVISION                          
*                                                                               
         TM    UCKIDOPT,UCOREG     TEST FOR REGION                              
         BNO   *+8                                                              
         LA    R1,UCRMXLNS            SET FOR REGION                            
*                                                                               
         TM    UCKIDOPT,UCODST     TEST FOR DISTRICT                            
         BNO   *+8                                                              
         LA    R1,UCDMXLNS            SET FOR DISTRICT                          
*                                                                               
         IC    RF,UCKIDREL         GET RELATIVE NUMBER FOR ID                   
         LA    R1,0(RF,R1)         POINT TO MAX LENGTH FOR ID                   
*                                                                               
         ICM   RF,1,0(R1)          GET INPUT LENGTH                             
*                                                                               
         CLI   UCKIDEDT,C'D'       IF DATE TYPE FIELD                           
         BNE   *+8                                                              
         LA    RF,3                   LENGTH IS 3                               
*                                                                               
         STC   RF,UCKIDLEN         SAVE LENGTH                                  
*                                                                               
IUCMIN05 DS    0H                                                               
*                                                                               
         TM    UCKIDOPT,UCOPRD     IF PRODUCT DATA ID                           
         BNO   IUCMIN10                                                         
         TM    UCOPT,UCO8EST       REQUESTED ESTIMATE UCOMMS 5-8?               
         BNZ   *+12                YES - OUTPUT IS IN A(UCPDATA)                
         TM    UCOPT,UCOPRD        AND PRODUCT DATA LOOKED UP                   
         BNO   IUCMIN80                                                         
*                                                                               
         L     R1,UCPDATA             POINT TO PRODUCT DATA                     
*                                                                               
         B     IUCMIN70                                                         
*                                                                               
IUCMIN10 DS    0H                                                               
*                                                                               
         TM    UCKIDOPT,UCOEST     IF ESTIMATE DATA ID                          
         BNO   IUCMIN20                                                         
         TM    UCOPT,UCOEST        AND ESTIMATE DATA LOOKED UP                  
         BNO   IUCMIN80                                                         
*                                                                               
         L     R1,UCEDATA             POINT TO ESTIMATE DATA                    
*                                                                               
         B     IUCMIN70                                                         
*                                                                               
IUCMIN20 DS    0H                                                               
*****                                                                           
*****    TM    UCKIDOPT,UCODIV     IF DIVISION DATA ID                          
*****    BNO   IUCMIN30                                                         
*****    TM    UCOPT,UCODIV        AND DIVISION DATA LOOKED UP                  
*****    BNO   IUCMIN80                                                         
*****                                                                           
*****    L     R1,UCVDATA             POINT TO DIVISION DATA                    
*****                                                                           
*****    B     IUCMIN70                                                         
*****                                                                           
IUCMIN30 DS    0H                                                               
*****                                                                           
         TM    UCKIDOPT,UCOREG     IF REGION   DATA ID                          
         BNO   IUCMIN40                                                         
         TM    UCOPT,UCOREG        AND REGION   DATA LOOKED UP                  
         BNO   IUCMIN80                                                         
*                                                                               
         L     R1,UCRDATA             POINT TO REGION   DATA                    
*                                                                               
         B     IUCMIN70                                                         
*                                                                               
IUCMIN40 DS    0H                                                               
*                                                                               
         TM    UCKIDOPT,UCODST     IF DISTRICT DATA ID                          
         BNO   IUCMIN50                                                         
         TM    UCOPT,UCODST        AND DISTRICT DATA LOOKED UP                  
         BNO   IUCMIN80                                                         
*                                                                               
         L     R1,UCDDATA             POINT TO DISTRICT DATA                    
*                                                                               
         B     IUCMIN70                                                         
*                                                                               
IUCMIN50 DS    0H                                                               
*                                                                               
         B     IUCMINCN            IGNORE UNKNOWN DATA TYPE                     
*                                                                               
IUCMIN70 DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,UCKIDREL       GET ID'S RELATIVE NUMBER                     
         MHI   RF,32               INDEX INTO DATA                              
*                                                                               
         LA    R1,0(RF,R1)         POINT TO DATA RETURNED BY DDUCOM             
*                                                                               
         MVC   UCKIDDAT,0(R1)      PUTS DATA IN TABLE                           
*                                                                               
IUCMIN80 DS    0H                                                               
*                                                                               
         CLI   UCKIDEDT,C'D'       IF A DATE                                    
         BNE   IUCMIN90                                                         
*                                                                               
         GOTO1 DATVAL,DMCB,UCKIDDAT,WORK VALIDATE DATE                          
*                                                                               
         CLC   WORK(6),=6C'0'         SKIP IF INVALID DATE                      
         BE    IUCMIN85                                                         
*                                                                               
         GOTO1 DATCON,DMCB,WORK,(3,0(R2)) CONVERT TO BINARY DATE                
*                                                                               
IUCMIN85 DS    0H                                                               
*                                                                               
         B     IUCMINCN                                                         
*                                                                               
IUCMIN90 DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         IC    RF,UCKIDLEN         GET STANDARD DATA LENGTH                     
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),UCKIDDAT    PASS DATA TO SORT                            
*                                                                               
IUCMINCN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,UCKIDLEN       BUMP TO NEXT INPUT AREA                      
         LA    R2,0(RF,R2)         POINT TO NEXT SORT AREA                      
*                                                                               
         LA    R5,UCKIDTBL(R5)     NEXT ID                                      
         BCT   R0,IUCMINLP                                                      
*                                                                               
IUCMINDN DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE CURRENT KEY                          
         OI    DMINBTS,8           PASS DELETED RECORDS                         
*                                                                               
         GOTO1 HIGH                                                             
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
IUCMX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
         DS    0H                                                               
IUCMCTR  DC    PL2'3'                TESTING                                    
*                                                                               
IUCMKYWA DS    A                   TABLE ENTRY ADDRESS                          
*                                                                               
IUCMBLK  DS    XL(UCOMDLNQ)        DDUCOM CONTROL BLOCK                         
*                                                                               
*        TABLE FOR COLUMNS REPORTING UCOMM DATA                                 
*                                                                               
         DS    0D                  ALIGNMENT                                    
UCKTAB   DS    0X                  KEYWORD INFO TABLE                           
UCKKEY#  DS    XL1                 KEYWORD NUMBER                               
         DS    XL1                 SPARE                                        
UCKID#   DS    XL1                 NUMBER OF IDS                                
         DS    XL1                 SPARE                                        
UCKOPTS  DS    XL1                 DATA TYPE OPTIONS                            
UCKOPRD  EQU   UCOPRD                PRODUCT DATA                               
UCKOEST  EQU   UCOEST                ESTIMATE DATA                              
*UCKODIV  EQU   UCODIV                DIVISION DATA                             
UCKOREG  EQU   UCOREG                REGION   DATA                              
UCKODST  EQU   UCODST                DISTRICT DATA                              
         DS    XL3                 SPARE                                        
UCKMED   DS    CL1                 MEDIA                                        
UCKCLT   DS    CL3                 CLIENT                                       
UCKPRD   DS    CL3                 PRODUCT                                      
UCKEST   DS    XL2                 ESTIMATE                                     
UCKDIV   DS    CL3                 DIVISION                                     
UCKREG   DS    CL3                 REGION                                       
UCKDST   DS    CL3                 DISTRICT                                     
         DS    XL14                SPARE                                        
UCKIDTB  DS    0D                  USERIDS TABLE                                
UCKID    DS    XL1                 USER ID                                      
UCKIDREL DS    XL1                 USER ID RELATIVE NUMBER OF ID TYPE           
UCKIDOPT DS    XL1                 USER ID TYPE PRD/EST/DIV/REG/DIS             
UCKIDEDT DS    XL1                 EDIT TYPE                                    
UCKIDLEN DS    XL1                 DATA LENGTH                                  
         DS    XL3                 SPARE                                        
UCKIDDAT DS    CL32                USER FIELD DATA                              
UCKIDTBL EQU   *-UCKIDTB           LENGTH OF USER ID TABLE ENTRY                
         DS    3XL(UCKIDTBL)       REST OF USER ID TABLE                        
UCKTABL  EQU   *-UCKTAB            LENGTH OF TABLE ENTRY                        
*                                                                               
         DS    XL((UCKTAB#Q-1)*UCKTABL) REPEAT OF PREVIOUS TO FORM TAB          
*                                                                               
UCKTAB#Q EQU   6                   MAX NUMBER OF UCOMM KYWDS ALLOWED            
*                                                                               
         DROP  R3,R5                                                            
*                                                                               
         TITLE 'PRWRITER - TRAFFIC KEYWORDS - ITRA'                             
***********************************************************************         
*                                                                     *         
*        TRAFFIC KEYWORDS                                             *         
*                                                                     *         
*NTRY  - GLARGS + 0 - C'B' FOR BUY RECORD KEYWORD                     *         
*               + 1 - C'O' FOR TRAFFICKED BUY OPTION                  *         
*                                                                     *         
*EXIT  R2 ==>                                                         *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
ITRA     NTR1  BASE=*,LABEL=*                                                   
*                                                                               
         USING GEND,RC             ESTABLISH WORKING STORAGE                    
*                                                                               
         L     R6,AIO1             POINT TO BUY RECORD                          
*                                                                               
         CLI   GLARGS+1,C'O'       TRAFFICKED BUY OPTION                        
         BE    ITRAOPT                                                          
*                                                                               
         B     ITRAX               UNKNOWN KEYWORD                              
*                                                                               
ITRAOPT  DS    0H                                                               
*                                                                               
         USING PBUYREC,R6          ESTABLISH BUY RECORD                         
*                                                                               
         MVI   0(R2),C'Y'          ASSUME A TRAFFICKED BUY                      
*                                                                               
         TM    PBDSTAT,X'20'       IF NOT TRAFFICKED BUY                        
         BNO   *+8                                                              
         MVI   0(R2),C'N'             PRINT A C'N'                              
*                                                                               
ITRAOPTX DS    0H                                                               
*                                                                               
ITRAX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
         TITLE 'PRWRITER - USER FIELDS - OUTPUT - OUCM'                         
***********************************************************************         
*                                                                     *         
*        USER DEFINED FIELDS FROM PRODUCT AND ESTIMATE HEADERS        *         
*                                                                     *         
*NTRY  - COLUMN FILTER AREA HAS IDS WANTED                            *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OUCM     NMOD1 0,**#OUCM                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OUCMLBLX                                                         
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL AREA                             
*                                                                               
         XC    OUCMWORK,OUCMWORK   INIT OUTPUT WORKAREA                         
         LA    R3,OUCMWORK         BUILD OUTPUT IN OUCMWORK                     
*                                                                               
OUCMLBLX DS    0H                                                               
*                                                                               
         L     R4,=A(UCKTAB)       POINT TO KEYWORD TABLE                       
         USING UCKTAB,R4                                                        
*                                                                               
         LA    R0,UCKTAB#Q         MAX NUMBER OF KEYWORDS                       
*                                                                               
OUCKYWLP DS    0H                                                               
*                                                                               
         CLC   UCKKEY#,GLARGS+6    FIND ENTRY FOR KEYWORD                       
         BE    OUCKYWFD            MATCH KEYWORD NUMBERS                        
*                                                                               
OUCKYWCN DS    0H                                                               
*                                                                               
         LA    R4,UCKTABL(R4)      BUMP TO NEXT TABLE ENTRY                     
         BCT   R0,OUCKYWLP                                                      
*                                                                               
         B     OUCMX               NO MATCH - IGNORE                            
*                                                                               
OUCKYWFD DS    0H                                                               
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,UCKID#         NUMBER OF IDS FOR KEYWORD                    
         BZ    OUCMX               IGNORE IF NONE                               
*                                                                               
         LA    R5,UCKIDTB-UCKTAB(R4)  POINT TO USER FIELD TABLE                 
*                                                                               
OUCMOUTL DS    0H                                                               
*                                                                               
         CLI   UCKIDEDT,C'D'       IF DATE                                      
         BNE   OUCMOUT5                                                         
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),(17,0(R3))  PRINT DATE                     
*                                                                               
         B     OUCMOUTC                                                         
*                                                                               
OUCMOUT5 DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,UCKIDLEN-UCKIDTB(R5) GET INPUT LENGTH PER ITEM              
         BZ    *+6                                                              
         BCTR  RF,0                EXECUTE LENGTH                               
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R2)       PRINT DATA                                   
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R3),SPACES      FORCE UPPERCASE                              
*                                                                               
OUCMOUTC DS    0H                                                               
*                                                                               
         SR    RF,RF               BUMP INPUT AREA POINTER                      
         ICM   RF,1,UCKIDLEN-UCKIDTB(R5)                                        
         LA    R2,0(RF,R2)         POINT TO NEXT INPUT AREA                     
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OUCMOUT8                                                         
*                                                                               
         BCT   RF,*+8              DECREMENT FOR EXECUTE                        
         B     OUCMOUT7                                                         
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R3),SPACES      FORCE UPPERCASE                              
*                                                                               
         LA    R3,1(RF,R3)         BUMP TO NEXT OUTPUT AREA                     
*                                                                               
OUCMOUT7 DS    0H                                                               
*                                                                               
         MVI   0(R3),C' '          INTERVENING SPACE                            
         LA    R3,1(R3)            NEXT AVAILABLE PRINT AREA                    
*                                                                               
         B     OUCMOUT9                                                         
*                                                                               
OUCMOUT8 DS    0H                                                               
*                                                                               
         LA    R3,198(R3)          NEXT PRINT AREA                              
*                                                                               
OUCMOUT9 DS    0H                                                               
*                                                                               
         LA    R5,UCKIDTBL(R5)     NEXT ID                                      
         BCT   R0,OUCMOUTL                                                      
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OUCMGENX                                                         
*                                                                               
         MVC   NAMEAREA,SPACES     INIT OUTPUT AREA                             
*                                                                               
         LA    RF,OUCMWORK         CALCULATE LENGTH OF OUTPUT                   
         SR    R3,RF                                                            
*                                                                               
         GOTO1 SQUASHER,DMCB,OUCMWORK,(R3)  SQUASH OUTPUT                       
*                                                                               
         ICM   RF,15,DMCB+4        GET NEW LENGTH                               
         BZ    OUCMOUTD            SKIP IF NO DATA                              
*                                                                               
         CHI   RF,L'NAMEAREA       CAN'T BE BIGGER THAN NAMEAREA                
         BNH   *+8                                                              
         LHI   RF,L'NAMEAREA                                                    
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   NAMEAREA(0),OUCMWORK  PRINT UDEF VALUES                          
*                                                                               
OUCMOUTD DS    0H                                                               
*                                                                               
         L     R3,GLAOFLD          R3=A(OUTPUT)                                 
*                                                                               
         GOTO1 GENOUTA             HEADLINE PROCESSING                          
*                                                                               
OUCMGENX DS    0H                                                               
*                                                                               
OUCMX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OUCMWORK DS    XL256               WORKAREA                                     
*                                                                               
         TITLE 'PRWRITER - USER FIELDS - INPUT - IUDF'                          
***********************************************************************         
*                                                                     *         
*        USER DEFINED FIELDS FROM PRODUCT AND ESTIMATE HEADERS        *         
*                                                                     *         
*NTRY  - COLUMN FILTER AREA HAS IDS WANTED                            *         
*                                                                     *         
*EXIT  R2 ==> IDS IN ORDER WANTED.                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IUDF     NMOD1 128,**#IUDF                                                      
*                                                                               
         ST    RC,IUDFWRKA         SAVE WORKAREA ADDRESS                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        RETRIEVE FIELD IDS                                                     
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,GLARGS+6       GET KEYWORD NUMBER                           
         BZ    IUDFX               NONE - SKIP KEYWORD                          
*                                                                               
*        FIND ENTRY IF KEYWORD TABLE                                            
*                                                                               
         LA    RE,IUDFKYWT         POINT TO START OF KEYWORD TABLE              
         USING IUDFKYWT,RE                                                      
*                                                                               
         CLI   IUDFKEY#,0          EOT USE AS ENTRY                             
         BE    *+8                                                              
         CLM   RF,1,IUDFKEY#       MATCH KEYWORD NUMBER                         
         BE    *+14                                                             
         LA    RE,L'IUDFKYWT(RE)   POINT TO NEXT ENTRY                          
         B     *-20                                                             
         DC    H'0'                ENLARGE TABLE                                
*                                                                               
         STC   RF,IUDFKEY#         SAVE KEYWORD #                               
         ST    RE,IUDFKYWA         SAVE A(TABLE ENTRY)                          
*                                                                               
         DROP  RE                                                               
*                                                                               
         LA    RE,FLTAREAL         LENGTH OF FILTER SAVEAREA                    
         BCTR  RF,0                DECREMENMT FOR INDEXING                      
         MR    RE,RE               CALCULATE INDEX AMOUNT                       
*                                                                               
         L     R7,AFLTTAB          POINT TO FILTER SAVEAREAS                    
         LA    R7,0(RF,R7)         POINT TO THIS KEYWORD'S AREA                 
*                                                                               
         USING FLTAREA,R7          ESTABLISH FILTER SAVEAREA                    
*                                                                               
         SR    R0,R0                                                            
         ICM   R0,1,FLTFNO         GET NUMBER OF FILTERS                        
         BZ    IUDFX               NONE - SKIP KEYWORD                          
*                                                                               
         LA    R6,FLTCTL           POINT TO FIRST FILTER                        
         LA    R5,IUDFIDS          POINT TO USER FIELD IDS                      
         SR    RF,RF                                                            
*                                                                               
UDEFIDLP DS    0H                                                               
*                                                                               
         USING FLTCTL,R6           ESTABLISH FILTER                             
*                                                                               
         CLC   FLTFTIC,=AL2(PRQUDEF)  LOOKING FOR USER FIELD IDS                
         BNE   UDEFIDCN                                                         
*                                                                               
         MVC   0(2,R5),FLTFVAL     SAVE ID                                      
         LA    R5,2(R5)            BUMP TO NEXT SAVEAREA                        
*                                                                               
UDEFIDCN DS    0H                                                               
*                                                                               
         IC    RF,FLTFVLEN         FILTER VALUE LENGTH                          
         LA    R6,FLTFVAL(RF)      BUMP TO NEXT FILTER                          
         BCT   R0,UDEFIDLP                                                      
*                                                                               
         LA    RF,IUDFIDS          DETERMINE NUMBER OF IDS                      
         SR    R5,RF                                                            
         BNP   IUDFX                                                            
         SRL   R5,1                EACH ID IS 2 LONG                            
         L     RE,IUDFKYWA         POINT TO SAVEAREA                            
         ST    R5,IUDFID#-IUDFKYWT(RE)  SAVE NUMBER OF IDS                      
*                                                                               
         DROP  R6,R7                                                            
*                                                                               
*        DETERMINE IF PRODUCT FIELDS WANTED                                     
*                                                                               
         LA    R5,IUDFIDS          MAKE SURE A PRODUCT FIELD WANTED             
*                                                                               
IUDFPIDL DS    0H                                                               
*                                                                               
         OC    0(2,R5),0(R5)       END OF IDS - NONE ARE PRODUCTS               
         BZ    IUDFPIDX                                                         
*                                                                               
         CLC   0(2,R5),=AL2(PRQUDP1)  PRODUCT 1                                 
         BE    *+10                                                             
         CLC   0(2,R5),=AL2(PRQUDP2)  PRODUCT 2                                 
         BE    IUDFPIDF                                                         
*                                                                               
         LA    R5,2(R5)                                                         
         B     IUDFPIDL                                                         
*                                                                               
IUDFPIDF DS    0H                                                               
*                                                                               
*        RETRIEVE PRODUCT FIELDS FROM PRODUCT HEADER                            
*                                                                               
         CLC   IUDFMED,PBMED       IF MEDIA   CHANGED                           
         BNE   *+10                                                             
         CLC   IUDFCLT,PBCLT       OR CLIENT  CHANGED                           
         BNE   *+10                                                             
         CLC   IUDFPRD,PBPROD      OR PRODUCT CHANGED                           
         BE    IUDFPRDX               SKIP IF UNCHANGED                         
*                                                                               
         XC    IUDFPRDS(IUDFPRSL),IUDFPRDS   CLEAR PRODUCT SAVEAREA             
         MVC   IUDFMED,PBMED       SAVE MEDIA   CODE                            
         MVC   IUDFCLT,PBCLT       SAVE CLIENT  CODE                            
         MVC   IUDFPRD,PBPROD      SAVE PRODUCT CODE                            
*                                                                               
         MVC   IUDFAIOS,AIO        SAVE ADDRESS OF AIO                          
         MVC   IUDFFILS,FILENAME   SAVE FILENAME                                
*                                                                               
         MVC   FILENAME,=CL8'PRTDIR' SET FILE NAME                              
*                                                                               
         LA    RE,IUDFWKIO                                                      
         ST    RE,AIO              SET I/O AREA ADDRESS                         
*                                                                               
         LA    R4,KEY              ESTABLISH KEY WORKAREA AS PPRDREC            
         USING PPRDRECD,R4                                                      
         XC    PPRDKEY,PPRDKEY     INIT KEY AREA                                
*                                                                               
         MVC   PPRDKAGY,PBAGY      SET AGENCY                                   
         MVI   PPRDKRCD,PPRDKIDQ   SET RECORD ID                                
         MVC   PPRDKMED,PBMED      SET MEDIA                                    
         MVC   PPRDKCLT,PBCLT      SET CLIENT                                   
         MVC   PPRDKPRD,PBPROD     SET PRODUCT                                  
*                                                                               
         GOTO1 HIGH                READ PPRDREC POINTER                         
*                                                                               
         CLC   PPRDKEY,KEYSAVE     MUST HAVE EXACT MATCH                        
         BNE   IUDFPRD1                                                         
*                                                                               
         MVC   FILENAME,=CL8'PRTFIL' SET FILE NAME                              
*                                                                               
         GOTO1 GETREC              READ PRDREC                                  
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
IUDFPRD1 DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE CURRENT KEY                          
         OI    DMINBTS,8           PASS BACK DELETED RECORDS                    
         MVC   AIO,IUDFAIOS        RESTORE I/O AREA POINTER                     
         MVC   FILENAME,IUDFFILS   RESTORE FILE NAME                            
*                                                                               
         GOTO1 HIGH                                                             
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         LA    R4,IUDFWKIO         POINT TO FOUND RECORD                        
         USING PPRDRECD,R4                                                      
         CLI   PPRDKRCD,PPRDKIDQ   HAVE VALID PRODUCT RECORD?                   
         JNE   IUDFPRDX                                                         
*                                                                               
*        FIND USER DESCRIPTION ELEMENT                                          
*                                                                               
         LA    R6,33(R4)           POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                                                               
IUDFPULP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             SKIP IF EOR REACHED                          
         BE    IUDFPUDN                                                         
*                                                                               
         CLI   0(R6),X'08'         LOOKING FOR USER DESCRIPTION ELM             
         BE    IUDFPUFD                                                         
*                                                                               
IUDFPUCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT IN RECORD               
         B     IUDFPULP                                                         
*                                                                               
IUDFPUDN DS    0H                                                               
         B     IUDFPRDX            NONE AVAILABLE                               
*                                                                               
IUDFPUFD DS    0H                  USER DESCRIPTION ELEMENT FOUND               
*                                                                               
         USING PPRDUDEF,R6         ESTABLISH USER DESCRIPTION ELM               
*                                                                               
         MVC   IUDFP1(L'PUSER1),PUSER1       SAVE USER DESCRIPTIONS             
         MVC   IUDFP2(L'PUSER2),PUSER2                                          
*                                                                               
IUDFPRDX DS    0H                                                               
*                                                                               
IUDFPIDX DS    0H                                                               
*                                                                               
*        DETERMINE IF ESTIMATE FIELDS WANTED                                    
*                                                                               
         LA    R5,IUDFIDS          MAKE SURE AN ESTIMATE FIELD WANTED           
*                                                                               
IUDFEIDL DS    0H                                                               
*                                                                               
         OC    0(2,R5),0(R5)       END OF IDS - NONE ARE ESTIMATES              
         BZ    IUDFEIDX                                                         
*                                                                               
         CLC   0(2,R5),=AL2(PRQUDE1)  ESTIMATE 1                                
         BE    *+10                                                             
         CLC   0(2,R5),=AL2(PRQUDE2)  ESTIMATE 2                                
         BE    IUDFEIDF                                                         
*                                                                               
         LA    R5,2(R5)                                                         
         B     IUDFEIDL                                                         
*                                                                               
IUDFEIDF DS    0H                                                               
*                                                                               
*        RETRIEVE ESTIMATE FIELDS FROM ESTIMATE HEADER                          
*                                                                               
         CLC   IUDFMED,PBMED       IF MEDIA   CHANGED                           
         BNE   *+10                                                             
         CLC   IUDFCLT,PBCLT       OR CLIENT  CHANGED                           
         BNE   *+10                                                             
         CLC   IUDFPRD,PBPROD      OR PRODUCT CHANGED                           
         BNE   *+10                                                             
         CLC   IUDFEST,PBEST       OR ESTIMATE CHANGED                          
         BE    IUDFESTX               SKIP IF UNCHANGED                         
*                                                                               
         XC    IUDFESTS(IUDFESSL),IUDFESTS   CLEAR ESTIMATE SAVEAREA            
         MVC   IUDFEST,PBEST       SAVE ESTIMATE CODE                           
*                                                                               
         MVC   IUDFAIOS,AIO        SAVE ADDRESS OF AIO                          
         MVC   IUDFFILS,FILENAME   SAVE FILENAME                                
*                                                                               
         MVC   FILENAME,=CL8'PRTDIR' SET FILE NAME                              
*                                                                               
         LA    RE,IUDFWKIO                                                      
         ST    RE,AIO              SET I/O AREA ADDRESS                         
*                                                                               
         LA    R4,KEY              ESTABLISH KEY WORKAREA AS PESTREC            
         USING PESTRECD,R4                                                      
         XC    PESTKEY,PESTKEY     INIT KEY AREA                                
*                                                                               
         MVC   PESTKAGY,PBAGY      SET AGENCY                                   
         MVI   PESTKRCD,PESTKIDQ   SET RECORD ID                                
         MVC   PESTKMED,PBMED      SET MEDIA                                    
         MVC   PESTKCLT,PBCLT      SET CLIENT                                   
         MVC   PESTKPRD,PBPROD     SET PRODUCT                                  
         MVC   PESTKEST,PBEST      SET ESTIMATE                                 
*                                                                               
         GOTO1 HIGH                READ PESTREC POINTER                         
*                                                                               
         CLC   PESTKEY,KEYSAVE     MUST HAVE EXACT MATCH                        
         BNE   IUDFEST1                                                         
*                                                                               
         MVC   FILENAME,=CL8'PRTFIL' SET FILE NAME                              
*                                                                               
         GOTO1 GETREC              READ ESTREC                                  
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
IUDFEST1 DS    0H                                                               
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE CURRENT KEY                          
         OI    DMINBTS,8           PASS BACK DELETED RECORDS                    
         MVC   AIO,IUDFAIOS        RESTORE I/O AREA POINTER                     
         MVC   FILENAME,IUDFFILS   RESTORE FILE NAME                            
*                                                                               
         GOTO1 HIGH                                                             
         BE    *+6                                                              
         DC    H'0'                NO ERRORS TOLERATED                          
*                                                                               
         LA    R4,IUDFWKIO         POINT TO FOUND RECORD                        
         USING PESTRECD,R4                                                      
*                                                                               
*        FIND USER DESCRIPTION ELEMENT                                          
*                                                                               
         LA    R6,33(R4)           POINT TO FIRST ELEMENT IN RECORD             
         SR    RF,RF                                                            
*                                                                               
IUDFEULP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             SKIP IF EOR REACHED                          
         BE    IUDFEUDN                                                         
*                                                                               
         CLI   0(R6),X'08'         LOOKING FOR USER DESCRIPTION ELM             
         BE    IUDFEUFD                                                         
*                                                                               
IUDFEUCN DS    0H                                                               
*                                                                               
         IC    RF,1(R6)            GET ELEMENT LENGTH                           
         LA    R6,0(RF,R6)         BUMP TO NEXT ELEMENT IN RECORD               
         B     IUDFEULP                                                         
*                                                                               
IUDFEUDN DS    0H                                                               
         B     IUDFESTX            NONE AVAILABLE                               
*                                                                               
IUDFEUFD DS    0H                  USER DESCRIPTION ELEMENT FOUND               
*                                                                               
         USING PESTUDEF,R6         ESTABLISH USER DESCRIPTION ELM               
*                                                                               
         MVC   IUDFE1(L'PEUSER1),PEUSER1      SAVE USER DESCRIPTIONS            
         MVC   IUDFE2(L'PEUSER2),PEUSER2                                        
*                                                                               
IUDFESTX DS    0H                                                               
*                                                                               
IUDFEIDX DS    0H                                                               
*                                                                               
*        HAVE ALL REQUIRED DATA - NOW ADD TO SORT                               
*                                                                               
         L     R1,GLADTENT             ESTABLISH INPUT DRIVETABLE ENTRY         
         USING DRIND,R1                                                         
*                                                                               
         L     RE,IUDFKYWA         POINT TO SAVEAREA                            
         MVC   IUDFFULL,IUDFID#-IUDFKYWT(RE)  SAVE # 0F IDS                     
*                                                                               
         SR    RE,RE                                                            
         SR    RF,RF                                                            
         IC    RF,DRINLEN          INPUT AREA LENGTH                            
         D     RE,IUDFFULL         DIVIDE BY # OF IDS                           
*                                  RF NOW HAS LNGTH ASSIGNED TO EACH ID         
         CLM   RF,1,=AL1(L'PUSER1)   CAN NOT EXCEED MAX LENGTH                  
         BNH   *+8                                                              
         LA    RF,L'PUSER1                                                      
*                                                                               
         L     RE,IUDFKYWA         POINT TO SAVEAREA                            
         STC   RF,IUDFILEN-IUDFKYWT(RE)  SAVE INPUT LENGTH PER ITEM             
*                                                                               
         BCTR  RF,0                EXECUTE LENGTH                               
         LA    R5,IUDFIDS          POINT TO REQUIRED FIELD IDS                  
*                                                                               
IUDFINLP DS    0H                                                               
*                                                                               
         OC    0(2,R5),0(R5)       END OF LIST                                  
         BZ    IUDFINDN                                                         
*                                                                               
         SR    R3,R3                                                            
*                                                                               
         CLC   0(2,R5),=AL2(PRQUDP1)   PUSER 1?                                 
         BNE   *+8                                                              
         LA    R3,IUDFP1                                                        
*                                                                               
         CLC   0(2,R5),=AL2(PRQUDP2)   PUSER 2?                                 
         BNE   *+8                                                              
         LA    R3,IUDFP2                                                        
*                                                                               
         CLC   0(2,R5),=AL2(PRQUDE1)   PEUSER 1?                                
         BNE   *+8                                                              
         LA    R3,IUDFE1                                                        
*                                                                               
         CLC   0(2,R5),=AL2(PRQUDE2)   PEUSER 1?                                
         BNE   *+8                                                              
         LA    R3,IUDFE2                                                        
*                                                                               
         LTR   R3,R3               MUST HAVE A MATCH                            
         BZ    IUDFINCN                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R2),0(R3)       ADD TO SORT                                  
*                                                                               
         LA    R2,1(RF,R2)         POINT TO NEXT SORT AREA                      
*                                                                               
IUDFINCN DS    0H                                                               
*                                                                               
         LA    R5,2(R5)            NEXT ID                                      
         B     IUDFINLP                                                         
*                                                                               
IUDFINDN DS    0H                                                               
*                                                                               
IUDFX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
IUDFWRKA DS    A                   WORKING STORAGE ADDRESS                      
IUDFAIOS DS    A                   I/O AREA        ADDRESS                      
IUDFFULL DS    F                   WORKAREA                                     
IUDFIDS  DC    10XL2'00'           USER ID SAVEAREA                             
IUDFFILS DS    CL8                 FILENAME SAVE AREA                           
*                                                                               
IUDFPRDS DS    0X                  PRODUCT FIELDS SAVEAREA                      
IUDFMED  DS    CL1                 MEDIA                                        
IUDFCLT  DS    CL3                 CLIENT                                       
IUDFPRD  DS    CL3                 PRODUCT                                      
IUDFP1   DS    CL(L'PUSER1)        PRODUCT  USER FIELD 1                        
IUDFP2   DS    CL(L'PUSER1)        PRODUCT  USER FIELD 2                        
*                                                                               
IUDFESTS DS    0X                  ESTIMATE FIELDS SAVEAREA                     
IUDFEST  DS    XL2                 ESTIMATE                                     
IUDFE1   DS    CL(L'PUSER1)        ESTIMATE USER FIELD 1                        
IUDFE2   DS    CL(L'PUSER1)        ESTIMATE USER FIELD 2                        
IUDFESSL EQU   *-IUDFESTS          LENGTH OF ESTIMATE SAVEAREA                  
*                                                                               
IUDFPRSL EQU   *-IUDFPRDS          LENGTH OF PRODUCT  SAVEAREA                  
*                                                                               
IUDFKYWA DS    A                   TABEL ENTRY ADDRESS                          
*                                                                               
IUDFKYWT DS    0XL8                KEYWORD INFO TABLE                           
IUDFID#  DC    F'0'                NUMBER OF IDS                                
IUDFKEY# DC    X'00'               KEYWORD NUMBER                               
IUDFILEN DS    XL1                 INPUT LENGTH SAVEAREA                        
         DS    XL2                 SPARE                                        
         DS    20XL8               REPEAT OF PREVIOUS TO FORM TABLE             
*                                                                               
IUDFWKIO DS    XL4096              LOCAL RECORD AREA                            
*                                                                               
         TITLE 'PRWRITER - USER FIELDS - OUTPUT - OUDF'                         
***********************************************************************         
*                                                                     *         
*        USER DEFINED FIELDS FROM PRODUCT AND ESTIMATE HEADERS        *         
*                                                                     *         
*NTRY  - COLUMN FILTER AREA HAS IDS WANTED                            *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OUDF     NMOD1 0,**#OUDF                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OUDFLBLX                                                         
*                                                                               
         GOTO1 =A(BLDLBL)          BUILD LABEL AREA                             
*                                                                               
         XC    OUDFWORK,OUDFWORK   INIT OUTPUT WORKAREA                         
         LA    R3,OUDFWORK         BUILD OUTPUT IN OUDFWORK                     
*                                                                               
OUDFLBLX DS    0H                                                               
*                                                                               
         L     R1,GLADTENT         ESTABLISH OUTPUT DRIVETABLE ENTRY            
         USING DROD,R1                                                          
*                                                                               
         L     RE,=A(IUDFKYWT)     POINT TO KEYWORD TABLE                       
*                                                                               
         CLC   IUDFKEY#-IUDFKYWT(L'IUDFKEY#,RE),GLARGS+6                        
         BE    *+12                MATCH KEYWORD NUMBERS                        
         LA    RE,L'IUDFKYWT(RE)   BUMP TO NEXT TABLE ENTRY                     
         B     *-14                                                             
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,IUDFILEN-IUDFKYWT(RE)  INPUT LENGTH PER ITEM                
         BZ    *+6                                                              
         BCTR  RF,0                EXECUTE LENGTH                               
*                                                                               
         L     R0,IUDFID#-IUDFKYWT(RE)      NUMBER OF IDS                       
*                                                                               
OUDFOUTL DS    0H                                                               
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R2)       PRINT DATA                                   
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R3),SPACES      FORCE UPPERCASE                              
*                                                                               
OUDFOUTC DS    0H                                                               
*                                                                               
         LA    R2,1(RF,R2)         POINT TO NEXT PART OF INPUT                  
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OUDFOUT8                                                         
*                                                                               
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R3),SPACES      FORCE UPPERCASE                              
*                                                                               
         LA    R3,1(RF,R3)         BUMP TO NEXT OUTPUT AREA                     
         MVI   0(R3),C' '          INTERVENING SPACE                            
         LA    R3,1(R3)            NEXT AVAILABLE PRINT AREA                    
*                                                                               
         B     OUDFOUT9                                                         
*                                                                               
OUDFOUT8 DS    0H                                                               
*                                                                               
         LA    R3,198(R3)          NEXT PRINT AREA                              
*                                                                               
OUDFOUT9 DS    0H                                                               
*                                                                               
         BCT   R0,OUDFOUTL                                                      
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OUDFX                                                            
*                                                                               
         MVC   NAMEAREA,SPACES     INIT OUTPUT AREA                             
*                                                                               
         LA    RF,OUDFWORK         CALCULATE LENGTH OF OUTPUT                   
         SR    R3,RF                                                            
*                                                                               
         GOTO1 SQUASHER,DMCB,OUDFWORK,(R3)  SQUASH OUTPUT                       
*                                                                               
         ICM   RF,15,DMCB+4        GET NEW LENGTH                               
         BZ    OUDFOUTA            SKIP IF NONE                                 
*                                                                               
         CHI   RF,L'NAMEAREA       CAN'T BE BIGGER THAN NAMEAREA                
         BNH   *+8                                                              
         LHI   RF,L'NAMEAREA                                                    
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   NAMEAREA(0),OUDFWORK  PRINT UDEF VALUES                          
*                                                                               
OUDFOUTA DS    0H                                                               
*                                                                               
OUDFX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
OUDFWORK DS    XL256               WORKAREA                                     
*                                                                               
         DROP  R1                                                               
*                                                                               
         TITLE 'PRWRITER - UNIT RATES - OUTPUT - OUNITRT'                       
***********************************************************************         
*                                                                     *         
*        ROUTINE TO PRINT OPEN UNIT RATE                              *         
*                                                                     *         
*                                                                     *         
*NTRY   0-0    -  C'U' IF A UNIT RATE - REQUIRES 5 DECIMALS           *         
*       1-5    -  UNIT RATE PL5                                       *         
*                                                                     *         
*        DOES NOT PRINT IF NOT A UNIT RATE                            *         
*                                                                     *         
*EXIT   0-9    -  REFENCE NUMBER                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OUNITRT  NMOD1 0,**#OUNRT                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             ESTABLISH BUY RECORD                         
         USING PBUYRECD,R4                                                      
*                                                                               
         L     R1,GLADTENT         POINT TO DRIVE TABLE ENTRY                   
         USING DROD,R1             ESTABLISH AS OUTPUT ELEMENT                  
*                                                                               
         MVI   DRODEC,5            DEFAULT TO 5 DECIMALS                        
*                                                                               
         CLI   0(R2),C'U'          SKIP IF NOT A  UNIT RATE                     
         BNE   OUNITRTX                                                         
*                                                                               
         MVI   0(R2),0             KILL UNIT RATE INDICATOR                     
*                                                                               
         MVI   GLHOOK,GLEDIT       TELL DRIVER TO EDIT                          
*                                                                               
OUNITRTX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R1                                                               
*                                                                               
         TITLE 'PRWRITER - WSJ DATA - INPUT - IWSJ'                             
***********************************************************************         
*                                                                     *         
*        WALL STREET JOURNAL FIELDS - INPUT                           *         
*                                                                     *         
*NTRY   GLARGS  + 0  - C'B' - BUY RECORD DATA                         *         
*                 1  - C'R' - RATE CODES                              *         
*                      C'U' - UNIT RATES                              *         
*                      C'#' - UNITS                                   *         
*                                                                     *         
*EXIT    0(R2)  - 2CL3 FOR RATECODES - COMMON, EXCESS                 *         
*               - 2PL8 FOR UNITRATES - COMMON, EXCESS                 *         
*               - 2PL3 FOR UNITS     - COMMON, EXCESS                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IWSJ     NMOD1 0,**#WSJ                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R4,AIO1             ESTABLISH PBUYREC                            
         USING PBUYRECD,R4                                                      
*                                                                               
         CLI   PBUYKRCD,PBUYKIDQ   SKIP IF NOT DOING A BUY RECORD               
         BNE   IWSJX                                                            
*                                                                               
*        FIND WALL STREET JOURNAL ELEMENT                                       
*                                                                               
         LA    R6,PBDELEM          FIRST ELEMENT IN RECORD                      
         SR    RF,RF                                                            
*                                                                               
IWSJLOOP DS    0H                                                               
*                                                                               
         USING PWSJELD,R6          ESTABLISH WSJ ELEMENT                        
*                                                                               
         CLI   PWSJELEM,0          DONE IF NONE FOUND                           
         BE    IWSJX                                                            
*                                                                               
         CLI   PWSJELEM,PWSJELQ    FOUND IF A WSJ ELEMENT                       
         BE    IWSJLPFD                                                         
*                                                                               
ISWJLPCN DS    0H                                                               
         IC    RF,PWSJELEM+1       ELEMENT LENGTH                               
         LA    R6,PWSJELD(RF)      BUMP TO NEXT ELEMENT                         
         B     IWSJLOOP                                                         
*                                                                               
IWSJLPFD DS    0H                                                               
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+1,C'R'       RATECODES                                    
         BE    IWSJRC                                                           
*                                                                               
         CLI   GLARGS+1,C'U'       UNIT RATES                                   
         BE    IWSJURT                                                          
*                                                                               
         CLI   GLARGS+1,C'#'       UNITS                                        
         BE    IWSJUNT                                                          
*                                                                               
         B     IWSJX               UNKNOWN DATA WANTED                          
*                                                                               
*        RATE CODES - COMMON AND EXCESS TOGETHER                                
*                                                                               
IWSJRC   DS    0H                                                               
*                                                                               
         MVC   0(3,R2),PWSJNRTE    NATIONAL OR COMMON RATE CODE                 
         MVC   3(3,R2),PBDRCODE    EXCESS RATE CODE                             
*                                                                               
         B     IWSJX               DONE                                         
*                                                                               
*        UNIT RATES - COMMON AND EXCESS TOGETHER                                
*                                                                               
IWSJURT  DS    0H                                                               
*                                                                               
         OC    PWSJNCOS,PWSJNCOS   IF NATIONAL RATE PRESENT                     
         BZ    *+10                                                             
         ZAP   0(8,R2),PWSJNCOS       RETURN IT                                 
*                                                                               
         OC    PWSJECOS,PWSJECOS   IF EDITION RATE PRESENT                      
         BZ    *+10                                                             
         ZAP   8(8,R2),PWSJECOS       RETURN IT                                 
*                                                                               
         B     IWSJX                                                            
*                                                                               
*        UNITS - COMMON AND EXCESS TOGETHER                                     
*                                                                               
IWSJUNT  DS    0H                                                               
*                                                                               
         ZAP   0(3,R2),=P'0'       INIT NATIONAL UNITS                          
*                                                                               
         OC    PWSJUNTS,PWSJUNTS   IF NATIONAL UNITS PRESENT                    
         BZ    *+10                                                             
         ZAP   0(3,R2),PWSJUNTS       RETURN IT                                 
*                                                                               
         OC    PWSJUNTS,PWSJUNTS   IF NATIONAL UNITS PRESENT                    
         BZ    IWSJUNTX                                                         
         OC    PBDUNITS,PBDUNITS   IF BUY     UNITS PRESENT                     
         BZ    IWSJUNTX                                                         
*                                                                               
         ZAP   3(3,R2),PBDUNITS       CALCULATE EXCESS UNITS                    
         SP    3(3,R2),PWSJUNTS       AND RETURN IT                             
*                                                                               
IWSJUNTX DS    0H                                                               
         B     IWSJX                                                            
*                                                                               
IWSJX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4,R6                                                            
*                                                                               
         TITLE 'PRWRITER - WSJ DATA - OUTPUT - OWSJ'                            
***********************************************************************         
*                                                                     *         
*        WALL STREET JOURNAL FIELDS - OUTPUT                          *         
*                                                                     *         
*NTRY    0(R2)  - 2CL3 FOR RATECODES - COMMON, EXCESS                 *         
*               - 2PL8 FOR UNITRATES - COMMON, EXCESS                 *         
*               - 2PL3 FOR UNITS     - COMMON, EXCESS                 *         
*                                                                     *         
*EXIT    PRINT COMMON ON FIRST LINE AND EXCESS ON SECOND              *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OWSJ     NMOD1 0,**#WSJ                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         L     R6,GLADTENT         ESTABLISH OUTPUT DESCRIPTION                 
         USING DROD,R6                                                          
*                                                                               
*        INIT EDITOR BLOCK                                                      
*                                                                               
         XC    EBLOCK,EBLOCK       INIT EDITOR BLOCK                            
*                                                                               
         MVI   EBTIN,C'P'          PACKED INPUT                                 
         MVC   EBLOUT,DROLEN       OUTPUT LENGTH                                
*                                                                               
         CLI   DOWNOPT,C'Y'        FORCE ZEROS IF DOWNLOADING                   
         BNE   *+8                                                              
         OI    EBOPT,EBOQZEN          ZEROS NOT REPLACED BY BLANKS              
*                                                                               
         TM    DROEDIT,EBOQZEN                                                  
         BNO   *+8                                                              
         OI    EBOPT,EBOQZEN       PRINT ZEROS IF ASKED                         
*                                                                               
*        DETERMINE DATA WANTED                                                  
*                                                                               
         CLI   GLARGS+1,C'R'       RATECODES                                    
         BE    OWSJRC                                                           
*                                                                               
         CLI   GLARGS+1,C'U'       UNIT RATES                                   
         BE    OWSJURT                                                          
*                                                                               
         CLI   GLARGS+1,C'#'       UNITS                                        
         BE    OWSJUNT                                                          
*                                                                               
         B     OWSJX               UNKNOWN DATA WANTED                          
*                                                                               
*        RATE CODES - COMMON AND EXCESS TOGETHER                                
*                                                                               
OWSJRC   DS    0H                                                               
*                                                                               
         MVC   0(3,R3),0(R2)       NATIONAL OR COMMON RATE CODE                 
         MVC   198(3,R3),3(R2)     EXCESS RATE CODE                             
*                                                                               
         B     OWSJX               DONE                                         
*                                                                               
*        UNIT RATES - COMMON AND EXCESS TOGETHER                                
*                                                                               
OWSJURT  DS    0H                                                               
*                                                                               
         OC    0(8,R2),0(R2)       IF NATIONAL RATE PRESENT                     
         BZ    OWSJURT1                                                         
*                                                                               
         ST    R2,EBAIN            A(INPUT)                                     
         ST    R3,EBAOUT           A(OUTPUT)                                    
         MVI   EBLIN,8             INPUT LENGTH                                 
         MVI   EBDECS,5            5 DECIMALS                                   
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK   PRINT IT                                  
*                                                                               
OWSJURT1 DS    0H                                                               
*                                                                               
         OC    8(8,R2),8(R2)       IF EDITION RATE PRESENT                      
         BZ    OWSJURT2                                                         
*                                                                               
         LA    RF,8(R2)                                                         
         ST    RF,EBAIN            A(INPUT)                                     
         LA    RF,198(R3)                                                       
         ST    RF,EBAOUT           A(OUTPUT)                                    
         MVI   EBLIN,8             INPUT LENGTH                                 
         MVI   EBDECS,5            5 DECIMALS                                   
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK   PRINT IT                                  
*                                                                               
OWSJURT2 DS    0H                                                               
*                                                                               
         B     OWSJX                                                            
*                                                                               
*        UNITS - COMMON AND EXCESS TOGETHER                                     
*                                                                               
OWSJUNT  DS    0H                                                               
*                                                                               
         OC    0(3,R2),0(R2)       IF NATIONAL UNIT PRESENT                     
         BZ    OWSJUNT1                                                         
*                                                                               
         ST    R2,EBAIN            A(INPUT)                                     
         ST    R3,EBAOUT           A(OUTPUT)                                    
         MVI   EBLIN,3             INPUT LENGTH                                 
         MVI   EBDECS,0            0 DECIMALS                                   
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK   PRINT IT                                  
*                                                                               
OWSJUNT1 DS    0H                                                               
*                                                                               
         OC    3(3,R2),3(R2)       IF EDITION UNIT PRESENT                      
         BZ    OWSJUNT2                                                         
*                                                                               
         LA    RF,3(R2)                                                         
         ST    RF,EBAIN            A(INPUT)                                     
         LA    RF,198(R3)                                                       
         ST    RF,EBAOUT           A(OUTPUT)                                    
         MVI   EBLIN,3             INPUT LENGTH                                 
         MVI   EBDECS,0            0 DECIMALS                                   
*                                                                               
         GOTO1 GLAEDITR,DMCB,EBLOCK   PRINT IT                                  
*                                                                               
OWSJUNT2 DS    0H                                                               
*                                                                               
         B     OWSJX                                                            
*                                                                               
OWSJX    DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R6                                                               
*                                                                               
         TITLE 'PRWRITER - PUB ZONE  - INPUT - IZONE'                           
***********************************************************************         
*                                                                     *         
*        PUB ZONE CODE AND/OR NAME                                    *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
IZONE    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        FIND CODE TO PRINT                                                     
*                                                                               
         L     R4,AIO3             ESTABLISH PUBREC                             
         USING PUBREC,R4                                                        
*                                                                               
         CLI   GLARGS+1,C'S'       SKIP IF NAME ONLY WANTED                     
         BE    *+8                                                              
         CLI   GLARGS+1,C'N'                                                    
         BE    *+12                                                             
         CLI   PUBKZON,0              SKIP IF NO ZONE PRESENT                   
         BE    IZONEX                                                           
*                                                                               
         UNPK  FULL(3),PUBKZON(2)  TRANSLATE TO HEX-ALPHA                       
         TR    FULL(2),IZONETBL-C'0'                                            
*                                                                               
         CLI   GLARGS+1,C'S'       SKIP IF SORTING ON ZONE NAME                 
         BE    *+10                                                             
         MVC   0(2,R2),FULL                                                     
*                                                                               
         CLI   GLARGS+1,C'C'       DONE IF CODE ONLY WANTED                     
         BE    IZONEX                                                           
*                                                                               
         MVC   22(2,R2),FULL                                                    
*                                                                               
*        FIND ZONE NAME IN PUBANEML                                             
*                                                                               
         LA    R6,PUBREC+33        POINT TO FIRST PUBREC ELEMENT                
         USING PUBNAMEL,R6         ESTABLISH PUBNAME ELEMENT                    
         SR    RF,RF                                                            
*                                                                               
IZONELP  DS   0H                                                                
*                                                                               
         CLI   PUBNAMEL,0          DONE AT END OF RECORD                        
         BE    IZONEDN                                                          
*                                                                               
         CLI   PUBNAMEL,X'10'      FIND PUBNAMEL                                
         BE    IZONEFD                                                          
*                                                                               
IZONECCN DS   0H                                                                
*                                                                               
         IC    RF,PUBNAMEL+1       ELEMENT LENGTH                               
         LA    R6,0(RF,R6)         POINT TO NEXT ELEMENT                        
         B     IZONELP                                                          
*                                                                               
IZONEFD  DS    0H                                                               
*                                                                               
         MVC   2(L'PUBZNAME,R2),PUBZNAME   RETURN ZONE NAME                     
*                                                                               
IZONEDN  DS   0H                                                                
*                                                                               
IZONEX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
         DS    XL128               TO GET TABLE 256 PAST MODULE START           
IZONETBL DC    C'0123456789ABCDEF' HEX CONVERSION TABLE                         
*                                                                               
         DROP  R4,R6                                                            
*                                                                               
         TITLE 'PRWRITER - ADITIONAL CHARGES  - OUTPUT - OZONE'                 
***********************************************************************         
*                                                                     *         
*        PUB ZONE CODE/NAME                                           *         
*                                                                     *         
*NTRY                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
OZONE    NTR1  BASE=*,LABEL=*                                                   
*                                                                               
*        BUILD LABEL AREA FOR TOTALS AND HEADLINES                              
*                                                                               
         MVC   LABLAREA,SPACES     INIT OUTPUT AREAS                            
         MVC   CODEAREA,SPACES                                                  
         MVC   NAMEAREA,SPACES                                                  
*                                                                               
         TM    GLINDS,GLTOTLIN     IF DOING TOTALS                              
         BO    *+12                                                             
         CLI   MYPOSO,C'H'         OR HEADLINE                                  
         BNE   OZONELBX                                                         
*                                                                               
         GOTOR BLDLBL              BUILD LABEL AREA                             
*                                                                               
OZONELBX DS   0H                                                                
*                                                                               
         CLI   GLARGS+1,C'B'       IF CODE WANTED                               
         BE    *+8                                                              
         CLI   GLARGS+1,C'C'                                                    
         BNE   *+10                                                             
         MVC   CODEAREA(2),0(R2)   PRINT IT                                     
*                                                                               
         CLI   GLARGS+1,C'B'       IF DESCRIPTION WANTED                        
         BE    *+8                                                              
         CLI   GLARGS+1,C'N'                                                    
         BE    *+8                                                              
         CLI   GLARGS+1,C'S'                                                    
         BNE   *+10                                                             
         MVC   NAMEAREA(L'PUBZNAME),2(R2)   PRINT IT                            
*                                                                               
OZONEX   DS    0H                                                               
         GOTO1 GENOUTA                                                          
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - BUILD INVOICE NUMBER - BLDINV'                       
***********************************************************************         
*                                                                     *         
*        ROUTINE TO BUILD INVOICE NUMBER                              *         
*                                                                     *         
*NTRY P1+0-  C'B' - BILL RECORD PRESENT                                         
*     P1  -  INVOICE DATE YYMMDD - BINARY                                       
*            INVOICE NUMBER  2 BYTES BINARY                           *         
*                                                                     *         
*     P2 -   RETURN AREA                                              *         
*                                                                     *         
* HOB P3  -  C'O' CLIENT OFFICE PRESENT AFTER MEDIA & CLIENT          *         
*     P3  -  MEDIA & CLIENT                                           *         
*                                                                     *         
*     P4  -  A(BILL RECORD IF P1+0 IS C'B')                           *         
*                                                                     *         
*EXIT    7 BYTE INVOICE NUMBER                                        *         
*        8 OR 10 BYTE FULL INVOICE NUMBER                             *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
BLDINV   NMOD1 0,**#BIV                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         MVC   BIVDMCB,0(R1)       SAVE INPUT PARAMETERS                        
         ST    R1,BIVREG1S         SAVE PARAMETER REGISTER                      
*                                                                               
         L     R2,0(R1)            POINT TO INPUT INFORMATION                   
*                                                                               
         OC    0(5,R2),0(R2)       MAKE SURE WE HAVE INPUT                      
         BZ    BLDINVX                                                          
*                                                                               
         L     R4,8(R1)            POINT TO INPUT MEDIA/CLIENT                  
*                                                                               
*        READ B1 PROFILE                                                        
*                                                                               
         XC    BLDIVWRK,BLDIVWRK   PARAMETERS FOR GETPROF                       
*                                                                               
         MVC   BLDIVWRK(4),=C'P0B1' B1X PROFILE                                 
         MVC   BLDIVWRK+4(2),PBQAGY AGENCY                                      
         MVC   BLDIVWRK+6(1),0(R4) MEDIA                                        
         MVC   BLDIVWRK+7(3),1(R4) CLIENT                                       
*                                                                               
*        CHECK IF OFFICE KNOWN                                                  
*                                                                               
         CLI   PBQCLT,C'*'         IF REQUESTED BY OFFICE                       
         BNE   *+14                                                             
         MVC   BLDIVWRK+11(1),PBQCLT+1   USE IT                                 
         B     BIVOFC9                                                          
*                                                                               
         CLI   PBCOFF,C' '        IF CLIENT OFFICE KNOWN USE IT                 
         BNH   *+10                                                             
         MVC   BLDIVWRK+11(1),PBCOFF   CLIENT OFFICE CODE                       
*                                                                               
         CLI   PBQSLAVE,C'Y'         IF DOING SLAVES                            
         BNE   BIVOFC9                                                          
*                                                                               
         ICM   RF,15,PBCLTADR           POINT TO CLIENT RECORD                  
         BZ    BIVSLVX                  NOT KNOWN                               
*                                                                               
         USING PCLTRECD,RF                                                      
*                                                                               
         CLI   PCLTOFF,C' '       IF CLIENT OFFICE KNOWN                        
         BNH   *+10                  USE IT                                     
         MVC   BLDIVWRK+11(1),PCLTOFF  SLAVE OFFICE CODE                        
*                                                                               
         DROP  RF                                                               
*                                                                               
BIVSLVX  DS    0H                                                               
*                                                                               
BIVOFC9  DS    0H                                                               
*                                                                               
         LA    RF,BIVDMCB          POINT TO SAVED PARAMETER LIST                
         CLI   8(RF),C'O'          OFFICE PASSED IN IN P3?                      
         BNE   BIVOFC10            NO                                           
         L     R4,8(R1)            POINT TO INPUT MEDIA/CLIENT/OFFICE           
         MVC   BLDIVWRK+11(1),4(R4) CLIENT OFFICE CODE                          
*                                                                               
BIVOFC10 CLI   BLDIVWRK+11,C' '  IF OFFICE PRESENT                              
         BNH   *+8                                                              
         MVI   BLDIVWRK+10,C'*'     INDICATE IN PARAMETERS                      
*                                                                               
BIVOFCX  DS    0H                                                               
*                                                                               
         CLC   BIVKEY,BLDIVWRK     SKIP IF PROFILE ALREADY IN CORE              
         BE    BIVRDX                                                           
*                                                                               
         MVC   BIVKEY,BLDIVWRK     SAVE PROFILE                                 
*                                                                               
         XC    BIVPRO,BIVPRO       SPECIAL BILLING PROFILE                      
*                                                                               
         GOTO1 GETPROF,DMCB,BLDIVWRK,BIVPRO,DATAMGR                             
*                                                                               
BIVRDX   DS    0H                                                               
*                                                                               
*        READ B1X PROFILE                                                       
*                                                                               
         XC    BLDIVWRK,BLDIVWRK   PARAMETERS FOR GETPROF                       
*                                                                               
         MVC   BLDIVWRK(4),=C'PB1X' B1X PROFILE                                 
         NI    BLDIVWRK,X'FF'-X'40' LOWER CASE                                  
         MVC   BLDIVWRK+4(2),PBQAGY AGENCY                                      
         MVC   BLDIVWRK+6(1),0(R4) MEDIA                                        
         MVC   BLDIVWRK+7(3),1(R4) CLIENT                                       
*                                                                               
*        CHECK IF OFFICE KNOWN                                                  
*                                                                               
         CLI   PBQCLT,C'*'         IF REQUESTED BY OFFICE                       
         BNE   *+14                                                             
         MVC   BLDIVWRK+11(1),PBQCLT+1   USE IT                                 
         B     BIVROFC9                                                         
*                                                                               
         CLI   PBCOFF,C' '        IF CLIENT OFFICE KNOWN USE IT                 
         BNH   *+10                                                             
         MVC   BLDIVWRK+11(1),PBCOFF   CLIENT OFFICE CODE                       
*                                                                               
         CLI   PBQSLAVE,C'Y'         IF DOING SLAVES                            
         BNE   BIVROFC9                                                         
*                                                                               
         ICM   RF,15,PBCLTADR           POINT TO CLIENT RECORD                  
         BZ    BIVRSLVX                  NOT KNOWN                              
*                                                                               
         USING PCLTRECD,RF                                                      
*                                                                               
         CLI   PCLTOFF,C' '       IF CLIENT OFFICE KNOWN                        
         BNH   *+10                  USE IT                                     
         MVC   BLDIVWRK+11(1),PCLTOFF  SLAVE OFFICE CODE                        
*                                                                               
         DROP  RF                                                               
*                                                                               
BIVRSLVX DS    0H                                                               
*                                                                               
BIVROFC9 DS    0H                                                               
*                                                                               
         LA    RF,BIVDMCB          POINT TO SAVED PARAMETER LIST                
         CLI   8(RF),C'O'          OFFICE PASSED IN IN P3?                      
         BNE   BIVROFCA            NO                                           
         L     R4,8(R1)            POINT TO INPUT MEDIA/CLIENT/OFFICE           
         MVC   BLDIVWRK+11(1),4(R4) CLIENT OFFICE CODE                          
*                                                                               
BIVROFCA CLI   BLDIVWRK+11,C' '  IF OFFICE PRESENT                              
         BNH   *+8                                                              
         MVI   BLDIVWRK+10,C'*'     INDICATE IN PARAMETERS                      
*                                                                               
BIVROFCX DS    0H                                                               
*                                                                               
         CLI   PBQCLT,C'*'         OFFICE REQUESTED                             
         BNE   *+10                                                             
         MVC   BLDIVWRK+10(2),PBQCLT                                            
*                                                                               
         CLC   BIVXKEY,BLDIVWRK     SKIP IF PROFILE ALREADY IN CORE             
         BE    BIVREADX                                                         
*                                                                               
         MVC   BIVXKEY,BLDIVWRK     SAVE PROFILE                                
*                                                                               
         XC    BIVPROX,BIVPROX      SPECIAL BILLING PROFILE                     
*                                                                               
         GOTO1 GETPROF,DMCB,BLDIVWRK,BIVPROX,DATAMGR                            
*                                                                               
*        BIVPROX+4   NOW HAS 'BASE' YEAR FOR INV MONTH DISPLAY                  
*        BIVPROX+5   ADD THIS MUNBER TO INVOICE MONTH                           
*                                                                               
BIVREADX DS    0H                                                               
*                                                                               
         GOTO1 DATCON,DMCB,(3,0(R2)),DUB  MAKE YYMMDD                           
*                                                                               
         LA    RF,BIVDMCB          POINT TO SAVED PARAMETER LIST                
*                                                                               
         CLI   0(RF),C'B'          IF BILL RECORD PRESENT                       
         BNE   BIVBRECN                                                         
*                                                                               
         L     RF,12(RF)              POINT TO INVOICE RECORD                   
*                                                                               
         GOTO1 =V(PPFMTINO),DMCB,(C'B',DUB),(2,3(R2)),(0(R4),BIVPRO),  X        
               BIVPROX,(RF)                                                     
*                                                                               
         L     R1,DMCB             POINT TO INVOICE NUMBER                      
*                                                                               
         L     R3,BIVDMCB+4        POINT TO OUTPUT AREA                         
*                                                                               
         CLI   GLARGS+3,C'1'       IF FULL INVOICE # WANTED                     
         BNE   *+14                                                             
         MVC   0(10,R3),0(R1)         RETURN INVOICE NUMBER                     
         B     BLDINVX                                                          
*                                                                               
*        STRIP DASHES FROM INVOICE NUMBER                                       
*                                                                               
         LR    RF,R1               POINT TO START OF INV NUMBER                 
         LA    R0,10               MAX 10 CHARACTERS                            
         LR    RE,R3               START OF RETURN AREA                         
*                                                                               
         CLI   0(RF),C'-'          SKIP DASHES                                  
         BE    *+14                                                             
         MVC   0(1,RE),0(RF)       COPY INV # TO RETURN AREA                    
         LA    RE,1(RE)            BUMP POINTERS                                
*                                                                               
         LA    RF,1(RF)                                                         
         BCT   R0,*-22                                                          
*                                                                               
         B     BLDINVX                                                          
*                                                                               
BIVBRECN DS    0H                                                               
*                                                                               
         GOTO1 =V(PPFMTINO),DMCB,DUB,(2,3(R2)),(0(R4),BIVPRO),         X        
               BIVPROX                                                          
*                                                                               
         L     R1,DMCB+4           POINT TO INVOICE NUMBER                      
*                                                                               
         L     R3,BIVDMCB+4        POINT TO OUTPUT AREA                         
*                                                                               
         CLI   GLARGS+3,C'L'       SKIP IF LABATT'S FORMAT                      
         BE    BIVLAB                                                           
         CLI   GLARGS+3,C'V'       SKIP IF LABATT'S VOUCHER                     
         BE    BIVLAB                                                           
*                                                                               
         MVC   0(7,R3),0(R1)       RETURN INVOICE NUMBER                        
*                                                                               
         B     BLDINVX                                                          
*                                                                               
BIVLAB   DS    0H                  SPECIAL FORMATTING FOR LABATT'S              
*                                                                               
         CLI   GLARGS+3,C'V'       IF VOUCHER #                                 
         BNE   *+12                                                             
         MVI   0(R3),C'J'             PREFACE WITH 'J'                          
         AHI   R3,1                   BUMP OUTPUT POINTER                       
*                                                                               
         MVC   0(2,R3),0(R1)       MONTH                                        
         MVC   2(4,R3),3(R1)       BILL NUMBER                                  
*                                                                               
BLDINVX  DS    0H                                                               
*                                                                               
         L     R1,BIVREG1S         RESTORE INCOMING PARAMETER LIST              
         MVC   0(L'BIVDMCB,R1),BIVDMCB                                          
*                                                                               
         XIT1  ,                                                                
*                                                                               
BIVHEXTB DC    C'0123456789ABCDEF'  HEX TRANSLATE TABLE                         
*                                                                               
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
BLDIVWRK DS    XL32                WORKAREA                                     
BIVREG1S DS    F                   PARAMETER LIST POINTER SAVE                  
BIVDMCB  DS    XL24                PARAMETER LIST SAVEAREA                      
BIVPRO   DS    XL16                BILLING 1 PROFILE                            
BIVKEY   DS    CL12                BILLING 1 PROFILE KEY (AGY/MEDIA)            
BIVPROX  DS    XL16                BILLING 1X PROFILE                           
BIVXKEY  DS    CL12                BILLING 1X PROFILE KEY (AGY/MEDIA)           
*                                                                               
         TITLE 'PRWRITER - BUILD LABEL AREA - BLDLBL'                           
***********************************************************************         
*                                                                     *         
*        ROUTINE TO BUILD HEADER LABEL FROM HEADLINES                 *         
*                                                                     *         
*NTRY                                                                           
*                                                                     *         
*EXIT    LABLAREA HAS LABEL BUILT FROM COLUMN HEADINGS                *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
BLDLBL   NMOD1 0,**#BLDLB                                                       
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
*        BUILD LABEL AREA FOR HEADLINES                                         
*                                                                               
         L     R4,GLADTENT         DRIVE TABLE ENTRY                            
*                                                                               
         CLI   0(R4),X'30'         IF NOT AN OUTPUT ELEMENT                     
         BE    BLDLBL1                                                          
*                                                                               
*                                     WE HAVE TOTAL ELEMENT AND NEED TO         
*                                     FIND CORRESPONDING OUTPUT ELEMENT         
*                                     IT WILL BE BEFORE TOTAL ELEMENT           
*                                                                               
         L     R4,GLADTAB          POINT TO START OF DRIVE TABLE                
*                                                                               
         SR    R1,R1               INIT ELEMENT OUTPUT ELEMENT POINTER          
         SR    RF,RF                                                            
*                                                                               
BLDLBL1L DS    0H                                                               
*                                                                               
         CLI   0(R4),X'30'         LOOK FOR OUTPUT TABLE ENTRY                  
         BNE   *+6                                                              
         LR    R1,R4               SAVE ELEMENT ADDRESS                         
*                                                                               
BLDLBL1C DS    0H                                                               
*                                                                               
         IC    RF,1(R4)            LENGTH OF ENTRY                              
         LA    R4,0(RF,R4)         BUMP TO NEXT ENTRY                           
*                                                                               
         CLM   R4,15,GLADTENT      STOP WHEN CURRENT ENTRY REACHED              
         BL    BLDLBL1L                                                         
*                                                                               
         LTR   R4,R1               USE THIS FLD'S OUTPUT ELM                    
         BZ    BLDLBLX             EXIT IF NOT FOUND                            
*                                                                               
BLDLBL1  DS    0H                                                               
*                                                                               
         LA    R0,L'LABLAREA       LABEL AREA LENGTH                            
         LA    R1,LABLAREA         POINT TO LABEL AREA                          
         SR    RF,RF                                                            
*                                                                               
BLBLLP   DS    0H                                                               
*                                                                               
         USING DRHDD,R4            ESTABLISH AS HEAD ELEMENT                    
         IC    RF,DRHDELEN         RECORD ELEMENT LENGTH                        
         LA    R4,0(RF,R4)         BUMP TO NEXT DRIVER RECORD                   
*                                                                               
         CLI   DRHDEL,X'40'        LOOKING FOR HEAD ELEMENTS                    
         BNE   BLBLDN              END OF HEADS FOUND                           
*                                                                               
         IC    RF,DRHDELEN         RECORD ELEMENT LENGTH                        
         SH    RF,=Y(DRHDLIT-DRHDD)   HEAD LITERAL LENGTH                       
         BNP   BLBLCN              SKIP IF NO LITERAL AVAILABLE                 
*                                                                               
         LA    R2,DRHDLIT          POINT TO LITERAL                             
*                                                                               
         CLI   0(R2),C' '          ELIMINATE LEADING BLANKS                     
         BH    *+16                                                             
         LA    R2,1(R2)            BUMP TO NEXT CHARACTER                       
         BCT   RF,*-12                                                          
         B     BLBLCN              ALL BLANKS                                   
*                                                                               
*        R2==> START OF PARED DOWN HEAD, RF = LENGTH                            
*                                                                               
         SR    R0,RF               DECREMENT ROOM LEFT COUNTER                  
         BM    BLBLDN              STOP IF NO ROOM AVAILABLE                    
*                                                                               
         BCTR  RF,0                DECREMENT FOR EXECUTE                        
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R1),0(R2)       ADD HEAD LITERAL TO LABEL                    
*                                                                               
         LTR   R0,R0               STOP IF AT END OF LABEL AREA                 
         BNP   BLBLDN                                                           
*                                                                               
         LA    R1,1(RF,R1)         BUMP TO END OF LABEL                         
*                                                                               
         MVI   0(R1),C' '          SEPARATE PARTS WITH A SPACE                  
         LA    R1,1(R1)            BUMP TO NEXT AVAILABLE SPACE                 
*                                                                               
BLBLCN   DS    0H                                                               
*                                                                               
         B     BLBLLP                                                           
*                                                                               
BLBLDN   DS    0H                                                               
*                                                                               
BLDLBLX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         DROP  R4                                                               
*                                                                               
         TITLE 'PRWRITER - FILTER BILLED - FLTBLD'                              
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FILTER INSERTIONS ON BILLED STATUS                *         
*                                                                     *         
* NTRY   R6 ==>  BILLING ELEMENT                                      *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
FLTBLD   NMOD1 0,**#FBL                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         CLC   PBQPRD,=C'ALL'   ACCEPT IF DOING ALL PRODUCTS                    
         BE    *+10                                                             
         CLC   PBQPRD,2(R6)     ELSE MUST MATCH REQUESTED PRODUCT               
         BNE   FBLDROP                                                          
*                                                                               
         TM    PBQPOPT,PBQPOBIL ACCEPT IF PAID OR BILLED SELECT                 
         BNO   FBLOK                 NOT ON                                     
*                                                                               
         CLI   PBQDATYP,C'L'    CONTINUE IF FILTERING ON BILLED DATES           
         BE    *+8                                                              
         CLI   PBQFLTDA,C'B'    OR BILLED IS A SECONDARY FILTER                 
         BNE   FBLOK               ELSE ACCEPT                                  
*                                                                               
*        BILLING ELEMENT MUST BE IN REQUEST PERIOD                              
*                                                                               
         CLC   PBQBST,5(R6)        MUST BE AFTER START DATE                     
         BH    FBLDROP                                                          
         CLC   PBQBEND,5(R6)       MUST BE BEFORE END DATE                      
         BL    FBLDROP                                                          
*                                                                               
         B     FBLOK               ACCEPT ELEMENT                               
*                                                                               
FBLDROP  DS    0H                                                               
         LTR   RB,RB               ^= CC                                        
         B     FLTBILX                                                          
*                                                                               
FBLOK    DS    0H                                                               
         CR    RE,RE               = CC                                         
*                                                                               
FLTBILX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - FILTER PAID - FLTPD'                                 
***********************************************************************         
*                                                                     *         
*        ROUTINE TO FILTER INSERTIONS ON PAID STATUS                  *         
*                                                                     *         
* NTRY   R6 ==>  PAY ELEMENT                                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
FLTPD    NMOD1 0,**#FPD                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         TM    PBQPOPT,PBQPOBIL ACCEPT IF PAID OR BILLED SELECT                 
         BNO   FPDOK                 NOT ON                                     
*                                                                               
         CLI   PBQDATYP,C'A'    CONTINUE IF FILTERING ON PAID DATES             
         BE    *+8                                                              
         CLI   PBQFLTDA,C'P'    OR PAID IS A SECONDARY FILTER                   
         BNE   FPDOK               ELSE ACCEPT                                  
*                                                                               
*        PAY ELEMENT MUST BE IN REQUEST PERIOD                                  
*                                                                               
         CLC   PBQBST,2(R6)        MUST BE AFTER START DATE                     
         BH    FPDDROP                                                          
         CLC   PBQBEND,2(R6)       MUST BE BEFORE END DATE                      
         BL    FPDDROP                                                          
*                                                                               
         B     FPDOK               ACCEPT ELEMENT                               
*                                                                               
FPDDROP  DS    0H                                                               
         LTR   RB,RB               ^= CC                                        
         B     FLTPDX                                                           
*                                                                               
FPDOK    DS    0H                                                               
         CR    RE,RE               = CC                                         
*                                                                               
FLTPDX   DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - GENERAL OUTPUT ROUTINE - GENOUT'                     
***********************************************************************         
*                                                                     *         
*                         SHARED OUTPUT ROUTINE                       *         
*                                                                     *         
*NTRY                                                                 *         
*        LABLAREA HAS PREFIX                                          *         
*        CODEAREA HAS CODE                                            *         
*        NAMEAREA HAS NAME                                            *         
*                                                                     *         
*EXIT                                                                 *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
GENOUTR  NMOD1 0,**#GOUT                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         TM    GLINDS,X'40'        TOTALS ARE DEALT WITH BELOW    L03           
         BO    TOTOUT                                             L03           
*                                                                               
         CLI   MYLTYP,C'H'         FOR HEADLINES, MOVE OUT THE LOT              
         BNE   GN10                                                             
*                                                                               
         TM    GLDOWNLD,GLDLACTV+GLDLHEAD  SKIP TITLE IF DOWNLOAD               
         BO    GN10                                                             
*                                                                               
         MVC   0(L'OUTAREA,R3),OUTAREA                                          
*                                                                               
         B     GENOUTX                                                          
*                                                                               
GN10     OC    CODENNAM,SPACES     MAKE OUTPUT UPPERCASE                        
*                                                                               
         L     RF,SQUASHER                                                      
         GOTO1 (RF),DMCB,CODENNAM,49                                            
*                                                                               
         TM    PBQPOPT,PBQPOCUT                                                 
         BNO   NOCUTA                                                           
*                                                                               
         ZIC   RF,MYOLEN                                                        
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),CODENNAM                                                 
*                                                                               
         B     GENOUTX                                                          
*                                                                               
NOCUTA   LA    R1,CODENNAM         SET UP FOR CHOPPER                           
*                                                                               
         CLI   MYOLEN,1            IF ONE BYTE OUTPUT                           
         BNE   GN20                                                             
         MVC   0(1,R3),CODEAREA    MOVE ON OUT                                  
*                                                                               
         B     GENOUTX                                                          
*                                                                               
GN20     DS    0H                                                               
*                                                                               
         ST    R1,DMCB             A(INPUT)                                     
         MVI   DMCB,49             L'INPUT                                      
         ST    R3,DMCB+4           A(OUTPUT)                                    
         MVC   DMCB+4(1),MYOLEN    LENGTH OF OUTPUT                             
         LA    R1,4                MAX N'LINES                                  
         ST    R1,DMCB+8                                                        
         MVI   DMCB+8,198          PRINT LINES ARE 198 APART                    
*                                                                               
         GOTO1 CHOPPER,DMCB                                                     
*                                                                               
         B     GENOUTX                                                          
*                                                                               
*--------------->    SHARED TOTAL ROUTINE <--------------------                 
*                                                                               
*              AT THIS STAGE...    LABLAREA HAS PREFIX                          
*                                  CODEAREA HAS CODE                            
*                                  NAMEAREA HAS NAME                            
*              INPUT               NDROW1WD NDROWWID                            
*                                                                               
TOTOUT   DS    0H                                                 L03           
*                                                                               
         GOTO1 =A(COMMON1),DMCB,48       TOTAL ROUTINES           L03           
*                                                                               
GENOUTX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - BUILDS COMMENT TABLE - GETCOM'                       
***********************************************************************         
*                                                                     *         
*        BUILDS A COMMENT IN A TABLE AND OPTIONALLY SQUASHES IT       *         
*                                                                     *         
*NTRY                                                                 *         
*        PARMS+0  - COMMENT ELEMENT IDENTIFIER                        *         
*        PARMS+1-3- A(RECORD KEY)                                     *         
*                                                                     *         
*        PARM1+0  - SE NUMBER                                         *         
*        PARM1+1-3- A('NOSQ') FOR NO SQUASHING OPTION                 *         
*                                                                     *         
*EXIT                                                                 *         
*        PARM2+0-3- A(TABLE OF COMMENTS)                              *         
*        PARM3+0-3- COMMENT LENGTH                                    *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
GETCOM   NMOD1 160,**#GCOM                                                      
*                                                                               
         ST    RC,GCOMCOMA         SET COMMENT RECORD AREA ADDRESS              
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         ST    R1,GCOMPRMA         SAVE PARAMETER LIST POINTER                  
         MVC   GCOMPRMS,0(R1)      SAVE PARAMETERS                              
*                                                                               
         L     R4,GCOMTBLA         POINT TO COMMENT TABLE                       
*                                                                               
         ST    R4,GCOMNXTA         INIT ADDRESS OF NEXT COMMENT                 
*                                                                               
         MVI   0(R4),C' '          INIT COMMENT TABLE TO SPACES                 
         LA    R1,GCOMTBLL-1                                                    
         MOVE  (1(R4),(R1)),0(R4)                                               
*                                                                               
*        FIND COMMENT ELEMENTS IN TABLE                                         
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR CLIENT OF AOR SITUATION                   
         BNE   GCOM10                                                           
*                                                                               
         ICM   RF,15,PBUTLA           RESET UTL                                 
         BZ    GCOM10                    NO ADDRESS GIVEN                       
*                                                                               
         MVC   GCOMSESV,4(RF)            SAVE CURRENT SE                        
         MVC   4(1,RF),GCOMSE         WITH PASSED SE                            
*                                                                               
GCOM10   DS    0H                                                               
*                                                                               
         MVC   GCOMLOW,GCOMELID    TYPE OF COMMENT ASKED FOR                    
         MVC   GCOMHIGH,GCOMELID                                                
*                                                                               
         CLI   GCOMELID,X'FF'      IF ALL COMMENTS WANTED                       
         BNE   *+12                                                             
         MVI   GCOMLOW,X'66'          SET BUY LOWEST  COMMENT ID                
         MVI   GCOMHIGH,X'69'         SET BUY HIGHEST COMMENT ID                
*                                                                               
         L     R6,GCOMRECA                                                      
         LA    R6,33(R6)                                                        
*                                                                               
GCOMLOOP DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE IF END OF RECORD REACHED                
         BE    GCOMLPDN                                                         
*                                                                               
         CLC   0(1,R6),GCOMLOW     FIND DESIRED ELEMENT                         
         BL    GCOMLPCN                                                         
         CLC   0(1,R6),GCOMHIGH    FIND DESIRED ELEMENT                         
         BH    GCOMLPCN                                                         
*                                                                               
         CLI   1(R6),2             SKIP IF NO DATA?                             
         BNH   GCOMLPCN                                                         
*                                                                               
         CLC   2(4,R6),=C'COM='    IF  NOT STANDARD COMMENT                     
         BE    GCOMSTD                                                          
         CLI   0(R6),X'30'         AND NOT CONTRACT STANDARD COMMENT            
         BE    GCOMSTD                                                          
*                                                                               
         L     R4,GCOMNXTA            SAVE COMMENT IN TABLE                     
         ZIC   R5,1(R6)                  ELEMENT LENGTH                         
         SH    R5,=H'3'                  EXECUTE LENGTH OF COMMENT              
*                                                                               
         LA    RF,2(R6)            POINT TO COMMENT TEXT                        
*                                                                               
         CLC   =C'E+',0(RF)        IF COMMENT STARTS WITH 'E+'                  
         BNE   *+12                                                             
         SH    R5,=H'2'               DECREMENT TEXT LENGTH                     
         LA    RF,2(RF)               BUMP TEXT POINTER                         
*                                                                               
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R4),0(RF)                                                    
*                                                                               
         LA    R4,2(R5,R4)           BUMP POINTER TO NEXT TABLE ENTRY           
         ST    R4,GCOMNXTA           FORCE SPACE BETWEEN COMMENTS               
*                                                                               
         B     GCOMLPCN                                                         
*                                                                               
GCOMSTD  DS    0H                  STANDARD COMMENT                             
*                                                                               
         ST    R6,GCOMELMA         SAVE COMMENT ELEMENT POINTER                 
*                                                                               
         L     RF,GCOMRECA         POINT TO PASSED RECORD                       
*                                                                               
         XC    KEY,KEY                                                          
*                                                                               
         MVC   KEY(3),0(RF)        AGENCY MEDIA                                 
         MVI   KEY+3,X'40'         COMMENT RECORD IDENTIFIER                    
*                                                                               
         ZIC   R5,1(R6)            ELEMENT LENGTH                               
         SH    R5,=H'2'            REDUCE BY CODE,LEN                           
         BNP   GCOMLPCN               NO NUMBER                                 
         LA    RF,2(R6)            POINT TO START OF COMMENT                    
*                                                                               
         CLI   0(R6),X'30'         IF NOT CONTRACT STANDARD COMMENT             
         BE    *+16                                                             
         SH    R5,=H'4'               REDUCE BY COM=                            
         BNP   GCOMLPCN               NO NUMBER                                 
         LA    RF,4(RF)               POINT TO START OF COMMENT                 
*                                                                               
*        STRIP TRAILING BLANKS FROM COMMENT CODE                                
*        ADBUYER PRODUCES SOME TRAILING BLANKS                                  
*                                                                               
         LA    RE,0(R5,RF)         POINT TO LAST CH IN CODE                     
         BCTR  RE,0                                                             
*                                                                               
         CLI   0(RE),C' '          DONE IF NON-BLANK                            
         BH    *+16                                                             
         SHI   RE,1                BACK UP A BYTE                               
         BCT   R5,*-12                                                          
         B     GCOMLPCN               NO NUMBER                                 
*                                                                               
         MVC   WORK(10),SPACES                                                  
         LA    RE,WORK+6                                                        
         SR    RE,R5                                                            
*                                                                               
         BCTR  R5,0                RIGHT JUSTIFY                                
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,RE),0(RF)          STANDARD COMMENT NUMBER                   
                                                                                
         MVC   KEY+4(6),WORK          STANDARD COMMENT NUMBER                   
*                                                                               
         GOTO1 HIGH                                                             
*                                                                               
         CLC   KEY(12),KEYSAVE                                                  
         BE    *+6                                                              
         DC    H'0'                STND COMMENT NOT FOUND                       
*                                                                               
         MVC   GCOMAIOS,AIO        SAVE CURRENT IO AREA ADDRESS                 
*                                                                               
         MVC   AIO,GCOMCOMA        SET UP WHERE REC IS TO BE READ               
*                                                                               
         GOTO1 GETREC                                                           
*                                                                               
         MVC   AIO,GCOMAIOS        RESTORE CURRENT IO AREA ADDRESS              
*                                                                               
         MVC   KEY,IOKEYSVE        RESTORE POINTERS                             
         OI    DMINBTS,X'08'       PASS BACK DELETED RECORDS                    
*                                                                               
         GOTO1 HIGH                RESET FILE POINTER                           
*                                                                               
         L     R6,GCOMCOMA         POINT TO COMMENT RECORD                      
         LA    R6,33(R6)           POINT TO FIRST ELEMENT                       
*                                                                               
GCOMSTDL DS    0H                                                               
*                                                                               
         CLI   0(R6),0             DONE IF END OF RECORD REACHED                
         BE    GCOMSTDD                                                         
*                                                                               
         CLI   0(R6),X'40'         SEARCH FOR COMMENT ELEMENTS                  
         BNE   GCOMSTDC                                                         
*                                                                               
         CLC   2(5,R6),=C'SHIP='   SKIP IF RESERVED COMMENTS                    
         BE    GCOMSTDC                                                         
         CLC   2(6,R6),=C'LABEL='                                               
         BE    GCOMSTDC                                                         
         CLC   2(4,R6),=C'MAT='                                                 
         BE    GCOMSTDC                                                         
         CLC   2(3,R6),=C'RC='                                                  
         BE    GCOMSTDC                                                         
*                                                                               
         ZIC   R5,1(R6)            ELEMENT LENGTH                               
         LR    R1,R6                 SAVE R6                                    
*                                                                               
         LA    R4,2(R6)            COMMENT START                                
         LR    R6,R4                                                            
*                                                                               
         SH    R5,=H'3'            SKIP IF NO COMMENT AVAILABLE                 
         BM    GCOMSTDC                                                         
*                                                                               
         CLI   0(R4),C'+'          SKIP LINES INDICATOR                         
         BNE   *+8                                                              
         LA    R6,2(R6)                                                         
*                                                                               
         CLC   0(3,R6),=C'DC='     SKIP DC= COMMENTS                            
         BE    GCOMSTD1                                                         
*                                                                               
         L     R3,GCOMNXTA         SAVE COMMENT IN TABLE                        
         LTR   R5,R5                                                            
         BM    GCOMSTD1                                                         
         EX    R5,*+8                                                           
         B     *+10                                                             
         MVC   0(0,R3),0(R4)                                                    
*                                                                               
         LA    R3,2(R5,R3)         UPDATE NEXT ELEMENT POINTER                  
         ST    R3,GCOMNXTA           WITH SPACE BETWEEN SEGMENTS                
*                                                                               
GCOMSTD1 DS    0H                  RESTORE ELEMENT POINTER                      
*                                                                               
         LR    R6,R1                                                            
*                                                                               
GCOMSTDC DS    0H                  LOOP CONTINUATION                            
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R6)          BUMP TO NEXT ELEMENT IN RECORD               
         BZ    GCOMSTDD            NONE AVAILABLE                               
         LA    R6,0(RF,R6)                                                      
         B     GCOMSTDL                                                         
*                                                                               
GCOMSTDD DS    0H                                                               
*                                                                               
         L     R6,GCOMELMA         RESTORE BUYREC'S R6                          
*                                                                               
GCOMLPCN DS    0H                                                               
*                                                                               
         SR    RF,RF                                                            
         ICM   RF,1,1(R6)          BUMP TO NEXT ELEMENT IN RECORD               
         BZ    GCOMLPDN            NONE AVAILABLE                               
         LA    R6,0(RF,R6)                                                      
         B     GCOMLOOP                                                         
*                                                                               
GCOMLPDN DS    0H                                                               
*                                                                               
         CLI   PBQADVSW,C'Y'       IF ADVERTISER REPORT                         
         BE    *+8                                                              
         CLI   PBQCLTSW,C'Y'       OR CLIENT OF AOR SITUATION                   
         BNE   GCOM90                                                           
*                                                                               
         ICM   RF,15,PBUTLA           RESET UTL                                 
         BZ    GCOM90                    NO ADDRESS GIVEN                       
*                                                                               
         MVC   4(1,RF),GCOMSESV       WITH CURRENT SE                           
*                                                                               
GCOM90   DS    0H                                                               
*                                                                               
         L     R3,GCOMTBLA         START OF COMMENT TABLE                       
*                                                                               
         L     RF,GCOMPRMA         POINT TO CALLER'S PARAMETERES                
         ST    R3,8(RF)            INITIALIZE A(TABLE)                          
*                                                                               
         L     R0,GCOMNXTA         CALCULATE COMMENT LENGTH                     
*                                  AS END MINUS START                           
         SR    R0,R3                                                            
         LTR   R5,R0               SAVE LENGTH FOR SQUASHER                     
         BNP   GCOMSQX             NOTHING FOUND                                
*                                                                               
         ST    R5,12(RF)           RETURN LENGTH TO CALLER                      
*                                                                               
GCOMUCLP DS    0H                                                               
*                                                                               
         LA    RF,L'SPACES         LENGTH OF SPACES                             
*                                                                               
         CR    RF,R0               MAKE COMMENT UPPERCASE                       
         BNH   *+6                                                              
         LR    RF,R0                                                            
*                                                                               
         BCTR  RF,0                                                             
         EX    RF,*+8                                                           
         B     *+10                                                             
         OC    0(0,R3),SPACES                                                   
*                                                                               
GCOMUCCN DS    0H                                                               
*                                                                               
         LA    R3,1(RF,R3)         NEXT PORTION OF COMMENT                      
         SR    R0,RF                                                            
         BCT   R0,GCOMUCLP                                                      
*                                                                               
GCOMUCDN DS    0H                                                               
*                                                                               
         ICM   RE,15,GCOMPRMS+4    GET PARAMETER                                
         BZ    *+14                                                             
         CLC   =C'NOSQ',0(RE)      NO SQUASH OPTION                             
         BE    GCOMSQX                                                          
*                                                                               
*                                  SQUASH COMMENT                               
         GOTO1 SQUASHER,GCOMDMCB,GCOMTBLA,(R5)                                  
*                                                                               
         L     R1,GCOMPRMA         POINT TO PARAMETER LIST                      
         MVC   12(4,R1),GCOMDMCB+4 RETURN SQUASHED LENGTH                       
*                                                                               
GCOMSQX  DS    0H                                                               
*                                                                               
GCOMX    DS    0H                                                               
         XIT1                                                                   
         LTORG                                                                  
*                                                                               
         DS    CL256               FOR NEW Z/OS PROCESSOR                       
GCOMPRMA DS    F                   A(PARAMETER LIST)                            
*                                                                               
GCOMPRMS DS    0XL16               PARAMETER LIST SAVEAREA                      
GCOMRECA DS    0A                  A(RECORD)                                    
GCOMELID DS    XL1                 ELEMENT ID                                   
         DS    XL3                                                              
GCOMNOSQ DS    0A                  A(NO SQUASH OPTION)                          
GCOMSE   DS    XL1                 SE NUMBER                                    
         DS    XL3                                                              
*                                                                               
GCOMDMCB DS    6A                  WORK PARAMETER LIST                          
*                                                                               
GCOMNXTA DS    A                   A(NEXT ENTRY IN TABLE)                       
GCOMELMA DS    A                   A(CURRENT COMMENT ELEMENT)                   
GCOMCOMA DS    A                   A(COMMENT RECORD  I/OAREA)                   
GCOMAIOS DS    A                   A(CURRENT I/OAREA ADDRESS)                   
GCOMSESV DS    XL1                 CURRENT SE SAVEAREA                          
GCOMLOW  DS    X                   LOW ELEMENT ID                               
GCOMHIGH DS    X                   HIGH ELEMENT ID                              
*                                                                               
GCOMTBLL EQU   L'BIGTABLE          TABLE LENGTH                                 
GCOMTBLA DC    A(BIGTABLE)         A(COMMENT TABLE)                             
*                                                                               
         TITLE 'PRWRITER - ABOUT TO PRINT A LINE - PRINTLN'                     
***********************************************************************         
*                                                                     *         
*        DRIVER ABOUT TO PRINT A LINE                                 *         
*                                                                     *         
* NTRY   SORTSW  - C'X' DON'T PRINT THE LINE                          *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PRINTLN  NMOD1 0,**#PLN                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         CLI   SORTSW,C'X'         IF NO PRINT SWITCH IS ON                     
         BNE   *+8                                                              
         MVI   GLHOOK,GLDONT          DON'T PRINT LINE                          
*                                                                               
         MVI   SORTSW,0            CLEAR SWITCH                                 
*                                                                               
PRINTLNX DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'PRWRITER - PUT RECORD TO SORT - PUTSRT'                         
***********************************************************************         
*                                                                     *         
*        DRIVER ABOUT TO PASS RECORD TO SORT                          *         
*                                                                     *         
* NTRY   SORTSW  - C'N' OR C'D' - DROP RECORD FROM SORT               *         
*                                                                     *         
***********************************************************************         
         SPACE 2                                                                
         DS    0D                                                               
PUTSRT   NMOD1 0,**#PSRT                                                        
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         TM    STACKSW,STACKYQ+STCKINIQ   DROP IF STACKING AND INIT SW          
         BO    PUTSRT1                      STILL ON                            
*                                                                               
         TM    STACKSW,STACKYQ+STCKMRGQ   IF STACKING OR MERGING                
         BZ    PUTSRT0                                                          
*                                                                               
         ICM   RF,15,STACKA        POINT TO STACK KEYWORD                       
******                                                                          
******   OC    0(L'FTBLINNM,RF),0(RF)   DROP IF NO LINE NUMBER SET              
******   BZ    PUTSRT1                                                          
*                                                                               
PUTSRT0  DS    0H                                                               
*                                                                               
         CLI   SORTSW,C'N'         IF SORT SWITCH IS ON                         
         BE    *+8                                                              
         CLI   SORTSW,C'D'         IF SORT SWITCH IS ON                         
         BNE   *+12                                                             
PUTSRT1  DS    0H                                                               
         MVI   GLHOOK,GLDONT          DON'T PUT RECORD TO SORT                  
         MVI   SORTSW,C'D'            INDICATE A DELETION DONE                  
*                                                                               
*        NEED THIS TRICK BECAUSE DRIVER ADDS EXTRA RECORD FOR EACH              
*        LEVEL OF TOTALLING AND SO NEED TO DELETE SEVERAL RECORDS BUT           
*        ALSO NEED TO KNOW WHEN TO RESET SWITCH. SINCE ALL RECORDS ARE          
*        ADDED CONSECUTIVELY WITHOUT INVOKING ANY OF OUR ROUTINES               
*        WE SHOULD BE SAFE IN RESETTING WHEN NEXT EXECUTED ROUTINE              
*        SEES A C'D' AS SWITCH VALUE.                                           
*                                                                               
PUTSRTX  DS    0H                                                               
         XIT1                                                                   
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE 'ROUTINE TO TEST IF BUY IS DELETED - TSTDEL'                     
***********************************************************************         
*                                                                     *         
*        DETERMINE IF A BUY IS DELETED                                *         
*        CALCULATE STANDARD DOLLAR AMOUNTS VIA GETINS                 *         
*        IF DELETED SET ORDERED DOLLARS TO ZERO                       *         
*                                                                     *         
*NTRY    GLARGS+1   C'O' - OPEN RATES WANTED                          *         
*        DLRTYPE    C'P' - PAID   DATA ENTRY                          *         
*                   C'B' - BILLED DATA ENTRY                          *         
*        GLARGS+7   C'$' - AMOUNT DATA ENTRY                          *         
*        GLARGS+8   C'L' - BILLED ELEMENTS USED                       *         
*                   C'T' - BILLED AND/OR PAID ELEMENTS USED           *         
*                   C'A' - PAID   ELEMENTS USED                       *         
*                                                                     *         
*EXIT    DOLLAR AMOUNTS FILLED IN INPRNTBLOCK                         *         
*                                                                     *         
***********************************************************************         
TSTDEL   NMOD1 0,**#TDL                                                         
*                                                                               
         L     RC,GLAWORKD         RESET WORKING STORAGE POINTER                
         USING GEND,RC                                                          
*                                                                               
         CLI   GLARGS+1,C'O'       IF OPEN RATES BEING PROCESSED                
         BNE   TSTDEL1                                                          
*                                                                               
         MVC   WORK,PBGRS             SAVE CONTRACT RATES                       
         MVC   PBGRS(64),OGROSS       & REPLACE WITH OPEN                       
*                                                                               
TSTDEL1  DS    0H                                                               
*                                                                               
         CLI   DLRTYPE,C'P'        SKIP IF   NOT PAID DATA ENTRIES              
         BE    *+8                                                              
         CLI   DLRTYPE,C'B'             AND NOT BILLED                          
         BNE   TSTDEL5                                                          
*                                                                               
         CLC   GLARGS+7(2),=C'$L'  IF PROCESSING BILLED ELEMENTS                
         BE    *+10                                                             
         CLC   GLARGS+7(2),=C'$T'  OR PAID AND/OR BILLED                        
         BE    *+10                                                             
         CLC   GLARGS+7(2),=C'$A'  OR PAID ELEMENTS                             
         BNE   TSTDEL5                                                          
*                                                                               
         CLI   GLARGS+1,C'O'       AND NOT OPEN RATES                           
         BE    *+10                                                             
         MVC   WORK,PBGRS              SAVE ORDERED AMOUNTS                     
*                                                                               
         GOTO1 =V(GETDLRS)         GET DOLLARS VIA GETINS                       
*                                                                               
TSTDEL5  DS    0H                                                               
*                                                                               
         L     RF,AIO1             POINT TO BUY RECORD                          
*                                                                               
         TM    PBUYCNTL-PBUYKEY(RF),X'80'  TEST FOR DELETED RECORD              
*                                                                               
         LA    RF,0              RETURN CODE                                    
*                                                                               
TSTDELX  DS    0H                                                               
         XIT1  REGS=(RF)                                                        
*                                                                               
         LTORG                                                                  
*                                                                               
         TITLE   'PRWRITER DSECTS / STORAGE'                                    
       ++INCLUDE PRWRIWORKD                                                     
         EJECT                                                                  
DATELSTD DSECT                                                                  
       ++INCLUDE PRDATELSTD                                                     
         EJECT                                                                  
MYWORKD  DSECT                                                                  
         DS    10D                                                              
WORKAREA DS    60D                                                              
         SPACE 2                                                                
LASTIOD  DSECT                                                                  
SAVKEYS  DS   CL25                                                              
SVADKEY  DS   CL14                                                              
SVADCD   DS   CL6                                                               
SKPUB    DS   CL18                                                              
SVLSTDAT DS   CL3                                                               
MLTREC   DS   CL1                                                               
         SPACE 1                                                                
         EJECT                                                                  
* DRGLOBAL                                                                      
         PRINT   OFF                                                            
       ++INCLUDE DRGLOBAL                                                       
         PRINT   ON                                                             
* DRIVETABLE                                                                    
         PRINT   OFF                                                            
       ++INCLUDE DRIVETABLE                                                     
         PRINT   ON                                                             
* DRINTRECD2                                                                    
         PRINT   OFF                                                            
       ++INCLUDE DRINTRECD2                                                     
         PRINT   ON                                                             
* DDSPOOLD                                                                      
         PRINT   OFF                                                            
       ++INCLUDE DDSPOOLD                                                       
         PRINT   ON                                                             
* DDSPLWORKD                                                                    
         PRINT OFF                                                              
       ++INCLUDE DDSPLWORKD                                                     
         PRINT   ON                                                             
* PRVALTABD                                                                     
         PRINT OFF                                                              
       ++INCLUDE PRVALTABD                                                      
         PRINT   ON                                                             
* DDGENTWA                                                                      
         PRINT OFF                                                              
       ++INCLUDE PRWRIFFD                                                       
       ++INCLUDE DDGENTWA                                                       
         PRINT   ON                                                             
* DDMASTD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDMASTD                                                        
         PRINT   ON                                                             
* PPGETBFRD                                                                     
         PRINT OFF                                                              
PPGBFRDD DSECT                                                                  
       ++INCLUDE PPGETBFRD                                                      
         PRINT   ON                                                             
* PRGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE PRGENFILE                                                      
         PRINT   ON                                                             
* PPGETCOND                                                                     
         PRINT OFF                                                              
       ++INCLUDE PPGETCOND                                                      
         PRINT   ON                                                             
* ACGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE ACGENFILE                                                      
         PRINT   ON                                                             
* PRWRIEQUS                                                                     
         PRINT OFF                                                              
       ++INCLUDE PRWRIEQUS                                                      
         PRINT   ON                                                             
* DDUCOMD                                                                       
         PRINT OFF                                                              
       ++INCLUDE DDUCOMD                                                        
         PRINT   ON                                                             
* DDCOMFACSD                                                                    
         PRINT OFF                                                              
       ++INCLUDE DDCOMFACSD                                                     
         PRINT   ON                                                             
* FAFACTS                                                                       
         PRINT OFF                                                              
       ++INCLUDE FAFACTS                                                        
         PRINT   ON                                                             
* DDOFFICED                                                                     
         PRINT OFF                                                              
       ++INCLUDE DDOFFICED                                                      
         PRINT ON                                                               
* DDMINBLK                                                                      
         PRINT OFF                                                              
       ++INCLUDE DDMINBLK                                                       
         PRINT   ON                                                             
* CTGENFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE CTGENFILE                                                      
         PRINT   ON                                                             
* SEACSFILE                                                                     
         PRINT OFF                                                              
       ++INCLUDE SEACSFILE                                                      
         PRINT   ON                                                             
**PAN#1  CSECT                                                                  
**PAN#1  DC    CL21'150PRWRITER  01/28/21'                                      
         END                                                                    
