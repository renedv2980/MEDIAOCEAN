        /* DATA SET DELMANALYZ AT LEVEL 045 AS OF 02/27/20    */                
       ++INCLUDE IEBUPDTHDR                                                     
                                                                                
We use PANACEA-style "conditional assembly" flags to provide parameters         
to this module. Supported parameters are:                                       
                                                                                
  TEST  = read Nielsen test-named files (not production files)                  
  MKTS  = report is broken out at the market level (not typically done)         
  STRMS = report is broken out by stream (typical)                              
  REGRS = suppress selected data to aid in for regression testing               
  IMPAC = accept Impact data files                                              
                                                                                
*&&TEST  SET   N        Default: read *production* data (not test data)         
*&&IMPAC SET   N        Default: do not read Impact data                        
*&&REGRS SET   N        Default: output is not for regression testing           
                                                                                
***********************************************************************         
                                                                                
This member contains ICETOOL/DFSORT control cards. It is a preprocessor         
for the Local Monthlies calculation driver. The purpose of this module          
is to print a report of "instructions" for Data Control, showing the            
control cards and jobs which must be submitted for the Local Monthlies.         
                                                                                
>>>>>>>>>>>>>>>>>>>>>>>>>>>>> CRITICAL <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<         
The LISTALL SYSPRINT output is also used as input to the automation             
process. Keep this in mind before changing the format of the report!            
>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>><<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<         
                                                                                
Input:  SYSIN DATE=YYYYMMDD parameter cards.                                    
        A Local Monthlies repository index file.                                
                                                                                
Output: SYSPRINT report (DDNAME LISTALL)  to drive the automation.              
        SYSPRINT report (DDNAME LISTALL1) so we can see the results.            
                                                                                
***********************************************************************         
./ ADD NAME=SYMNAMES   ** SYMBOLICS USED IN CONTROL CARDS                       
*                                                                               
JOB_UNIT,1,126,CH        *** HARD-CODED LENGTH (w/ all subfields below)         
* this is the unit of work that the software can handle in one job              
 JOB_PROCESSING_DATE,=,8,CH   *** YYYYMMDD symlink folder date                  
 JOB_SERVICE,*,7,CH      *** NSI, NSIBLK, etc                                   
 JOB_SURVEY_YM,*,6,CH    *** YYYYMM survey                                      
 JOB_STREAM,*,7,CH       *** same length as FILENAME_QUALIFIER                  
 JOB_VIP_DUMMY_CARD,*,49,CH            *** ++DUMMY card for VIP job             
 JOB_PREPROC_DUMMY_CARD,*,49,CH        *** ++DUMMY pre-processor card           
*                                                                               
MARKET_KEY,*,17,CH       *** HARD-CODED LENGTH (w/ all subfields below)         
 CYCLE,=,1,CH            *** always "C"                                         
 SERVICE,*,7,CH          *** NSI, NSIBLK, etc                                   
 MARKET_CODE,*,3,CH      *** 101, 102, etc                                      
 SURVEY_YM,*,6,CH        *** YYYYMM                                             
  SURVEY_YYYY,=,4,CH                                                            
   SURVEY_CC,=,2,CH                                                             
   SURVEY_YY,*,2,CH                                                             
  SURVEY_MM,*,2,CH                                                              
*                                                                               
ALPHA_BOOK,*,6,CH            *** BOOK= format (MMM/YY)                          
 ALPHA_MMM,=,3,CH            *** e.g., SEP                                      
 ALPHA_SLASH,*,1,CH          *** for "/" delimiter in MMM/YY                    
 ALPHA_YY,*,2,CH             *** e.g., 10 (YY)                                  
*                                                                               
*                       *** Note: DPOPT files discontinued as of Jan/16         
FILENAME_QUALIFIER,*,7,CH    *** L7, DPCUME, PGNAMUP, etc.                      
PROCESSING_DATE,*,8,CH       *** YYYYMMDD or repo                               
FILETYPE,*,7,CH              *** NORMAL, DPCUME, PGNAMUP                        
SORT_SURVEY_TYPE,*,1,CH      *** " " = regular, "O" = Olympic Exclusion         
SORT_SERVICE,*,1,CH          *** for priority (NSI first, etc)                  
SORT_STREAM,*,1,CH           *** for priority (L7/L1 first, etc)                
LATEST_DATE,*,8,CH           *** latest symlink date folder (YYYYMMDD)          
SORT_MODE,*,1,CH             *** for report line sorting                        
ALL_STREAMS,*,7,CH           *** same length as FILENAME_QUALIFIER              
JOB_SEQNUM,*,2,ZD            *** to help Ops Support keep it straight           
MARKET_COUNT,*,2,FI          *** for reported market total                      
*                                                                               
PARM_KEYWORD,1,10,CH         *** C'DATE'                                        
PARM_VALUE,*,10,CH           *** YYYYMMDD (or "LATEST")                         
*                                                                               
ZIP_FILE_EXTENSION,C'.ZIP'                                                      
REPOSITORY_NAME,C'repo'   *** Local Monthlies zipped repository folder          
TEMPORARY_FOLDER,C'/TMP'  *** Local Monthlies temporary file folder             
*                                                                               
* FILETYPE values                                                               
*                                                                               
QH_TYPE,C'QH     '      *** all quarter-hour files (for all streams)            
PGNAM_TYPE,C'PGNAM  '   *** program name files                                  
PGNAMUP_TYPE,C'PGNAMUP' *** program name update files                           
DPCUME_TYPE,C'DPCUME '  *** daypart cumes files                                 
*                                                                               
* SERVICE values                                                                
*                                                                               
* Note: In order to prevent DFSORT symbol substitution errors in these          
*   control statements, each SERVICE symbol must be resolved regardless         
*   of the TEST switch setting. I.e., even if we do not expect to               
*   receive test files for a particular service, we must define the             
*   symbol anyway, and assign it a value that we know will never occur.         
*   Also note that Nielsen does not always release all required *test*          
*   files for a given market/survey. E.g., they might issue a test              
*   quarter-hour file without its associated PGNAM file, in which case          
*   the analyzer will ignore that market.                                       
*&!TEST                                                                         
NSI_SERVICE,C'NSI    '      *** Standard NSI                                    
*&&IMPAC                                                                        
NSIX_SERVICE,C'NSIX   '     *** NSI (Parallel Impact)                           
*&&                                                                             
*&!IMPAC                                                                        
NSIX_SERVICE,C'???????'     *** (force deliberate mismatch)                     
*&!                                                                             
NHSI_SERVICE,C'NHSI   '     *** NHSI (only valid prior to Oct27/2011)           
NSIBLK_SERVICE,C'NSIBLK '   *** NSIBLK                                          
NSIHSP_SERVICE,C'NSIHSP '   *** NSIHSP                                          
*&&IMPAC                                                                        
NSIXHSP_SERVICE,C'NSIXHSP'  *** NSIHSP (Parallel Impact)                        
*&&                                                                             
*&!IMPAC                                                                        
NSIXHSP_SERVICE,C'???????'  *** (force deliberate mismatch)                     
*&!                                                                             
NSIOLY_SERVICE,C'NSIOLY '   *** NSI Olympic Exclusion                           
SVIP_SERVICE,C'SVIP   '     *** Special VIP                                     
NCM_SERVICE,C'NCM    '      *** National CineMedia                              
*&!                                                                             
*&&TEST                                                                         
NSI_SERVICE,C'NSIT   '      *** Standard NSI (test files)                       
NSIX_SERVICE,C'???????'     *** NSI (Parallel Impact)                           
NHSI_SERVICE,C'NHSIT  '     *** NHSI (test files: prior to Oct27/2011)          
NSIBLK_SERVICE,C'NSIBLKT'   *** NSIBLK (test files)                             
NSIHSP_SERVICE,C'NSIHSPT'   *** NSIHSP (test files)                             
NSIXHSP_SERVICE,C'???????'  *** NSIHSP (Parallel Impact)                        
NSIOLY_SERVICE,C'NSIOLYT'   *** NSI Olympic Exclusion (test files)              
SVIP_SERVICE,C'SVIPT  '     *** Special VIP (test: never actually seen)         
NCM_SERVICE,C'???????'      *** National CineMedia                              
*&&                                                                             
*                                                                               
* MODE values                                                                   
*                                                                               
NORMAL_MODE,C'1'        *** MODE=NORMAL                                         
DPCUME_MODE,C'2'        *** MODE=DPCUME                                         
PGNAMUP_MODE,C'3'       *** MODE=PGNAMUP                                        
*                                                                               
* ++DUMMY card values (and related symbols)                                     
*                                                                               
DUMMY_VIP_NORMAL,C'++DUMMY DELMICETPA'                                          
DUMMY_VIP_PGNAMUP,C'++DUMMY DELMICETPA &&SET PU=Y'                              
DUMMY_VIP_DPCUME,C'++DUMMY DELMICEDPT'                                          
DUMMY_VIP_NCM,C'++DUMMY DELMICENCM'                                             
*                                                                               
DUMMY_PREPROC_NORMAL,C'++DUMMY DELMINDNR'                                       
DUMMY_PREPROC_PGNAMUP,C'++DUMMY DELMINDPU'                                      
DUMMY_PREPROC_DPCUME,C'++DUMMY DELMINDDP'                                       
*                                                                               
DPCUME_USE_L7_FIRST_SURVEY,C'201807'    * use L+7 for DPCUMEs Jul/2018          
*                                                                               
* Parsed variables for SYSIN parameter cards                                    
*                                                                               
C_KEYWORD,%01                                                                   
C_VALUE,%02                                                                     
*                                                                               
* Parsed variables for pathname file                                            
*                                                                               
U_PROCESSING_DATE,%11                                                           
U_SERVICE,%12                                                                   
U_MARKET_CODE,%13                                                               
U_CYCLE,%14                                                                     
U_SURVEY_YYYY,%15                                                               
U_SURVEY_MM,%16                                                                 
U_FILENAME_QUALIFIER,%17                                                        
U_FILE_EXTENSION,%18                                                            
*                                                                               
*                                                                               
P_RDW,1,4,BI                                                                    
P_CYCLE,*,1,CH                                                                  
P_SERVICE,*,7,CH                                                                
P_MARKET_CODE,*,3,CH                                                            
P_SURVEY_YYYY,*,4,CH                                                            
P_SURVEY_MM,*,2,CH                                                              
P_FILENAME_QUALIFIER,*,7,CH                                                     
P_PROCESSING_DATE,*,8,CH                                                        
*                                                                               
*                                                                               
./ ADD NAME=TOOLIN        ** CONTROL CARDS FOR ICETOOL                          
*                                                                               
* Parse the parameter cards (only DATE= supported):                             
COPY FROM(SYSIN) TO(TEMP11) USING(COPP)                                         
*                                                                               
* Reformat the index file so that it is ready for parsing.                      
COPY FROM(INDEX) TO(TEMP15) USING(COP9)                                         
*                                                                               
* Parse the index file of pathnames:                                            
COPY FROM(TEMP15) TO(PARSED) USING(COP1)                                        
*                                                                               
* Keep only Local Monthlies data files. Populate the file list with             
* sort priority key fields. Split the file into two output files: one           
* containing the repository pathnames, the other with all symlinks by           
* date.                                                                         
COPY FROM(PARSED) USING(COP2)                                                   
*                                                                               
* If both L7 and L7DMA files are present in the "repo" folder, keep             
* only the L7. Otherwise, keep whichever one we have.                           
SELECT FROM(TEMP25) TO(TEMP16) ON(MARKET_KEY) FIRST USING(SRT7)                 
*                                                                               
* Extract only the PGNAM and PGNAMUP files for service NSI from                 
* the full file list, and duplicate them with service NSIOLY.                   
COPY FROM(TEMP16) TO(TEMP12) USING(COP8)                                        
*                                                                               
* Append the constructed service NSIOLY records to the full file list.          
COPY FROM(TEMP12) TO(TEMP16)                                                    
*                                                                               
* Sort the full file list for efficiency in subsequent JOINs.                   
SORT FROM(TEMP16) TO(FILELIST) USING(SRT3)                                      
*                                                                               
* Find the symlink file with the most recent date, and create a file            
* with a single record containing that date:                                    
SORT FROM(DATELIST) TO(TEMP10) USING(SRT5)                                      
*                                                                               
* Insert the latest date into the parameter card record:                        
COPY JKFROM TO(SYSINPAR) USING(JKT7)                                            
*                                                                               
* Filter the symlink file so that we keep only those for the requested          
* processing date.                                                              
COPY JKFROM USING(JKT1)                                                         
*                                                                               
* If both L7 and L7DMA files are present in the daily folder, keep only         
* the L7. Otherwise, keep whichever one we have. (If Nielsen reissues           
* corrected L7 data, they may also reissue L7DMA data simultaneously,           
* which we must discard.)                                                       
SELECT FROM(TEMP9) TO(TEMP17) ON(MARKET_KEY) FIRST USING(SRT7)                  
*                                                                               
* Extract only the PGNAM and PGNAMUP files for service NSI from                 
* the "today" file list, and duplicate them with service NSIOLY.                
COPY FROM(TEMP17) TO(TEMP13) USING(COP8)                                        
*                                                                               
* Append the constructed service NSIOLY records to the "today" list.            
COPY FROM(TEMP13) TO(TEMP17)                                                    
*                                                                               
* Sort the "today" file list for efficiency in subsequent JOINs.                
SORT FROM(TEMP17) TO(TODAYLST) USING(SRT3)                                      
*                                                                               
* Make sure there are no pathnames in the daily folder without                  
* corresponding pathnames in the repository. If there are any such              
* names, this may indicate that the download has failed, or that the            
* download is incomplete. It may also indicate that we want to                  
* deliberately stop VIP processing for some reason.                             
COPY JKFROM USING(JKT8)                                                         
*                                                                               
* Check for "old" survey dates in the daily folder.                             
COPY FROM(TODAYLST) TO(TEMP24) USING(COPF)                                      
COUNT FROM(TEMP24) RC4 NOTEMPTY                                                 
*                                                                               
* Set completion code 8 if we think the download was incomplete, but            
* do not stop processing.                                                       
MODE CONTINUE                                                                   
COUNT FROM(TEMP14) RC8 NOTEMPTY                                                 
MODE STOP                                                                       
*                                                                               
* Create a list of all pathnames from the repository which are                  
* associated with the markets found in the requested date symlink               
* folder.                                                                       
SORT JKFROM TO(FINLLIST) USING(JKT2)                                            
*                                                                               
*======================================================================         
* Prepare a file for the "DPCUME" JCL report section.                           
*======================================================================         
*                                                                               
* Find all markets represented in the daily folder which must trigger           
* daypart cumes calculations.                                                   
SORT JKFROM TO(TEMP2) USING(JKT3)                                               
* Keep only markets for which we have DPCUME data.                              
COPY FROM(TEMP2) TO(TEMP1) USING(DPCU)                                          
*                                                                               
* ---> DEIS Apr/2018: We just discovered that the analyzer has never            
* --->   correctly discarded markets which do have DPCUME data, but             
* --->   which do not have associated time period data. This seems very         
* --->   unlikely, but it could theoretically happen. The safest way to         
* --->   fix it is by adding the JOIN below.                                    
*                                                                               
* Locate needed time period files in the repository.                            
COPY JKFROM TO(TEMP23) USING(JKTD)                                              
*                                                                               
* Perform (almost) final updates on the report lines.                           
COPY FROM(TEMP23) TO(TEMP6) USING(COP6)                                         
* Finalize the report lines.                                                    
SORT FROM(TEMP6) TO(DPOUT) USING(FMTD)                                          
*                                                                               
*======================================================================         
* Prepare a file for the "PGNAMUP" JCL report section.                          
*======================================================================         
* Find all markets for which PGNAMUP files are present.                         
SORT JKFROM TO(TEMP2) USING(JKT4)                                               
* Locate needed time period files in the repository.                            
COPY JKFROM TO(TEMP3) USING(PGNM)                                               
* Combine streams where appropriate.                                            
SORT FROM(TEMP3) TO(TEMP1) USING(SRT1)                                          
* Perform (almost) final updates on the report lines.                           
COPY FROM(TEMP1) TO(TEMP6) USING(COP6)                                          
* Finalize the report lines.                                                    
SORT FROM(TEMP6) TO(PUOUT) USING(FMTP)                                          
*                                                                               
*======================================================================         
* Prepare a file for the "NORMAL" JCL report section.                           
*======================================================================         
* Find all markets for which PGNAM files are present.                           
SORT JKFROM TO(TEMP2) USING(JKT5)                                               
* Locate needed time period files in the repository.                            
COPY JKFROM TO(TEMP3) USING(PGNM)                                               
* Combine streams where appropriate.                                            
SORT FROM(TEMP3) TO(TEMP4) USING(NORM)                                          
* Find all markets for which quarter-hour files are present.                    
COPY FROM(TODAYLST) TO(TEMP1) USING(COP5)                                       
* Combine streams where appropriate.                                            
SORT FROM(TEMP1) TO(TEMP4) USING(NORM)                                          
*                                                                               
* ---> DEIS MAR/2018: We just discovered that the analyzer has never            
* --->   correctly discarded markets which have no PGNAM data. This bug         
* --->   was exposed when we began supporting NCM. The safest way to            
* --->   fix it is by adding the statements below (and for NCM also).           
*                                                                               
* Copy MOD file to NEW file as input to the JOIN that follows.                  
COPY FROM(TEMP4) TO(TEMP21)                                                     
* Keep only markets for which PGNAM files are present.                          
COPY JKFROM TO(TEMP22) USING(JKT9)                                              
*                                                                               
* Eliminate duplicate markets.                                                  
SORT FROM(TEMP22) TO(TEMP5) USING(SRT2)                                         
* Perform (almost) final updates on the report lines.                           
COPY FROM(TEMP5) TO(TEMP6) USING(COP6)                                          
* Finalize the report lines.                                                    
SORT FROM(TEMP6) TO(NROUT) USING(FMTN)                                          
*                                                                               
*======================================================================         
* Prepare a file for the "NCM" JCL report section.                              
*======================================================================         
* Find all markets for which PGNAM files are present.                           
SORT JKFROM TO(TEMP2) USING(JKT5)                                               
* Locate needed time period files in the repository.                            
COPY JKFROM TO(TEMP3) USING(PGNM)                                               
* Combine streams where appropriate.                                            
SORT FROM(TEMP3) TO(TEMP8) USING(NCMS)                                          
* Find all markets for which quarter-hour files are present.                    
COPY FROM(TODAYLST) TO(TEMP1) USING(COP5)                                       
* Combine streams where appropriate.                                            
SORT FROM(TEMP1) TO(TEMP8) USING(NCMS)                                          
* Copy MOD file to NEW file as input to the JOIN that follows.                  
COPY FROM(TEMP8) TO(TEMP21)                                                     
* Keep only markets for which PGNAM files are present.                          
COPY JKFROM TO(TEMP22) USING(JKT9)                                              
* Eliminate duplicate markets.                                                  
SORT FROM(TEMP22) TO(TEMP5) USING(SRT2)                                         
* Perform (almost) final updates on the report lines.                           
COPY FROM(TEMP5) TO(TEMP6) USING(COP6)                                          
* Finalize the report lines.                                                    
SORT FROM(TEMP6) TO(NCOUT) USING(FMTN)                                          
*                                                                               
*======================================================================         
* Perform final validity checking.                                              
*======================================================================         
* See if any market has both PGNAM and PGNAMUP files in the daily               
* folder (for the same service/survey).                                         
COPY FROM(TODAYLST) TO(TEMP5)                                                   
COPY JKFROM TO(TEMP9) USING(JKT6)                                               
COPY FROM(TEMP9) TO(EROUT) USING(COP6)                                          
*                                                                               
*======================================================================         
* Print the reports.                                                            
*======================================================================         
*                                                                               
* Print the MODE=NORMAL report.                                                 
*                                                                               
DISPLAY BLANK FROM(NROUT) LIST(TEMP7) -                                         
  TLEFT TBETWEEN(5) -                                                           
  WIDTH(300) -                                                                  
  TITLE('LOCAL MONTHLIES: FILENAME ANALYZER') -                                 
*&!REGRS                                                                        
         DATE TIME -                                                            
*&!                                                                             
  TITLE('USE JCL FOR *** QH/PAV ***') -                                         
*&!MKTS                                                                         
  TITLE('MARKET=ALL') -                                                         
*&!REGRS                                                                        
  HEADER('NO.') ON(JOB_SEQNUM) -                                                
*&!                                                                             
*&!                                                                             
  HEADER('MODE=') ON(FILETYPE) -                                                
  HEADER('DATE=') ON(PROCESSING_DATE) -                                         
  HEADER('SERVICE=') ON(SERVICE) -                                              
  HEADER('BOOK=') ON(ALPHA_BOOK) -                                              
*&&STRMS                                                                        
  HEADER('STREAM=') ON(FILENAME_QUALIFIER) -                                    
*&&                                                                             
*&!STRMS                                                                        
  HEADER('STREAM=') ON(ALL_STREAMS) -                                           
*&!                                                                             
*&!MKTS                                                                         
  HEADER('#MKTS') ON(MARKET_COUNT) -                                            
*&!                                                                             
*&&MKTS                                                                         
  TITLE('INDIVIDUAL MARKET BREAKOUT') -                                         
  HEADER('MARKET=') ON(MARKET_CODE) -                                           
  BTITLE('JOB KEY (IGNORE THIS):') BREAK(JOB_UNIT) -                            
  BCOUNT('NO. OF MARKETS IN THIS JOB:') EDBCOUNT(U03) -                         
*&&                                                                             
  HEADER('VIP ++DUMMY CARD') ON(JOB_VIP_DUMMY_CARD) -                           
  HEADER('PREPROCESSOR ++DUMMY CARD') ON(JOB_PREPROC_DUMMY_CARD)                
*                                                                               
* Print the MODE=DPCUME report.                                                 
*                                                                               
DISPLAY BLANK FROM(DPOUT) LIST(TEMP7) -                                         
  TLEFT TBETWEEN(5) -                                                           
  WIDTH(300) -                                                                  
  TITLE('LOCAL MONTHLIES: FILENAME ANALYZER') -                                 
*&!REGRS                                                                        
         DATE TIME -                                                            
*&!                                                                             
  TITLE('USE JCL FOR *** DPCUME ***') -                                         
*&!MKTS                                                                         
  TITLE('MARKET=ALL') -                                                         
*&!REGRS                                                                        
  HEADER('NO.') ON(JOB_SEQNUM) -                                                
*&!                                                                             
*&!                                                                             
  HEADER('MODE=') ON(FILETYPE) -                                                
  HEADER('DATE=') ON(PROCESSING_DATE) -                                         
  HEADER('SERVICE=') ON(SERVICE) -                                              
  HEADER('BOOK=') ON(ALPHA_BOOK) -                                              
  HEADER('') ON(ALL_STREAMS) -                                                  
*&!MKTS                                                                         
  HEADER('#MKTS') ON(MARKET_COUNT) -                                            
*&!                                                                             
*&&MKTS                                                                         
  TITLE('INDIVIDUAL MARKET BREAKOUT') -                                         
  HEADER('MARKET=') ON(MARKET_CODE) -                                           
  BTITLE('JOB KEY (IGNORE THIS):') BREAK(JOB_UNIT) -                            
  BCOUNT('NO. OF MARKETS IN THIS JOB:') EDBCOUNT(U03) -                         
*&&                                                                             
  HEADER('VIP ++DUMMY CARD') ON(JOB_VIP_DUMMY_CARD) -                           
  HEADER('PREPROCESSOR ++DUMMY CARD') ON(JOB_PREPROC_DUMMY_CARD)                
*                                                                               
* Print the MODE=PGNAMUP report.                                                
*                                                                               
DISPLAY BLANK FROM(PUOUT) LIST(TEMP7) -                                         
  TLEFT TBETWEEN(5) -                                                           
  WIDTH(300) -                                                                  
  TITLE('LOCAL MONTHLIES: FILENAME ANALYZER') -                                 
*&!REGRS                                                                        
         DATE TIME -                                                            
*&!                                                                             
  TITLE('USE JCL FOR *** PGNAMUP ***') -                                        
*&!MKTS                                                                         
  TITLE('MARKET=ALL') -                                                         
*&!REGRS                                                                        
  HEADER('NO.') ON(JOB_SEQNUM) -                                                
*&!                                                                             
*&!                                                                             
  HEADER('MODE=') ON(FILETYPE) -                                                
  HEADER('DATE=') ON(PROCESSING_DATE) -                                         
  HEADER('SERVICE=') ON(SERVICE) -                                              
  HEADER('BOOK=') ON(ALPHA_BOOK) -                                              
*&&STRMS                                                                        
  HEADER('STREAM=') ON(FILENAME_QUALIFIER) -                                    
*&&                                                                             
*&!STRMS                                                                        
  HEADER('STREAM=') ON(ALL_STREAMS) -                                           
*&!                                                                             
*&!MKTS                                                                         
  HEADER('#MKTS') ON(MARKET_COUNT) -                                            
*&!                                                                             
*&&MKTS                                                                         
  TITLE('INDIVIDUAL MARKET BREAKOUT') -                                         
  HEADER('MARKET=') ON(MARKET_CODE) -                                           
  BTITLE('JOB KEY (IGNORE THIS):') BREAK(JOB_UNIT) -                            
  BCOUNT('NO. OF MARKETS IN THIS JOB:') EDBCOUNT(U03) -                         
*&&                                                                             
  HEADER('VIP ++DUMMY CARD') ON(JOB_VIP_DUMMY_CARD) -                           
  HEADER('PREPROCESSOR ++DUMMY CARD') ON(JOB_PREPROC_DUMMY_CARD)                
*                                                                               
* Print the NCM processing report.                                              
*                                                                               
DISPLAY BLANK FROM(NCOUT) LIST(TEMP7) -                                         
  TLEFT TBETWEEN(5) -                                                           
  WIDTH(300) -                                                                  
  TITLE('LOCAL MONTHLIES: FILENAME ANALYZER') -                                 
*&!REGRS                                                                        
         DATE TIME -                                                            
*&!                                                                             
  TITLE('USE JCL FOR *** QH/NCM ***') -                                         
*&!MKTS                                                                         
  TITLE('MARKET=ALL') -                                                         
*&!REGRS                                                                        
  HEADER('NO.') ON(JOB_SEQNUM) -                                                
*&!                                                                             
*&!                                                                             
  HEADER('MODE=') ON(FILETYPE) -                                                
  HEADER('DATE=') ON(PROCESSING_DATE) -                                         
  HEADER('SERVICE=') ON(SERVICE) -                                              
  HEADER('BOOK=') ON(ALPHA_BOOK) -                                              
*&&STRMS                                                                        
  HEADER('STREAM=') ON(FILENAME_QUALIFIER) -                                    
*&&                                                                             
*&!STRMS                                                                        
  HEADER('STREAM=') ON(ALL_STREAMS) -                                           
*&!                                                                             
*&!MKTS                                                                         
  HEADER('#MKTS') ON(MARKET_COUNT) -                                            
*&!                                                                             
*&&MKTS                                                                         
  TITLE('INDIVIDUAL MARKET BREAKOUT') -                                         
  HEADER('MARKET=') ON(MARKET_CODE) -                                           
  BTITLE('JOB KEY (IGNORE THIS):') BREAK(JOB_UNIT) -                            
  BCOUNT('NO. OF MARKETS IN THIS JOB:') EDBCOUNT(U03) -                         
*&&                                                                             
  HEADER('VIP ++DUMMY CARD') ON(JOB_VIP_DUMMY_CARD) -                           
  HEADER('PREPROCESSOR ++DUMMY CARD') ON(JOB_PREPROC_DUMMY_CARD)                
*                                                                               
* Print the error report.                                                       
*                                                                               
DISPLAY BLANK FROM(EROUT) LIST(TEMP7) -                                         
  TLEFT TBETWEEN(5) -                                                           
  WIDTH(300) -                                                                  
  TITLE('LOCAL MONTHLIES: FILENAME ANALYZER') -                                 
*&!REGRS                                                                        
         DATE TIME -                                                            
*&!                                                                             
  TITLE('PGNAM/PGNAMUP DUPLICATE ERROR REPORT') -                               
  TITLE('*** IF ANY DATA APPEARS HERE, CONTACT NIELSEN ***') -                  
  HEADER('DATE=') ON(PROCESSING_DATE) -                                         
  HEADER('SERVICE=') ON(SERVICE) -                                              
  HEADER('BOOK=') ON(ALPHA_BOOK) -                                              
  HEADER('MARKET=') ON(MARKET_CODE)                                             
*                                                                               
* Copy the final report to two datasets. In production, LISTALL is              
* directed to a sequential dataset, and drives the automation process.          
* LISTALL1 is a SYSOUT dataset viewable in (E)JES.                              
*                                                                               
COPY FROM(TEMP7) TO(LISTALL1)                                                   
*                                                                               
* Make sure there were no errors found before producing the LISTALL             
* report, because that report drives the automation!                            
COUNT FROM(EROUT) RC12 NOTEMPTY                                                 
*                                                                               
* Execution stops here if RC12 was just set.                                    
COPY FROM(TEMP7) TO(LISTALL)                                                    
*                                                                               
*                                                                               
./ ADD NAME=COP9CNTL                                                            
*                                                                               
* The input file is the output of the Unix "ls -R" command, which               
* recurses through the Local Monthlies mounted drive, and produces              
* a list of all directories and pathnames. The input file records look          
* like this (for example):                                                      
*                                                                               
*    ----+----1----+----2----+----3----+----4----+----5----+----6               
*    /u/deis/nfs/20150507:                                                      
*    NSIBLK_167_C_2015_02_L7.ZIP                                                
*    NSIBLK_167_C_2015_02_PGNAM.ZIP                                             
*    /u/deis/nfs/repo:                                                          
*    NSIBLK_167_C_2015_02_L7.ZIP                                                
*    NSIBLK_167_C_2015_02_PGNAM.ZIP                                             
*                                                                               
* We assume that any record beginning with a slash, and containing a            
* colon, is a directory name. We push the directory name down into              
* the records containing the filenames (keeping only the ZIP files, and         
* ignoring the temporary work folder which is needed by Ops to park the         
* files while they are being downloaded). This produces an output file          
* of all potentially relevant Local Monthlies ZIP filenames and their           
* directory locations.                                                          
*                                                                               
 OPTION VLSCMP                   *** required for "short" records               
 INREC IFTHEN=(WHEN=INIT,OVERLAY=(200:X)),   ** force 200-byte reclen           
       IFTHEN=(WHEN=GROUP,BEGIN=(5,1,CH,EQ,C'/',AND,5,40,SS,EQ,C':'),           
                          PUSH=(100:5,40)),  ** assume 40-char max dir.         
       IFTHEN=(WHEN=NONE,FINDREP=(IN=C':',OUT=C' '))                            
* After the RDW, put the folder in column 5, and filename in column 50.         
 OUTREC BUILD=(1,4,5:100,40,50:5)                                               
* Only keep the ZIP files.                                                      
 OUTFIL INCLUDE=(50,150,SS,EQ,ZIP_FILE_EXTENSION,AND, ** keep ZIP files         
                 50,3,CH,NE,C'SN_',AND,       ** ignore "Special Notes"         
                 50,4,CH,NE,C'RDN_',AND,      ** ignore "RDN" files             
                 5,40,SS,NE,TEMPORARY_FOLDER),      ** ignore TMP files         
        IFTHEN=(WHEN=INIT,BUILD=(1,4,5,100))                                    
*                                                                               
*                                                                               
./ ADD NAME=COPPCNTL                                                            
*                                                                               
 INCLUDE COND=(1,1,CH,NE,C'*')  ** IGNORE COMMENTS                              
 INREC PARSE=(C_KEYWORD=(ENDBEFR=C'=',FIXLEN=10),                               
              C_VALUE=(ENDBEFR=C' ',FIXLEN=10)),                                
       BUILD=(C_KEYWORD,C_VALUE)                                                
 OUTFIL REMOVECC,                                                               
       INCLUDE=(PARM_KEYWORD,EQ,C'DATE      '),                                 
       IFTHEN=(WHEN=INIT,                                                       
                BUILD=(CYCLE:C'C',                                              
                       PROCESSING_DATE:PARM_VALUE)),                            
       IFTHEN=(WHEN=(PROCESSING_DATE,EQ,C'TODAY!'),                             
                OVERLAY=(PROCESSING_DATE:&DATE1))                               
*                                                                               
*                                                                               
./ ADD NAME=COP1CNTL                                                            
*                                                                               
 INREC PARSE=(%=(ABSPOS=6,ENDBEFR=C'/'),                                        
              %=(ENDBEFR=C'/'),                                                 
              %=(ENDBEFR=C'/'),                                                 
              U_PROCESSING_DATE=(FIXLEN=8),                                     
              U_SERVICE=(ABSPOS=50,ENDBEFR=C'_',FIXLEN=7),                      
              U_MARKET_CODE=(ENDBEFR=C'_',FIXLEN=3),                            
              U_CYCLE=(ENDBEFR=C'_',FIXLEN=1),                                  
              U_SURVEY_YYYY=(ENDBEFR=C'_',FIXLEN=4),                            
              U_SURVEY_MM=(ENDBEFR=C'_',FIXLEN=2),                              
              U_FILENAME_QUALIFIER=(ENDBEFR=C'.',FIXLEN=7),                     
              U_FILE_EXTENSION=(FIXLEN=3)),                                     
    BUILD=(P_RDW,                                                               
           P_CYCLE:U_CYCLE,                                                     
           P_SERVICE:U_SERVICE,                                                 
           P_MARKET_CODE:U_MARKET_CODE,                                         
           P_SURVEY_YYYY:U_SURVEY_YYYY,                                         
           P_SURVEY_MM:U_SURVEY_MM,                                             
           P_FILENAME_QUALIFIER:U_FILENAME_QUALIFIER,                           
           P_PROCESSING_DATE:U_PROCESSING_DATE)                                 
 OUTFIL REMOVECC,VTOF,                                                          
       BUILD=(CYCLE:P_CYCLE,                                                    
              SERVICE:P_SERVICE,                                                
              MARKET_CODE:P_MARKET_CODE,                                        
              SURVEY_YYYY:P_SURVEY_YYYY,                                        
              SURVEY_MM:P_SURVEY_MM,                                            
              FILENAME_QUALIFIER:P_FILENAME_QUALIFIER,                          
              PROCESSING_DATE:P_PROCESSING_DATE)                                
*                                                                               
*                                                                               
./ ADD NAME=COP2CNTL                                                            
*                                                                               
* Find Local Monthlies data files.                                              
* Ignore SRA markets without DMA demo data.                                     
* Ignore DPCUME files unless the service is NSI.                                
*                                                                               
 INCLUDE COND=((PROCESSING_DATE,FS,EQ,NUM,OR,                                   
                PROCESSING_DATE,EQ,REPOSITORY_NAME),AND,                        
                MARKET_CODE,NE,C'290',AND,   * GREAT BEND                       
                MARKET_CODE,NE,C'341',AND,   * HAYS-GOODLAND                    
                MARKET_CODE,NE,C'342',AND,   * ENSIGN-GARDEN CITY               
               (FILENAME_QUALIFIER,NE,C'DPCUME',OR,                             
               (FILENAME_QUALIFIER,EQ,C'DPCUME',AND,                            
                SERVICE,EQ,NSI_SERVICE)),AND,                                   
               (SERVICE,EQ,NSI_SERVICE,OR,                                      
                SERVICE,EQ,NSIX_SERVICE,OR,                                     
                SERVICE,EQ,NSIOLY_SERVICE,OR,                                   
                SERVICE,EQ,NHSI_SERVICE,OR,                                     
                SERVICE,EQ,SVIP_SERVICE,OR,                                     
                SERVICE,EQ,NCM_SERVICE,OR,                                      
                SERVICE,EQ,NSIBLK_SERVICE,OR,                                   
                SERVICE,EQ,NSIXHSP_SERVICE,OR,                                  
                SERVICE,EQ,NSIHSP_SERVICE))                                     
*                                                                               
* DEIS: effective with the Jul/2018 survey, we no longer support the            
*   concept of a "standard" stream, because we will be receiving both           
*   L+7 and L+1 streams for some markets. So going forward, we assign           
*   those streams different sort values (lest we crunch out one of the          
*   streams downstream, thinking that it is a duplicate).                       
 INREC IFTHEN=(WHEN=((FILENAME_QUALIFIER,EQ,C'L7',OR,                           
                      FILENAME_QUALIFIER,EQ,C'L7DMA'),AND,                      
                     SURVEY_YM,GE,DPCUME_USE_L7_FIRST_SURVEY),                  
                      OVERLAY=(SORT_STREAM:C'0'),HIT=NEXT),                     
       IFTHEN=(WHEN=((FILENAME_QUALIFIER,EQ,C'L7',OR,                           
                      FILENAME_QUALIFIER,EQ,C'L7DMA'),AND,                      
                     SURVEY_YM,LT,DPCUME_USE_L7_FIRST_SURVEY),                  
                      OVERLAY=(SORT_STREAM:C'1'),HIT=NEXT),                     
       IFTHEN=(WHEN=(FILENAME_QUALIFIER,EQ,C'L1'),                              
                      OVERLAY=(SORT_STREAM:C'1'),HIT=NEXT),                     
       IFTHEN=(WHEN=(FILENAME_QUALIFIER,EQ,C'LS'),                              
                      OVERLAY=(SORT_STREAM:C'2'),HIT=NEXT),                     
       IFTHEN=(WHEN=(FILENAME_QUALIFIER,EQ,C'LO'),                              
                      OVERLAY=(SORT_STREAM:C'3'),HIT=NEXT),                     
       IFTHEN=(WHEN=(FILENAME_QUALIFIER,EQ,C'L3'),                              
                      OVERLAY=(SORT_STREAM:C'4'),HIT=NEXT),                     
       IFTHEN=(WHEN=ANY,OVERLAY=(FILETYPE:QH_TYPE),HIT=NEXT), *ANY*             
       IFTHEN=(WHEN=(FILENAME_QUALIFIER,EQ,C'PGNAM'),                           
                       OVERLAY=(FILETYPE:PGNAM_TYPE),HIT=NEXT),                 
       IFTHEN=(WHEN=(FILENAME_QUALIFIER,EQ,C'PGNAMUP'),                         
                       OVERLAY=(FILETYPE:PGNAMUP_TYPE),HIT=NEXT),               
       IFTHEN=(WHEN=(FILENAME_QUALIFIER,EQ,C'DPCUME'),                          
                       OVERLAY=(FILETYPE:DPCUME_TYPE),HIT=NEXT),                
       IFTHEN=(WHEN=(SERVICE,EQ,NSI_SERVICE,OR,                                 
                     SERVICE,EQ,NCM_SERVICE,OR,                                 
                     SERVICE,EQ,NSIX_SERVICE),                                  
                       OVERLAY=(SORT_SERVICE:C'1'),HIT=NEXT),                   
       IFTHEN=(WHEN=(SERVICE,EQ,NSIOLY_SERVICE),                                
                       OVERLAY=(SORT_SERVICE:C'1',                              
                                SORT_SURVEY_TYPE:C'O'),HIT=NEXT),               
*&&STRMS                                                                        
       IFTHEN=(WHEN=((FILENAME_QUALIFIER,EQ,C'L3'),AND,                         
                     (SERVICE,EQ,NSI_SERVICE,OR,                                
                      SERVICE,EQ,NSIX_SERVICE)),                                
                       OVERLAY=(SORT_SERVICE:C'8'),HIT=NEXT),                   
       IFTHEN=(WHEN=((FILENAME_QUALIFIER,EQ,C'L3'),AND,                         
                      SERVICE,EQ,NSIOLY_SERVICE),                               
                       OVERLAY=(SORT_SERVICE:C'8',                              
                                SORT_SURVEY_TYPE:C'O'),HIT=NEXT),               
*&&                                                                             
       IFTHEN=(WHEN=(SERVICE,EQ,NHSI_SERVICE),                                  
                       OVERLAY=(SORT_SERVICE:C'2'),HIT=NEXT),                   
       IFTHEN=(WHEN=(SERVICE,EQ,SVIP_SERVICE),                                  
                       OVERLAY=(SORT_SERVICE:C'9'),HIT=NEXT),                   
       IFTHEN=(WHEN=(SERVICE,EQ,NSIBLK_SERVICE),                                
                       OVERLAY=(SORT_SERVICE:C'3'),HIT=NEXT),                   
       IFTHEN=(WHEN=(SERVICE,EQ,NSIHSP_SERVICE,OR,                              
                     SERVICE,EQ,NSIXHSP_SERVICE),                               
                       OVERLAY=(SORT_SERVICE:C'4'))                             
*                                                                               
 OUTFIL FNAMES=TEMP16,                  ** "repo" file list                     
          INCLUDE=(PROCESSING_DATE,EQ,REPOSITORY_NAME,AND,                      
                  (FILETYPE,NE,QH_TYPE,OR,                                      
                  (FILETYPE,EQ,QH_TYPE,AND,                                     
                   SORT_STREAM,NE,C'0')),AND,  ** omit L7/L7DMA                 
                   FILETYPE,NE,C'       ')                                      
*                                                                               
 OUTFIL FNAMES=TEMP25,                  ** "repo" file list: L7/L7DMA           
          INCLUDE=(PROCESSING_DATE,EQ,REPOSITORY_NAME,AND,                      
                   FILETYPE,EQ,QH_TYPE,AND,                                     
                   SORT_STREAM,EQ,C'0')        ** include L7/L7DMA              
*                                                                               
 OUTFIL FNAMES=DATELIST,                ** daily file list (all days)           
          INCLUDE=(PROCESSING_DATE,NE,REPOSITORY_NAME,AND,                      
                   FILETYPE,NE,C'       ')                                      
*                                                                               
 OUTFIL FNAMES=PATHTAB,            ** Tab-delimited file for debugging          
    REMOVECC,                                                                   
    HEADER1=(C'SEP=',X'05',/,      ** show Excel the delimiter                  
             C'CYCLE',X'05',                                                    
             C'SERVICE',X'05',                                                  
             C'MARKET',X'05',                                                   
             C'YEAR',X'05',                                                     
             C'MONTH',X'05',                                                    
             C'QUALIFIER',X'05',                                                
             C'PROCESSING DATE',X'05',                                          
             C'FILETYPE'),                                                      
*                                                                               
    BUILD=(CYCLE,X'05',                                                         
           SERVICE,X'05',                                                       
           C'="',MARKET_CODE,C'"',X'05',  *force Excel to treat as text         
           SURVEY_YYYY,X'05',                                                   
           C'="',SURVEY_MM,C'"',X'05',    *force Excel to treat as text         
           FILENAME_QUALIFIER,X'05',                                            
           PROCESSING_DATE,X'05',                                               
           FILETYPE,X'05',                                                      
           100:X)                          accommodate headline length          
*                                                                               
*                                                                               
./ ADD NAME=JKT1CNTL                                                            
*                                                                               
* F1: DATE= filter from parameter card                                          
* F2: Filename list from processing date symlinks                               
*                                                                               
 JOINKEYS F1=SYSINPAR,FIELDS=(PROCESSING_DATE,A),SORTED                         
 JOINKEYS F2=DATELIST,FIELDS=(PROCESSING_DATE,A),SORTED                         
 REFORMAT FIELDS=(F2:JOB_UNIT,                                                  
                  F2:MARKET_KEY,                                                
                  F2:ALPHA_BOOK,                                                
                  F2:FILENAME_QUALIFIER,                                        
                  F2:PROCESSING_DATE,                                           
                  F2:FILETYPE,                                                  
                  F2:SORT_SURVEY_TYPE,                                          
                  F2:SORT_SERVICE,                                              
                  F2:SORT_STREAM)                                               
*                                                                               
 OUTFIL FNAMES=TEMP9,                                                           
          INCLUDE=(FILETYPE,EQ,QH_TYPE,AND,                                     
                   SORT_STREAM,EQ,C'0') ** only L7/L7DMA from today             
*                                                                               
 OUTFIL FNAMES=TEMP17,SAVE              ** everything else from today           
*                                                                               
*                                                                               
./ ADD NAME=JKT8CNTL                                                            
*                                                                               
* F1: repository file list                                                      
* F2: "Today" file list from processing date symlinks                           
*                                                                               
* The general idea is to catch the situation in which a symlink is              
* present, but the actual file is not. This may mean that the download          
* process is incomplete. However, it may also mean that we want to              
* deliberately generate RC=8 to stop any VIP jobs from being generated.         
* E.g., if we have *both* L7DMA and L7 data, then we do not want to             
* submit a STREAM=L7DMA job under any circumstances. If we happen to            
* run the analyzer with a DATE= card which is more than a couple of             
* weeks old, it is possible that the daily folder will only have L7DMA          
* files. But because the "repo" filelist in "FILELIST" will already             
* have had the L7DMA filenames crunched out of it prior to this point,          
* the JOIN result below will kick out the L7DMA files from "TODAYLST",          
* thereby making it appear as though their download was incomplete.             
* That is stretching the truth, but it works, because it causes RC=8            
* to be generated, thereby inhibiting the VIP job submission. (This             
* really is just defensive code, but it seems prudent.)                         
*                                                                               
 JOINKEYS F1=FILELIST,FIELDS=(MARKET_KEY,A,                                     
                              FILENAME_QUALIFIER,A),SORTED                      
 JOINKEYS F2=TODAYLST,FIELDS=(MARKET_KEY,A,                                     
                              FILENAME_QUALIFIER,A),SORTED                      
 JOIN UNPAIRED,F2,ONLY                                                          
*                      (Ignore NSIOLY files for PGNAM. They are fake!)          
 OUTFIL FNAMES=TEMP14,                                                          
         OMIT=((FILETYPE,EQ,PGNAM_TYPE,OR,                                      
                FILETYPE,EQ,PGNAMUP_TYPE),AND,                                  
                SERVICE,EQ,NSIOLY_SERVICE)                                      
*                                                                               
*                                                                               
./ ADD NAME=COPFCNTL                                                            
*                                                                               
* Catch survey dates in the daily files which are old enough that               
* necessary associated files might have been purged from the repo               
* folder.                                                                       
*                                                                               
* Note: "DATE2"   = DFSORT constant equal to today in YYYYMM format             
*       "DATE2-n" = this month minus n months                                   
 INCLUDE COND=(SURVEY_YM,LE,DATE2-6) *compare to "today minus 6 months"         
*                                                                               
*                                                                               
./ ADD NAME=JKT2CNTL                                                            
*                                                                               
* F1: repository file list                                                      
* F2: "Today" file list from processing date symlinks                           
*                                                                               
 JOINKEYS F1=FILELIST,FIELDS=(MARKET_KEY,A),SORTED                              
 JOINKEYS F2=TODAYLST,FIELDS=(MARKET_KEY,A),SORTED                              
 REFORMAT FIELDS=(F1:JOB_UNIT,                                                  
                  F1:MARKET_KEY,                                                
                  F1:ALPHA_BOOK,                                                
                  F1:FILENAME_QUALIFIER,                                        
                  F2:PROCESSING_DATE,                                           
                  F1:FILETYPE,                                                  
                  F1:SORT_SURVEY_TYPE,                                          
                  F1:SORT_SERVICE,                                              
                  F1:SORT_STREAM)                                               
 SORT FIELDS=(MARKET_KEY,A,FILENAME_QUALIFIER,A,PROCESSING_DATE,A)              
 SUM FIELDS=(NONE)                                                              
*                                                                               
*                                                                               
./ ADD NAME=NORMCNTL                                                            
*                                                                               
 INCLUDE COND=(FILETYPE,EQ,QH_TYPE,AND,SERVICE,NE,NCM_SERVICE)                  
 INREC IFTHEN=(WHEN=INIT,                                                       
                OVERLAY=(SORT_MODE:NORMAL_MODE,                                 
                         JOB_PROCESSING_DATE:PROCESSING_DATE,                   
                         JOB_SERVICE:SERVICE,                                   
                         JOB_SURVEY_YM:SURVEY_YM,                               
                         JOB_STREAM:FILENAME_QUALIFIER,                         
                         JOB_VIP_DUMMY_CARD:DUMMY_VIP_NORMAL,                   
                         JOB_PREPROC_DUMMY_CARD:DUMMY_PREPROC_NORMAL)),         
       IFTHEN=(WHEN=(SORT_STREAM,EQ,C'1',AND,                                   
                     SURVEY_YM,LT,DPCUME_USE_L7_FIRST_SURVEY),                  
                OVERLAY=(FILENAME_QUALIFIER:C'ST',                              
                         JOB_STREAM:FILENAME_QUALIFIER))                        
*                                                                               
 SORT FIELDS=(SORT_SURVEY_TYPE,A,                                               
              SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SORT_STREAM,A,                                                    
              FILENAME_QUALIFIER,A,                                             
              MARKET_CODE,A)                                                    
 SUM FIELDS=(NONE)                                                              
*                                                                               
*                                                                               
./ ADD NAME=NCMSCNTL                                                            
*                                                                               
 INCLUDE COND=(FILETYPE,EQ,QH_TYPE,AND,                                         
               SERVICE,EQ,NCM_SERVICE)                                          
 INREC OVERLAY=(SORT_MODE:NORMAL_MODE,                                          
                JOB_PROCESSING_DATE:PROCESSING_DATE,                            
                JOB_SERVICE:SERVICE,                                            
                JOB_SURVEY_YM:SURVEY_YM,                                        
                JOB_STREAM:FILENAME_QUALIFIER,                                  
                JOB_PREPROC_DUMMY_CARD:DUMMY_PREPROC_NORMAL,                    
                JOB_VIP_DUMMY_CARD:DUMMY_VIP_NCM)                               
 SORT FIELDS=(SORT_SURVEY_TYPE,A,                                               
              SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SORT_STREAM,A,                                                    
              FILENAME_QUALIFIER,A,                                             
              MARKET_CODE,A)                                                    
 SUM FIELDS=(NONE)                                                              
*                                                                               
*                                                                               
./ ADD NAME=DPCUCNTL                                                            
*                                                                               
 INCLUDE COND=(FILETYPE,EQ,DPCUME_TYPE)                                         
 INREC OVERLAY=(SORT_MODE:DPCUME_MODE,                                          
                JOB_PROCESSING_DATE:PROCESSING_DATE,                            
                JOB_SERVICE:SERVICE,                                            
                JOB_SURVEY_YM:SURVEY_YM,                                        
                JOB_STREAM:C'       ')                                          
*                                                                               
*                                                                               
./ ADD NAME=PGNMCNTL                                                            
*                                                                               
* Find the repository files associated with the PGNAM (or PGNAMUP)              
* files in the daily folder.                                                    
*                                                                               
 JOINKEYS F1=FINLLIST,FIELDS=(MARKET_KEY,A),SORTED                              
 JOINKEYS F2=TEMP2,FIELDS=(MARKET_KEY,A),SORTED                                 
 REFORMAT FIELDS=(F1:JOB_UNIT,                                                  
                  F1:MARKET_KEY,                                                
                  F1:ALPHA_BOOK,                                                
                  F1:FILENAME_QUALIFIER,                                        
                  F1:PROCESSING_DATE,                                           
                  F1:FILETYPE,                                                  
                  F1:SORT_SURVEY_TYPE,                                          
                  F1:SORT_SERVICE,                                              
                  F1:SORT_STREAM)                                               
*                                                                               
*                                                                               
./ ADD NAME=SRT1CNTL                                                            
*                                                                               
 INCLUDE COND=(FILETYPE,EQ,QH_TYPE)                                             
 INREC IFTHEN=(WHEN=INIT,                                                       
                OVERLAY=(SORT_MODE:PGNAMUP_MODE,                                
                         JOB_PROCESSING_DATE:PROCESSING_DATE,                   
                         JOB_SERVICE:SERVICE,                                   
                         JOB_SURVEY_YM:SURVEY_YM,                               
                         JOB_STREAM:FILENAME_QUALIFIER,                         
                         JOB_VIP_DUMMY_CARD:DUMMY_VIP_PGNAMUP,                  
                         JOB_PREPROC_DUMMY_CARD:DUMMY_PREPROC_PGNAMUP,          
                         FILETYPE:PGNAMUP_TYPE)),                               
       IFTHEN=(WHEN=(SORT_STREAM,EQ,C'1',AND,                                   
                     SURVEY_YM,LT,DPCUME_USE_L7_FIRST_SURVEY),                  
                OVERLAY=(FILENAME_QUALIFIER:C'ST',                              
                         JOB_STREAM:FILENAME_QUALIFIER))                        
*                                                                               
 SORT FIELDS=(SORT_SURVEY_TYPE,A,                                               
              SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SORT_STREAM,A,                                                    
              FILENAME_QUALIFIER,A,                                             
              MARKET_CODE,A)                                                    
 SUM FIELDS=(NONE)                                                              
*                                                                               
*                                                                               
./ ADD NAME=SRT7CNTL                                                            
*                                                                               
* Sort any L7 files ahead of their corresponding L7DMA files.                   
*                                                                               
 SORT FIELDS=(MARKET_KEY,A,                                                     
              FILENAME_QUALIFIER,A)                                             
*                                                                               
*                                                                               
./ ADD NAME=COP5CNTL                                                            
*                                                                               
* Only consider markets with stream data. This ensures that we pick up          
* any new streams that arrive on a given day.                                   
*                                                                               
 INCLUDE COND=(FILETYPE,EQ,QH_TYPE)                                             
*                                                                               
*                                                                               
./ ADD NAME=SRT2CNTL                                                            
*                                                                               
* Eliminate the duplicate filenames (the only time there would *not*            
* be duplicates for a market is if we did not get a complete fileset            
* on a given day).                                                              
*                                                                               
 SORT FIELDS=(MARKET_KEY,A,FILENAME_QUALIFIER,A)                                
 SUM FIELDS=(NONE)                                                              
*                                                                               
*                                                                               
./ ADD NAME=SRT3CNTL                                                            
*                                                                               
* Sort the file so that subsequent JOINs can be more efficient.                 
*                                                                               
 SORT FIELDS=(MARKET_KEY,A,                                                     
              FILENAME_QUALIFIER,A)                                             
*                                                                               
*                                                                               
./ ADD NAME=JKT3CNTL                                                            
*                                                                               
* F1: repository file list                                                      
* F2: "Today" file list from processing date symlinks                           
*       (Only consider markets containing files relevant to DPCUME              
*        calculations.)                                                         
*                                                                               
 JOINKEYS F1=FILELIST,FIELDS=(MARKET_KEY,A),SORTED                              
 JOINKEYS F2=TODAYLST,FIELDS=(MARKET_KEY,A),SORTED,                             
                      OMIT=(FILETYPE,EQ,PGNAM_TYPE,OR,                          
                            FILETYPE,EQ,PGNAMUP_TYPE)                           
 REFORMAT FIELDS=(F1:JOB_UNIT,                                                  
                  F1:MARKET_KEY,                                                
                  F1:ALPHA_BOOK,                                                
                  F1:FILENAME_QUALIFIER,                                        
                  F2:PROCESSING_DATE,                                           
                  F1:FILETYPE,                                                  
                  F1:SORT_SERVICE,                                              
                  F1:SORT_STREAM)                                               
 INCLUDE COND=((FILENAME_QUALIFIER,EQ,C'L7',OR,                                 
               (FILENAME_QUALIFIER,EQ,C'L1',AND,                                
                SURVEY_YM,LT,DPCUME_USE_L7_FIRST_SURVEY),OR,                    
                FILETYPE,EQ,DPCUME_TYPE),AND,                                   
                SERVICE,EQ,NSI_SERVICE)                                         
 INREC OVERLAY=(JOB_VIP_DUMMY_CARD:DUMMY_VIP_DPCUME,                            
                JOB_PREPROC_DUMMY_CARD:DUMMY_PREPROC_DPCUME)                    
 SORT FIELDS=(MARKET_KEY,A,FILENAME_QUALIFIER,A,PROCESSING_DATE,A)              
 SUM FIELDS=(NONE)                                                              
*                                                                               
*                                                                               
./ ADD NAME=JKT4CNTL                                                            
*                                                                               
* F1: repository file list                                                      
* F2: "Today" file list from processing date symlinks                           
*                                                                               
 JOINKEYS F1=FILELIST,FIELDS=(MARKET_KEY,A),SORTED                              
 JOINKEYS F2=TODAYLST,FIELDS=(MARKET_KEY,A),SORTED,                             
                      INCLUDE=(FILETYPE,EQ,PGNAMUP_TYPE)                        
 REFORMAT FIELDS=(F1:JOB_UNIT,                                                  
                  F1:MARKET_KEY,                                                
                  F1:ALPHA_BOOK,                                                
                  F1:FILENAME_QUALIFIER,                                        
                  F2:PROCESSING_DATE,                                           
                  F1:FILETYPE,                                                  
                  F1:SORT_SURVEY_TYPE,                                          
                  F1:SORT_SERVICE,                                              
                  F1:SORT_STREAM)                                               
 SORT FIELDS=(MARKET_KEY,A,FILENAME_QUALIFIER,A,PROCESSING_DATE,A)              
 SUM FIELDS=(NONE)                                                              
*                                                                               
*                                                                               
./ ADD NAME=JKT5CNTL                                                            
*                                                                               
* F1: repository file list                                                      
* F2: "Today" file list from processing date symlinks                           
*                                                                               
 JOINKEYS F1=FILELIST,FIELDS=(MARKET_KEY,A),SORTED                              
 JOINKEYS F2=TODAYLST,FIELDS=(MARKET_KEY,A),SORTED,                             
                      INCLUDE=(FILETYPE,EQ,PGNAM_TYPE)                          
 REFORMAT FIELDS=(F1:JOB_UNIT,                                                  
                  F1:MARKET_KEY,                                                
                  F1:ALPHA_BOOK,                                                
                  F1:FILENAME_QUALIFIER,                                        
                  F2:PROCESSING_DATE,                                           
                  F1:FILETYPE,                                                  
                  F1:SORT_SURVEY_TYPE,                                          
                  F1:SORT_SERVICE,                                              
                  F1:SORT_STREAM)                                               
 SORT FIELDS=(MARKET_KEY,A,FILENAME_QUALIFIER,A,PROCESSING_DATE,A)              
 SUM FIELDS=(NONE)                                                              
*                                                                               
*                                                                               
./ ADD NAME=JKT9CNTL                                                            
*                                                                               
* F1: all located market/stream combinations                                    
* F2: all available files                                                       
*                                                                               
 JOINKEYS F1=TEMP21,FIELDS=(MARKET_KEY,A)                                       
 JOINKEYS F2=FILELIST,FIELDS=(MARKET_KEY,A),SORTED,                             
                      INCLUDE=(FILETYPE,EQ,PGNAM_TYPE)                          
 REFORMAT FIELDS=(F1:JOB_UNIT,                                                  
                  F1:MARKET_KEY,                                                
                  F1:ALPHA_BOOK,                                                
                  F1:FILENAME_QUALIFIER,                                        
                  F1:PROCESSING_DATE,                                           
                  F1:FILETYPE,                                                  
                  F1:SORT_SURVEY_TYPE,                                          
                  F1:SORT_SERVICE,                                              
                  F1:SORT_STREAM,                                               
                  F1:LATEST_DATE,                                               
                  F1:SORT_MODE)                                                 
*                                                                               
*                                                                               
./ ADD NAME=COP6CNTL                                                            
*                                                                               
* Reformat the book to MMM/YY format.                                           
* Change filetype "QH" to "NORMAL" for the printed report.                      
*                                                                               
 OUTFIL REMOVECC,                                                               
  IFTHEN=(WHEN=INIT,                                                            
   OVERLAY=(ALPHA_MMM:SURVEY_MM,                                                
            CHANGE=(3,           ** LENGTH OF SUBSTITUTED LOOKUP VALUE          
             C'01',C'JAN',                                                      
             C'02',C'FEB',                                                      
             C'03',C'MAR',                                                      
             C'04',C'APR',                                                      
             C'05',C'MAY',                                                      
             C'06',C'JUN',                                                      
             C'07',C'JUL',                                                      
             C'08',C'AUG',                                                      
             C'09',C'SEP',                                                      
             C'10',C'OCT',                                                      
             C'11',C'NOV',                                                      
             C'12',C'DEC'),                                                     
           ALPHA_SLASH:C'/',                                                    
           ALPHA_YY:SURVEY_YY)),                                                
  IFTHEN=(WHEN=(FILETYPE,EQ,QH_TYPE), ** for quarter-hour processing...         
   OVERLAY=(FILETYPE:C'NORMAL '))     ** printed MODE must be "NORMAL"          
*                                                                               
*                                                                               
./ ADD NAME=FMTDCNTL                                                            
*                                                                               
*&!MKTS                                                                         
 INREC OVERLAY=(ALL_STREAMS:C'       ',MARKET_COUNT:X'0001')                    
 SORT FIELDS=(SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SERVICE,A)                                                        
 SUM FIELDS=(MARKET_COUNT)                                                      
*&!                                                                             
*&&MKTS                                                                         
 OPTION COPY                                                                    
*&&                                                                             
 OUTREC OVERLAY=(JOB_SEQNUM:SEQNUM,2,ZD)                                        
*                                                                               
*                                                                               
./ ADD NAME=FMTPCNTL                                                            
*                                                                               
*&&MKTS                                                                         
 INREC OVERLAY=(ALL_STREAMS:C'ALL    ',                                         
                MARKET_COUNT:X'0001')                                           
*&&                                                                             
*&!MKTS                                                                         
* For service NSIHSP, force STREAM=ALL. As of Feb/2019, that is safe,           
* because there are only two NSIHSP markets (Miami and LA) which have           
* more than one stream. So there is no risk of generating a huge number         
* of markets within a job for NSIHSP, and this saves Ops the trouble of         
* potentially dealing with 4 update jobs when 1 will suffice.                   
 INREC IFTHEN=(WHEN=INIT,OVERLAY=(ALL_STREAMS:C'ALL    ',                       
                                  MARKET_COUNT:X'0001')),                       
       IFTHEN=(WHEN=(SERVICE,EQ,NSIHSP_SERVICE,OR,                              
                     SERVICE,EQ,NSIXHSP_SERVICE),                               
                         OVERLAY=(SORT_STREAM:C' ',                             
                                  FILENAME_QUALIFIER:ALL_STREAMS))              
*&!                                                                             
*&!MKTS                                                                         
*&&STRMS                                                                        
 SORT FIELDS=(SORT_SURVEY_TYPE,A,                                               
              SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SERVICE,A,                                                        
              SORT_STREAM,A,                                                    
              FILENAME_QUALIFIER,A)                                             
 SUM FIELDS=(MARKET_COUNT)                                                      
*&&                                                                             
*&!STRMS                                                                        
 SORT FIELDS=(SORT_SURVEY_TYPE,A,                                               
              SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SERVICE,A)                                                        
 SUM FIELDS=(MARKET_COUNT)                                                      
*&!                                                                             
*&!                                                                             
*                                                                               
*&&MKTS                                                                         
 OPTION COPY                                                                    
*&&                                                                             
 OUTREC OVERLAY=(JOB_SEQNUM:SEQNUM,2,ZD)                                        
*                                                                               
./ ADD NAME=FMTNCNTL                                                            
*                                                                               
*&&MKTS                                                                         
 INREC OVERLAY=(ALL_STREAMS:C'ALL    ',                                         
                MARKET_COUNT:X'0001')                                           
*&&                                                                             
*&!MKTS                                                                         
* For service NSIHSP, force STREAM=ALL. As of Feb/2019, that is safe,           
* because there are only two NSIHSP markets (Miami and LA) which have           
* more than one stream. So there is no risk of generating a huge number         
* of markets within a job for NSIHSP, and this saves Ops the trouble of         
* potentially dealing with 4 update jobs when 1 will suffice.                   
 INREC IFTHEN=(WHEN=INIT,OVERLAY=(ALL_STREAMS:C'ALL    ',                       
                                  MARKET_COUNT:X'0001')),                       
       IFTHEN=(WHEN=(SERVICE,EQ,NSIHSP_SERVICE,OR,                              
                     SERVICE,EQ,NSIXHSP_SERVICE),                               
                         OVERLAY=(SORT_STREAM:C' ',                             
                                  FILENAME_QUALIFIER:ALL_STREAMS))              
*&!                                                                             
*&!MKTS                                                                         
*&&STRMS                                                                        
 SORT FIELDS=(SORT_SURVEY_TYPE,A,                                               
              SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SERVICE,A,                                                        
              SORT_STREAM,A,                                                    
              FILENAME_QUALIFIER,A)                                             
 SUM FIELDS=(MARKET_COUNT)                                                      
*&&                                                                             
*&!STRMS                                                                        
 SORT FIELDS=(SORT_SURVEY_TYPE,A,                                               
              SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SERVICE,A)                                                        
 SUM FIELDS=(MARKET_COUNT)                                                      
*&!                                                                             
*&!                                                                             
*                                                                               
*&&MKTS                                                                         
 SORT FIELDS=(SORT_SURVEY_TYPE,A,                                               
              SORT_SERVICE,A,                                                   
              SURVEY_YM,A,                                                      
              SERVICE,A,                                                        
              SORT_STREAM,A,                                                    
              MARKET_CODE,A)                                                    
*&&                                                                             
*                                                                               
 OUTREC OVERLAY=(JOB_SEQNUM:SEQNUM,2,ZD)                                        
*                                                                               
*                                                                               
./ ADD NAME=JKT6CNTL                                                            
*                                                                               
* F1: PGNAM files from daily folder                                             
* F2: PGNAMUP files from daily folder                                           
*                                                                               
 JOINKEYS F1=TEMP5,FIELDS=(MARKET_KEY,A),SORTED,                                
                   INCLUDE=(FILETYPE,EQ,PGNAM_TYPE)                             
 JOINKEYS F2=TODAYLST,FIELDS=(MARKET_KEY,A),SORTED,                             
                   INCLUDE=(FILETYPE,EQ,PGNAMUP_TYPE)                           
 REFORMAT FIELDS=(F1:JOB_UNIT,                                                  
                  F1:MARKET_KEY,                                                
                  F1:ALPHA_BOOK,                                                
                  F1:FILENAME_QUALIFIER,                                        
                  F1:PROCESSING_DATE,                                           
                  F1:FILETYPE,                                                  
                  F1:SORT_SURVEY_TYPE,                                          
                  F1:SORT_SERVICE,                                              
                  F1:SORT_STREAM)                                               
*                                                                               
*                                                                               
./ ADD NAME=SRT5CNTL                                                            
*                                                                               
* Populate the "latest date" field with the most recently found                 
* processing date.                                                              
*                                                                               
 INREC OVERLAY=(LATEST_DATE:PROCESSING_DATE)                                    
 SORT FIELDS=(PROCESSING_DATE,D)                                                
 OUTFIL ACCEPT=1                    ** only keep the first record               
*                                                                               
*                                                                               
./ ADD NAME=JKT7CNTL                                                            
*                                                                               
* F1: Parameter card record                                                     
* F2: Latest date record                                                        
*                                                                               
 JOINKEYS F1=TEMP11,FIELDS=(CYCLE,A),SORTED                                     
 JOINKEYS F2=TEMP10,FIELDS=(CYCLE,A),SORTED                                     
 REFORMAT FIELDS=(F1:JOB_UNIT,                                                  
                  F1:MARKET_KEY,                                                
                  F1:ALPHA_BOOK,                                                
                  F1:FILENAME_QUALIFIER,                                        
                  F1:PROCESSING_DATE,                                           
                  F2:FILETYPE,                                                  
                  F2:SORT_SURVEY_TYPE,                                          
                  F2:SORT_SERVICE,                                              
                  F2:SORT_STREAM,                                               
                  F2:LATEST_DATE)                                               
 OUTREC IFTHEN=(WHEN=(PROCESSING_DATE,EQ,C'LATEST '),                           
                OVERLAY=(PROCESSING_DATE:LATEST_DATE))                          
*                                                                               
*                                                                               
./ ADD NAME=COP8CNTL                                                            
*                                                                               
 INCLUDE COND=((FILETYPE,EQ,PGNAM_TYPE,OR,                                      
                FILETYPE,EQ,PGNAMUP_TYPE),AND,                                  
                SERVICE,EQ,NSI_SERVICE)                                         
 OUTREC OVERLAY=(SERVICE:NSIOLY_SERVICE)                                        
*                                                                               
*                                                                               
./ ADD NAME=JKTDCNTL                                                            
*                                                                               
* Find the quarter-hour repository files associated with the DPCUME             
* files which were found in the daily folder.                                   
*                                                                               
 JOINKEYS F1=FINLLIST,FIELDS=(MARKET_KEY,A),SORTED,                             
              INCLUDE=((FILENAME_QUALIFIER,EQ,C'L7',OR,                         
                       (FILENAME_QUALIFIER,EQ,C'L1',AND,                        
                        SURVEY_YM,LT,DPCUME_USE_L7_FIRST_SURVEY)),AND,          
                        SERVICE,EQ,NSI_SERVICE)                                 
 JOINKEYS F2=TEMP1,FIELDS=(MARKET_KEY,A)                                        
 REFORMAT FIELDS=(F2:JOB_UNIT,                                                  
                  F2:MARKET_KEY,                                                
                  F2:ALPHA_BOOK,                                                
                  F2:FILENAME_QUALIFIER,                                        
                  F2:PROCESSING_DATE,                                           
                  F2:FILETYPE,                                                  
                  F2:SORT_SURVEY_TYPE,                                          
                  F2:SORT_SERVICE,                                              
                  F2:SORT_STREAM,                                               
                  F2:LATEST_DATE,                                               
                  F2:SORT_MODE)                                                 
 SORT FIELDS=(SORT_SERVICE,A,SURVEY_YM,A,MARKET_CODE,A)                         
 SUM FIELDS=(NONE)                    *** only leave one stream                 
*                                                                               
*                                                                               
