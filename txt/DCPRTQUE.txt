         TITLE 'Print queue - Programming Techniques'                           
Introduction                                                                    
------------                                                                    
The print queue is a DDS disk file upon which printed documents can be          
stored for subsequent shipping to remote printer devices. In Jan/85 the         
software was rewritten to form the new print queue, and this document           
will serve both as a conversion aid to programs that already have print         
queue code in them, and also as the recomended method of coding print           
queue requiremnents into future programs. The change from old to new            
that could affect existing programs is the requirement for a larger             
buffer. The old code required a 4000 chr buffer and the new now requires        
a 14336 chr buffer. If the online program uses the TIA as a print queue         
buffer there is no problem as the TIA is 14336 chrs long. If an offline         
program provides its print queue buffer via *INCLUDE DMPQBUFF there is          
also no problem as this module now defines the larger buffer required.          
                                                                                
Relo Modules                                                                    
------------                                                                    
A typical program or link edit deck will contain the following modules.         
There is no need to change these, as after the conversion the new code          
will be copied into the old modules. (Including the 4k to 6k shift).            
                                                                                
*INCLUDE DMPRTQUE                  The basic code module     V(DMPRTQUE)        
*INCLUDE DMPQOPEN                  The open and init module  V(PQOPEN)          
*INCLUDE DMPQBUFF                  The 4k buffer             V(PQBUFF)          
                                                                                
A new program or a converted program should use the new relo modules.           
There is no need to include an open module as the new basic module              
contains the open and initialise code ie. the call to =V(PQOPEN) is no          
longer needed and MUST be removed.The only program that now needs to            
call PQOPEN is FACPAK which has a new specialised open module DMPRTQO.          
The typical offline program or link edit deck should contain:-                  
                                                                                
*INCLUDE DMPRTQ                    The basic/init module     V(DMPRTQUE)        
*INCLUDE DMPRTQB                   The 6K buffer             V(PQBUFF)          
                                                                                
How to add a report into the Print Queue                                        
----------------------------------------                                        
Printer infomation is assumed to be created in a 133chr print line              
which has been pre-filled with spaces.The first chr of the line is              
assumed to be a valid IBM carraige control chr (cc chr). Print lines            
are added to the print queue by use of the c'DMPRINT' datamgr command           
with the C'PRTQU' datamgr file name. To terminate the report the                
convention is to set the cc chr in the first print line to an X'FF'.            
                                                                                
Before any print lines can be added some basic information to define            
the report is required ie the report must be opened. The report is              
opened by setting the whole of the print line to binary zeros, moving           
in some required values, and by issuing the first DMPRINT/PRTQUE.               
Coding examples of the basic write loop and terminate logic is given            
later. There is no change in the old and new print queue for these              
functions, but the new coding example gives better error handling.              
                                                                                
The print queue values are defined by a PQPLD DSECT given by the Pan            
book DMPRTQD. All values must be set to binary zeros and the field              
QLEXTRA at +26 MUST be set to x'FF' to indicate a new call. Examples            
of the code involved in both the new and the old print queue are given          
later. One conversion problem must be noted. As the old open data only          
consisted of a few fields then some programs provided a short print line        
to the open call. The new print queue defines more attributes of a              
report and requires a full 133 chr line into which some default values          
will be moved. The whole 133 chr line must be XC'ed so that non defined         
fields will not be processed. The fields are defined below. The fields          
that are required are defined below. If any field values are missing            
or are invalid the DMPRINT/PRTQUE call will return X'41' in DMCB+8 to           
indicate a format error.                                                        
                                                                                
QLSRCID  The user id number of the origin data. If this field is zero           
-------  for an online program the connect user id in the UTL will be           
         moved into this field. An offline program must set this field.         
                                                                                
QLSUBID  Each report for a given user id is sub defined by a three chr          
-------  subid. For an individual online report this is typically the           
         creator's initials. For a formal offline report this is usually        
         the system and request eg A55. The value of this field cannot          
         be set to ALL, and any special chrs including spaces will be           
         changed to dots eg c'A B' will be set to C'A.B'.                       
                                                                                
QLCLASS  A report can be assigned a class value. This value can be C'A'         
         thru c'Z' or C'0' thru C'9'. Any other value will be set to            
         the default undefined class value of C' ' ie blank.                    
                                                                                
QLSTAT   A report will be created with an ACTV status. If the HOLD              
         status bit is set on (X'40') the report will be created with an        
         initial status of HOLD. If the KEEP bit is set on (X'08') the          
         report will be assigned the KEEP sub status.                           
                                                                                
QLLINET  This field defines the structure of the print line data that           
-------  will be passed in the print line. The value of the bits are            
         defined by equates in the DSECT. A normal print line should            
         be defined by X'C0' ie with cc chr and fixed length (given by          
         the QLLINEW field) NB if both QLLINET and QLLINEW are set to           
         binary zero they are set to X'C0' and 132 ie the system default        
         print line.                                                            
                                                                                
QLLINEW  If the X'40' fixed length data bit is set in QLLINET the fixed         
-------  data length must be set in this field. For a standard print            
         line this should be set to 132. A card deck could be stored            
         in the print queue by setting QLLINET=X'40' and QLLINEW=80.            
                                                                                
QLLPP    The number of lines per page can be set for documentation              
         purposes only. The value of this field has no real effect.             
         If set to zero a default value of 66 or 88 is moved in.                
                                                                                
QLRETNL  This field must be set to the LIVE retain hours. This defines          
-------  the number of hours the report will remain on the print queue          
         if its status remains live (ie it is not printed or sent). If          
         this field is set to X'FFFF' the report will be assigned a             
         permanent live retain date.                                            
                                                                                
QLRETND  This field must be set to the DEAD retain hours. This defines          
-------  the number of hours the report will remain on the print queue          
         after its status changes from live to dead (ie when it is              
         printed or sent this value is used to compute the new retain           
         date). If this value is set to X'FFFF' the report will be              
         permanently retained after printing/sending.                           
                                                                                
QLFORMS  This field is used to define the stationary type required for          
         this report. The format of this four chr field is the same as          
         that used by JCL.                                                      
                                                                                
QLCHARS  This field is used to define the character set required for            
         this report. The format of this four chr field is the same as          
         that used by JCL.                                                      
                                                                                
QLCOPIES This field is used to define the number of copies required             
         for this report. This field is a one byte binary integer.              
                                                                                
QLDESC   This field is used for a free form report description. In some         
         online generated reports it contains a reference number (eg a          
         REP system contract number). In offline programs it should be          
         used to hold a short report name.                                      
                                                                                
QLPSWD   This field contains password data. The password is defined to          
         be six alpha chrs. If the value in this field is non zero the          
         report index entry will be flagged as password protected and           
         some password data must be available for printing or online            
         viewing of the report data.                                            
         EJECT                                                                  
Information passed back to caller                                               
---------------------------------                                               
The process of creating a report on the prtque requires the use of a            
buffer. This buffer must be at least 14336 bytes long and is used to            
hold the print lines for writing to disk. The same buffer that was              
passed at open must be used for all subsequent DMPRINT's including              
the final close. This is because the end of the buffer contains save            
storage used by the print queue module to control the sequence of events        
required to create a report. If a program needs to create two reports           
at the same time two 14k buffers must be provided - one for each report.        
                                                                                
Each report in the print queue is assigned a unique sequence number for         
a given user id. This number runs from 1 thru 65000 and is assigned when        
the report is opened. This number is returned back in the print line            
passed at report open at the field QLREPRNO at +19(2). Also returned in         
the open print line is the disk address of the first control interval           
in the field QLREPRCI at +23(2). If the  current user id has a sequence         
number of 9999 the subsequent opens will return X'80' end of file for           
attempts to add more reports under that user id. The end of file value          
will also be returned at open when there is no more space in the print          
queue ie when no existing reports have passed their expiration time.            
Also note the certain default fields will have been moved in and that           
the QLSUBID field will have been changed if it contains invalid chrs.           
                                                                                
Normal print lines are passed by setting the data in the print line and         
the IBM cc chr in the first byte. These print lines are buffered into           
the passed 6k buffer and written to disk when full. If an X'40' is              
returned at DMCB+8 a disk write error has occurred. If the report needs         
more space on disk a new control interval is searched for. If the print         
queue is full then an X'80' eof error will be passed back at DMCB+8.            
                                                                                
The report is closed by setting an X'FF' in the first byte of the print         
line. The close process consists of turning all control intervals and           
index entrys from temporary to live status and by linking together in a         
forward chain all control intervals aquired by report creation. A normal        
completion is returned in the normal way. If an X'40' is returned a disk        
error was encountered during the close process. If an X'41' is returned         
at DMCB+8 a format error occurred during the close ie the control               
interval linkage could not be performed due to some corruption in the           
file.                                                                           
                                                                                
After a normal close the 6k buffer that has been used during the report         
creation contains the first record of the first control interval. This          
record contains the report header which holds all data avialable for            
the report. The report header is defined by PQRECD DSECT given by the           
Pan book DMPRTQD. This dsect provides infomation such as the report             
sequence number (also passed back at open time) and key data as well as         
the number of lines and pages in the report. The coding examples show           
how this info can be extracted from the buffer after a close.                   
                                                                                
Print Queue - Typical old coding                                                
--------------------------------                                                
OFFLINE  CSECT                     CODE FOUND IN A TYPICAL OFFLINE PROG         
         ...                                                                    
         GOTO1  =V(PQOPEN),DMCB    OPEN AND INIT PRTQUE FILE                    
         BE     *+6                                                             
         DC     H'0'               DIE IF CANT OPEN PRTQUE                      
         ...                                                                    
PQOPEN   LA     R5,OPENINFO        POINT TO PRINT OPEN DATA                     
         USING  PQPLD,R5                                                        
         XC     OPENINFO,OPENINFO  MUST CLEAR ALL FIELDS                        
*                                                                               
         MVC    PLDESC,...         SET REPORT NAME DESCRIPTION                  
         MVC    PLSUBID,...        SET REPORT 3CHR ID (INITIALS)                
         MVI    PLSTAT,X'..'       SET REPORT INIT STAT HOLD/KEEP               
         MVC    PLUSER,...         SET REPORT USER ID                           
         MVC    PLCLASS,...        SET REPORT CLASS                             
*                                                                               
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,OPENINFO,ATIA              
         CLI    DMCB+8,0                                                        
         BNE    EOFERR             ERROR ON OPEN - PROBABLY EOF                 
         MVC    SAVENUM,PLREPNO    SAVE RETURNED REPORT NUMBER                  
*                                                                               
PQFIRST  MVI    P,X'89'            SET SKIP TO TOP OF PAGE                      
         MVC    P+1(132),SPACES                                                 
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,P,ATIA                     
         CLI    DMCB+8,0                                                        
         BNE    DSKERR             ERROR ON FIRST LINE - PROBABLY DISK          
*                                                                               
PQLOOP   MVI    P,X'09'            SET SINGLE SPACE WRITE                       
         MVC    P+1(132),SPACES                                                 
         MVC    P+1(..),......     SET DATA IN PRINT LINE                       
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,P,ATIA                     
         CLI    DMCB+8,0                                                        
         BNE    EOFERR             ERROR ON LINE - PROBABLY EOF                 
         ...                                                                    
         BE     PQLAST             TEST END OF REPORT                           
         ...                                                                    
         B      PQLOOP             BACK FOR NEXT PRINT LINE                     
*                                                                               
PQLAST   MVI    P,X'FF'            SET END OF REPORT                            
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,P,ATIA                     
         CLI    DMCB+8,0                                                        
         BNE    DSKERR             ERROR ON CLOSE - PROBABLY DISK               
*                                                                               
         L      R5,ATIA            POINT TO 4K RECORD BUFFER                    
         USING  PQRECD,R5                                                       
         MVC    SVLINES,PQLINES    SAVE NUMBER OF LINES (XL2)                   
         MVC    SVPAGES,PQPAGES    SAVE NUMBER OF PAGES (XL2)                   
         ...                                                                    
*                                                                               
OPENINFO DS     CL32               PRTQUE REPORT OPEN INFO                      
P        DS     CL133              PRTQUE NORMAL PRINT LINE                     
         ...                                                                    
       INCLUDE  FAPQPL             PQPLD DSECT FOR PRINT LINE OPEN INFO         
       INCLUDE  FAPQRECD           PQRECD DSECT FOR BLOCK REPORT HEADER         
         ...                                                                    
         END                                                                    
         EJECT                                                                  
Print Queue - Recomended new coding                                             
-----------------------------------                                             
PQOPEN   LA     R5,P               POINT TO FULL PRINT LINE FOR OPEN            
         USING  PQPLD,R5                                                        
         XC     P,P                MUST CLEAR ALL FIELDS IN WHOLE LINE          
         MVI    QLEXTRA,X'FF'      SET NEW CALL FLAG FOR EXTRA INFO             
*                                                                               
         MVC    QLSRCID,...        SET REPORT USER ID                           
         MVC    QLSUBID,...        SET REPORT 3CHR ID (INITIALS)                
         MVC    QLCLASS,...        SET REPORT CLASS                             
         MVI    QLSTAT,X'..'       SET REPORT INIT STAT HOLD/KEEP               
         MVI    QLLINET,X'C0'      SET LINE HAS CC CHR & FIXED LENGTH           
         MVI    QLLINEW,132        SET 132 CHR FIXED LENGTH PRINT LINE          
         MVC    QLRETNL,...        SET LIVE RETENTION HOURS                     
         MVC    QLRETND,...        SET DEAD RETENTION HOURS                     
         MVC    QLFORMS,...        SET FORM TYPE REQUIRED                       
         MVC    QLCHARS,...        SET CHARACTER SET REQUIRED                   
         MVC    QLCOPIES,..        SET NUMBER OF COPIES REQUIRED                
         MVC    QLDESC,...         SET REPORT NAME DESCRIPTION                  
         MVC    QLPSWD,...         SET PASSWORD INFO                            
*                                                                               
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,P,ATIA                     
         CLI    DMCB+8,0                                                        
         BE     PQOPENOK                                                        
         TM     DMCB+8,X'80'       EOF - CANT ADD REPORT FOR USER ID            
         BO     EOFERR                                                          
         TM     DMCB+8,X'41'       FMT - INVALID OPEN INFO PASSED               
         BO     FMTERR                                                          
         B      DSKERR             DSK - DISK ERROR ON OPEN                     
*                                                                               
PQOPENOK MVC    SAVEID,QLSUBID     SAVE RETURNED REPORT SUB ID                  
         MVC    SAVENO,QLREPRNO    SAVE RETURNED REPORT SEQ NUM                 
         MVC    SAVEDA,QLREPRCI    SAVE RETURNED DISK ADDR                      
*                                                                               
PQFIRST  MVI    P,X'89'            SET SKIP TO TOP OF PAGE                      
         MVC    P+1(132),SPACES                                                 
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,P,ATIA                     
         CLI    DMCB+8,0                                                        
         BNE    DSKERR             ERROR ON FIRST LINE - PROBABLY DISK          
*                                                                               
PQLOOP   MVI    P,X'09'            SET SINGLE SPACE WRITE                       
         MVC    P+1(132),SPACES                                                 
         MVC    P+1(..),...        SET DATA IN PRINT LINE                       
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,P,ATIA                     
         CLI    DMCB+8,0                                                        
         BE     PQLOOP1                                                         
         TM     DMCB+8,X'80'       EOF - REPORT TOO BIG OR PRTQUE FULL          
         BO     EOFERR                                                          
         B      DSKERR             DSK - DISK ERROR ON WRITE                    
PQLOOP1  ...                                                                    
         BE     PQLAST             TEST END OF REPORT                           
         ...                                                                    
         B      PQLOOP             BACK FOR NEXT PRINT LINE                     
*                                                                               
PQLAST   MVI    P,X'FF'            SET END OF REPORT                            
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,P,ATIA                     
         CLI    DMCB+8,0                                                        
         BE     PQLAST1                                                         
         TM     DMCB+8,X'41'       FMT - PROBLEM WITH PRTQUE STRUCTURE          
         BO     FMTERR                                                          
         B      DSKERR             DSK - DISK ERROR ON WRITE                    
*                                                                               
PQLAST1  L      R5,ATIA            POINT TO PQ RECORD BUFFER                    
         USING  PQRECD,R5                                                       
         MVC    SVLINES,PQLINES+1  SAVE NUMBER OF LINES (XL3)                   
         MVC    SVPAGES,PQPAGES    SAVE NUMBER OF PAGES (XL2)                   
         ...                                                                    
*                                                                               
P        DS     CL133              PRTQUE PRINT LINE FOR OPEN/NORMAL            
         ...                                                                    
       INCLUDE  DMPRTQL            PQPLD DSECT FOR PRINT LINE OPEN INFO         
       INCLUDE  DMPRTQD            PQRECD DSECT FOR BLOCK REPORT HEADER         
         ...                                                                    
         END                                                                    
         EJECT                                                                  
Print Queue - How to replace or extend an existing report                       
---------------------------------------------------------                       
If you know the key of an existing report on the print queue you can            
set this key in the print line at open time, and set a flag QLFLKEY to          
tell the open routine to locate the given report. The whole report will         
be over written by the lines that you add after the open.                       
                                                                                
If you wish to take an existing report and extend it by adding more             
print lines at the end you must also set an extra flag to request that          
the report be extended. This flag is QLFLXTND and this only works if            
QLFLKEY flag is set as well. After doing this special open with the             
QLFLKEY+QLFLXTND flags the report is loacated and the open routine              
positions to after the last line in the report. The lines that you add          
after the open will then go on the end of the report.                           
                                                                                
Sample coding to extend a report is shown below. The QLFLRALL flag means        
set all the QL.... attributes to the existing values in the report that         
is being extended (or replaced).                                                
                                                                                
PQXTND   LA     R5,P               POINT TO FULL PRINT LINE FOR OPEN            
         USING  PQPLD,R5                                                        
         XC     P,P                MUST CLEAR ALL FIELDS IN WHOLE LINE          
         MVI    QLEXTRA,X'FF'      SET NEW CALL FLAG FOR EXTRA INFO             
*                                                                               
         MVC    QLSRCID,...        SET EXISTING REPORT USER ID                  
         MVC    QLSUBID,...        SET EXISTING REPORT 3CHR ID                  
         MVC    QLREPNO,...        SET EXISTING REPORT NUMBER                   
*                                                                               
         MVI    QLFLAG,QLFLRALL+QLFLKEY+QLFLXTND                                
*                                                                               
         GOTO1  DATAMGR,DMCB,=C'DMPRINT',=C'PRTQU',0,P,ATIA                     
         CLI    DMCB+8,0                                                        
         BE     PQOPENOK                                                        
         TM     DMCB+8,X'80'       EOF - CANT ADD REPORT FOR USER ID            
         BO     EOFERR                                                          
         TM     DMCB+8,X'41'       FMT - INVALID OPEN INFO PASSED               
         BO     FMTERR                                                          
         B      DSKERR             DSK - DISK ERROR ON OPEN                     
*                                                                               
PQOPENOK EQU    *                  REPORT IS OPEN FOR EXTENSION                 
                                                                                
FAPQPL Pan book - Old print line dsect                                          
--------------------------------------                                          
PQPLD    DSECT                     ***** PRINT QUEUE PRINT LINE *****           
PLCC     DS    XL1       +00       CONTROL CHR X'00'=OPEN,X'FF'=CLOSE           
PLDESC   DS    CL11      +01       REPORT DESCRIPTION                           
PLSUBID  DS    CL3       +12       REPORT SUB ID                                
PLSTAT   DS    XL1       +15       REPORT INITIAL STATUS                        
PLLPP    DS    XL1       +16       LINES PER PAGE                               
PLUSER   DS    XL2       +17       USER ID NUMBER (OFFLINE ONLY)                
PLREPNO  DS    XL2       +19       REPORT SEQUENCE NUMBER                       
PLREPNOX DS    XL2       +21       REPORT SEQUENCE NUMBER MAXIMUM               
PLSTRCI  DS    XL2       +23       START CONTROL INTERVAL TRACK                 
PLCLASS  DS    CL1       +25       REPORT CLASS                                 
                                                                                
FAPQREC Pan book - Old record header dsect                                      
------------------------------------------                                      
PQRECD   DSECT                     ***** PRINT QUEUE RECORD *****               
*                                                                               
* FIRST PART OF RECORD IS INDEX ENTRY                                           
*                                                                               
PQINDEX  DS    0CL14                                                            
PQKEY    DS    0CL8                                                             
PQSRCID  DS    XL2                 SOURCE ID NUMBER                             
PQSUBID  DS    CL3                 SOURCE SUB-ID                                
PQREPNO  DS    XL2                 REPORT SEQUENCE NUMBER                       
PQCLASS  DS    CL1                 REPORT CLASS                                 
PQSEQ    DS    XL1                 SEQUENCE NUMBER (0=ONLY ONE CI)              
PQSTAT   DS    XL1                 REPORT STATUS                                
PQAGED   DS    XL2                 AGE DATE                                     
PQAGET   DS    XL1                 AGE TIME (PACKED HOURS)                      
PQAGES   DS    XL1                 AGE SIZE (NUM OF CI'S)                       
*                                                                               
STACTV   EQU   X'80'               CREATION COMPLETE - ACTIVE                   
STHOLD   EQU   X'40'               CREATION COMPLETE - HOLD                     
STPRTD   EQU   X'20'               PRINTING COMPLETE                            
STCREAT  EQU   X'10'               CREATION IN PROCESS                          
STPNTG   EQU   X'10'               PRINTING IN PROCESS                          
STKEEP   EQU   X'08'               KEEP REPORT AFTER PRINTING                   
STSENT   EQU   X'02'               SENT TO REMOTE MINI                          
STLIVE   EQU   X'C0'               LIVE - ACTIVE OR HOLD                        
STDEAD   EQU   X'22'               DEAD - PRINTED OR SENT                       
STPURGE  EQU   X'00'               PURGED                                       
*                                                                               
* SECOND PART OF RECORD IS REPORT ATTRIBUTES                                    
*                                                                               
PQLINES  DS    H                   NUMBER OF LINES                              
PQPAGES  DS    H                   NUMBER OF PAGES                              
PQCPL    DS    XL1                 AVERAGE NUMBER OF CHRS PER LINE              
PQLPP    DS    XL1                 LINES PER PAGE                               
PQHIPAGE DS    H                   HIGHEST PAGE NUMBER IN THIS BLOCK            
PQCINEXT DS    H                   TTTT OF NEXT CI                              
*                                                                               
PQDATEC  DS    XL3                 DATE CREATED - P'YMD'                        
PQTIMEC  DS    XL2                 TIME CREATED - P'HM'                         
PQDATEP  DS    XL3                 DATE PRINTED - P'YMD'                        
PQTIMEP  DS    XL2                 TIME PRINTED - P'HM'                         
*                                                                               
PQPRLOC  DS    XL2                 LOCATATION ID WHERE PRINTED                  
PQPRNUM  DS    XL1                 PRINTER NUMBER WHERE PRINTED                 
PQDESC   DS    CL11                REPORT DESCRIPTION                           
*                                                                               
* THIRD PART OF RECORD IS PRINT LINE ELEMENTS                                   
*                                                                               
PQDATA   DS    0C                  XL1=LEN,XL1=CCC,XLN=DATA                     
                                                                                
DMPRTQL Pan book - new print line dsect                                         
---------------------------------------                                         
PQPLD    DSECT                     ***** PRINT QUEUE PRINT LINE *****   00001   
*                                                                       00002   
PLOLD    DS    0CL28 ============= 0TH PART OF LINE IS OLD OPEN DATA    00003   
PLCC     DS    XL1       +00       CONTROL CHR X'00'=OPEN,X'FF'=CLOSE   00004   
PLDESC   DS    CL11      +01       REPORT DESCRIPTION                   00005   
PLSUBID  DS    CL3       +12       REPORT SUB ID                        00006   
PLSTAT   DS    XL1       +15       REPORT INITIAL STATUS                00007   
PLLPP    DS    XL1       +16       LINES PER PAGE                       00008   
PLUSER   DS    XL2       +17       USER ID NUMBER (OFFLINE ONLY)        00009   
PLREPNO  DS    XL2       +19     * REPORT SEQUENCE NUMBER               00010   
PLREPNOX DS    XL2       +21     * REPORT SEQUENCE NUMBER MAXIMUM       00011   
PLSTRCI  DS    XL2       +23     * START CONTROL INTERVAL TRACK         00012   
PLCLASS  DS    CL1       +25       REPORT CLASS                         00013   
*                                                                       00014   
         ORG   PLOLD                                                    00015   
QLSOFLAB DS    CL10      +00       **SOFSOF** START OF REPORT LABEL     00016   
QLAGELT  DS    XL2       +10       RETURNED REPORT CREATION TIME        00017   
         DS    XL2       +12       RESERVED FOR LAST 02 BYTES INDEX     00018   
         DS    XL4       +14       RESERVED FOR LAST 24 BYTES DATA      00019   
         DS    XL1       +18       RESERVED FOR CONTROL OF NEW DATA     00020   
QLREPRNO DS    XL2       +19       RETURNED REPORT NUMBER               00021   
QLREPINT DS    XL1       +21       RETURNED PRTQ FILE INTERNAL NUMBER   00022   
QLREPCHR DS    XL1       +22       RETURNED PRTQ FILE ALPHA CHR         00023   
QLREPRCI DS    XL2       +23       RETURNED CONTROL INTERVAL DISK ADDR  00024   
         DS    XL1       +25       N/D                                  00025   
*                                                                       00026   
QLEXTRA  DS    XL1       +26       MUST SET TO X'FF' FOR EXTRA VALUES   00027   
QLFLAG   DS    XL1       +27       FLAGS FOR PASSING ATTRIBUTES         00028   
*                                                                       00029   
QLFLCIDA EQU   X'80'               USE CONTROL INTERVAL DISK ADDRESS    00030   
QLFLRST  EQU   X'40'               STATUS FROM RECORD                   00031   
QLFLRDT  EQU   X'20'               DATE/TIME FROM RECORD                00032   
QLFLRRE  EQU   X'10'               RETAIN FROM RECORD                   00033   
QLFLRALL EQU   X'08'               EVERY VALUE FROM RECORD              00034   
QLFLXTND EQU   X'04'               EXTEND THE REPORT FOR QLFLKEY        00035**8
QLFLKEY  EQU   X'02'               USE REPORT DEFINED BY QLKEY          00036**6
QLFLDD   EQU   X'01'               CALL DICTATE FOR DATA DICTIONARY     00037   
*                                                                       00038   
QLINDEX  DS    0CL20 ============= 1ST PART OF REC IS INDEX             00039   
QLKEY    DS    0CL7                                                     00040   
QLSRCID  DS    XL2                 SOURCE ID NUMBER                     00041   
QLSUBID  DS    CL3                 SOURCE SUB-ID                        00042   
QLREPNO  DS    XL2                 REPORT SEQUENCE NUMBER               00043   
QLCLASS  DS    CL1                 REPORT CLASS                         00044   
*                                                                       00045**3
QLTYPE   DS    XL1                 REPORT TYPE                          00046**3
QLTYUPDT EQU   X'80'               UPDATIVE SOON REPORT                 00047**3
QLTYRSND EQU   X'40'               REMOTE SEND PENDING                  00048**3
QLTYRRCV EQU   X'20'               REMOTE RECEIVE PENDING               00049**3
QLTYDL   EQU   X'10'               REPORT IN DOWN LOADABLE FORMAT       00050**3
QLTYSQL  EQU   X'08'               REPORT REQUIRES CONVERSION TO SQL    00051**5
QLTYONS  EQU   X'04'               OVERNIGHT SOON REPORT                00052**7
QLTYONL  EQU   X'01'               REPORT CREATED ONLINE                00053**3
*                                                                       00054   
QLATTB   DS    XL1                 REPORT ATTRIBUTES                    00055**3
QLATPW   EQU   X'80'               ATTRIB PASSWORD PROTECTED            00056   
QLATNP   EQU   X'40'               ATTRIB NON PRINTABLE (NO CC)         00057   
QLATUSR  EQU   X'20'               ATTRIB REPORT HAS USER DATA          00058   
QLATUSRW EQU   X'10'               ATTRIB REPORT HAS USER WKFILE DATA   00059   
QLATWIDE EQU   X'08'               ATTRIB WIDE REPORT PQMAXCPL GT 132   00060   
QLATERR  EQU   X'04'               ATTRIB REPORT IN ERROR               00061   
QLATJOBO EQU   X'02'               ATTRIB JOB OUTPUT                    00062   
QLATJOBI EQU   X'01'               ATTRIB JOB INPUT (CONTAINS JCL)      00063   
QLATSHIT EQU   X'47'               REPORT CI TRACK NON READABLE         00064   
*                                                                       00065   
QLSTAT   DS    XL1                 REPORT STATUS                        00066   
QLSTAC   EQU   X'80'               STATUS ACTIVE (DEFAULT)              00067**5
QLSTHO   EQU   X'40'               STATUS HOLD                          00068**5
QLSTKE   EQU   X'08'               STATUS KEEP                          00069**5
QLSTIN   EQU   X'02'               STATUS INVISIBLE                     00070**5
*                                                                       00071**5
         DS    XL1                 N/A                                  00072   
QLAGES   DS    XL1                 REPORT NUM OF CI'S                   00073   
QLAGELD  DS    XL2                 REPORT AGE LIVE                      00074   
QLAGEDD  DS    XL2                 REPORT AGE DEAD                      00075   
QLAGERD  DS    XL2                 REPORT AGE RETAIN                    00076   
         DS    XL1                                                      00077   
*                                                                       00078   
QLBATTR  DS    0CL16 ============= 2ND PART OF REC IS BLOCK ATTRIBUTES  00079   
         DS    XL2                 N/A                                  00080   
QLLINES  DS    XL3                 NUMBER OF LINES                      00081   
QLPAGES  DS    XL2                 NUMBER OF PAGES                      00082   
         DS    XL5                 N/A                                  00083   
QLLINET  DS    XL1                 LINE TYPE                            00084   
QLLINEW  DS    XL1                 LINE WIDTH IN CHARACTERS             00085   
QLLPP    DS    XL1                 LINES PER PAGE                       00086   
         DS    XL1                                                      00087   
*                                                                       00088   
QLLTCC   EQU   X'80'               1ST CHR OF DATA IS CARRIAGE CONTROL  00089   
QLLTFL   EQU   X'40'               LINE HAS FIXED LEN GIVEN BY QLLINEW  00090   
QLLTDC   EQU   X'20'               DATA IS COMPESSABLE                  00091   
QLLTLA   EQU   X'10'               DATA CONTAINS LASER SPECIAL CHRS     00092   
*                                                                       00093   
QLFATTR  DS    0CL69 ============= 3RD PART OF REC IS REPORT ATTR       00094**4
         DS    XL2                                                      00095   
QLDATEL  DS    XL2                 DATE CREATED - CMPRSD                00096   
QLTIMEL  DS    XL2                 TIME CREATED - BINARY                00097   
QLRETNL  DS    XL2                 RETENTION HOURS FOR LIVE REPORT      00098   
QLDATED  DS    XL2                 DATE PRINTED - CMPRSD                00099   
QLTIMED  DS    XL2                 TIME PRINTED - BINARY                00100   
QLRETND  DS    XL2                 RETENTION HOURS FOR DEAD REPORT      00101   
QLPRCNT  DS    XL1                 PRTD/SENT COUNTER                    00102   
QLPRLOC  DS    XL2                 PRTD/SENT LOCATION ID                00103   
QLPRNUM  DS    XL1                 PRTD/SENT DEVICE NUM SUB LOCATION    00104   
QLPRSYM  DS    CL8                 PRTD/SENT DEVICE VTAM SYMBOLIC ID    00105   
         ORG   QLPRSYM                                                  00106   
QLPRREF  DS    XL2                 BTAM FLAG ZEROS IF BTAM DEVICE       00107   
QLPRLINE DS    CL4                 BTAM LINE ID                         00108   
QLPRADDR DS    XL2                 BTAM TERM ID CUDV IN HEX             00109   
*                                                                       00110   
QLFORMS  DS    CL4                 REPORT FORMS CODE                    00111   
QLCHARS  DS    CL4                 REPORT CHARACTER SET                 00112   
QLCOPIES DS    XL1                 REPORT NUMBER OF COPIES              00113   
         DS    XL2                 N/A                                  00114   
QLDESC   DS    CL11                REPORT DESCRIPTION                   00115   
QLPSWD   DS    CL6                 REPORT PASSWORD                      00116   
QLRNUM   DS    XL2                 REPORT REMOTE REPORT NUMBER          00117**2
QLUSRINF DS    CL8                 REPORT USER SUPPLIED DATA            00118   
*                                                                       00119   
QLMAKER  DS    0CL5                REPORT MAKER ID                      00120**2
QLSYS    DS    CL1                 REPORT SYSTEM                        00121**2
QLPRG    DS    CL2                 REPORT PROGRAM                       00122**2
QLPRGSUB DS    CL2                 REPORT SUBPROGRAM                    00123**2
*                                                                       00124   
QLSOFEND DS    0C                  END OF SOF HEADER RECORD             00125   
                                                                                
DMPRTQD Pan book - New record header dsect                                      
------------------------------------------                                      
PQRECD   DSECT                     ***** PRINT QUEUE RECORD *****       00001   
*                                                                       00002   
PQINDEX  DS    0CL24 ============= 1ST PART OF REC IS INDEX             00003   
PQKEY    DS    0CL7                                                     00004   
PQSRCID  DS    XL2                 SOURCE ID NUMBER                     00005   
PQSUBID  DS    CL3                 SOURCE SUB-ID                        00006   
PQREPNO  DS    XL2                 REPORT SEQUENCE NUMBER               00007   
PQCLASS  DS    CL1                 REPORT CLASS                         00008   
*                                                                       00009   
PQTYPE   DS    CL1                 REPORT TYPE                          00010   
PQTYUPDT EQU   X'80'               UPDATIVE SOON REPORT                 00011   
PQTYRSND EQU   X'40'               REMOTE SEND PENDING                  00012   
PQTYRRCV EQU   X'20'               REMOTE RECEIVE PENDING               00013   
PQTYDL   EQU   X'10'               REPORT IN DOWN LOADABLE FORMAT       00014   
PQTYSQL  EQU   X'08'               REPORT REQUIRES CONVERSION TO SQL    00015**3
PQTYXCI  EQU   X'04'               REPORT CI IS EXTENSION               00016**2
PQTYXTN  EQU   X'02'               REPORT HAS EXTENSION CI'S            00017**2
PQTYONL  EQU   X'01'               REPORT CREATED ONLINE                00018   
*                                                                       00019   
PQATTB   DS    XL1                 REPORT ATTRIBUTES                    00020   
PQATPW   EQU   X'80'               ATTRIB PASSWORD PROTECTED            00021   
PQATNP   EQU   X'40'               ATTRIB NON PRINTABLE (NO CC)         00022   
PQATUSR  EQU   X'20'               ATTRIB REPORT HAS USER DATA          00023   
PQATUSRW EQU   X'10'               ATTRIB REPORT HAS USER WKFILE DATA   00024   
PQATWIDE EQU   X'08'               ATTRIB WIDE REPORT PQMAXCPL GT 132   00025   
PQATERR  EQU   X'04'               ATTRIB REPORT IN ERROR               00026   
PQATJOBO EQU   X'02'               ATTRIB JOB OUTPUT                    00027   
PQATJOBI EQU   X'01'               ATTRIB JOB INPUT (CONTAINS JCL)      00028   
PQATSHIT EQU   X'47'               REPORT CI TRACK NON READABLE         00029   
*                                                                       00030   
PQSTAT   DS    XL1                 REPORT STATUS                        00031   
PQSTAC   EQU   X'80'               STATUS ACTIVE                        00032   
PQSTHO   EQU   X'40'               STATUS HOLD                          00033   
PQSTLIVE EQU   X'C0'               STATUS LIVE - ACTIVE OR HOLD         00034   
PQSTPR   EQU   X'20'               STATUS PRINTED                       00035   
PQSTSE   EQU   X'10'               STATUS SENT                          00036   
PQSTDEAD EQU   X'30'               STATUS DEAD - PRINTED OR SENT        00037   
PQSTKE   EQU   X'08'               STATUS KEEP                          00038   
PQSTDL   EQU   X'04'               STATUS DELETED                       00039   
PQSTIN   EQU   X'02'               STATUS INVISIBLE                     00040**3
PQSTTE   EQU   X'01'               STATUS TEMP - CREATION IN PROCESS    00041   
PQSTPG   EQU   X'01'               STATUS TEMP - PRINTING IN PROCESS    00042   
PQSTPU   EQU   X'00'               STATUS PURGED                        00043   
*                                                                       00044   
PQSEQ    DS    XL1                 CI SEQ NUMBER    (0=ONLY ONE CI)     00045   
PQAGES   DS    XL1                 AGE SIZE         (FACTOR PQLINES)    00046   
PQAGELD  DS    XL2                 AGE DATE LIVE    (BINARY COMPR)      00047   
PQAGEDD  DS    XL2                 AGE DATE DEAD    (BINARY COMPR)      00048   
PQAGERD  DS    XL2                 AGE DATE RETAIN  (BINARY COMPR)      00049   
PQAGERT  DS    XL1                 AGE TIME RETAIN  (BINARY 10MIN)      00050   
PQAGELT  DS    XL2                 AGE TIME LIVE    (BINARY (SECS*3)/4) 00051   
         DS    XL2                 N/D                                  00052   
         SPACE 1                                                        00053   
PQBATTR  DS    0CL16 ============= 2ND PART OF REC IS BLOCK ATTRIBUTES  00054   
PQCINEXT DS    XL2                 TTTT OF NEXT CI                      00055   
PQLINES  DS    XL3                 NUMBER OF LINES (LOWEST IN BLOCK)    00056   
PQPAGES  DS    XL2                 NUMBER OF PAGES (LOWEST IN BLOCK)    00057   
PQLINEH  DS    XL3                 HIGHEST LINE NUMBER IN THIS BLOCK    00058   
PQPAGEH  DS    XL2                 HIGHEST PAGE NUMBER IN THIS BLOCK    00059   
PQLINET  DS    XL1                 LINE TYPE                            00060   
PQLINEW  DS    XL1                 LINE WIDTH IN CHARACTERS             00061   
PQLPP    DS    XL1                 LINES PER PAGE                       00062   
PQBFLAG  DS    XL1                 BLOCK FLAGS                          00063   
*                                                                       00064   
PQLTCC   EQU   X'80'               1ST CHR OF DATA IS CARRIAGE CONTROL  00065   
PQLTFL   EQU   X'40'               LINE HAS FIXED LEN GIVEN BY PQLINEW  00066   
PQLTDC   EQU   X'20'               DATA IS COMPESSABLE                  00067   
PQLTLA   EQU   X'10'               DATA CONTAINS LASER SPECIAL CHRS     00068   
PQBFNP   EQU   X'80'               BLOCK CONTAINS NEW PAGE CC CHR       00069   
         SPACE 1                                                        00070   
PQDATA   DS    0C    ============= 3RD PART OF REC IS REPORT ATTR/DATA  00071   
PQFATTR  DS    0CL88                                                    00072   
PQAVCPL  DS    XL2                 AVERAGE NUMBER OF CHRS PER LINE      00073   
*                                                                       00074   
PQDATEL  DS    XL2                 DATE CREATED - CMPRSD                00075   
PQTIMEL  DS    XL2                 TIME CREATED - BINARY                00076   
PQRETNL  DS    XL2                 RETENTION HOURS FOR LIVE REPORT      00077   
PQDATED  DS    XL2                 DATE PRINTED - CMPRSD                00078   
PQTIMED  DS    XL2                 TIME PRINTED - BINARY                00079   
PQRETND  DS    XL2                 RETENTION HOURS FOR DEAD REPORT      00080   
PQPRCNT  DS    XL1                 PRTD/SENT COUNTER                    00081   
PQPRLOC  DS    XL2                 PRTD/SENT LOCATION ID                00082   
PQPRNUM  DS    XL1                 PRTD/SENT DEVICE NUM SUB LOCATION    00083   
PQPRSYM  DS    CL8                 PRTD/SENT DEVICE VTAM SYMBOLIC ID    00084   
*                                                                       00085   
PQFORMS  DS    CL4                 REPORT FORMS CODE                    00086   
PQCHARS  DS    CL4                 REPORT CHARACTER SET                 00087   
PQCOPIES DS    XL1                 REPORT NUMBER OF COPIES              00088   
PQNCI    DS    XL1                 REPORT NUMBER OF CONTROL INTERVALS   00089   
PQMAXCPL DS    XL1                 REPORT MAXIMUM CHRS PER LINE         00090   
PQDESC   DS    CL11                REPORT DESCRIPTION                   00091   
PQPSWD   DS    CL6                 REPORT PASSWORD                      00092   
PQRNUM   DS    XL2                 REPORT REMOTE PQ NUMBER              00093   
*                                                                       00094   
PQUSRINF DS    0XL8                USER SUPPLIED DATA                   00095   
PQUSRTY  DS    CL1                 USER DATA TYPE                       00096   
PQUSRTYW EQU   C'W'                USER DATA TYPE IS A WORKER FILE      00097   
PQUSRTYP EQU   C'P'                USER DATA TYPE IS A PRTQUE FILE      00098   
PQUSRCI  DS    XL2                 USER DATA CI ADDR                    00099   
PQUSRDA  DS    XL5                 USER DATA DATA                       00100   
*                                                                       00101   
PQMAKER  DS    0CL5                REPORT MAKER ID                      00102   
PQSYS    DS    CL1                 REPORT SYSTEM                        00103   
PQPRG    DS    CL2                 REPORT PROGRAM                       00104   
PQPRGSUB DS    CL2                 REPORT SUBPROGRAM                    00105   
*                                                                       00106   
         DS    XL3                 N/D                                  00107   
PQNCIX   DS    XL1                 NUMBER OF EXTENSION CI'S             00108**2
PQDAEOR  DS    XL3                 TTTTBB OF LAST BLOCK IN REPORT       00109**4
PQCIEOR  DS    XL2                 TTTT OF LAST CI IN REPORT            00110**4
         DS    XL10                N/D                                  00111**4
*                                                                       00112   
PQDATA1  DS    0C                  XL2=LEN (XL1=CCC) XLN=DATA           00113   
------------------------------------------                                      
                                                                                
Locating a report in the Print Queue                                            
------------------------------------                                            
Once a report has been added to the printque it can be located by the           
datamgr command INDEX. To locate a report the caller must provide the           
userid num, the report id, and the report sequence number. These fields         
are part of a 40 byte index area defined by the UKRECD DSECT in the             
Pan book DMPRTQK. This DESCT is detailed below. The caller fills in             
various fields in the index area and calls DATAMGR passing the address          
of the area in DMCBW3.                                                          
                                                                                
The INDEX call searches the prtque index for reports that match the info        
set in the index area,and returns full index data of report(s) that             
match. The caller's buffer in DMCBW5 is used to read the index and when         
a report is found details of the report are saved in a save area at the         
end of the buffer. Sample code is as follows :                                  
                                                                                
         XC    INDEX,INDEX        CLEAR ALL INDEX FIELDS                        
         LA    RE,INDEX                                                         
         USING UKRECD,RE                                                        
         MVC   UKSRCID,...        REPORT USER ID                                
         MVC   UKSUBID,...        REPORT ID                                     
         MVC   UKREPID,...        REPORT SEQUENCE NUMBER                        
*                                                                               
         GOTO1 DATAMGR,DMCB,(X'00',=C'INDEX'),=C'PRTQU',INDEX,P,ATIA            
         CLI   DMCB+8,0                                                         
         BE    FOUND                                                            
         TM    DMCB+8,X'80'       EOF - REPORT NOT FOUND                        
         BO    NOTFOUND                                                         
         DC    H'0'               DISK ERROR READING INDEX                      
*                                                                               
INDEX    DS    XL40               USER INDEX ERROR                              
                                                                                
Processing a report in the Print Queue                                          
--------------------------------------                                          
Once a report has been located by the INDEX call described above it can         
be processed with a set of Data Manager commands. The caller must pass          
the same index area in DMCBW3 and Buffer area in DMCBW5 as used in the          
preceeding INDEX call. DMCBW4 is the area where print lines are passed          
back if required.                                                               
                                                                                
The report status can be changed by the following DMCBW1 commands :             
ACTIVATE - Set primary status to Active                                         
HOLD     - Set primary status to Hold                                           
PRINTED  - Set primary status to Printed                                        
SENT     - Set primary status to Sent                                           
PURGE    - Purge report from PQ                                                 
KEEP     - Set status to keep                                                   
INVISIB  - Set status to invisible                                              
UNKEEP   - Turn off keep status                                                 
VISIBLE  - Turn off invisible status                                            
UNERROR  - Turn off error status                                                
RETAIN   - Change retain hours                                                  
                                                                                
The READ data manager command will read sequentially each report line.          
Each READ comand returns the next print queue line into the area pointed        
to by DMCBW4. A return code of X'80' in DMCBW3(1) means end or report.          
                                                                                
The RANDOM data manager command will locate a nominated line in the             
report and return it at DMCBW4. To locate the nth line in a report set          
DMCBW4 to the 8 chr value llllLINE where llll is the binary line number.        
To locate the nth line on a given page set DMCBW4 to the 12 chr value           
ppppPAGEnnnn where pppp=binary page number and nnnn=binary line number          
relative to that page. The example below shows how to read the first            
line of page 7 :                                                                
                                                                                
         MVC   P+0(4),=F'7'                                                     
         MVC   P+4(4),=C'PAGE'                                                  
         MVC   P+8(4),=F'1'                                                     
         GOTO1 DATAMGR,DMCB,(X'00',=C'RANDOM'),=C'PRTQU',INDEX,P,ATIA           
         CLI   DMCB+8,0                                                         
         BE    FOUND                                                            
         TM    DMCB+8,X'90'       END OF REPORT/PAGE NOT FOUND                  
         BNZ   NOTFOUND                                                         
                                                                                
Saving and restoring of PQ Buffers                                              
------------------------------------                                            
As mentioned earlier when processing a report,either adding or reading,         
the same 14k buffer must be used, as the end of the buffer contains a           
save area in which are stored details of the last report record read or         
added into the buffer. The Pan book DMPRTQS gives the SKBUFFD DSECT that        
defines this save area. This is shown below. If a print queue report is         
read over several transactions the contents of the PQ buffer must be            
saved at the end of a trasaction,and restored at the start of the next          
transaction,so that processing can continue on the report.                      
                                                                                
There are three special PQ actions that can be used to initialise, save,        
and restore a PQ buffer. There is also a special action that returns the        
PQ id of the file where reports for a given userid reside. The simple           
                                                                                
If during the first transaction a file was located (via an INDEX call)          
and the next transaction needs to refer to the file (say to READ it).           
The user provides a 30 byte save area in TEMPSTR (TWASAVI in the example        
below) and codes a BUSAVE command to save the relevent fields and then          
in the subsequent transaction uses a BURSTR command to restore.                 
                                                                                
*End of transaction n - save basic index info using BUSAVE                      
         ...                                                                    
         GOTO1 DATAMGR,DMCB,(X'00',=C'BUSAVE'),=C'PRTQU',INDEX,P,ATIA           
         MVC   TWASAVI(30),P                                                    
                                                                                
*Start of transaction n+1- restore basic index info usin BURSTR                 
         ...                                                                    
         MVC   P(30),TWASAVI                                                    
         GOTO1 DATAMRR,DMCB,(X'00',=C'BURSTR'),=C'PRTQU',INDEX,P,ATIA           
                                                                                
Saving and restoring of PQ Buffers for full Optimisation                        
--------------------------------------------------------                        
For true optimisation where a transaction can terminate in the middle of        
a print queue read loop, and restart with the next record, more work has        
to be done as the print queue buffer has to be fully restored, including        
the print queue record. In this case we need a 96 byte TWA save area to         
save the whole of the print queue buffer area. Sample code showning what        
to do to at end of transaction n and at the start of transaction n+1 is         
shown below.                                                                    
                                                                                
*Start of first transaction - Initialise buffer and save disp to buffer         
*save area. Also save the prtq name where the report will be stored.            
*Locate the required file with an IONDEX call.                                  
         ...                                                                    
         GOTO1 DATAMGR,DMCB,(X'00',=C'BUFFER'),=C'PRTQU',INDEX,P,ATIA           
         L     RE,ATIA                                                          
         MVC   SAVEBDSP(4),8(RE)   SAVE DISP TO START OF BUFFER SAVE            
         LA    RE,INDEX                                                         
         XC    INDEX,INDEX         SET USERID NUM IN INDEX                      
         MVC   UKSRCID-UKRECD(2,RE),USERID                                      
         GOTO1 DATAMGR,DMCB,(X'00',=C'GFILE'),=C'PRTQU',INDEX,P,ATIA            
         LA    RE,INDEX                                                         
         MVC   SAVEPQID(8),UKUSRINF-UKRECD(RE) SAVE PQID FOR USERID             
         MVC   UKSRCID-UKRECD(2),USERID                                         
         MVC   UKSUBID-UKRECD(2),SUBID                                          
         MVC   UKREPID-UKRECD(2),REPNUM                                         
         GOTO1 DATAMGR,DMCB,(X'00',=C'INDEX'),=C'PRTQU',INDEX,P,ATIA            
         ....                                                                   
*During transaction file located by INDEX can be read with READ command         
         ...                                                                    
         GOTO1 DATAMGR,DMCB,(X'00',=C'READ'),=C'PRTQU',INDEX,P,ATIA             
         ...                                                                    
*End of transaction n. Save Index data and Buffer save area.                    
         ...                                                                    
         GOTO1 DATAMGR,DMCB,(X'00',=C'BUSAVE'),=C'PRTQU',INDEX,P,ATIA           
         MVC   TWASAVI(30),P       SAVE INDEX DATA                              
         L     RE,ATIA                                                          
         A     RE,SAVEBDSP                                                      
         MVC   TWASAVB(96),0(RE)   SAVE BUFFER DATA                             
                                                                                
*Start of transaction n+1. Restore index data and buffer save area.             
*Read into buffer the block that was last there in transaction n.               
         ...                                                                    
         MVC   P(30),TWASAVI                                                    
         GOTO1 DATAMGR,DMCB,(X'00',=C'BURSTR'),=C'PRTQU',INDEX,P,ATIA           
         L     RE,ATIA                                                          
         A     RE,SAVEBDSP                                                      
         MVC   8(88,RE),TWASAVB+8  RESTORE SAVE AREA LESS FIRST 8 CHRS          
         MVC   FULL(4),SKADDR-SKBUFFD(RE)                                       
         GOTO1 DATAMGR,DMCB,=C'DMREAD',SAVEPQID,FULL,ATIA                       
         ....                                                                   
*During transaction n+1 can continue with READ commands as before.              
         ...                                                                    
         GOTO1 DATAMGR,DMCB,(X'00',=C'READ'),=C'PRTQU',INDEX,P,ATIA             
                                                                                
DMPRTQK Pan book - DSECT UKRECD for user key in DMCB3                           
-----------------------------------------------------                           
UKRECD   DSECT                                                          00001   
*                                                                       00002   
UKINDEX  DS    0CL24               PRTQ INDEX ENTRY                     00003**2
*                                                                       00004   
UKKEY    DS    0CL7                                                     00005   
UKSRCID  DS    XL2                 USER ID NUMBER                       00006   
UKSUBID  DS    CL3                 REPORT ID                            00007   
UKREPNO  DS    XL2                 FILE REPORT NUMBER WITHIN USERID     00008   
*                                                                       00009   
UKCLASS  DS    XL1                 CLASS                                00010   
UKTYPE   DS    XL1                 TYPE                                 00011   
UKATTB   DS    XL1                 ATTRIBUTES                           00012   
UKSTAT   DS    XL1                 FILE STATUS                          00013   
UKSEQ    DS    XL1                 CI SEQ NUM                           00014   
UKAGES   DS    XL1                 NUMBER OF CONTROL INTERVALS          00015   
UKAGELD  DS    XL2                 LIVE DATE                            00016   
UKAGEDD  DS    XL2                 DEAD DATE                            00017   
UKAGERD  DS    XL2                 RETN DATE                            00018   
         DS    XL1                                                      00019   
UKAGELT  DS    XL2                 LIVE TIME (SECS*3)/4                 00020**2
         DS    XL2                                                      00021**2
*                                                                       00022   
UKINFO   DS    XL2                 INFO PASSING FIELD                   00023**2
UKREPNOX DS    XL2                 UPPER LIMIT                          00024   
UKCIADDR DS    XL2                 TTTT OF FIRST CI                     00025   
UKFLAG   DS    XL1                 FLAG VALUES                          00026   
UKFLDAT  EQU   X'80'               PASS BACK DATA                       00027**2
UKFLDSW  EQU   X'40'               SWITCH FROM INDEX TO DATA            00028**2
UKFLUSR  EQU   X'20'               USER INFO SUPPLIED IN UKUSRINF       00029   
UKFLHRS  EQU   X'10'               HOURS PASSED IN UKINFO               00030**2
UKFLTMP  EQU   X'08'               PASS BACK TEMPORARY ENTRIES          00031**3
         DS    XL1                 N/D                                  00032   
*                                                                       00033   
UKUSRINF DS    XL8                 USER INFO                            00034   
                                                                                
DMPRTQS Pan book - End of buffer save area DSECT                                
------------------------------------------------                                
SKBUFFD  DSECT                                                          00001   
*                                                                       00002   
SKBCTRL  DS    0CL16 ============= CONTROL OF BUFFER                    00003   
SKLABEL  DS    CL8                 BUFF LABEL SET TO *PQSAVE*           00004   
SKINTNO  DS    XL1                 FILE INTERNAL ID NUM                 00005   
SKACTN   DS    XL1                 THIS ACTION VALUE                    00006   
SKLACTN  DS    XL1                 LAST ACTION VALUE                    00007   
SKSCTRL  DS    XL1                 SEQ FUNCTION CONTROL FLAGS           00008   
SKACTRL  DS    XL1                 ADD FUNCTION CONTROL FLAGS           00009   
SKEXTNO  DS    XL1                 FILE EXTERNAL ID NUM                 00010   
         DS    XL2                                                      00011   
SKFCTRL  DS    0CL32 ============= CONTROL OF DATA                      00012   
SKADDR   DS    F                   DISK ADDR OF CURRENT FILE BLOCK      00013   
SKFSTCI  DS    F                   DISK ADDR OF FIRST FILE BLOCK        00014   
SKSTRCI  DS    F                   DISK ADDR OF START OF THIS CI        00015   
SKENDCI  DS    F                   DISK ADDR OF END OF THIS CI          00016   
SKNXTCI  DS    F                   DISK ADDR OF START OF NEXT CI        00017   
SKDISP   DS    H                   DISP OF NEXT RECORD IN BLOCK         00018   
SKLEN    DS    H                   LENGTH OF THIS RECORD                00019   
SKLINES  DS    F                   COUNT OF LINES                       00020   
SKPAGES  DS    F                   COUNT OF PAGES                       00021   
         ORG   SKLINES                                                  00022   
SKCHRS   DS    F                   ADD COUNT OF TOTAL CHRS IN REPORT    00023   
SKCHRMAX DS    H                   ADD MAXIMUM CHRS IN ANY LINE         00024   
         DS    H                                                        00025   
SKXCTRL  DS    0CL36 ============= CONTROL OF INDEX                     00026**2
SKXADDR  DS    F                   CURRENT INDEX DISK ADDR              00027   
SKPAGE   DS    XL2                 CURRENT INDEX PAGE                   00028   
SKENTRY  DS    XL2                 CURRENT INDEX ENTRY                  00029   
*                                                                       00030   
SKINDEX  DS    0CL24               USER INDEX ENTRY FOR PRTQUE          00031**2
SKKEY    DS    0CL7                                                     00032   
SKSRCID  DS    XL2                 USER ID NUMBER                       00033   
SKSUBID  DS    CL3                 REPORT ID                            00034   
SKREPNO  DS    XL2                 FILE REPORT NUMBER WITHIN USERID     00035   
SKCLASS  DS    XL1                 CLASS                                00036   
SKTYPE   DS    XL1                 TYPE                                 00037   
SKATTB   DS    XL1                 ATTRIBUTES                           00038   
SKSTAT   DS    XL1                 FILE STATUS                          00039   
SKSEQ    DS    XL1                 CI SEQ NUM                           00040   
SKAGES   DS    XL1                 NUMBER OF CONTROL INTERVALS          00041   
SKAGELD  DS    XL2                 LIVE DATE                            00042   
SKAGEDD  DS    XL2                 DEAD DATE                            00043   
         DS    XL3                                                      00044   
SKAGELT  DS    XL2                 LIVE TIME                            00045**2
         DS    XL2                                                      00046**2
SKCIADDR DS    XL2                 TTTT OF FIRST CI                     00047   
         DS    XL2                                                      00048**2
*                                                                       00049   
         DS    XL12                SPARE                                00050**2
SKBUFFL  EQU   *-SKBUFFD           LENGTH OF BUFFER SAVE AREA           00051**2
SKEND    DS    0C                                                       00052   
